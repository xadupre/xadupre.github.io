<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>onnxmltools.utils.visualize</title>

  <link rel="stylesheet" href="../../../_static/sphinx-modern-theme.css" type="text/css"/>
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
</head>
<body>
<div class="container">
  <div class="row" style="margin-top: 1rem;">
    <div id="sidebar" class="col-xs-12 col-sm-3">
      <a href="../../../index.html">
        <img style="margin-bottom: 0.5rem;" class="img-fluid" src="../../../_static/ONNXMLTools_logo_main.png"/>
      </a>
      <div id="searchbox" style="display: none" role="search">
        <form class="form-inline" action="../../../search.html" method="get">
          <div class="form-group">
            <label class="sr-only" for="searchInput">Search</label>
            <input type="text" class="form-control" name="q" id="searchInput" placeholder="Search">
          </div>
          <button type="submit" class="btn btn-secondary" style="display:none">Go</button>
          <input type="hidden" name="check_keywords" value="yes"/>
          <input type="hidden" name="area" value="default"/>
        </form>
      </div>

      <hr>

        <div id="toc">
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#step-1-train-a-model-using-your-favorite-framework">Step 1: Train a model using your favorite framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#step-2-convert-or-export-the-model-into-onnx-format">Step 2: Convert or export the model into ONNX format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#step-3-load-and-run-the-model-using-onnx-runtime">Step 3: Load and run the model using ONNX Runtime</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_summary.html">API Summary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_summary.html#converters">Converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_summary.html#utils">Utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Gallery of examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_backend.html">ONNX Runtime Backend for ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_pipeline.html">Draw a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_metadata.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_dl_keras.html">ONNX Runtime for Keras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_common_errors.html">Common errors with onnxruntime</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tests.html">Tests, Dependencies, Contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tests.html#test-all-existing-converters">Test all existing converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tests.html#add-a-new-converter">Add a new converter</a></li>
</ul>
</li>
</ul>

        </div>
    </div>
    <div class="col-xs-12 col-sm-9">
      <h1>Source code for onnxmltools.utils.visualize</h1><div class="highlight"><pre>
<span></span><span class="c1">#-------------------------------------------------------------------------</span>
<span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c1"># Licensed under the MIT License. See License.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1">#--------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">webbrowser</span> <span class="k">import</span> <span class="n">open_new_tab</span>


<span class="k">def</span> <span class="nf">get_set_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;g.setNode(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, { label: &#39;&quot;</span> <span class="o">+</span> <span class="n">node</span> <span class="o">+</span> <span class="s2">&quot;&#39;, class: &#39;type-&quot;</span> <span class="o">+</span> <span class="n">node</span> <span class="o">+</span> <span class="s2">&quot;&#39; });&quot;</span>


<span class="k">def</span> <span class="nf">get_set_edge</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;g.setEdge(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span>


<span class="k">def</span> <span class="nf">get_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">):</span>
    <span class="n">graph_nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">op_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">graph_nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">))])</span>
    <span class="n">graph_nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">graph_nodes</span>


<span class="k">def</span> <span class="nf">get_nodes_builder</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">):</span>
    <span class="n">_ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_set_node</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph_nodes</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_ret</span>


<span class="k">def</span> <span class="nf">get_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">):</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">node</span>
    <span class="n">initializer_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">init</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">initializer</span><span class="p">]</span>
    <span class="n">output_node_hash</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">edge_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">output_node_hash</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">output_node_hash</span><span class="p">[</span><span class="n">output</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_node_hash</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
        <span class="n">output_node_hash</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">output_node_hash</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">edge_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">output_node_hash</span><span class="p">[</span><span class="nb">input</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">initializer_names</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;No corresponding output found for </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">output_node_hash</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">edge_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">output_node_hash</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">edge_list</span>


<div class="viewcode-block" id="visualize_model"><a class="viewcode-back" href="../../../api_summary.html#onnxmltools.utils.visualize_model">[docs]</a><span class="k">def</span> <span class="nf">visualize_model</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;index.html&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a graph visualization of an ONNX protobuf model.</span>
<span class="sd">    It creates a SVG graph with *d3.js* and stores it into a file.</span>

<span class="sd">    :param model: ONNX model (protobuf object)    </span>
<span class="sd">    :param open_browser: opens the browser</span>
<span class="sd">    :param dest: destination file</span>

<span class="sd">    Example:</span>

<span class="sd">    ::</span>

<span class="sd">        from onnxmltools.utils import visualize_model</span>
<span class="sd">        visualize_model(model)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="s2">&quot;Model produced by: &quot;</span> <span class="o">+</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">producer_name</span> <span class="o">+</span> \
        <span class="s2">&quot; version(&quot;</span> <span class="o">+</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">producer_version</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

    <span class="n">html_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;!doctype html&gt;</span>
<span class="s2">    &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s2">    &lt;title&gt;ONNX Visualization&lt;/title&gt;</span>
<span class="s2">    &lt;script src=&quot;https://d3js.org/d3.v3.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="s2">    &lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot;&gt;</span>
<span class="s2">    &lt;script src=&quot;dagre-d3.min.js&quot;&gt;&lt;/script&gt;</span>

<span class="s2">    &lt;h2&gt;[model_info]&lt;/h2&gt;</span>

<span class="s2">    &lt;svg id=&quot;svg-canvas&quot; width=960 height=600&gt;&lt;/svg&gt;</span>

<span class="s2">    &lt;script id=&quot;js&quot;&gt;</span>
<span class="s2">    var g = new dagreD3.graphlib.Graph()</span>
<span class="s2">    .setGraph(</span><span class="si">{}</span><span class="s2">)</span>
<span class="s2">    .setDefaultEdgeLabel(function() { return </span><span class="si">{}</span><span class="s2">; });</span>

<span class="s2">    [nodes_html]</span>

<span class="s2">    g.nodes().forEach(function(v) {</span>
<span class="s2">    var node = g.node(v);</span>
<span class="s2">    // Round the corners of the nodes</span>
<span class="s2">    node.rx = node.ry = 5;</span>
<span class="s2">    });</span>

<span class="s2">    [edges_html]</span>

<span class="s2">    // Create the renderer</span>
<span class="s2">    var render = new dagreD3.render();</span>

<span class="s2">    // Set up an SVG group so that we can translate the final graph.</span>
<span class="s2">    var svg = d3.select(&quot;svg&quot;),</span>
<span class="s2">        svgGroup = svg.append(&quot;g&quot;);</span>

<span class="s2">    // Run the renderer. This is what draws the final graph.</span>
<span class="s2">    render(d3.select(&quot;svg g&quot;), g);</span>

<span class="s2">    // Center the graph</span>
<span class="s2">    svgGroup.attr(&quot;transform&quot;, &quot;translate(20, 20)&quot;);</span>
<span class="s2">    svg.attr(&quot;height&quot;, g.graph().height + 40);</span>
<span class="s2">    svg.attr(&quot;width&quot;, g.graph().width + 40);</span>
<span class="s2">    &lt;/script&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">html_str</span> <span class="o">=</span> <span class="n">html_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[nodes_html]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">get_nodes_builder</span><span class="p">(</span><span class="n">get_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">))))</span>

    <span class="n">html_str</span> <span class="o">=</span> <span class="n">html_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[edges_html]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="n">get_set_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">get_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">)]))</span>

    <span class="n">html_str</span> <span class="o">=</span> <span class="n">html_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[model_info]&quot;</span><span class="p">,</span> <span class="n">model_info</span><span class="p">)</span>

    <span class="n">Html_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">Html_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_str</span><span class="p">)</span>
    <span class="n">Html_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">pkgdir</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;onnxmltools&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkgdir</span><span class="p">,</span> <span class="s2">&quot;utils&quot;</span><span class="p">,</span> <span class="s2">&quot;styles.css&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkgdir</span><span class="p">,</span> <span class="s2">&quot;utils&quot;</span><span class="p">,</span> <span class="s2">&quot;dagre-d3.min.js&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="n">open_new_tab</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">))</span></div>
</pre></div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"
        integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js"
        integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/js/bootstrap.min.js"
        integrity="sha384-ux8v3A6CPtOTqOzMKiuo3d/DomGaaClxFYdCu2HPMBEkf6x2xiDyJ7gkXU0MWwaD"
        crossorigin="anonymous"></script>
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="../../../_static/searchtools.js"></script>
<script>$('#searchbox').show(0)</script>
</body>
</html>