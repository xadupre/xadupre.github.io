<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>onnxmltools.utils.tests_helper</title>

  <link rel="stylesheet" href="../../../_static/sphinx-modern-theme.css" type="text/css"/>
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
</head>
<body>
<div class="container">
  <div class="row" style="margin-top: 1rem;">
    <div id="sidebar" class="col-xs-12 col-sm-3">
      <a href="../../../index.html">
        <img style="margin-bottom: 0.5rem;" class="img-fluid" src="../../../_static/ONNXMLTools_logo_main.png"/>
      </a>
      <div id="searchbox" style="display: none" role="search">
        <form class="form-inline" action="../../../search.html" method="get">
          <div class="form-group">
            <label class="sr-only" for="searchInput">Search</label>
            <input type="text" class="form-control" name="q" id="searchInput" placeholder="Search">
          </div>
          <button type="submit" class="btn btn-secondary" style="display:none">Go</button>
          <input type="hidden" name="check_keywords" value="yes"/>
          <input type="hidden" name="area" value="default"/>
        </form>
      </div>

      <hr>

        <div id="toc">
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#step-1-train-a-model-using-your-favorite-framework">Step 1: Train a model using your favorite framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#step-2-convert-or-export-the-model-into-onnx-format">Step 2: Convert or export the model into ONNX format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#step-3-load-and-run-the-model-using-onnx-runtime">Step 3: Load and run the model using ONNX Runtime</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_summary.html">API Summary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_summary.html#converters">Converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_summary.html#utils">Utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Gallery of examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_backend.html">ONNX Runtime Backend for ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_pipeline.html">Draw a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_metadata.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_dl_keras.html">ONNX Runtime for Keras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/plot_common_errors.html">Common errors with onnxruntime</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tests.html">Tests, Dependencies, Contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tests.html#test-all-existing-converters">Test all existing converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tests.html#add-a-new-converter">Add a new converter</a></li>
</ul>
</li>
</ul>

        </div>
    </div>
    <div class="col-xs-12 col-sm-9">
      <h1>Source code for onnxmltools.utils.tests_helper</h1><div class="highlight"><pre>
<span></span><span class="c1">#-------------------------------------------------------------------------</span>
<span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c1"># Licensed under the MIT License. See License.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1">#--------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">..convert.common.data_types</span> <span class="k">import</span> <span class="n">FloatTensorType</span>
<span class="kn">from</span> <span class="nn">.utils_backend</span> <span class="k">import</span> <span class="n">compare_backend</span><span class="p">,</span> <span class="n">extract_options</span><span class="p">,</span> <span class="n">evaluate_condition</span><span class="p">,</span> <span class="n">is_backend_enabled</span>


<div class="viewcode-block" id="dump_data_and_model"><a class="viewcode-back" href="../../../api_summary.html#onnxmltools.utils.dump_data_and_model">[docs]</a><span class="k">def</span> <span class="nf">dump_data_and_model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">onnx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basename</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;onnxruntime&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">allow_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves data with pickle, saves the model with pickle and *onnx*,</span>
<span class="sd">    runs and saves the predictions for the given model.</span>
<span class="sd">    This function is used to test a backend (runtime) for *onnx*.</span>

<span class="sd">    :param data: any kind of data</span>
<span class="sd">    :param model: any model</span>
<span class="sd">    :param onnx: *onnx* model or *None* to use *onnxmltools* to convert it</span>
<span class="sd">        only if the model accepts one float vector</span>
<span class="sd">    :param basemodel: three files are writen ``&lt;basename&gt;.data.pkl``,</span>
<span class="sd">        ``&lt;basename&gt;.model.pkl``, ``&lt;basename&gt;.model.onnx``</span>
<span class="sd">    :param folder: files are written in this folder,</span>
<span class="sd">        it is created if it does not exist, if *folder* is None,</span>
<span class="sd">        it looks first in environment variable ``ONNXTESTDUMP``,</span>
<span class="sd">        otherwise, it is placed into ``&#39;tests&#39;``.</span>
<span class="sd">    :param inputs: standard type or specific one if specified, only used is</span>
<span class="sd">        parameter *onnx* is None</span>
<span class="sd">    :param backend: backend used to compare expected output and runtime output.</span>
<span class="sd">        Two options are currently supported: None for no test,</span>
<span class="sd">        `&#39;onnxruntime&#39;` to use module *onnxruntime*.</span>
<span class="sd">    :param context: used if the model contains a custom operator such</span>
<span class="sd">        as a custom Keras function...</span>
<span class="sd">    :param allow_failure: None to raise an exception if comparison fails</span>
<span class="sd">        for the backends, otherwise a string which is then evaluated to check</span>
<span class="sd">        whether or not the test can fail, example:</span>
<span class="sd">        ``&quot;StrictVersion(onnx.__version__) &lt; StrictVersion(&#39;1.3.0&#39;)&quot;``</span>
<span class="sd">    :return: the created files</span>

<span class="sd">    Some convention for the name,</span>
<span class="sd">    *Bin* for a binary classifier, *Mcl* for a multiclass</span>
<span class="sd">    classifier, *Reg* for a regressor, *MRg* for a multi-regressor.</span>
<span class="sd">    The name can contain some flags. Expected outputs refer to the</span>
<span class="sd">    outputs computed with the original library, computed outputs</span>
<span class="sd">    refer to the outputs computed with a ONNX runtime.</span>
<span class="sd">    </span>
<span class="sd">    * ``-CannotLoad``: the model can be converted but the runtime cannot load it</span>
<span class="sd">    * ``-Dec3``: compares expected and computed outputs up to 3 decimals (5 by default)</span>
<span class="sd">    * ``-Dec4``: compares expected and computed outputs up to 4 decimals (5 by default)    </span>
<span class="sd">    * ``-NoProb``: The original models computed probabilites for two classes *size=(N, 2)*</span>
<span class="sd">      but the runtime produces a vector of size *N*, the test will compare the second column</span>
<span class="sd">      to the column</span>
<span class="sd">    * ``-OneOff``: the ONNX runtime cannot computed the prediction for several inputs,</span>
<span class="sd">      it must be called for each of them</span>
<span class="sd">      and computed output.</span>
<span class="sd">    * ``-Out0``: only compares the first output on both sides</span>
<span class="sd">    * ``-Reshape``: merges all outputs into one single vector and resizes it before comparing</span>
<span class="sd">    * ``-SkipDim1``: before comparing expected and computed output,</span>
<span class="sd">      arrays with a shape like *(2, 1, 2)* becomes *(2, 2)*</span>
<span class="sd">    </span>
<span class="sd">    If the *backend* is not None, the function either raises an exception</span>
<span class="sd">    if the comparison between the expected outputs and the backend outputs</span>
<span class="sd">    fails or it saves the backend output and adds it to the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">runtime_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ONNXTESTDUMP&#39;</span><span class="p">,</span> <span class="s1">&#39;tests&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">):</span>
            <span class="c1"># Classifier</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;decision_function&quot;</span><span class="p">):</span>
            <span class="c1"># Classifier without probabilities</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">):</span>
            <span class="c1"># Keras</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">input_names</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s2">&quot;Only neural network with one input are supported&quot;</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Regressor</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">):</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model has not predict or transform method.&quot;</span><span class="p">)</span>
        
    <span class="n">runtime_test</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span>
    
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.expected.pkl&quot;</span><span class="p">)</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.data.pkl&quot;</span><span class="p">)</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">):</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.model.keras&quot;</span><span class="p">)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.model.pkl&quot;</span><span class="p">)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">onnx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)))]</span>
        <span class="n">onnx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
    
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.model.onnx&quot;</span><span class="p">)</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onnx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
    
    <span class="n">runtime_test</span><span class="p">[</span><span class="s2">&quot;onnx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span>
    
    <span class="c1"># backend</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">backend</span> <span class="o">=</span> <span class="p">[</span><span class="n">backend</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">backend</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_backend_enabled</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">allow_failure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">allow</span> <span class="o">=</span> <span class="n">evaluate_condition</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">allow_failure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">allow</span> <span class="o">=</span> <span class="n">allow_failure</span>
            <span class="k">if</span> <span class="n">allow</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">compare_backend</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">runtime_test</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">extract_options</span><span class="p">(</span><span class="n">basename</span><span class="p">),</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">compare_backend</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">runtime_test</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">extract_options</span><span class="p">(</span><span class="n">basename</span><span class="p">),</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">allow</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allow</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Issue with &#39;</span><span class="si">{0}</span><span class="s2">&#39; due to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.backend.</span><span class="si">{0}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">names</span></div>


<span class="k">def</span> <span class="nf">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the appropriate conversion method.</span>
<span class="sd">    </span>
<span class="sd">    :param model: model, *scikit-learn*, *keras*, or *coremltools* object</span>
<span class="sd">    :return: *onnx* model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="k">import</span> <span class="n">BaseEstimator</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;LGBM&quot;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">onnxmltools.convert</span> <span class="k">import</span> <span class="n">convert_lightgbm</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_lightgbm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_types</span><span class="p">),</span> <span class="s2">&quot;LightGbm&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">onnxmltools.convert</span> <span class="k">import</span> <span class="n">convert_sklearn</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_types</span><span class="p">),</span> <span class="s2">&quot;Sklearn&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">onnxmltools.convert</span> <span class="k">import</span> <span class="n">convert_keras</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_keras</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_types</span><span class="p">),</span> <span class="s2">&quot;Keras&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">onnxmltools.convert</span> <span class="k">import</span> <span class="n">convert_coreml</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_coreml</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_types</span><span class="p">),</span> <span class="s2">&quot;Cml&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to convert model of type &#39;</span><span class="si">{0}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">prefix</span>
    
    
<span class="k">def</span> <span class="nf">dump_one_class_classification</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains and dumps a model for a One Class outlier problem.</span>
<span class="sd">    The function trains a model and calls</span>
<span class="sd">    :func:`dump_data_and_model`.</span>
<span class="sd">    </span>
<span class="sd">    :param model: any model following *scikit-learn* API</span>
<span class="sd">    :param suffix: added to filenames</span>
<span class="sd">    :param folder: where to save the file</span>
<span class="sd">    :param allow_failure: None to raise an exception if comparison fails</span>
<span class="sd">        for the backends, otherwise a string which is then evaluated to check</span>
<span class="sd">        whether or not the test can fail, example:</span>
<span class="sd">        ``&quot;StrictVersion(onnx.__version__) &lt; StrictVersion(&#39;1.3.0&#39;)&quot;``</span>
<span class="sd">    :return: output of :func:`dump_data_and_model`</span>
<span class="sd">    </span>
<span class="sd">    Every created filename will follow the pattern:</span>
<span class="sd">    ``&lt;folder&gt;/&lt;prefix&gt;&lt;task&gt;&lt;classifier-name&gt;&lt;suffix&gt;.&lt;data|expected|model|onnx&gt;.&lt;pkl|onnx&gt;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">model_onnx</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;one_class&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))])</span>
    <span class="k">return</span> <span class="n">dump_data_and_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_onnx</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="n">allow_failure</span><span class="p">,</span>
                               <span class="n">basename</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;One&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dump_binary_classification</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains and dumps a model for a binary classification problem.</span>
<span class="sd">    </span>
<span class="sd">    :param model: any model following *scikit-learn* API</span>
<span class="sd">    :param suffix: added to filenames</span>
<span class="sd">    :param folder: where to save the file</span>
<span class="sd">    :param allow_failure: None to raise an exception if comparison fails</span>
<span class="sd">        for the backends, otherwise a string which is then evaluated to check</span>
<span class="sd">        whether or not the test can fail, example:</span>
<span class="sd">        ``&quot;StrictVersion(onnx.__version__) &lt; StrictVersion(&#39;1.3.0&#39;)&quot;``</span>
<span class="sd">    :return: output of :func:`dump_data_and_model`</span>
<span class="sd">    </span>
<span class="sd">    Every created filename will follow the pattern:</span>
<span class="sd">    ``&lt;folder&gt;/&lt;prefix&gt;&lt;task&gt;&lt;classifier-name&gt;&lt;suffix&gt;.&lt;data|expected|model|onnx&gt;.&lt;pkl|onnx&gt;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">model_onnx</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;tree-based binary classifier&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))])</span>
    <span class="n">dump_data_and_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_onnx</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="n">allow_failure</span><span class="p">,</span>
                        <span class="n">basename</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;Bin&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dump_multiple_classification</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains and dumps a model for a binary classification problem.</span>
<span class="sd">    </span>
<span class="sd">    :param model: any model following *scikit-learn* API</span>
<span class="sd">    :param suffix: added to filenames</span>
<span class="sd">    :param folder: where to save the file</span>
<span class="sd">    :param allow_failure: None to raise an exception if comparison fails</span>
<span class="sd">        for the backends, otherwise a string which is then evaluated to check</span>
<span class="sd">        whether or not the test can fail, example:</span>
<span class="sd">        ``&quot;StrictVersion(onnx.__version__) &lt; StrictVersion(&#39;1.3.0&#39;)&quot;``</span>
<span class="sd">    :return: output of :func:`dump_data_and_model`</span>
<span class="sd">    </span>
<span class="sd">    Every created filename will follow the pattern:</span>
<span class="sd">    ``&lt;folder&gt;/&lt;prefix&gt;&lt;task&gt;&lt;classifier-name&gt;&lt;suffix&gt;.&lt;data|expected|model|onnx&gt;.&lt;pkl|onnx&gt;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">model_onnx</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;tree-based multi-output regressor&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))])</span>
    <span class="n">dump_data_and_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_onnx</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="n">allow_failure</span><span class="p">,</span>
                        <span class="n">basename</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;Mcl&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dump_multiple_regression</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains and dumps a model for a multi regression problem.</span>
<span class="sd">    </span>
<span class="sd">    :param model: any model following *scikit-learn* API</span>
<span class="sd">    :param suffix: added to filenames</span>
<span class="sd">    :param folder: where to save the file</span>
<span class="sd">    :param allow_failure: None to raise an exception if comparison fails</span>
<span class="sd">        for the backends, otherwise a string which is then evaluated to check</span>
<span class="sd">        whether or not the test can fail, example:</span>
<span class="sd">        ``&quot;StrictVersion(onnx.__version__) &lt; StrictVersion(&#39;1.3.0&#39;)&quot;``</span>
<span class="sd">    :return: output of :func:`dump_data_and_model`</span>
<span class="sd">    </span>
<span class="sd">    Every created filename will follow the pattern:</span>
<span class="sd">    ``&lt;folder&gt;/&lt;prefix&gt;&lt;task&gt;&lt;classifier-name&gt;&lt;suffix&gt;.&lt;data|expected|model|onnx&gt;.&lt;pkl|onnx&gt;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">49</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">99</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">model_onnx</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;tree-based multi-output regressor&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))])</span>
    <span class="n">dump_data_and_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_onnx</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="n">allow_failure</span><span class="p">,</span>
                        <span class="n">basename</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;MRg&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dump_single_regression</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains and dumps a model for a regression problem.</span>
<span class="sd">    </span>
<span class="sd">    :param model: any model following *scikit-learn* API</span>
<span class="sd">    :param prefix: library name</span>
<span class="sd">    :param suffix: added to filenames</span>
<span class="sd">    :param folder: where to save the file</span>
<span class="sd">    :param allow_failure: None to raise an exception if comparison fails</span>
<span class="sd">        for the backends, otherwise a string which is then evaluated to check</span>
<span class="sd">        whether or not the test can fail, example:</span>
<span class="sd">        ``&quot;StrictVersion(onnx.__version__) &lt; StrictVersion(&#39;1.3.0&#39;)&quot;``</span>
<span class="sd">    :return: output of :func:`dump_data_and_model`</span>
<span class="sd">    </span>
<span class="sd">    Every created filename will follow the pattern:</span>
<span class="sd">    ``&lt;folder&gt;/&lt;prefix&gt;&lt;task&gt;&lt;classifier-name&gt;&lt;suffix&gt;.&lt;data|expected|model|onnx&gt;.&lt;pkl|onnx&gt;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">model_onnx</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">convert_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;tree-based regressor&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))])</span>
    <span class="n">dump_data_and_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_onnx</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">allow_failure</span><span class="o">=</span><span class="n">allow_failure</span><span class="p">,</span>
                        <span class="n">basename</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;Reg&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_report_backend</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Looks into a folder for dumped files after</span>
<span class="sd">    the unit tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.expected.pkl&quot;</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">res</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s2">&quot;_tested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="s1">&#39;.backend.&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">bk</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.backend.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">res</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">bk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">dict_update</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    
    <span class="n">aslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict_update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">_model</span><span class="o">=</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">aslist</span>
</pre></div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"
        integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js"
        integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/js/bootstrap.min.js"
        integrity="sha384-ux8v3A6CPtOTqOzMKiuo3d/DomGaaClxFYdCu2HPMBEkf6x2xiDyJ7gkXU0MWwaD"
        crossorigin="anonymous"></script>
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="../../../_static/searchtools.js"></script>
<script>$('#searchbox').show(0)</script>
</body>
</html>