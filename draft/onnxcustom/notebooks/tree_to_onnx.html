
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Convert a tree into ONNX &#8212; onnxcustom</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Stochastic Gradient Descent on simple function" href="onnxruntime_training_nb.html" />
    <link rel="prev" title="Notebooks Gallery" href="../all_notebooks.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/apis.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Examples Gallery
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebooks Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../other_pages.html">
  Other pages
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../blog/blogindex.html">
  Blog Gallery
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Convert a tree into ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnxruntime_training_nb.html">
   Stochastic Gradient Descent on simple function
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../all_notebooks_coverage.html">
   Notebooks Coverage
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tree-and-cython">
   Tree and cython
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-simple-problem">
   A simple problem
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-tree-construction">
   The tree construction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conversion-to-onnx">
   Conversion to ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#text-visualization">
   Text visualization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-a-forest-of-trees">
   Convert a forest of trees
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="convert-a-tree-into-onnx">
<span id="treetoonnxrst"></span><h1>Convert a tree into ONNX<a class="headerlink" href="#convert-a-tree-into-onnx" title="Permalink to this headline">¶</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/512639130569a8ce0515c2f7a2530edf/tree_to_onnx.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="tree_to_onnx2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/f739cd46829c9c063de39d209e78ed4a/tree_to_onnx.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/f6aacd9faf86baa63777874a49681378/tree_to_onnx.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="tree_to_onnx.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/onnxcustom/blob/master/_doc/notebooks/tree_to_onnx.ipynb">GitHub</a></p>
<p>This notebook shows how to create a tree and execute it with
<a class="reference external" href="https://github.com/onnx/onnx">onnx</a> and
<a class="reference external" href="https://onnxruntime.ai/docs/api/python/">onnxruntime</a>. The direct
way to do it is simple to use ONNX API and more precisely, the node
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators-ml.md#ai.onnx.ml.TreeEnsembleRegressor">TreeEnsembleRegressor</a>.
Another option is to create a tree in
<a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> and then to convert
it using <a class="reference external" href="https://onnx.ai/sklearn-onnx/">skl2onnx</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#tree-and-cython" id="id61">Tree and cython</a></p></li>
<li><p><a class="reference internal" href="#a-simple-problem" id="id62">A simple problem</a></p></li>
<li><p><a class="reference internal" href="#the-tree-construction" id="id63">The tree construction</a></p></li>
<li><p><a class="reference internal" href="#conversion-to-onnx" id="id64">Conversion to ONNX</a></p></li>
<li><p><a class="reference internal" href="#text-visualization" id="id65">Text visualization</a></p></li>
<li><p><a class="reference internal" href="#convert-a-forest-of-trees" id="id66">Convert a forest of trees</a></p></li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<section id="tree-and-cython">
<h2><a class="toc-backref" href="#id61">Tree and cython</a><a class="headerlink" href="#tree-and-cython" title="Permalink to this headline">¶</a></h2>
<p>Class
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeRegressor.html#sklearn.tree.DecisionTreeRegressor">DecisionTreeRegressor</a>
is the public API for a tree in scikit-learn. It relies one another
implemented in <a class="reference external" href="https://cython.org/">cython</a> called
<a class="reference external" href="https://github.com/scikit-learn/scikit-learn/blob/main/sklearn/tree/_tree.pyx#L490">Tree</a>.
This one is private and not supposed to be accessed by users. All
methods cannot be accessed from python including the one used to add
nodes
<a class="reference external" href="https://github.com/scikit-learn/scikit-learn/blob/main/sklearn/tree/_tree.pyx#L716">add_node</a>.
Then a little bit of cython is needed to actually create a tree… or we
could use function
<a class="reference external" href="http://www.xavierdupre.fr/app/mlinsights/helpsphinx/mlinsights/mltree/_tree_digitize.cpython-39-x86_64-linux-gnu.html">tree_add_node</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlinsights.mltree._tree_digitize</span> <span class="kn">import</span> <span class="n">tree_add_node</span>
<span class="n">help</span><span class="p">(</span><span class="n">tree_add_node</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Help on built-in function tree_add_node in module mlinsights.mltree._tree_digitize:
tree_add_node(...)
    tree_add_node(tree, parent, is_left, is_leaf, feature, threshold, impurity, n_node_samples, weighted_n_node_samples)
    Adds a node to tree.
    :param parent: parent index (-1 for the root)
    :param is_left: is left node?
    :param is_leaf: is leave?
    :param feature: feature index
    :param threshold: threshold (or value)
    :param impurity: impurity
    :param n_node_samples: number of samples this node represents
    :param weighted_n_node_samples: node weight
</pre></div>
</div>
</section>
<section id="a-simple-problem">
<h2><a class="toc-backref" href="#id62">A simple problem</a><a class="headerlink" href="#a-simple-problem" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="k">def</span> <span class="nf">plot_function</span><span class="p">(</span><span class="n">fct</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># step size in the mesh</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">fct</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

    <span class="c1"># Put the result into a color plot</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="k">def</span> <span class="nf">tree_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">tree_function_data</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree_function</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="n">plot_function</span><span class="p">(</span><span class="n">tree_function_data</span><span class="p">,</span> <span class="s2">&quot;tree_function_data&quot;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">09</span><span class="n">db879347c8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span> <span class="n">MatplotlibDeprecationWarning</span><span class="p">:</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span> <span class="n">when</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">Y</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">dimensions</span> <span class="k">as</span> <span class="n">C</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="n">since</span> <span class="mf">3.3</span><span class="o">.</span>  <span class="n">Either</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">corners</span> <span class="n">of</span> <span class="n">the</span> <span class="n">quadrilaterals</span> <span class="k">with</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">Y</span><span class="p">,</span> <span class="ow">or</span> <span class="k">pass</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span> <span class="ow">or</span> <span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="ow">or</span> <span class="nb">set</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pcolor.shading&#39;</span><span class="p">]</span><span class="o">.</span>  <span class="n">This</span> <span class="n">will</span> <span class="n">become</span> <span class="n">an</span> <span class="n">error</span> <span class="n">two</span> <span class="n">minor</span> <span class="n">releases</span> <span class="n">later</span><span class="o">.</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tree_to_onnx_6_1.png" src="../_images/tree_to_onnx_6_1.png" />
</section>
<section id="the-tree-construction">
<h2><a class="toc-backref" href="#id63">The tree construction</a><a class="headerlink" href="#the-tree-construction" title="Permalink to this headline">¶</a></h2>
<p>The tree needs two features and has three nodes.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.tree._tree</span> <span class="kn">import</span> <span class="n">Tree</span>

<span class="n">UNUSED</span> <span class="o">=</span> <span class="mi">99999</span>

<span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># stored the predicted values</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># n_features</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">intp</span><span class="p">),</span>  <span class="c1">#  n_classes</span>
            <span class="mi">1</span><span class="p">,</span>  <span class="c1"># n_outputs</span>
            <span class="p">)</span>


<span class="c1"># First node: the root: x &lt;= 0</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                      <span class="o">-</span><span class="mi">1</span><span class="p">,</span>          <span class="c1"># parent index</span>
                      <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is left node</span>
                      <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is leaf</span>
                      <span class="mi">0</span><span class="p">,</span>           <span class="c1"># feature index</span>
                      <span class="mi">0</span><span class="p">,</span>           <span class="c1"># threshold</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNUSED</span><span class="p">)</span>


<span class="c1"># Second node: y &lt;= 0.2</span>
<span class="n">index1</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                       <span class="n">index</span><span class="p">,</span>       <span class="c1"># parent index</span>
                       <span class="kc">True</span><span class="p">,</span>        <span class="c1"># is left node</span>
                       <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is leaf</span>
                       <span class="mi">1</span><span class="p">,</span>           <span class="c1"># feature index</span>
                       <span class="mf">0.2</span><span class="p">,</span>         <span class="c1"># threshold</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNUSED</span><span class="p">)</span>

<span class="c1"># First leaf</span>
<span class="n">leaf_1</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                       <span class="n">index1</span><span class="p">,</span>      <span class="c1"># parent index</span>
                       <span class="kc">True</span><span class="p">,</span>        <span class="c1"># is left node</span>
                       <span class="kc">True</span><span class="p">,</span>        <span class="c1"># is leaf</span>
                       <span class="mi">0</span><span class="p">,</span>           <span class="c1"># feature index</span>
                       <span class="mi">0</span><span class="p">,</span>           <span class="c1"># threshold</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Second leaf</span>
<span class="n">leaf_2</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Third node: y &lt;= -0.1</span>
<span class="n">index2</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                       <span class="n">index</span><span class="p">,</span>       <span class="c1"># parent index</span>
                       <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is left node</span>
                       <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is right node</span>
                       <span class="mi">1</span><span class="p">,</span>           <span class="c1"># feature index</span>
                       <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>        <span class="c1"># threshold</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNUSED</span><span class="p">)</span>

<span class="c1"># Third leaf</span>
<span class="n">leaf_3</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                       <span class="n">index2</span><span class="p">,</span>      <span class="c1"># parent index</span>
                       <span class="kc">True</span><span class="p">,</span>        <span class="c1"># is left node</span>
                       <span class="kc">True</span><span class="p">,</span>        <span class="c1"># is leaf</span>
                       <span class="mi">0</span><span class="p">,</span>           <span class="c1"># feature index</span>
                       <span class="mi">0</span><span class="p">,</span>           <span class="c1"># threshold</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Fourth leaf</span>
<span class="n">leaf_4</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="n">index</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="n">values</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">99999</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">99999</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p>The final detail.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<p>The internal structure is created, let’s complete the public API.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">reg</span><span class="o">.</span><span class="n">tree_</span> <span class="o">=</span> <span class="n">tree</span>
<span class="n">reg</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">value</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>  <span class="c1"># pylint: disable=E1137</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">reg</span><span class="o">.</span><span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">reg</span><span class="o">.</span><span class="n">n_outputs_</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">reg</span><span class="o">.</span><span class="n">n_features_in_</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># scikit-learn &gt;= 0.24</span>
<span class="n">reg</span><span class="o">.</span><span class="n">maxdepth</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">max_depth</span>

<span class="n">reg</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DecisionTreeRegressor</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_function</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="s2">&quot;DecisionTreeRegressor&quot;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">09</span><span class="n">db879347c8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span> <span class="n">MatplotlibDeprecationWarning</span><span class="p">:</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span> <span class="n">when</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">Y</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">dimensions</span> <span class="k">as</span> <span class="n">C</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="n">since</span> <span class="mf">3.3</span><span class="o">.</span>  <span class="n">Either</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">corners</span> <span class="n">of</span> <span class="n">the</span> <span class="n">quadrilaterals</span> <span class="k">with</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">Y</span><span class="p">,</span> <span class="ow">or</span> <span class="k">pass</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span> <span class="ow">or</span> <span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="ow">or</span> <span class="nb">set</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pcolor.shading&#39;</span><span class="p">]</span><span class="o">.</span>  <span class="n">This</span> <span class="n">will</span> <span class="n">become</span> <span class="n">an</span> <span class="n">error</span> <span class="n">two</span> <span class="n">minor</span> <span class="n">releases</span> <span class="n">later</span><span class="o">.</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tree_to_onnx_13_1.png" src="../_images/tree_to_onnx_13_1.png" />
<p>It is the same.</p>
</section>
<section id="conversion-to-onnx">
<h2><a class="toc-backref" href="#id64">Conversion to ONNX</a><a class="headerlink" href="#conversion-to-onnx" title="Permalink to this headline">¶</a></h2>
<p>The only difference is ONNX does not support double (float64) in opset
15 or below with
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators-ml.md#ai.onnx.ml.TreeEnsembleRegressor">TreeEnsembleRegressor</a>.
It does not really matter for this example but it could (see this
example
<a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/gyexamples/plot_ebegin_float_double.html">Discrepancies</a>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>

<span class="n">feat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">target_opset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="o">%</span><span class="k">onnxview</span> onx
</pre></div>
</div>
<div id="Md63c91c5e18d4b9c822aa65ee38f5380-cont"><div id="Md63c91c5e18d4b9c822aa65ee38f5380" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n\n  X [shape=box color=red label=\"X\nfloat((0, 2))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\nfloat((0, 1))\" fontsize=10];\n\n\n  TreeEnsembleRegressor [shape=box style=\"filled,rounded\" color=orange label=\"TreeEnsembleRegressor\n(TreeEnsembleRegressor)\nn_targets=1\nnodes_falsenodeids=[4 3 0 0 6 0...\nnodes_featureids=[0 1 0 0 1 0 0...\nnodes_hitrates=[1. 1. 1. 1. 1. ...\nnodes_missing_value_tracks_true=[0 0 0 0 0...\nnodes_modes=[b'BRANCH_LEQ' b'BR...\nnodes_nodeids=[0 1 2 3 4 5 6]\nnodes_treeids=[0 0 0 0 0 0 0]\nnodes_truenodeids=[1 2 0 0 5 0 ...\nnodes_values=[ 0.          0.19...\npost_transform=b'NONE'\ntarget_ids=[0 0 0 0]\ntarget_nodeids=[2 3 5 6]\ntarget_treeids=[0 0 0 0]\ntarget_weights=[0. 1. 2. 3.]\" fontsize=10];\n  X -> TreeEnsembleRegressor;\n  TreeEnsembleRegressor -> variable;\n}");
document.getElementById('Md63c91c5e18d4b9c822aa65ee38f5380').innerHTML = svgGraph; });

</script><p>And we execute it with onnxruntime.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="n">plot_function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;onnxruntime&quot;</span><span class="p">);</span>
</pre></div>
</div>
<pre class="literal-block">No CUDA runtime is found, using CUDA_HOME='C:Program FilesNVIDIA GPU Computing ToolkitCUDAv11.4'</pre>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">09</span><span class="n">db879347c8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span> <span class="n">MatplotlibDeprecationWarning</span><span class="p">:</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span> <span class="n">when</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">Y</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">dimensions</span> <span class="k">as</span> <span class="n">C</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="n">since</span> <span class="mf">3.3</span><span class="o">.</span>  <span class="n">Either</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">corners</span> <span class="n">of</span> <span class="n">the</span> <span class="n">quadrilaterals</span> <span class="k">with</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">Y</span><span class="p">,</span> <span class="ow">or</span> <span class="k">pass</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span> <span class="ow">or</span> <span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="ow">or</span> <span class="nb">set</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pcolor.shading&#39;</span><span class="p">]</span><span class="o">.</span>  <span class="n">This</span> <span class="n">will</span> <span class="n">become</span> <span class="n">an</span> <span class="n">error</span> <span class="n">two</span> <span class="n">minor</span> <span class="n">releases</span> <span class="n">later</span><span class="o">.</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tree_to_onnx_18_2.png" src="../_images/tree_to_onnx_18_2.png" />
<p>Still the same.</p>
</section>
<section id="text-visualization">
<h2><a class="toc-backref" href="#id65">Text visualization</a><a class="headerlink" href="#text-visualization" title="Permalink to this headline">¶</a></h2>
<p>This can be useful to debug a function building a tree.</p>
<p>See
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/plotting/text_plot.html#mlprodict.plotting.text_plot.onnx_text_plot_tree">onnx_text_plot_tree</a>,
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.export_text.html?highlight=export_text#sklearn.tree.export_text">export_text</a>,
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.plot_tree.html?highlight=plot_tree#sklearn.tree.plot_tree">plot_tree</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_text_plot_tree</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_text_plot_tree</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_targets</span><span class="o">=</span><span class="mi">1</span>
<span class="n">n_trees</span><span class="o">=</span><span class="mi">1</span>
<span class="o">----</span>
<span class="n">treeid</span><span class="o">=</span><span class="mi">0</span>
 <span class="n">X0</span> <span class="o">&lt;=</span> <span class="mf">0.0</span>
   <span class="n">F</span> <span class="n">X1</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.1</span>
      <span class="n">F</span> <span class="n">y</span><span class="o">=</span><span class="mf">3.0</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span> <span class="n">i</span><span class="o">=</span><span class="mi">6</span>
      <span class="n">T</span> <span class="n">y</span><span class="o">=</span><span class="mf">2.0</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span> <span class="n">i</span><span class="o">=</span><span class="mi">5</span>
   <span class="n">T</span> <span class="n">X1</span> <span class="o">&lt;=</span> <span class="mf">0.19999999</span>
      <span class="n">F</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span> <span class="n">i</span><span class="o">=</span><span class="mi">3</span>
      <span class="n">T</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span> <span class="n">i</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">export_text</span>

<span class="nb">print</span><span class="p">(</span><span class="n">export_text</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|---</span> <span class="n">feature_0</span> <span class="o">&lt;=</span> <span class="mf">0.00</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&lt;=</span> <span class="mf">0.20</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">]</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&gt;</span>  <span class="mf">0.20</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.00</span><span class="p">]</span>
<span class="o">|---</span> <span class="n">feature_0</span> <span class="o">&gt;</span>  <span class="mf">0.00</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.10</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.00</span><span class="p">]</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&gt;</span>  <span class="o">-</span><span class="mf">0.10</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.00</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">plot_tree</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/tree_to_onnx_23_0.png" src="../_images/tree_to_onnx_23_0.png" />
</section>
<section id="convert-a-forest-of-trees">
<h2><a class="toc-backref" href="#id66">Convert a forest of trees</a><a class="headerlink" href="#convert-a-forest-of-trees" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/onnx/sklearn-onnx">sklearn-onnx</a> does not support
the conversion of mulitple trees in a list. It can only convert a model.
Converting list produces the following error:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">to_onnx</span><span class="p">([</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">],</span> <span class="n">feat</span><span class="p">,</span> <span class="n">target_opset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">shape</span> <span class="n">calculator</span> <span class="k">for</span> <span class="nb">type</span> <span class="s1">&#39;&lt;class &#39;</span><span class="nb">list</span><span class="s1">&#39;&gt;&#39;</span><span class="o">.</span>
<span class="n">It</span> <span class="n">usually</span> <span class="n">means</span> <span class="n">the</span> <span class="n">pipeline</span> <span class="n">being</span> <span class="n">converted</span> <span class="n">contains</span> <span class="n">a</span>
<span class="n">transformer</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">predictor</span> <span class="k">with</span> <span class="n">no</span> <span class="n">corresponding</span> <span class="n">converter</span>
<span class="n">implemented</span> <span class="ow">in</span> <span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">converted</span> <span class="ow">is</span> <span class="n">implemented</span>
<span class="ow">in</span> <span class="n">another</span> <span class="n">library</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">register</span>
<span class="n">the</span> <span class="n">converted</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">by</span> <span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span> <span class="p">(</span><span class="n">function</span>
<span class="n">update_registered_converter</span><span class="p">)</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">covered</span>
<span class="n">by</span> <span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="p">,</span> <span class="n">you</span> <span class="n">may</span> <span class="k">raise</span> <span class="n">an</span> <span class="n">issue</span> <span class="n">to</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">onnx</span><span class="o">/</span><span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="o">/</span><span class="n">issues</span>
<span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">converter</span> <span class="n">implemented</span> <span class="ow">or</span> <span class="n">even</span> <span class="n">contribute</span> <span class="n">to</span> <span class="n">the</span>
<span class="n">project</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">model</span><span class="p">,</span> <span class="n">a</span> <span class="n">new</span> <span class="n">converter</span> <span class="n">must</span>
<span class="n">be</span> <span class="n">implemented</span><span class="o">.</span> <span class="n">Examples</span> <span class="n">can</span> <span class="n">be</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">gallery</span><span class="o">.</span>
</pre></div>
</div>
<p>However, the model
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">RandomForestRegressor</a>
is an average of decision trees which we can use to convert those trees.
Let’s assume we want to convert weighted average of regressions tree. We
first need to multiply every leaf of a tree by its weight.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.tree._tree</span> <span class="kn">import</span> <span class="n">Tree</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>


<span class="k">def</span> <span class="nf">build_dummy_tree</span><span class="p">(</span><span class="n">leaf_values</span><span class="p">):</span>
    <span class="n">UNUSED</span> <span class="o">=</span> <span class="mi">99999</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># n_features</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">intp</span><span class="p">),</span>  <span class="c1">#  n_classes</span>
                <span class="mi">1</span><span class="p">,</span>  <span class="c1"># n_outputs</span>
                <span class="p">)</span>


    <span class="c1"># First node: the root: x &lt;= 0</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                          <span class="o">-</span><span class="mi">1</span><span class="p">,</span>          <span class="c1"># parent index</span>
                          <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is left node</span>
                          <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is leaf</span>
                          <span class="mi">0</span><span class="p">,</span>           <span class="c1"># feature index</span>
                          <span class="mi">0</span><span class="p">,</span>           <span class="c1"># threshold</span>
                          <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNUSED</span><span class="p">)</span>


    <span class="c1"># Second node: y &lt;= 0.2</span>
    <span class="n">index1</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                           <span class="n">index</span><span class="p">,</span>       <span class="c1"># parent index</span>
                           <span class="kc">True</span><span class="p">,</span>        <span class="c1"># is left node</span>
                           <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is leaf</span>
                           <span class="mi">1</span><span class="p">,</span>           <span class="c1"># feature index</span>
                           <span class="mf">0.2</span><span class="p">,</span>         <span class="c1"># threshold</span>
                           <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNUSED</span><span class="p">)</span>

    <span class="c1"># First leaf</span>
    <span class="n">leaf_1</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leaf_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Second leaf</span>
    <span class="n">leaf_2</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leaf_values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Third node: y &lt;= -0.1</span>
    <span class="n">index2</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span>
                           <span class="n">index</span><span class="p">,</span>       <span class="c1"># parent index</span>
                           <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is left node</span>
                           <span class="kc">False</span><span class="p">,</span>       <span class="c1"># is right node</span>
                           <span class="mi">1</span><span class="p">,</span>           <span class="c1"># feature index</span>
                           <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>        <span class="c1"># threshold</span>
                           <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>    <span class="c1"># impurity, n_node_samples, node weight</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNUSED</span><span class="p">)</span>

    <span class="c1"># Third leaf</span>
    <span class="n">leaf_3</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leaf_values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Fourth leaf</span>
    <span class="n">leaf_4</span> <span class="o">=</span> <span class="n">tree_add_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leaf_values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">tree</span><span class="o">.</span><span class="n">value</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">reg</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">tree_</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">n_outputs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">n_outputs_</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">n_features_in_</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># scikit-learn &gt;= 0.24</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">maxdepth</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">max_depth</span>
    <span class="k">return</span> <span class="n">reg</span>


<span class="k">def</span> <span class="nf">build_dummy_forest</span><span class="p">(</span><span class="n">trees</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span> <span class="o">=</span> <span class="n">trees</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">n_outputs_</span> <span class="o">=</span> <span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_outputs_</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">n_features_in_</span> <span class="o">=</span> <span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_features_in_</span>
    <span class="k">return</span> <span class="n">rf</span>


<span class="n">tree1</span> <span class="o">=</span> <span class="n">build_dummy_tree</span><span class="p">(</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">tree2</span> <span class="o">=</span> <span class="n">build_dummy_tree</span><span class="p">(</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>

<span class="n">rf</span> <span class="o">=</span> <span class="n">build_dummy_forest</span><span class="p">([</span><span class="n">tree1</span><span class="p">,</span> <span class="n">tree2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">export_text</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">export_text</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|---</span> <span class="n">feature_0</span> <span class="o">&lt;=</span> <span class="mf">0.00</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&lt;=</span> <span class="mf">0.20</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.80</span><span class="p">]</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&gt;</span>  <span class="mf">0.20</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.00</span><span class="p">]</span>
<span class="o">|---</span> <span class="n">feature_0</span> <span class="o">&gt;</span>  <span class="mf">0.00</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.10</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.00</span><span class="p">]</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&gt;</span>  <span class="o">-</span><span class="mf">0.10</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.20</span><span class="p">]</span>
<span class="o">|---</span> <span class="n">feature_0</span> <span class="o">&lt;=</span> <span class="mf">0.00</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&lt;=</span> <span class="mf">0.20</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.00</span><span class="p">]</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&gt;</span>  <span class="mf">0.20</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.80</span><span class="p">]</span>
<span class="o">|---</span> <span class="n">feature_0</span> <span class="o">&gt;</span>  <span class="mf">0.00</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.10</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.00</span><span class="p">]</span>
<span class="o">|</span>   <span class="o">|---</span> <span class="n">feature_1</span> <span class="o">&gt;</span>  <span class="o">-</span><span class="mf">0.10</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|---</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.60</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">2.9000001</span><span class="p">])</span>
</pre></div>
</div>
<p>Conversion to ONNX.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">target_opset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="o">%</span><span class="k">onnxview</span> onx
</pre></div>
</div>
<div id="M5bc8a555e67f47bcb3c5d0d13d32cb36-cont"><div id="M5bc8a555e67f47bcb3c5d0d13d32cb36" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n\n  X [shape=box color=red label=\"X\nfloat((0, 2))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\nfloat((0, 1))\" fontsize=10];\n\n\n  TreeEnsembleRegressor [shape=box style=\"filled,rounded\" color=orange label=\"TreeEnsembleRegressor\n(TreeEnsembleRegressor)\nn_targets=1\nnodes_falsenodeids=[4 3 0 0 6 0...\nnodes_featureids=[0 1 0 0 1 0 0...\nnodes_hitrates=[1. 1. 1. 1. 1. ...\nnodes_missing_value_tracks_true=[0 0 0 0 0...\nnodes_modes=[b'BRANCH_LEQ' b'BR...\nnodes_nodeids=[0 1 2 3 4 5 6 0 ...\nnodes_treeids=[0 0 0 0 0 0 0 1 ...\nnodes_truenodeids=[1 2 0 0 5 0 ...\nnodes_values=[ 0.          0.19...\npost_transform=b'NONE'\ntarget_ids=[0 0 0 0 0 0 0 0]\ntarget_nodeids=[2 3 5 6 2 3 5 6...\ntarget_treeids=[0 0 0 0 1 1 1 1...\ntarget_weights=[ 0.4  0.5 -0.5 ...\" fontsize=10];\n  X -> TreeEnsembleRegressor;\n  TreeEnsembleRegressor -> variable;\n}");
document.getElementById('M5bc8a555e67f47bcb3c5d0d13d32cb36').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.9</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)]</span>
</pre></div>
</div>
<p>It works.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../all_notebooks.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Notebooks Gallery</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="onnxruntime_training_nb.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Stochastic Gradient Descent on simple function</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>