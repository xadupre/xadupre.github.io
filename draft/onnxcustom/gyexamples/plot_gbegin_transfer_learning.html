
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Transfer Learning with ONNX &#8212; onnxcustom</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Store arrays in one onnx graph" href="plot_gbegin_cst.html" />
    <link rel="prev" title="Dataframe as an input" href="plot_gbegin_dataframe.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/apis.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="index.html">
  Examples Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebooks Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../other_pages.html">
  Other pages
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../blog/blogindex.html">
  Blog Gallery
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnx/index.html">
   Introduction to ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnxruntime/index.html">
   Introduction to onnxruntime
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../tutorials/tutorial_skl/index.html">
   scikit-learn to ONNX Tutorial
  </a>
  <input checked class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_1_simple.html">
     The easy case
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="plot_abegin_convert_pipeline.html">
       Train and deploy a scikit-learn pipeline
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_bbegin_measure_time.html">
       Benchmark ONNX conversion
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_cbegin_opset.html">
       What is the opset number?
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_dbegin_options.html">
       One model, many possible conversions with options
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_dbegin_options_list.html">
       Black list operators when converting
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_dbegin_options_zipmap.html">
       Choose appropriate output of a classifier
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_ebegin_float_double.html">
       Issues when switching to float
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_funny_sigmoid.html">
       Funny discrepancies
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_fbegin_investigate.html">
       Intermediate results and investigation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gbegin_dataframe.html">
       Dataframe as an input
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Transfer Learning with ONNX
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gbegin_cst.html">
       Store arrays in one onnx graph
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gconverting.html">
       Modify the ONNX graph
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_1-5_external.html">
     Using converter from other libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_2_new_converter.html">
     A custom converter for a custom model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_3_new_operator.html">
     Extend ONNX, extend runtime
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_4_complex.html">
     Complex Scenarios
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_training/index.html">
   Training Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_bench/index.html">
   Benchmarking and profiling Tutorial
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retrieve-and-load-a-model">
   Retrieve and load a model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#classifying-an-image">
   Classifying an image
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#classifying-more-images">
   Classifying more images
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transfer-learning-in-a-pipeline">
   Transfer learning in a pipeline
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#graph-for-the-pca">
     Graph for the PCA
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#remove-one-layer-at-the-end">
     Remove one layer at the end
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-gbegin-transfer-learning-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="transfer-learning-with-onnx">
<span id="sphx-glr-gyexamples-plot-gbegin-transfer-learning-py"></span><h1>Transfer Learning with ONNX<a class="headerlink" href="#transfer-learning-with-onnx" title="Permalink to this headline">¶</a></h1>
<p id="index-0">Transfer learning is common with deep learning.
A deep learning model is used as preprocessing before
the output is sent to a final classifier or regressor.
It is not quite easy in this case to mix framework,
<a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> with <a class="reference external" href="https://pytorch.org/">pytorch</a>
(or <a class="reference external" href="https://skorch.readthedocs.io/en/stable/">skorch</a>), the Keras API for Tensorflow,
<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/wrappers/scikit_learn">tf.keras.wrappers.scikit_learn</a>. Every combination
requires work. ONNX reduces the number of platforms to
support. Once the model is converted into ONNX,
it can be inserted in any <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> pipeline.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#retrieve-and-load-a-model" id="id1">Retrieve and load a model</a></p></li>
<li><p><a class="reference internal" href="#classifying-an-image" id="id2">Classifying an image</a></p></li>
<li><p><a class="reference internal" href="#classifying-more-images" id="id3">Classifying more images</a></p></li>
<li><p><a class="reference internal" href="#transfer-learning-in-a-pipeline" id="id4">Transfer learning in a pipeline</a></p>
<ul>
<li><p><a class="reference internal" href="#graph-for-the-pca" id="id5">Graph for the PCA</a></p></li>
<li><p><a class="reference internal" href="#remove-one-layer-at-the-end" id="id6">Remove one layer at the end</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="retrieve-and-load-a-model">
<h2><a class="toc-backref" href="#id1">Retrieve and load a model</a><a class="headerlink" href="#retrieve-and-load-a-model" title="Permalink to this headline">¶</a></h2>
<p>We download one model from the <a class="reference external" href="https://github.com/onnx/models">ONNX Zoo</a> but the model
could be trained and produced by another converter library.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.sklapi</span> <span class="kn">import</span> <span class="n">OnnxTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">mlinsights.plotting.gallery</span> <span class="kn">import</span> <span class="n">plot_gallery_images</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">onnxcustom.utils.imagenet_classes</span> <span class="kn">import</span> <span class="n">class_names</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>


<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">min_size</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;download &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to download &#39;</span><span class="si">{}</span><span class="s2">&#39; due to</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;downloaded </span><span class="si">%d</span><span class="s2"> bytes.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; already downloaded&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;squeezenet1.1-7.onnx&quot;</span>
<span class="n">url_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;https://github.com/onnx/models/raw/main/vision/&quot;</span>
            <span class="s2">&quot;classification/squeezenet/model&quot;</span><span class="p">)</span>
<span class="n">url_name</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">model_name</span>
<span class="n">download_file</span><span class="p">(</span><span class="n">url_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>download &#39;https://github.com/onnx/models/raw/main/vision/classification/squeezenet/model/squeezenet1.1-7.onnx&#39;
downloaded 4956208 bytes.
</pre></div>
</div>
<p>Loading the ONNX file and use it on one image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>NodeArg(name=&#39;data&#39;, type=&#39;tensor(float)&#39;, shape=[1, 3, 224, 224])
</pre></div>
</div>
<p>The model expects a series of images of size
<cite>[3, 224, 224]</cite>.</p>
</section>
<section id="classifying-an-image">
<h2><a class="toc-backref" href="#id2">Classifying an image</a><a class="headerlink" href="#classifying-an-image" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/d/d2/&quot;</span>
       <span class="s2">&quot;East_Coker_elm%2C_2.jpg&quot;</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="s2">&quot;East_Coker_elm.jpg&quot;</span>
<span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>

<span class="n">im0</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">im0</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
<span class="c1"># im.show()</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>download &#39;https://upload.wikimedia.org/wikipedia/commons/d/d2/East_Coker_elm%2C_2.jpg&#39;
downloaded 712230 bytes.
</pre></div>
</div>
<p>Image to numpy and predection.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">im2array</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">im2array</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[145.59464   55.067673  60.599747  46.29393   37.98244 ]
</pre></div>
</div>
<p>Interpretation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[(205.84172, &#39;Samoyed, Samoyede&#39;), (212.0366, &#39;park bench&#39;), (225.50684, &#39;lakeside, lakeshore&#39;), (232.90251, &#39;fountain&#39;), (258.10968, &#39;geyser&#39;)]
</pre></div>
</div>
</section>
<section id="classifying-more-images">
<h2><a class="toc-backref" href="#id3">Classifying more images</a><a class="headerlink" href="#classifying-more-images" title="Permalink to this headline">¶</a></h2>
<p>The initial image is rotated,
the answer is changing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="mf">2.</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
<span class="n">imgs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">angle</span><span class="p">,</span> <span class="n">im0</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">angle</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">im2array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
            <span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">angle</span><span class="p">,</span> <span class="n">pl</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">labels</span>


<span class="n">climgs</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
<span class="k">for</span> <span class="n">angle</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">climgs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;angle=</span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">res</span><span class="p">[:</span><span class="mi">5</span><span class="p">]))</span>


<span class="n">plot_gallery_images</span><span class="p">([</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:</span><span class="mi">15</span><span class="p">]</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">climgs</span><span class="p">])</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_gbegin_transfer_learning_001.png" srcset="../_images/sphx_glr_plot_gbegin_transfer_learning_001.png" alt="plot gbegin transfer learning" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>angle=-12.0 - [(247.06139, &#39;obelisk&#39;), (238.95375, &#39;car mirror&#39;), (235.27644, &#39;flagpole, flagstaff&#39;), (231.51715, &#39;window screen&#39;), (230.90665, &#39;picket fence, paling&#39;)]
angle=-10.0 - [(254.24683, &#39;car mirror&#39;), (251.51355, &#39;obelisk&#39;), (235.1051, &#39;groom, bridegroom&#39;), (234.5295, &#39;picket fence, paling&#39;), (232.13913, &#39;church, church building&#39;)]
angle=-8.0 - [(235.56947, &#39;obelisk&#39;), (226.59702, &#39;car mirror&#39;), (226.46767, &#39;picket fence, paling&#39;), (221.46799, &#39;groom, bridegroom&#39;), (220.8851, &#39;fountain&#39;)]
angle=-6.0 - [(265.50803, &#39;geyser&#39;), (243.6862, &#39;obelisk&#39;), (238.92964, &#39;fountain&#39;), (226.73685, &#39;pedestal, plinth, footstall&#39;), (226.11945, &#39;Great Pyrenees&#39;)]
angle=-4.0 - [(287.74472, &#39;geyser&#39;), (255.25311, &#39;fountain&#39;), (236.8495, &#39;obelisk&#39;), (223.02892, &#39;Great Pyrenees&#39;), (222.80464, &#39;church, church building&#39;)]
angle=-2.0 - [(267.63535, &#39;geyser&#39;), (251.4896, &#39;fountain&#39;), (214.64238, &#39;obelisk&#39;), (214.56233, &#39;mobile home, manufactured home&#39;), (213.12416, &#39;flagpole, flagstaff&#39;)]
angle=0.0 - [(258.10968, &#39;geyser&#39;), (232.90251, &#39;fountain&#39;), (225.50684, &#39;lakeside, lakeshore&#39;), (212.0366, &#39;park bench&#39;), (205.84172, &#39;Samoyed, Samoyede&#39;)]
angle=2.0 - [(222.7483, &#39;geyser&#39;), (213.38457, &#39;fountain&#39;), (212.24373, &#39;obelisk&#39;), (198.37137, &#39;beacon, lighthouse, beacon light, pharos&#39;), (197.43808, &#39;picket fence, paling&#39;)]
angle=4.0 - [(221.34749, &#39;geyser&#39;), (209.60358, &#39;fountain&#39;), (207.06915, &#39;American egret, great white heron, Egretta albus&#39;), (201.63094, &#39;obelisk&#39;), (198.75664, &#39;Great Pyrenees&#39;)]
angle=6.0 - [(230.98729, &#39;American egret, great white heron, Egretta albus&#39;), (216.63416, &#39;fountain&#39;), (212.7324, &#39;groom, bridegroom&#39;), (209.60928, &#39;flagpole, flagstaff&#39;), (209.46211, &#39;swimming trunks, bathing trunks&#39;)]
angle=8.0 - [(253.32701, &#39;American egret, great white heron, Egretta albus&#39;), (222.69963, &#39;golf ball&#39;), (222.50493, &#39;groom, bridegroom&#39;), (222.36345, &#39;sulphur-crested cockatoo, Kakatoe galerita, Cacatua galerita&#39;), (217.73135, &#39;swimming trunks, bathing trunks&#39;)]
angle=10.0 - [(244.30115, &#39;solar dish, solar collector, solar furnace&#39;), (239.57332, &#39;flagpole, flagstaff&#39;), (234.92137, &#39;picket fence, paling&#39;), (230.62117, &#39;car mirror&#39;), (221.87946, &#39;screen, CRT screen&#39;)]

array([[&lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;],
       [&lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;],
       [&lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;, &lt;AxesSubplot:&gt;]],
      dtype=object)
</pre></div>
</div>
</section>
<section id="transfer-learning-in-a-pipeline">
<h2><a class="toc-backref" href="#id4">Transfer learning in a pipeline</a><a class="headerlink" href="#transfer-learning-in-a-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The proposed transfer learning consists
using a PCA to projet the probabilities
on a graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">model_bytes</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="n">OnnxTransformer</span><span class="p">(</span>
        <span class="n">model_bytes</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime1&#39;</span><span class="p">,</span> <span class="n">change_batch_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
    <span class="p">[</span><span class="n">im2array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="n">proj</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[[-676.5762   -203.35457 ]
 [-570.6659   -208.09712 ]
 [-339.81204   -86.33981 ]
 [ -14.555829 -168.44829 ]
 [ 357.2239   -157.6136  ]
 [ 596.38605   -90.2109  ]
 [ 918.8613    -26.340012]
 [ 499.87158   128.27254 ]
 [ 306.68607   156.42967 ]
 [-125.911835  119.21933 ]
 [-446.60468   342.4584  ]
 [-504.9029    194.02429 ]]
</pre></div>
</div>
<section id="graph-for-the-pca">
<h3><a class="toc-backref" href="#id5">Graph for the PCA</a><a class="headerlink" href="#graph-for-the-pca" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">proj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">proj</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Projection of classification probabilities&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%1.0f</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">climgs</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">proj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">proj</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.5&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3,rad=0&#39;</span><span class="p">))</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_gbegin_transfer_learning_002.png" srcset="../_images/sphx_glr_plot_gbegin_transfer_learning_002.png" alt="Projection of classification probabilities" class = "sphx-glr-single-img"/></section>
<section id="remove-one-layer-at-the-end">
<h3><a class="toc-backref" href="#id6">Remove one layer at the end</a><a class="headerlink" href="#remove-one-layer-at-the-end" title="Permalink to this headline">¶</a></h3>
<p>The last is often removed before the model is
inserted in a pipeline. Let’s see how to do that.
First, we need the list of output for every node.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model_onnx</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">model_bytes</span><span class="p">))</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model_onnx</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>squeezenet0_conv0_fwd [&#39;squeezenet0_conv0_fwd&#39;]
squeezenet0_relu0_fwd [&#39;squeezenet0_relu0_fwd&#39;]
squeezenet0_pool0_fwd [&#39;squeezenet0_pool0_fwd&#39;]
squeezenet0_conv1_fwd [&#39;squeezenet0_conv1_fwd&#39;]
squeezenet0_relu1_fwd [&#39;squeezenet0_relu1_fwd&#39;]
squeezenet0_conv2_fwd [&#39;squeezenet0_conv2_fwd&#39;]
squeezenet0_relu2_fwd [&#39;squeezenet0_relu2_fwd&#39;]
squeezenet0_conv3_fwd [&#39;squeezenet0_conv3_fwd&#39;]
squeezenet0_relu3_fwd [&#39;squeezenet0_relu3_fwd&#39;]
squeezenet0_concat0 [&#39;squeezenet0_concat0&#39;]
squeezenet0_conv4_fwd [&#39;squeezenet0_conv4_fwd&#39;]
squeezenet0_relu4_fwd [&#39;squeezenet0_relu4_fwd&#39;]
squeezenet0_conv5_fwd [&#39;squeezenet0_conv5_fwd&#39;]
squeezenet0_relu5_fwd [&#39;squeezenet0_relu5_fwd&#39;]
squeezenet0_conv6_fwd [&#39;squeezenet0_conv6_fwd&#39;]
squeezenet0_relu6_fwd [&#39;squeezenet0_relu6_fwd&#39;]
squeezenet0_concat1 [&#39;squeezenet0_concat1&#39;]
squeezenet0_pool1_fwd [&#39;squeezenet0_pool1_fwd&#39;]
squeezenet0_conv7_fwd [&#39;squeezenet0_conv7_fwd&#39;]
squeezenet0_relu7_fwd [&#39;squeezenet0_relu7_fwd&#39;]
squeezenet0_conv8_fwd [&#39;squeezenet0_conv8_fwd&#39;]
squeezenet0_relu8_fwd [&#39;squeezenet0_relu8_fwd&#39;]
squeezenet0_conv9_fwd [&#39;squeezenet0_conv9_fwd&#39;]
squeezenet0_relu9_fwd [&#39;squeezenet0_relu9_fwd&#39;]
squeezenet0_concat2 [&#39;squeezenet0_concat2&#39;]
squeezenet0_conv10_fwd [&#39;squeezenet0_conv10_fwd&#39;]
squeezenet0_relu10_fwd [&#39;squeezenet0_relu10_fwd&#39;]
squeezenet0_conv11_fwd [&#39;squeezenet0_conv11_fwd&#39;]
squeezenet0_relu11_fwd [&#39;squeezenet0_relu11_fwd&#39;]
squeezenet0_conv12_fwd [&#39;squeezenet0_conv12_fwd&#39;]
squeezenet0_relu12_fwd [&#39;squeezenet0_relu12_fwd&#39;]
squeezenet0_concat3 [&#39;squeezenet0_concat3&#39;]
squeezenet0_pool2_fwd [&#39;squeezenet0_pool2_fwd&#39;]
squeezenet0_conv13_fwd [&#39;squeezenet0_conv13_fwd&#39;]
squeezenet0_relu13_fwd [&#39;squeezenet0_relu13_fwd&#39;]
squeezenet0_conv14_fwd [&#39;squeezenet0_conv14_fwd&#39;]
squeezenet0_relu14_fwd [&#39;squeezenet0_relu14_fwd&#39;]
squeezenet0_conv15_fwd [&#39;squeezenet0_conv15_fwd&#39;]
squeezenet0_relu15_fwd [&#39;squeezenet0_relu15_fwd&#39;]
squeezenet0_concat4 [&#39;squeezenet0_concat4&#39;]
squeezenet0_conv16_fwd [&#39;squeezenet0_conv16_fwd&#39;]
squeezenet0_relu16_fwd [&#39;squeezenet0_relu16_fwd&#39;]
squeezenet0_conv17_fwd [&#39;squeezenet0_conv17_fwd&#39;]
squeezenet0_relu17_fwd [&#39;squeezenet0_relu17_fwd&#39;]
squeezenet0_conv18_fwd [&#39;squeezenet0_conv18_fwd&#39;]
squeezenet0_relu18_fwd [&#39;squeezenet0_relu18_fwd&#39;]
squeezenet0_concat5 [&#39;squeezenet0_concat5&#39;]
squeezenet0_conv19_fwd [&#39;squeezenet0_conv19_fwd&#39;]
squeezenet0_relu19_fwd [&#39;squeezenet0_relu19_fwd&#39;]
squeezenet0_conv20_fwd [&#39;squeezenet0_conv20_fwd&#39;]
squeezenet0_relu20_fwd [&#39;squeezenet0_relu20_fwd&#39;]
squeezenet0_conv21_fwd [&#39;squeezenet0_conv21_fwd&#39;]
squeezenet0_relu21_fwd [&#39;squeezenet0_relu21_fwd&#39;]
squeezenet0_concat6 [&#39;squeezenet0_concat6&#39;]
squeezenet0_conv22_fwd [&#39;squeezenet0_conv22_fwd&#39;]
squeezenet0_relu22_fwd [&#39;squeezenet0_relu22_fwd&#39;]
squeezenet0_conv23_fwd [&#39;squeezenet0_conv23_fwd&#39;]
squeezenet0_relu23_fwd [&#39;squeezenet0_relu23_fwd&#39;]
squeezenet0_conv24_fwd [&#39;squeezenet0_conv24_fwd&#39;]
squeezenet0_relu24_fwd [&#39;squeezenet0_relu24_fwd&#39;]
squeezenet0_concat7 [&#39;squeezenet0_concat7&#39;]
squeezenet0_dropout0_fwd [&#39;squeezenet0_dropout0_fwd&#39;]
squeezenet0_conv25_fwd [&#39;squeezenet0_conv25_fwd&#39;]
squeezenet0_relu25_fwd [&#39;squeezenet0_relu25_fwd&#39;]
squeezenet0_pool3_fwd [&#39;squeezenet0_pool3_fwd&#39;]
squeezenet0_flatten0_reshape0 [&#39;squeezenet0_flatten0_reshape0&#39;]
</pre></div>
</div>
<p>We select one of the last one.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">selected</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="n">selected</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>selected squeezenet0_relu25_fwd
</pre></div>
</div>
<p>And we tell <em>OnnxTransformer</em> to use that
specific one and to flatten the output
as the dimension is not a matrix.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipe2</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="n">OnnxTransformer</span><span class="p">(</span>
        <span class="n">model_bytes</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime1&#39;</span><span class="p">,</span> <span class="n">change_batch_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">selected</span><span class="p">,</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">pipe2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;deep&#39;,
                 OnnxTransformer(change_batch_size=0, onnx_bytes=b&#39;\x08\x03:\xa5\xc0\xae\x02\n\xca\x01\n\x04data\n\x18squeezenet0_conv0_weight\n\x16squeezenet0_conv0_bias\x12\x15squeezenet0_conv0_fwd\x1a\x15squeezenet0_conv0_fwd&quot;\x04Conv*\x12\n\tdilations@\x01@\x01\xa0\x01\x07*\x0c\n\x05group\x18\x01\xa0\x01\x02*\x15\n\x0ckernel_shape@\x03@\x...zenet0_conv25_bias\x12\x0b\n\t\x08\x01\x12\x05\n\x03\x08\xe8\x07Z$\n\x16reshape_attr_tensor118\x12\n\n\x08\x08\x07\x12\x04\n\x02\x08\x02b0\n\x1dsqueezenet0_flatten0_reshape0\x12\x0f\n\r\x08\x01\x12\t\n\x02\x08\x01\n\x03\x08\xe8\x07B\x02\x10\x07&#39;, output_name=&#39;squeezenet0_relu25_fwd&#39;, reshape=True, runtime=&#39;onnxruntime1&#39;)),
                (&#39;pca&#39;, PCA(n_components=2))])
</pre></div>
</div>
<p>We check that it is different.
The following values are the shape of the
PCA components. The number of column is the number
of dimensions of the outputs of the transfered
neural network.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
      <span class="n">pipe2</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(2, 1000) (2, 169000)
</pre></div>
</div>
<p>Graph again.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">proj2</span> <span class="o">=</span> <span class="n">pipe2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">proj2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">proj2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Second projection of classification probabilities&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%1.0f</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">climgs</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">proj2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">proj2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.5&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3,rad=0&#39;</span><span class="p">))</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_gbegin_transfer_learning_003.png" srcset="../_images/sphx_glr_plot_gbegin_transfer_learning_003.png" alt="Second projection of classification probabilities" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  12.040 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-gbegin-transfer-learning-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/a9e248a6255e452c1d327aa552392af9/plot_gbegin_transfer_learning.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_gbegin_transfer_learning.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/e363aa1efefc0ccef7f7fe6e5c9dde62/plot_gbegin_transfer_learning.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_gbegin_transfer_learning.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_gbegin_dataframe.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Dataframe as an input</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_gbegin_cst.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Store arrays in one onnx graph</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>