
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Profile onnxruntime execution &#8212; onnxcustom</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Profiling of ONNX graph with onnxruntime" href="plot_profile_ort_onnx.html" />
    <link rel="prev" title="Profiling" href="../tutorials/tutorial_bench/tutorial_profile.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/apis.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="index.html">
  Examples Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebooks Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../other_pages.html">
  Other pages
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../blog/blogindex.html">
  Blog Gallery
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnx/index.html">
   Introduction to ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnxruntime/index.html">
   Introduction to onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_skl/index.html">
   scikit-learn to ONNX Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_training/index.html">
   Training Tutorial
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../tutorials/tutorial_bench/index.html">
   Benchmarking and profiling Tutorial
  </a>
  <input checked class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_op.html">
     Study behavior of one operator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_benchmark.html">
     Inference
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_profile.html">
     Profiling
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Profile onnxruntime execution
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_profile_ort_onnx.html">
       Profiling of ONNX graph with onnxruntime
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_training.html">
     Training
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#neareast-neighbours">
   Neareast Neighbours
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-the-model">
   Building the model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conversion-to-onnx">
   Conversion to ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling">
   Profiling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#better-rendering">
   Better rendering
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#graphs">
   Graphs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gpu-or-cpu">
   GPU or CPU
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-profile-ort-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="profile-onnxruntime-execution">
<span id="l-profile-ort-api"></span><span id="sphx-glr-gyexamples-plot-profile-ort-py"></span><h1>Profile onnxruntime execution<a class="headerlink" href="#profile-onnxruntime-execution" title="Permalink to this headline">¶</a></h1>
<p>The following examples converts a model into <a class="reference external" href="https://onnx.ai/">ONNX</a> and runs it
with <a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a>. This one is then uses to profile the execution
by looking the time spent in each operator. This analysis gives some
hints on how to optimize the processing time by looking the nodes
consuming most of the ressources.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#neareast-neighbours" id="id1">Neareast Neighbours</a></p></li>
<li><p><a class="reference internal" href="#building-the-model" id="id2">Building the model</a></p></li>
<li><p><a class="reference internal" href="#conversion-to-onnx" id="id3">Conversion to ONNX</a></p></li>
<li><p><a class="reference internal" href="#profiling" id="id4">Profiling</a></p></li>
<li><p><a class="reference internal" href="#better-rendering" id="id5">Better rendering</a></p></li>
<li><p><a class="reference internal" href="#graphs" id="id6">Graphs</a></p></li>
<li><p><a class="reference internal" href="#gpu-or-cpu" id="id7">GPU or CPU</a></p></li>
</ul>
</div>
<section id="neareast-neighbours">
<h2><a class="toc-backref" href="#id1">Neareast Neighbours</a><a class="headerlink" href="#neareast-neighbours" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_divider</span> <span class="kn">import</span> <span class="n">make_axes_area_auto_adjustable</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span><span class="p">,</span> <span class="n">SessionOptions</span><span class="p">,</span> <span class="n">get_device</span>
<span class="kn">from</span> <span class="nn">onnxruntime.capi._pybind_state</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># pylint: disable=E0611</span>
    <span class="n">SessionIOBinding</span><span class="p">,</span> <span class="n">OrtDevice</span> <span class="k">as</span> <span class="n">C_OrtDevice</span><span class="p">,</span> <span class="n">OrtValue</span> <span class="k">as</span> <span class="n">C_OrtValue</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">RadiusNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">mlprodict.testing.experimental_c_impl.experimental_c</span> <span class="kn">import</span> <span class="n">code_optimisation</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.plotting</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span><span class="p">,</span> <span class="n">plot_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt.ops_whole.session</span> <span class="kn">import</span> <span class="n">OnnxWholeSession</span>
</pre></div>
</div>
<p>Available optimisation on this machine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">code_optimisation</span><span class="p">())</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>AVX-omp=8
</pre></div>
</div>
</section>
<section id="building-the-model">
<h2><a class="toc-backref" href="#id2">Building the model</a><a class="headerlink" href="#building-the-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RadiusNeighborsRegressor</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>RadiusNeighborsRegressor()
</pre></div>
</div>
</section>
<section id="conversion-to-onnx">
<h2><a class="toc-backref" href="#id3">Conversion to ONNX</a><a class="headerlink" href="#conversion-to-onnx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;optim&#39;</span><span class="p">:</span> <span class="s1">&#39;cdist&#39;</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=15
opset: domain=&#39;ai.onnx.ml&#39; version=1
opset: domain=&#39;com.microsoft&#39; version=1
input: name=&#39;X&#39; type=dtype(&#39;float64&#39;) shape=(0, 10)
init: name=&#39;knny_ArrayFeatureExtractorcst&#39; type=dtype(&#39;float64&#39;) shape=(1000,)
init: name=&#39;cond_CDistcst&#39; type=dtype(&#39;float64&#39;) shape=(10000,)
init: name=&#39;cond_Lesscst&#39; type=dtype(&#39;float64&#39;) shape=(1,) -- array([1.])
init: name=&#39;arange_CumSumcst&#39; type=dtype(&#39;int64&#39;) shape=(1,) -- array([1])
init: name=&#39;knny_Reshapecst&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([  -1, 1000])
init: name=&#39;Re_Reshapecst&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([-1,  1])
CDist(X, cond_CDistcst) -&gt; cond_dist
  Shape(cond_dist) -&gt; arange_shape0
    ConstantOfShape(arange_shape0) -&gt; arange_output01
      Cast(arange_output01, to=7) -&gt; arange_output0
        CumSum(arange_output0, arange_CumSumcst) -&gt; arange_y0
          Neg(arange_y0) -&gt; arange_Y0
        Add(arange_Y0, arange_output0) -&gt; arange_C0
  Less(cond_dist, cond_Lesscst) -&gt; cond_C0
    Cast(cond_C0, to=11) -&gt; nnbin_output0
      ReduceSum(nnbin_output0, arange_CumSumcst, keepdims=0) -&gt; norm_reduced0
    Where(cond_C0, arange_C0, arange_output0) -&gt; nnind_output0
      Flatten(nnind_output0) -&gt; knny_output0
        ArrayFeatureExtractor(knny_ArrayFeatureExtractorcst, knny_output0) -&gt; knny_Z0
          Reshape(knny_Z0, knny_Reshapecst, allowzero=0) -&gt; knny_reshaped0
            Cast(knny_reshaped0, to=11) -&gt; final_output0
      Mul(final_output0, nnbin_output0) -&gt; final_C0
        ReduceSum(final_C0, arange_CumSumcst, keepdims=0) -&gt; final_reduced0
          Shape(final_reduced0) -&gt; normr_shape0
        Reshape(norm_reduced0, normr_shape0, allowzero=0) -&gt; normr_reshaped0
          Div(final_reduced0, normr_reshaped0) -&gt; Di_C0
            Reshape(Di_C0, Re_Reshapecst, allowzero=0) -&gt; variable
output: name=&#39;variable&#39; type=dtype(&#39;float64&#39;) shape=(0, 1)
</pre></div>
</div>
<p>The ONNX graph looks like the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plot_onnx</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_profile_ort_001.png" srcset="../_images/sphx_glr_plot_profile_ort_001.png" alt="plot profile ort" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
</section>
<section id="profiling">
<h2><a class="toc-backref" href="#id4">Profiling</a><a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h2>
<p>The profiling is enabled by setting attribute <cite>enable_profling</cite>
in <a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnxruntime_python/inference.html#sessionoptions">SessionOptions</a>. Method <em>end_profiling</em> collects
all the results and stores it on disk in <a class="reference external" href="https://en.wikipedia.org/wiki/JSON">JSON</a> format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">so</span> <span class="o">=</span> <span class="n">SessionOptions</span><span class="p">()</span>
<span class="n">so</span><span class="o">.</span><span class="n">enable_profiling</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">so</span><span class="p">,</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">feeds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">[:</span><span class="mi">100</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">feeds</span><span class="p">)</span>

<span class="n">prof</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">end_profiling</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prof</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/10 [00:00&lt;?, ?it/s]
 70%|#######   | 7/10 [00:00&lt;00:00, 65.66it/s]
100%|##########| 10/10 [00:00&lt;00:00, 65.15it/s]
onnxruntime_profile__2022-03-08_02-44-53.json
</pre></div>
</div>
</section>
<section id="better-rendering">
<h2><a class="toc-backref" href="#id5">Better rendering</a><a class="headerlink" href="#better-rendering" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">OnnxWholeSession</span><span class="o">.</span><span class="n">process_profiling</span><span class="p">(</span><span class="n">js</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cat</th>
      <th>pid</th>
      <th>tid</th>
      <th>dur</th>
      <th>ts</th>
      <th>ph</th>
      <th>name</th>
      <th>args_op_name</th>
      <th>args_thread_scheduling_stats</th>
      <th>args_activation_size</th>
      <th>args_parameter_size</th>
      <th>args_graph_index</th>
      <th>args_output_size</th>
      <th>args_provider</th>
      <th>args_exec_plan_index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>2084</td>
      <td>6</td>
      <td>X</td>
      <td>model_loading_array</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>8176</td>
      <td>2211</td>
      <td>X</td>
      <td>session_initialization</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>1</td>
      <td>13134</td>
      <td>X</td>
      <td>cond_CDist_fence_before</td>
      <td>CDist</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>3243</td>
      <td>13152</td>
      <td>X</td>
      <td>cond_CDist_kernel_time</td>
      <td>CDist</td>
      <td>{'main_thread': {'thread_pool_name': 'session-...</td>
      <td>8000</td>
      <td>80000</td>
      <td>0</td>
      <td>800000</td>
      <td>CPUExecutionProvider</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>1</td>
      <td>16430</td>
      <td>X</td>
      <td>cond_CDist_fence_after</td>
      <td>CDist</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>617</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>0</td>
      <td>166076</td>
      <td>X</td>
      <td>Re_Reshape_fence_before</td>
      <td>Reshape</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>618</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>34</td>
      <td>166080</td>
      <td>X</td>
      <td>Re_Reshape_kernel_time</td>
      <td>Reshape</td>
      <td>{'main_thread': {'thread_pool_name': 'session-...</td>
      <td>800</td>
      <td>16</td>
      <td>20</td>
      <td>800</td>
      <td>CPUExecutionProvider</td>
      <td>20</td>
    </tr>
    <tr>
      <th>619</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>0</td>
      <td>166141</td>
      <td>X</td>
      <td>Re_Reshape_fence_after</td>
      <td>Reshape</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>620</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>14912</td>
      <td>151237</td>
      <td>X</td>
      <td>SequentialExecutor::Execute</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>621</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>14940</td>
      <td>151223</td>
      <td>X</td>
      <td>model_run</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>622 rows × 15 columns</p>
</div>
</div>
<br />
<br /></section>
<section id="graphs">
<h2><a class="toc-backref" href="#id6">Graphs</a><a class="headerlink" href="#graphs" title="Permalink to this headline">¶</a></h2>
<p>First graph is by operator type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gr_dur</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;dur&#39;</span><span class="p">,</span> <span class="s2">&quot;args_op_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s2">&quot;args_op_name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dur&#39;</span><span class="p">)</span>
<span class="n">gr_n</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;dur&#39;</span><span class="p">,</span> <span class="s2">&quot;args_op_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s2">&quot;args_op_name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dur&#39;</span><span class="p">)</span>
<span class="n">gr_n</span> <span class="o">=</span> <span class="n">gr_n</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">gr_dur</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">gr_n</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;n occurences&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_profile_ort_002.png" srcset="../_images/sphx_glr_plot_profile_ort_002.png" alt="RadiusNeighborsRegressor, duration, n occurences" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;RadiusNeighborsRegressor&#39;)
</pre></div>
</div>
<p>Second graph is by operator name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gr_dur</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;dur&#39;</span><span class="p">,</span> <span class="s2">&quot;args_op_name&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;args_op_name&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dur&#39;</span><span class="p">)</span>
<span class="n">gr_dur</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>dur</th>
    </tr>
    <tr>
      <th>args_op_name</th>
      <th>name</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Add</th>
      <th>arange_Add_fence_after</th>
      <td>0</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Reshape</th>
      <th>knny_Reshape_fence_after</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Re_Reshape_fence_before</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Re_Reshape_fence_after</th>
      <td>0</td>
    </tr>
    <tr>
      <th>ReduceSum</th>
      <th>norm_ReduceSum_fence_before</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>And the graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">gr_dur</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">gr_dur</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;duration per node&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">make_axes_area_auto_adjustable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_profile_ort_003.png" srcset="../_images/sphx_glr_plot_profile_ort_003.png" alt="duration per node" class = "sphx-glr-single-img"/><p>The model spends most of its time in CumSum operator.
Operator Shape gets called the highest number of times.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.show()</span>
</pre></div>
</div>
</section>
<section id="gpu-or-cpu">
<h2><a class="toc-backref" href="#id7">GPU or CPU</a><a class="headerlink" href="#gpu-or-cpu" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">get_device</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GPU&#39;</span><span class="p">:</span>
    <span class="n">ort_device</span> <span class="o">=</span> <span class="n">C_OrtDevice</span><span class="p">(</span>
        <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">default_memory</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ort_device</span> <span class="o">=</span> <span class="n">C_OrtDevice</span><span class="p">(</span>
        <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">default_memory</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># session</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="n">so</span><span class="p">,</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;CUDAExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">bind</span> <span class="o">=</span> <span class="n">SessionIOBinding</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="p">)</span>

<span class="c1"># moving the data on CPU or GPU</span>
<span class="n">ort_value</span> <span class="o">=</span> <span class="n">C_OrtValue</span><span class="o">.</span><span class="n">ortvalue_from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/jenkins/workspace/onnxcustom/onnxcustom_UT_39_std/_venv/lib/python3.9/site-packages/onnxruntime/capi/onnxruntime_inference_collection.py:55: UserWarning: Specified provider &#39;CUDAExecutionProvider&#39; is not in available provider names.Available providers: &#39;CPUExecutionProvider&#39;
  warnings.warn(&quot;Specified provider &#39;{}&#39; is not in available provider names.&quot;
</pre></div>
</div>
<p>A function which calls the API for any device.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_with_iobinding</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">ort_value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="n">bind</span><span class="o">.</span><span class="n">bind_input</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">ort_value</span><span class="o">.</span><span class="n">shape</span><span class="p">(),</span>
                    <span class="n">ort_value</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
    <span class="n">bind</span><span class="o">.</span><span class="n">bind_output</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">)</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="o">.</span><span class="n">run_with_iobinding</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ortvalues</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ortvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
<p>The profiling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
    <span class="n">run_with_iobinding</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">ort_value</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="n">prof</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">end_profiling</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">OnnxWholeSession</span><span class="o">.</span><span class="n">process_profiling</span><span class="p">(</span><span class="n">js</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/10 [00:00&lt;?, ?it/s]
 10%|#         | 1/10 [00:00&lt;00:01,  7.20it/s]
 20%|##        | 2/10 [00:00&lt;00:01,  7.52it/s]
 30%|###       | 3/10 [00:00&lt;00:00,  7.63it/s]
 40%|####      | 4/10 [00:00&lt;00:00,  7.69it/s]
 50%|#####     | 5/10 [00:00&lt;00:00,  7.72it/s]
 60%|######    | 6/10 [00:00&lt;00:00,  7.73it/s]
 70%|#######   | 7/10 [00:00&lt;00:00,  7.74it/s]
 80%|########  | 8/10 [00:01&lt;00:00,  7.75it/s]
 90%|######### | 9/10 [00:01&lt;00:00,  7.76it/s]
100%|##########| 10/10 [00:01&lt;00:00,  7.76it/s]
100%|##########| 10/10 [00:01&lt;00:00,  7.70it/s]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cat</th>
      <th>pid</th>
      <th>tid</th>
      <th>dur</th>
      <th>ts</th>
      <th>ph</th>
      <th>name</th>
      <th>args_op_name</th>
      <th>args_thread_scheduling_stats</th>
      <th>args_activation_size</th>
      <th>args_parameter_size</th>
      <th>args_graph_index</th>
      <th>args_output_size</th>
      <th>args_provider</th>
      <th>args_exec_plan_index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>1107</td>
      <td>7</td>
      <td>X</td>
      <td>model_loading_array</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>7538</td>
      <td>1217</td>
      <td>X</td>
      <td>session_initialization</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>1</td>
      <td>16948</td>
      <td>X</td>
      <td>cond_CDist_fence_before</td>
      <td>CDist</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>26295</td>
      <td>16960</td>
      <td>X</td>
      <td>cond_CDist_kernel_time</td>
      <td>CDist</td>
      <td>{'main_thread': {'thread_pool_name': 'session-...</td>
      <td>80000</td>
      <td>80000</td>
      <td>0</td>
      <td>8000000</td>
      <td>CPUExecutionProvider</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>0</td>
      <td>43280</td>
      <td>X</td>
      <td>cond_CDist_fence_after</td>
      <td>CDist</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>617</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>0</td>
      <td>1314016</td>
      <td>X</td>
      <td>Re_Reshape_fence_before</td>
      <td>Reshape</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>618</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>35</td>
      <td>1314020</td>
      <td>X</td>
      <td>Re_Reshape_kernel_time</td>
      <td>Reshape</td>
      <td>{'main_thread': {'thread_pool_name': 'session-...</td>
      <td>8000</td>
      <td>16</td>
      <td>20</td>
      <td>8000</td>
      <td>CPUExecutionProvider</td>
      <td>20</td>
    </tr>
    <tr>
      <th>619</th>
      <td>Node</td>
      <td>17150</td>
      <td>17150</td>
      <td>0</td>
      <td>1314070</td>
      <td>X</td>
      <td>Re_Reshape_fence_after</td>
      <td>Reshape</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>620</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>127331</td>
      <td>1186747</td>
      <td>X</td>
      <td>SequentialExecutor::Execute</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>621</th>
      <td>Session</td>
      <td>17150</td>
      <td>17150</td>
      <td>127377</td>
      <td>1186716</td>
      <td>X</td>
      <td>model_run</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>622 rows × 15 columns</p>
</div>
</div>
<br />
<br /><p>First graph is by operator type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gr_dur</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;dur&#39;</span><span class="p">,</span> <span class="s2">&quot;args_op_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s2">&quot;args_op_name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dur&#39;</span><span class="p">)</span>
<span class="n">gr_n</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;dur&#39;</span><span class="p">,</span> <span class="s2">&quot;args_op_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s2">&quot;args_op_name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dur&#39;</span><span class="p">)</span>
<span class="n">gr_n</span> <span class="o">=</span> <span class="n">gr_n</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">gr_dur</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">gr_n</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;n occurences&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_profile_ort_004.png" srcset="../_images/sphx_glr_plot_profile_ort_004.png" alt="RadiusNeighborsRegressor, duration, n occurences" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;RadiusNeighborsRegressor&#39;)
</pre></div>
</div>
<p>Second graph is by operator name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gr_dur</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;dur&#39;</span><span class="p">,</span> <span class="s2">&quot;args_op_name&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;args_op_name&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dur&#39;</span><span class="p">)</span>
<span class="n">gr_dur</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>dur</th>
    </tr>
    <tr>
      <th>args_op_name</th>
      <th>name</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Flatten</th>
      <th>knny_Flatten_fence_after</th>
      <td>0</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Reshape</th>
      <th>knny_Reshape_fence_after</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Re_Reshape_fence_before</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Re_Reshape_fence_after</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Div</th>
      <th>Di_Div_fence_after</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>And the graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">gr_dur</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">gr_dur</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;duration per node&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">make_axes_area_auto_adjustable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_profile_ort_005.png" srcset="../_images/sphx_glr_plot_profile_ort_005.png" alt="duration per node" class = "sphx-glr-single-img"/><p>It shows the same results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.show()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  24.564 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-profile-ort-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/448a6184d883d7576ddb5b497737e10b/plot_profile_ort.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_profile_ort.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/bcc77338f9f5876c876478ab77ff42c6/plot_profile_ort.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_profile_ort.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../tutorials/tutorial_bench/tutorial_profile.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Profiling</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_profile_ort_onnx.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Profiling of ONNX graph with onnxruntime</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>