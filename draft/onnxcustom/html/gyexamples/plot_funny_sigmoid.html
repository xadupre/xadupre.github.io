
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Funny discrepancies &#8212; onnxcustom</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Intermediate results and investigation" href="plot_fbegin_investigate.html" />
    <link rel="prev" title="Issues when switching to float" href="plot_ebegin_float_double.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/apis.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="index.html">
  Examples Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebooks Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../other_pages.html">
  Other pages
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../blog/blogindex.html">
  Blog Gallery
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnx/index.html">
   Introduction to ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnxruntime/index.html">
   Introduction to onnxruntime
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../tutorials/tutorial_skl/index.html">
   scikit-learn to ONNX Tutorial
  </a>
  <input checked class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_1_simple.html">
     The easy case
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="plot_abegin_convert_pipeline.html">
       Train and deploy a scikit-learn pipeline
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_bbegin_measure_time.html">
       Benchmark ONNX conversion
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_cbegin_opset.html">
       What is the opset number?
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_dbegin_options.html">
       One model, many possible conversions with options
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_dbegin_options_list.html">
       Black list operators when converting
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_dbegin_options_zipmap.html">
       Choose appropriate output of a classifier
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_ebegin_float_double.html">
       Issues when switching to float
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Funny discrepancies
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_fbegin_investigate.html">
       Intermediate results and investigation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gbegin_dataframe.html">
       Dataframe as an input
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gbegin_transfer_learning.html">
       Transfer Learning with ONNX
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gbegin_cst.html">
       Store arrays in one onnx graph
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_gconverting.html">
       Modify the ONNX graph
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_1-5_external.html">
     Using converter from other libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_2_new_converter.html">
     A custom converter for a custom model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_3_new_operator.html">
     Extend ONNX, extend runtime
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_skl/tutorial_4_complex.html">
     Complex Scenarios
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_training/index.html">
   Training Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_bench/index.html">
   Benchmarking and profiling Tutorial
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#precision">
   Precision
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#computation-time">
   Computation time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-funny-sigmoid-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="funny-discrepancies">
<span id="l-example-discrepencies-sigmoid"></span><span id="sphx-glr-gyexamples-plot-funny-sigmoid-py"></span><h1>Funny discrepancies<a class="headerlink" href="#funny-discrepancies" title="Permalink to this headline">¶</a></h1>
<p>Function sigmoid is <img class="math" src="../_images/math/b3872a3efb2dc28078ad45c24573c50d8f178bb9.svg" alt="sig(x) = \frac{1}{1 + e^{-x}}"/>.
For small or high value, implementation has to do approximation
and they are not always the same. It may be a tradeoff between
precision and computation time…
It is always a tradeoff.</p>
<div class="contents local topic" id="contents">
<span id="index-0"></span><ul class="simple">
<li><p><a class="reference internal" href="#precision" id="id1">Precision</a></p></li>
<li><p><a class="reference internal" href="#computation-time" id="id2">Computation time</a></p></li>
<li><p><a class="reference internal" href="#conclusion" id="id3">Conclusion</a></p></li>
</ul>
</div>
<section id="precision">
<h2><a class="toc-backref" href="#id1">Precision</a><a class="headerlink" href="#precision" title="Permalink to this headline">¶</a></h2>
<p>This section compares the precision of a couple of implementations
of the ssigmoid function. The custom implementation is done with
a Taylor expansion of exponential function:
<img class="math" src="../_images/math/902f62287b7fd6253b71f11db74ab47d50977958.svg" alt="e^x \sim 1 + x + \frac{x^2}{2} + ... + \frac{x^n}{n!} + o(x^n)"/>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">expit</span>

<span class="kn">from</span> <span class="nn">skl2onnx.algebra.onnx_ops</span> <span class="kn">import</span> <span class="n">OnnxSigmoid</span>
<span class="kn">from</span> <span class="nn">skl2onnx.common.data_types</span> <span class="kn">import</span> <span class="n">FloatTensorType</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">onnxcustom</span> <span class="kn">import</span> <span class="n">get_max_opset</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">one</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">taylor_approximation_exp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">degre</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">degre</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">*=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">i</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">taylor_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">degre</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">one</span> <span class="o">+</span> <span class="n">taylor_approximation_exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">degre</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">one</span> <span class="o">/</span> <span class="p">(</span><span class="n">den</span><span class="p">)</span>


<span class="n">opset</span> <span class="o">=</span> <span class="n">get_max_opset</span><span class="p">()</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">min_values</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="n">N</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">OnnxSigmoid</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opset</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">FloatTensorType</span><span class="p">()},</span>
                   <span class="p">{</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">FloatTensorType</span><span class="p">()},</span>
                   <span class="n">target_opset</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
<span class="n">rts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime&#39;</span><span class="p">,</span> <span class="s1">&#39;taylor20&#39;</span><span class="p">,</span> <span class="s1">&#39;taylor40&#39;</span><span class="p">]</span>

<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="n">graph</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">min_values</span><span class="p">):</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mv</span>
    <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">rts</span><span class="p">:</span>
        <span class="n">lab</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">expit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
            <span class="c1"># * 1.2 to avoid curves to be superimposed</span>
            <span class="n">y</span> <span class="o">*=</span> <span class="mf">1.2</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="s2">&quot;x1.2&quot;</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;onnxruntime&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;taylor40&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">taylor_sigmoid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
            <span class="c1"># * 0.8 to avoid curves to be superimposed</span>
            <span class="n">y</span> <span class="o">*=</span> <span class="mf">0.8</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="s2">&quot;x0.8&quot;</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;taylor20&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">taylor_sigmoid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="c1"># * 0.6 to avoid curves to be superimposed</span>
            <span class="n">y</span> <span class="o">*=</span> <span class="mf">0.6</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="s2">&quot;x0.6&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Unknown runtime </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">rt</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">rt</span><span class="o">=</span><span class="n">rt</span> <span class="o">+</span> <span class="n">lab</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mv</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/300 [00:00&lt;?, ?it/s]
 11%|#1        | 33/300 [00:00&lt;00:00, 320.92it/s]
 22%|##2       | 66/300 [00:00&lt;00:00, 318.44it/s]
 33%|###2      | 98/300 [00:00&lt;00:00, 318.40it/s]
 43%|####3     | 130/300 [00:00&lt;00:00, 318.12it/s]
 54%|#####4    | 162/300 [00:00&lt;00:00, 318.31it/s]
 65%|######4   | 194/300 [00:00&lt;00:00, 318.48it/s]
 75%|#######5  | 226/300 [00:00&lt;00:00, 318.56it/s]
 86%|########6 | 258/300 [00:00&lt;00:00, 318.52it/s]
 97%|#########6| 290/300 [00:00&lt;00:00, 318.56it/s]
100%|##########| 300/300 [00:00&lt;00:00, 318.21it/s]
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">piv</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_funny_sigmoid_001.png" srcset="../_images/sphx_glr_plot_funny_sigmoid_001.png" alt="plot funny sigmoid" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>x               -20.000000    -19.966667  ...  -10.066667  -10.033333
rt                                        ...
numpy         2.061154e-09  2.131016e-09  ...    0.000042    0.000044
onnxruntime  -5.960464e-08 -5.960464e-08  ...    0.000042    0.000044
pythonx1.2    2.473385e-09  2.557219e-09  ...    0.000051    0.000053
taylor20x0.6  2.211963e-09  2.274888e-09  ...    0.000026    0.000026
taylor40x0.8  1.648965e-09  1.704854e-09  ...    0.000034    0.000035

[5 rows x 300 columns]

&lt;AxesSubplot:xlabel=&#39;x&#39;&gt;
</pre></div>
</div>
<p><img class="math" src="../_images/math/877441d0be3bbf4322bd8b90bdffe5fb447464b2.svg" alt="log(sig(x)) = -log(1 + e^{-x})"/>. When <em>x</em> is very negative,
<img class="math" src="../_images/math/48a83ed94481090d113a7accc40be4b4b61e9c05.svg" alt="log(sig(x)) \\sim -x"/>. That explains the graph.
We also see <a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a> is less precise for these values.
What’s the benefit?</p>
</section>
<section id="computation-time">
<h2><a class="toc-backref" href="#id2">Computation time</a><a class="headerlink" href="#computation-time" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">min_values</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mv</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">rts</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">expit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;onnxruntime&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;taylor40&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">taylor_sigmoid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;taylor20&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">taylor_sigmoid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Unknown runtime </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">rt</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">rt</span><span class="o">=</span><span class="n">rt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mv</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">duration</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_funny_sigmoid_002.png" srcset="../_images/sphx_glr_plot_funny_sigmoid_002.png" alt="plot funny sigmoid" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/300 [00:00&lt;?, ?it/s]
  3%|3         | 10/300 [00:00&lt;00:02, 97.91it/s]
  7%|6         | 20/300 [00:00&lt;00:02, 97.46it/s]
 10%|#         | 30/300 [00:00&lt;00:02, 97.31it/s]
 13%|#3        | 40/300 [00:00&lt;00:02, 97.25it/s]
 17%|#6        | 50/300 [00:00&lt;00:02, 97.20it/s]
 20%|##        | 60/300 [00:00&lt;00:02, 97.14it/s]
 23%|##3       | 70/300 [00:00&lt;00:02, 97.12it/s]
 27%|##6       | 80/300 [00:00&lt;00:02, 97.11it/s]
 30%|###       | 90/300 [00:00&lt;00:02, 97.10it/s]
 33%|###3      | 100/300 [00:01&lt;00:02, 97.10it/s]
 37%|###6      | 110/300 [00:01&lt;00:01, 97.09it/s]
 40%|####      | 120/300 [00:01&lt;00:01, 96.96it/s]
 43%|####3     | 130/300 [00:01&lt;00:01, 96.99it/s]
 47%|####6     | 140/300 [00:01&lt;00:01, 97.04it/s]
 50%|#####     | 150/300 [00:01&lt;00:01, 96.96it/s]
 53%|#####3    | 160/300 [00:01&lt;00:01, 96.98it/s]
 57%|#####6    | 170/300 [00:01&lt;00:01, 97.00it/s]
 60%|######    | 180/300 [00:01&lt;00:01, 97.02it/s]
 63%|######3   | 190/300 [00:01&lt;00:01, 97.03it/s]
 67%|######6   | 200/300 [00:02&lt;00:01, 97.05it/s]
 70%|#######   | 210/300 [00:02&lt;00:00, 97.06it/s]
 73%|#######3  | 220/300 [00:02&lt;00:00, 97.10it/s]
 77%|#######6  | 230/300 [00:02&lt;00:00, 97.15it/s]
 80%|########  | 240/300 [00:02&lt;00:00, 97.14it/s]
 83%|########3 | 250/300 [00:02&lt;00:00, 97.15it/s]
 87%|########6 | 260/300 [00:02&lt;00:00, 97.17it/s]
 90%|######### | 270/300 [00:02&lt;00:00, 97.17it/s]
 93%|#########3| 280/300 [00:02&lt;00:00, 97.18it/s]
 97%|#########6| 290/300 [00:02&lt;00:00, 97.19it/s]
100%|##########| 300/300 [00:03&lt;00:00, 97.06it/s]
100%|##########| 300/300 [00:03&lt;00:00, 97.07it/s]

&lt;AxesSubplot:xlabel=&#39;x&#39;&gt;
</pre></div>
</div>
</section>
<section id="conclusion">
<h2><a class="toc-backref" href="#id3">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>The implementation from <a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a> is faster but
is much less contiguous for extremes. It explains why
probabilities may be much different when an observation
is far from every classification border. In that case,
<a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a> implementation of the sigmoid function
returns 0 when <code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.sigmoid()</span></code> returns a smoother value.
Probabilites of logistic regression are obtained after the raw
scores are transformed with the sigmoid function and
normalized. If the raw scores are very negative,
the sum of probabilities becomes null with <a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a>.
The normalization fails.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.show()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  6.687 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-funny-sigmoid-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/76b95d0d92a9da9a6b5522e5879eb850/plot_funny_sigmoid.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_funny_sigmoid.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/837a416f9acbec9132e4c5487b6e77fc/plot_funny_sigmoid.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_funny_sigmoid.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_ebegin_float_double.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Issues when switching to float</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_fbegin_investigate.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Intermediate results and investigation</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>