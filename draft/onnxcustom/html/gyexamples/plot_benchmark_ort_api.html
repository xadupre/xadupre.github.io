
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Benchmark onnxruntime API: run or … &#8212; onnxcustom</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Benchmark inference for scikit-learn models" href="plot_benchmark_inference_standard.html" />
    <link rel="prev" title="Inference" href="../tutorials/tutorial_bench/tutorial_benchmark.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/apis.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="index.html">
  Examples Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebooks Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../other_pages.html">
  Other pages
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../blog/blogindex.html">
  Blog Gallery
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnx/index.html">
   Introduction to ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_onnxruntime/index.html">
   Introduction to onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_skl/index.html">
   scikit-learn to ONNX Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/tutorial_training/index.html">
   Training Tutorial
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../tutorials/tutorial_bench/index.html">
   Benchmarking and profiling Tutorial
  </a>
  <input checked class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_op.html">
     Study behavior of one operator
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_benchmark.html">
     Inference
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Benchmark onnxruntime API: run or …
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_benchmark_inference_standard.html">
       Benchmark inference for scikit-learn models
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_benchmark_inference.html">
       Benchmark inference for a linear regression
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="plot_benchmark_graph_opt.html">
       Benchmark onnxruntime optimization
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_profile.html">
     Profiling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/tutorial_bench/tutorial_training.html">
     Training
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-regression">
   Linear Regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-the-model">
   Building the model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conversion-to-onnx">
   Conversion to ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmarks">
   Benchmarks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final">
   Final
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#graph">
   Graph
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-benchmark-ort-api-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="benchmark-onnxruntime-api-run-or">
<span id="benchmark-ort-api"></span><span id="sphx-glr-gyexamples-plot-benchmark-ort-api-py"></span><h1>Benchmark onnxruntime API: run or …<a class="headerlink" href="#benchmark-onnxruntime-api-run-or" title="Permalink to this headline">¶</a></h1>
<p>This short code compares different methods to call onnxruntime API.</p>
<ul class="simple">
<li><p><cite>run</cite></p></li>
<li><p><cite>run_with_ort_values</cite></p></li>
<li><p><cite>run_with_iobinding</cite></p></li>
</ul>
<p>You may profile this code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">-</span><span class="n">spy</span> <span class="n">record</span> <span class="o">-</span><span class="n">o</span> <span class="n">plot_benchmark_ort_api</span><span class="o">.</span><span class="n">svg</span> <span class="o">-</span><span class="n">r</span> <span class="mi">10</span>
<span class="o">--</span><span class="n">native</span> <span class="o">--</span> <span class="n">python</span> <span class="n">plot_benchmark_ort_api</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#linear-regression" id="id1">Linear Regression</a></p></li>
<li><p><a class="reference internal" href="#building-the-model" id="id2">Building the model</a></p></li>
<li><p><a class="reference internal" href="#conversion-to-onnx" id="id3">Conversion to ONNX</a></p></li>
<li><p><a class="reference internal" href="#benchmarks" id="id4">Benchmarks</a></p></li>
<li><p><a class="reference internal" href="#final" id="id5">Final</a></p></li>
<li><p><a class="reference internal" href="#graph" id="id6">Graph</a></p></li>
<li><p><a class="reference internal" href="#conclusion" id="id7">Conclusion</a></p></li>
</ul>
</div>
<section id="linear-regression">
<h2><a class="toc-backref" href="#id1">Linear Regression</a><a class="headerlink" href="#linear-regression" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">from</span> <span class="nn">onnxruntime.capi._pybind_state</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># pylint: disable=E0611</span>
    <span class="n">SessionIOBinding</span><span class="p">,</span> <span class="n">OrtDevice</span> <span class="k">as</span> <span class="n">C_OrtDevice</span><span class="p">,</span>
    <span class="n">OrtMemType</span><span class="p">,</span> <span class="n">OrtValue</span> <span class="k">as</span> <span class="n">C_OrtValue</span><span class="p">,</span> <span class="n">RunOptions</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">config_context</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">cpyquickhelper.numbers.speed_measure</span> <span class="kn">import</span> <span class="n">measure_time</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.plotting</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.testing.experimental_c_impl.experimental_c</span> <span class="kn">import</span> <span class="n">code_optimisation</span>
</pre></div>
</div>
<p>Available optimisation on this machine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">code_optimisation</span><span class="p">())</span>
<span class="n">repeat</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">number</span> <span class="o">=</span> <span class="mi">250</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>AVX-omp=8
</pre></div>
</div>
</section>
<section id="building-the-model">
<h2><a class="toc-backref" href="#id2">Building the model</a><a class="headerlink" href="#building-the-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>LinearRegression()
</pre></div>
</div>
</section>
<section id="conversion-to-onnx">
<h2><a class="toc-backref" href="#id3">Conversion to ONNX</a><a class="headerlink" href="#conversion-to-onnx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">black_op</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LinearRegressor&#39;</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>opset: domain=&#39;&#39; version=13
input: name=&#39;X&#39; type=dtype(&#39;float32&#39;) shape=(0, 10)
init: name=&#39;coef&#39; type=dtype(&#39;float32&#39;) shape=(10,)
init: name=&#39;intercept&#39; type=dtype(&#39;float32&#39;) shape=(1,) -- array([1.4016405e-07], dtype=float32)
init: name=&#39;shape_tensor&#39; type=dtype(&#39;int64&#39;) shape=(2,) -- array([-1,  1])
MatMul(X, coef) -&gt; multiplied
  Add(multiplied, intercept) -&gt; resh
    Reshape(resh, shape_tensor) -&gt; variable
output: name=&#39;variable&#39; type=dtype(&#39;float32&#39;) shape=(0, 1)
</pre></div>
</div>
</section>
<section id="benchmarks">
<h2><a class="toc-backref" href="#id4">Benchmarks</a><a class="headerlink" href="#benchmarks" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>scikit-learn</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;scikit-learn&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">config_context</span><span class="p">(</span><span class="n">assume_finite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">),</span>
                       <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">),</span>
                       <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
    <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;skl&#39;</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>scikit-learn
</pre></div>
</div>
<p>numpy runtime</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python_compiled&quot;</span><span class="p">)</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">}),</span> <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">oinf</span><span class="o">=</span><span class="n">oinf</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>numpy
</pre></div>
</div>
<p>onnxruntime: run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ort&#39;</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">}),</span>
                   <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">),</span>
                   <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort-run&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ort
</pre></div>
</div>
<p>onnxruntime: run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ort-c&#39;</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">ro</span> <span class="o">=</span> <span class="n">RunOptions</span><span class="p">()</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()]</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_names</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">},</span> <span class="n">ro</span><span class="p">),</span>
    <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort-c&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ort-c
</pre></div>
</div>
<p>onnxruntime: run_with_ort_values</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ort-ov-c&#39;</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">C_OrtDevice</span><span class="p">(</span><span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">OrtMemType</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">Xov</span> <span class="o">=</span> <span class="n">C_OrtValue</span><span class="o">.</span><span class="n">ortvalue_from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">ro</span> <span class="o">=</span> <span class="n">RunOptions</span><span class="p">()</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()]</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="o">.</span><span class="n">run_with_ort_values</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">Xov</span><span class="p">},</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">ro</span><span class="p">),</span>
    <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort-ov&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ort-ov-c
</pre></div>
</div>
<p>onnxruntime: run_with_iobinding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ort-bind&#39;</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">bind</span> <span class="o">=</span> <span class="n">SessionIOBinding</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="p">)</span>
<span class="n">ort_device</span> <span class="o">=</span> <span class="n">C_OrtDevice</span><span class="p">(</span><span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">default_memory</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_with_iobinding</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;strides&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;onnxruntime only supports contiguous arrays.&quot;</span><span class="p">)</span>
    <span class="n">bind</span><span class="o">.</span><span class="n">bind_input</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">X</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bind</span><span class="o">.</span><span class="n">bind_output</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">)</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="o">.</span><span class="n">run_with_iobinding</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ortvalues</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ortvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>


<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">run_with_iobinding</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">),</span>
                   <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">run_with_iobinding</span><span class="o">=</span><span class="n">run_with_iobinding</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
                                <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">ort_device</span><span class="o">=</span><span class="n">ort_device</span><span class="p">),</span>
                   <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>

<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort-bind&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ort-bind
</pre></div>
</div>
<p>This fourth implementation is very similar to the previous
one but it only binds array once and reuse the memory
without changing the binding. It assumes that input size
and output size never change. It copies the data into
the fixed buffer and returns the same array, modified
inplace.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ort-bind-inplace&#39;</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">bind</span> <span class="o">=</span> <span class="n">SessionIOBinding</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="p">)</span>
<span class="n">ort_device</span> <span class="o">=</span> <span class="n">C_OrtDevice</span><span class="p">(</span><span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">default_memory</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">bY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">bind</span><span class="o">.</span><span class="n">bind_input</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">bX</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">bX</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bind</span><span class="o">.</span><span class="n">bind_output</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">bY</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                 <span class="n">bY</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ortvalues</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">run_with_iobinding</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ortvalues</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;strides&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;onnxruntime only supports contiguous arrays.&quot;</span><span class="p">)</span>
    <span class="n">bX</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="o">.</span><span class="n">run_with_iobinding</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bY</span>


<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">run_with_iobinding</span><span class="p">(</span>
        <span class="n">sess</span><span class="p">,</span> <span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ortvalues</span><span class="p">),</span>
    <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">run_with_iobinding</span><span class="o">=</span><span class="n">run_with_iobinding</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
                 <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">ortvalues</span><span class="o">=</span><span class="n">ortvalues</span><span class="p">,</span> <span class="n">bX</span><span class="o">=</span><span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="o">=</span><span class="n">bY</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>

<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort-bind-inplace&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ort-bind-inplace
</pre></div>
</div>
<p>Fifth implementation is equivalent to the previous one
but does not copy anything.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ort-run-inplace&#39;</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
                        <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">])</span>
<span class="n">bind</span> <span class="o">=</span> <span class="n">SessionIOBinding</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="p">)</span>
<span class="n">ort_device</span> <span class="o">=</span> <span class="n">C_OrtDevice</span><span class="p">(</span><span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">C_OrtDevice</span><span class="o">.</span><span class="n">default_memory</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">bY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">bind</span><span class="o">.</span><span class="n">bind_input</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">bX</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">bX</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bind</span><span class="o">.</span><span class="n">bind_output</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">ort_device</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">bY</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                 <span class="n">bY</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ortvalues</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">run_with_iobinding_no_copy</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ortvalues</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;strides&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;onnxruntime only supports contiguous arrays.&quot;</span><span class="p">)</span>
    <span class="c1"># bX[:, :] = X[:, :]</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">_sess</span><span class="o">.</span><span class="n">run_with_iobinding</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bY</span>


<span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">run_with_iobinding_no_copy</span><span class="p">(</span>
        <span class="n">sess</span><span class="p">,</span> <span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">ortvalues</span><span class="p">),</span>
    <span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">run_with_iobinding_no_copy</span><span class="o">=</span><span class="n">run_with_iobinding_no_copy</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
                 <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">ortvalues</span><span class="o">=</span><span class="n">ortvalues</span><span class="p">,</span> <span class="n">bX</span><span class="o">=</span><span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="o">=</span><span class="n">bY</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>

<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort-run-inplace&#39;</span>
<span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ort-run-inplace
</pre></div>
</div>
</section>
<section id="final">
<h2><a class="toc-backref" href="#id5">Final</a><a class="headerlink" href="#final" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;deviation&#39;</span><span class="p">]])</span>
<span class="n">df</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>               name   average  number  repeat  deviation
0               skl  0.062533     250     250   0.017054
1             numpy  0.098921     250     250   0.021386
2           ort-run  0.037019     250     250   0.002043
3             ort-c  0.033772     250     250   0.000150
4            ort-ov  0.032038     250     250   0.000071
5          ort-bind  0.046441     250     250   0.000126
6  ort-bind-inplace  0.036102     250     250   0.000284
7   ort-run-inplace  0.032373     250     250   0.000039
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>average</th>
      <th>deviation</th>
      <th>min_exec</th>
      <th>max_exec</th>
      <th>repeat</th>
      <th>number</th>
      <th>ttime</th>
      <th>context_size</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.062533</td>
      <td>0.017054</td>
      <td>0.052082</td>
      <td>0.127703</td>
      <td>250</td>
      <td>250</td>
      <td>15.633355</td>
      <td>232</td>
      <td>skl</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.098921</td>
      <td>0.021386</td>
      <td>0.040168</td>
      <td>0.169376</td>
      <td>250</td>
      <td>250</td>
      <td>24.730248</td>
      <td>232</td>
      <td>numpy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.037019</td>
      <td>0.002043</td>
      <td>0.036602</td>
      <td>0.060717</td>
      <td>250</td>
      <td>250</td>
      <td>9.254672</td>
      <td>232</td>
      <td>ort-run</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.033772</td>
      <td>0.000150</td>
      <td>0.033562</td>
      <td>0.035747</td>
      <td>250</td>
      <td>250</td>
      <td>8.442984</td>
      <td>232</td>
      <td>ort-c</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.032038</td>
      <td>0.000071</td>
      <td>0.031911</td>
      <td>0.032308</td>
      <td>250</td>
      <td>250</td>
      <td>8.009545</td>
      <td>232</td>
      <td>ort-ov</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.046441</td>
      <td>0.000126</td>
      <td>0.046264</td>
      <td>0.046998</td>
      <td>250</td>
      <td>250</td>
      <td>11.610148</td>
      <td>232</td>
      <td>ort-bind</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.036102</td>
      <td>0.000284</td>
      <td>0.035914</td>
      <td>0.038481</td>
      <td>250</td>
      <td>250</td>
      <td>9.025473</td>
      <td>360</td>
      <td>ort-bind-inplace</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.032373</td>
      <td>0.000039</td>
      <td>0.032274</td>
      <td>0.032611</td>
      <td>250</td>
      <td>250</td>
      <td>8.093184</td>
      <td>360</td>
      <td>ort-run-inplace</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="graph">
<h2><a class="toc-backref" href="#id6">Graph</a><a class="headerlink" href="#graph" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[[</span><span class="s1">&#39;average&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average inference time</span><span class="se">\n</span><span class="s2">The lower the better&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_benchmark_ort_api_001.png" srcset="../_images/sphx_glr_plot_benchmark_ort_api_001.png" alt="Average inference time The lower the better" class = "sphx-glr-single-img"/></section>
<section id="conclusion">
<h2><a class="toc-backref" href="#id7">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>A profiling (<a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a> is compiled with debug information)
including # calls to native C++ functions shows that referencing input
by name # takes a significant time when the graph is very small such
as this one. The logic in method <em>run_with_iobinding</em> is much longer
that the one implemented in <em>run</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 1 minutes  35.485 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-benchmark-ort-api-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/db94438f3ae5291e4ab02dafb45d6b51/plot_benchmark_ort_api.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_benchmark_ort_api.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/414e3f7572d21514ba015231aceaae33/plot_benchmark_ort_api.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_benchmark_ort_api.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../tutorials/tutorial_bench/tutorial_benchmark.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Inference</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_benchmark_inference_standard.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Benchmark inference for scikit-learn models</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>