
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ONNX with Python &#8212; onnxcustom</title>
    
    <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Challenges" href="challenges.html" />
    <link rel="prev" title="ONNX Concepts" href="concepts.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api/apis.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../gyexamples/index.html">
  Examples Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../all_notebooks.html">
  Notebooks Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../other_pages.html">
  Other pages
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../blog/blogindex.html">
  Blog Gallery
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Introduction to ONNX
  </a>
  <input checked class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="concepts.html">
     ONNX Concepts
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     ONNX with Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="challenges.html">
     Challenges
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="onnxops.html">
     ONNX operators and function
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorial_onnxruntime/index.html">
   Introduction to onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorial_skl/index.html">
   scikit-learn to ONNX Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorial_training/index.html">
   Training Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorial_bench/index.html">
   Benchmarking and profiling Tutorial
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-simple-example-a-linear-regression">
   A simple example: a linear regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#serialization">
   Serialization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initializer-default-value">
   Initializer, default value
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#attributes">
   Attributes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#opset-and-metadata">
   Opset and metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subgraph-test-and-loops">
   Subgraph: test and loops
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if">
     If
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scan">
     Scan
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#functions">
   Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parsing">
   Parsing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#checker-and-shape-inference">
   Checker and Shape Inference
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="onnx-with-python">
<h1>ONNX with Python<a class="headerlink" href="#onnx-with-python" title="Permalink to this headline">¶</a></h1>
<p>Next sections highlight the main functions used to build
an ONNX graph with the <a class="reference internal" href="../../api/onnx_python/index.html#l-python-onnx-api"><span class="std std-ref">Python API</span></a>
<a class="reference external" href="https://github.com/onnx/onnx">onnx</a> offers.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#a-simple-example-a-linear-regression" id="id1">A simple example: a linear regression</a></p></li>
<li><p><a class="reference internal" href="#serialization" id="id2">Serialization</a></p></li>
<li><p><a class="reference internal" href="#initializer-default-value" id="id3">Initializer, default value</a></p></li>
<li><p><a class="reference internal" href="#attributes" id="id4">Attributes</a></p></li>
<li><p><a class="reference internal" href="#opset-and-metadata" id="id5">Opset and metadata</a></p></li>
<li><p><a class="reference internal" href="#subgraph-test-and-loops" id="id6">Subgraph: test and loops</a></p>
<ul>
<li><p><a class="reference internal" href="#if" id="id7">If</a></p></li>
<li><p><a class="reference internal" href="#scan" id="id8">Scan</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#functions" id="id9">Functions</a></p></li>
<li><p><a class="reference internal" href="#parsing" id="id10">Parsing</a></p></li>
<li><p><a class="reference internal" href="#checker-and-shape-inference" id="id11">Checker and Shape Inference</a></p></li>
</ul>
</div>
<section id="a-simple-example-a-linear-regression">
<span id="l-onnx-linear-regression-onnx-api"></span><h2><a class="toc-backref" href="#id1">A simple example: a linear regression</a><a class="headerlink" href="#a-simple-example-a-linear-regression" title="Permalink to this headline">¶</a></h2>
<p>The linear regression is the most simple model
in machine learning described by the following expression
<img class="math" src="../../_images/math/aa73e51a011e75aac8fbc2865bfa9ce8ec4efa12.svg" alt="Y = XA + B"/>. We can see it as a function of three
variables <img class="math" src="../../_images/math/0cd20dff739f9d04364f3cfeb9fb78823e5e85c1.svg" alt="Y = f(X, A, B)"/> decomposed into
<cite>y = Add(MatMul(X, A), B))</cite>. That what’s we need to represent
with ONNX operators. The first thing is to implement a function
with <a class="reference internal" href="../../onnxmd/onnx_operators.html#l-onnx-operators"><span class="std std-ref">ONNX operators</span></a>.
ONNX is strongly typed. Shape and type must be defined for both
input and output of the function. That said, we need four functions
to build the graph among the <a class="reference internal" href="../../api/onnx_python/helper.html#l-onnx-make-function"><span class="std std-ref">make function</span></a>:</p>
<ul class="simple">
<li><p><cite>make_tensor_value_info</cite>: declares a variable (input or output)
given its shape and type</p></li>
<li><p><cite>make_node</cite>: creates a node defined by an operation
(an operator type), its inputs and outputs</p></li>
<li><p><cite>make_graph</cite>: a function to create an ONNX graph with
the objects created by the two previous functions</p></li>
<li><p><cite>make_model</cite>: a last function with merges the graph and
additional metadata</p></li>
</ul>
<p>All along the creation, we need to give a name to every input,
output of every node of the graph. Input and output of the graph
are defined by <a class="reference external" href="https://github.com/onnx/onnx">onnx</a> objects, strings are used to refer to
intermediate results. This is how it looks like.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span>
    <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="c1"># inputs</span>

<span class="c1"># &#39;X&#39; is the name, TensorProto.FLOAT the type, [None, None] the shape</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

<span class="c1"># outputs, the shape is left undefined</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># nodes</span>

<span class="c1"># It creates a node defined by the operator type MatMul,</span>
<span class="c1"># &#39;X&#39;, &#39;A&#39; are the inputs of the node, &#39;XA&#39; the output.</span>
<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>

<span class="c1"># from nodes to graph</span>
<span class="c1"># the graph is built from the list of nodes, the list of inputs,</span>
<span class="c1"># the list of outputs and a name.</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span>  <span class="c1"># nodes</span>
                   <span class="s1">&#39;lr&#39;</span><span class="p">,</span>  <span class="c1"># a name</span>
                   <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span>  <span class="c1"># inputs</span>
                   <span class="p">[</span><span class="n">Y</span><span class="p">])</span>  <span class="c1"># outputs</span>

<span class="c1"># onnx graph</span>
<span class="c1"># there is no metata in this case.</span>

<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># the work is done, let&#39;s display it...</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<script>
function myFunction140033945706704() {
    var x = document.getElementById("collapse140033945706704");
    var b = document.getElementById("colidb140033945706704");
    if (x.style.display === "none") { x.style.display = "block"; b.innerText = 'hide output'; }
    else { x.style.display = "none"; b.innerText = 'unhide output'; }
}
</script>
<p style="margin-bottom:10px;"><button id="colidb140033945706704" onclick="myFunction140033945706704()">unhide output</button></p>
<div id="collapse140033945706704" style="display:none;"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XA</span>
      <span class="n">Add</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
</div>
    <div id="gdot-140033945706896-cont"><div id="gdot-140033945706896" style="width:100%;height:100%;"></div>
    <script>

    require(['../../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n\n  X [shape=box color=red label=\"X\\nfloat((0, 0))\" fontsize=10];\n  A [shape=box color=red label=\"A\\nfloat((0, 0))\" fontsize=10];\n  B [shape=box color=red label=\"B\\nfloat((0, 0))\" fontsize=10];\n\n  Y [shape=box color=green label=\"Y\\nfloat(('?',))\" fontsize=10];\n\n\n  XA [shape=box label=\"XA\" fontsize=10];\n  MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\\n(MatMul)\" fontsize=10];\n  X -> MatMul;\n  A -> MatMul;\n  MatMul -> XA;\n\n  Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\\n(Add)\" fontsize=10];\n  XA -> Add;\n  B -> Add;\n  Add -> Y;\n}\n");
    document.getElementById('gdot-140033945706896').innerHTML = svgGraph; });
    
</script>
</div><p>An empty shape (<cite>None</cite>) means any shape, a shape defined as <cite>[None, None]</cite>
tells this object is a tensor with two dimensions without any further precision.
The ONNX graph can also be inspected by looking into the fields
of each object of the graph.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span>
    <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>


<span class="k">def</span> <span class="nf">shape2tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;dim_value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span> <span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">])</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># the list of inputs</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** inputs **&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

<span class="c1"># in a more nicely format</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** inputs **&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;name=</span><span class="si">%r</span><span class="s2"> dtype=</span><span class="si">%r</span><span class="s2"> shape=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">elem_type</span><span class="p">,</span>
        <span class="n">shape2tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>

<span class="c1"># the list of outputs</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** outputs **&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

<span class="c1"># in a more nicely format</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** outputs **&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;name=</span><span class="si">%r</span><span class="s2"> dtype=</span><span class="si">%r</span><span class="s2"> shape=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">elem_type</span><span class="p">,</span>
        <span class="n">shape2tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>

<span class="c1"># the list of nodes</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** nodes **&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

<span class="c1"># in a more nicely format</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** nodes **&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;name=</span><span class="si">%r</span><span class="s2"> type=</span><span class="si">%r</span><span class="s2"> input=</span><span class="si">%r</span><span class="s2"> output=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">op_type</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">**</span> <span class="n">inputs</span> <span class="o">**</span>
    <span class="p">[</span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="n">tensor_type</span> <span class="p">{</span>
        <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="p">{</span>
          <span class="n">dim</span> <span class="p">{</span>
          <span class="p">}</span>
          <span class="n">dim</span> <span class="p">{</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="n">tensor_type</span> <span class="p">{</span>
        <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="p">{</span>
          <span class="n">dim</span> <span class="p">{</span>
          <span class="p">}</span>
          <span class="n">dim</span> <span class="p">{</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="n">tensor_type</span> <span class="p">{</span>
        <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="p">{</span>
          <span class="n">dim</span> <span class="p">{</span>
          <span class="p">}</span>
          <span class="n">dim</span> <span class="p">{</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">]</span>
    <span class="o">**</span> <span class="n">inputs</span> <span class="o">**</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="n">dtype</span><span class="o">=</span><span class="mi">1</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="n">dtype</span><span class="o">=</span><span class="mi">1</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="n">dtype</span><span class="o">=</span><span class="mi">1</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="o">**</span> <span class="n">outputs</span> <span class="o">**</span>
    <span class="p">[</span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
    <span class="nb">type</span> <span class="p">{</span>
      <span class="n">tensor_type</span> <span class="p">{</span>
        <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">]</span>
    <span class="o">**</span> <span class="n">outputs</span> <span class="o">**</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="n">dtype</span><span class="o">=</span><span class="mi">1</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="o">**</span> <span class="n">nodes</span> <span class="o">**</span>
    <span class="p">[</span><span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
    <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
    <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;MatMul&quot;</span>
    <span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
    <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
    <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Add&quot;</span>
    <span class="p">]</span>
    <span class="o">**</span> <span class="n">nodes</span> <span class="o">**</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;MatMul&#39;</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">]</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The tensor type is an integer (= 1). The following array gives the
equivalent type with <a class="reference external" href="https://numpy.org/">numpy</a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">onnx.mapping</span> <span class="kn">import</span> <span class="n">TENSOR_TYPE_TO_NP_TYPE</span>

<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">TENSOR_TYPE_TO_NP_TYPE</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
     <span class="mi">2</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">),</span>
     <span class="mi">3</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">),</span>
     <span class="mi">4</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint16&#39;</span><span class="p">),</span>
     <span class="mi">5</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span>
     <span class="mi">6</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span>
     <span class="mi">7</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">),</span>
     <span class="mi">8</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">),</span>
     <span class="mi">9</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">),</span>
     <span class="mi">10</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float16&#39;</span><span class="p">),</span>
     <span class="mi">11</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">),</span>
     <span class="mi">12</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint32&#39;</span><span class="p">),</span>
     <span class="mi">13</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">),</span>
     <span class="mi">14</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;complex64&#39;</span><span class="p">),</span>
     <span class="mi">15</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;complex128&#39;</span><span class="p">),</span>
     <span class="mi">16</span><span class="p">:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float16&#39;</span><span class="p">)}</span>
</pre></div>
</div>
</section>
<section id="serialization">
<h2><a class="toc-backref" href="#id2">Serialization</a><a class="headerlink" href="#serialization" title="Permalink to this headline">¶</a></h2>
<p>The model needs to be saved to be deployed.
ONNX is based on <a class="reference external" href="https://developers.google.com/protocol-buffers">protobuf</a>. It minimizes the space needed
to save the graph on disk. Every object (see <a class="reference internal" href="../../api/onnx_python/classes.html#l-onnx-classes"><span class="std std-ref">onnx classes</span></a>)
in <a class="reference external" href="https://github.com/onnx/onnx">onnx</a> can be serialized with method <cite>SerializeToString</cite>. That’s
the case for the whole model.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span>
    <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>


<span class="k">def</span> <span class="nf">shape2tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;dim_value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span> <span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">])</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># The serialization</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;linear_regression.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="c1"># display</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XA</span>
      <span class="n">Add</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>The graph can be restored with function <cite>load</cite>:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;linear_regression.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># display</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XA</span>
      <span class="n">Add</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>It looks exactly the same. Any model can be serialized this way
unless they are bigger than 2 Gb. <a class="reference external" href="https://developers.google.com/protocol-buffers">protobuf</a> is limited to size
smaller than this threshold. Next sections will show how to
overcome that limit.</p>
</section>
<section id="initializer-default-value">
<span id="l-onnx-linear-regression-onnx-api-init"></span><h2><a class="toc-backref" href="#id3">Initializer, default value</a><a class="headerlink" href="#initializer-default-value" title="Permalink to this headline">¶</a></h2>
<p>The previous model assumed the coefficients of the linear regression
were also input of the model. That’s not very convenient. They should be
part of the model itself as constant or <strong>initializer</strong> to follow
onnx semantic. Next example modifies the previous one to change inputs
<cite>A</cite> and <cite>B</cite> into initializers. The package implements two functions to
convert from <a class="reference external" href="https://numpy.org/">numpy</a> into <a class="reference external" href="https://github.com/onnx/onnx">onnx</a> and the other way around
(see <a class="reference internal" href="../../api/onnx_python/numpy_helper.html#l-numpy-helper-onnx-array"><span class="std std-ref">array</span></a>).</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">onnx.numpy_helper.to_array</span></code>: converts from onnx to numpy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onnx.numpy_helper.from_array</span></code>: converts from numpy to onnx</p></li>
</ul>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span> <span class="n">make_graph</span><span class="p">,</span>
    <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="c1"># initializers</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>

<span class="c1"># the part which does not change</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;AX&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AX&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span> <span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">],</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">])</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;C&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AX</span>
      <span class="n">Add</span><span class="p">(</span><span class="n">AX</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>

    <div id="gdot-140033945746016-cont"><div id="gdot-140033945746016" style="width:100%;height:100%;"></div>
    <script>

    require(['../../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n\n  X [shape=box color=red label=\"X\\nfloat((0, 0))\" fontsize=10];\n\n  Y [shape=box color=green label=\"Y\\nfloat(('?',))\" fontsize=10];\n\n  A [shape=box label=\"A\\nfloat32((2,))\\n[ 0.5 -0.6]\" fontsize=10];\n  C [shape=box label=\"C\\nfloat32((1,))\\n[0.4]\" fontsize=10];\n\n  AX [shape=box label=\"AX\" fontsize=10];\n  MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\\n(MatMul)\" fontsize=10];\n  X -> MatMul;\n  A -> MatMul;\n  MatMul -> AX;\n\n  Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\\n(Add)\" fontsize=10];\n  AX -> Add;\n  C -> Add;\n  Add -> Y;\n}\n");
    document.getElementById('gdot-140033945746016').innerHTML = svgGraph; });
    
</script>
</div><p>Again, it is possible to go through the onnx structure to check
how the initializers look like.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span> <span class="n">make_graph</span><span class="p">,</span>
    <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="c1"># initializers</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>

<span class="c1"># the part which does not change</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;AX&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AX&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span> <span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">],</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">])</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** intializer **&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">initializer</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">**</span> <span class="n">intializer</span> <span class="o">**</span>
    <span class="n">dims</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">data_type</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
    <span class="n">raw_data</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\000\000\000</span><span class="s2">?</span><span class="se">\232\231\031\277</span><span class="s2">&quot;</span>
    
    <span class="n">dims</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">data_type</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span>
    <span class="n">raw_data</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\315\314\314</span><span class="s2">&gt;&quot;</span>
</pre></div>
</div>
<p>The type is defined as integer as well with the same meaning.
In this second example, there is only one input left.
Input <cite>A</cite> and <cite>B</cite> were removed. They could be kept. In that case,
they are optional: every initiliazer sharing the same name as input
is considered as a default value. It replaces the input if this one
is not given.</p>
</section>
<section id="attributes">
<h2><a class="toc-backref" href="#id4">Attributes</a><a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h2>
<p>Some operators need attributes such as <a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnx_docs/Operators.html#a-name-transpose-a-a-name-transpose-transpose-a">Transpose</a> operator.
Let’s build the graph for expression <img class="math" src="../../_images/math/a02f9eaed7f324069c5995b3be0cb862a791300c.svg" alt="y = XA' + B"/> or
<cite>y = Add(MatMul(X, Transpose(A)) + B)</cite>. Tranpose needs an attribute
defining the permutation of axes: <cite>perm=[1, 0]</cite>. It is added
as a named attribute in function <cite>make_node</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span>
    <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="c1"># unchanged</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># added</span>
<span class="n">node_transpose</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;tA&#39;</span><span class="p">],</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># unchanged except A is replaced by tA</span>
<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;tA&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>

<span class="c1"># node_transpose is added to the list</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">node_transpose</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span>
                   <span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">])</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># the work is done, let&#39;s display it...</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Transpose</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">tA</span>
      <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tA</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XA</span>
        <span class="n">Add</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>

    <div id="gdot-140033945695376-cont"><div id="gdot-140033945695376" style="width:100%;height:100%;"></div>
    <script>

    require(['../../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n\n  X [shape=box color=red label=\"X\\nfloat((0, 0))\" fontsize=10];\n  A [shape=box color=red label=\"A\\nfloat((0, 0))\" fontsize=10];\n  B [shape=box color=red label=\"B\\nfloat((0, 0))\" fontsize=10];\n\n  Y [shape=box color=green label=\"Y\\nfloat(('?',))\" fontsize=10];\n\n\n  tA [shape=box label=\"tA\" fontsize=10];\n  Transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\\n(Transpose)\\nperm=[1 0]\" fontsize=10];\n  A -> Transpose;\n  Transpose -> tA;\n\n  XA [shape=box label=\"XA\" fontsize=10];\n  MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\\n(MatMul)\" fontsize=10];\n  X -> MatMul;\n  tA -> MatMul;\n  MatMul -> XA;\n\n  Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\\n(Add)\" fontsize=10];\n  XA -> Add;\n  B -> Add;\n  Add -> Y;\n}\n");
    document.getElementById('gdot-140033945695376').innerHTML = svgGraph; });
    
</script>
</div></section>
<section id="opset-and-metadata">
<h2><a class="toc-backref" href="#id5">Opset and metadata</a><a class="headerlink" href="#opset-and-metadata" title="Permalink to this headline">¶</a></h2>
<p>Let’s load the ONNX file previously created and check
what kind of metadata it has.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">load</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;linear_regression.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc_string&#39;</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">,</span>
              <span class="s1">&#39;ir_version&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata_props&#39;</span><span class="p">,</span> <span class="s1">&#39;model_version&#39;</span><span class="p">,</span>
              <span class="s1">&#39;opset_import&#39;</span><span class="p">,</span> <span class="s1">&#39;producer_name&#39;</span><span class="p">,</span> <span class="s1">&#39;producer_version&#39;</span><span class="p">,</span>
              <span class="s1">&#39;training_info&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">doc_string</span> 
    <span class="n">domain</span> 
    <span class="n">functions</span> <span class="p">[]</span>
    <span class="n">ir_version</span> <span class="mi">8</span>
    <span class="n">metadata_props</span> <span class="p">[]</span>
    <span class="n">model_version</span> <span class="mi">0</span>
    <span class="n">opset_import</span> <span class="p">[</span><span class="n">version</span><span class="p">:</span> <span class="mi">16</span>
    <span class="p">]</span>
    <span class="n">producer_name</span> 
    <span class="n">producer_version</span> 
    <span class="n">training_info</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Most of them are empty because it was not filled when the ONNX
graph was created. Two of them have a value:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">load</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;linear_regression.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ir_version:&quot;</span><span class="p">,</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">ir_version</span><span class="p">)</span>
<span class="k">for</span> <span class="n">opset</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;opset domain=</span><span class="si">%r</span><span class="s2"> version=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opset</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">opset</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">ir_version</span><span class="p">:</span> <span class="mi">8</span>
    <span class="n">opset</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
</pre></div>
</div>
<p><a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnx_docs/IR.html">IR</a> defined the version of ONNX language.
Opset defines the version of operators being used.
Without any precision, ONNX uses the latest version available
coming from the installed package.
Another one can be used.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">load</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;linear_regression.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="k">del</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="p">[:]</span>
<span class="n">opset</span> <span class="o">=</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
<span class="n">opset</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">opset</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">14</span>

<span class="k">for</span> <span class="n">opset</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;opset domain=</span><span class="si">%r</span><span class="s2"> version=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opset</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">opset</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
</pre></div>
</div>
<p>Any opset can be used as long as all operators are defined
the way ONNX specifies it. Version 5 of operator <em>Reshape</em>
defines the shape as an input and not as an attribute like in
version 1. The opset tells which specifications is followed
while describing the graph.</p>
<p>The other metadata can be used to store any information,
to store information about the way the model was generated,
a way to distinguish a model from another one with a version
number.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">load</span><span class="p">,</span> <span class="n">helper</span><span class="p">,</span> <span class="n">TrainingInfoProto</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;linear_regression.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">onnx_model</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">producer_name</span> <span class="o">=</span> <span class="s2">&quot;something&quot;</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">producer_version</span> <span class="o">=</span> <span class="s2">&quot;some other thing&quot;</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">doc_string</span> <span class="o">=</span> <span class="s2">&quot;documentation about this model&quot;</span>
<span class="n">prop</span> <span class="o">=</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">metadata_props</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">key1</span><span class="o">=</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="n">key2</span><span class="o">=</span><span class="s2">&quot;value2&quot;</span><span class="p">)</span>
<span class="n">helper</span><span class="o">.</span><span class="n">set_model_props</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">ir_version</span><span class="p">:</span> <span class="mi">8</span>
    <span class="n">producer_name</span><span class="p">:</span> <span class="s2">&quot;something&quot;</span>
    <span class="n">producer_version</span><span class="p">:</span> <span class="s2">&quot;some other thing&quot;</span>
    <span class="n">model_version</span><span class="p">:</span> <span class="mi">15</span>
    <span class="n">doc_string</span><span class="p">:</span> <span class="s2">&quot;documentation about this model&quot;</span>
    <span class="n">graph</span> <span class="p">{</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;MatMul&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Add&quot;</span>
      <span class="p">}</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;lr&quot;</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">output</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">opset_import</span> <span class="p">{</span>
      <span class="n">version</span><span class="p">:</span> <span class="mi">16</span>
    <span class="p">}</span>
    <span class="n">metadata_props</span> <span class="p">{</span>
      <span class="n">key</span><span class="p">:</span> <span class="s2">&quot;key1&quot;</span>
      <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span>
    <span class="p">}</span>
    <span class="n">metadata_props</span> <span class="p">{</span>
      <span class="n">key</span><span class="p">:</span> <span class="s2">&quot;key2&quot;</span>
      <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Field <cite>training_info</cite> can be used to store additional graphs.
See <a class="reference external" href="https://github.com/onnx/onnx/blob/master/onnx/test/training_tool_test.py">training_tool_test.py</a>
to see how it works.</p>
</section>
<section id="subgraph-test-and-loops">
<h2><a class="toc-backref" href="#id6">Subgraph: test and loops</a><a class="headerlink" href="#subgraph-test-and-loops" title="Permalink to this headline">¶</a></h2>
<p>They are usually grouped in a category called <em>control flow</em>.
It is usually better to avoid them as they are not as efficient
as the matrix operation are much faster and optimized.</p>
<section id="if">
<h3><a class="toc-backref" href="#id7">If</a><a class="headerlink" href="#if" title="Permalink to this headline">¶</a></h3>
<p>A test can be implemented with operator <a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnx_docs/Operators.html#a-name-if-a-a-name-if-if-a">If</a>.
It executes one subgraph or another depending on one
boolean. This is not used very often as a function usually
needs the result of many comparisons in a batch.
The following example computes the sum of all floats
in a matrix based on the sign, returns 1 or -1.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_node</span><span class="p">,</span> <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_model</span><span class="p">,</span> <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">onnx.numpy_helper</span> <span class="kn">import</span> <span class="n">from_array</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="c1"># initializers</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">)</span>

<span class="c1"># Same as before, X is the input, Y is the output.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># The node building the condition. The first one</span>
<span class="c1"># sum over all axes.</span>
<span class="n">rsum</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;ReduceSum&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;rsum&#39;</span><span class="p">])</span>
<span class="c1"># The second compares the result to 0.</span>
<span class="n">cond</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Greater&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rsum&#39;</span><span class="p">,</span> <span class="s1">&#39;zero&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">])</span>

<span class="c1"># Builds the graph is the condition is True.</span>
<span class="c1"># Input for then</span>
<span class="n">then_out</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span>
    <span class="s1">&#39;then_out&#39;</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="c1"># The constant to return.</span>
<span class="n">then_cst</span> <span class="o">=</span> <span class="n">from_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="c1"># The only node.</span>
<span class="n">then_const_node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Constant&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;then_out&#39;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="n">then_cst</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cst1&#39;</span><span class="p">)</span>

<span class="c1"># And the graph wrapping these elements.</span>
<span class="n">then_body</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span>
    <span class="p">[</span><span class="n">then_const_node</span><span class="p">],</span> <span class="s1">&#39;then_body&#39;</span><span class="p">,</span>
    <span class="p">[],</span> <span class="p">[</span><span class="n">then_out</span><span class="p">])</span>

<span class="c1"># Same process for the else branch.</span>
<span class="n">else_out</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span>
    <span class="s1">&#39;else_out&#39;</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">else_cst</span> <span class="o">=</span> <span class="n">from_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">else_const_node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Constant&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;else_out&#39;</span><span class="p">],</span>
    <span class="n">value</span><span class="o">=</span><span class="n">else_cst</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cst2&#39;</span><span class="p">)</span>

<span class="n">else_body</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span>
    <span class="p">[</span><span class="n">else_const_node</span><span class="p">],</span> <span class="s1">&#39;else_body&#39;</span><span class="p">,</span>
    <span class="p">[],</span> <span class="p">[</span><span class="n">else_out</span><span class="p">])</span>

<span class="c1"># Finally the node If taking both graphs as attributes.</span>
<span class="n">if_node</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;If&#39;</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">],</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span>
    <span class="n">then_branch</span><span class="o">=</span><span class="n">then_body</span><span class="p">,</span>
    <span class="n">else_branch</span><span class="o">=</span><span class="n">else_body</span><span class="p">)</span>

<span class="c1"># The final graph.</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">([</span><span class="n">if_node</span><span class="p">,</span> <span class="n">rsum</span><span class="p">,</span> <span class="n">cond</span><span class="p">],</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">],</span> <span class="p">[</span><span class="n">zero</span><span class="p">])</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># Let&#39;s freeze the opset.</span>
<span class="k">del</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="p">[:]</span>
<span class="n">opset</span> <span class="o">=</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
<span class="n">opset</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">opset</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># Save.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;onnx_if_sign.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="c1"># Let&#39;s see the output.</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>

<span class="c1"># It works.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="c1"># Some display.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)]</span>
    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ReduceSum</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rsum</span>
      <span class="n">Greater</span><span class="p">(</span><span class="n">rsum</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cond</span>
        <span class="n">If</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>The whole is easier to visualize with the following image.</p>

    <div id="gdot-140034059243632-cont"><div id="gdot-140034059243632" style="width:100%;height:100%;"></div>
    <script>

    require(['../../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n\n  X [shape=box color=red label=\"X\\nfloat(('?',))\" fontsize=10];\n\n  Y [shape=box color=green label=\"Y\\nfloat(('?',))\" fontsize=10];\n\n  zero [shape=box label=\"zero\\nfloat32((1,))\\n[0.]\" fontsize=10];\n\n  subgraph cluster_If140034929016160_140039666466096 {\n    label=\"If\\n(If)\\nelse_branch=node {\\n  output: '...\\nthen_branch=node {\\n  output: '...\";\n    fontsize=10;\n    color=black;\n    B_then_out [shape=box color=green label=\"then_out\\nfloat((5,))\" fontsize=10];\n  \n  \n    B_cst1 [shape=box style=\"filled,rounded\" color=orange label=\"Constant\\n(cst1)\\nvalue=[1.]\" fontsize=10];\n    B_cst1 -> B_then_out;\n  }\n  B_then_out -> Y;\n  subgraph cluster_If140034929016160_140039666466032 {\n    label=\"If\\n(If)\\nelse_branch=node {\\n  output: '...\\nthen_branch=node {\\n  output: '...\";\n    fontsize=10;\n    color=black;\n    B_else_out [shape=box color=green label=\"else_out\\nfloat((5,))\" fontsize=10];\n  \n  \n    B_cst2 [shape=box style=\"filled,rounded\" color=orange label=\"Constant\\n(cst2)\\nvalue=[-1.]\" fontsize=10];\n    B_cst2 -> B_else_out;\n  }\n  B_else_out -> Y;\n  If -> B_cst1 [lhead=cluster_If140034929016160_140039666466096];\n  If -> B_cst2 [lhead=cluster_If140034929016160_140039666466032];\n  cond -> If;\n  If -> Y;\n\n  rsum [shape=box label=\"rsum\" fontsize=10];\n  ReduceSum [shape=box style=\"filled,rounded\" color=orange label=\"ReduceSum\\n(ReduceSum)\" fontsize=10];\n  X -> ReduceSum;\n  ReduceSum -> rsum;\n\n  cond [shape=box label=\"cond\" fontsize=10];\n  Greater [shape=box style=\"filled,rounded\" color=orange label=\"Greater\\n(Greater)\" fontsize=10];\n  rsum -> Greater;\n  zero -> Greater;\n  Greater -> cond;\n}\n");
    document.getElementById('gdot-140034059243632').innerHTML = svgGraph; });
    
</script>
</div><p>Both else and then branches are very simple.
Node <em>If</em> could even be replace with a node <em>Where</em> and
that would be faster. It becomes interesting when both branches
are bigger and skipping one is more efficient.</p>
</section>
<section id="scan">
<h3><a class="toc-backref" href="#id8">Scan</a><a class="headerlink" href="#scan" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnx_docs/Operators.html#a-name-scan-a-a-name-scan-scan-a">Scan</a> seems quite complex when reading the specifications.
It is useful to loop over one dimension of a tensor and store
the results in a preallocated tensor.</p>
<p>The following example implements a classic nearest neighbors for
a regression problem. The first step consists in computing the
pairwise distances between the input features <em>X</em> and the training
set <em>W</em>: <img class="math" src="../../_images/math/9e7588f0bfc11e891f341bd3002f42d12b7367fe.svg" alt="dist(X,W) = (M_{ij}) = (\norm{X_i - W_j}^2)_{ij}"/>. It is
followed by an operator <a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnx_docs/Operators.html#a-name-topk-a-a-name-topk-topk-a">TopK</a> which extracts the <em>k</em> nearest
neighbors.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span> <span class="n">make_graph</span><span class="p">,</span>
    <span class="n">make_tensor_value_info</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="c1"># subgraph</span>
<span class="n">initializers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;next_in&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;next_out&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;scan_out&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
<span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Identity&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;next_in&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;next_out&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cdistd_17_Identity&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;next_in&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cdistdf_17_C0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cdistdf_17_Sub&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;ReduceSumSquare&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cdistdf_17_C0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cdistdf_17_reduced0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cdistdf_17_ReduceSumSquare&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Identity&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cdistdf_17_reduced0&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;scan_out&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cdistdf_17_Identity&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;OnnxIdentity&#39;</span><span class="p">,</span>
                   <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">initializers</span><span class="p">)</span>

<span class="c1"># main graph</span>

<span class="n">initializers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">opsets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
<span class="n">target_opset</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># subgraphs</span>

<span class="c1"># initializers</span>
<span class="n">list_value</span> <span class="o">=</span> <span class="p">[</span><span class="mf">23.29599822460675</span><span class="p">,</span> <span class="o">-</span><span class="mf">120.86516699239603</span><span class="p">,</span> <span class="o">-</span><span class="mf">144.70495899914215</span><span class="p">,</span> <span class="o">-</span><span class="mf">260.08772982740413</span><span class="p">,</span>
              <span class="mf">154.65272105889147</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.23295157108991</span><span class="p">,</span> <span class="mf">247.45232560871727</span><span class="p">,</span> <span class="o">-</span><span class="mf">182.83789715805776</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">132.92727431421793</span><span class="p">,</span> <span class="mf">147.48710175784703</span><span class="p">,</span> <span class="mf">88.27761768038069</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.87785569894749</span><span class="p">,</span>
              <span class="mf">111.71487894705504</span><span class="p">,</span> <span class="mf">301.0518319089629</span><span class="p">,</span> <span class="o">-</span><span class="mf">29.64235742280055</span><span class="p">,</span> <span class="o">-</span><span class="mf">113.78493504731911</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">204.41218591022718</span><span class="p">,</span> <span class="mf">112.26561056133608</span><span class="p">,</span> <span class="mf">66.04032954135549</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">229.5428380626701</span><span class="p">,</span> <span class="o">-</span><span class="mf">33.549262642481615</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">140.95737409864623</span><span class="p">,</span> <span class="o">-</span><span class="mf">87.8145187836131</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">90.61397011283958</span><span class="p">,</span> <span class="mf">57.185488100413366</span><span class="p">,</span> <span class="mf">56.864151796743855</span><span class="p">,</span> <span class="mf">77.09054590340892</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">187.72501631246712</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.779503579806025</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">21.642642730674076</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.58517761667535</span><span class="p">,</span>
              <span class="mf">78.56025104939847</span><span class="p">,</span> <span class="o">-</span><span class="mf">23.92423223842056</span><span class="p">,</span> <span class="mf">234.9166231927213</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.73512816431007</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">10.150864499514297</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.37105466673813</span><span class="p">,</span> <span class="mf">65.5755688281476</span><span class="p">,</span> <span class="mf">108.68676290979731</span><span class="p">,</span> <span class="o">-</span><span class="mf">78.36748960443065</span><span class="p">]</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">tensor</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_ArrayFeatureExtractorcst&#39;</span><span class="p">)</span>
<span class="n">initializers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

<span class="n">list_value</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1394007205963135</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6848101019859314</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.234825849533081</span><span class="p">,</span> <span class="mf">0.4023416340351105</span><span class="p">,</span>
              <span class="mf">0.17742614448070526</span><span class="p">,</span> <span class="mf">0.46278226375579834</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.4017809331417084</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.630198359489441</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.5096521973609924</span><span class="p">,</span> <span class="mf">0.7774903774261475</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.4380742907524109</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2527953386306763</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">1.0485529899597168</span><span class="p">,</span> <span class="mf">1.950775384902954</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">1.420017957687378</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7062702178955078</span><span class="p">,</span>
              <span class="mf">1.8675580024719238</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15135720372200012</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.9772778749465942</span><span class="p">,</span> <span class="mf">0.9500884413719177</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">2.5529897212982178</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7421650290489197</span><span class="p">,</span> <span class="mf">0.653618574142456</span><span class="p">,</span> <span class="mf">0.8644362092018127</span><span class="p">,</span>
              <span class="mf">1.5327792167663574</span><span class="p">,</span> <span class="mf">0.37816253304481506</span><span class="p">,</span> <span class="mf">1.4693588018417358</span><span class="p">,</span> <span class="mf">0.154947429895401</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.6724604368209839</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7262825965881348</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.35955315828323364</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8131462931632996</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.8707971572875977</span><span class="p">,</span> <span class="mf">0.056165341287851334</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.5788496732711792</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3115525245666504</span><span class="p">,</span>
              <span class="mf">1.2302906513214111</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.302302747964859</span><span class="p">,</span> <span class="mf">1.202379822731018</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.38732680678367615</span><span class="p">,</span>
              <span class="mf">2.269754648208618</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18718385696411133</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">1.4543657302856445</span><span class="p">,</span> <span class="mf">0.04575851559638977</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.9072983860969543</span><span class="p">,</span> <span class="mf">0.12898291647434235</span><span class="p">,</span> <span class="mf">0.05194539576768875</span><span class="p">,</span> <span class="mf">0.7290905714035034</span><span class="p">,</span>
              <span class="mf">1.4940791130065918</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8540957570075989</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.2051582634449005</span><span class="p">,</span> <span class="mf">0.3130677044391632</span><span class="p">,</span>
              <span class="mf">1.764052391052246</span><span class="p">,</span> <span class="mf">2.2408931255340576</span><span class="p">,</span> <span class="mf">0.40015721321105957</span><span class="p">,</span> <span class="mf">0.978738009929657</span><span class="p">,</span>
              <span class="mf">0.06651721894741058</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3627411723136902</span><span class="p">,</span> <span class="mf">0.30247190594673157</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6343221068382263</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.5108051300048828</span><span class="p">,</span> <span class="mf">0.4283318817615509</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">1.18063223361969</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02818222902715206</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">1.6138978004455566</span><span class="p">,</span> <span class="mf">0.38690251111984253</span><span class="p">,</span> <span class="o">-</span>
              <span class="mf">0.21274028718471527</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8954665660858154</span><span class="p">,</span>
              <span class="mf">0.7610377073287964</span><span class="p">,</span> <span class="mf">0.3336743414402008</span><span class="p">,</span> <span class="mf">0.12167501449584961</span><span class="p">,</span> <span class="mf">0.44386324286460876</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.10321885347366333</span><span class="p">,</span> <span class="mf">1.4542734622955322</span><span class="p">,</span> <span class="mf">0.4105985164642334</span><span class="p">,</span> <span class="mf">0.14404356479644775</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.8877857327461243</span><span class="p">,</span> <span class="mf">0.15634897351264954</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.980796456336975</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.34791216254234314</span><span class="p">]</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">tensor</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sc_Scancst&#39;</span><span class="p">)</span>
<span class="n">initializers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">tensor</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;To_TopKcst&#39;</span><span class="p">)</span>
<span class="n">initializers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">tensor</span> <span class="o">=</span> <span class="n">numpy_helper</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_Reshapecst&#39;</span><span class="p">)</span>
<span class="n">initializers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

<span class="c1"># inputs</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># outputs</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># nodes</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Scan&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;Sc_Scancst&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;UU032UU&#39;</span><span class="p">,</span> <span class="s1">&#39;UU033UU&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sc_Scan&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">num_scan_inputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;UU033UU&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Tr_transposed0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tr_Transpose&#39;</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Sqrt&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Tr_transposed0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Sq_Y0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sq_Sqrt&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;TopK&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Sq_Y0&#39;</span><span class="p">,</span> <span class="s1">&#39;To_TopKcst&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;To_Values0&#39;</span><span class="p">,</span> <span class="s1">&#39;To_Indices1&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;To_TopK&#39;</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Flatten&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;To_Indices1&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;knny_output0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_Flatten&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;ArrayFeatureExtractor&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;knny_ArrayFeatureExtractorcst&#39;</span><span class="p">,</span> <span class="s1">&#39;knny_output0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;knny_Z0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_ArrayFeatureExtractor&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Reshape&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;knny_Z0&#39;</span><span class="p">,</span> <span class="s1">&#39;knny_Reshapecst&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;knny_reshaped0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_Reshape&#39;</span><span class="p">,</span> <span class="n">allowzero</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;knny_reshaped0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;knny_transposed0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_Transpose&#39;</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Cast&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;knny_transposed0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Ca_output0&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ca_Cast&#39;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;ReduceMean&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Ca_output0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Re_ReduceMean&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="c1"># graph</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;KNN regressor&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">initializers</span><span class="p">)</span>

<span class="c1"># model</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">ir_version</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">producer_name</span> <span class="o">=</span> <span class="s1">&#39;skl2onnx&#39;</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">producer_version</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;ai.onnx&#39;</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">onnx_model</span><span class="o">.</span><span class="n">doc_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">set_model_props</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="p">{})</span>

<span class="c1"># opsets</span>
<span class="k">del</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="p">[:]</span>  <span class="c1"># pylint: disable=E1101</span>
<span class="k">for</span> <span class="n">dom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">opsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">op_set</span> <span class="o">=</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">opset_import</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
    <span class="n">op_set</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">dom</span>
    <span class="n">op_set</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;knnr.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;ai.onnx.ml&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_ArrayFeatureExtractorcst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span>  <span class="mf">23.296</span><span class="p">,</span> <span class="o">-</span><span class="mf">120.865</span><span class="p">,</span> <span class="o">-</span><span class="mf">144.705</span><span class="p">,</span> <span class="o">-</span><span class="mf">260.088</span><span class="p">,</span>  <span class="mf">154.653</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.233</span><span class="p">,</span>
            <span class="mf">247.452</span><span class="p">,</span> <span class="o">-</span><span class="mf">182.838</span><span class="p">,</span> <span class="o">-</span><span class="mf">132.927</span><span class="p">,</span>  <span class="mf">147.487</span><span class="p">,</span>   <span class="mf">88.278</span><span class="p">,</span>  <span class="o">-</span><span class="mf">14.878</span><span class="p">,</span>
            <span class="mf">111.715</span><span class="p">,</span>  <span class="mf">301.052</span><span class="p">,</span>  <span class="o">-</span><span class="mf">29.642</span><span class="p">,</span> <span class="o">-</span><span class="mf">113.785</span><span class="p">,</span> <span class="o">-</span><span class="mf">204.412</span><span class="p">,</span>  <span class="mf">112.266</span><span class="p">,</span>
             <span class="mf">66.04</span> <span class="p">,</span> <span class="o">-</span><span class="mf">229.543</span><span class="p">,</span>  <span class="o">-</span><span class="mf">33.549</span><span class="p">,</span> <span class="o">-</span><span class="mf">140.957</span><span class="p">,</span>  <span class="o">-</span><span class="mf">87.815</span><span class="p">,</span>  <span class="o">-</span><span class="mf">90.614</span><span class="p">,</span>
             <span class="mf">57.185</span><span class="p">,</span>   <span class="mf">56.864</span><span class="p">,</span>   <span class="mf">77.091</span><span class="p">,</span> <span class="o">-</span><span class="mf">187.725</span><span class="p">,</span>  <span class="o">-</span><span class="mf">42.78</span> <span class="p">,</span>  <span class="o">-</span><span class="mf">21.643</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">44.585</span><span class="p">,</span>   <span class="mf">78.56</span> <span class="p">,</span>  <span class="o">-</span><span class="mf">23.924</span><span class="p">,</span>  <span class="mf">234.917</span><span class="p">,</span>  <span class="o">-</span><span class="mf">73.735</span><span class="p">,</span>  <span class="o">-</span><span class="mf">10.151</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">70.371</span><span class="p">,</span>   <span class="mf">65.576</span><span class="p">,</span>  <span class="mf">108.687</span><span class="p">,</span>  <span class="o">-</span><span class="mf">78.367</span><span class="p">])</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sc_Scancst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span> <span class="mf">1.139</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.685</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.235</span><span class="p">,</span>  <span class="mf">0.402</span><span class="p">,</span>  <span class="mf">0.177</span><span class="p">,</span>  <span class="mf">0.463</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.402</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.63</span> <span class="p">,</span>
           <span class="o">-</span><span class="mf">0.51</span> <span class="p">,</span>  <span class="mf">0.777</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.438</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.253</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.049</span><span class="p">,</span>  <span class="mf">1.951</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.42</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.706</span><span class="p">,</span>
            <span class="mf">1.868</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.151</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.977</span><span class="p">,</span>  <span class="mf">0.95</span> <span class="p">,</span> <span class="o">-</span><span class="mf">2.553</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.742</span><span class="p">,</span>  <span class="mf">0.654</span><span class="p">,</span>  <span class="mf">0.864</span><span class="p">,</span>
            <span class="mf">1.533</span><span class="p">,</span>  <span class="mf">0.378</span><span class="p">,</span>  <span class="mf">1.469</span><span class="p">,</span>  <span class="mf">0.155</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.672</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.726</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.813</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">0.871</span><span class="p">,</span>  <span class="mf">0.056</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.579</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.312</span><span class="p">,</span>  <span class="mf">1.23</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.302</span><span class="p">,</span>  <span class="mf">1.202</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.387</span><span class="p">,</span>
            <span class="mf">2.27</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.187</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.454</span><span class="p">,</span>  <span class="mf">0.046</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.907</span><span class="p">,</span>  <span class="mf">0.129</span><span class="p">,</span>  <span class="mf">0.052</span><span class="p">,</span>  <span class="mf">0.729</span><span class="p">,</span>
            <span class="mf">1.494</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.854</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.205</span><span class="p">,</span>  <span class="mf">0.313</span><span class="p">,</span>  <span class="mf">1.764</span><span class="p">,</span>  <span class="mf">2.241</span><span class="p">,</span>  <span class="mf">0.4</span>  <span class="p">,</span>  <span class="mf">0.979</span><span class="p">,</span>
            <span class="mf">0.067</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.363</span><span class="p">,</span>  <span class="mf">0.302</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.634</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.511</span><span class="p">,</span>  <span class="mf">0.428</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.181</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.028</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">1.614</span><span class="p">,</span>  <span class="mf">0.387</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.213</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.895</span><span class="p">,</span>  <span class="mf">0.761</span><span class="p">,</span>  <span class="mf">0.334</span><span class="p">,</span>  <span class="mf">0.122</span><span class="p">,</span>  <span class="mf">0.444</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">0.103</span><span class="p">,</span>  <span class="mf">1.454</span><span class="p">,</span>  <span class="mf">0.411</span><span class="p">,</span>  <span class="mf">0.144</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.888</span><span class="p">,</span>  <span class="mf">0.156</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.981</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.348</span><span class="p">],</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;To_TopKcst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;knny_Reshapecst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">])</span>
    <span class="n">Scan</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">Sc_Scancst</span><span class="p">,</span> <span class="n">num_scan_inputs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UU032UU</span><span class="p">,</span> <span class="n">UU033UU</span>
      <span class="n">Transpose</span><span class="p">(</span><span class="n">UU033UU</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tr_transposed0</span>
        <span class="n">Sqrt</span><span class="p">(</span><span class="n">Tr_transposed0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sq_Y0</span>
          <span class="n">TopK</span><span class="p">(</span><span class="n">Sq_Y0</span><span class="p">,</span> <span class="n">To_TopKcst</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">To_Values0</span><span class="p">,</span> <span class="n">To_Indices1</span>
            <span class="n">Flatten</span><span class="p">(</span><span class="n">To_Indices1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">knny_output0</span>
              <span class="n">ArrayFeatureExtractor</span><span class="p">(</span><span class="n">knny_ArrayFeatureExtractorcst</span><span class="p">,</span> <span class="n">knny_output0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">knny_Z0</span>
                <span class="n">Reshape</span><span class="p">(</span><span class="n">knny_Z0</span><span class="p">,</span> <span class="n">knny_Reshapecst</span><span class="p">,</span> <span class="n">allowzero</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">knny_reshaped0</span>
                  <span class="n">Transpose</span><span class="p">(</span><span class="n">knny_reshaped0</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">knny_transposed0</span>
                    <span class="n">Cast</span><span class="p">(</span><span class="n">knny_transposed0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ca_output0</span>
                      <span class="n">ReduceMean</span><span class="p">(</span><span class="n">Ca_output0</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">variable</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Visually it looks like the following:</p>

    <div id="gdot-140034059246464-cont"><div id="gdot-140034059246464" style="width:100%;height:100%;"></div>
    <script>

    require(['../../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  size=7;\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n\n  input [shape=box color=red label=\"input\\nfloat((0, 4))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\\nfloat((0, 2))\" fontsize=10];\n\n  knny_ArrayFeatureExtractorcst [shape=box label=\"knny_ArrayFeatureExtractorcst\\nfloat64((2, 20))\\n[[  23.296 -120.865 -144.705 -260.088  154.653 -12...\" fontsize=10];\n  Sc_Scancst [shape=box label=\"Sc_Scancst\\nfloat32((20, 4))\\n[[ 1.139 -0.685 -1.235  0.402]\\n [ 0.177  0.463 -0....\" fontsize=10];\n  To_TopKcst [shape=box label=\"To_TopKcst\\nint64((1,))\\n[2]\" fontsize=10];\n  knny_Reshapecst [shape=box label=\"knny_Reshapecst\\nint64((3,))\\n[ 2 -1  2]\" fontsize=10];\n\n  UU032UU [shape=box label=\"UU032UU\" fontsize=10];\n  UU033UU [shape=box label=\"UU033UU\" fontsize=10];\n  subgraph cluster_Scan140035733991328_140040186607664 {\n    label=\"Scan\\n(Sc_Scan)\\nbody=node {\\n  input: 'next_in'...\\nnum_scan_inputs=1\";\n    fontsize=10;\n    color=black;\n    B_next_in [shape=box color=red label=\"next_in\\nfloat((0, 4))\" fontsize=10];\n    B_next [shape=box color=red label=\"next\\nfloat((0,))\" fontsize=10];\n  \n    B_next_out [shape=box color=green label=\"next_out\\nfloat((0, 0))\" fontsize=10];\n    B_scan_out [shape=box color=green label=\"scan_out\\nfloat((0,))\" fontsize=10];\n  \n  \n    B_cdistd_17_Identity [shape=box style=\"filled,rounded\" color=orange label=\"Identity\\n(cdistd_17_Identity)\" fontsize=10];\n    B_next_in -> B_cdistd_17_Identity;\n    B_cdistd_17_Identity -> B_next_out;\n  \n    B_cdistdf_17_C0 [shape=box label=\"cdistdf_17_C0\" fontsize=10];\n    B_cdistdf_17_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\\n(cdistdf_17_Sub)\" fontsize=10];\n    B_next_in -> B_cdistdf_17_Sub;\n    B_next -> B_cdistdf_17_Sub;\n    B_cdistdf_17_Sub -> B_cdistdf_17_C0;\n  \n    B_cdistdf_17_reduced0 [shape=box label=\"cdistdf_17_reduced0\" fontsize=10];\n    B_cdistdf_17_ReduceSumSquare [shape=box style=\"filled,rounded\" color=orange label=\"ReduceSumSquare\\n(cdistdf_17_ReduceSumSquare)\\naxes=[1]\\nkeepdims=0\" fontsize=10];\n    B_cdistdf_17_C0 -> B_cdistdf_17_ReduceSumSquare;\n    B_cdistdf_17_ReduceSumSquare -> B_cdistdf_17_reduced0;\n  \n    B_cdistdf_17_Identity [shape=box style=\"filled,rounded\" color=orange label=\"Identity\\n(cdistdf_17_Identity)\" fontsize=10];\n    B_cdistdf_17_reduced0 -> B_cdistdf_17_Identity;\n    B_cdistdf_17_Identity -> B_scan_out;\n  }\n  input -> B_next_in;\n  Sc_Scancst -> B_next;\n  B_next_out -> UU032UU;\n  B_scan_out -> UU033UU;\n  Sc_Scan -> B_cdistd_17_Identity [lhead=cluster_Scan140035733991328_140040186607664];\n  input -> Sc_Scan;\n  Sc_Scancst -> Sc_Scan;\n  Sc_Scan -> UU032UU;\n  Sc_Scan -> UU033UU;\n\n  Tr_transposed0 [shape=box label=\"Tr_transposed0\" fontsize=10];\n  Tr_Transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\\n(Tr_Transpose)\\nperm=[1 0]\" fontsize=10];\n  UU033UU -> Tr_Transpose;\n  Tr_Transpose -> Tr_transposed0;\n\n  Sq_Y0 [shape=box label=\"Sq_Y0\" fontsize=10];\n  Sq_Sqrt [shape=box style=\"filled,rounded\" color=orange label=\"Sqrt\\n(Sq_Sqrt)\" fontsize=10];\n  Tr_transposed0 -> Sq_Sqrt;\n  Sq_Sqrt -> Sq_Y0;\n\n  To_Values0 [shape=box label=\"To_Values0\" fontsize=10];\n  To_Indices1 [shape=box label=\"To_Indices1\" fontsize=10];\n  To_TopK [shape=box style=\"filled,rounded\" color=orange label=\"TopK\\n(To_TopK)\\nlargest=0\\nsorted=1\" fontsize=10];\n  Sq_Y0 -> To_TopK;\n  To_TopKcst -> To_TopK;\n  To_TopK -> To_Values0;\n  To_TopK -> To_Indices1;\n\n  knny_output0 [shape=box label=\"knny_output0\" fontsize=10];\n  knny_Flatten [shape=box style=\"filled,rounded\" color=orange label=\"Flatten\\n(knny_Flatten)\" fontsize=10];\n  To_Indices1 -> knny_Flatten;\n  knny_Flatten -> knny_output0;\n\n  knny_Z0 [shape=box label=\"knny_Z0\" fontsize=10];\n  knny_ArrayFeatureExtractor [shape=box style=\"filled,rounded\" color=orange label=\"ArrayFeatureExtractor\\n(knny_ArrayFeatureExtractor)\" fontsize=10];\n  knny_ArrayFeatureExtractorcst -> knny_ArrayFeatureExtractor;\n  knny_output0 -> knny_ArrayFeatureExtractor;\n  knny_ArrayFeatureExtractor -> knny_Z0;\n\n  knny_reshaped0 [shape=box label=\"knny_reshaped0\" fontsize=10];\n  knny_Reshape [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\\n(knny_Reshape)\\nallowzero=0\" fontsize=10];\n  knny_Z0 -> knny_Reshape;\n  knny_Reshapecst -> knny_Reshape;\n  knny_Reshape -> knny_reshaped0;\n\n  knny_transposed0 [shape=box label=\"knny_transposed0\" fontsize=10];\n  knny_Transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\\n(knny_Transpose)\\nperm=[1 0 2]\" fontsize=10];\n  knny_reshaped0 -> knny_Transpose;\n  knny_Transpose -> knny_transposed0;\n\n  Ca_output0 [shape=box label=\"Ca_output0\" fontsize=10];\n  Ca_Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\\n(Ca_Cast)\\nto=1\" fontsize=10];\n  knny_transposed0 -> Ca_Cast;\n  Ca_Cast -> Ca_output0;\n\n  Re_ReduceMean [shape=box style=\"filled,rounded\" color=orange label=\"ReduceMean\\n(Re_ReduceMean)\\naxes=[2]\\nkeepdims=0\" fontsize=10];\n  Ca_output0 -> Re_ReduceMean;\n  Re_ReduceMean -> variable;\n}\n");
    document.getElementById('gdot-140034059246464').innerHTML = svgGraph; });
    
</script>
</div><p>The subgraph is executed by operator <a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/onnxmd/onnx_docs/Operators.html#a-name-scan-a-a-name-scan-scan-a">Scan</a>. In this case,
there is one <em>scan</em> input meaning the operator only builds one output.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span>
    <span class="s1">&#39;Scan&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X1&#39;</span><span class="p">,</span> <span class="s1">&#39;X2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y1&#39;</span><span class="p">,</span> <span class="s1">&#39;Y2&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sc_Scan&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">num_scan_inputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>At the first iteration, the subgraph gets <em>X1</em> and the first row of <em>X2</em>.
The graph produces two outputs. The first one replaces <em>X1</em> in the next iteration,
the second one is store in a container to form <em>Y2</em>. At the second iteration,
second input of the subgraph is the second row of <em>X2</em>.
Here is a short summary. Green is the first iteration, blue the second.</p>
<a class="reference internal image-reference" href="../../_images/scanop.png"><img alt="../../_images/scanop.png" src="../../_images/scanop.png" style="width: 400px;" /></a>
</section>
</section>
<section id="functions">
<h2><a class="toc-backref" href="#id9">Functions</a><a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<p>As mentioned in previous chapter, functions can be used to shorten
the code to build the model and offer more possibilities to the runtime
running predictions to be faster if there exists a specific implementation
of this function. If it is not the case, the runtime can still use
the default implementation based on existing operators.</p>
<p>Function <cite>make_function</cite> is used to define a function.
It works like a graph with less types. It is more like a
template. This API may evolve. It does not include intializers either.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">numpy_helper</span><span class="p">,</span> <span class="n">TensorProto</span>
<span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_model</span><span class="p">,</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">set_model_props</span><span class="p">,</span> <span class="n">make_tensor</span><span class="p">,</span>
    <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_tensor_value_info</span><span class="p">,</span> <span class="n">make_opsetid</span><span class="p">,</span>
    <span class="n">make_function</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="n">new_domain</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>
<span class="n">opset_imports</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_opsetid</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">make_opsetid</span><span class="p">(</span><span class="n">new_domain</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

<span class="c1"># Let&#39;s define a function for a linear regression</span>

<span class="n">node1</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">])</span>
<span class="n">node2</span> <span class="o">=</span> <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>

<span class="n">linear_regression</span> <span class="o">=</span> <span class="n">make_function</span><span class="p">(</span>
    <span class="n">new_domain</span><span class="p">,</span>            <span class="c1"># domain name</span>
    <span class="s1">&#39;LinearRegression&#39;</span><span class="p">,</span>     <span class="c1"># function name</span>
    <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span>        <span class="c1"># input names</span>
    <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span>                  <span class="c1"># output names</span>
    <span class="p">[</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">],</span>         <span class="c1"># nodes</span>
    <span class="n">opset_imports</span><span class="p">,</span>          <span class="c1"># opsets</span>
    <span class="p">[])</span>                     <span class="c1"># attribute names</span>

<span class="c1"># Let&#39;s use it in a graph.</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span>
    <span class="p">[</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;LinearRegression&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y1&#39;</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">new_domain</span><span class="p">),</span>
     <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Abs&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Y1&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])],</span>
    <span class="s1">&#39;example&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="p">[</span><span class="n">Y</span><span class="p">])</span>

<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span> <span class="n">opset_imports</span><span class="o">=</span><span class="n">opset_imports</span><span class="p">,</span>
    <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="n">linear_regression</span><span class="p">])</span>  <span class="c1"># functions to add)</span>

<span class="c1"># the work is done, let&#39;s display it...</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    opset: domain=&#39;&#39; version=14
    opset: domain=&#39;custom&#39; version=1
    input: name=&#39;X&#39; type=dtype(&#39;float32&#39;) shape=(0, 0)
    input: name=&#39;A&#39; type=dtype(&#39;float32&#39;) shape=(0, 0)
    input: name=&#39;B&#39; type=dtype(&#39;float32&#39;) shape=(0, 0)
    LinearRegression(X, A, B) -&gt; Y1
      Abs(Y1) -&gt; Y
    output: name=&#39;Y&#39; type=dtype(&#39;float32&#39;) shape=()
    ----- function name=LinearRegression domain=custom
    opset: domain=&#39;&#39; version=14
    opset: domain=&#39;custom&#39; version=1
    input: &#39;X&#39;
    input: &#39;A&#39;
    input: &#39;B&#39;
    MatMul(X, A) -&gt; XA
      Add(XA, B) -&gt; Y
    output: name=&#39;Y&#39; type=? shape=?
</pre></div>
</div>
</section>
<section id="parsing">
<h2><a class="toc-backref" href="#id10">Parsing</a><a class="headerlink" href="#parsing" title="Permalink to this headline">¶</a></h2>
<p>Module <a class="reference external" href="https://github.com/onnx/onnx">onnx</a> provides a faster way to define a graph
a lot easier to read. That’s easy to use when the graph is built
in a single function, less easy when the graph is built from many
different functions converting each piece of a machine learning
pipeline.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx.parser</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>

<span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &lt;</span>
<span class="s1">        ir_version: 8,</span>
<span class="s1">        opset_import: [ &quot;&quot; : 15]</span>
<span class="s1">    &gt;</span>
<span class="s1">    agraph (float[I,J] X, float[] A, float[] B) =&gt; (float[I] Y) {</span>
<span class="s1">        XA = MatMul(X, A)</span>
<span class="s1">        Y = Add(XA, B)</span>
<span class="s1">    }</span>
<span class="s1">    &#39;&#39;&#39;</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XA</span>
      <span class="n">Add</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Y</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
</pre></div>
</div>
<p>This way is used to create small models but it is rarely used
in converting libraries.</p>
</section>
<section id="checker-and-shape-inference">
<h2><a class="toc-backref" href="#id11">Checker and Shape Inference</a><a class="headerlink" href="#checker-and-shape-inference" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/onnx/onnx">onnx</a> provides a function to check the model is valid.
It checks input type or shapes whenever it can detect inconsistency.
The following example multiplies two matrices of different types
which is not allowed.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx.parser</span>
<span class="kn">import</span> <span class="nn">onnx.checker</span>

<span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &lt;</span>
<span class="s1">        ir_version: 8,</span>
<span class="s1">        opset_import: [ &quot;&quot; : 15]</span>
<span class="s1">    &gt;</span>
<span class="s1">    agraph (float[I,4] X, float[4,2] A, int[4] B) =&gt; (float[I] Y) {</span>
<span class="s1">        XA = MatMul(X, A)</span>
<span class="s1">        Y = Add(XA, B)</span>
<span class="s1">    }</span>
<span class="s1">    &#39;&#39;&#39;</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="n">onnx</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">check_model</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    
    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">18</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="n">File</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_python_script_140034456629696</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/onnxcustom/onnxcustom_UT_39_std/_venv/lib/python3.9/site-packages/onnx/parser.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">17</span><span class="p">,</span> <span class="ow">in</span> <span class="n">parse_model</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">onnx</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;[ParseError at position (line: 6 column: 48)]</span><span class="se">\n</span><span class="s1">Error context:         agraph (float[I,4] X, float[4,2] A, int[4] B) =&gt; (float[I] Y) {</span><span class="se">\n</span><span class="s1">Expected character ) not found.&#39;</span>
</pre></div>
</div>
<p><cite>check_model</cite> raises an error due to that inconsistency.
This work for all operators defined in the main domain or the ML domain.
It remains silent for any custom operator not defined in any specification.</p>
<p>Shape inference serves one purpose: estimate the shape
and the type of intermediate results.
If known, the runtime can estimate the memory consumption
beforehand and optimize the computation. It can fuse some
operators, it can do the computation inplace…</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnx.parser</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">helper</span><span class="p">,</span> <span class="n">shape_inference</span>

<span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &lt;</span>
<span class="s1">        ir_version: 8,</span>
<span class="s1">        opset_import: [ &quot;&quot; : 15]</span>
<span class="s1">    &gt;</span>
<span class="s1">    agraph (float[I,4] X, float[4,2] A, float[4] B) =&gt; (float[I] Y) {</span>
<span class="s1">        XA = MatMul(X, A)</span>
<span class="s1">        Y = Add(XA, B)</span>
<span class="s1">    }</span>
<span class="s1">    &#39;&#39;&#39;</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="n">inferred_model</span> <span class="o">=</span> <span class="n">shape_inference</span><span class="o">.</span><span class="n">infer_shapes</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">inferred_model</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">ir_version</span><span class="p">:</span> <span class="mi">8</span>
    <span class="n">graph</span> <span class="p">{</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;MatMul&quot;</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Add&quot;</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="p">}</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;agraph&quot;</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;I&quot;</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">4</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">4</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">2</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">4</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">output</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;I&quot;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">value_info</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;XA&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;I&quot;</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">2</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">opset_import</span> <span class="p">{</span>
      <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="n">version</span><span class="p">:</span> <span class="mi">15</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>There is a new attribute <cite>value_info</cite> which stores the inferred shapes.
Letter <cite>I</cite> in <code class="docutils literal notranslate"><span class="pre">dim_param:</span> <span class="pre">&quot;I&quot;</span></code> can be seen as a variable. It depends on the inputs
but the function is able to tell which intermediate result will share
the same dimension.
Shape inference does not work all the time. For example,
a Reshape operator. Shape inference only works if the shape is constant.
If not constant, the shape cannot be easily inferred unless
the following nodes expect specific shape.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="concepts.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">ONNX Concepts</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="challenges.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Challenges</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>