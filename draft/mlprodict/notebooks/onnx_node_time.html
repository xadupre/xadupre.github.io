
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Time processing for every ONNX nodes in a graph &#8212; Python Runtime for ONNX</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transfer Learning with ONNX" href="transfer_learning.html" />
    <link rel="prev" title="Profiling with onnxruntime" href="onnx_profile_ort.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../all_notebooks_coverage.html">
   Notebooks Coverage
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logisticregression">
   LogisticRegression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#measure-time-spent-in-each-node">
   Measure time spent in each node
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logistic-regression-python-runtime-vs-onnxruntime">
   Logistic regression: python runtime vs onnxruntime
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gaussianprocessregressor">
   GaussianProcessRegressor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#measuring-the-time-with-a-custom-dataset">
   Measuring the time with a custom dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#onnxruntime2-onnxruntime1">
   onnxruntime2 / onnxruntime1
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="time-processing-for-every-onnx-nodes-in-a-graph">
<span id="onnxnodetimerst"></span><h1>Time processing for every ONNX nodes in a graph<a class="headerlink" href="#time-processing-for-every-onnx-nodes-in-a-graph" title="Permalink to this headline">¶</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/3b1c09db214a355b559788b06a86fa5c/onnx_node_time.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="onnx_node_time2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/bce213063cdaf86101a2dbebb22526f3/onnx_node_time.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/6f5d200930ecfe2722ee1b3345c665e6/onnx_node_time.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="onnx_node_time.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/onnx_node_time.ipynb">GitHub</a></p>
<p>The following notebook show how long the runtime spends in each node of
an ONNX graph.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#logisticregression" id="id35">LogisticRegression</a></p></li>
<li><p><a class="reference internal" href="#measure-time-spent-in-each-node" id="id36">Measure time spent in each node</a></p></li>
<li><p><a class="reference internal" href="#logistic-regression-python-runtime-vs-onnxruntime" id="id37">Logistic regression: python runtime vs onnxruntime</a></p></li>
<li><p><a class="reference internal" href="#gaussianprocessregressor" id="id38">GaussianProcessRegressor</a></p></li>
<li><p><a class="reference internal" href="#measuring-the-time-with-a-custom-dataset" id="id39">Measuring the time with a custom dataset</a></p></li>
<li><p><a class="reference internal" href="#onnxruntime2-onnxruntime1" id="id40">onnxruntime2 / onnxruntime1</a></p></li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<section id="logisticregression">
<h2><a class="toc-backref" href="#id35">LogisticRegression</a><a class="headerlink" href="#logisticregression" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="n">iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">clr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
<span class="n">clr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">clr</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;logreg_time.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="c1"># add -l 1 if nothing shows up</span>
<span class="o">%</span><span class="k">onnxview</span> onx
</pre></div>
</div>
<div id="M55f9a2ca1198490ba84a6cd669311f6e-cont"><div id="M55f9a2ca1198490ba84a6cd669311f6e" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  ranksep=0.25;\n  nodesep=0.05;\n\n  X [shape=box color=red label=\"X\nfloat((0, 4))\" fontsize=10];\n\n  output_label [shape=box color=green label=\"output_label\nint64((0,))\" fontsize=10];\n  output_probability [shape=box color=green label=\"output_probability\n[{int64, {'kind': 'tensor', 'elem': 'float', 'shape': }}]\" fontsize=10];\n\n\n  label [shape=box label=\"label\" fontsize=10];\n  probability_tensor [shape=box label=\"probability_tensor\" fontsize=10];\n  LinearClassifier [shape=box style=\"filled,rounded\" color=orange label=\"LinearClassifier\n(LinearClassifier)\nclasslabels_ints=[0 1 2]\ncoefficients=[ 0.34304482  1.39...\nintercepts=[ 0.23314844  0.9524...\nmulti_class=1\npost_transform=b'LOGISTIC'\" fontsize=10];\n  X -> LinearClassifier;\n  LinearClassifier -> label;\n  LinearClassifier -> probability_tensor;\n\n  probabilities [shape=box label=\"probabilities\" fontsize=10];\n  Normalizer [shape=box style=\"filled,rounded\" color=orange label=\"Normalizer\n(Normalizer)\nnorm=b'L1'\" fontsize=10];\n  probability_tensor -> Normalizer;\n  Normalizer -> probabilities;\n\n  Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast)\nto=7\" fontsize=10];\n  label -> Cast;\n  Cast -> output_label;\n\n  ZipMap [shape=box style=\"filled,rounded\" color=orange label=\"ZipMap\n(ZipMap)\nclasslabels_int64s=[0 1 2]\" fontsize=10];\n  probabilities -> ZipMap;\n  ZipMap -> output_probability;\n}");
document.getElementById('M55f9a2ca1198490ba84a6cd669311f6e').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">},</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>i</th>
      <th>name</th>
      <th>op_type</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.199603</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000091</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000016</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})[</span><span class="s1">&#39;output_probability&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">8.38235830e-01</span><span class="p">,</span> <span class="mf">1.21554664e-03</span><span class="p">,</span> <span class="mf">6.97352537e-04</span><span class="p">,</span> <span class="mf">7.93823160e-01</span><span class="p">,</span>
        <span class="mf">9.24825077e-01</span><span class="p">]),</span>
 <span class="mi">1</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.16162989</span><span class="p">,</span> <span class="mf">0.39692812</span><span class="p">,</span> <span class="mf">0.25688601</span><span class="p">,</span> <span class="mf">0.20607722</span><span class="p">,</span> <span class="mf">0.07516498</span><span class="p">]),</span>
 <span class="mi">2</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.34279470e-04</span><span class="p">,</span> <span class="mf">6.01856333e-01</span><span class="p">,</span> <span class="mf">7.42416637e-01</span><span class="p">,</span> <span class="mf">9.96200831e-05</span><span class="p">,</span>
        <span class="mf">9.94208860e-06</span><span class="p">])}</span>
</pre></div>
</div>
</section>
<section id="measure-time-spent-in-each-node">
<h2><a class="toc-backref" href="#id36">Measure time spent in each node</a><a class="headerlink" href="#measure-time-spent-in-each-node" title="Permalink to this headline">¶</a></h2>
<p>With parameter <code class="docutils literal notranslate"><span class="pre">node_time=True</span></code>, method <em>run</em> returns the output and
time measurement.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exe</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">},</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">exe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;LinearClassifier&#39;</span><span class="p">,</span>
  <span class="s1">&#39;op_type&#39;</span><span class="p">:</span> <span class="s1">&#39;LinearClassifier&#39;</span><span class="p">,</span>
  <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mf">0.00015699999999974068</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Normalizer&#39;</span><span class="p">,</span>
  <span class="s1">&#39;op_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Normalizer&#39;</span><span class="p">,</span>
  <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mf">5.43000000003957e-05</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Cast&#39;</span><span class="p">,</span> <span class="s1">&#39;op_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Cast&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mf">1.1699999999947863e-05</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ZipMap&#39;</span><span class="p">,</span>
  <span class="s1">&#39;op_type&#39;</span><span class="p">:</span> <span class="s1">&#39;ZipMap&#39;</span><span class="p">,</span>
  <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mf">1.940000000111297e-05</span><span class="p">}]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">exe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>i</th>
      <th>name</th>
      <th>op_type</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.000157</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000054</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000012</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000019</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="logistic-regression-python-runtime-vs-onnxruntime">
<h2><a class="toc-backref" href="#id37">Logistic regression: python runtime vs onnxruntime</a><a class="headerlink" href="#logistic-regression-python-runtime-vs-onnxruntime" title="Permalink to this headline">¶</a></h2>
<p>Function
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/validate/validate.html?highlight=enumerate_validated_operator_opsets#mlprodict.onnxrt.validate.validate.enumerate_validated_operator_opsets">enumerate_validated_operator_opsets</a>
implements automated tests for every model with artificial data. Option
<code class="docutils literal notranslate"><span class="pre">node_time</span></code> automatically returns the time spent in each node and does
it multiple time.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt.validate</span> <span class="kn">import</span> <span class="n">enumerate_validated_operator_opsets</span>
<span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">enumerate_validated_operator_opsets</span><span class="p">(</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;LogisticRegression&quot;</span><span class="p">},</span> <span class="n">opset_min</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">filter_exp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;b-cl&quot;</span><span class="p">))</span>
</pre></div>
</div>
<pre class="literal-block">C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bench-batch&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>i</th>
      <th>name</th>
      <th>op_type</th>
      <th>time</th>
      <th>N</th>
      <th>max_time</th>
      <th>min_time</th>
      <th>repeat</th>
      <th>number</th>
      <th>step</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.000018</td>
      <td>1</td>
      <td>0.000033</td>
      <td>0.000015</td>
      <td>20</td>
      <td>30</td>
      <td>0-LinearClassifier</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000017</td>
      <td>1</td>
      <td>0.000069</td>
      <td>0.000012</td>
      <td>20</td>
      <td>30</td>
      <td>1-Normalizer</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000004</td>
      <td>1</td>
      <td>0.000009</td>
      <td>0.000003</td>
      <td>20</td>
      <td>30</td>
      <td>2-Cast</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000005</td>
      <td>1</td>
      <td>0.000007</td>
      <td>0.000004</td>
      <td>20</td>
      <td>30</td>
      <td>3-ZipMap</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.000020</td>
      <td>10</td>
      <td>0.000052</td>
      <td>0.000017</td>
      <td>20</td>
      <td>20</td>
      <td>0-LinearClassifier</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000015</td>
      <td>10</td>
      <td>0.000035</td>
      <td>0.000013</td>
      <td>20</td>
      <td>20</td>
      <td>1-Normalizer</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000004</td>
      <td>10</td>
      <td>0.000013</td>
      <td>0.000003</td>
      <td>20</td>
      <td>20</td>
      <td>2-Cast</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000004</td>
      <td>10</td>
      <td>0.000008</td>
      <td>0.000004</td>
      <td>20</td>
      <td>20</td>
      <td>3-ZipMap</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.000024</td>
      <td>100</td>
      <td>0.000036</td>
      <td>0.000019</td>
      <td>10</td>
      <td>8</td>
      <td>0-LinearClassifier</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000018</td>
      <td>100</td>
      <td>0.000023</td>
      <td>0.000015</td>
      <td>10</td>
      <td>8</td>
      <td>1-Normalizer</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000004</td>
      <td>100</td>
      <td>0.000006</td>
      <td>0.000003</td>
      <td>10</td>
      <td>8</td>
      <td>2-Cast</td>
    </tr>
    <tr>
      <th>11</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000007</td>
      <td>100</td>
      <td>0.000005</td>
      <td>0.000004</td>
      <td>10</td>
      <td>8</td>
      <td>3-ZipMap</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.000051</td>
      <td>1000</td>
      <td>0.000057</td>
      <td>0.000047</td>
      <td>5</td>
      <td>5</td>
      <td>0-LinearClassifier</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000041</td>
      <td>1000</td>
      <td>0.000045</td>
      <td>0.000040</td>
      <td>5</td>
      <td>5</td>
      <td>1-Normalizer</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000003</td>
      <td>1000</td>
      <td>0.000004</td>
      <td>0.000003</td>
      <td>5</td>
      <td>5</td>
      <td>2-Cast</td>
    </tr>
    <tr>
      <th>15</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000004</td>
      <td>1000</td>
      <td>0.000004</td>
      <td>0.000004</td>
      <td>5</td>
      <td>5</td>
      <td>3-ZipMap</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.000315</td>
      <td>10000</td>
      <td>0.000328</td>
      <td>0.000315</td>
      <td>3</td>
      <td>3</td>
      <td>0-LinearClassifier</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.000272</td>
      <td>10000</td>
      <td>0.000284</td>
      <td>0.000256</td>
      <td>3</td>
      <td>3</td>
      <td>1-Normalizer</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000004</td>
      <td>10000</td>
      <td>0.000004</td>
      <td>0.000004</td>
      <td>3</td>
      <td>3</td>
      <td>2-Cast</td>
    </tr>
    <tr>
      <th>19</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000004</td>
      <td>10000</td>
      <td>0.000004</td>
      <td>0.000004</td>
      <td>3</td>
      <td>3</td>
      <td>3-ZipMap</td>
    </tr>
    <tr>
      <th>20</th>
      <td>0</td>
      <td>LinearClassifier</td>
      <td>LinearClassifier</td>
      <td>0.005634</td>
      <td>100000</td>
      <td>0.005634</td>
      <td>0.005634</td>
      <td>1</td>
      <td>2</td>
      <td>0-LinearClassifier</td>
    </tr>
    <tr>
      <th>21</th>
      <td>1</td>
      <td>Normalizer</td>
      <td>Normalizer</td>
      <td>0.004671</td>
      <td>100000</td>
      <td>0.004671</td>
      <td>0.004671</td>
      <td>1</td>
      <td>2</td>
      <td>1-Normalizer</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2</td>
      <td>Cast</td>
      <td>Cast</td>
      <td>0.000024</td>
      <td>100000</td>
      <td>0.000024</td>
      <td>0.000024</td>
      <td>1</td>
      <td>2</td>
      <td>2-Cast</td>
    </tr>
    <tr>
      <th>23</th>
      <td>3</td>
      <td>ZipMap</td>
      <td>ZipMap</td>
      <td>0.000013</td>
      <td>100000</td>
      <td>0.000013</td>
      <td>0.000013</td>
      <td>1</td>
      <td>2</td>
      <td>3-ZipMap</td>
    </tr>
  </tbody>
</table>
</div><p>Following tables shows the time spent in each node, it is relative to
the total time. For one observation, the runtime spends 10% of the time
in ZipMap, it is only 1% or 2% with 10 observations. These proportions
change due to the computing cost of each node.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">piv</span> <span class="o">/</span> <span class="n">total</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>1000</th>
      <th>10000</th>
      <th>100000</th>
    </tr>
    <tr>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0-LinearClassifier</th>
      <td>0.410138</td>
      <td>0.459103</td>
      <td>0.450882</td>
      <td>0.512622</td>
      <td>0.530490</td>
      <td>0.544785</td>
    </tr>
    <tr>
      <th>1-Normalizer</th>
      <td>0.390060</td>
      <td>0.353622</td>
      <td>0.350126</td>
      <td>0.414227</td>
      <td>0.456671</td>
      <td>0.451642</td>
    </tr>
    <tr>
      <th>2-Cast</th>
      <td>0.095729</td>
      <td>0.089857</td>
      <td>0.074343</td>
      <td>0.034398</td>
      <td>0.006092</td>
      <td>0.002306</td>
    </tr>
    <tr>
      <th>3-ZipMap</th>
      <td>0.104073</td>
      <td>0.097418</td>
      <td>0.124649</td>
      <td>0.038753</td>
      <td>0.006747</td>
      <td>0.001267</td>
    </tr>
  </tbody>
</table>
</div><p>The python implementation of <em>ZipMap</em> does not change the data but wraps
in into a frozen class
<a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/mlprodict/onnxrt/ops_cpu/op_zipmap.py#L90">ArrayZipMapDitionary</a>
which mocks a list of dictionaries <em>pandas</em> can ingest to create a
DataFrame. The cost is a fixed cost and does not depend on the number of
processed rows.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile</span>
<span class="n">bigX</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">profile</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">bigX</span><span class="p">}),</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<pre class="literal-block">  _     ._   __/__   _ _  _  _ _/_   Recorded: 00:28:08  Samples:  4
 /_//_/// /_/ //_// / //_'/ //     Duration: 0.009     CPU time: 0.031
/   _/                      v3.0.1
Program: c:python372_x64libsite-packagesipykernel_launcher.py -f C:UsersxavieAppDataRoamingjupyterruntimekernel-287476aa-b8ba-4140-902a-b0aad833ffd0.json
0.008 profile  pyquickhelperpycodeprofiling.py:49
<a href="#id1"><span class="problematic" id="id2">`</span></a>- 0.008 &lt;lambda&gt;  &lt;ipython-input-13-ccd42692a7ed&gt;:3
   <a href="#id3"><span class="problematic" id="id4">`</span></a>- 0.008 run  mlprodictonnxrtonnx_inference.py:475
      <a href="#id5"><span class="problematic" id="id6">`</span></a>- 0.008 _run_sequence_runtime  mlprodictonnxrtonnx_inference.py:558
         <a href="#id7"><span class="problematic" id="id8">`</span></a>- 0.008 run  mlprodictonnxrtonnx_inference_node.py:141
            <a href="#id9"><span class="problematic" id="id10">|</span></a>- 0.005 run  mlprodictonnxrtops_cpu_op.py:417
            |  <a href="#id11"><span class="problematic" id="id12">`</span></a>- 0.005 run  mlprodictonnxrtops_cpu_op.py:298
            |     <a href="#id13"><span class="problematic" id="id14">`</span></a>- 0.005 _run  mlprodictonnxrtops_cpuop_linear_classifier.py:40
            |        <a href="#id15"><span class="problematic" id="id16">|</span></a>- 0.003 [self]
            |        <a href="#id17"><span class="problematic" id="id18">`</span></a>- 0.002 argmax  &lt;__array_function__ internals&gt;:2
            |           <a href="#id19"><span class="problematic" id="id20">`</span></a>- 0.002 argmax  numpycorefromnumeric.py:1112
            |                 [3 frames hidden]  numpy
            |                    0.002 _wrapfunc  numpycorefromnumeric.py:55
            <a href="#id21"><span class="problematic" id="id22">`</span></a>- 0.003 run  mlprodictonnxrtops_cpu_op.py:383
               <a href="#id23"><span class="problematic" id="id24">`</span></a>- 0.003 run  mlprodictonnxrtops_cpu_op.py:298
                  <a href="#id25"><span class="problematic" id="id26">`</span></a>- 0.003 _run  mlprodictonnxrtops_cpuop_normalizer.py:66
                     <a href="#id27"><span class="problematic" id="id28">`</span></a>- 0.003 norm_l1  mlprodictonnxrtops_cpuop_normalizer.py:42
                        <a href="#id29"><span class="problematic" id="id30">`</span></a>- 0.003 _norm_L1_inplace  mlprodictonnxrtops_cpuop_normalizer.py:49
                           <a href="#id31"><span class="problematic" id="id32">|</span></a>- 0.002 [self]
                           <a href="#id33"><span class="problematic" id="id34">`</span></a>- 0.002 _sum  numpycore_methods.py:36
                                 [2 frames hidden]  numpy</pre>
<p>The class <em>ArrayZipMapDictionary</em> is fast to build but has an overhead
after that because it builds data when needed.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">bigX</span><span class="p">})</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;output_probability&#39;</span><span class="p">]</span>
<span class="nb">type</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mlprodict</span><span class="o">.</span><span class="n">onnxrt</span><span class="o">.</span><span class="n">ops_cpu</span><span class="o">.</span><span class="n">op_zipmap</span><span class="o">.</span><span class="n">ArrayZipMapDictionary</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> pandas.DataFrame(prob)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>721 ms ± 54.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prob</span><span class="p">]</span>
<span class="o">%</span><span class="k">timeit</span> pandas.DataFrame(list_of_dict)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>108 ms ± 2.01 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
<p>But if you just need to do the following:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> pandas.DataFrame(prob).values
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>713 ms ± 56.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<p>Then, you can just do that:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> prob.values
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[0, 1, 2]
390 ns ± 51.2 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
</pre></div>
</div>
<p>And then:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -n 100 pandas.DataFrame(prob.values, columns=prob.columns)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>215 µs ± 82.6 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
<p>We can then compare to what <em>onnxruntime</em> would do when the runtime is
called indenpently for each node. We use the runtime named
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/onnx_runtime.html?highlight=onnxruntime2#onnxruntime2-independent-onnxruntime-for-every-node">onnxruntime2</a>.
Class <em>OnnxInference</em> splits the ONNX graph into multiple ONNX graphs,
one for each node, and then calls <em>onnxruntime</em> for each of them
indenpently. <em>Python</em> handles the graph logic.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">enumerate_validated_operator_opsets</span><span class="p">(</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;LogisticRegression&quot;</span><span class="p">},</span> <span class="n">opset_min</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime2&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<pre class="literal-block">C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))
C:xavierdupre__home_github_forkscikit-learnsklearnlinear_model_logistic.py:1356: UserWarning: 'n_jobs' &gt; 1 does not have any effect when 'solver' is set to 'liblinear'. Got 'n_jobs' = 4.
  &quot; = {}.&quot;.format(effective_n_jobs(self.n_jobs)))</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res0</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;available-ERROR&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;available-ERROR&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">res0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res0</span> <span class="o">=</span> <span class="n">r</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;ZipMap&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">inferred</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;ZipMap&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">inferred</span><span class="p">)</span>
<span class="mi">4</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;LinearClassifier&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">guessed</span><span class="p">)</span>
<span class="mi">5</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;LinearClassifier&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">guessed</span><span class="p">)</span>
<span class="mi">6</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;LinearClassifier&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">guessed</span><span class="p">)</span>
<span class="mi">7</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;LinearClassifier&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">guessed</span><span class="p">)</span>
<span class="mi">8</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;ZipMap&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">inferred</span><span class="p">)</span>
<span class="mi">9</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">node</span> <span class="s1">&#39;ZipMap&#39;</span> <span class="p">(</span><span class="n">output</span> <span class="nb">type</span> <span class="n">was</span> <span class="n">inferred</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;_6ort_run_batch_exc&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;Something went wrong.&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_6ort_run_batch_exc&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res0</span><span class="p">[</span><span class="s1">&#39;bench-batch&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">piv</span> <span class="o">/</span> <span class="n">total</span>
<span class="n">m</span>
</pre></div>
</div>
<pre class="literal-block">   i              name           op_type      time       N  max_time  0  0  LinearClassifier  LinearClassifier  0.000052       1  0.000190
1  0  LinearClassifier  LinearClassifier  0.000044      10  0.000070
2  0  LinearClassifier  LinearClassifier  0.000071     100  0.000133
3  0  LinearClassifier  LinearClassifier  0.000066    1000  0.000079
4  0  LinearClassifier  LinearClassifier  0.000409   10000  0.000408
5  0  LinearClassifier  LinearClassifier  0.003275  100000  0.003275
   min_time  repeat  number
0  0.000028      20      30
1  0.000031      20      20
2  0.000046      10       8
3  0.000057       5       5
4  0.000365       3       3
5  0.003275       1       2</pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>1000</th>
      <th>10000</th>
      <th>100000</th>
    </tr>
    <tr>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0-LinearClassifier</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div><p><em>onnxruntime</em> creates a new container each time a ZipMap is executed.
That’s whay it takes that much time and the ratio increases when the
number of observations increases.</p>
</section>
<section id="gaussianprocessregressor">
<h2><a class="toc-backref" href="#id38">GaussianProcessRegressor</a><a class="headerlink" href="#gaussianprocessregressor" title="Permalink to this headline">¶</a></h2>
<p>This operator is slow for small batches compare to scikit-learn but
closes the gap as the batch size increases. Let’s see where the time
goes.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx.defs</span> <span class="kn">import</span> <span class="n">onnx_opset_version</span>
<span class="kn">from</span> <span class="nn">mlprodict.tools.asv_options_helper</span> <span class="kn">import</span> <span class="n">get_opset_number_from_onnx</span>
<span class="n">onnx_opset_version</span><span class="p">(),</span> <span class="n">get_opset_number_from_onnx</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">enumerate_validated_operator_opsets</span><span class="p">(</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;GaussianProcessRegressor&quot;</span><span class="p">},</span>
            <span class="n">opset_min</span><span class="o">=</span><span class="n">get_opset_number_from_onnx</span><span class="p">(),</span>
            <span class="n">opset_max</span><span class="o">=</span><span class="n">get_opset_number_from_onnx</span><span class="p">(),</span>
            <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">filter_exp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;b-reg&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">enumerate_validated_operator_opsets</span><span class="p">]</span> <span class="n">opset</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GaussianProcessRegressor    :   0%|          | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">enumerate_compatible_opset</span><span class="p">]</span> <span class="n">opset</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GaussianProcessRegressor    : 100%|██████████| 1/1 [00:05&lt;00:00,  5.66s/it]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res0</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;available-ERROR&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;available-ERROR&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">res0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res0</span> <span class="o">=</span> <span class="n">r</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res0</span><span class="p">[</span><span class="s1">&#39;bench-batch&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:02d}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>i</th>
      <th>name</th>
      <th>op_type</th>
      <th>time</th>
      <th>N</th>
      <th>max_time</th>
      <th>min_time</th>
      <th>repeat</th>
      <th>number</th>
      <th>step</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>kgpd_CDist</td>
      <td>CDist</td>
      <td>0.000033</td>
      <td>1</td>
      <td>0.000045</td>
      <td>0.000027</td>
      <td>20</td>
      <td>30</td>
      <td>00-kgpd_CDist</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>kgpd_Div</td>
      <td>Div</td>
      <td>0.000009</td>
      <td>1</td>
      <td>0.000016</td>
      <td>0.000007</td>
      <td>20</td>
      <td>30</td>
      <td>01-kgpd_Div</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>kgpd_Mul</td>
      <td>Mul</td>
      <td>0.000006</td>
      <td>1</td>
      <td>0.000007</td>
      <td>0.000005</td>
      <td>20</td>
      <td>30</td>
      <td>02-kgpd_Mul</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>kgpd_Sin</td>
      <td>Sin</td>
      <td>0.000007</td>
      <td>1</td>
      <td>0.000009</td>
      <td>0.000006</td>
      <td>20</td>
      <td>30</td>
      <td>03-kgpd_Sin</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>kgpd_Div1</td>
      <td>Div</td>
      <td>0.000007</td>
      <td>1</td>
      <td>0.000008</td>
      <td>0.000005</td>
      <td>20</td>
      <td>30</td>
      <td>04-kgpd_Div1</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pivpy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">pivpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pivpy</span> <span class="o">/</span> <span class="n">total</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>1000</th>
      <th>10000</th>
      <th>100000</th>
    </tr>
    <tr>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>00-kgpd_CDist</th>
      <td>0.311496</td>
      <td>0.300665</td>
      <td>0.244035</td>
      <td>0.227984</td>
      <td>0.264447</td>
      <td>0.288546</td>
    </tr>
    <tr>
      <th>01-kgpd_Div</th>
      <td>0.082535</td>
      <td>0.067193</td>
      <td>0.028348</td>
      <td>0.011667</td>
      <td>0.012230</td>
      <td>0.015447</td>
    </tr>
    <tr>
      <th>02-kgpd_Mul</th>
      <td>0.059840</td>
      <td>0.050664</td>
      <td>0.018670</td>
      <td>0.006959</td>
      <td>0.010950</td>
      <td>0.012468</td>
    </tr>
    <tr>
      <th>03-kgpd_Sin</th>
      <td>0.067037</td>
      <td>0.086529</td>
      <td>0.106165</td>
      <td>0.113068</td>
      <td>0.102102</td>
      <td>0.107563</td>
    </tr>
    <tr>
      <th>04-kgpd_Div1</th>
      <td>0.061852</td>
      <td>0.053088</td>
      <td>0.025749</td>
      <td>0.010935</td>
      <td>0.009810</td>
      <td>0.009875</td>
    </tr>
    <tr>
      <th>05-kgpd_Pow</th>
      <td>0.072520</td>
      <td>0.166539</td>
      <td>0.361318</td>
      <td>0.438253</td>
      <td>0.418169</td>
      <td>0.404182</td>
    </tr>
    <tr>
      <th>06-kgpd_Mul1</th>
      <td>0.057508</td>
      <td>0.050477</td>
      <td>0.020386</td>
      <td>0.010334</td>
      <td>0.009079</td>
      <td>0.010466</td>
    </tr>
    <tr>
      <th>07-kgpd_Exp</th>
      <td>0.067885</td>
      <td>0.098850</td>
      <td>0.150876</td>
      <td>0.168079</td>
      <td>0.165177</td>
      <td>0.145106</td>
    </tr>
    <tr>
      <th>08-gpr_MatMul</th>
      <td>0.137546</td>
      <td>0.064570</td>
      <td>0.025069</td>
      <td>0.009029</td>
      <td>0.007134</td>
      <td>0.006159</td>
    </tr>
    <tr>
      <th>09-gpr_Add</th>
      <td>0.081782</td>
      <td>0.061424</td>
      <td>0.019383</td>
      <td>0.003692</td>
      <td>0.000903</td>
      <td>0.000190</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">pivpy</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Time spent in each node relatively to the total time</span><span class="se">\n</span><span class="s2">python runtime&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_node_time_40_0.png" src="../_images/onnx_node_time_40_0.png" />
<p>The operator <em>Scan</em> is clearly time consuming when the batch size is
small. <em>onnxruntime</em> is more efficient for this one.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">enumerate_validated_operator_opsets</span><span class="p">(</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;GaussianProcessRegressor&quot;</span><span class="p">},</span>
            <span class="n">opset_min</span><span class="o">=</span><span class="n">get_opset_number_from_onnx</span><span class="p">(),</span>
            <span class="n">opset_max</span><span class="o">=</span><span class="n">get_opset_number_from_onnx</span><span class="p">(),</span>
            <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime2&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">filter_exp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;b-reg&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">enumerate_validated_operator_opsets</span><span class="p">]</span> <span class="n">opset</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GaussianProcessRegressor    :   0%|          | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">enumerate_compatible_opset</span><span class="p">]</span> <span class="n">opset</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GaussianProcessRegressor    : 100%|██████████| 1/1 [00:06&lt;00:00,  6.84s/it]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bench-batch&#39;</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No model available.&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:02d}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pivort</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">pivort</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pivort</span> <span class="o">/</span> <span class="n">total</span>
<span class="n">r</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>1000</th>
      <th>10000</th>
      <th>100000</th>
    </tr>
    <tr>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>00-kgpd_CDist</th>
      <td>0.114001</td>
      <td>0.120884</td>
      <td>0.128845</td>
      <td>0.148042</td>
      <td>0.156776</td>
      <td>0.180377</td>
    </tr>
    <tr>
      <th>01-kgpd_Div</th>
      <td>0.101792</td>
      <td>0.098622</td>
      <td>0.085983</td>
      <td>0.085108</td>
      <td>0.086603</td>
      <td>0.084520</td>
    </tr>
    <tr>
      <th>02-kgpd_Mul</th>
      <td>0.099980</td>
      <td>0.097547</td>
      <td>0.084001</td>
      <td>0.064706</td>
      <td>0.072849</td>
      <td>0.081023</td>
    </tr>
    <tr>
      <th>03-kgpd_Sin</th>
      <td>0.089632</td>
      <td>0.103505</td>
      <td>0.194194</td>
      <td>0.301002</td>
      <td>0.245769</td>
      <td>0.260717</td>
    </tr>
    <tr>
      <th>04-kgpd_Div1</th>
      <td>0.099119</td>
      <td>0.096737</td>
      <td>0.088709</td>
      <td>0.063237</td>
      <td>0.095840</td>
      <td>0.091635</td>
    </tr>
    <tr>
      <th>05-kgpd_Pow</th>
      <td>0.108045</td>
      <td>0.098307</td>
      <td>0.081161</td>
      <td>0.064898</td>
      <td>0.079015</td>
      <td>0.076962</td>
    </tr>
    <tr>
      <th>06-kgpd_Mul1</th>
      <td>0.098561</td>
      <td>0.098475</td>
      <td>0.082770</td>
      <td>0.063557</td>
      <td>0.087732</td>
      <td>0.076762</td>
    </tr>
    <tr>
      <th>07-kgpd_Exp</th>
      <td>0.090019</td>
      <td>0.087015</td>
      <td>0.086282</td>
      <td>0.088542</td>
      <td>0.103798</td>
      <td>0.087690</td>
    </tr>
    <tr>
      <th>08-gpr_MatMul</th>
      <td>0.100426</td>
      <td>0.102766</td>
      <td>0.106220</td>
      <td>0.102751</td>
      <td>0.069157</td>
      <td>0.059617</td>
    </tr>
    <tr>
      <th>09-gpr_Add</th>
      <td>0.098425</td>
      <td>0.096143</td>
      <td>0.061836</td>
      <td>0.018155</td>
      <td>0.002462</td>
      <td>0.000696</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">pivort</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Time spent in each node relatively to the total time</span><span class="se">\n</span><span class="s2">onnxtunime&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_node_time_44_0.png" src="../_images/onnx_node_time_44_0.png" />
<p>The results are relative. Let’s see which runtime is best node by node.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">pivort</span> <span class="o">-</span> <span class="n">pivpy</span><span class="p">)</span> <span class="o">/</span> <span class="n">pivpy</span>
<span class="n">r</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>1000</th>
      <th>10000</th>
      <th>100000</th>
    </tr>
    <tr>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>00-kgpd_CDist</th>
      <td>-0.239113</td>
      <td>-0.367743</td>
      <td>-0.630420</td>
      <td>-0.703226</td>
      <td>-0.677041</td>
      <td>-0.631775</td>
    </tr>
    <tr>
      <th>01-kgpd_Div</th>
      <td>1.564119</td>
      <td>1.308106</td>
      <td>1.123155</td>
      <td>2.333824</td>
      <td>2.857590</td>
      <td>2.223117</td>
    </tr>
    <tr>
      <th>02-kgpd_Mul</th>
      <td>2.473648</td>
      <td>2.027773</td>
      <td>2.149388</td>
      <td>3.249448</td>
      <td>2.624165</td>
      <td>2.828025</td>
    </tr>
    <tr>
      <th>03-kgpd_Sin</th>
      <td>1.779780</td>
      <td>0.881090</td>
      <td>0.280401</td>
      <td>0.216680</td>
      <td>0.311288</td>
      <td>0.427768</td>
    </tr>
    <tr>
      <th>04-kgpd_Div1</th>
      <td>2.331710</td>
      <td>1.865534</td>
      <td>1.411570</td>
      <td>1.642922</td>
      <td>4.321977</td>
      <td>4.466249</td>
    </tr>
    <tr>
      <th>05-kgpd_Pow</th>
      <td>2.097502</td>
      <td>-0.071724</td>
      <td>-0.842765</td>
      <td>-0.932321</td>
      <td>-0.897065</td>
      <td>-0.887837</td>
    </tr>
    <tr>
      <th>06-kgpd_Mul1</th>
      <td>2.563218</td>
      <td>2.067909</td>
      <td>1.842112</td>
      <td>1.811019</td>
      <td>4.263897</td>
      <td>3.320524</td>
    </tr>
    <tr>
      <th>07-kgpd_Exp</th>
      <td>1.756911</td>
      <td>0.384288</td>
      <td>-0.599693</td>
      <td>-0.759241</td>
      <td>-0.657668</td>
      <td>-0.644029</td>
    </tr>
    <tr>
      <th>08-gpr_MatMul</th>
      <td>0.517953</td>
      <td>1.502798</td>
      <td>1.965953</td>
      <td>4.201281</td>
      <td>4.281286</td>
      <td>4.701255</td>
    </tr>
    <tr>
      <th>09-gpr_Add</th>
      <td>1.502111</td>
      <td>1.461452</td>
      <td>1.233097</td>
      <td>1.247736</td>
      <td>0.486358</td>
      <td>1.160395</td>
    </tr>
  </tbody>
</table>
</div><p>Based on this, <em>onnxruntime</em> is faster for operators <em>Scan</em>, <em>Pow</em>,
<em>Exp</em> and slower for all the others.</p>
</section>
<section id="measuring-the-time-with-a-custom-dataset">
<h2><a class="toc-backref" href="#id39">Measuring the time with a custom dataset</a><a class="headerlink" href="#measuring-the-time-with-a-custom-dataset" title="Permalink to this headline">¶</a></h2>
<p>We use the example <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/gaussian_process/plot_compare_gpr_krr.html#sphx-glr-auto-examples-gaussian-process-plot-compare-gpr-krr-py">Comparison of kernel ridge and Gaussian process
regression</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.kernel_ridge</span> <span class="kn">import</span> <span class="n">KernelRidge</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ExpSineSquared</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Generate sample data</span>
<span class="n">X</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">y</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># add noise</span>

<span class="n">gp_kernel</span> <span class="o">=</span> <span class="n">ExpSineSquared</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">periodicity_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e1</span><span class="p">))</span>
<span class="n">gpr</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">gp_kernel</span><span class="p">)</span>
<span class="n">gpr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">C:xavierdupre__home_github_forkscikit-learnsklearngaussian_processkernels.py:409: ConvergenceWarning: The optimal value found for dimension 0 of parameter length_scale is close to the specified lower bound 1e-05. Decreasing the bound and calling fit again may find a better value.
  ConvergenceWarning)
C:xavierdupre__home_github_forkscikit-learnsklearngaussian_processkernels.py:418: ConvergenceWarning: The optimal value found for dimension 0 of parameter periodicity is close to the specified upper bound 10.0. Increasing the bound and calling fit again may find a better value.
  ConvergenceWarning)</pre>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">ExpSineSquared</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">periodicity</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gpr_time.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="o">%</span><span class="k">onnxview</span> onx -r 1
</pre></div>
</div>
<div id="M2b506ed3425a4240a66f7e1bb82a958c-cont"><div id="M2b506ed3425a4240a66f7e1bb82a958c" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  ranksep=0.25;\n  nodesep=0.05;\n\n  X [shape=box color=red label=\"X\ndouble((0, 4))\" fontsize=10];\n\n  GPmean [shape=box color=green label=\"GPmean\ndouble((0, 1))\" fontsize=10];\n\n  Sc_Scancst [shape=box label=\"Sc_Scancst\nfloat64((100, 1))\n[[ 8.23220256]\n [10.7278405 ]\n [ 9.04145064]\n [ 8....\" fontsize=10];\n  kgpd_Divcst [shape=box label=\"kgpd_Divcst\nfloat64((1,))\n[10.]\" fontsize=10];\n  kgpd_Mulcst [shape=box label=\"kgpd_Mulcst\nfloat64((1,))\n[3.14159265]\" fontsize=10];\n  kgpd_Divcst1 [shape=box label=\"kgpd_Divcst1\nfloat64((1,))\n[1.e-05]\" fontsize=10];\n  kgpd_Powcst [shape=box label=\"kgpd_Powcst\nfloat64((1,))\n[2.]\" fontsize=10];\n  kgpd_Mulcst1 [shape=box label=\"kgpd_Mulcst1\nfloat64((1,))\n[-2.]\" fontsize=10];\n  gpr_MatMulcst [shape=box label=\"gpr_MatMulcst\nfloat64((100,))\n[ 3.95873450e-01 -2.74396810e-01 -3.31573692e-01 -...\" fontsize=10];\n  gpr_Addcst [shape=box label=\"gpr_Addcst\nfloat64((1, 1))\n[[0.]]\" fontsize=10];\n\n  scan0 [shape=box label=\"scan0\" fontsize=10];\n  scan1 [shape=box label=\"scan1\" fontsize=10];\n  subgraph cluster_Scan2468478552544 {\n    label=\"Scan\n(Sc_Scan)\nbody=node {\n  input: 'next_in'...\nnum_scan_inputs=1\";\n    fontsize=10;\n    color=black;\n    B_next_in [shape=box color=red label=\"next_in\ndouble(('?',))\" fontsize=10];\n    B_next [shape=box color=red label=\"next\ndouble(('?',))\" fontsize=10];\n  \n    B_next_out [shape=box color=green label=\"next_out\ndouble(('?',))\" fontsize=10];\n    B_scan_out [shape=box color=green label=\"scan_out\ndouble(('?',))\" fontsize=10];\n  \n  \n    B_cdistd_Identity [shape=box style=\"filled,rounded\" color=orange label=\"Identity\n(cdistd_Identity)\" fontsize=10];\n    B_next_in -> B_cdistd_Identity;\n    B_cdistd_Identity -> B_next_out;\n  \n    B_diff [shape=box label=\"diff\" fontsize=10];\n    B_Su_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub)\" fontsize=10];\n    B_next_in -> B_Su_Sub;\n    B_next -> B_Su_Sub;\n    B_Su_Sub -> B_diff;\n  \n    B_Re_ReduceSumSquare [shape=box style=\"filled,rounded\" color=orange label=\"ReduceSumSquare\n(Re_ReduceSumSquare)\naxes=[1]\nkeepdims=0\" fontsize=10];\n    B_diff -> B_Re_ReduceSumSquare;\n    B_Re_ReduceSumSquare -> B_scan_out;\n  }\n  X -> B_next_in;\n  Sc_Scancst -> B_next;\n  B_next_out -> scan0;\n  B_scan_out -> scan1;\n\n  kgpd_transposed0 [shape=box label=\"kgpd_transposed0\" fontsize=10];\n  kgpd_Transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(kgpd_Transpose)\nperm=[1 0]\" fontsize=10];\n  scan1 -> kgpd_Transpose;\n  kgpd_Transpose -> kgpd_transposed0;\n\n  kgpd_Y0 [shape=box label=\"kgpd_Y0\" fontsize=10];\n  kgpd_Sqrt [shape=box style=\"filled,rounded\" color=orange label=\"Sqrt\n(kgpd_Sqrt)\" fontsize=10];\n  kgpd_transposed0 -> kgpd_Sqrt;\n  kgpd_Sqrt -> kgpd_Y0;\n\n  kgpd_C03 [shape=box label=\"kgpd_C03\" fontsize=10];\n  kgpd_Div [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(kgpd_Div)\" fontsize=10];\n  kgpd_Y0 -> kgpd_Div;\n  kgpd_Divcst -> kgpd_Div;\n  kgpd_Div -> kgpd_C03;\n\n  kgpd_C02 [shape=box label=\"kgpd_C02\" fontsize=10];\n  kgpd_Mul [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(kgpd_Mul)\" fontsize=10];\n  kgpd_C03 -> kgpd_Mul;\n  kgpd_Mulcst -> kgpd_Mul;\n  kgpd_Mul -> kgpd_C02;\n\n  kgpd_output02 [shape=box label=\"kgpd_output02\" fontsize=10];\n  kgpd_Sin [shape=box style=\"filled,rounded\" color=orange label=\"Sin\n(kgpd_Sin)\" fontsize=10];\n  kgpd_C02 -> kgpd_Sin;\n  kgpd_Sin -> kgpd_output02;\n\n  kgpd_C01 [shape=box label=\"kgpd_C01\" fontsize=10];\n  kgpd_Div1 [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(kgpd_Div1)\" fontsize=10];\n  kgpd_output02 -> kgpd_Div1;\n  kgpd_Divcst1 -> kgpd_Div1;\n  kgpd_Div1 -> kgpd_C01;\n\n  kgpd_Z0 [shape=box label=\"kgpd_Z0\" fontsize=10];\n  kgpd_Pow [shape=box style=\"filled,rounded\" color=orange label=\"Pow\n(kgpd_Pow)\" fontsize=10];\n  kgpd_C01 -> kgpd_Pow;\n  kgpd_Powcst -> kgpd_Pow;\n  kgpd_Pow -> kgpd_Z0;\n\n  kgpd_C0 [shape=box label=\"kgpd_C0\" fontsize=10];\n  kgpd_Mul1 [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(kgpd_Mul1)\" fontsize=10];\n  kgpd_Z0 -> kgpd_Mul1;\n  kgpd_Mulcst1 -> kgpd_Mul1;\n  kgpd_Mul1 -> kgpd_C0;\n\n  kgpd_output01 [shape=box label=\"kgpd_output01\" fontsize=10];\n  kgpd_Exp [shape=box style=\"filled,rounded\" color=orange label=\"Exp\n(kgpd_Exp)\" fontsize=10];\n  kgpd_C0 -> kgpd_Exp;\n  kgpd_Exp -> kgpd_output01;\n\n  gpr_Y0 [shape=box label=\"gpr_Y0\" fontsize=10];\n  gpr_MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(gpr_MatMul)\" fontsize=10];\n  kgpd_output01 -> gpr_MatMul;\n  gpr_MatMulcst -> gpr_MatMul;\n  gpr_MatMul -> gpr_Y0;\n\n  gpr_Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(gpr_Add)\" fontsize=10];\n  gpr_Y0 -> gpr_Add;\n  gpr_Addcst -> gpr_Add;\n  gpr_Add -> GPmean;\n}");
document.getElementById('M2b506ed3425a4240a66f7e1bb82a958c').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.tools</span> <span class="kn">import</span> <span class="n">get_ir_version_from_onnx</span>
<span class="n">onx</span><span class="o">.</span><span class="n">ir_version</span> <span class="o">=</span> <span class="n">get_ir_version_from_onnx</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinfpy</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
<span class="n">oinfort</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;onnxruntime2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">runtime==onnxruntime2</span></code> tells the class <code class="docutils literal notranslate"><span class="pre">OnnxInference</span></code> to use
<em>onnxruntime</em> for every node independently, there are as many calls as
there are nodes in the graph.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">respy</span> <span class="o">=</span> <span class="n">oinfpy</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">},</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resort</span> <span class="o">=</span> <span class="n">oinfort</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">},</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">resort</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">resort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">respy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">resort</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;op_type&quot;</span><span class="p">],</span>
                                        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_py&quot;</span><span class="p">,</span> <span class="s2">&quot;_ort&quot;</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time_ort</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">time_py</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>i</th>
      <th>name</th>
      <th>op_type</th>
      <th>time_py</th>
      <th>time_ort</th>
      <th>delta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Sc_Scan</td>
      <td>Scan</td>
      <td>0.007998</td>
      <td>0.005970</td>
      <td>-0.002028</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>kgpd_Transpose</td>
      <td>Transpose</td>
      <td>0.000032</td>
      <td>0.000599</td>
      <td>0.000567</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>kgpd_Sqrt</td>
      <td>Sqrt</td>
      <td>0.000063</td>
      <td>0.000112</td>
      <td>0.000049</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>kgpd_Div</td>
      <td>Div</td>
      <td>0.000143</td>
      <td>0.000097</td>
      <td>-0.000045</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>kgpd_Mul</td>
      <td>Mul</td>
      <td>0.000038</td>
      <td>0.000321</td>
      <td>0.000283</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5</td>
      <td>kgpd_Sin</td>
      <td>Sin</td>
      <td>0.000095</td>
      <td>0.000146</td>
      <td>0.000051</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6</td>
      <td>kgpd_Div1</td>
      <td>Div</td>
      <td>0.000027</td>
      <td>0.000096</td>
      <td>0.000069</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7</td>
      <td>kgpd_Pow</td>
      <td>Pow</td>
      <td>0.000299</td>
      <td>0.000104</td>
      <td>-0.000196</td>
    </tr>
    <tr>
      <th>8</th>
      <td>8</td>
      <td>kgpd_Mul1</td>
      <td>Mul</td>
      <td>0.000032</td>
      <td>0.000097</td>
      <td>0.000065</td>
    </tr>
    <tr>
      <th>9</th>
      <td>9</td>
      <td>kgpd_Exp</td>
      <td>Exp</td>
      <td>0.000383</td>
      <td>0.000111</td>
      <td>-0.000271</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10</td>
      <td>gpr_MatMul</td>
      <td>MatMul</td>
      <td>0.000080</td>
      <td>0.004359</td>
      <td>0.004279</td>
    </tr>
    <tr>
      <th>11</th>
      <td>11</td>
      <td>gpr_Add</td>
      <td>Add</td>
      <td>0.000034</td>
      <td>0.000165</td>
      <td>0.000131</td>
    </tr>
  </tbody>
</table>
</div><p>The following function runs multiple the same inference and aggregates
the results node by node.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt.validate.validate</span> <span class="kn">import</span> <span class="n">benchmark_fct</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">benchmark_fct</span><span class="p">(</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">oinfpy</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">},</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">X_test</span><span class="p">,</span> <span class="n">node_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>i</th>
      <th>name</th>
      <th>op_type</th>
      <th>time</th>
      <th>N</th>
      <th>max_time</th>
      <th>min_time</th>
      <th>repeat</th>
      <th>number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>24</th>
      <td>0</td>
      <td>Sc_Scan</td>
      <td>Scan</td>
      <td>0.004154</td>
      <td>100</td>
      <td>0.004330</td>
      <td>0.003843</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>25</th>
      <td>1</td>
      <td>kgpd_Transpose</td>
      <td>Transpose</td>
      <td>0.000013</td>
      <td>100</td>
      <td>0.000019</td>
      <td>0.000010</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2</td>
      <td>kgpd_Sqrt</td>
      <td>Sqrt</td>
      <td>0.000018</td>
      <td>100</td>
      <td>0.000022</td>
      <td>0.000015</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>27</th>
      <td>3</td>
      <td>kgpd_Div</td>
      <td>Div</td>
      <td>0.000025</td>
      <td>100</td>
      <td>0.000092</td>
      <td>0.000015</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>28</th>
      <td>4</td>
      <td>kgpd_Mul</td>
      <td>Mul</td>
      <td>0.000012</td>
      <td>100</td>
      <td>0.000019</td>
      <td>0.000009</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>29</th>
      <td>5</td>
      <td>kgpd_Sin</td>
      <td>Sin</td>
      <td>0.000057</td>
      <td>100</td>
      <td>0.000070</td>
      <td>0.000050</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>30</th>
      <td>6</td>
      <td>kgpd_Div1</td>
      <td>Div</td>
      <td>0.000014</td>
      <td>100</td>
      <td>0.000017</td>
      <td>0.000011</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>31</th>
      <td>7</td>
      <td>kgpd_Pow</td>
      <td>Pow</td>
      <td>0.000172</td>
      <td>100</td>
      <td>0.000198</td>
      <td>0.000155</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>32</th>
      <td>8</td>
      <td>kgpd_Mul1</td>
      <td>Mul</td>
      <td>0.000020</td>
      <td>100</td>
      <td>0.000101</td>
      <td>0.000009</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>33</th>
      <td>9</td>
      <td>kgpd_Exp</td>
      <td>Exp</td>
      <td>0.000213</td>
      <td>100</td>
      <td>0.000249</td>
      <td>0.000193</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>34</th>
      <td>10</td>
      <td>gpr_MatMul</td>
      <td>MatMul</td>
      <td>0.000034</td>
      <td>100</td>
      <td>0.000047</td>
      <td>0.000026</td>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>35</th>
      <td>11</td>
      <td>gpr_Add</td>
      <td>Add</td>
      <td>0.000013</td>
      <td>100</td>
      <td>0.000019</td>
      <td>0.000011</td>
      <td>10</td>
      <td>8</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df100</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">df100</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">op_type</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">df100</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df100</span><span class="p">[[</span><span class="s2">&quot;min_time&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">df100</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
            <span class="n">uplims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lolims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Time spent in each node for 100 observations</span><span class="se">\n</span><span class="s2">GaussianProcess&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_node_time_61_0.png" src="../_images/onnx_node_time_61_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df100c</span> <span class="o">=</span> <span class="n">df100</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">df100c</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
<span class="c1">#ax.set_yscale(&#39;log&#39;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">df100c</span><span class="o">.</span><span class="n">min_time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df100c</span><span class="o">.</span><span class="n">max_time</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">op_type</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">df100</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">df100c</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">df100c</span><span class="p">[[</span><span class="s2">&quot;min_time&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">df100c</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())),</span>
            <span class="n">uplims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lolims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cumulated time spent in each node for 100 observations</span><span class="se">\n</span><span class="s2">GaussianProcess&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_node_time_63_0.png" src="../_images/onnx_node_time_63_0.png" />
</section>
<section id="onnxruntime2-onnxruntime1">
<h2><a class="toc-backref" href="#id40">onnxruntime2 / onnxruntime1</a><a class="headerlink" href="#onnxruntime2-onnxruntime1" title="Permalink to this headline">¶</a></h2>
<p>The runtime <code class="docutils literal notranslate"><span class="pre">onnxruntime1</span></code> uses <em>onnxruntime</em> for the whole ONNX
graph. There is no way to get the computation time for each node except
if we create a ONNX graph for each intermediate node.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinfort1</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">split</span> <span class="o">=</span> <span class="n">oinfort1</span><span class="o">.</span><span class="n">build_intermediate</span><span class="p">()</span>
<span class="n">split</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;scan0&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;scan1&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_transposed0&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_Y0&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_C03&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_C02&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_output02&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_C01&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_Z0&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_C0&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;kgpd_output01&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;gpr_Y0&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)),</span>
             <span class="p">(</span><span class="s1">&#39;GPmean&#39;</span><span class="p">,</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">))])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">split</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">benchmark_fct</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">}),</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="n">scan0</span>
<span class="n">node</span> <span class="n">scan1</span>
<span class="n">node</span> <span class="n">kgpd_transposed0</span>
<span class="n">node</span> <span class="n">kgpd_Y0</span>
<span class="n">node</span> <span class="n">kgpd_C03</span>
<span class="n">node</span> <span class="n">kgpd_C02</span>
<span class="n">node</span> <span class="n">kgpd_output02</span>
<span class="n">node</span> <span class="n">kgpd_C01</span>
<span class="n">node</span> <span class="n">kgpd_Z0</span>
<span class="n">node</span> <span class="n">kgpd_C0</span>
<span class="n">node</span> <span class="n">kgpd_output01</span>
<span class="n">node</span> <span class="n">gpr_Y0</span>
<span class="n">node</span> <span class="n">GPmean</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>1</th>
      <th>10</th>
      <th>100</th>
      <th>1000</th>
      <th>10000</th>
      <th>100000</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>average</td>
      <td>0.000623</td>
      <td>0.000592</td>
      <td>0.000754</td>
      <td>0.002202</td>
      <td>0.017529</td>
      <td>0.201192</td>
      <td>scan0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>deviation</td>
      <td>0.000115</td>
      <td>0.000030</td>
      <td>0.000034</td>
      <td>0.000026</td>
      <td>0.000976</td>
      <td>0.000000</td>
      <td>scan0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>min_exec</td>
      <td>0.000541</td>
      <td>0.000537</td>
      <td>0.000657</td>
      <td>0.002169</td>
      <td>0.016677</td>
      <td>0.201192</td>
      <td>scan0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>max_exec</td>
      <td>0.000980</td>
      <td>0.000639</td>
      <td>0.000780</td>
      <td>0.002239</td>
      <td>0.018896</td>
      <td>0.201192</td>
      <td>scan0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>repeat</td>
      <td>20.000000</td>
      <td>20.000000</td>
      <td>10.000000</td>
      <td>5.000000</td>
      <td>3.000000</td>
      <td>1.000000</td>
      <td>scan0</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df100c</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">]</span>
<span class="n">df100c_min</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;min_exec&quot;</span><span class="p">]</span>
<span class="n">df100c_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;max_exec&quot;</span><span class="p">]</span>
<span class="n">ave</span> <span class="o">=</span> <span class="n">df100c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">ave_min</span> <span class="o">=</span> <span class="n">df100c_min</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">ave_max</span> <span class="o">=</span> <span class="n">df100c_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">ave</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ave_min</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ave_max</span><span class="o">.</span><span class="n">shape</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ave</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ave</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df100c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
    <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ave</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ave_min</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ave_max</span><span class="o">.</span><span class="n">values</span><span class="p">])</span> <span class="o">-</span> <span class="n">ave</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())),</span>
            <span class="n">uplims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lolims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cumulated time spent in each node for 100 &quot;</span>
             <span class="s2">&quot;observations</span><span class="se">\n</span><span class="s2">GaussianProcess and onnxruntime1&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_node_time_70_0.png" src="../_images/onnx_node_time_70_0.png" />
<p>The visual graph helps matching the output names with the operator type.
The curve is not monotononic because each experiment computes every
output from the start. The number of repetitions should be increased.
Documentation of function
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/validate/validate.html?highlight=benchmark_fct#mlprodict.onnxrt.validate.validate.benchmark_fct">benchmark_fct</a>
tells how to do it.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="onnx_profile_ort.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Profiling with onnxruntime</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="transfer_learning.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Transfer Learning with ONNX</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>