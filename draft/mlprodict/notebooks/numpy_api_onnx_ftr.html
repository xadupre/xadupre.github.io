
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Introduction to a numpy API for ONNX: FunctionTransformer &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lightgbm, double, discrepencies" href="lightgbm_double.html" />
    <link rel="prev" title="Introduction to a numpy API for ONNX: CustomClassifier" href="numpy_api_onnx_ccl.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_ffts.html">
   ONNX FFTs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-pipeline-with-functiontransformer">
   A pipeline with FunctionTransformer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-onnx-instead-of-numpy">
   Use ONNX instead of numpy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#slightly-more-complex-functions-with-a-functiontransformer">
   Slightly more complex functions with a FunctionTransformer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#function-transformer-with-fft">
   Function transformer with FFT
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-implementation">
     numpy implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#onnx-implementation">
     ONNX implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-onnxruntime">
     Using onnxruntime
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inside-a-functiontransformer">
     Inside a FunctionTransformer
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="introduction-to-a-numpy-api-for-onnx-functiontransformer">
<span id="numpyapionnxftrrst"></span><h1>Introduction to a numpy API for ONNX: FunctionTransformer<a class="headerlink" href="#introduction-to-a-numpy-api-for-onnx-functiontransformer" title="Permalink to this headline">#</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/cc4c88a3f7d6bd9e9d9a564257ffdeda/numpy_api_onnx_ftr.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="numpy_api_onnx_ftr2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/2d5baf119f1cf885ddf961acea2312fa/numpy_api_onnx_ftr.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/4b033e2b9baece76f453559091e9b7a9/numpy_api_onnx_ftr.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="numpy_api_onnx_ftr.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/numpy_api_onnx_ftr.ipynb">GitHub</a></p>
<p>This notebook shows how to write python functions similar functions as
numpy offers and get a function which can be converted into ONNX.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#a-pipeline-with-functiontransformer" id="id1">A pipeline with FunctionTransformer</a></p></li>
<li><p><a class="reference internal" href="#use-onnx-instead-of-numpy" id="id2">Use ONNX instead of numpy</a></p></li>
<li><p><a class="reference internal" href="#slightly-more-complex-functions-with-a-functiontransformer" id="id3">Slightly more complex functions with a FunctionTransformer</a></p></li>
<li><p><a class="reference internal" href="#function-transformer-with-fft" id="id4">Function transformer with FFT</a></p>
<ul>
<li><p><a class="reference internal" href="#numpy-implementation" id="id5">numpy implementation</a></p></li>
<li><p><a class="reference internal" href="#onnx-implementation" id="id6">ONNX implementation</a></p></li>
<li><p><a class="reference internal" href="#using-onnxruntime" id="id7">Using onnxruntime</a></p></li>
<li><p><a class="reference internal" href="#inside-a-functiontransformer" id="id8">Inside a FunctionTransformer</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<section id="a-pipeline-with-functiontransformer">
<h2><a class="toc-backref" href="#id1">A pipeline with FunctionTransformer</a><a class="headerlink" href="#a-pipeline-with-functiontransformer" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
            <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">),</span>
            <span class="n">StandardScaler</span><span class="p">(),</span>
            <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;functiontransformer&#39;</span><span class="p">,</span>
                 <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">func</span><span class="o">=&lt;</span><span class="n">ufunc</span> <span class="s1">&#39;log&#39;</span><span class="o">&gt;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;standardscaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;logisticregression&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())])</span>
</pre></div>
</div>
<p>Let’s convert it into ONNX.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FunctionTransformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">supported</span> <span class="n">unless</span> <span class="n">the</span> <span class="n">transform</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">(</span><span class="o">=</span> <span class="n">identity</span><span class="p">)</span><span class="o">.</span> <span class="n">You</span> <span class="n">may</span> <span class="k">raise</span> <span class="n">an</span> <span class="n">issue</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">onnx</span><span class="o">/</span><span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="o">/</span><span class="n">issues</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="use-onnx-instead-of-numpy">
<h2><a class="toc-backref" href="#id2">Use ONNX instead of numpy</a><a class="headerlink" href="#use-onnx-instead-of-numpy" title="Permalink to this headline">#</a></h2>
<p>The pipeline cannot be converter because the converter does not know how
to convert the function (<code class="docutils literal notranslate"><span class="pre">numpy.log</span></code>) held by <code class="docutils literal notranslate"><span class="pre">FunctionTransformer</span></code>
into ONNX. One way to avoid that is to replace it by a function <code class="docutils literal notranslate"><span class="pre">log</span></code>
defined with <em>ONNX</em> operators and executed with an ONNX runtime.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_pyrt</span> <span class="k">as</span> <span class="nn">npnxrt</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
            <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">npnxrt</span><span class="o">.</span><span class="n">log</span><span class="p">),</span>
            <span class="n">StandardScaler</span><span class="p">(),</span>
            <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;functiontransformer&#39;</span><span class="p">,</span>
                 <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">func</span><span class="o">=&lt;</span><span class="n">mlprodict</span><span class="o">.</span><span class="n">npy</span><span class="o">.</span><span class="n">onnx_numpy_wrapper</span><span class="o">.</span><span class="n">onnxnumpy_nb_log_None_None</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000002B02D5D7550</span><span class="o">&gt;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;standardscaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;logisticregression&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">C:Python395_x64libsite-packagesxgboostcompat.py:36: FutureWarning: pandas.Int64Index is deprecated and will be removed from pandas in a future version. Use pandas.Index with the appropriate dtype instead.
  from pandas import MultiIndex, Int64Index</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> onx
</pre></div>
</div>
<div id="Mf5623408ebc44c239ece05c19a80a72f-cont"><div id="Mf5623408ebc44c239ece05c19a80a72f" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  nodesep=0.05;\n  size=7;\n  ranksep=0.25;\n\n  X [shape=box color=red label=\"X\ndouble((0, 4))\" fontsize=10];\n\n  output_label [shape=box color=green label=\"output_label\nint64((0,))\" fontsize=10];\n  output_probability [shape=box color=green label=\"output_probability\n[{int64, {'kind': 'tensor', 'elem': 'double', 'shape': }}]\" fontsize=10];\n\n  Su_Subcst [shape=box label=\"Su_Subcst\nfloat64((4,))\n[ 1.75233693  1.11020979  1.16721816 -0.19607855]\" fontsize=10];\n  Di_Divcst [shape=box label=\"Di_Divcst\nfloat64((4,))\n[0.13316014 0.14052184 0.57746737 0.98983177]\" fontsize=10];\n  coef [shape=box label=\"coef\nfloat64((4, 3))\n[[-0.92381911  0.19033174  0.73348737]\n [ 1.000908...\" fontsize=10];\n  intercept [shape=box label=\"intercept\nfloat64((1, 3))\n[[ 0.33436407  1.83444625 -2.16881032]]\" fontsize=10];\n  classes [shape=box label=\"classes\nint32((3,))\n[0 1 2]\" fontsize=10];\n  shape_tensor [shape=box label=\"shape_tensor\nint64((1,))\n[-1]\" fontsize=10];\n\n  ft_y [shape=box label=\"ft_y\" fontsize=10];\n  ft_Log [shape=box style=\"filled,rounded\" color=orange label=\"Log\n(ft_Log)\" fontsize=10];\n  X -> ft_Log;\n  ft_Log -> ft_y;\n\n  Su_C0 [shape=box label=\"Su_C0\" fontsize=10];\n  Su_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub)\" fontsize=10];\n  ft_y -> Su_Sub;\n  Su_Subcst -> Su_Sub;\n  Su_Sub -> Su_C0;\n\n  variable1 [shape=box label=\"variable1\" fontsize=10];\n  Di_Div [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(Di_Div)\" fontsize=10];\n  Su_C0 -> Di_Div;\n  Di_Divcst -> Di_Div;\n  Di_Div -> variable1;\n\n  multiplied [shape=box label=\"multiplied\" fontsize=10];\n  MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(MatMul)\" fontsize=10];\n  variable1 -> MatMul;\n  coef -> MatMul;\n  MatMul -> multiplied;\n\n  raw_scores [shape=box label=\"raw_scores\" fontsize=10];\n  Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(Add)\" fontsize=10];\n  multiplied -> Add;\n  intercept -> Add;\n  Add -> raw_scores;\n\n  label1 [shape=box label=\"label1\" fontsize=10];\n  ArgMax [shape=box style=\"filled,rounded\" color=orange label=\"ArgMax\n(ArgMax)\naxis=1\" fontsize=10];\n  raw_scores -> ArgMax;\n  ArgMax -> label1;\n\n  probabilities [shape=box label=\"probabilities\" fontsize=10];\n  Softmax [shape=box style=\"filled,rounded\" color=orange label=\"Softmax\n(Softmax)\naxis=-1\" fontsize=10];\n  raw_scores -> Softmax;\n  Softmax -> probabilities;\n\n  array_feature_extractor_result [shape=box label=\"array_feature_extractor_result\" fontsize=10];\n  ArrayFeatureExtractor [shape=box style=\"filled,rounded\" color=orange label=\"ArrayFeatureExtractor\n(ArrayFeatureExtractor)\" fontsize=10];\n  classes -> ArrayFeatureExtractor;\n  label1 -> ArrayFeatureExtractor;\n  ArrayFeatureExtractor -> array_feature_extractor_result;\n\n  ZipMap [shape=box style=\"filled,rounded\" color=orange label=\"ZipMap\n(ZipMap)\nclasslabels_int64s=[0 1 2]\" fontsize=10];\n  probabilities -> ZipMap;\n  ZipMap -> output_probability;\n\n  cast2_result [shape=box label=\"cast2_result\" fontsize=10];\n  Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast)\nto=11\" fontsize=10];\n  array_feature_extractor_result -> Cast;\n  Cast -> cast2_result;\n\n  reshaped_result [shape=box label=\"reshaped_result\" fontsize=10];\n  Reshape [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\n(Reshape)\" fontsize=10];\n  cast2_result -> Reshape;\n  shape_tensor -> Reshape;\n  Reshape -> reshaped_result;\n\n  label [shape=box label=\"label\" fontsize=10];\n  Cast1 [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast1)\nto=7\" fontsize=10];\n  reshaped_result -> Cast1;\n  Cast1 -> label;\n\n  Cast2 [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast2)\nto=7\" fontsize=10];\n  label -> Cast2;\n  Cast2 -> output_label;\n}");
document.getElementById('Mf5623408ebc44c239ece05c19a80a72f').innerHTML = svgGraph; });

</script><p>The operator <code class="docutils literal notranslate"><span class="pre">Log</span></code> is belongs to the graph. There is some overhead by
using this function on small matrices. The gap is much less on big
matrices.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> numpy.log(X_train)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>3.86 µs ± 177 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> npnxrt.log(X_train)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>22.5 µs ± 1.66 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
</pre></div>
</div>
</section>
<section id="slightly-more-complex-functions-with-a-functiontransformer">
<h2><a class="toc-backref" href="#id3">Slightly more complex functions with a FunctionTransformer</a><a class="headerlink" href="#slightly-more-complex-functions-with-a-functiontransformer" title="Permalink to this headline">#</a></h2>
<p>What about more complex functions? It is a bit more complicated too. The
previous syntax does not work.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_fct</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">npnxrt</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
            <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">custom_fct</span><span class="p">),</span>
            <span class="n">StandardScaler</span><span class="p">(),</span>
            <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;functiontransformer&#39;</span><span class="p">,</span>
                 <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">func</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">custom_fct</span> <span class="n">at</span> <span class="mh">0x000002B02E5B24C0</span><span class="o">&gt;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;standardscaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;logisticregression&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FunctionTransformer is not supported unless the transform function is of type &lt;class &#39;function&#39;&gt; wrapped with onnxnumpy.
</pre></div>
</div>
<p>The syntax is different.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>

<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">custom_fct</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
            <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">custom_fct</span><span class="p">),</span>
            <span class="n">StandardScaler</span><span class="p">(),</span>
            <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;functiontransformer&#39;</span><span class="p">,</span>
                 <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">func</span><span class="o">=&lt;</span><span class="n">mlprodict</span><span class="o">.</span><span class="n">npy</span><span class="o">.</span><span class="n">onnx_numpy_wrapper</span><span class="o">.</span><span class="n">onnxnumpy_custom_fct_None_None</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000002B02E63F6D0</span><span class="o">&gt;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;standardscaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;logisticregression&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">%</span><span class="k">onnxview</span> onx
</pre></div>
</div>
<div id="M16f0d5d6b9224a5484d3f67d6c828749-cont"><div id="M16f0d5d6b9224a5484d3f67d6c828749" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  nodesep=0.05;\n  size=7;\n  ranksep=0.25;\n\n  X [shape=box color=red label=\"X\ndouble((0, 4))\" fontsize=10];\n\n  output_label [shape=box color=green label=\"output_label\nint64((0,))\" fontsize=10];\n  output_probability [shape=box color=green label=\"output_probability\n[{int64, {'kind': 'tensor', 'elem': 'double', 'shape': }}]\" fontsize=10];\n\n  ft_init [shape=box label=\"ft_init\nfloat64((1,))\n[1.]\" fontsize=10];\n  Su_Subcst [shape=box label=\"Su_Subcst\nfloat64((4,))\n[1.9133287  1.39684219 1.46982746 0.71125505]\" fontsize=10];\n  Di_Divcst [shape=box label=\"Di_Divcst\nfloat64((4,))\n[0.11354364 0.10570008 0.41965295 0.38344944]\" fontsize=10];\n  coef [shape=box label=\"coef\nfloat64((4, 3))\n[[-0.91820372  0.25731821  0.66088551]\n [ 1.034911...\" fontsize=10];\n  intercept [shape=box label=\"intercept\nfloat64((1, 3))\n[[ 0.176704    1.79748833 -1.97419233]]\" fontsize=10];\n  classes [shape=box label=\"classes\nint32((3,))\n[0 1 2]\" fontsize=10];\n  shape_tensor [shape=box label=\"shape_tensor\nint64((1,))\n[-1]\" fontsize=10];\n\n  ft_out_add_0 [shape=box label=\"ft_out_add_0\" fontsize=10];\n  ft_Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(ft_Add)\" fontsize=10];\n  X -> ft_Add;\n  ft_init -> ft_Add;\n  ft_Add -> ft_out_add_0;\n\n  ft_y [shape=box label=\"ft_y\" fontsize=10];\n  ft_Log [shape=box style=\"filled,rounded\" color=orange label=\"Log\n(ft_Log)\" fontsize=10];\n  ft_out_add_0 -> ft_Log;\n  ft_Log -> ft_y;\n\n  Su_C0 [shape=box label=\"Su_C0\" fontsize=10];\n  Su_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub)\" fontsize=10];\n  ft_y -> Su_Sub;\n  Su_Subcst -> Su_Sub;\n  Su_Sub -> Su_C0;\n\n  variable1 [shape=box label=\"variable1\" fontsize=10];\n  Di_Div [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(Di_Div)\" fontsize=10];\n  Su_C0 -> Di_Div;\n  Di_Divcst -> Di_Div;\n  Di_Div -> variable1;\n\n  multiplied [shape=box label=\"multiplied\" fontsize=10];\n  MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(MatMul)\" fontsize=10];\n  variable1 -> MatMul;\n  coef -> MatMul;\n  MatMul -> multiplied;\n\n  raw_scores [shape=box label=\"raw_scores\" fontsize=10];\n  Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(Add)\" fontsize=10];\n  multiplied -> Add;\n  intercept -> Add;\n  Add -> raw_scores;\n\n  probabilities [shape=box label=\"probabilities\" fontsize=10];\n  Softmax [shape=box style=\"filled,rounded\" color=orange label=\"Softmax\n(Softmax)\naxis=-1\" fontsize=10];\n  raw_scores -> Softmax;\n  Softmax -> probabilities;\n\n  label1 [shape=box label=\"label1\" fontsize=10];\n  ArgMax [shape=box style=\"filled,rounded\" color=orange label=\"ArgMax\n(ArgMax)\naxis=1\" fontsize=10];\n  raw_scores -> ArgMax;\n  ArgMax -> label1;\n\n  ZipMap [shape=box style=\"filled,rounded\" color=orange label=\"ZipMap\n(ZipMap)\nclasslabels_int64s=[0 1 2]\" fontsize=10];\n  probabilities -> ZipMap;\n  ZipMap -> output_probability;\n\n  array_feature_extractor_result [shape=box label=\"array_feature_extractor_result\" fontsize=10];\n  ArrayFeatureExtractor [shape=box style=\"filled,rounded\" color=orange label=\"ArrayFeatureExtractor\n(ArrayFeatureExtractor)\" fontsize=10];\n  classes -> ArrayFeatureExtractor;\n  label1 -> ArrayFeatureExtractor;\n  ArrayFeatureExtractor -> array_feature_extractor_result;\n\n  cast2_result [shape=box label=\"cast2_result\" fontsize=10];\n  Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast)\nto=11\" fontsize=10];\n  array_feature_extractor_result -> Cast;\n  Cast -> cast2_result;\n\n  reshaped_result [shape=box label=\"reshaped_result\" fontsize=10];\n  Reshape [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\n(Reshape)\" fontsize=10];\n  cast2_result -> Reshape;\n  shape_tensor -> Reshape;\n  Reshape -> reshaped_result;\n\n  label [shape=box label=\"label\" fontsize=10];\n  Cast1 [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast1)\nto=7\" fontsize=10];\n  reshaped_result -> Cast1;\n  Cast1 -> label;\n\n  Cast2 [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast2)\nto=7\" fontsize=10];\n  label -> Cast2;\n  Cast2 -> output_label;\n}");
document.getElementById('M16f0d5d6b9224a5484d3f67d6c828749').innerHTML = svgGraph; });

</script><p>Let’s compare the time to <em>numpy</em>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_numpy_fct</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="o">%</span><span class="k">timeit</span> custom_numpy_fct(X_train)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>5.43 µs ± 99.3 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fct(X_train)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>25 µs ± 1.13 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
</pre></div>
</div>
<p>The new function is slower but the gap is much less on bigger matrices.
The default ONNX runtime has a significant cost compare to the cost of a
couple of operations on small matrices.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bigx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="o">%</span><span class="k">timeit</span> custom_numpy_fct(bigx)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>351 µs ± 41.4 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fct(bigx)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>334 µs ± 2.63 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
</pre></div>
</div>
</section>
<section id="function-transformer-with-fft">
<h2><a class="toc-backref" href="#id4">Function transformer with FFT</a><a class="headerlink" href="#function-transformer-with-fft" title="Permalink to this headline">#</a></h2>
<p>The following function is equivalent to the module of the output of a
FFT transform. The matrix <img class="math" src="../_images/math/709dd4926288e7c9f5b94effe429a506cf81824d.svg" alt="M_{kn}"/> is defined by
<img class="math" src="../_images/math/6240911feee2b5e282e53df5bb403f2ae324c206.svg" alt="M_{kn}=(\exp(-2i\pi kn/N))_{kn}"/>. Complex features are then
obtained by computing <img class="math" src="../_images/math/b33642b21bbffb41f6a101790ba94259a5477cae.svg" alt="MX"/>. Taking the module leads to real
features: <img class="math" src="../_images/math/ee4158724176e51d8fdcc1394d64fd4ba4bc47c9.svg" alt="\sqrt{Re(MX)^2 + Im(MX)^2}"/>. That’s what the following
function does.</p>
<section id="numpy-implementation">
<h3><a class="toc-backref" href="#id5">numpy implementation</a><a class="headerlink" href="#numpy-implementation" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_fft_abs_py</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="s2">&quot;onnx fft + abs python&quot;</span>
    <span class="c1"># see https://jakevdp.github.io/blog/</span>
    <span class="c1"># 2013/08/28/understanding-the-fft/</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">kn</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">dim</span><span class="p">)</span>
    <span class="n">kn_cos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">kn</span><span class="p">)</span>
    <span class="n">kn_sin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">kn</span><span class="p">)</span>
    <span class="n">ekn</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,)</span> <span class="o">+</span> <span class="n">kn</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">ekn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">kn_cos</span>
    <span class="n">ekn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">kn_sin</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ekn</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">res</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">custom_fft_abs_py</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">1.982739</span>  <span class="p">,</span> <span class="mf">1.1724371</span> <span class="p">,</span> <span class="mf">3.4323769</span> <span class="p">,</span> <span class="mf">1.172437</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.764481</span>  <span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">,</span> <span class="mf">0.28028846</span><span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.8741124</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">,</span> <span class="mf">2.1338394</span> <span class="p">,</span> <span class="mf">1.8547024</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="onnx-implementation">
<h3><a class="toc-backref" href="#id6">ONNX implementation</a><a class="headerlink" href="#onnx-implementation" title="Permalink to this headline">#</a></h3>
<p>This function cannot be exported into ONNX unless it is written with
ONNX operators. This is where the numpy API for ONNX helps speeding up
the process.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">onnxnumpy_np</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">nxnp</span>


<span class="k">def</span> <span class="nf">_custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">kn</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="n">dim</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">kn3</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">kn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">kn_cos</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">kn3</span><span class="p">)</span>
    <span class="n">kn_sin</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">kn3</span><span class="p">)</span>
    <span class="n">ekn</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kn_cos</span><span class="p">,</span> <span class="n">kn_sin</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ekn</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">res</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="s2">&quot;onnx fft + abs&quot;</span>
    <span class="k">return</span> <span class="n">_custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">C:xavierdupre__home_GitHubmlprodictmlprodictnpynumpy_onnx_impl.py:253: UserWarning: npnx.dot is equivalent to npnx.matmul == numpy.matmul != numpy.dot with arrays with more than 3D dimensions.
  warnings.warn(</pre>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">1.982739</span>  <span class="p">,</span> <span class="mf">1.1724371</span> <span class="p">,</span> <span class="mf">3.4323769</span> <span class="p">,</span> <span class="mf">1.172437</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.7644813</span> <span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">,</span> <span class="mf">0.28028846</span><span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.8741124</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">,</span> <span class="mf">2.1338396</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">custom_fft_abs</span></code> is not a function a class holding an ONNX graph. A
method <code class="docutils literal notranslate"><span class="pre">__call__</span></code> executes the ONNX graph with a python runtime.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fonx</span> <span class="o">=</span> <span class="n">custom_fft_abs</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">()</span>
<span class="o">%</span><span class="k">onnxview</span> fonx
</pre></div>
</div>
<div id="M5dbac4943bec4ca88a94e4923223ff16-cont"><div id="M5dbac4943bec4ca88a94e4923223ff16" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  nodesep=0.05;\n  size=7;\n  ranksep=0.25;\n\n  x [shape=box color=red label=\"x\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\nint64(())\n1\" fontsize=10];\n  init_1 [shape=box label=\"init_1\nint64((1,))\n[-1]\" fontsize=10];\n  init_2 [shape=box label=\"init_2\nint64((1,))\n[0]\" fontsize=10];\n  init_4 [shape=box label=\"init_4\nfloat32((1,))\n[-6.2831855]\" fontsize=10];\n  init_5 [shape=box label=\"init_5\nint64((2,))\n[-1  1]\" fontsize=10];\n  init_7 [shape=box label=\"init_7\nint64((1,))\n[2]\" fontsize=10];\n  init_8 [shape=box label=\"init_8\nint64((1,))\n[1]\" fontsize=10];\n\n  out_sha_0 [shape=box label=\"out_sha_0\" fontsize=10];\n  _shape [shape=box style=\"filled,rounded\" color=orange label=\"Shape\n(_shape)\" fontsize=10];\n  x -> _shape;\n  _shape -> out_sha_0;\n\n  out_gat_0 [shape=box label=\"out_gat_0\" fontsize=10];\n  _gather [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather)\naxis=0\" fontsize=10];\n  out_sha_0 -> _gather;\n  init -> _gather;\n  _gather -> out_gat_0;\n\n  out_res_0 [shape=box label=\"out_res_0\" fontsize=10];\n  _reshape [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\n(_reshape)\" fontsize=10];\n  out_gat_0 -> _reshape;\n  init_1 -> _reshape;\n  _reshape -> out_res_0;\n\n  out_con_0 [shape=box label=\"out_con_0\" fontsize=10];\n  _constantofshape [shape=box style=\"filled,rounded\" color=orange label=\"ConstantOfShape\n(_constantofshape)\nvalue=[1]\" fontsize=10];\n  out_res_0 -> _constantofshape;\n  _constantofshape -> out_con_0;\n\n  out_cum_0 [shape=box label=\"out_cum_0\" fontsize=10];\n  _cumsum [shape=box style=\"filled,rounded\" color=orange label=\"CumSum\n(_cumsum)\" fontsize=10];\n  out_con_0 -> _cumsum;\n  init_2 -> _cumsum;\n  _cumsum -> out_cum_0;\n\n  out_add_0 [shape=box label=\"out_add_0\" fontsize=10];\n  _add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(_add)\" fontsize=10];\n  out_cum_0 -> _add;\n  init_1 -> _add;\n  _add -> out_add_0;\n\n  out_cas_0 [shape=box label=\"out_cas_0\" fontsize=10];\n  _cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(_cast)\nto=1\" fontsize=10];\n  out_add_0 -> _cast;\n  _cast -> out_cas_0;\n\n  out_mul_0 [shape=box label=\"out_mul_0\" fontsize=10];\n  _mul [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(_mul)\" fontsize=10];\n  out_cas_0 -> _mul;\n  init_4 -> _mul;\n  _mul -> out_mul_0;\n\n  out_res_0_1 [shape=box label=\"out_res_0_1\" fontsize=10];\n  _reshape_1 [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\n(_reshape_1)\" fontsize=10];\n  out_cas_0 -> _reshape_1;\n  init_5 -> _reshape_1;\n  _reshape_1 -> out_res_0_1;\n\n  out_cas_0_1 [shape=box label=\"out_cas_0_1\" fontsize=10];\n  _cast_1 [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(_cast_1)\nto=1\" fontsize=10];\n  out_gat_0 -> _cast_1;\n  _cast_1 -> out_cas_0_1;\n\n  out_mul_0_1 [shape=box label=\"out_mul_0_1\" fontsize=10];\n  _mul_1 [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(_mul_1)\" fontsize=10];\n  out_res_0_1 -> _mul_1;\n  out_mul_0 -> _mul_1;\n  _mul_1 -> out_mul_0_1;\n\n  out_div_0 [shape=box label=\"out_div_0\" fontsize=10];\n  _div [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(_div)\" fontsize=10];\n  out_mul_0_1 -> _div;\n  out_cas_0_1 -> _div;\n  _div -> out_div_0;\n\n  out_uns_0 [shape=box label=\"out_uns_0\" fontsize=10];\n  _unsqueeze [shape=box style=\"filled,rounded\" color=orange label=\"Unsqueeze\n(_unsqueeze)\" fontsize=10];\n  out_div_0 -> _unsqueeze;\n  init_2 -> _unsqueeze;\n  _unsqueeze -> out_uns_0;\n\n  out_sin_0 [shape=box label=\"out_sin_0\" fontsize=10];\n  _sin [shape=box style=\"filled,rounded\" color=orange label=\"Sin\n(_sin)\" fontsize=10];\n  out_uns_0 -> _sin;\n  _sin -> out_sin_0;\n\n  out_cos_0 [shape=box label=\"out_cos_0\" fontsize=10];\n  _cos [shape=box style=\"filled,rounded\" color=orange label=\"Cos\n(_cos)\" fontsize=10];\n  out_uns_0 -> _cos;\n  _cos -> out_cos_0;\n\n  out_tra_0 [shape=box label=\"out_tra_0\" fontsize=10];\n  _transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose)\" fontsize=10];\n  x -> _transpose;\n  _transpose -> out_tra_0;\n\n  out_con_0_1 [shape=box label=\"out_con_0_1\" fontsize=10];\n  _concat [shape=box style=\"filled,rounded\" color=orange label=\"Concat\n(_concat)\naxis=0\" fontsize=10];\n  out_cos_0 -> _concat;\n  out_sin_0 -> _concat;\n  _concat -> out_con_0_1;\n\n  out_mat_0 [shape=box label=\"out_mat_0\" fontsize=10];\n  _matmul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul)\" fontsize=10];\n  out_con_0_1 -> _matmul;\n  out_tra_0 -> _matmul;\n  _matmul -> out_mat_0;\n\n  out_pow_0 [shape=box label=\"out_pow_0\" fontsize=10];\n  _pow [shape=box style=\"filled,rounded\" color=orange label=\"Pow\n(_pow)\" fontsize=10];\n  out_mat_0 -> _pow;\n  init_7 -> _pow;\n  _pow -> out_pow_0;\n\n  out_sli_0 [shape=box label=\"out_sli_0\" fontsize=10];\n  _slice [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice)\" fontsize=10];\n  out_pow_0 -> _slice;\n  init_8 -> _slice;\n  init_7 -> _slice;\n  init_2 -> _slice;\n  _slice -> out_sli_0;\n\n  out_sli_0_1 [shape=box label=\"out_sli_0_1\" fontsize=10];\n  _slice_1 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_1)\" fontsize=10];\n  out_pow_0 -> _slice_1;\n  init_2 -> _slice_1;\n  init_8 -> _slice_1;\n  init_2 -> _slice_1;\n  _slice_1 -> out_sli_0_1;\n\n  out_squ_0 [shape=box label=\"out_squ_0\" fontsize=10];\n  _squeeze [shape=box style=\"filled,rounded\" color=orange label=\"Squeeze\n(_squeeze)\" fontsize=10];\n  out_sli_0 -> _squeeze;\n  init_2 -> _squeeze;\n  _squeeze -> out_squ_0;\n\n  out_squ_0_1 [shape=box label=\"out_squ_0_1\" fontsize=10];\n  _squeeze_1 [shape=box style=\"filled,rounded\" color=orange label=\"Squeeze\n(_squeeze_1)\" fontsize=10];\n  out_sli_0_1 -> _squeeze_1;\n  init_2 -> _squeeze_1;\n  _squeeze_1 -> out_squ_0_1;\n\n  out_add_0_1 [shape=box label=\"out_add_0_1\" fontsize=10];\n  _add_1 [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(_add_1)\" fontsize=10];\n  out_squ_0_1 -> _add_1;\n  out_squ_0 -> _add_1;\n  _add_1 -> out_add_0_1;\n\n  out_sqr_0 [shape=box label=\"out_sqr_0\" fontsize=10];\n  _sqrt [shape=box style=\"filled,rounded\" color=orange label=\"Sqrt\n(_sqrt)\" fontsize=10];\n  out_add_0_1 -> _sqrt;\n  _sqrt -> out_sqr_0;\n\n  _transpose_1 [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose_1)\" fontsize=10];\n  out_sqr_0 -> _transpose_1;\n  _transpose_1 -> y;\n}");
document.getElementById('M5dbac4943bec4ca88a94e4923223ff16').innerHTML = svgGraph; });

</script><p>Every intermediate output can be logged.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fLOG</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">OnnxInference</span><span class="p">:</span> <span class="n">run</span> <span class="mi">26</span> <span class="n">nodes</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sha_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_shape&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sha_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">3</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Gather</span><span class="p">(</span><span class="n">out_sha_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gather&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_gat_0&#39;</span><span class="p">:</span> <span class="p">()</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Reshape</span><span class="p">(</span><span class="n">out_gat_0</span><span class="p">,</span> <span class="n">init_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_res_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_reshape&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_res_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">ConstantOfShape</span><span class="p">(</span><span class="n">out_res_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_con_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_constantofshape&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_con_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">CumSum</span><span class="p">(</span><span class="n">out_con_0</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cum_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_cumsum&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_cum_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Add</span><span class="p">(</span><span class="n">out_cum_0</span><span class="p">,</span> <span class="n">init_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_add&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_add_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Cast</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cas_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_cast&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_cas_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Mul</span><span class="p">(</span><span class="n">out_cas_0</span><span class="p">,</span> <span class="n">init_4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_mul&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">18.84955596923828</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Reshape</span><span class="p">(</span><span class="n">out_cas_0</span><span class="p">,</span> <span class="n">init_5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_res_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_reshape_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_res_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Cast</span><span class="p">(</span><span class="n">out_gat_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cas_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_cast_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_cas_0_1&#39;</span><span class="p">:</span> <span class="p">()</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">4.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Mul</span><span class="p">(</span><span class="n">out_res_0_1</span><span class="p">,</span> <span class="n">out_mul_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_mul_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_mul_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">56.548667907714844</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Div</span><span class="p">(</span><span class="n">out_mul_0_1</span><span class="p">,</span> <span class="n">out_cas_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_div_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_div&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_div_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">14.137166976928711</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Unsqueeze</span><span class="p">(</span><span class="n">out_div_0</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_uns_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_unsqueeze&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_uns_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">14.137166976928711</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Sin</span><span class="p">(</span><span class="n">out_uns_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sin_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_sin&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sin_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Cos</span><span class="p">(</span><span class="n">out_uns_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cos_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_cos&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_cos_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Transpose</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_tra_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_transpose&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_tra_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.118224620819092</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.176269054412842</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Concat</span><span class="p">(</span><span class="n">out_cos_0</span><span class="p">,</span> <span class="n">out_sin_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_con_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_concat&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_con_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">MatMul</span><span class="p">(</span><span class="n">out_con_0_1</span><span class="p">,</span> <span class="n">out_tra_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mat_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_matmul&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_mat_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.9943528175354004</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.4323768615722656</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Pow</span><span class="p">(</span><span class="n">out_mat_0</span><span class="p">,</span> <span class="n">init_7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_pow_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_pow&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_pow_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">11.781210899353027</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_pow_0</span><span class="p">,</span> <span class="n">init_8</span><span class="p">,</span> <span class="n">init_7</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.20590990781784058</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_pow_0</span><span class="p">,</span> <span class="n">init_2</span><span class="p">,</span> <span class="n">init_8</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.07856161892414093</span> <span class="nb">max</span><span class="o">=</span><span class="mf">11.781210899353027</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Squeeze</span><span class="p">(</span><span class="n">out_sli_0</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_squ_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_squeeze&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_squ_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.20590990781784058</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Squeeze</span><span class="p">(</span><span class="n">out_sli_0_1</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_squ_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_squeeze_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_squ_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.07856161892414093</span> <span class="nb">max</span><span class="o">=</span><span class="mf">11.781210899353027</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Add</span><span class="p">(</span><span class="n">out_squ_0_1</span><span class="p">,</span> <span class="n">out_squ_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_add_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_add_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.07856161892414093</span> <span class="nb">max</span><span class="o">=</span><span class="mf">11.781210899353027</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Sqrt</span><span class="p">(</span><span class="n">out_add_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sqr_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_sqrt&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sqr_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.2802884578704834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.4323768615722656</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Transpose</span><span class="p">(</span><span class="n">out_sqr_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">y</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_transpose_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.2802884578704834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.4323768615722656</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">1.982739</span>  <span class="p">,</span> <span class="mf">1.1724371</span> <span class="p">,</span> <span class="mf">3.4323769</span> <span class="p">,</span> <span class="mf">1.172437</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.7644813</span> <span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">,</span> <span class="mf">0.28028846</span><span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.8741124</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">,</span> <span class="mf">2.1338396</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fft_abs_py(x)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>18.6 µs ± 581 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fft_abs(x)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>261 µs ± 8.92 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
</pre></div>
</div>
<p>Again the gap is less on bigger matrices. It cannot be faster with the
default runtime as it is also using <em>numpy</em>. That’s another story with
<em>onnxruntime</em> (see below).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bigx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> custom_fft_abs_py(bigx)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.64 ms ± 49.1 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fft_abs(bigx)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>3.69 ms ± 224 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</section>
<section id="using-onnxruntime">
<h3><a class="toc-backref" href="#id7">Using onnxruntime</a><a class="headerlink" href="#using-onnxruntime" title="Permalink to this headline">#</a></h3>
<p>The python runtime is using numpy but is usually quite slow as the
runtime needs to go through the graph structure. <em>onnxruntime</em> is
faster.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">custom_fft_abs_ort</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">],</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="s2">&quot;onnx fft + abs&quot;</span>
    <span class="k">return</span> <span class="n">_custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">custom_fft_abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">1.982739</span>  <span class="p">,</span> <span class="mf">1.1724371</span> <span class="p">,</span> <span class="mf">3.4323769</span> <span class="p">,</span> <span class="mf">1.172437</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.7644813</span> <span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">,</span> <span class="mf">0.28028846</span><span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.8741124</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">,</span> <span class="mf">2.1338396</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fft_abs_ort(x)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>77.7 µs ± 44 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<p><em>onnxruntime</em> is faster than numpy in this case.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> custom_fft_abs_ort(bigx)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>231 µs ± 48.8 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
</pre></div>
</div>
</section>
<section id="inside-a-functiontransformer">
<h3><a class="toc-backref" href="#id8">Inside a FunctionTransformer</a><a class="headerlink" href="#inside-a-functiontransformer" title="Permalink to this headline">#</a></h3>
<p>The conversion to ONNX fails if the python function is used.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>

<span class="n">tr</span> <span class="o">=</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">custom_fft_abs_py</span><span class="p">)</span>
<span class="n">tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FunctionTransformer is not supported unless the transform function is of type &lt;class &#39;function&#39;&gt; wrapped with onnxnumpy.
</pre></div>
</div>
<p>Now with the onnx version but before, the converter for
FunctionTransformer needs to be overwritten to handle this functionality
not available in
<a class="reference external" href="https://github.com/onnx/sklearn-onnx">sklearn-onnx</a>. These version
are automatically called in function
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnx_conv/convert.html#mlprodict.onnx_conv.convert.to_onnx">to_onnx</a>
from <em>mlprodict</em>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tr</span> <span class="o">=</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">custom_fft_abs</span><span class="p">)</span>
<span class="n">tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>

<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">)</span>
<span class="n">y_onx</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>
<span class="n">y_onx</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">1.982739</span>  <span class="p">,</span> <span class="mf">1.1724371</span> <span class="p">,</span> <span class="mf">3.4323769</span> <span class="p">,</span> <span class="mf">1.172437</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.7644813</span> <span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">,</span> <span class="mf">0.28028846</span><span class="p">,</span> <span class="mf">3.0285406</span> <span class="p">],</span>
       <span class="p">[</span><span class="mf">2.8741124</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">,</span> <span class="mf">2.1338396</span> <span class="p">,</span> <span class="mf">1.8547025</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="numpy_api_onnx_ccl.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Introduction to a numpy API for ONNX: CustomClassifier</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="lightgbm_double.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lightgbm, double, discrepencies</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>