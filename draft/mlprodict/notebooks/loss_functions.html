
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Loss function in ONNX &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Memory usage" href="onnx_profile.html" />
    <link rel="prev" title="Lightgbm, double, discrepencies" href="lightgbm_double.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_ffts.html">
   ONNX FFTs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#square-loss">
   Square loss
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-function">
     numpy function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#onnx-version">
     onnx version
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#second-api-from-sklearn-onnx">
     second API from sklearn-onnx
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-api">
     numpy API
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#log-loss">
   log loss
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     numpy function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-to-onnx-with-onnx-operators">
     numpy to onnx with onnx operators
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#back-to-onnx-api">
     Back to onnx API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-to-onnx-with-numpy-api">
     numpy to onnx with numpy API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#no-loss-but-lagg-something-difficult-to-write-with-onnx">
     no loss but lagg, something difficult to write with onnx
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="loss-function-in-onnx">
<span id="lossfunctionsrst"></span><h1>Loss function in ONNX<a class="headerlink" href="#loss-function-in-onnx" title="Permalink to this headline">#</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/67ce50517e98815d34fb6f56ec156eaf/loss_functions.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="loss_functions2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/de6cb3f9978c3d739302a0f06bf3eb71/loss_functions.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/d03e548c4d22e96ce7956f32c2438849/loss_functions.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="loss_functions.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/loss_functions.ipynb">GitHub</a></p>
<p>The following notebook show how to translate common loss function into
ONNX.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#square-loss" id="id2">Square loss</a></p>
<ul>
<li><p><a class="reference internal" href="#numpy-function" id="id3">numpy function</a></p></li>
<li><p><a class="reference internal" href="#onnx-version" id="id4">onnx version</a></p></li>
<li><p><a class="reference internal" href="#second-api-from-sklearn-onnx" id="id5">second API from sklearn-onnx</a></p></li>
<li><p><a class="reference internal" href="#numpy-api" id="id6">numpy API</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#log-loss" id="id7">log loss</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id8">numpy function</a></p></li>
<li><p><a class="reference internal" href="#numpy-to-onnx-with-onnx-operators" id="id9">numpy to onnx with onnx operators</a></p></li>
<li><p><a class="reference internal" href="#back-to-onnx-api" id="id10">Back to onnx API</a></p></li>
<li><p><a class="reference internal" href="#numpy-to-onnx-with-numpy-api" id="id11">numpy to onnx with numpy API</a></p></li>
<li><p><a class="reference internal" href="#no-loss-but-lagg-something-difficult-to-write-with-onnx" id="id12">no loss but lagg, something difficult to write with onnx</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<section id="square-loss">
<h2><a class="toc-backref" href="#id2">Square loss</a><a class="headerlink" href="#square-loss" title="Permalink to this headline">#</a></h2>
<p>The first example shows how to use
<a class="reference external" href="https://github.com/onnx/onnx">onnx</a> API to represent the square loss
function <img class="math" src="../_images/math/81bf6d6dfc81e7419e859971970e688ea99e688e.svg" alt="E(X,Y) = \sum_i(x_i-y_i)^2"/> where <img class="math" src="../_images/math/370bda9f42fb69fc2382987afd1d289629ac10e1.svg" alt="X=(x_i)"/> and
<img class="math" src="../_images/math/cf93f79e80efafd8285816b244d082638c1fedda.svg" alt="Y=(y_i)"/>.</p>
<section id="numpy-function">
<h3><a class="toc-backref" href="#id3">numpy function</a><a class="headerlink" href="#numpy-function" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>


<span class="k">def</span> <span class="nf">square_loss</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">square_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="onnx-version">
<h3><a class="toc-backref" href="#id4">onnx version</a><a class="headerlink" href="#onnx-version" title="Permalink to this headline">#</a></h3>
<p>Following example is based on <a class="reference external" href="https://github.com/onnx/onnx/blob/main/docs/PythonAPIOverview.md">onnx Python
API</a>,
described with more detailed at <a class="reference external" href="http://www.xavierdupre.fr/app/onnxcustom/helpsphinx/tutorials/tutorial_onnx/python.html">Introduction to onnx Python
API</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx.helper</span> <span class="kn">import</span> <span class="n">make_node</span><span class="p">,</span> <span class="n">make_graph</span><span class="p">,</span> <span class="n">make_model</span><span class="p">,</span> <span class="n">make_tensor_value_info</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">TensorProto</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]),</span>
         <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;Mul&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;diff2&#39;</span><span class="p">]),</span>
         <span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;ReduceSum&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;diff2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])]</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;square_loss&#39;</span><span class="p">,</span>
                   <span class="p">[</span><span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]),</span>
                    <span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])],</span>
                   <span class="p">[</span><span class="n">make_tensor_value_info</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">TensorProto</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">])])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="k">del</span> <span class="n">model</span><span class="o">.</span><span class="n">opset_import</span><span class="p">[:]</span>
<span class="n">opset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">opset_import</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
<span class="n">opset</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">opset</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">14</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">diff</span>
  <span class="n">Mul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">diff2</span>
    <span class="n">ReduceSum</span><span class="p">(</span><span class="n">diff2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loss</span>
<span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> model
</pre></div>
</div>
<div id="M2643b877c1bd42deb30bf38d7223a245-cont"><div id="M2643b877c1bd42deb30bf38d7223a245" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0,))\" fontsize=10];\n  Y [shape=box color=red label=\"Y\nfloat((0,))\" fontsize=10];\n\n  loss [shape=box color=green label=\"loss\nfloat((0,))\" fontsize=10];\n\n\n  diff [shape=box label=\"diff\" fontsize=10];\n  Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Sub)\" fontsize=10];\n  X -> Sub;\n  Y -> Sub;\n  Sub -> diff;\n\n  diff2 [shape=box label=\"diff2\" fontsize=10];\n  Mul [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(Mul)\" fontsize=10];\n  diff -> Mul;\n  diff -> Mul;\n  Mul -> diff2;\n\n  ReduceSum [shape=box style=\"filled,rounded\" color=orange label=\"ReduceSum\n(ReduceSum)\" fontsize=10];\n  diff2 -> ReduceSum;\n  ReduceSum -> loss;\n}");
document.getElementById('M2643b877c1bd42deb30bf38d7223a245').innerHTML = svgGraph; });

</script><p>Let’s check it gives the same results.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="second-api-from-sklearn-onnx">
<h3><a class="toc-backref" href="#id5">second API from sklearn-onnx</a><a class="headerlink" href="#second-api-from-sklearn-onnx" title="Permalink to this headline">#</a></h3>
<p>The previous API is quite verbose.
<a class="reference external" href="https://onnx.ai/sklearn-onnx/">sklearn-onnx</a> implements a more
simple API to do it where every onnx operator is made available as a
class. It was developped to speed up the implementation of converters
for scikit-learn (see
<a class="reference external" href="https://onnx.ai/sklearn-onnx/auto_tutorial/plot_icustom_converter.html">sklearn-onnx</a>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skl2onnx.algebra.onnx_ops</span> <span class="kn">import</span> <span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span><span class="p">,</span> <span class="n">OnnxReduceSum</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="n">OnnxReduceSum</span><span class="p">(</span><span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Su_C0</span>
  <span class="n">Mul</span><span class="p">(</span><span class="n">Su_C0</span><span class="p">,</span> <span class="n">Su_C0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mu_C0</span>
    <span class="n">ReduceSum</span><span class="p">(</span><span class="n">Mu_C0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Re_reduced0</span>
<span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Re_reduced0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)]</span>
</pre></div>
</div>
<p>As the previous example, this function only allows float32 arrays. It
fails for any other type.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                    <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)})</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">INVALID_ARGUMENT</span> <span class="p">:</span> <span class="n">Unexpected</span> <span class="nb">input</span> <span class="n">data</span> <span class="nb">type</span><span class="o">.</span> <span class="n">Actual</span><span class="p">:</span> <span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">double</span><span class="p">))</span> <span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="numpy-api">
<h3><a class="toc-backref" href="#id6">numpy API</a><a class="headerlink" href="#numpy-api" title="Permalink to this headline">#</a></h3>
<p>Second example is much more simple than the first one but it requires to
know <a class="reference external" href="https://github.com/onnx/onnx/blob/main/docs/Operators.md">ONNX
operators</a>.
The most difficult type is about writing the signature. In the following
example, it take two arrays of the same type <code class="docutils literal notranslate"><span class="pre">T</span></code> and returns an array
of the same type, <code class="docutils literal notranslate"><span class="pre">T</span></code> being any element type (float32, float64, int64,
…).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_np</span><span class="p">,</span> <span class="n">NDArrayType</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>

<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime&#39;</span><span class="p">,</span>
              <span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">((</span><span class="s2">&quot;T:all&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span> <span class="n">dtypes_out</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)))</span>
<span class="k">def</span> <span class="nf">onnx_square_loss</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">onnx_square_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>This API compiles an ONNX graphs for every element type. So it works
float64 as well.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onnx_square_loss</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
</pre></div>
</div>
<p>That’s why method <code class="docutils literal notranslate"><span class="pre">to_onnx</span></code> requires to specify the element type
before the method can return the associated ONNX graph.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span> <span class="o">=</span> <span class="n">onnx_square_loss</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>
<span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
  <span class="n">Pow</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_pow_0</span>
    <span class="n">ReduceSum</span><span class="p">(</span><span class="n">out_pow_0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">y</span>
<span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="log-loss">
<h2><a class="toc-backref" href="#id7">log loss</a><a class="headerlink" href="#log-loss" title="Permalink to this headline">#</a></h2>
<p>The log loss is defined as the following:
<img class="math" src="../_images/math/805bc2859166ce871bc2deb54c59f7140e555904.svg" alt="L(y, s) = (1 - y)\log(1 - p(s)) + y \log(p(s))"/> where
<img class="math" src="../_images/math/3cdeb77e654c909f7267de73d4aeff4f92c9a96b.svg" alt="p(s) = sigmoid(s) = \frac{1}{1 + \exp(-s)}"/>. Let’s start with the
numpy version.</p>
<section id="id1">
<h3><a class="toc-backref" href="#id8">numpy function</a><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">expit</span>

<span class="k">def</span> <span class="nf">log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">expit</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-50</span><span class="p">,</span> <span class="mf">1e50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="n">e0328016fe80</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span> <span class="ne">RuntimeWarning</span><span class="p">:</span> <span class="n">divide</span> <span class="n">by</span> <span class="n">zero</span> <span class="n">encountered</span> <span class="ow">in</span> <span class="n">log</span>
  <span class="n">ls</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">inf</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>The function may return unexpected values because <code class="docutils literal notranslate"><span class="pre">log(0)</span></code> does not
exist. The trick is usually to clip the value.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_loss_clipped</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">expit</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">),</span> <span class="n">eps</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">log_loss_clipped</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">16.515066</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="numpy-to-onnx-with-onnx-operators">
<h3><a class="toc-backref" href="#id9">numpy to onnx with onnx operators</a><a class="headerlink" href="#numpy-to-onnx-with-onnx-operators" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skl2onnx.algebra.onnx_ops</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OnnxClip</span><span class="p">,</span> <span class="n">OnnxSigmoid</span><span class="p">,</span> <span class="n">OnnxLog</span><span class="p">,</span> <span class="n">OnnxAdd</span><span class="p">,</span> <span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span><span class="p">,</span> <span class="n">OnnxNeg</span><span class="p">)</span>

<span class="n">eps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">ps</span> <span class="o">=</span> <span class="n">OnnxClip</span><span class="p">(</span><span class="n">OnnxSigmoid</span><span class="p">(</span><span class="n">OnnxNeg</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)),</span> <span class="n">eps</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span>
<span class="n">ls1</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">OnnxSub</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">),</span> <span class="n">OnnxLog</span><span class="p">(</span><span class="n">OnnxSub</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">ps</span><span class="p">)))</span>
<span class="n">ls2</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">OnnxLog</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="n">OnnxReduceSum</span><span class="p">(</span><span class="n">OnnxAdd</span><span class="p">(</span><span class="n">ls1</span><span class="p">,</span> <span class="n">ls2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;S&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Su_Subcst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Cl_Clipcst&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.e-06</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Cl_Clipcst1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.999999</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Identity</span><span class="p">(</span><span class="n">Su_Subcst</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Su_Subcst1</span>
<span class="n">Neg</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ne_Y0</span>
  <span class="n">Sigmoid</span><span class="p">(</span><span class="n">Ne_Y0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Si_Y0</span>
    <span class="n">Clip</span><span class="p">(</span><span class="n">Si_Y0</span><span class="p">,</span> <span class="n">Cl_Clipcst</span><span class="p">,</span> <span class="n">Cl_Clipcst1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cl_output0</span>
  <span class="n">Sub</span><span class="p">(</span><span class="n">Su_Subcst1</span><span class="p">,</span> <span class="n">Cl_output0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Su_C02</span>
    <span class="n">Log</span><span class="p">(</span><span class="n">Su_C02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lo_output0</span>
<span class="n">Sub</span><span class="p">(</span><span class="n">Su_Subcst</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Su_C0</span>
  <span class="n">Mul</span><span class="p">(</span><span class="n">Su_C0</span><span class="p">,</span> <span class="n">Lo_output0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mu_C0</span>
<span class="n">Log</span><span class="p">(</span><span class="n">Cl_output0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lo_output02</span>
  <span class="n">Mul</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Lo_output02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mu_C02</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">Mu_C0</span><span class="p">,</span> <span class="n">Mu_C02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ad_C0</span>
      <span class="n">ReduceSum</span><span class="p">(</span><span class="n">Ad_C0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Re_reduced0</span>
<span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Re_reduced0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> model
</pre></div>
</div>
<div id="M2d0d58db6b5045b98be7dea255cbd74d-cont"><div id="M2d0d58db6b5045b98be7dea255cbd74d" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n\n  Y [shape=box color=red label=\"Y\nfloat((0,))\" fontsize=10];\n  S [shape=box color=red label=\"S\nfloat((0,))\" fontsize=10];\n\n  Re_reduced0 [shape=box color=green label=\"Re_reduced0\nfloat((1,))\" fontsize=10];\n\n  Su_Subcst [shape=box label=\"Su_Subcst\nfloat32((1,))\n[1.]\" fontsize=10];\n  Cl_Clipcst [shape=box label=\"Cl_Clipcst\nfloat32((1,))\n[1.e-06]\" fontsize=10];\n  Cl_Clipcst1 [shape=box label=\"Cl_Clipcst1\nfloat32((1,))\n[0.999999]\" fontsize=10];\n\n  Ne_Y0 [shape=box label=\"Ne_Y0\" fontsize=10];\n  Ne_Neg [shape=box style=\"filled,rounded\" color=orange label=\"Neg\n(Ne_Neg)\" fontsize=10];\n  S -> Ne_Neg;\n  Ne_Neg -> Ne_Y0;\n\n  Su_C0 [shape=box label=\"Su_C0\" fontsize=10];\n  Su_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub)\" fontsize=10];\n  Su_Subcst -> Su_Sub;\n  Y -> Su_Sub;\n  Su_Sub -> Su_C0;\n\n  Su_Subcst1 [shape=box label=\"Su_Subcst1\" fontsize=10];\n  Su_Subcst1_op [shape=box style=\"filled,rounded\" color=orange label=\"Identity\n(Su_Subcst1_op)\" fontsize=10];\n  Su_Subcst -> Su_Subcst1_op;\n  Su_Subcst1_op -> Su_Subcst1;\n\n  Si_Y0 [shape=box label=\"Si_Y0\" fontsize=10];\n  Si_Sigmoid [shape=box style=\"filled,rounded\" color=orange label=\"Sigmoid\n(Si_Sigmoid)\" fontsize=10];\n  Ne_Y0 -> Si_Sigmoid;\n  Si_Sigmoid -> Si_Y0;\n\n  Cl_output0 [shape=box label=\"Cl_output0\" fontsize=10];\n  Cl_Clip [shape=box style=\"filled,rounded\" color=orange label=\"Clip\n(Cl_Clip)\" fontsize=10];\n  Si_Y0 -> Cl_Clip;\n  Cl_Clipcst -> Cl_Clip;\n  Cl_Clipcst1 -> Cl_Clip;\n  Cl_Clip -> Cl_output0;\n\n  Su_C02 [shape=box label=\"Su_C02\" fontsize=10];\n  Su_Sub1 [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub1)\" fontsize=10];\n  Su_Subcst1 -> Su_Sub1;\n  Cl_output0 -> Su_Sub1;\n  Su_Sub1 -> Su_C02;\n\n  Lo_output02 [shape=box label=\"Lo_output02\" fontsize=10];\n  Lo_Log1 [shape=box style=\"filled,rounded\" color=orange label=\"Log\n(Lo_Log1)\" fontsize=10];\n  Cl_output0 -> Lo_Log1;\n  Lo_Log1 -> Lo_output02;\n\n  Lo_output0 [shape=box label=\"Lo_output0\" fontsize=10];\n  Lo_Log [shape=box style=\"filled,rounded\" color=orange label=\"Log\n(Lo_Log)\" fontsize=10];\n  Su_C02 -> Lo_Log;\n  Lo_Log -> Lo_output0;\n\n  Mu_C02 [shape=box label=\"Mu_C02\" fontsize=10];\n  Mu_Mul1 [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(Mu_Mul1)\" fontsize=10];\n  Y -> Mu_Mul1;\n  Lo_output02 -> Mu_Mul1;\n  Mu_Mul1 -> Mu_C02;\n\n  Mu_C0 [shape=box label=\"Mu_C0\" fontsize=10];\n  Mu_Mul [shape=box style=\"filled,rounded\" color=orange label=\"Mul\n(Mu_Mul)\" fontsize=10];\n  Su_C0 -> Mu_Mul;\n  Lo_output0 -> Mu_Mul;\n  Mu_Mul -> Mu_C0;\n\n  Ad_C0 [shape=box label=\"Ad_C0\" fontsize=10];\n  Ad_Add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(Ad_Add)\" fontsize=10];\n  Mu_C0 -> Ad_Add;\n  Mu_C02 -> Ad_Add;\n  Ad_Add -> Ad_C0;\n\n  Re_ReduceSum [shape=box style=\"filled,rounded\" color=orange label=\"ReduceSum\n(Re_ReduceSum)\nkeepdims=1\" fontsize=10];\n  Ad_C0 -> Re_ReduceSum;\n  Re_ReduceSum -> Re_reduced0;\n}");
document.getElementById('M2d0d58db6b5045b98be7dea255cbd74d').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">16.515068</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)]</span>
</pre></div>
</div>
<p>Same results.</p>
</section>
<section id="back-to-onnx-api">
<h3><a class="toc-backref" href="#id10">Back to onnx API</a><a class="headerlink" href="#back-to-onnx-api" title="Permalink to this headline">#</a></h3>
<p>Coding the previous graph would take too much time but it is still
possible to build it from the ONNX graph we just got.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.onnx_export</span> <span class="kn">import</span> <span class="n">export2onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.onnx_manipulations</span> <span class="kn">import</span> <span class="n">onnx_rename_names</span>
<span class="nb">print</span><span class="p">(</span><span class="n">export2onnx</span><span class="p">(</span><span class="n">onnx_rename_names</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>
</pre></div>
</div>
<pre class="literal-block">import numpy
from onnx import numpy_helper, TensorProto
from onnx.helper import (
    make_model, make_node, set_model_props, make_tensor, make_graph,
    make_tensor_value_info)

def create_model():
    '''
    Converted <code class="docutils literal notranslate"><span class="pre">OnnxReduceSum</span></code>.
    * producer: skl2onnx
    * version: 0
    * description:
    '''
    # subgraphs
    # containers
    print('[containers]')   # verbose
    initializers = []
    nodes = []
    inputs = []
    outputs = []
    # opsets
    print('[opsets]')   # verbose
    opsets = {'': 15}
    target_opset = 15  # subgraphs
    print('[subgraphs]')   # verbose
    # initializers
    print('[initializers]')   # verbose
    list_value = [1.0]
    value = numpy.array(list_value, dtype=numpy.float32)
    tensor = numpy_helper.from_array(value, name='i0')
    initializers.append(tensor)
    list_value = [9.999999974752427e-07]
    value = numpy.array(list_value, dtype=numpy.float32)
    tensor = numpy_helper.from_array(value, name='i1')
    initializers.append(tensor)
    list_value = [0.9999989867210388]
    value = numpy.array(list_value, dtype=numpy.float32)
    tensor = numpy_helper.from_array(value, name='i2')
    initializers.append(tensor)
    # inputs
    print('[inputs]')   # verbose
    value = make_tensor_value_info('Y', 1, [None])
    inputs.append(value)
    value = make_tensor_value_info('S', 1, [None])
    inputs.append(value)
    # outputs
    print('[outputs]')   # verbose
    value = make_tensor_value_info('Re_reduced0', 1, [1])
    outputs.append(value)
    # nodes
    print('[nodes]')   # verbose
    node = make_node(
        'Neg',
        ['S'],
        ['r0'],
        name='n0', domain='')
    nodes.append(node)
    node = make_node(
        'Sub',
        ['i0', 'Y'],
        ['r1'],
        name='n1', domain='')
    nodes.append(node)
    node = make_node(
        'Identity',
        ['i0'],
        ['r2'],
        name='n2', domain='')
    nodes.append(node)
    node = make_node(
        'Sigmoid',
        ['r0'],
        ['r3'],
        name='n3', domain='')
    nodes.append(node)
    node = make_node(
        'Clip',
        ['r3', 'i1', 'i2'],
        ['r4'],
        name='n4', domain='')
    nodes.append(node)
    node = make_node(
        'Sub',
        ['r2', 'r4'],
        ['r5'],
        name='n5', domain='')
    nodes.append(node)
    node = make_node(
        'Log',
        ['r4'],
        ['r6'],
        name='n6', domain='')
    nodes.append(node)
    node = make_node(
        'Log',
        ['r5'],
        ['r7'],
        name='n7', domain='')
    nodes.append(node)
    node = make_node(
        'Mul',
        ['Y', 'r6'],
        ['r8'],
        name='n8', domain='')
    nodes.append(node)
    node = make_node(
        'Mul',
        ['r1', 'r7'],
        ['r9'],
        name='n9', domain='')
    nodes.append(node)
    node = make_node(
        'Add',
        ['r9', 'r8'],
        ['r10'],
        name='n10', domain='')
    nodes.append(node)
    node = make_node(
        'ReduceSum',
        ['r10'],
        ['Re_reduced0'],
        name='n11', keepdims=1, domain='')
    nodes.append(node)
    # graph
    print('[graph]')   # verbose
    graph = make_graph(nodes, 'OnnxReduceSum', inputs, outputs, initializers)
    # '8'
    onnx_model = make_model(graph)
    onnx_model.ir_version = 8
    onnx_model.producer_name = 'skl2onnx'
    onnx_model.producer_version = ''
    onnx_model.domain = 'ai.onnx'
    onnx_model.model_version = 0
    onnx_model.doc_string = ''
    set_model_props(onnx_model, {})
    # opsets
    print('[opset]')   # verbose
    del onnx_model.opset_import[:]  # pylint: disable=E1101
    for dom, value in opsets.items():
        op_set = onnx_model.opset_import.add()
        op_set.domain = dom
        op_set.version = value
    return onnx_model

onnx_model = create_model()</pre>
</section>
<section id="numpy-to-onnx-with-numpy-api">
<h3><a class="toc-backref" href="#id11">numpy to onnx with numpy API</a><a class="headerlink" href="#numpy-to-onnx-with-numpy-api" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime&#39;</span><span class="p">,</span>
              <span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">((</span><span class="s2">&quot;T:all&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span> <span class="n">dtypes_out</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)),</span>
              <span class="n">op_version</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">onnx_log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>

    <span class="n">one</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">ceps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eps</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">ps</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">npnx</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">),</span> <span class="n">ceps</span><span class="p">,</span> <span class="n">one</span><span class="o">-</span><span class="n">ceps</span><span class="p">)</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="p">(</span><span class="n">one</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">one</span> <span class="o">-</span> <span class="n">ps</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">onnx_log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">16.515068</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onnx_log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">11.909897</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>The implementation is slightly different from the numpy implementation.
<code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">-</span> <span class="pre">y</span></code> cannot be used because 1 is an integer and the function needs
to know if it is a integer 32 or 64.
<code class="docutils literal notranslate"><span class="pre">numpy.array([1],</span> <span class="pre">dtype=s.dtype)</span> <span class="pre">-</span> <span class="pre">y</span></code> is better in this case to avoid
any ambiguity on the type of constant <code class="docutils literal notranslate"><span class="pre">1</span></code>. That may be revisited in
the future. The named argument is part of the ONNX graph as an
initializer. An new graph is generated every time the function sees a
new value. That explains why the following instructions cannot return
one ONNX graph as they are more than one:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">onnx_log_loss</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Unable to find signature with key=&lt;class &#39;numpy.float32&#39;&gt; among [FctVersion((numpy.float32,numpy.float32), (1e-06,)), FctVersion((numpy.float32,numpy.float32), (0.0001,))] found=[(FctVersion((numpy.float32,numpy.float32), (1e-06,)), &lt;mlprodict.npy.onnx_numpy_wrapper.onnxnumpy_np_onnx_log_loss_15_onnxruntime_float32_float32___1e-06 object at 0x00000231FC3134C0&gt;), (FctVersion((numpy.float32,numpy.float32), (0.0001,)), &lt;mlprodict.npy.onnx_numpy_wrapper.onnxnumpy_np_onnx_log_loss_15_onnxruntime_float32_float32___0_0001 object at 0x00000231FC313D90&gt;)].
</pre></div>
</div>
<p>Let’s see the list of available graphs:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">onnx_log_loss</span><span class="o">.</span><span class="n">signed_compiled</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">FctVersion</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-06</span><span class="p">,)),</span>
 <span class="n">FctVersion</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0001</span><span class="p">,))]</span>
</pre></div>
</div>
<p>Let’s pick the first one.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">FctVersion</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx_log_loss</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">FctVersion</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-06</span><span class="p">,)))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;s&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.e-06</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.999999</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_2&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Neg</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_neg_0</span>
  <span class="n">Sigmoid</span><span class="p">(</span><span class="n">out_neg_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sig_0</span>
    <span class="n">Clip</span><span class="p">(</span><span class="n">out_sig_0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cli_0</span>
      <span class="n">Sub</span><span class="p">(</span><span class="n">init_2</span><span class="p">,</span> <span class="n">out_cli_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
        <span class="n">Log</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_log_0_1</span>
      <span class="n">Log</span><span class="p">(</span><span class="n">out_cli_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_log_0</span>
        <span class="n">Mul</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">out_log_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
<span class="n">Sub</span><span class="p">(</span><span class="n">init_2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0_1</span>
  <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0_1</span><span class="p">,</span> <span class="n">out_log_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0_1</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">out_mul_0_1</span><span class="p">,</span> <span class="n">out_mul_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0</span>
      <span class="n">ReduceSum</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">z</span>
<span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;z&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="no-loss-but-lagg-something-difficult-to-write-with-onnx">
<h3><a class="toc-backref" href="#id12">no loss but lagg, something difficult to write with onnx</a><a class="headerlink" href="#no-loss-but-lagg-something-difficult-to-write-with-onnx" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime&#39;</span><span class="p">,</span>
              <span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">((</span><span class="s2">&quot;T:all&quot;</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtypes_out</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)))</span>
<span class="k">def</span> <span class="nf">lagged</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">lag</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">lag</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">lagged</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span> <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">18.</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">lagged</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_2&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>
<span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_4&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>
<span class="n">Shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sha_0</span>
  <span class="n">Gather</span><span class="p">(</span><span class="n">out_sha_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0</span>
    <span class="n">Slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">init_4</span><span class="p">,</span> <span class="n">out_gat_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_1</span>
<span class="n">Slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_2</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0</span>
  <span class="n">Sub</span><span class="p">(</span><span class="n">out_sli_0_1</span><span class="p">,</span> <span class="n">out_sli_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">y</span>
<span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> lagged.to_onnx(key=numpy.float32)
</pre></div>
</div>
<div id="Ma598e6dceddf42cca338f7f1fb636525-cont"><div id="Ma598e6dceddf42cca338f7f1fb636525" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n\n  x [shape=box color=red label=\"x\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\nint64((1,))\n[0]\" fontsize=10];\n  init_2 [shape=box label=\"init_2\nint64((1,))\n[-2]\" fontsize=10];\n  init_4 [shape=box label=\"init_4\nint64((1,))\n[2]\" fontsize=10];\n\n  out_sha_0 [shape=box label=\"out_sha_0\" fontsize=10];\n  _shape [shape=box style=\"filled,rounded\" color=orange label=\"Shape\n(_shape)\" fontsize=10];\n  x -> _shape;\n  _shape -> out_sha_0;\n\n  out_gat_0 [shape=box label=\"out_gat_0\" fontsize=10];\n  _gather [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather)\" fontsize=10];\n  out_sha_0 -> _gather;\n  init -> _gather;\n  _gather -> out_gat_0;\n\n  out_sli_0 [shape=box label=\"out_sli_0\" fontsize=10];\n  _slice [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice)\" fontsize=10];\n  x -> _slice;\n  init -> _slice;\n  init_2 -> _slice;\n  init -> _slice;\n  _slice -> out_sli_0;\n\n  out_sli_0_1 [shape=box label=\"out_sli_0_1\" fontsize=10];\n  _slice_1 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_1)\" fontsize=10];\n  x -> _slice_1;\n  init_4 -> _slice_1;\n  out_gat_0 -> _slice_1;\n  init -> _slice_1;\n  _slice_1 -> out_sli_0_1;\n\n  _sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(_sub)\" fontsize=10];\n  out_sli_0_1 -> _sub;\n  out_sli_0 -> _sub;\n  _sub -> y;\n}");
document.getElementById('Ma598e6dceddf42cca338f7f1fb636525').innerHTML = svgGraph; });

</script></section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="lightgbm_double.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Lightgbm, double, discrepencies</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="onnx_profile.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Memory usage</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>