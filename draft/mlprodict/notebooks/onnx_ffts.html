
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ONNX FFTs &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ONNX and FFT" href="onnx_fft.html" />
    <link rel="prev" title="Memory usage" href="onnx_profile.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   ONNX FFTs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#signature">
   Signature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numpy-implementation">
   Numpy implementation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmark">
   Benchmark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling">
   Profiling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#faster-dft-cst">
   Faster _dft_cst
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmark-again">
   Benchmark again
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cooleytukey-fft-algorithm">
   Cooley–Tukey FFT algorithm
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="onnx-ffts">
<span id="onnxfftsrst"></span><h1>ONNX FFTs<a class="headerlink" href="#onnx-ffts" title="Permalink to this headline">#</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/a871d5ec788055a01d860d6f251fadb2/onnx_ffts.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="onnx_ffts2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/31f93ca6c61d3bac4248d3806502bb1f/onnx_ffts.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/cbd0b85c58089e220198d4ab9f6247d0/onnx_ffts.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="onnx_ffts.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/onnx_ffts.ipynb">GitHub</a></p>
<p>Implementation of a couple of variations of FFT (see
<a class="reference external" href="https://www.tensorflow.org/xla/operation_semantics#fft">FFT</a> in
ONNX.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#signature" id="id1">Signature</a></p></li>
<li><p><a class="reference internal" href="#numpy-implementation" id="id2">Numpy implementation</a></p></li>
<li><p><a class="reference internal" href="#benchmark" id="id3">Benchmark</a></p></li>
<li><p><a class="reference internal" href="#profiling" id="id4">Profiling</a></p></li>
<li><p><a class="reference internal" href="#faster-dft-cst" id="id5">Faster _dft_cst</a></p></li>
<li><p><a class="reference internal" href="#benchmark-again" id="id6">Benchmark again</a></p></li>
<li><p><a class="reference internal" href="#cooleytukey-fft-algorithm" id="id7">Cooley–Tukey FFT algorithm</a></p></li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<section id="signature">
<h2><a class="toc-backref" href="#id1">Signature</a><a class="headerlink" href="#signature" title="Permalink to this headline">#</a></h2>
<p>We try to use function
<a class="reference external" href="https://www.tensorflow.org/xla/operation_semantics#fft">FFT</a> or
<a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.fft.fftn.html#torch.fft.fftn">torch.fft.fftn</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>

<span class="k">def</span> <span class="nf">numpy_fftn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements FFT</span>

<span class="sd">    :param x: input</span>
<span class="sd">    :param fft_type: string (see below)</span>
<span class="sd">    :param fft_length: length on each axis of axes</span>
<span class="sd">    :param axes: axes</span>
<span class="sd">    :return: result</span>

<span class="sd">    * `&#39;FFT`&#39;: complex-to-complex FFT. Shape is unchanged.</span>
<span class="sd">    * `&#39;IFFT`&#39;: Inverse complex-to-complex FFT. Shape is unchanged.</span>
<span class="sd">    * `&#39;RFFT`&#39;: Forward real-to-complex FFT.</span>
<span class="sd">      Shape of the innermost axis is reduced to fft_length[-1] // 2 + 1 if fft_length[-1]</span>
<span class="sd">      is a non-zero value, omitting the reversed conjugate part of</span>
<span class="sd">      the transformed signal beyond the Nyquist frequency.</span>
<span class="sd">    * `&#39;IRFFT`&#39;: Inverse real-to-complex FFT (ie takes complex, returns real).</span>
<span class="sd">      Shape of the innermost axis is expanded to fft_length[-1] if fft_length[-1]</span>
<span class="sd">      is a non-zero value, inferring the part of the transformed signal beyond the Nyquist</span>
<span class="sd">      frequency from the reverse conjugate of the 1 to fft_length[-1] // 2 + 1 entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fft_type</span> <span class="o">==</span> <span class="s1">&#39;FFT&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented for fft_type=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">fft_type</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_fct</span><span class="p">(</span><span class="n">fct1</span><span class="p">,</span> <span class="n">fct2</span><span class="p">,</span> <span class="n">fft_type</span><span class="o">=</span><span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">cases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">[[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span>
    <span class="n">lengths_axes</span> <span class="o">=</span> <span class="p">[([</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">),</span> <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">),</span> <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="n">n_test</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ndim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">length</span><span class="p">,</span> <span class="n">axes</span> <span class="ow">in</span> <span class="n">lengths_axes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
                <span class="n">di</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[:</span><span class="n">ndim</span><span class="p">]</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">di</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
                <span class="n">le</span> <span class="o">=</span> <span class="n">length</span><span class="p">[:</span><span class="n">ndim</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">fct1</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to run </span><span class="si">%r</span><span class="s2"> mat.shape=</span><span class="si">%r</span><span class="s2"> ndim=</span><span class="si">%r</span><span class="s2"> di=</span><span class="si">%r</span><span class="s2"> fft_type=</span><span class="si">%r</span><span class="s2"> le=</span><span class="si">%r</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;axes=</span><span class="si">%r</span><span class="s2"> exc=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span>
                            <span class="n">fct1</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">fct2</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="s2">&quot;Failure mat.shape=</span><span class="si">%r</span><span class="s2">, fft_type=</span><span class="si">%r</span><span class="s2">, fft_length=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">le</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>
                <span class="n">n_test</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">n_test</span>


<span class="n">test_fct</span><span class="p">(</span><span class="n">numpy_fftn</span><span class="p">,</span> <span class="n">numpy_fftn</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1302</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -n 1 -r 1 test_fct(numpy_fftn, numpy_fftn)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.81 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">torch_fftn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="n">xt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fft_type</span> <span class="o">==</span> <span class="s1">&#39;FFT&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="o">%</span><span class="k">timeit</span> -n 1 -r 1 test_fct(numpy_fftn, torch_fftn)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2.07 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
</section>
<section id="numpy-implementation">
<h2><a class="toc-backref" href="#id2">Numpy implementation</a><a class="headerlink" href="#numpy-implementation" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>


<span class="k">def</span> <span class="nf">_dft_cst</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_arange</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">resh</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">resh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="n">fft_length</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_exp</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">_arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">_arange</span><span class="p">(</span><span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">_exp</span><span class="p">(</span><span class="n">_prod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span>


<span class="k">def</span> <span class="nf">custom_fft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dft_fct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># https://github.com/numpy/numpy/blob/4adc87dff15a247e417d50f10cc4def8e1c17a03/numpy/fft/_pocketfft.py#L56</span>
    <span class="k">if</span> <span class="n">dft_fct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dft_fct</span> <span class="o">=</span> <span class="n">_dft_cst</span>
    <span class="k">if</span> <span class="n">fft_type</span> <span class="o">==</span> <span class="s1">&#39;FFT&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="c1"># fft_length &gt; shape on the same axis</span>
            <span class="c1"># the matrix is shortened</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">slices</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># other, the matrix is completed with zeros</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">slices</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
            <span class="n">zeros</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">zeros</span>

        <span class="n">cst</span> <span class="o">=</span> <span class="n">dft_fct</span><span class="p">(</span><span class="n">new_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">length</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">==</span> <span class="n">perm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">cst</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">new_x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">cst</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected value for fft_type=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">fft_type</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_fftn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">dft_fct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fft_length</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length mismatch axes=</span><span class="si">%r</span><span class="s2">, fft_length=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
           <span class="n">axes</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fft_type</span> <span class="o">==</span> <span class="s1">&#39;FFT&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fft_length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">fft_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">custom_fft</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dft_fct</span><span class="o">=</span><span class="n">dft_fct</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected value for fft_type=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">fft_type</span><span class="p">)</span>


<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">)</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,]</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
<span class="n">custom_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span> <span class="n">numpy_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">custom_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span>
                    <span class="n">numpy_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
<span class="n">custom_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span> <span class="n">numpy_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">custom_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span>
                    <span class="n">numpy_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -n 1 -r 1 test_fct(numpy_fftn, custom_fftn, decimal=4)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2.35 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
</section>
<section id="benchmark">
<h2><a class="toc-backref" href="#id3">Benchmark</a><a class="headerlink" href="#benchmark" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cpyquickhelper.numbers.speed_measure</span> <span class="kn">import</span> <span class="n">measure_time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>

<span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">fcts</span><span class="p">,</span> <span class="n">power2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">power2</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lengths</span><span class="p">):</span>
        <span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">length</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fct</span> <span class="ow">in</span> <span class="n">fcts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">fct</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span>
                               <span class="n">repeat</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">({</span><span class="s1">&#39;numpy_fftn&#39;</span><span class="p">:</span> <span class="n">numpy_fftn</span><span class="p">,</span> <span class="s1">&#39;custom_fftn&#39;</span><span class="p">:</span> <span class="n">custom_fftn</span><span class="p">,</span> <span class="s1">&#39;torch_fftn&#39;</span><span class="p">:</span> <span class="n">torch_fftn</span><span class="p">})</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
<span class="n">piv</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 24/24 [00:06&lt;00:00,  3.91it/s]
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>custom_fftn</th>
      <th>numpy_fftn</th>
      <th>torch_fftn</th>
    </tr>
    <tr>
      <th>length</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>0.000585</td>
      <td>0.000911</td>
      <td>0.003643</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.001669</td>
      <td>0.001373</td>
      <td>0.004087</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.002682</td>
      <td>0.003273</td>
      <td>0.005745</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.004288</td>
      <td>0.003275</td>
      <td>0.004657</td>
    </tr>
    <tr>
      <th>40</th>
      <td>0.004818</td>
      <td>0.003831</td>
      <td>0.005198</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;FFT benchmark&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../_images/onnx_ffts_13_0.png" src="../_images/onnx_ffts_13_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">({</span><span class="s1">&#39;numpy_fftn&#39;</span><span class="p">:</span> <span class="n">numpy_fftn</span><span class="p">,</span> <span class="s1">&#39;custom_fftn&#39;</span><span class="p">:</span> <span class="n">custom_fftn</span><span class="p">,</span> <span class="s1">&#39;torch_fftn&#39;</span><span class="p">:</span> <span class="n">torch_fftn</span><span class="p">},</span>
              <span class="n">power2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
<span class="n">piv</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10/10 [00:13&lt;00:00,  1.33s/it]
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>custom_fftn</th>
      <th>numpy_fftn</th>
      <th>torch_fftn</th>
    </tr>
    <tr>
      <th>length</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>0.000434</td>
      <td>0.001167</td>
      <td>0.023980</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.001117</td>
      <td>0.001671</td>
      <td>0.022530</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.001428</td>
      <td>0.002077</td>
      <td>0.022102</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.004654</td>
      <td>0.002874</td>
      <td>0.019792</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.003172</td>
      <td>0.002689</td>
      <td>0.017474</td>
    </tr>
    <tr>
      <th>64</th>
      <td>0.006966</td>
      <td>0.004612</td>
      <td>0.018116</td>
    </tr>
    <tr>
      <th>128</th>
      <td>0.030904</td>
      <td>0.011608</td>
      <td>0.023369</td>
    </tr>
    <tr>
      <th>256</th>
      <td>0.123821</td>
      <td>0.025853</td>
      <td>0.023532</td>
    </tr>
    <tr>
      <th>512</th>
      <td>0.476802</td>
      <td>0.043352</td>
      <td>0.033228</td>
    </tr>
    <tr>
      <th>1024</th>
      <td>1.527917</td>
      <td>0.109868</td>
      <td>0.052858</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;FFT benchmark (power2)&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../_images/onnx_ffts_15_0.png" src="../_images/onnx_ffts_15_0.png" />
</section>
<section id="profiling">
<h2><a class="toc-backref" href="#id4">Profiling</a><a class="headerlink" href="#profiling" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile2graph</span><span class="p">,</span> <span class="n">profile</span>

<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">custom_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

<span class="n">stat</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">gr</span> <span class="o">=</span> <span class="n">profile2graph</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">fct_width</span><span class="o">=</span><span class="mi">40</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span>                                        <span class="o">--</span>    <span class="mi">1</span>    <span class="mi">1</span> <span class="o">--</span> <span class="mf">0.01752</span> <span class="mf">0.54515</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">81</span><span class="o">-</span><span class="mi">3</span><span class="n">ee1763130c2</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">f</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">custom_fftn</span>                          <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00234</span> <span class="mf">0.52763</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">85</span><span class="n">a4c9f552d3</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="n">custom_fftn</span> <span class="p">(</span><span class="n">custom_fftn</span><span class="p">)</span>
        <span class="n">custom_fft</span>                       <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.19936</span> <span class="mf">0.52516</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">85</span><span class="n">a4c9f552d3</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="n">custom_fft</span> <span class="p">(</span><span class="n">custom_fft</span><span class="p">)</span>
            <span class="n">_dft_cst</span>                     <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.31917</span> <span class="mf">0.32366</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">61</span><span class="o">-</span><span class="n">afe90fb073f9</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="n">_dft_cst</span> <span class="p">(</span><span class="n">_dft_cst</span><span class="p">)</span>
                <span class="n">_arange</span>                  <span class="o">--</span>  <span class="mi">200</span>  <span class="mi">200</span> <span class="o">--</span> <span class="mf">0.00088</span> <span class="mf">0.00449</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">61</span><span class="o">-</span><span class="n">afe90fb073f9</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="n">_arange</span> <span class="p">(</span><span class="n">_arange</span><span class="p">)</span>
                    <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;...objects&gt; --  200  200 -- 0.00128 0.00128 -- ~:0:&lt;method &#39;</span><span class="n">astype</span><span class="s1">&#39; of &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s1">&#39; objects&gt; (&lt;method &#39;</span><span class="n">astype</span><span class="s1">&#39; of &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s1">&#39; objects&gt;)</span>
                    <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;...objects&gt; --  200  200 -- 0.00064 0.00064 -- ~:0:&lt;method &#39;</span><span class="n">reshape</span><span class="s1">&#39; of &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s1">&#39; objects&gt; (&lt;method &#39;</span><span class="n">reshape</span><span class="s1">&#39; of &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s1">&#39; objects&gt;)</span>
                    <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="o">....</span><span class="n">arange</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">200</span>  <span class="mi">200</span> <span class="o">--</span> <span class="mf">0.00169</span> <span class="mf">0.00169</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">uiltins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00011</span> <span class="mf">0.00011</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
            <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;toli...ay&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00024</span> <span class="mf">0.00024</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;tolist&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;tolist&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;tran...ay&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00076</span> <span class="mf">0.00076</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;transpose&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;transpose&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">umpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00102</span> <span class="mf">0.00102</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
        <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>   <span class="o">--</span>  <span class="mi">300</span>  <span class="mi">300</span> <span class="o">--</span> <span class="mf">0.00013</span> <span class="mf">0.00013</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
<span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>           <span class="o">--</span>  <span class="mi">400</span>  <span class="mi">400</span> <span class="o">--</span> <span class="mf">0.00024</span> <span class="mf">0.00024</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span>           <span class="o">--</span>  <span class="mi">300</span>  <span class="mi">300</span> <span class="o">--</span> <span class="mf">0.00271</span> <span class="mf">0.00271</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can see that function <code class="docutils literal notranslate"><span class="pre">_dft_cst</span></code> is the bottle neck and more
precisely the exponential. We need to use the symmetries of the matrix
it builds.</p>
</section>
<section id="faster-dft-cst">
<h2><a class="toc-backref" href="#id5">Faster _dft_cst</a><a class="headerlink" href="#faster-dft-cst" title="Permalink to this headline">#</a></h2>
<p>The function builds the matrix
<img class="math" src="../_images/math/f017ce09d8695103f020f9c98e090af5f047168e.svg" alt="M_{nk} = \left( \exp\left(\frac{-2i\pi nk}{K}\right) \right)_{nk}"/>
where <img class="math" src="../_images/math/fe427df8dcec05af1a5e36f3437db727d2faa99a.svg" alt="1 \leqslant n \leqslant N"/> and
<img class="math" src="../_images/math/f59e9af3d950bb5a3a31ed822edae0ae80a07272.svg" alt="1 \leqslant k \leqslant K"/>. So it computes powers of the unity
roots.</p>
<div class="math">
<p><img src="../_images/math/b9d9a8ae931fb849b48af37cdb512ee8a0153c57.svg" alt="\exp\left(\frac{-2i\pi nk}{K}\right) = \exp\left(\frac{-2i\pi k}{K}\right)^n = \exp\left(\frac{-2i\pi}{K}\right)^{nk}"/></p>
</div><p>We use that expression to reduce the number of exponentiels to compute.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>

<span class="k">def</span> <span class="nf">_dft_cst</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_arange</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">resh</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">resh</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">_arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">_arange</span><span class="p">(</span><span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="n">fft_length</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span>


<span class="n">M</span> <span class="o">=</span> <span class="n">_dft_cst</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;complex64&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">_dft_cst</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;complex128&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">2.44929360e-16</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">4.89858720e-16</span><span class="n">j</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_dft_cst_power</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex64</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ctype</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">fft_length</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="p">))</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">root</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">current</span> <span class="o">*=</span> <span class="n">root</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">out</span><span class="o">=</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">M_pow</span> <span class="o">=</span> <span class="n">_dft_cst_power</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">M_pow</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">8.66025404e-01</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span> <span class="o">+</span><span class="mf">0.00000000e+00</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">6.10622664e-16</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.</span> <span class="o">+</span><span class="mf">1.22124533e-15</span><span class="n">j</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">M_pow</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">_dft_cst</span><span class="p">(</span><span class="o">*</span><span class="n">dims</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="n">_dft_cst_power</span><span class="p">(</span><span class="o">*</span><span class="n">dims</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="n">decimal</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="benchmark-again">
<h2><a class="toc-backref" href="#id6">Benchmark again</a><a class="headerlink" href="#benchmark-again" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_fftn_power</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">custom_fftn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dft_fct</span><span class="o">=</span><span class="n">_dft_cst_power</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="o">%</span><span class="k">timeit</span> -r 1 -n 1 test_fct(numpy_fftn, custom_fftn_power, decimal=4)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.46 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">({</span>
    <span class="s1">&#39;numpy_fftn&#39;</span><span class="p">:</span> <span class="n">numpy_fftn</span><span class="p">,</span> <span class="s1">&#39;torch_fftn&#39;</span><span class="p">:</span> <span class="n">torch_fftn</span><span class="p">,</span> <span class="s1">&#39;custom_fftn&#39;</span><span class="p">:</span> <span class="n">custom_fftn</span><span class="p">,</span>
    <span class="s1">&#39;custom_fftn_power&#39;</span><span class="p">:</span> <span class="n">custom_fftn_power</span><span class="p">})</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
<span class="n">piv</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 24/24 [00:07&lt;00:00,  3.19it/s]
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>custom_fftn</th>
      <th>custom_fftn_power</th>
      <th>numpy_fftn</th>
      <th>torch_fftn</th>
    </tr>
    <tr>
      <th>length</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>0.000991</td>
      <td>0.000837</td>
      <td>0.001177</td>
      <td>0.007033</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.002758</td>
      <td>0.002591</td>
      <td>0.002069</td>
      <td>0.006228</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.003087</td>
      <td>0.002816</td>
      <td>0.002499</td>
      <td>0.005564</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.003767</td>
      <td>0.003068</td>
      <td>0.003306</td>
      <td>0.005985</td>
    </tr>
    <tr>
      <th>40</th>
      <td>0.004710</td>
      <td>0.003975</td>
      <td>0.004044</td>
      <td>0.005733</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;FFT benchmark 2&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../_images/onnx_ffts_29_0.png" src="../_images/onnx_ffts_29_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile2graph</span><span class="p">,</span> <span class="n">profile</span>

<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">custom_fftn_power</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

<span class="n">stat</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">gr</span> <span class="o">=</span> <span class="n">profile2graph</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">fct_width</span><span class="o">=</span><span class="mi">40</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span>                                        <span class="o">--</span>    <span class="mi">1</span>    <span class="mi">1</span> <span class="o">--</span> <span class="mf">0.02624</span> <span class="mf">0.57688</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">92</span><span class="o">-</span><span class="mi">112</span><span class="n">d00957d81</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">f</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">custom_fftn_power</span>                    <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00094</span> <span class="mf">0.55064</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">88</span><span class="o">-</span><span class="n">b403af8c0b43</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">custom_fftn_power</span> <span class="p">(</span><span class="n">custom_fftn_power</span><span class="p">)</span>
        <span class="n">custom_fftn</span>                      <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00609</span> <span class="mf">0.54970</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">85</span><span class="n">a4c9f552d3</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="n">custom_fftn</span> <span class="p">(</span><span class="n">custom_fftn</span><span class="p">)</span>
            <span class="n">custom_fft</span>                   <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.46378</span> <span class="mf">0.54342</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">85</span><span class="n">a4c9f552d3</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="n">custom_fft</span> <span class="p">(</span><span class="n">custom_fft</span><span class="p">)</span>
                <span class="n">_dft_cst_power</span>           <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.07599</span> <span class="mf">0.07726</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">85</span><span class="o">-</span><span class="mi">8502</span><span class="n">f1ddbe1f</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">_dft_cst_power</span> <span class="p">(</span><span class="n">_dft_cst_power</span><span class="p">)</span>
                    <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="o">...</span><span class="n">y</span><span class="o">.</span><span class="n">empty</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00126</span> <span class="mf">0.00126</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="o">&gt;</span><span class="p">)</span>
                <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">m</span><span class="o">...</span><span class="n">ltins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00008</span> <span class="mf">0.00008</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
                <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;to...&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00025</span> <span class="mf">0.00025</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;tolist&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;tolist&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">)</span>
                <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;tr...&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00096</span> <span class="mf">0.00096</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;transpose&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;transpose&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">)</span>
                <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">m</span><span class="o">...</span><span class="n">py</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">100</span>  <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00109</span> <span class="mf">0.00109</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="o">&gt;</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">uiltins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">300</span>  <span class="mi">300</span> <span class="o">--</span> <span class="mf">0.00020</span> <span class="mf">0.00020</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
<span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>           <span class="o">--</span>  <span class="mi">400</span>  <span class="mi">400</span> <span class="o">--</span> <span class="mf">0.00027</span> <span class="mf">0.00027</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cooleytukey-fft-algorithm">
<h2><a class="toc-backref" href="#id7">Cooley–Tukey FFT algorithm</a><a class="headerlink" href="#cooleytukey-fft-algorithm" title="Permalink to this headline">#</a></h2>
<p>See <a class="reference external" href="https://en.wikipedia.org/wiki/Cooley%E2%80%93Tukey_FFT_algorithm">Cooley–Tukey FFT
algorithm</a>.</p>
<p>The FFT matrix is defined by the matrix computation
<img class="math" src="../_images/math/950efec988e00e7709c865f03414eb8e63c2f1ff.svg" alt="F_{ak} = X_{an} M_{nk}"/>, then one coefficient is
(<img class="math" src="../_images/math/f9bd0a03d69eb05eadbebd20ec305ec920bac097.svg" alt="1 \leqslant n, k \leqslant K"/>):</p>
<div class="math">
<p><img src="../_images/math/9b7a9c893edc951d4812302f77ca7fe7c6a3f112.svg" alt="F_{ak} = \sum_n X_{an} M_{nk} = \sum_n X_{an} \exp\left(\frac{-2i\pi}{K}\right)^{nk}"/></p>
</div><p>Let’s assume K is even, then
<img class="math" src="../_images/math/d20f8288f3dfafec4b1d1df6bc7b9372a4d85d0b.svg" alt="\exp\left(\frac{-2i\pi k}{K}\right) = -\exp\left(\frac{-2i\pi \left(k + \frac{K}{2}\right)}{K}\right)"/>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">);</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;exp(-2pi </span><span class="si">%d</span><span class="s2">/12)&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;unit roots&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_ffts_32_0.png" src="../_images/onnx_ffts_32_0.png" />
<p>Then:</p>
<div class="math">
<p><img src="../_images/math/08ad99a6d11823841e3c69f9426685a51d162762.svg" alt="\begin{array}{rcl}
F_{a,k + \frac{K}{2}} &amp;=&amp; \sum_{n=1}^{N} X_{an} \exp\left(\frac{-2i\pi}{K}\right)^{n\left(k + \frac{K}{2}\right)} \\
&amp;=&amp;\sum_{n=1}^{N} X_{an} (-1)^n \exp\left(\frac{-2i\pi}{K}\right)^{nk} \\
&amp;=&amp;\sum_{m=1}^{\frac{N}{2}} X_{a,2m} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} - \sum_{m=1}^{\frac{N}{2}} X_{a,2m-1} \exp\left(\frac{-2i\pi}{K}\right)^{(2m-1)k} \\
&amp;=&amp;\sum_{m=1}^{\frac{N}{2}} X_{a,2m} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} - \sum_{m=1}^{\frac{N}{2}} X_{a,2m-1} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} \exp\left(\frac{-2i\pi}{K}\right)^{-k}
\end{array}"/></p>
</div><p>Then:</p>
<div class="math">
<p><img src="../_images/math/693edcbdd44aedc96b00410f131534c5a7832550.svg" alt="\begin{array}{rcl}
F_{a,k} + F_{a,k+\frac{K}{2}} &amp;=&amp; 2\sum_{m=1}^{\frac{N}{2}} X_{a,2m}  \exp\left(\frac{-2i\pi}{K}\right)^{2mk}
= 2\sum_{m=1}^{\frac{N}{2}} X_{a,2m}  \exp\left(\frac{-2i\pi}{\frac{K}{2}}\right)^{mk}
\end{array}"/></p>
</div><p>Finally:</p>
<div class="math">
<p><img src="../_images/math/f53515d76d6075948c3009d3905d2142da6c74b4.svg" alt="\begin{array}{rcl}
F_{a,k} &amp;=&amp; \sum_{m=1}^{\frac{N}{2}} X_{a,2m} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} + \sum_{m=1}^{\frac{N}{2}} X_{a,2m-1} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} \exp\left(\frac{-2i\pi}{K}\right)^{-k} \\
F_{a,k + \frac{K}{2}} &amp;=&amp;\sum_{m=1}^{\frac{N}{2}} X_{a,2m} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} - \sum_{m=1}^{\frac{N}{2}} X_{a,2m-1} \exp\left(\frac{-2i\pi}{K}\right)^{2mk} \exp\left(\frac{-2i\pi}{K}\right)^{-k}
\end{array}"/></p>
</div><p>Now, what happen when <em>K</em> is odd, fallback to the original computation.</p>
<div class="math">
<p><img src="../_images/math/9b7a9c893edc951d4812302f77ca7fe7c6a3f112.svg" alt="F_{ak} = \sum_n X_{an} M_{nk} = \sum_n X_{an} \exp\left(\frac{-2i\pi}{K}\right)^{nk}"/></p>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">cooley_fft_2p</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="n">cst</span> <span class="o">=</span> <span class="n">_dft_cst_power</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cst</span><span class="p">)</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span> <span class="nf">_build_fact</span><span class="p">(</span><span class="n">p2_2</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="n">fact</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">p2_2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p2_2</span><span class="p">):</span>
        <span class="n">fact</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fact</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">first</span>
    <span class="k">return</span> <span class="n">fact</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">build_fact</span><span class="p">(</span><span class="n">p2_2</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_build_fact</span><span class="p">(</span><span class="n">p2_2</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cooley_fft_recursive</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Unexpected x.shape=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex64</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fft_length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">even</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">odd</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">even</span><span class="p">,</span> <span class="n">odd</span>

        <span class="k">def</span> <span class="nf">tmp1</span><span class="p">(</span><span class="n">even</span><span class="p">,</span> <span class="n">odd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
            <span class="n">p2_2</span> <span class="o">=</span> <span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">fft_even</span> <span class="o">=</span> <span class="n">cooley_fft_recursive</span><span class="p">(</span><span class="n">even</span><span class="p">,</span> <span class="n">p2_2</span><span class="p">)</span>
            <span class="n">fft_odd</span> <span class="o">=</span> <span class="n">cooley_fft_recursive</span><span class="p">(</span><span class="n">odd</span><span class="p">,</span> <span class="n">p2_2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fft_even</span><span class="p">,</span> <span class="n">fft_odd</span><span class="p">,</span> <span class="n">p2_2</span>

        <span class="k">def</span> <span class="nf">tmp2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_even</span><span class="p">,</span> <span class="n">fft_odd</span><span class="p">,</span> <span class="n">p2_2</span><span class="p">):</span>
            <span class="n">fact</span> <span class="o">=</span> <span class="n">build_fact</span><span class="p">(</span><span class="n">p2_2</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">fft_even</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="n">fact_odd</span> <span class="o">=</span> <span class="n">fft_odd</span> <span class="o">*</span> <span class="n">fact</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">fft_even</span> <span class="o">+</span> <span class="n">fact_odd</span><span class="p">,</span> <span class="n">fft_even</span> <span class="o">-</span> <span class="n">fact_odd</span><span class="p">])</span>

            <span class="c1"># inplace</span>
            <span class="c1"># result = numpy.empty((x.shape[0], fft_length), dtype=fft_even.dtype)</span>
            <span class="c1"># numpy.multiply(fft_odd, fact, out=result[:, :p2_2])</span>
            <span class="c1"># numpy.subtract(fft_even, result[:, :p2_2], out=result[:, p2_2:])</span>
            <span class="c1"># numpy.add(fft_even, result[:, :p2_2], out=result[:, :p2_2])</span>
            <span class="c1"># return result</span>

        <span class="n">even</span><span class="p">,</span> <span class="n">odd</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">fft_even</span><span class="p">,</span> <span class="n">fft_odd</span><span class="p">,</span> <span class="n">p2_2</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">(</span><span class="n">even</span><span class="p">,</span> <span class="n">odd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_even</span><span class="p">,</span> <span class="n">fft_odd</span><span class="p">,</span> <span class="n">p2_2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cooley_fft_2p</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>



<span class="k">def</span> <span class="nf">cooley_fft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cooley_fft_recursive</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_fft_cooley</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="c1"># https://github.com/numpy/numpy/blob/4adc87dff15a247e417d50f10cc4def8e1c17a03/numpy/fft/_pocketfft.py#L56</span>
    <span class="k">if</span> <span class="n">fft_type</span> <span class="o">==</span> <span class="s1">&#39;FFT&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="c1"># fft_length &gt; shape on the same axis</span>
            <span class="c1"># the matrix is shortened</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">slices</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># other, the matrix is completed with zeros</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">slices</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
            <span class="n">zeros</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">zeros</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">xt</span> <span class="o">=</span> <span class="n">new_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xt</span> <span class="o">=</span> <span class="n">new_x</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cooley_fft</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">new_x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cooley_fft</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected value for fft_type=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">fft_type</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_fftn_cooley</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fft_length</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length mismatch axes=</span><span class="si">%r</span><span class="s2">, fft_length=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
           <span class="n">axes</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fft_type</span> <span class="o">==</span> <span class="s1">&#39;FFT&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fft_length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">fft_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">custom_fft_cooley</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fft_type</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected value for fft_type=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">fft_type</span><span class="p">)</span>


<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">)</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,]</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">custom_fftn_cooley</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span>
                    <span class="n">numpy_fftn</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">),</span>
                    <span class="n">decimal</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> -n 1 -r 1 test_fct(numpy_fftn, custom_fftn_cooley)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.5 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">({</span>
    <span class="s1">&#39;numpy_fftn&#39;</span><span class="p">:</span> <span class="n">numpy_fftn</span><span class="p">,</span> <span class="s1">&#39;torch_fftn&#39;</span><span class="p">:</span> <span class="n">torch_fftn</span><span class="p">,</span>
    <span class="s1">&#39;custom_fftn_power&#39;</span><span class="p">:</span> <span class="n">custom_fftn_power</span><span class="p">,</span> <span class="s1">&#39;custom_fftn_cooley&#39;</span><span class="p">:</span> <span class="n">custom_fftn_cooley</span><span class="p">})</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
<span class="n">piv</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 24/24 [00:10&lt;00:00,  2.35it/s]
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>custom_fftn_cooley</th>
      <th>custom_fftn_power</th>
      <th>numpy_fftn</th>
      <th>torch_fftn</th>
    </tr>
    <tr>
      <th>length</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>0.002873</td>
      <td>0.000685</td>
      <td>0.001482</td>
      <td>0.005463</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.007197</td>
      <td>0.002121</td>
      <td>0.001922</td>
      <td>0.005063</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.009443</td>
      <td>0.002903</td>
      <td>0.002739</td>
      <td>0.005169</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.012783</td>
      <td>0.002556</td>
      <td>0.002003</td>
      <td>0.004076</td>
    </tr>
    <tr>
      <th>40</th>
      <td>0.014142</td>
      <td>0.003916</td>
      <td>0.003937</td>
      <td>0.005118</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;FFT benchmark 3&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../_images/onnx_ffts_37_0.png" src="../_images/onnx_ffts_37_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">({</span>
    <span class="s1">&#39;numpy_fftn&#39;</span><span class="p">:</span> <span class="n">numpy_fftn</span><span class="p">,</span> <span class="s1">&#39;torch_fftn&#39;</span><span class="p">:</span> <span class="n">torch_fftn</span><span class="p">,</span>
    <span class="s1">&#39;custom_fftn_power&#39;</span><span class="p">:</span> <span class="n">custom_fftn_power</span><span class="p">,</span> <span class="s1">&#39;custom_fftn_cooley&#39;</span><span class="p">:</span> <span class="n">custom_fftn_cooley</span><span class="p">},</span>
    <span class="n">power2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
<span class="n">piv</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10/10 [00:11&lt;00:00,  1.15s/it]
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>custom_fftn_cooley</th>
      <th>custom_fftn_power</th>
      <th>numpy_fftn</th>
      <th>torch_fftn</th>
    </tr>
    <tr>
      <th>length</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>0.000575</td>
      <td>0.000471</td>
      <td>0.000722</td>
      <td>0.019371</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.001153</td>
      <td>0.000328</td>
      <td>0.001130</td>
      <td>0.018366</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.003678</td>
      <td>0.000624</td>
      <td>0.001779</td>
      <td>0.019295</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.006843</td>
      <td>0.002255</td>
      <td>0.002192</td>
      <td>0.020169</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.015574</td>
      <td>0.003045</td>
      <td>0.002736</td>
      <td>0.017193</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;FFT benchmark 3 (power2)&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../_images/onnx_ffts_39_0.png" src="../_images/onnx_ffts_39_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile2graph</span><span class="p">,</span> <span class="n">profile</span>

<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">]</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">custom_fftn_cooley</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="s1">&#39;FFT&#39;</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

<span class="n">stat</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">gr</span> <span class="o">=</span> <span class="n">profile2graph</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">fct_width</span><span class="o">=</span><span class="mi">40</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cooley_fft_recursive</span>                     <span class="o">--</span>    <span class="mi">100</span>  <span class="mi">51100</span> <span class="o">--</span> <span class="mf">0.24497</span> <span class="mf">2.68339</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="n">cooley_fft_recursive</span> <span class="p">(</span><span class="n">cooley_fft_recursive</span><span class="p">)</span>
    <span class="n">split</span>                                <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.06264</span> <span class="mf">0.06264</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="n">split</span> <span class="p">(</span><span class="n">split</span><span class="p">)</span>
    <span class="n">tmp1</span>                                 <span class="o">--</span>    <span class="mi">100</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.09438</span> <span class="mf">2.54540</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="n">tmp1</span> <span class="p">(</span><span class="n">tmp1</span><span class="p">)</span>
        <span class="n">cooley_fft_recursive</span>             <span class="o">--</span>  <span class="mi">51000</span>    <span class="mi">200</span> <span class="o">--</span> <span class="mf">0.24336</span> <span class="mf">2.54421</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="n">cooley_fft_recursive</span> <span class="p">(</span><span class="n">cooley_fft_recursive</span><span class="p">)</span> <span class="o">+++</span>
    <span class="n">tmp2</span>                                 <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.95948</span> <span class="mf">2.04473</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="n">tmp2</span> <span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
        <span class="n">hstack</span>                           <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.04799</span> <span class="mf">1.05776</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">__array_function__</span> <span class="n">internals</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">177</span><span class="p">:</span><span class="n">hstack</span> <span class="p">(</span><span class="n">hstack</span><span class="p">)</span>
            <span class="n">_vhstack_dispatcher</span>          <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.02712</span> <span class="mf">0.07002</span> <span class="o">--</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Python395_x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">shape_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">218</span><span class="p">:</span><span class="n">_vhstack_dispatcher</span> <span class="p">(</span><span class="n">_vhstack_dispatcher</span><span class="p">)</span>
                <span class="n">_arrays_for</span><span class="o">...</span><span class="n">dispatcher</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.02361</span> <span class="mf">0.04290</span> <span class="o">--</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Python395_x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">shape_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">207</span><span class="p">:</span><span class="n">_arrays_for_stack_dispatcher</span> <span class="p">(</span><span class="n">_arrays_for_stack_dispatcher</span><span class="p">)</span>
                    <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="o">...</span><span class="n">hasattr</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.01929</span> <span class="mf">0.01929</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">hasattr</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">hasattr</span><span class="o">&gt;</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">ay_function</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.03753</span> <span class="mf">0.93975</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
        <span class="n">build_fact</span>                       <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.02749</span> <span class="mf">0.02749</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="n">build_fact</span> <span class="p">(</span><span class="n">build_fact</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>       <span class="o">--</span>  <span class="mi">51100</span>  <span class="mi">51100</span> <span class="o">--</span> <span class="mf">0.01521</span> <span class="mf">0.01521</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
    <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;astype&#39;</span> <span class="o">...</span><span class="n">darray</span><span class="s1">&#39; objects&gt; --  25600  25600 -- 0.22146 0.22146 -- ~:0:&lt;method &#39;</span><span class="n">astype</span><span class="s1">&#39; of &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s1">&#39; objects&gt; (&lt;method &#39;</span><span class="n">astype</span><span class="s1">&#39; of &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s1">&#39; objects&gt;)</span>
<span class="n">f</span>                                        <span class="o">--</span>      <span class="mi">1</span>      <span class="mi">1</span> <span class="o">--</span> <span class="mf">0.01449</span> <span class="mf">2.70167</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">144</span><span class="o">-</span><span class="mf">55e663</span><span class="n">ef5e2e</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">f</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">custom_fftn_cooley</span>                   <span class="o">--</span>    <span class="mi">100</span>    <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00139</span> <span class="mf">2.68718</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">112</span><span class="p">:</span><span class="n">custom_fftn_cooley</span> <span class="p">(</span><span class="n">custom_fftn_cooley</span><span class="p">)</span>
        <span class="n">custom_fft_cooley</span>                <span class="o">--</span>    <span class="mi">100</span>    <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00135</span> <span class="mf">2.68568</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">69</span><span class="p">:</span><span class="n">custom_fft_cooley</span> <span class="p">(</span><span class="n">custom_fft_cooley</span><span class="p">)</span>
            <span class="n">cooley_fft</span>                   <span class="o">--</span>    <span class="mi">100</span>    <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00082</span> <span class="mf">2.68421</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">65</span><span class="p">:</span><span class="n">cooley_fft</span> <span class="p">(</span><span class="n">cooley_fft</span><span class="p">)</span>
                <span class="n">cooley_fft_recursive</span>     <span class="o">--</span>    <span class="mi">100</span>    <span class="mi">100</span> <span class="o">--</span> <span class="mf">0.00160</span> <span class="mf">2.68339</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">139</span><span class="o">-</span><span class="n">b9d3f22689f8</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="n">cooley_fft_recursive</span> <span class="p">(</span><span class="n">cooley_fft_recursive</span><span class="p">)</span> <span class="o">+++</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">uiltins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="o">--</span>    <span class="mi">300</span>    <span class="mi">300</span> <span class="o">--</span> <span class="mf">0.00012</span> <span class="mf">0.00012</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
        <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>   <span class="o">--</span>    <span class="mi">300</span>    <span class="mi">300</span> <span class="o">--</span> <span class="mf">0.00011</span> <span class="mf">0.00011</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
<span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>           <span class="o">--</span>  <span class="mi">77200</span>  <span class="mi">77200</span> <span class="o">--</span> <span class="mf">0.02367</span> <span class="mf">0.02367</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">nu</span><span class="o">...</span><span class="n">nt_array_function</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">76500</span> <span class="o">--</span> <span class="mf">0.58675</span> <span class="mf">0.93975</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="n">atleast_1d</span>                           <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.09562</span> <span class="mf">0.13747</span> <span class="o">--</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Python395_x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">shape_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="n">atleast_1d</span> <span class="p">(</span><span class="n">atleast_1d</span><span class="p">)</span>
        <span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;append...list&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">51000</span>  <span class="mi">51000</span> <span class="o">--</span> <span class="mf">0.01708</span> <span class="mf">0.01708</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;append&#39;</span> <span class="n">of</span> <span class="s1">&#39;list&#39;</span> <span class="n">objects</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">method</span> <span class="s1">&#39;append&#39;</span> <span class="n">of</span> <span class="s1">&#39;list&#39;</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span>   <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.00822</span> <span class="mf">0.00822</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">len</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
        <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">metho</span><span class="o">...</span><span class="n">py</span><span class="o">.</span><span class="n">asanyarray</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">51000</span>  <span class="mi">51000</span> <span class="o">--</span> <span class="mf">0.01655</span> <span class="mf">0.01655</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="n">hstack</span>                               <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.09871</span> <span class="mf">0.90222</span> <span class="o">--</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Python395_x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">shape_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">285</span><span class="p">:</span><span class="n">hstack</span> <span class="p">(</span><span class="n">hstack</span><span class="p">)</span>
        <span class="n">concatenate</span>                      <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.04882</span> <span class="mf">0.57709</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">__array_function__</span> <span class="n">internals</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">177</span><span class="p">:</span><span class="n">concatenate</span> <span class="p">(</span><span class="n">concatenate</span><span class="p">)</span>
            <span class="n">concatenate</span>                  <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.01049</span> <span class="mf">0.01049</span> <span class="o">--</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Python395_x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">multiarray</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">148</span><span class="p">:</span><span class="n">concatenate</span> <span class="p">(</span><span class="n">concatenate</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">ay_function</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.51778</span> <span class="mf">0.51778</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
        <span class="n">atleast_1d</span>                       <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.04022</span> <span class="mf">0.21751</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">__array_function__</span> <span class="n">internals</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">177</span><span class="p">:</span><span class="n">atleast_1d</span> <span class="p">(</span><span class="n">atleast_1d</span><span class="p">)</span>
            <span class="n">_atleast_1d_dispatcher</span>       <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.00838</span> <span class="mf">0.00838</span> <span class="o">--</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Python395_x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">shape_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="n">_atleast_1d_dispatcher</span> <span class="p">(</span><span class="n">_atleast_1d_dispatcher</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">met</span><span class="o">...</span><span class="n">ay_function</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.03144</span> <span class="mf">0.16891</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_multiarray_umath</span><span class="o">.</span><span class="n">implement_array_function</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">+++</span>
        <span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">metho</span><span class="o">...</span><span class="n">ns</span><span class="o">.</span><span class="n">isinstance</span><span class="o">&gt;</span> <span class="o">--</span>  <span class="mi">25500</span>  <span class="mi">25500</span> <span class="o">--</span> <span class="mf">0.00892</span> <span class="mf">0.00892</span> <span class="o">--</span> <span class="o">~</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">isinstance</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">builtins</span><span class="o">.</span><span class="n">isinstance</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="onnx_profile.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Memory usage</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="onnx_fft.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">ONNX and FFT</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>