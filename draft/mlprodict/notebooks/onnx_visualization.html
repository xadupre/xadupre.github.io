
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ONNX visualization &#8212; Python Runtime for ONNX</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pairwise distances with ONNX (pdist)" href="onnx_pdist.html" />
    <link rel="prev" title="ONNX side by side" href="onnx_sbs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../all_notebooks_coverage.html">
   Notebooks Coverage
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-a-model">
   Train a model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-a-model">
   Convert a model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explore-it-with-onnxinference">
   Explore it with OnnxInference
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dot">
   dot
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#magic-commands">
   magic commands
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shape-information">
   Shape information
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#runtime">
   runtime
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-metadata">
   Add metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simple-pca">
   Simple PCA
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="onnx-visualization">
<span id="onnxvisualizationrst"></span><h1>ONNX visualization<a class="headerlink" href="#onnx-visualization" title="Permalink to this headline">¶</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/dc6e3d0572fc317a67fe790346a49b31/onnx_visualization.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="onnx_visualization2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/733bded56927c2f2665b97cc06553fe4/onnx_visualization.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/d7a34144c049e29c8ec8da81dcc20452/onnx_visualization.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="onnx_visualization.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/onnx_visualization.ipynb">GitHub</a></p>
<p><a class="reference external" href="https://onnx.ai/">ONNX</a> is a serialization format for machine
learned model. It is a list of mathematical functions used to describe
every prediction function for standard and deep machine learning. Module
<a class="reference external" href="https://github.com/onnx/onnx">onnx</a> offers some tools to <a class="reference external" href="http://www.xavierdupre.fr/app/sklearn-onnx/helpsphinx/auto_examples/plot_pipeline.html">display
ONNX
graph</a>.
<a class="reference external" href="https://github.com/lutzroeder/netron">Netron</a> is another approach.
The following notebooks explore a ligher visualization.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#train-a-model" id="id1">Train a model</a></p></li>
<li><p><a class="reference internal" href="#convert-a-model" id="id2">Convert a model</a></p></li>
<li><p><a class="reference internal" href="#explore-it-with-onnxinference" id="id3">Explore it with OnnxInference</a></p></li>
<li><p><a class="reference internal" href="#dot" id="id4">dot</a></p></li>
<li><p><a class="reference internal" href="#magic-commands" id="id5">magic commands</a></p></li>
<li><p><a class="reference internal" href="#shape-information" id="id6">Shape information</a></p></li>
<li><p><a class="reference internal" href="#runtime" id="id7">runtime</a></p></li>
<li><p><a class="reference internal" href="#add-metadata" id="id8">Add metadata</a></p></li>
<li><p><a class="reference internal" href="#simple-pca" id="id9">Simple PCA</a></p></li>
</ul>
</div>
<section id="train-a-model">
<h2><a class="toc-backref" href="#id1">Train a model</a><a class="headerlink" href="#train-a-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="n">iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">clr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
<span class="n">clr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="convert-a-model">
<h2><a class="toc-backref" href="#id2">Convert a model</a><a class="headerlink" href="#convert-a-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="n">model_onnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">clr</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="explore-it-with-onnxinference">
<h2><a class="toc-backref" href="#id3">Explore it with OnnxInference</a><a class="headerlink" href="#explore-it-with-onnxinference" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_onnx</span><span class="p">)</span>
<span class="n">sess</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">ir_version</span><span class="p">:</span> <span class="mi">4</span>
    <span class="n">producer_name</span><span class="p">:</span> <span class="s2">&quot;skl2onnx&quot;</span>
    <span class="n">producer_version</span><span class="p">:</span> <span class="s2">&quot;1.7.1076&quot;</span>
    <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;ai.onnx&quot;</span>
    <span class="n">model_version</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">doc_string</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="n">graph</span> <span class="p">{</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;probability_tensor&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;LinearClassifier&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;LinearClassifier&quot;</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;classlabels_ints&quot;</span>
          <span class="n">ints</span><span class="p">:</span> <span class="mi">0</span>
          <span class="n">ints</span><span class="p">:</span> <span class="mi">1</span>
          <span class="n">ints</span><span class="p">:</span> <span class="mi">2</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">INTS</span>
        <span class="p">}</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;coefficients&quot;</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">0.3895888328552246</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">1.3643852472305298</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.140394449234009</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.9475928544998169</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">0.3562876284122467</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.4181873798370361</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">0.5958272218704224</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.3317818641662598</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.5090725421905518</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.3937636613845825</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">2.168299436569214</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">2.3770956993103027</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">FLOATS</span>
        <span class="p">}</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;intercepts&quot;</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">0.23760676383972168</span>
          <span class="n">floats</span><span class="p">:</span> <span class="mf">0.8039277791976929</span>
          <span class="n">floats</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0647538900375366</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">FLOATS</span>
        <span class="p">}</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;multi_class&quot;</span>
          <span class="n">i</span><span class="p">:</span> <span class="mi">1</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">INT</span>
        <span class="p">}</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;post_transform&quot;</span>
          <span class="n">s</span><span class="p">:</span> <span class="s2">&quot;LOGISTIC&quot;</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">STRING</span>
        <span class="p">}</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;ai.onnx.ml&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;probability_tensor&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;probabilities&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Normalizer&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Normalizer&quot;</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;norm&quot;</span>
          <span class="n">s</span><span class="p">:</span> <span class="s2">&quot;L1&quot;</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">STRING</span>
        <span class="p">}</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;ai.onnx.ml&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;output_label&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Cast&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Cast&quot;</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;to&quot;</span>
          <span class="n">i</span><span class="p">:</span> <span class="mi">7</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">INT</span>
        <span class="p">}</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;probabilities&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;output_probability&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;ZipMap&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;ZipMap&quot;</span>
        <span class="n">attribute</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;classlabels_int64s&quot;</span>
          <span class="n">ints</span><span class="p">:</span> <span class="mi">0</span>
          <span class="n">ints</span><span class="p">:</span> <span class="mi">1</span>
          <span class="n">ints</span><span class="p">:</span> <span class="mi">2</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">INTS</span>
        <span class="p">}</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;ai.onnx.ml&quot;</span>
      <span class="p">}</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;mlprodict_ONNX(LogisticRegression)&quot;</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">4</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">output</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;output_label&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">7</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">output</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;output_probability&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">sequence_type</span> <span class="p">{</span>
            <span class="n">elem_type</span> <span class="p">{</span>
              <span class="n">map_type</span> <span class="p">{</span>
                <span class="n">key_type</span><span class="p">:</span> <span class="mi">7</span>
                <span class="n">value_type</span> <span class="p">{</span>
                  <span class="n">tensor_type</span> <span class="p">{</span>
                    <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
                  <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">opset_import</span> <span class="p">{</span>
      <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;ai.onnx.ml&quot;</span>
      <span class="n">version</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="n">opset_import</span> <span class="p">{</span>
      <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="n">version</span><span class="p">:</span> <span class="mi">9</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="dot">
<h2><a class="toc-backref" href="#id4">dot</a><a class="headerlink" href="#dot" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dot</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">to_dot</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">digraph{
  ranksep=0.25;
  nodesep=0.05;
  orientation=portrait;
  X [shape=box color=red label=&quot;Xnfloat((0, 4))&quot; fontsize=10];
  output_label [shape=box color=green label=&quot;output_labelnint64((0,))&quot; fontsize=10];
  output_probability [shape=box color=green label=&quot;output_probabilityn[{int64, {'kind': 'tensor', 'elem': 'float', 'shape': }}]&quot; fontsize=10];

  label [shape=box label=&quot;label&quot; fontsize=10];
  probability_tensor [shape=box label=&quot;probability_tensor&quot; fontsize=10];
  LinearClassifier [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;LinearClassifiern(LinearClassifier)nclasslabels_ints=[0 1 2]ncoefficients=[ 0.38958883  1.36...nintercepts=[ 0.23760676  0.8039...nmulti_class=1npost_transform=b'LOGISTIC'&quot; fontsize=10];
  X -&gt; LinearClassifier;
  LinearClassifier -&gt; label;
  LinearClassifier -&gt; probability_tensor;
  probabilities [shape=box label=&quot;probabilities&quot; fontsize=10];
  Normalizer [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Normalizern(Normalizer)nnorm=b'L1'&quot; fontsize=10];
  probability_tensor -&gt; Normalizer;
  Normalizer -&gt; probabilities;
  Cast [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;Castn(Cast)nto=7&quot; fontsize=10];
  label -&gt; Cast;
  Cast -&gt; output_label;
  ZipMap [shape=box style=&quot;filled,rounded&quot; color=orange label=&quot;ZipMapn(ZipMap)nclasslabels_int64s=[0 1 2]&quot; fontsize=10];
  probabilities -&gt; ZipMap;
  ZipMap -&gt; output_probability;
}</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">RenderJsDot</span>
<span class="n">RenderJsDot</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>  <span class="c1"># add local=True if nothing shows up</span>
</pre></div>
</div>
<div id="M9860a8666929417599d923fec7918c38-cont"><div id="M9860a8666929417599d923fec7918c38" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  ranksep=0.25;\n  nodesep=0.05;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 4))\" fontsize=10];\n\n  output_label [shape=box color=green label=\"output_label\nint64((0,))\" fontsize=10];\n  output_probability [shape=box color=green label=\"output_probability\n[{int64, {'kind': 'tensor', 'elem': 'float', 'shape': }}]\" fontsize=10];\n\n\n  label [shape=box label=\"label\" fontsize=10];\n  probability_tensor [shape=box label=\"probability_tensor\" fontsize=10];\n  LinearClassifier [shape=box style=\"filled,rounded\" color=orange label=\"LinearClassifier\n(LinearClassifier)\nclasslabels_ints=[0 1 2]\ncoefficients=[ 0.38958883  1.36...\nintercepts=[ 0.23760676  0.8039...\nmulti_class=1\npost_transform=b'LOGISTIC'\" fontsize=10];\n  X -> LinearClassifier;\n  LinearClassifier -> label;\n  LinearClassifier -> probability_tensor;\n\n  probabilities [shape=box label=\"probabilities\" fontsize=10];\n  Normalizer [shape=box style=\"filled,rounded\" color=orange label=\"Normalizer\n(Normalizer)\nnorm=b'L1'\" fontsize=10];\n  probability_tensor -> Normalizer;\n  Normalizer -> probabilities;\n\n  Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast)\nto=7\" fontsize=10];\n  label -> Cast;\n  Cast -> output_label;\n\n  ZipMap [shape=box style=\"filled,rounded\" color=orange label=\"ZipMap\n(ZipMap)\nclasslabels_int64s=[0 1 2]\" fontsize=10];\n  probabilities -> ZipMap;\n  ZipMap -> output_probability;\n}");
document.getElementById('M9860a8666929417599d923fec7918c38').innerHTML = svgGraph; });

</script></section>
<section id="magic-commands">
<h2><a class="toc-backref" href="#id5">magic commands</a><a class="headerlink" href="#magic-commands" title="Permalink to this headline">¶</a></h2>
<p>The module implements a magic command to easily display graphs.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">mlprodict</span> <span class="n">extension</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">loaded</span><span class="o">.</span> <span class="n">To</span> <span class="n">reload</span> <span class="n">it</span><span class="p">,</span> <span class="n">use</span><span class="p">:</span>
  <span class="o">%</span><span class="n">reload_ext</span> <span class="n">mlprodict</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add -l 1 if nothing shows up</span>
<span class="o">%</span><span class="k">onnxview</span> model_onnx
</pre></div>
</div>
<div id="M1fb8cd2ee0ef4ef5886636d648c6c315-cont"><div id="M1fb8cd2ee0ef4ef5886636d648c6c315" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  ranksep=0.25;\n  nodesep=0.05;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 4))\" fontsize=10];\n\n  output_label [shape=box color=green label=\"output_label\nint64((0,))\" fontsize=10];\n  output_probability [shape=box color=green label=\"output_probability\n[{int64, {'kind': 'tensor', 'elem': 'float', 'shape': }}]\" fontsize=10];\n\n\n  label [shape=box label=\"label\" fontsize=10];\n  probability_tensor [shape=box label=\"probability_tensor\" fontsize=10];\n  LinearClassifier [shape=box style=\"filled,rounded\" color=orange label=\"LinearClassifier\n(LinearClassifier)\nclasslabels_ints=[0 1 2]\ncoefficients=[ 0.38958883  1.36...\nintercepts=[ 0.23760676  0.8039...\nmulti_class=1\npost_transform=b'LOGISTIC'\" fontsize=10];\n  X -> LinearClassifier;\n  LinearClassifier -> label;\n  LinearClassifier -> probability_tensor;\n\n  probabilities [shape=box label=\"probabilities\" fontsize=10];\n  Normalizer [shape=box style=\"filled,rounded\" color=orange label=\"Normalizer\n(Normalizer)\nnorm=b'L1'\" fontsize=10];\n  probability_tensor -> Normalizer;\n  Normalizer -> probabilities;\n\n  Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast)\nto=7\" fontsize=10];\n  label -> Cast;\n  Cast -> output_label;\n\n  ZipMap [shape=box style=\"filled,rounded\" color=orange label=\"ZipMap\n(ZipMap)\nclasslabels_int64s=[0 1 2]\" fontsize=10];\n  probabilities -> ZipMap;\n  ZipMap -> output_probability;\n}");
document.getElementById('M1fb8cd2ee0ef4ef5886636d648c6c315').innerHTML = svgGraph; });

</script></section>
<section id="shape-information">
<h2><a class="toc-backref" href="#id6">Shape information</a><a class="headerlink" href="#shape-information" title="Permalink to this headline">¶</a></h2>
<p>It is possible to use the python runtime to get an estimation of each
node shape.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> model_onnx -a 1
</pre></div>
</div>
<div id="Meaee2b355fba48c9bbf6090f46fe3479-cont"><div id="Meaee2b355fba48c9bbf6090f46fe3479" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  ranksep=0.25;\n  nodesep=0.05;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 4))\nshape=(n, 4)\" fontsize=10];\n\n  output_label [shape=box color=green label=\"output_label\nint64((0,))\nshape=(n)\" fontsize=10];\n  output_probability [shape=box color=green label=\"output_probability\n[{int64, {'kind': 'tensor', 'elem': 'float', 'shape': }}]\nshape=(n)\" fontsize=10];\n\n\n  label [shape=box label=\"label\nshape=(n)\ninplace\" fontsize=10];\n  probability_tensor [shape=box label=\"probability_tensor\nshape=(n, 3)\ninplace\" fontsize=10];\n  LinearClassifier [shape=box style=\"filled,rounded\" color=orange label=\"LinearClassifier\n(LinearClassifier)\nclasslabels_ints=[0 1 2]\ncoefficients=[ 0.38958883  1.36...\nintercepts=[ 0.23760676  0.8039...\nmulti_class=1\npost_transform=b'LOGISTIC'\" fontsize=10];\n  X -> LinearClassifier;\n  LinearClassifier -> label;\n  LinearClassifier -> probability_tensor;\n\n  probabilities [shape=box label=\"probabilities\nshape=(n, 3)\ninplace\" fontsize=10];\n  Normalizer [shape=box style=\"filled,rounded\" color=orange label=\"Normalizer\n(Normalizer)\nnorm=b'L1'\" fontsize=10];\n  probability_tensor -> Normalizer;\n  Normalizer -> probabilities;\n\n  Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Cast)\nto=7\" fontsize=10];\n  label -> Cast;\n  Cast -> output_label;\n\n  ZipMap [shape=box style=\"filled,rounded\" color=orange label=\"ZipMap\n(ZipMap)\nclasslabels_int64s=[0 1 2]\" fontsize=10];\n  probabilities -> ZipMap;\n  ZipMap -> output_probability;\n}");
document.getElementById('Meaee2b355fba48c9bbf6090f46fe3479').innerHTML = svgGraph; });

</script><p>The shape <code class="docutils literal notranslate"><span class="pre">(n,</span> <span class="pre">2)</span></code> means a matrix with an indefinite number of rows
and 2 columns.</p>
</section>
<section id="runtime">
<h2><a class="toc-backref" href="#id7">runtime</a><a class="headerlink" href="#runtime" title="Permalink to this headline">¶</a></h2>
<p>Let’s compute the prediction using a Python runtime.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prob</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})[</span><span class="s1">&#39;output_probability&#39;</span><span class="p">]</span>
<span class="n">prob</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.84339281</span><span class="p">,</span> <span class="mf">0.01372288</span><span class="p">,</span> <span class="mf">0.77424892</span><span class="p">,</span> <span class="mf">0.00095374</span><span class="p">,</span> <span class="mf">0.04052374</span><span class="p">]),</span>
 <span class="mi">1</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.15649399</span><span class="p">,</span> <span class="mf">0.71819778</span><span class="p">,</span> <span class="mf">0.22563196</span><span class="p">,</span> <span class="mf">0.25979154</span><span class="p">,</span> <span class="mf">0.7736001</span> <span class="p">]),</span>
 <span class="mi">2</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.13198419e-04</span><span class="p">,</span> <span class="mf">2.68079336e-01</span><span class="p">,</span> <span class="mf">1.19117272e-04</span><span class="p">,</span> <span class="mf">7.39254721e-01</span><span class="p">,</span>
        <span class="mf">1.85876160e-01</span><span class="p">])}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">prob</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
<span class="n">prob</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">8.43392810e-01</span><span class="p">,</span> <span class="mf">1.56493992e-01</span><span class="p">,</span> <span class="mf">1.13198419e-04</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">1.37228844e-02</span><span class="p">,</span> <span class="mf">7.18197780e-01</span><span class="p">,</span> <span class="mf">2.68079336e-01</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">7.74248918e-01</span><span class="p">,</span> <span class="mf">2.25631964e-01</span><span class="p">,</span> <span class="mf">1.19117272e-04</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">9.53737402e-04</span><span class="p">,</span> <span class="mf">2.59791542e-01</span><span class="p">,</span> <span class="mf">7.39254721e-01</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">4.05237433e-02</span><span class="p">,</span> <span class="mf">7.73600097e-01</span><span class="p">,</span> <span class="mf">1.85876160e-01</span><span class="p">]])</span>
</pre></div>
</div>
<p>Which we compare to the original model.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">8.43392800e-01</span><span class="p">,</span> <span class="mf">1.56494002e-01</span><span class="p">,</span> <span class="mf">1.13198441e-04</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">1.37228764e-02</span><span class="p">,</span> <span class="mf">7.18197725e-01</span><span class="p">,</span> <span class="mf">2.68079398e-01</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">7.74248907e-01</span><span class="p">,</span> <span class="mf">2.25631976e-01</span><span class="p">,</span> <span class="mf">1.19117296e-04</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">9.53736800e-04</span><span class="p">,</span> <span class="mf">2.59791543e-01</span><span class="p">,</span> <span class="mf">7.39254720e-01</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">4.05237263e-02</span><span class="p">,</span> <span class="mf">7.73600070e-01</span><span class="p">,</span> <span class="mf">1.85876204e-01</span><span class="p">]])</span>
</pre></div>
</div>
<p>Some time measurement…</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> clr.predict_proba(X_test)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>86.7 µs ± 7.33 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> sess.run({&#39;X&#39;: X_test})[&#39;output_probability&#39;]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>52.5 µs ± 4.53 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<p>With one observation:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> clr.predict_proba(X_test[:1])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>77.6 µs ± 4.07 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> sess.run({&#39;X&#39;: X_test[:1]})[&#39;output_probability&#39;]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>40.6 µs ± 913 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile</span>
<span class="n">pr</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})[</span><span class="s1">&#39;output_probability&#39;</span><span class="p">],</span> <span class="n">as_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;namefct&#39;</span><span class="p">,</span> <span class="s1">&#39;cum_tall&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;namefct&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rot</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;example of a graph&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
    <span class="n">la</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_visualization_30_0.png" src="../_images/onnx_visualization_30_0.png" />
</section>
<section id="add-metadata">
<h2><a class="toc-backref" href="#id8">Add metadata</a><a class="headerlink" href="#add-metadata" title="Permalink to this headline">¶</a></h2>
<p>It is possible to add metadata once the model is converted.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="n">model_onnx</span><span class="o">.</span><span class="n">metadata_props</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
<span class="n">meta</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;key_meta&quot;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;value_meta&quot;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">model_onnx</span><span class="o">.</span><span class="n">metadata_props</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">key</span><span class="p">:</span> <span class="s2">&quot;key_meta&quot;</span>
 <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;value_meta&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_onnx</span><span class="o">.</span><span class="n">metadata_props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">:</span> <span class="s2">&quot;key_meta&quot;</span>
<span class="n">value</span><span class="p">:</span> <span class="s2">&quot;value_meta&quot;</span>
</pre></div>
</div>
</section>
<section id="simple-pca">
<h2><a class="toc-backref" href="#id9">Simple PCA</a><a class="headerlink" href="#simple-pca" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca_onnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">mlprodict</span> <span class="n">extension</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">loaded</span><span class="o">.</span> <span class="n">To</span> <span class="n">reload</span> <span class="n">it</span><span class="p">,</span> <span class="n">use</span><span class="p">:</span>
  <span class="o">%</span><span class="n">reload_ext</span> <span class="n">mlprodict</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> pca_onnx -a 1
</pre></div>
</div>
<div id="M112a258f4f634829b6e34b86cb8896a2-cont"><div id="M112a258f4f634829b6e34b86cb8896a2" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  ranksep=0.25;\n  nodesep=0.05;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 4))\nshape=(n, 4)\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\nfloat((0, 2))\nshape=(max(max(n,4),4), 4)\" fontsize=10];\n\n  transform_matrix [shape=box label=\"transform_matrix\nfloat32((4, 2))\n[[ 0.3613866   0.6565888 ]\n [-0.08452252  0.7301614 ]\n [ 0.8566706  -0.17337266]\n [ 0.3582892  -0.07548102]]\" fontsize=10];\n  mean [shape=box label=\"mean\nfloat32((4,))\n[5.8433332 3.0573332 3.758     1.1993333]\" fontsize=10];\n\n  sub_result [shape=box label=\"sub_result\nshape=(max(n,4), 4)\ninplace\" fontsize=10];\n  Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Sub)\" fontsize=10];\n  X -> Sub;\n  mean -> Sub;\n  Sub -> sub_result;\n\n  MatMul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(MatMul)\" fontsize=10];\n  sub_result -> MatMul;\n  transform_matrix -> MatMul;\n  MatMul -> variable;\n}");
document.getElementById('M112a258f4f634829b6e34b86cb8896a2').innerHTML = svgGraph; });

</script><p>The graph would probably be faster if the multiplication was done before
the subtraction because it is easier to do this one inline than the
multiplication.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="onnx_sbs.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">ONNX side by side</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="onnx_pdist.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Pairwise distances with ONNX (pdist)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>