
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Precision loss due to float32 conversion with ONNX &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Profiling with onnxruntime" href="onnx_profile_ort.html" />
    <link rel="prev" title="Pairwise distances with ONNX (pdist)" href="onnx_pdist.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_ffts.html">
   ONNX FFTs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gradientboostingclassifier">
   GradientBoostingClassifier
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conversion-to-onnx-and-comparison-to-original-outputs">
   Conversion to ONNX and comparison to original outputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#why-this-difference">
   Why this difference?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bigger-datasets">
   Bigger datasets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decisiontreeregressor">
   DecisionTreeRegressor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#runtime-supporting-float64-for-decisiontreeregressor">
   Runtime supporting float64 for DecisionTreeRegressor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interpretation">
   Interpretation
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="precision-loss-due-to-float32-conversion-with-onnx">
<span id="onnxshakerrst"></span><h1>Precision loss due to float32 conversion with ONNX<a class="headerlink" href="#precision-loss-due-to-float32-conversion-with-onnx" title="Permalink to this headline">#</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/7862a75e9df9b49228a8c1f9649294f2/onnx_shaker.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="onnx_shaker2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/cb56ce2d1698122ce953e4cc2a297f0f/onnx_shaker.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/97087aa9c3b03d8effe2e13842e325d8/onnx_shaker.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="onnx_shaker.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/onnx_shaker.ipynb">GitHub</a></p>
<p>The notebook studies the loss of precision while converting a
non-continuous model into float32. It studies the conversion of
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingClassifier.html">GradientBoostingClassifier</a>
and then a
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeRegressor.html">DecisionTreeRegressor</a>
for which a runtime supported float64 was implemented.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#gradientboostingclassifier" id="id1">GradientBoostingClassifier</a></p></li>
<li><p><a class="reference internal" href="#conversion-to-onnx-and-comparison-to-original-outputs" id="id2">Conversion to ONNX and comparison to original outputs</a></p></li>
<li><p><a class="reference internal" href="#why-this-difference" id="id3">Why this difference?</a></p></li>
<li><p><a class="reference internal" href="#bigger-datasets" id="id4">Bigger datasets</a></p></li>
<li><p><a class="reference internal" href="#decisiontreeregressor" id="id5">DecisionTreeRegressor</a></p></li>
<li><p><a class="reference internal" href="#runtime-supporting-float64-for-decisiontreeregressor" id="id6">Runtime supporting float64 for DecisionTreeRegressor</a></p></li>
<li><p><a class="reference internal" href="#interpretation" id="id7">Interpretation</a></p></li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<section id="gradientboostingclassifier">
<h2><a class="toc-backref" href="#id1">GradientBoostingClassifier</a><a class="headerlink" href="#gradientboostingclassifier" title="Permalink to this headline">#</a></h2>
<p>We just train such a model on Iris dataset.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingClassifier</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">clr</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">clr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>We are interested into the probability of the last class.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp</span> <span class="o">=</span> <span class="n">clr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">exp</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03267424</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.94383517</span><span class="p">,</span>
       <span class="mf">0.02866979</span><span class="p">,</span> <span class="mf">0.94572751</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.94383517</span><span class="p">,</span>
       <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.94696795</span><span class="p">,</span> <span class="mf">0.0317053</span> <span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span>
       <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span>
       <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.94577389</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.91161635</span><span class="p">,</span>
       <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267424</span><span class="p">,</span> <span class="mf">0.94282974</span><span class="p">,</span>
       <span class="mf">0.03267424</span><span class="p">,</span> <span class="mf">0.94696795</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.94696795</span><span class="p">,</span> <span class="mf">0.9387834</span> <span class="p">,</span>
       <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="conversion-to-onnx-and-comparison-to-original-outputs">
<h2><a class="toc-backref" href="#id2">Conversion to ONNX and comparison to original outputs</a><a class="headerlink" href="#conversion-to-onnx-and-comparison-to-original-outputs" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_def</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">clr</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">outputs</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;output_label&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">),</span>
 <span class="s1">&#39;output_probability&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.029367255</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.93795854</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032674246</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026494453</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.02967037</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9438352</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.027988827</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.94334143</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.028669795</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026551371</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.027721122</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9457275</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026494453</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.02967037</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9438352</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026586197</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.026445853</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.946968</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.027929045</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9403657</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.0317053</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026503632</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.027722482</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9457739</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.041209597</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.04717405</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9116163</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.029367255</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.93795854</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032674246</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.027969029</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.029201236</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9428297</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.029367255</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.93795854</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032674246</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026586197</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.026445853</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.946968</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.026586197</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.026445853</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.946968</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.027941188</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.033275396</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.9387834</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.02932842</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.9379961</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.032675553</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.94445217</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.025442092</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.030105816</span><span class="p">}]}</span>
</pre></div>
</div>
<p>Let’s extract the probability of the last class.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">output_fct</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;output_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

<span class="n">output_fct</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03267425</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.9438352</span> <span class="p">,</span>
       <span class="mf">0.0286698</span> <span class="p">,</span> <span class="mf">0.9457275</span> <span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.9438352</span> <span class="p">,</span>
       <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.946968</span>  <span class="p">,</span> <span class="mf">0.0317053</span> <span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span>
       <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span>
       <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.9457739</span> <span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.9116163</span> <span class="p">,</span>
       <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267425</span><span class="p">,</span> <span class="mf">0.9428297</span> <span class="p">,</span>
       <span class="mf">0.03267425</span><span class="p">,</span> <span class="mf">0.946968</span>  <span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.946968</span>  <span class="p">,</span> <span class="mf">0.9387834</span> <span class="p">,</span>
       <span class="mf">0.03010582</span><span class="p">,</span> <span class="mf">0.03267555</span><span class="p">,</span> <span class="mf">0.03010582</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s compare both predictions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">output_fct</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">-</span> <span class="n">exp</span><span class="p">))</span>
<span class="n">diff</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span>
       <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span>
       <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.35649712e-09</span><span class="p">,</span> <span class="mf">1.40241483e-09</span><span class="p">,</span> <span class="mf">1.40403427e-09</span><span class="p">,</span>
       <span class="mf">1.40403427e-09</span><span class="p">,</span> <span class="mf">1.40403427e-09</span><span class="p">,</span> <span class="mf">4.08553857e-09</span><span class="p">,</span> <span class="mf">7.87733068e-09</span><span class="p">,</span>
       <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span>
       <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span>
       <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">8.05985446e-09</span><span class="p">,</span>
       <span class="mf">8.05985446e-09</span><span class="p">,</span> <span class="mf">9.19990018e-09</span><span class="p">,</span> <span class="mf">9.34906490e-09</span><span class="p">,</span> <span class="mf">1.80944041e-08</span><span class="p">,</span>
       <span class="mf">2.73915506e-08</span><span class="p">,</span> <span class="mf">2.81494498e-08</span><span class="p">,</span> <span class="mf">2.81494498e-08</span><span class="p">,</span> <span class="mf">6.50696940e-08</span><span class="p">,</span>
       <span class="mf">6.50696940e-08</span><span class="p">,</span> <span class="mf">6.50696940e-08</span><span class="p">])</span>
</pre></div>
</div>
<p>The highest difference is quite high but there is only one.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">max</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">6.506969396635753e-08</span>
</pre></div>
</div>
</section>
<section id="why-this-difference">
<h2><a class="toc-backref" href="#id3">Why this difference?</a><a class="headerlink" href="#why-this-difference" title="Permalink to this headline">#</a></h2>
<p>The function <em>astype_range</em> returns floats (single floats) around the
true value of the orginal features in double floats.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.model_checker</span> <span class="kn">import</span> <span class="n">astype_range</span>
<span class="n">astype_range</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">array</span><span class="p">([[</span><span class="mf">5.7999997</span> <span class="p">,</span> <span class="mf">3.9999995</span> <span class="p">,</span> <span class="mf">1.1999999</span> <span class="p">,</span> <span class="mf">0.19999999</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">5.0999994</span> <span class="p">,</span> <span class="mf">2.4999998</span> <span class="p">,</span> <span class="mf">2.9999998</span> <span class="p">,</span> <span class="mf">1.0999999</span> <span class="p">],</span>
        <span class="p">[</span><span class="mf">6.5999994</span> <span class="p">,</span> <span class="mf">2.9999998</span> <span class="p">,</span> <span class="mf">4.3999996</span> <span class="p">,</span> <span class="mf">1.3999999</span> <span class="p">],</span>
        <span class="p">[</span><span class="mf">5.3999996</span> <span class="p">,</span> <span class="mf">3.8999996</span> <span class="p">,</span> <span class="mf">1.2999998</span> <span class="p">,</span> <span class="mf">0.39999998</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.899999</span>  <span class="p">,</span> <span class="mf">3.7999995</span> <span class="p">,</span> <span class="mf">6.3999996</span> <span class="p">,</span> <span class="mf">1.9999998</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">),</span>
 <span class="n">array</span><span class="p">([[</span><span class="mf">5.8000007</span> <span class="p">,</span> <span class="mf">4.0000005</span> <span class="p">,</span> <span class="mf">1.2000002</span> <span class="p">,</span> <span class="mf">0.20000002</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">5.1000004</span> <span class="p">,</span> <span class="mf">2.5000002</span> <span class="p">,</span> <span class="mf">3.0000002</span> <span class="p">,</span> <span class="mf">1.1000001</span> <span class="p">],</span>
        <span class="p">[</span><span class="mf">6.6000004</span> <span class="p">,</span> <span class="mf">3.0000002</span> <span class="p">,</span> <span class="mf">4.4000006</span> <span class="p">,</span> <span class="mf">1.4000001</span> <span class="p">],</span>
        <span class="p">[</span><span class="mf">5.4000006</span> <span class="p">,</span> <span class="mf">3.9000006</span> <span class="p">,</span> <span class="mf">1.3000001</span> <span class="p">,</span> <span class="mf">0.40000004</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">7.900001</span>  <span class="p">,</span> <span class="mf">3.8000004</span> <span class="p">,</span> <span class="mf">6.4000006</span> <span class="p">,</span> <span class="mf">2.0000002</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
<p>If a decision tree uses a threshold which verifies <code class="docutils literal notranslate"><span class="pre">float32(t)</span> <span class="pre">!=</span> <span class="pre">t</span></code>,
it cannot be converted into single float without discrepencies. The
interval <code class="docutils literal notranslate"><span class="pre">[float32(t</span> <span class="pre">-</span> <span class="pre">|t|*1e-7),</span> <span class="pre">float32(t</span> <span class="pre">+</span> <span class="pre">|t|*1e-7)]</span></code> is close to
all double values converted to the same <em>float32</em> but every feature <em>x</em>
in this interval verifies <code class="docutils literal notranslate"><span class="pre">float32(x)</span> <span class="pre">&gt;=</span> <span class="pre">float32(t)</span></code>. It is not an
issue for continuous machine learned models as all errors usually
compensate. For non continuous models, there might some outliers. Next
function considers all intervals of input features and randomly chooses
one extremity for each of them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.model_checker</span> <span class="kn">import</span> <span class="n">onnx_shaker</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">shaked</span> <span class="o">=</span> <span class="n">onnx_shaker</span><span class="p">(</span><span class="n">oinf</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                     <span class="n">output_fct</span><span class="o">=</span><span class="n">output_fct</span><span class="p">)</span>
<span class="n">shaked</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>The function draws out 100 input vectors randomly choosing one extremity
for each feature. It then sort every row. First column is the lower
bound, last column is the upper bound.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff2</span> <span class="o">=</span> <span class="n">shaked</span><span class="p">[:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shaked</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">diff2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.02333647</span><span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span>
       <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="mf">0.</span>        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">max</span><span class="p">(</span><span class="n">diff2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.02333647</span>
</pre></div>
</div>
<p>We get the same value as before. At least one feature of one observation
is really close to one threshold and changes the prediction.</p>
</section>
<section id="bigger-datasets">
<h2><a class="toc-backref" href="#id4">Bigger datasets</a><a class="headerlink" href="#bigger-datasets" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_breast_cancer</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_breast_cancer</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">clr</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span><span class="p">()</span>
<span class="n">clr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GradientBoostingClassifier</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_def</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">clr</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">output_fct1</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;output_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">shaked</span> <span class="o">=</span> <span class="n">onnx_shaker</span><span class="p">(</span><span class="n">oinf</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                     <span class="n">output_fct</span><span class="o">=</span><span class="n">output_fct1</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shaked</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">143</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shaked</span><span class="p">[:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shaked</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Observed differences on a dataset</span><span class="se">\n</span><span class="s2">when exploring rounding to float32&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_shaker_30_0.png" src="../_images/onnx_shaker_30_0.png" />
</section>
<section id="decisiontreeregressor">
<h2><a class="toc-backref" href="#id5">DecisionTreeRegressor</a><a class="headerlink" href="#decisiontreeregressor" title="Permalink to this headline">#</a></h2>
<p>This model is much simple than the previous one as it contains only one
tree. We study it on the
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_boston.html#sklearn.datasets.load_boston">Boston</a>
datasets.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_boston</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">load_boston</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="n">clr</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">clr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DecisionTreeRegressor</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ypred</span> <span class="o">=</span> <span class="n">clr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_onnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">clr</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_onnx</span><span class="p">)</span>
<span class="n">opred</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ypred</span> <span class="o">-</span> <span class="n">opred</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">1.52587891e-06</span><span class="p">,</span> <span class="mf">1.52587891e-06</span><span class="p">,</span> <span class="mf">1.52587891e-06</span><span class="p">,</span> <span class="mf">1.52587891e-06</span><span class="p">,</span>
       <span class="mf">1.52587891e-06</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ypred</span> <span class="o">-</span> <span class="n">opred</span><span class="p">)</span> <span class="o">/</span> <span class="n">ypred</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">4.680610146230323e-06</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;highest relative error: </span><span class="si">{0:1.3}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ypred</span> <span class="o">-</span> <span class="n">opred</span><span class="p">)</span> <span class="o">/</span> <span class="n">ypred</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">highest</span> <span class="n">relative</span> <span class="n">error</span><span class="p">:</span> <span class="mf">4.68e-06</span><span class="o">%</span>
</pre></div>
</div>
<p>The last difference is quite big. Let’s reuse function <em>onnx_shaker</em>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">output_fct_reg</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">shaked</span> <span class="o">=</span> <span class="n">onnx_shaker</span><span class="p">(</span><span class="n">oinf</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)},</span>
                     <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                     <span class="n">output_fct</span><span class="o">=</span><span class="n">output_fct_reg</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shaked</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shaked</span><span class="p">[:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shaked</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Observed differences on a Boston dataset</span><span class="se">\n</span><span class="s2">with a DecisionTreeRegressor&quot;</span>
          <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when exploring rounding to float32&quot;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/onnx_shaker_42_0.png" src="../_images/onnx_shaker_42_0.png" />
<p>That’s consistent. This function is way to retrieve the error due to the
conversion into float32 without using the expected values.</p>
</section>
<section id="runtime-supporting-float64-for-decisiontreeregressor">
<h2><a class="toc-backref" href="#id6">Runtime supporting float64 for DecisionTreeRegressor</a><a class="headerlink" href="#runtime-supporting-float64-for-decisiontreeregressor" title="Permalink to this headline">#</a></h2>
<p>We prooved that the conversion to float32 introduces discrepencies in a
statistical way. But if the runtime supports float64 and not only
float32, we should have absolutely no discrepencies. Let’s verify that
error disappear when the runtime supports an operator handling float64,
which is the case for the python runtime for <em>DecisionTreeRegression</em>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_onnx64</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">clr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The option <strong>rewrite_ops</strong> is needed to tell the function the operator
we need is not (yet) supported by the official specification of ONNX.
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators-ml.md#ai.onnx.ml.TreeEnsembleRegressor">TreeEnsembleRegressor</a>
only allows float coefficients and we need double coefficients. That’s
why the function rewrites the converter of this operator and selects the
appropriate runtime operator <strong>RuntimeTreeEnsembleRegressorDouble</strong>. It
works as if the ONNX specification was extended to support operator
<em>TreeEnsembleRegressorDouble</em> which behaves the same but with double.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinf64</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_onnx64</span><span class="p">)</span>
<span class="n">opred64</span> <span class="o">=</span> <span class="n">oinf64</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The runtime operator is accessible with the following path:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinf64</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">mlprodict</span><span class="o">.</span><span class="n">onnxrt</span><span class="o">.</span><span class="n">ops_cpu</span><span class="o">.</span><span class="n">op_tree_ensemble_regressor</span><span class="o">.</span><span class="n">TreeEnsembleRegressorDouble</span> <span class="n">at</span> <span class="mh">0x2135e18d320</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Different from this one:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">mlprodict</span><span class="o">.</span><span class="n">onnxrt</span><span class="o">.</span><span class="n">ops_cpu</span><span class="o">.</span><span class="n">op_tree_ensemble_regressor</span><span class="o">.</span><span class="n">TreeEnsembleRegressor</span> <span class="n">at</span> <span class="mh">0x2135d3786a0</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And the highest absolute difference is now null.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ypred</span> <span class="o">-</span> <span class="n">opred64</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.0</span>
</pre></div>
</div>
</section>
<section id="interpretation">
<h2><a class="toc-backref" href="#id7">Interpretation</a><a class="headerlink" href="#interpretation" title="Permalink to this headline">#</a></h2>
<p>We may wonder if we should extend the ONNX specifications to support
double for every operator. However, the fact the model predict a very
different value for an observation indicates the prediction cannot be
trusted as a very small modification of the input introduces a huge
change on the output. I would use a different model. We may also wonder
which prediction is the best one compare to the expected value…</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ypred</span> <span class="o">-</span> <span class="n">opred</span><span class="p">))</span>
<span class="n">i</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">26</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ypred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">opred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">opred64</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span> <span class="mf">43.1</span><span class="p">,</span> <span class="mf">43.1</span><span class="p">,</span> <span class="mf">43.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Well at the end, it is only luck on that kind of example.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="onnx_pdist.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Pairwise distances with ONNX (pdist)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="onnx_profile_ort.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Profiling with onnxruntime</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>