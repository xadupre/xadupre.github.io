
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Discrepencies with ONNX &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Einsum decomposition" href="einsum_decomposition.html" />
    <link rel="prev" title="Converts a logistic regression into C" href="sklearn_grammar_lr.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_ffts.html">
   ONNX FFTs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_fft.html">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-and-first-model">
   Data and first model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conversion-to-onnx">
   Conversion to ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-way-to-convert">
   Other way to convert
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#onnxpipeline">
   OnnxPipeline
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-explanation-standardscalerfloat">
   Final explanation: StandardScalerFloat
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#change-the-conversion-with-option-div">
   Change the conversion with option
   <em>
    div
   </em>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explanation-in-practice">
   Explanation in practice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="discrepencies-with-onnx">
<span id="onnxdiscrepenciesrst"></span><h1>Discrepencies with ONNX<a class="headerlink" href="#discrepencies-with-onnx" title="Permalink to this headline">#</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/4db27035413840ab238c80e8c515053a/onnx_discrepencies.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="onnx_discrepencies2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/4b52d4b359cd400087e8a2c37a1d65ed/onnx_discrepencies.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/a3316d0009043465945b1413176ab837/onnx_discrepencies.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="onnx_discrepencies.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/onnx_discrepencies.ipynb">GitHub</a></p>
<p>The notebook shows one example where the conversion leads with
discrepencies if default options are used. It converts a pipeline with
two steps, a scaler followed by a tree.</p>
<p>The bug this notebook is tracking does not always appear, it has a
better chance to happen with integer features but that’s not always the
case. The notebook must be run again in that case.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#data-and-first-model" id="id1">Data and first model</a></p></li>
<li><p><a class="reference internal" href="#conversion-to-onnx" id="id2">Conversion to ONNX</a></p></li>
<li><p><a class="reference internal" href="#other-way-to-convert" id="id3">Other way to convert</a></p></li>
<li><p><a class="reference internal" href="#onnxpipeline" id="id4">OnnxPipeline</a></p></li>
<li><p><a class="reference internal" href="#final-explanation-standardscalerfloat" id="id5">Final explanation: StandardScalerFloat</a></p></li>
<li><p><a class="reference internal" href="#change-the-conversion-with-option-div" id="id6">Change the conversion with option <em>div</em></a></p></li>
<li><p><a class="reference internal" href="#explanation-in-practice" id="id7">Explanation in practice</a></p></li>
<li><p><a class="reference internal" href="#conclusion" id="id8">Conclusion</a></p></li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<section id="data-and-first-model">
<h2><a class="toc-backref" href="#id1">Data and first model</a><a class="headerlink" href="#data-and-first-model" title="Permalink to this headline">#</a></h2>
<p>We take a random datasets with mostly integers.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">Xi_test</span><span class="p">,</span> <span class="n">yi_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">Xi_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xi_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">Xi_test</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xi_test</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>

<span class="n">max_depth</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xi_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">283.03708629</span><span class="p">,</span>  <span class="mf">263.17931397</span><span class="p">,</span> <span class="o">-</span><span class="mf">160.34784206</span><span class="p">,</span> <span class="o">-</span><span class="mf">126.59514441</span><span class="p">,</span>
       <span class="o">-</span><span class="mf">150.1963714</span> <span class="p">])</span>
</pre></div>
</div>
<p>Other models:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>
<span class="n">model3</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="p">])</span>


<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">model</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;no scaler&#39;</span><span class="p">,</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
     <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
     <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;max_depth=3&#39;</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
     <span class="n">model3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="conversion-to-onnx">
<h2><a class="toc-backref" href="#id2">Conversion to ONNX</a><a class="headerlink" href="#conversion-to-onnx" title="Permalink to this headline">#</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>

<span class="n">oinfpy</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python_compiled&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinfpy</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OnnxInference</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compiled_run</span><span class="p">(</span><span class="n">dict_inputs</span><span class="p">):</span>
        <span class="c1"># inputs</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">dict_inputs</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="p">(</span><span class="n">variable1</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">n0_scaler</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">n1_treeensembleregressor</span><span class="p">(</span><span class="n">variable1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>

<span class="n">X32</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y_skl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X32</span><span class="p">)</span>

<span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
    <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
    <span class="n">y_onx</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
    <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>

<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>v[1583]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>-439.590635</td>
    </tr>
    <tr>
      <th>1</th>
      <td>python</td>
      <td>133.641599</td>
      <td>-305.949036</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python_compiled</td>
      <td>133.641599</td>
      <td>-305.949036</td>
    </tr>
    <tr>
      <th>3</th>
      <td>onnxruntime1</td>
      <td>133.641599</td>
      <td>-305.949036</td>
    </tr>
  </tbody>
</table>
</div><p>The pipeline shows huge discrepencies. They appear for a pipeline
<em>StandardScaler</em> + <em>DecisionTreeRegressor</em> applied in integer features.
They disappear if floats are used, or if the scaler is removed. The bug
also disappear if the tree is not big enough (max_depth=4 instread of
5).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x32</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
        <span class="n">lonx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">x32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">loinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">lonx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
        <span class="n">y_skl</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X32</span><span class="p">)</span>
        <span class="n">y_onx</span> <span class="o">=</span> <span class="n">loinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>name</th>
      <th>v[1583]</th>
      <th>v[1109]</th>
      <th>v[19]</th>
      <th>v[4]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>sklearn</td>
      <td>-439.590635</td>
      <td>516.084502</td>
      <td>-549.753386</td>
      <td>-97.726497</td>
    </tr>
    <tr>
      <th>1</th>
      <td>python</td>
      <td>133.641599</td>
      <td>bug</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python_compiled</td>
      <td>133.641599</td>
      <td>bug</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>onnxruntime1</td>
      <td>133.641599</td>
      <td>bug</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>python</td>
      <td>0.000029</td>
      <td>no scaler</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>python_compiled</td>
      <td>0.000029</td>
      <td>no scaler</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>onnxruntime1</td>
      <td>0.000029</td>
      <td>no scaler</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>python</td>
      <td>0.000029</td>
      <td>float</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-549.753357</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>python_compiled</td>
      <td>0.000029</td>
      <td>float</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-549.753357</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>onnxruntime1</td>
      <td>0.000029</td>
      <td>float</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-549.753357</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>python</td>
      <td>0.000003</td>
      <td>max_depth=3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-97.726494</td>
    </tr>
    <tr>
      <th>11</th>
      <td>python_compiled</td>
      <td>0.000003</td>
      <td>max_depth=3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-97.726494</td>
    </tr>
    <tr>
      <th>12</th>
      <td>onnxruntime1</td>
      <td>0.000003</td>
      <td>max_depth=3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-97.726494</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;runtime&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>bug</th>
      <th>float</th>
      <th>max_depth=3</th>
      <th>no scaler</th>
      <th>sklearn</th>
    </tr>
    <tr>
      <th>runtime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>onnxruntime1</th>
      <td>133.641599</td>
      <td>0.000029</td>
      <td>0.000003</td>
      <td>0.000029</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>python</th>
      <td>133.641599</td>
      <td>0.000029</td>
      <td>0.000003</td>
      <td>0.000029</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>python_compiled</th>
      <td>133.641599</td>
      <td>0.000029</td>
      <td>0.000003</td>
      <td>0.000029</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>sklearn</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="other-way-to-convert">
<h2><a class="toc-backref" href="#id3">Other way to convert</a><a class="headerlink" href="#other-way-to-convert" title="Permalink to this headline">#</a></h2>
<p>ONNX does not support double for TreeEnsembleRegressor but that a new
operator TreeEnsembleRegressorDouble was implemented into <em>mlprodict</em>.
We need to update the conversion.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx32</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">onx64</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">%</span><span class="k">onnxview</span> onx64
</pre></div>
</div>
<div id="M365443388f39454e88273854e65f7098-cont"><div id="M365443388f39454e88273854e65f7098" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\ndouble((0, 10))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\ndouble((0, 1))\" fontsize=10];\n\n\n  variable1 [shape=box label=\"variable1\" fontsize=10];\n  Scaler [shape=box style=\"filled,rounded\" color=orange label=\"Scaler\n(Scaler)\noffset=[ 2.66666667e-03  5.8666...\nscale=[0.35824136 0.16805995 0....\" fontsize=10];\n  X -> Scaler;\n  Scaler -> variable1;\n\n  TreeEnsembleRegressorDouble [shape=box style=\"filled,rounded\" color=orange label=\"TreeEnsembleRegressorDouble\n(TreeEnsembleRegressorDouble)\nn_targets=1\nnodes_falsenodeids=[ 930  461  ...\nnodes_featureids=[7 8 3 ... 5 0...\nnodes_hitrates=[1. 1. 1. ... 1....\nnodes_missing_value_tracks_true=[0 0 0 ......\nnodes_modes=[b'BRANCH_LEQ' b'BR...\nnodes_nodeids=[   0    1    2 ....\nnodes_treeids=[0 0 0 ... 0 0 0]\nnodes_truenodeids=[   1    2   ...\nnodes_values=[-0.26122029  0.08...\npost_transform=b'NONE'\ntarget_ids=[0 0 0 0 0 0 0 0 0 0...\ntarget_nodeids=[   9   11   12 ...\ntarget_treeids=[0 0 0 0 0 0 0 0...\ntarget_weights=[-6.14043756e+02...\" fontsize=10];\n  variable1 -> TreeEnsembleRegressorDouble;\n  TreeEnsembleRegressorDouble -> variable;\n}");
document.getElementById('M365443388f39454e88273854e65f7098').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">X64</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">onx</span><span class="p">,</span> <span class="n">xr</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">onx32</span><span class="p">,</span> <span class="n">X32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="n">onx64</span><span class="p">,</span> <span class="n">X64</span><span class="p">)]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">real</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">y_skl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
        <span class="n">y_onx</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xr</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">real</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>

<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>v[1583]</th>
      <th>v[0]</th>
      <th>real</th>
      <th>error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>-439.590635</td>
      <td>-283.037086</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>python</td>
      <td>133.641599</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>float</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>-283.037086</td>
      <td>double</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>python_compiled</td>
      <td>133.641599</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>float</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>python_compiled</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>-283.037086</td>
      <td>double</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>onnxruntime1</td>
      <td>133.641599</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>float</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>onnxruntime1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>double</td>
      <td>Unable to create InferenceSession due to '[ONN...</td>
    </tr>
  </tbody>
</table>
</div><p>We see that the use of double removes the discrepencies.</p>
</section>
<section id="onnxpipeline">
<h2><a class="toc-backref" href="#id4">OnnxPipeline</a><a class="headerlink" href="#onnxpipeline" title="Permalink to this headline">#</a></h2>
<p>Another way to reduce the number of discrepencies is to use a pipeline
which converts every steps into ONNX before training the next one. That
way, every steps is either trained on the inputs, either trained on the
outputs produced by ONNX. Let’s see how it works.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.sklapi</span> <span class="kn">import</span> <span class="n">OnnxPipeline</span>

<span class="n">model_onx</span> <span class="o">=</span> <span class="n">OnnxPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>
<span class="n">model_onx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">C:xavierdupre__home_github_forkscikit-learnsklearnbase.py:209: FutureWarning: From version 0.24, get_params will raise an AttributeError if a parameter cannot be retrieved as an instance attribute. Previously it would return None.
  FutureWarning)</pre>
<pre class="literal-block">OnnxPipeline(steps=[('scaler',
                     OnnxTransformer(onnx_bytes=b'x08x06x12x08skl2onnxx1ax081.7.1076&quot;x07ai.onnx(x002x00:xf6x01nxa6x01nx01Xx12x08variablex1ax06Scaler&quot;x06Scaler*=nx06offset=&gt;xc3.;=+=xc0;=|xf2xb0&lt;=xcd`xf9&gt;=x89xad3xbd=RLxabxbf=Vxc4Vxbe=6&lt;x9dxc0=B&gt;xa0&#64;=xbbx93xea&#64;xa0x01x06*&lt;nx05scale=ikxb7&gt;=xe8x17,&gt;=)xb5xa9==xa7xd5#==Qx9exa1&lt;=xf5)$&lt;=x90&lt;xa2;=(D%;=axa8xa1:= x9f$:xa0x01x06:nai.onnx.mlx12x1emlprodict_ONNX(StandardScaler)Zx11nx01Xx12x0cnnx08x01x12x06nx00nx02x08nbx18nx08variablex12x0cnnx08x01x12x06nx00nx02x08nBx0ennai.onnx.mlx10x01')),
                    ('dt', DecisionTreeRegressor(max_depth=10))])</pre>
<p>We see that the first steps was replaced by an object <em>OnnxTransformer</em>
which wraps an ONNX file into a transformer following the <em>scikit-learn</em>
API. The initial steps are still available.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_onx</span><span class="o">.</span><span class="n">raw_steps_</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">model</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;OnnxPipeline&#39;</span><span class="p">,</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">model_onx</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x32</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
        <span class="n">lonx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">x32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">loinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">lonx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
        <span class="n">y_skl</span> <span class="o">=</span> <span class="n">model_onx</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X32</span><span class="p">)</span>  <span class="c1"># model_onx is the new baseline</span>
        <span class="n">y_onx</span> <span class="o">=</span> <span class="n">loinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>name</th>
      <th>v[2276]</th>
      <th>v[1109]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>sklearn</td>
      <td>272.784708</td>
      <td>516.084502</td>
    </tr>
    <tr>
      <th>1</th>
      <td>python</td>
      <td>234.930666</td>
      <td>bug</td>
      <td>37.854042</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python_compiled</td>
      <td>234.930666</td>
      <td>bug</td>
      <td>37.854042</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>onnxruntime1</td>
      <td>234.930666</td>
      <td>bug</td>
      <td>37.854042</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>python</td>
      <td>0.000029</td>
      <td>OnnxPipeline</td>
      <td>NaN</td>
      <td>516.084473</td>
    </tr>
    <tr>
      <th>5</th>
      <td>python_compiled</td>
      <td>0.000029</td>
      <td>OnnxPipeline</td>
      <td>NaN</td>
      <td>516.084473</td>
    </tr>
    <tr>
      <th>6</th>
      <td>onnxruntime1</td>
      <td>0.000029</td>
      <td>OnnxPipeline</td>
      <td>NaN</td>
      <td>516.084473</td>
    </tr>
  </tbody>
</table>
</div><p>Training the next steps based on ONNX outputs is better. This is not
completely satisfactory… Let’s check the accuracy.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">Xi_test</span><span class="p">,</span> <span class="n">yi_test</span><span class="p">),</span> <span class="n">model_onx</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">Xi_test</span><span class="p">,</span> <span class="n">yi_test</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mf">0.6492778377907853</span><span class="p">,</span> <span class="mf">0.6536515451871481</span><span class="p">)</span>
</pre></div>
</div>
<p>Pretty close.</p>
</section>
<section id="final-explanation-standardscalerfloat">
<h2><a class="toc-backref" href="#id5">Final explanation: StandardScalerFloat</a><a class="headerlink" href="#final-explanation-standardscalerfloat" title="Permalink to this headline">#</a></h2>
<p>We proposed two ways to have an ONNX pipeline which produces the same
prediction as <em>scikit-learn</em>. Let’s now replace the StandardScaler by a
new one which outputs float and not double. It turns out that class
<em>StandardScaler</em> computes <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">/=</span> <span class="pre">self.scale_</span></code> but ONNX does
<code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">*=</span> <span class="pre">self.scale_inv_</span></code>. We need to implement this exact same operator
with float32 to remove all discrepencies.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StandardScalerFloat</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_std</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">StandardScaler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_mean</span><span class="o">=</span><span class="n">with_mean</span><span class="p">,</span> <span class="n">with_std</span><span class="o">=</span><span class="n">with_std</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">StandardScaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_inv_</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_mean</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_std</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_inv_</span>
        <span class="k">return</span> <span class="n">X</span>


<span class="n">model_float</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScalerFloat</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model_float</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">yi_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScalerFloat</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">onx_float</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model_float</span><span class="p">,</span> <span class="n">Xi_test</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">shape</span> <span class="n">calculator</span> <span class="k">for</span> <span class="nb">type</span> <span class="s1">&#39;&lt;class &#39;</span><span class="n">__main__</span><span class="o">.</span><span class="n">StandardScalerFloat</span><span class="s1">&#39;&gt;&#39;</span><span class="o">.</span>
<span class="n">It</span> <span class="n">usually</span> <span class="n">means</span> <span class="n">the</span> <span class="n">pipeline</span> <span class="n">being</span> <span class="n">converted</span> <span class="n">contains</span> <span class="n">a</span>
<span class="n">transformer</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">predictor</span> <span class="k">with</span> <span class="n">no</span> <span class="n">corresponding</span> <span class="n">converter</span>
<span class="n">implemented</span> <span class="ow">in</span> <span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">converted</span> <span class="ow">is</span> <span class="n">implemented</span>
<span class="ow">in</span> <span class="n">another</span> <span class="n">library</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">register</span>
<span class="n">the</span> <span class="n">converted</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">by</span> <span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span> <span class="p">(</span><span class="n">function</span>
<span class="n">update_registered_converter</span><span class="p">)</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">covered</span>
<span class="n">by</span> <span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="p">,</span> <span class="n">you</span> <span class="n">may</span> <span class="k">raise</span> <span class="n">an</span> <span class="n">issue</span> <span class="n">to</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">onnx</span><span class="o">/</span><span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="o">/</span><span class="n">issues</span>
<span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">converter</span> <span class="n">implemented</span> <span class="ow">or</span> <span class="n">even</span> <span class="n">contribute</span> <span class="n">to</span> <span class="n">the</span>
<span class="n">project</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">model</span><span class="p">,</span> <span class="n">a</span> <span class="n">new</span> <span class="n">converter</span> <span class="n">must</span>
<span class="n">be</span> <span class="n">implemented</span><span class="o">.</span> <span class="n">Examples</span> <span class="n">can</span> <span class="n">be</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">gallery</span><span class="o">.</span>
</pre></div>
</div>
<p>We need to register a new converter so that <em>sklearn-onnx</em> knows how to
convert the new scaler. We reuse the existing converters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">update_registered_converter</span>
<span class="kn">from</span> <span class="nn">skl2onnx.operator_converters.scaler_op</span> <span class="kn">import</span> <span class="n">convert_sklearn_scaler</span>
<span class="kn">from</span> <span class="nn">skl2onnx.shape_calculators.scaler</span> <span class="kn">import</span> <span class="n">calculate_sklearn_scaler_output_shapes</span>


<span class="n">update_registered_converter</span><span class="p">(</span>
    <span class="n">StandardScalerFloat</span><span class="p">,</span> <span class="s2">&quot;SklearnStandardScalerFloat&quot;</span><span class="p">,</span>
    <span class="n">calculate_sklearn_scaler_output_shapes</span><span class="p">,</span>
    <span class="n">convert_sklearn_scaler</span><span class="p">,</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;div&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="s1">&#39;div_cast&#39;</span><span class="p">]})</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">model</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;FloatPipeline&#39;</span><span class="p">,</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">model_float</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x32</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
        <span class="n">lonx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">x32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">loinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">lonx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
        <span class="n">y_skl</span> <span class="o">=</span> <span class="n">model_float</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X32</span><span class="p">)</span>  <span class="c1"># we use model_float as a baseline</span>
        <span class="n">y_onx</span> <span class="o">=</span> <span class="n">loinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>name</th>
      <th>v[1489]</th>
      <th>v[1109]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>sklearn</td>
      <td>378.038116</td>
      <td>516.084493</td>
    </tr>
    <tr>
      <th>1</th>
      <td>python</td>
      <td>273.322334</td>
      <td>bug</td>
      <td>104.715782</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python_compiled</td>
      <td>273.322334</td>
      <td>bug</td>
      <td>104.715782</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>onnxruntime1</td>
      <td>273.322334</td>
      <td>bug</td>
      <td>104.715782</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>python</td>
      <td>0.000020</td>
      <td>FloatPipeline</td>
      <td>NaN</td>
      <td>516.084473</td>
    </tr>
    <tr>
      <th>5</th>
      <td>python_compiled</td>
      <td>0.000020</td>
      <td>FloatPipeline</td>
      <td>NaN</td>
      <td>516.084473</td>
    </tr>
    <tr>
      <th>6</th>
      <td>onnxruntime1</td>
      <td>0.000020</td>
      <td>FloatPipeline</td>
      <td>NaN</td>
      <td>516.084473</td>
    </tr>
  </tbody>
</table>
</div><p>That means than the differences between <code class="docutils literal notranslate"><span class="pre">float32(X</span> <span class="pre">/</span> <span class="pre">Y)</span></code> and
<code class="docutils literal notranslate"><span class="pre">float32(X)</span> <span class="pre">*</span> <span class="pre">float32(1</span> <span class="pre">/</span> <span class="pre">Y)</span></code> are big enough to select a different
path in the decision tree. <code class="docutils literal notranslate"><span class="pre">float32(X)</span> <span class="pre">/</span> <span class="pre">float32(Y)</span></code> and
<code class="docutils literal notranslate"><span class="pre">float32(X)</span> <span class="pre">*</span> <span class="pre">float32(1</span> <span class="pre">/</span> <span class="pre">Y)</span></code> are also different enough to trigger a
different path. Let’s illustrate that on example:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">a2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1000</span>
<span class="n">a3</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">a3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1000</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">]):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">max_diff32</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">([</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
    <span class="n">max_diff64</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">([</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">max_diff32</span><span class="p">,</span> <span class="n">max_diff64</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="mf">1.9073486e-06</span> <span class="mf">7.105427357601002e-15</span>
<span class="mi">1</span> <span class="mf">3.7252903e-09</span> <span class="mf">3.469446951953614e-18</span>
<span class="mi">2</span> <span class="mf">0.00390625</span> <span class="mf">7.275957614183426e-12</span>
</pre></div>
</div>
<p>The last random set shows very big differences, obviously big enough to
trigger a different path in the graph. The difference for double could
probably be significant in some cases, not enough on this example.</p>
</section>
<section id="change-the-conversion-with-option-div">
<h2><a class="toc-backref" href="#id6">Change the conversion with option <em>div</em></a><a class="headerlink" href="#change-the-conversion-with-option-div" title="Permalink to this headline">#</a></h2>
<p>Option <code class="docutils literal notranslate"><span class="pre">'div'</span></code> was added to the converter for <em>StandardScaler</em> to
change the way the scaler is converted.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx_std</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="o">%</span><span class="k">onnxview</span> onx_std
</pre></div>
</div>
<div id="Mf2605ecdcd5a40f88e17e654b5b25cb3-cont"><div id="Mf2605ecdcd5a40f88e17e654b5b25cb3" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 10))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\nfloat((0, 1))\" fontsize=10];\n\n\n  variable1 [shape=box label=\"variable1\" fontsize=10];\n  Scaler [shape=box style=\"filled,rounded\" color=orange label=\"Scaler\n(Scaler)\noffset=[ 2.6666666e-03  5.86666...\nscale=[0.35824135 0.16805995 0....\" fontsize=10];\n  X -> Scaler;\n  Scaler -> variable1;\n\n  TreeEnsembleRegressor [shape=box style=\"filled,rounded\" color=orange label=\"TreeEnsembleRegressor\n(TreeEnsembleRegressor)\nn_targets=1\nnodes_falsenodeids=[ 930  461  ...\nnodes_featureids=[7 8 3 ... 7 0...\nnodes_hitrates=[1. 1. 1. ... 1....\nnodes_missing_value_tracks_true=[0 0 0 ......\nnodes_modes=[b'BRANCH_LEQ' b'BR...\nnodes_nodeids=[   0    1    2 ....\nnodes_treeids=[0 0 0 ... 0 0 0]\nnodes_truenodeids=[   1    2   ...\nnodes_values=[-0.2612203   0.08...\npost_transform=b'NONE'\ntarget_ids=[0 0 0 0 0 0 0 0 0 0...\ntarget_nodeids=[  10   11   12 ...\ntarget_treeids=[0 0 0 0 0 0 0 0...\ntarget_weights=[-5.76468811e+02...\" fontsize=10];\n  variable1 -> TreeEnsembleRegressor;\n  TreeEnsembleRegressor -> variable;\n}");
document.getElementById('Mf2605ecdcd5a40f88e17e654b5b25cb3').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx_div</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                  <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">StandardScaler</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;div&#39;</span><span class="p">:</span> <span class="s1">&#39;div&#39;</span><span class="p">}})</span>
<span class="o">%</span><span class="k">onnxview</span> onx_div
</pre></div>
</div>
<div id="Md568d7f27c08496d92427f853145d394-cont"><div id="Md568d7f27c08496d92427f853145d394" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 10))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\nfloat((0, 1))\" fontsize=10];\n\n  Su_Subcst [shape=box label=\"Su_Subcst\nfloat32((10,))\n[ 2.6666666e-03  5.8666668e-03  2.1600001e-02  4.8...\" fontsize=10];\n  Di_Divcst [shape=box label=\"Di_Divcst\nfloat32((10,))\n[   2.791414    5.950258   12.067811   25.000826  ...\" fontsize=10];\n\n  Su_C0 [shape=box label=\"Su_C0\" fontsize=10];\n  Su_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub)\" fontsize=10];\n  X -> Su_Sub;\n  Su_Subcst -> Su_Sub;\n  Su_Sub -> Su_C0;\n\n  variable1 [shape=box label=\"variable1\" fontsize=10];\n  Di_Div [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(Di_Div)\" fontsize=10];\n  Su_C0 -> Di_Div;\n  Di_Divcst -> Di_Div;\n  Di_Div -> variable1;\n\n  TreeEnsembleRegressor [shape=box style=\"filled,rounded\" color=orange label=\"TreeEnsembleRegressor\n(TreeEnsembleRegressor)\nn_targets=1\nnodes_falsenodeids=[ 930  461  ...\nnodes_featureids=[7 8 3 ... 7 0...\nnodes_hitrates=[1. 1. 1. ... 1....\nnodes_missing_value_tracks_true=[0 0 0 ......\nnodes_modes=[b'BRANCH_LEQ' b'BR...\nnodes_nodeids=[   0    1    2 ....\nnodes_treeids=[0 0 0 ... 0 0 0]\nnodes_truenodeids=[   1    2   ...\nnodes_values=[-0.2612203   0.08...\npost_transform=b'NONE'\ntarget_ids=[0 0 0 0 0 0 0 0 0 0...\ntarget_nodeids=[  10   11   12 ...\ntarget_treeids=[0 0 0 0 0 0 0 0...\ntarget_weights=[-5.76468811e+02...\" fontsize=10];\n  variable1 -> TreeEnsembleRegressor;\n  TreeEnsembleRegressor -> variable;\n}");
document.getElementById('Md568d7f27c08496d92427f853145d394').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx_div_cast</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                       <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">StandardScaler</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;div&#39;</span><span class="p">:</span> <span class="s1">&#39;div_cast&#39;</span><span class="p">}})</span>
<span class="o">%</span><span class="k">onnxview</span> onx_div_cast
</pre></div>
</div>
<div id="M4b52eb3ba264417ba7be4c07b28ae471-cont"><div id="M4b52eb3ba264417ba7be4c07b28ae471" style="width:100%;height:100%;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\nfloat((0, 10))\" fontsize=10];\n\n  variable [shape=box color=green label=\"variable\nfloat((0, 1))\" fontsize=10];\n\n  Su_Subcst [shape=box label=\"Su_Subcst\nfloat64((10,))\n[ 2.66666664e-03  5.86666679e-03  2.16000006e-02  ...\" fontsize=10];\n  Di_Divcst [shape=box label=\"Di_Divcst\nfloat64((10,))\n[   2.79141414    5.95025761   12.06781118   25.00...\" fontsize=10];\n\n  Ca_output0 [shape=box label=\"Ca_output0\" fontsize=10];\n  Ca_Cast [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Ca_Cast)\nto=11\" fontsize=10];\n  X -> Ca_Cast;\n  Ca_Cast -> Ca_output0;\n\n  Su_C0 [shape=box label=\"Su_C0\" fontsize=10];\n  Su_Sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\n(Su_Sub)\" fontsize=10];\n  Ca_output0 -> Su_Sub;\n  Su_Subcst -> Su_Sub;\n  Su_Sub -> Su_C0;\n\n  Di_C0 [shape=box label=\"Di_C0\" fontsize=10];\n  Di_Div [shape=box style=\"filled,rounded\" color=orange label=\"Div\n(Di_Div)\" fontsize=10];\n  Su_C0 -> Di_Div;\n  Di_Divcst -> Di_Div;\n  Di_Div -> Di_C0;\n\n  variable1 [shape=box label=\"variable1\" fontsize=10];\n  Ca_Cast1 [shape=box style=\"filled,rounded\" color=orange label=\"Cast\n(Ca_Cast1)\nto=1\" fontsize=10];\n  Di_C0 -> Ca_Cast1;\n  Ca_Cast1 -> variable1;\n\n  TreeEnsembleRegressor [shape=box style=\"filled,rounded\" color=orange label=\"TreeEnsembleRegressor\n(TreeEnsembleRegressor)\nn_targets=1\nnodes_falsenodeids=[ 930  461  ...\nnodes_featureids=[7 8 3 ... 7 0...\nnodes_hitrates=[1. 1. 1. ... 1....\nnodes_missing_value_tracks_true=[0 0 0 ......\nnodes_modes=[b'BRANCH_LEQ' b'BR...\nnodes_nodeids=[   0    1    2 ....\nnodes_treeids=[0 0 0 ... 0 0 0]\nnodes_truenodeids=[   1    2   ...\nnodes_values=[-0.2612203   0.08...\npost_transform=b'NONE'\ntarget_ids=[0 0 0 0 0 0 0 0 0 0...\ntarget_nodeids=[  10   11   12 ...\ntarget_treeids=[0 0 0 0 0 0 0 0...\ntarget_weights=[-5.76468811e+02...\" fontsize=10];\n  variable1 -> TreeEnsembleRegressor;\n  TreeEnsembleRegressor -> variable;\n}");
document.getElementById('M4b52eb3ba264417ba7be4c07b28ae471').innerHTML = svgGraph; });

</script><p>The ONNX graph is different and using division. Let’s measure the
discrepencies.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">X64</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">onx_std</span><span class="p">),</span>
          <span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">onx_div</span><span class="p">),</span>
          <span class="p">(</span><span class="s1">&#39;div_cast&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">onx_div_cast</span><span class="p">),]</span>

<span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">onx</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
        <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
        <span class="n">y_skl32</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X32</span><span class="p">)</span>
        <span class="n">y_skl64</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X64</span><span class="p">)</span>
        <span class="n">y_onx</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>

        <span class="n">delta32</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl32</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">am32</span> <span class="o">=</span> <span class="n">delta32</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">delta64</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl64</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">am64</span> <span class="o">=</span> <span class="n">delta64</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

        <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff32</span><span class="o">=</span><span class="n">delta32</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="n">diff64</span><span class="o">=</span><span class="n">delta64</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v32[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am32</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl32</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am32</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v64[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am64</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl64</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am64</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v32[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am32</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am32</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v64[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am64</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am64</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>name</th>
      <th>v32[1583]</th>
      <th>v64[1246]</th>
      <th>v32[1246]</th>
      <th>v64[2080]</th>
      <th>v64[1109]</th>
      <th>diff32</th>
      <th>diff64</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.0</td>
      <td>sklearn</td>
      <td>-439.590635</td>
      <td>-364.555875</td>
      <td>-203.438616</td>
      <td>171.604023</td>
      <td>516.084502</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>python</td>
      <td>NaN</td>
      <td>bug</td>
      <td>-305.949036</td>
      <td>-203.438614</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>133.641599</td>
      <td>161.117261</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python_compiled</td>
      <td>NaN</td>
      <td>bug</td>
      <td>-305.949036</td>
      <td>-203.438614</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>133.641599</td>
      <td>161.117261</td>
    </tr>
    <tr>
      <th>3</th>
      <td>onnxruntime1</td>
      <td>NaN</td>
      <td>bug</td>
      <td>-305.949036</td>
      <td>-203.438614</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>133.641599</td>
      <td>161.117261</td>
    </tr>
    <tr>
      <th>4</th>
      <td>python</td>
      <td>NaN</td>
      <td>div</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>329.592377</td>
      <td>NaN</td>
      <td>161.117261</td>
      <td>157.988354</td>
    </tr>
    <tr>
      <th>5</th>
      <td>python_compiled</td>
      <td>NaN</td>
      <td>div</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>329.592377</td>
      <td>NaN</td>
      <td>161.117261</td>
      <td>157.988354</td>
    </tr>
    <tr>
      <th>6</th>
      <td>onnxruntime1</td>
      <td>NaN</td>
      <td>div</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>329.592377</td>
      <td>NaN</td>
      <td>161.117261</td>
      <td>157.988354</td>
    </tr>
    <tr>
      <th>7</th>
      <td>python</td>
      <td>NaN</td>
      <td>div_cast</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>161.117261</td>
      <td>0.000029</td>
    </tr>
    <tr>
      <th>8</th>
      <td>python_compiled</td>
      <td>NaN</td>
      <td>div_cast</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>161.117261</td>
      <td>0.000029</td>
    </tr>
    <tr>
      <th>9</th>
      <td>onnxruntime1</td>
      <td>NaN</td>
      <td>div_cast</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>161.117261</td>
      <td>0.000029</td>
    </tr>
  </tbody>
</table>
</div><p>The only combination which works is the model converted with option
<em>div_cast</em> (use of division in double precision), float input for ONNX,
double input for <em>scikit-learn</em>.</p>
</section>
<section id="explanation-in-practice">
<h2><a class="toc-backref" href="#id7">Explanation in practice</a><a class="headerlink" href="#explanation-in-practice" title="Permalink to this headline">#</a></h2>
<p>Based on previous sections, the following example buids a case where
discreprencies are significant.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">std</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">)</span>
<span class="n">xt32</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">xt64</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xt32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>

<span class="n">onx32</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">sess32</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx32</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">got32</span> <span class="o">=</span> <span class="n">sess32</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xt32</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">d32</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">got32</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="n">d32</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.3841858e-07</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oinf32</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx32</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">gotpy32</span> <span class="o">=</span> <span class="n">oinf32</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xt32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
<span class="n">dpy32</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">gotpy32</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="n">dpy32</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.3841858e-07</span>
</pre></div>
</div>
<p>We tried to cast float into double before applying the normalisation and
to cast back into single float. It does not help much.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx64</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">std</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;div&#39;</span><span class="p">:</span> <span class="s1">&#39;div&#39;</span><span class="p">}})</span>
<span class="n">sess64</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx64</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">got64</span> <span class="o">=</span> <span class="n">sess64</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xt32</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">d64</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">got64</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="n">d64</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.3841858e-07</span>
</pre></div>
</div>
<p>Last experiment, we try to use double all along.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnxruntime.capi.onnxruntime_pybind11_state</span> <span class="kn">import</span> <span class="n">InvalidGraph</span>

<span class="n">onx64_2</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">sess64_2</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx64_2</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="k">except</span> <span class="n">InvalidGraph</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ONNXRuntimeError</span><span class="p">]</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">INVALID_GRAPH</span> <span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">model</span><span class="o">.</span> <span class="n">Error</span> <span class="ow">in</span> <span class="n">Node</span><span class="p">:</span><span class="n">Scaler</span> <span class="p">:</span> <span class="n">Mismatched</span> <span class="n">attribute</span> <span class="nb">type</span> <span class="ow">in</span> <span class="s1">&#39;Scaler : offset&#39;</span>
</pre></div>
</div>
<p><em>onnxruntime</em> does not support this. Let’s switch to <em>mlprodict</em>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onx64_2</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="n">sess64_2</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx64_2</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
<span class="n">pred64</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xt64</span><span class="p">)</span>
<span class="n">got64_2</span> <span class="o">=</span> <span class="n">sess64_2</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xt64</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
<span class="n">d64_2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred64</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">got64_2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
<span class="n">d64_2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">4.440892098500626e-16</span>
</pre></div>
</div>
<p>Differences are lower if every operator is done with double.</p>
</section>
<section id="conclusion">
<h2><a class="toc-backref" href="#id8">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">#</a></h2>
<p>Maybe the best option is just to introduce a transform which just cast
inputs into floats.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model1</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skl2onnx.sklapi</span> <span class="kn">import</span> <span class="n">CastTransformer</span>

<span class="n">model2</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;cast64&#39;</span><span class="p">,</span> <span class="n">CastTransformer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;cast&#39;</span><span class="p">,</span> <span class="n">CastTransformer</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xi_train</span><span class="p">,</span> <span class="n">yi_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;cast64&#39;, CastTransformer(dtype=&lt;class &#39;numpy.float64&#39;&gt;)),
                (&#39;scaler&#39;, StandardScaler()), (&#39;cast&#39;, CastTransformer()),
                (&#39;dt&#39;, DecisionTreeRegressor(max_depth=10))])
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model1&#39;</span><span class="p">,</span> <span class="n">model1</span><span class="p">,</span> <span class="n">X32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;model2&#39;</span><span class="p">,</span> <span class="n">model2</span><span class="p">,</span> <span class="n">X32</span><span class="p">)]</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;div_cast&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">StandardScaler</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;div&#39;</span><span class="p">:</span> <span class="s1">&#39;div_cast&#39;</span><span class="p">}})]</span>

<span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;model1&#39;</span><span class="p">),</span>
       <span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;model2&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">x32</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">no</span><span class="p">,</span> <span class="n">opts</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">Xi_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="n">options</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;python_compiled&#39;</span><span class="p">,</span> <span class="s1">&#39;onnxruntime1&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">no</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">y_skl</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x32</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y_onx</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x32</span><span class="p">})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">no</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">delta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_skl</span> <span class="o">-</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">am</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">no</span><span class="p">))</span>
            <span class="n">obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_onx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;model1&#39;</span><span class="p">:</span>
                <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
                <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xi_test</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;model2&#39;</span><span class="p">:</span>
                <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xi_test</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>
                <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;v[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">am</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_skl</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">am</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>runtime</th>
      <th>diff</th>
      <th>name</th>
      <th>v[1583]</th>
      <th>v[1246]</th>
      <th>v[1109]</th>
      <th>options</th>
      <th>err</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>model1</td>
      <td>-439.590635</td>
      <td>-162.952888</td>
      <td>516.084502</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>sklearn</td>
      <td>0.000000</td>
      <td>model2</td>
      <td>-439.590635</td>
      <td>-364.555875</td>
      <td>516.084502</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>python</td>
      <td>133.641599</td>
      <td>model1</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>python_compiled</td>
      <td>133.641599</td>
      <td>model1</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>onnxruntime1</td>
      <td>133.641599</td>
      <td>model1</td>
      <td>-305.949036</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>python</td>
      <td>201.602989</td>
      <td>model1</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>NaN</td>
      <td>div_cast</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>python_compiled</td>
      <td>201.602989</td>
      <td>model1</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>NaN</td>
      <td>div_cast</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>onnxruntime1</td>
      <td>201.602989</td>
      <td>model1</td>
      <td>NaN</td>
      <td>-364.555878</td>
      <td>NaN</td>
      <td>div_cast</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>python</td>
      <td>0.000029</td>
      <td>model2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>-</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>python_compiled</td>
      <td>0.000029</td>
      <td>model2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>-</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>onnxruntime1</td>
      <td>NaN</td>
      <td>model2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-</td>
      <td>Unable to create InferenceSession due to '[ONN...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>python</td>
      <td>0.000029</td>
      <td>model2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>div_cast</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>12</th>
      <td>python_compiled</td>
      <td>0.000029</td>
      <td>model2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>div_cast</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>13</th>
      <td>onnxruntime1</td>
      <td>0.000029</td>
      <td>model2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>516.084473</td>
      <td>div_cast</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div><p>It seems to work that way.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="sklearn_grammar_lr.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Converts a logistic regression into C</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="einsum_decomposition.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Einsum decomposition</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>