
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ONNX and FFT &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="../_static/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ONNX graph, single or double floats" href="onnx_float32_and_64.html" />
    <link rel="prev" title="ONNX FFTs" href="onnx_ffts.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn_grammar_lr.html">
   Converts a logistic regression into C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_discrepencies.html">
   Discrepencies with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="einsum_decomposition.html">
   Einsum decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="topk_cpp.html">
   Fast TopK elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_operator_cost.html">
   Infer operator computation cost
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ccl.html">
   Introduction to a numpy API for ONNX: CustomClassifier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx_ftr.html">
   Introduction to a numpy API for ONNX: FunctionTransformer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lightgbm_double.html">
   Lightgbm, double, discrepencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="loss_functions.html">
   Loss function in ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile.html">
   Memory usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_ffts.html">
   ONNX FFTs
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   ONNX and FFT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float32_and_64.html">
   ONNX graph, single or double floats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_sbs.html">
   ONNX side by side
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_visualization.html">
   ONNX visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_pdist.html">
   Pairwise distances with ONNX (pdist)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_shaker.html">
   Precision loss due to float32 conversion with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_profile_ort.html">
   Profiling with onnxruntime
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_node_time.html">
   Time processing for every ONNX nodes in a graph
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transfer_learning.html">
   Transfer Learning with ONNX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_float_double_skl_decision_trees.html">
   Tricky detail when converting a random forest from scikit-learn into ONNX
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#python-implementation-of-rfft">
   Python implementation of RFFT
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rfft-in-onnx">
   RFFT in ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fft-2d">
   FFT 2D
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fft-2d-in-onnx">
   FFT 2D in ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fft2d-with-shape-3-1-4">
   FFT2D with shape (3,1,4)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-version">
     numpy version
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#onnx-version">
     ONNX version
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#onnx-graph">
     ONNX graph
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="onnx-and-fft">
<span id="onnxfftrst"></span><h1>ONNX and FFT<a class="headerlink" href="#onnx-and-fft" title="Permalink to this headline">#</a></h1>
<p><strong>Links:</strong> <a class="reference download internal" download="" href="../_downloads/301947d48d1fde752e6251e2d375e048/onnx_fft.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">notebook</span></code></a>, <a class="reference internal" href="onnx_fft2html.html">html</a>, <a class="reference download internal" download="" href="../_downloads/a7aff13722fcc6d917df04c2be00ace7/onnx_fft.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a>, <a class="reference download internal" download="" href="../_downloads/f94c67c315218ceec770e34383908226/onnx_fft.py"><code class="xref download docutils literal notranslate"><span class="pre">python</span></code></a>, <a class="reference internal" href="onnx_fft.slides.html">slides</a>, <a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_doc/notebooks/onnx_fft.ipynb">GitHub</a></p>
<p>ONNX does not fully support complex yet. It does not have any FFT
operators either. What if we need them anyway?</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jyquickhelper</span> <span class="kn">import</span> <span class="n">add_notebook_menu</span>
<span class="n">add_notebook_menu</span><span class="p">()</span>
</pre></div>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#python-implementation-of-rfft" id="id1">Python implementation of RFFT</a></p></li>
<li><p><a class="reference internal" href="#rfft-in-onnx" id="id2">RFFT in ONNX</a></p></li>
<li><p><a class="reference internal" href="#fft-2d" id="id3">FFT 2D</a></p></li>
<li><p><a class="reference internal" href="#fft-2d-in-onnx" id="id4">FFT 2D in ONNX</a></p></li>
<li><p><a class="reference internal" href="#fft2d-with-shape-3-1-4" id="id5">FFT2D with shape (3,1,4)</a></p>
<ul>
<li><p><a class="reference internal" href="#numpy-version" id="id6">numpy version</a></p></li>
<li><p><a class="reference internal" href="#onnx-version" id="id7">ONNX version</a></p></li>
<li><p><a class="reference internal" href="#onnx-graph" id="id8">ONNX graph</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> mlprodict
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">numpy</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;1.21.5&#39;</span>
</pre></div>
</div>
<section id="python-implementation-of-rfft">
<h2><a class="toc-backref" href="#id1">Python implementation of RFFT</a><a class="headerlink" href="#python-implementation-of-rfft" title="Permalink to this headline">#</a></h2>
<p>We try to replicate
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.fft.rfft.html">numpy.rfft</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>


<span class="k">def</span> <span class="nf">almost_equal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function compares two matrices, one may be complex. In that case,</span>
<span class="sd">    this matrix is changed into a new matrix with a new first dimension,</span>
<span class="sd">    [0,::] means real part, [1,::] means imaginary part.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span>
        <span class="n">new_a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,)</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">new_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">new_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">almost_equal</span><span class="p">(</span><span class="n">new_a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">almost_equal</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Shape mismatch </span><span class="si">%r</span><span class="s2"> != </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Mismatch max diff=</span><span class="si">%r</span><span class="s2"> &gt; </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">dft_real_cst</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="n">both</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,)</span> <span class="o">+</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">both</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">both</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">both</span>


<span class="k">def</span> <span class="nf">dft_real</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">transpose</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fft_length</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">cst</span> <span class="o">=</span> <span class="n">dft_real_cst</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">fft_np</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
<span class="n">fft_cus</span> <span class="o">=</span> <span class="n">dft_real</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
<span class="n">fft_np</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.33227623</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">1.53729601</span><span class="o">-</span><span class="mf">0.93413037</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">4.47973719</span><span class="o">+</span><span class="mf">2.89019374</span><span class="n">j</span><span class="p">,</span>  <span class="mf">1.36392938</span><span class="o">-</span><span class="mf">2.59133368</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.07591467</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.51947711</span><span class="o">+</span><span class="mf">0.624144</span><span class="n">j</span>  <span class="p">,</span>
        <span class="o">-</span><span class="mf">2.48242622</span><span class="o">-</span><span class="mf">1.56579382</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.98728199</span><span class="o">+</span><span class="mf">2.81434946</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">0.55875075</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">0.83228203</span><span class="o">+</span><span class="mf">2.25251549</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">0.48281369</span><span class="o">+</span><span class="mf">2.69338405</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.86559293</span><span class="o">+</span><span class="mf">0.08437194</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.26185111</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">1.18143684</span><span class="o">+</span><span class="mf">1.73623491</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">0.96002386</span><span class="o">+</span><span class="mf">0.39340971</span><span class="n">j</span><span class="p">,</span>  <span class="mf">3.53861562</span><span class="o">-</span><span class="mf">1.32858241</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.06276855</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">3.07258661</span><span class="o">-</span><span class="mf">2.71505518</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.82579331</span><span class="o">-</span><span class="mf">1.91852778</span><span class="n">j</span><span class="p">,</span>  <span class="mf">4.10811113</span><span class="o">-</span><span class="mf">0.46836687</span><span class="n">j</span><span class="p">]])</span>
</pre></div>
</div>
<p>Function <code class="docutils literal notranslate"><span class="pre">almost_equal</span></code> verifies both functions return the same
results.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">almost_equal</span><span class="p">(</span><span class="n">fft_np</span><span class="p">,</span> <span class="n">fft_cus</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s do the same with <code class="docutils literal notranslate"><span class="pre">fft_length</span> <span class="pre">&lt;</span> <span class="pre">shape[1]</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft_np3</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fft_cus3</span> <span class="o">=</span> <span class="n">dft_real</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fft_np3</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.86976612</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">2.20926839</span><span class="o">+</span><span class="mf">0.35688821</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.33280143</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">1.41451804</span><span class="o">+</span><span class="mf">0.2065253</span><span class="n">j</span> <span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">2.30690554</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.51297992</span><span class="o">+</span><span class="mf">0.62331197</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">0.72842433</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">1.84198139</span><span class="o">+</span><span class="mf">1.07546916</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">4.17533261</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.86360028</span><span class="o">+</span><span class="mf">0.36508775</span><span class="n">j</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">almost_equal</span><span class="p">(</span><span class="n">fft_np3</span><span class="p">,</span> <span class="n">fft_cus3</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="rfft-in-onnx">
<h2><a class="toc-backref" href="#id2">RFFT in ONNX</a><a class="headerlink" href="#rfft-in-onnx" title="Permalink to this headline">#</a></h2>
<p>Let’s assume first the number of column of the input matrix is fixed.
The result of function <code class="docutils literal notranslate"><span class="pre">dft_real_cst</span></code> can be considered as constant.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_np</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.onnx_numpy_annotation</span> <span class="kn">import</span> <span class="n">NDArrayType</span>
<span class="c1"># from mlprodict.onnxrt import OnnxInference</span>

<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">((</span><span class="s2">&quot;T:all&quot;</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtypes_out</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)))</span>
<span class="k">def</span> <span class="nf">onnx_rfft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;fft_length must be specified.&quot;</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">cst</span> <span class="o">=</span> <span class="n">dft_real_cst</span><span class="p">(</span><span class="n">fft_length</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">xt</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">],</span> <span class="n">xt</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">])[:,</span> <span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">fft_onx</span> <span class="o">=</span> <span class="n">onnx_rfft</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">rnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">fft_onx</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="mf">0.33227617</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5372959</span> <span class="p">,</span>  <span class="mf">4.4797373</span> <span class="p">,</span>  <span class="mf">1.3639294</span> <span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.07591468</span><span class="p">,</span>  <span class="mf">0.51947707</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4824262</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.98728204</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5587506</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.8322822</span> <span class="p">,</span>  <span class="mf">0.48281363</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.86559296</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.26185107</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1814368</span> <span class="p">,</span>  <span class="mf">0.96002394</span><span class="p">,</span>  <span class="mf">3.5386157</span> <span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.0627685</span> <span class="p">,</span>  <span class="mf">3.0725865</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.8257934</span> <span class="p">,</span>  <span class="mf">4.108111</span>  <span class="p">]],</span>
       <span class="p">[[</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">0.93413043</span><span class="p">,</span>  <span class="mf">2.890194</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">2.5913336</span> <span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.</span>        <span class="p">,</span>  <span class="mf">0.624144</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">1.5657941</span> <span class="p">,</span>  <span class="mf">2.8143494</span> <span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.</span>        <span class="p">,</span>  <span class="mf">2.2525156</span> <span class="p">,</span>  <span class="mf">2.6933842</span> <span class="p">,</span>  <span class="mf">0.08437189</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.</span>        <span class="p">,</span>  <span class="mf">1.7362347</span> <span class="p">,</span>  <span class="mf">0.39340976</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3285824</span> <span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">2.7150555</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.9185277</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4683669</span> <span class="p">]]],</span>
      <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">almost_equal</span><span class="p">(</span><span class="n">fft_cus</span><span class="p">,</span> <span class="n">fft_onx</span><span class="p">)</span>
</pre></div>
</div>
<p>The corresponding ONNX graph is the following:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> onnx_rfft.to_onnx()
</pre></div>
</div>
<div id="M1dcc1af5e46442f28bf8feba620af585-cont"><div id="M1dcc1af5e46442f28bf8feba620af585" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n\n  x [shape=box color=red label=\"x\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\nint64((1,))\n[0]\" fontsize=10];\n  init_1 [shape=box label=\"init_1\nint64((1,))\n[7]\" fontsize=10];\n  init_3 [shape=box label=\"init_3\nfloat32((2, 7, 7))\n[[[ 1.          1.          1.          1.        ...\" fontsize=10];\n  init_5 [shape=box label=\"init_5\nint64((1,))\n[4]\" fontsize=10];\n  init_6 [shape=box label=\"init_6\nint64((1,))\n[1]\" fontsize=10];\n\n  out_tra_0 [shape=box label=\"out_tra_0\" fontsize=10];\n  _transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose)\nperm=[1 0]\" fontsize=10];\n  x -> _transpose;\n  _transpose -> out_tra_0;\n\n  out_sli_0 [shape=box label=\"out_sli_0\" fontsize=10];\n  _slice [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice)\" fontsize=10];\n  out_tra_0 -> _slice;\n  init -> _slice;\n  init_1 -> _slice;\n  init -> _slice;\n  _slice -> out_sli_0;\n\n  out_mat_0 [shape=box label=\"out_mat_0\" fontsize=10];\n  _matmul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul)\" fontsize=10];\n  init_3 -> _matmul;\n  out_sli_0 -> _matmul;\n  _matmul -> out_mat_0;\n\n  out_sli_0_1 [shape=box label=\"out_sli_0_1\" fontsize=10];\n  _slice_1 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_1)\" fontsize=10];\n  out_mat_0 -> _slice_1;\n  init -> _slice_1;\n  init_5 -> _slice_1;\n  init_6 -> _slice_1;\n  _slice_1 -> out_sli_0_1;\n\n  _transpose_1 [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose_1)\nperm=[0 2 1]\" fontsize=10];\n  out_sli_0_1 -> _transpose_1;\n  _transpose_1 -> y;\n}");
document.getElementById('M1dcc1af5e46442f28bf8feba620af585').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft_onx3</span> <span class="o">=</span> <span class="n">onnx_rfft</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft_cus3</span><span class="p">,</span> <span class="n">fft_onx3</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fft-2d">
<h2><a class="toc-backref" href="#id3">FFT 2D</a><a class="headerlink" href="#fft-2d" title="Permalink to this headline">#</a></h2>
<p>Below the code for complex features.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_DFT_cst</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span><span class="p">[:</span><span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">trunc</span> <span class="k">else</span> <span class="n">M</span>

<span class="k">def</span> <span class="nf">DFT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fft_length</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cst</span> <span class="o">=</span> <span class="n">_DFT_cst</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="n">axis</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cst</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cst</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fft2d_</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">DFT</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">DFT</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>


<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">fft2d_np_</span> <span class="o">=</span> <span class="n">fft2d_</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">rnd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">fft2d_np</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
<span class="n">fft2d_np_</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">4.14039719</span> <span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">1.06715605</span> <span class="o">+</span><span class="mf">1.16770652</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.27080808</span> <span class="o">+</span><span class="mf">1.93562775</span><span class="n">j</span><span class="p">,</span>  <span class="mf">5.28785846</span> <span class="o">+</span><span class="mf">2.27915445</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">2.57576449</span> <span class="o">+</span><span class="mf">3.09907081</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.90391777</span> <span class="o">-</span><span class="mf">5.56953367</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">1.6455202</span>  <span class="o">+</span><span class="mf">2.03337471</span><span class="n">j</span><span class="p">,</span>  <span class="mf">4.21121677</span> <span class="o">-</span><span class="mf">1.85803104</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.84529583</span> <span class="o">-</span><span class="mf">0.54705419</span><span class="n">j</span><span class="p">,</span>  <span class="mf">3.61232172</span> <span class="o">-</span><span class="mf">4.11661604</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">1.00659205</span> <span class="o">+</span><span class="mf">3.72264071</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36878039</span> <span class="o">-</span><span class="mf">8.21956881</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.84529583</span> <span class="o">+</span><span class="mf">0.54705419</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.173484</span>   <span class="o">+</span><span class="mf">5.12345283</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">1.7897386</span> <span class="o">-</span><span class="mf">10.15322422</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.17258219</span> <span class="o">+</span><span class="mf">2.37388952</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">2.57576449</span> <span class="o">-</span><span class="mf">3.09907081</span><span class="n">j</span><span class="p">,</span>  <span class="mf">0.58355627</span> <span class="o">+</span><span class="mf">1.62293628</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">0.71779814</span> <span class="o">+</span><span class="mf">4.64582025</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.32441255</span> <span class="o">-</span><span class="mf">4.21906685</span><span class="n">j</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_np_</span><span class="p">,</span> <span class="n">fft2d_np</span><span class="p">)</span>
</pre></div>
</div>
<p>It implies the computation of two FFT 1D along both axes. However, as
ONNX does not support complex, it needs to be rewritten with only real
numbers. The algorithm can be summarized into this formula
<img class="math" src="../_images/math/56fbe074e67b2e1e0524e9141a31bf22218d4e30.svg" alt="FFT(FFT(x, axis=1), axis=0)"/>. If <em>x</em> is real, <img class="math" src="../_images/math/c52a6e23b2e62dba2e3e8fe2e37abb044686740e.svg" alt="FFT(x, .)"/>
is complex. We still assume <em>x</em> is real, it then becomes (FFT is a
linear operator, so <img class="math" src="../_images/math/ec90b5c8d7bdb7dae94faece5dbf310ac5c222a7.svg" alt="FFT(ix)=i FFT(x)"/>):</p>
<ul class="simple">
<li><p><img class="math" src="../_images/math/c2eda3afb9df73b339657596a2e60aaac688ddaf.svg" alt="y = FFT(x, axis=1)"/></p></li>
<li><p><img class="math" src="../_images/math/763fd9fd25a1ea3ae4006d4c5f6d7a68963bcc7f.svg" alt="z_r = FFT(Real(y), axis=0)"/>,
<img class="math" src="../_images/math/eebd5dfe722370132445a39aa30b0a29444b9025.svg" alt="z_i = FFT(Imag(y), axis=0)"/></p></li>
<li><p><img class="math" src="../_images/math/9a10b6f4de33014d4fce495848bc538aa74b01d3.svg" alt="z = z_r + i z_i"/></p></li>
</ul>
<p><em>z</em> is the desired output. The following implementation is probably not
the most efficient one. It avoids inplace computation as ONNX does like
that.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fft2d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># first FFT</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dft_real</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># second FFT decomposed on FFT on real part and imaginary part</span>
    <span class="n">res2_real</span> <span class="o">=</span> <span class="n">dft_real</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag</span> <span class="o">=</span> <span class="n">dft_real</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="o">-</span><span class="n">res2_imag</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">res2_imag</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res2_real</span> <span class="o">+</span> <span class="n">res2_imag2</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">size</span><span class="p">]</span>


<span class="n">fft2d_np</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
<span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">rnd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_np</span><span class="p">,</span> <span class="n">fft2d_cus</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft2d_np</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">4.14039719</span> <span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">1.06715605</span> <span class="o">+</span><span class="mf">1.16770652</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.27080808</span> <span class="o">+</span><span class="mf">1.93562775</span><span class="n">j</span><span class="p">,</span>  <span class="mf">5.28785846</span> <span class="o">+</span><span class="mf">2.27915445</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">2.57576449</span> <span class="o">+</span><span class="mf">3.09907081</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.90391777</span> <span class="o">-</span><span class="mf">5.56953367</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">1.6455202</span>  <span class="o">+</span><span class="mf">2.03337471</span><span class="n">j</span><span class="p">,</span>  <span class="mf">4.21121677</span> <span class="o">-</span><span class="mf">1.85803104</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.84529583</span> <span class="o">-</span><span class="mf">0.54705419</span><span class="n">j</span><span class="p">,</span>  <span class="mf">3.61232172</span> <span class="o">-</span><span class="mf">4.11661604</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">1.00659205</span> <span class="o">+</span><span class="mf">3.72264071</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36878039</span> <span class="o">-</span><span class="mf">8.21956881</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.84529583</span> <span class="o">+</span><span class="mf">0.54705419</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.173484</span>   <span class="o">+</span><span class="mf">5.12345283</span><span class="n">j</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">1.7897386</span> <span class="o">-</span><span class="mf">10.15322422</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.17258219</span> <span class="o">+</span><span class="mf">2.37388952</span><span class="n">j</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">2.57576449</span> <span class="o">-</span><span class="mf">3.09907081</span><span class="n">j</span><span class="p">,</span>  <span class="mf">0.58355627</span> <span class="o">+</span><span class="mf">1.62293628</span><span class="n">j</span><span class="p">,</span>
         <span class="mf">0.71779814</span> <span class="o">+</span><span class="mf">4.64582025</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.32441255</span> <span class="o">-</span><span class="mf">4.21906685</span><span class="n">j</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft2d_cus</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[[</span> <span class="o">-</span><span class="mf">4.14039719</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.06715605</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.27080808</span><span class="p">,</span>   <span class="mf">5.28785846</span><span class="p">],</span>
        <span class="p">[</span> <span class="o">-</span><span class="mf">2.57576449</span><span class="p">,</span>  <span class="o">-</span><span class="mf">8.90391777</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.6455202</span> <span class="p">,</span>   <span class="mf">4.21121677</span><span class="p">],</span>
        <span class="p">[</span>  <span class="mf">1.84529583</span><span class="p">,</span>   <span class="mf">3.61232172</span><span class="p">,</span>   <span class="mf">1.00659205</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.36878039</span><span class="p">],</span>
        <span class="p">[</span>  <span class="mf">1.84529583</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.173484</span>  <span class="p">,</span>  <span class="o">-</span><span class="mf">1.7897386</span> <span class="p">,</span>  <span class="o">-</span><span class="mf">0.17258219</span><span class="p">],</span>
        <span class="p">[</span> <span class="o">-</span><span class="mf">2.57576449</span><span class="p">,</span>   <span class="mf">0.58355627</span><span class="p">,</span>   <span class="mf">0.71779814</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.32441255</span><span class="p">]],</span>
       <span class="p">[[</span>  <span class="mf">0.</span>        <span class="p">,</span>   <span class="mf">1.16770652</span><span class="p">,</span>   <span class="mf">1.93562775</span><span class="p">,</span>   <span class="mf">2.27915445</span><span class="p">],</span>
        <span class="p">[</span>  <span class="mf">3.09907081</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.56953367</span><span class="p">,</span>   <span class="mf">2.03337471</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.85803104</span><span class="p">],</span>
        <span class="p">[</span> <span class="o">-</span><span class="mf">0.54705419</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.11661604</span><span class="p">,</span>   <span class="mf">3.72264071</span><span class="p">,</span>  <span class="o">-</span><span class="mf">8.21956881</span><span class="p">],</span>
        <span class="p">[</span>  <span class="mf">0.54705419</span><span class="p">,</span>   <span class="mf">5.12345283</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.15322422</span><span class="p">,</span>   <span class="mf">2.37388952</span><span class="p">],</span>
        <span class="p">[</span> <span class="o">-</span><span class="mf">3.09907081</span><span class="p">,</span>   <span class="mf">1.62293628</span><span class="p">,</span>   <span class="mf">4.64582025</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.21906685</span><span class="p">]]])</span>
</pre></div>
</div>
<p>And with a different <code class="docutils literal notranslate"><span class="pre">fft_length</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft2d_np</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_np</span><span class="p">[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span> <span class="n">fft2d_cus</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fft-2d-in-onnx">
<h2><a class="toc-backref" href="#id4">FFT 2D in ONNX</a><a class="headerlink" href="#fft-2d-in-onnx" title="Permalink to this headline">#</a></h2>
<p>We use again the numpy API for ONNX.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">onnx_rfft_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;fft_length must be specified.&quot;</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">cst</span> <span class="o">=</span> <span class="n">dft_real_cst</span><span class="p">(</span><span class="n">fft_length</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">],</span> <span class="n">xt</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">])[:,</span> <span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">],</span> <span class="n">x</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">])</span>


<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">((</span><span class="s2">&quot;T:all&quot;</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtypes_out</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)))</span>
<span class="k">def</span> <span class="nf">onnx_rfft_2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># first FFT</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">onnx_rfft_1d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># second FFT decomposed on FFT on real part and imaginary part</span>
    <span class="n">res2_real</span> <span class="o">=</span> <span class="n">onnx_rfft_1d</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag</span> <span class="o">=</span> <span class="n">onnx_rfft_1d</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag2</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="o">-</span><span class="n">res2_imag</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">res2_imag</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res2_real</span> <span class="o">+</span> <span class="n">res2_imag2</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">size</span><span class="p">]</span>


<span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">rnd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">fft2d_onx</span> <span class="o">=</span> <span class="n">onnx_rfft_2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">rnd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_cus</span><span class="p">,</span> <span class="n">fft2d_onx</span><span class="p">)</span>
</pre></div>
</div>
<p>The corresponding ONNX graph.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">onnxview</span> onnx_rfft_2d.to_onnx()
</pre></div>
</div>
<div id="M79d084ff707542a2bd01788961e5de7a-cont"><div id="M79d084ff707542a2bd01788961e5de7a" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n\n  x [shape=box color=red label=\"x\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\nint64((2,))\n[0 0]\" fontsize=10];\n  init_1 [shape=box label=\"init_1\nint64((2,))\n[5 7]\" fontsize=10];\n  init_2 [shape=box label=\"init_2\nint64((2,))\n[0 1]\" fontsize=10];\n  init_3 [shape=box label=\"init_3\nint64((1,))\n[0]\" fontsize=10];\n  init_4 [shape=box label=\"init_4\nint64((1,))\n[7]\" fontsize=10];\n  init_6 [shape=box label=\"init_6\nfloat32((2, 7, 7))\n[[[ 1.          1.          1.          1.        ...\" fontsize=10];\n  init_8 [shape=box label=\"init_8\nint64((1,))\n[4]\" fontsize=10];\n  init_9 [shape=box label=\"init_9\nint64((1,))\n[1]\" fontsize=10];\n  init_b10 [shape=box label=\"init_b10\nint64(())\n1\" fontsize=10];\n  init_b12 [shape=box label=\"init_b12\nint64((1,))\n[5]\" fontsize=10];\n  init_b14 [shape=box label=\"init_b14\nfloat32((2, 5, 5))\n[[[ 1.          1.          1.          1.        ...\" fontsize=10];\n  init_b16 [shape=box label=\"init_b16\nint64((1,))\n[2]\" fontsize=10];\n  init_b18 [shape=box label=\"init_b18\nint64(())\n0\" fontsize=10];\n  init_b27 [shape=box label=\"init_b27\nint64((2,))\n[5 4]\" fontsize=10];\n  init_b28 [shape=box label=\"init_b28\nint64((2,))\n[1 2]\" fontsize=10];\n\n  out_sli_0 [shape=box label=\"out_sli_0\" fontsize=10];\n  _slice [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice)\" fontsize=10];\n  x -> _slice;\n  init -> _slice;\n  init_1 -> _slice;\n  init_2 -> _slice;\n  _slice -> out_sli_0;\n\n  out_tra_0 [shape=box label=\"out_tra_0\" fontsize=10];\n  _transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose)\nperm=[1 0]\" fontsize=10];\n  out_sli_0 -> _transpose;\n  _transpose -> out_tra_0;\n\n  out_sli_0_1 [shape=box label=\"out_sli_0_1\" fontsize=10];\n  _slice_1 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_1)\" fontsize=10];\n  out_tra_0 -> _slice_1;\n  init_3 -> _slice_1;\n  init_4 -> _slice_1;\n  init_3 -> _slice_1;\n  _slice_1 -> out_sli_0_1;\n\n  out_mat_0 [shape=box label=\"out_mat_0\" fontsize=10];\n  _matmul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul)\" fontsize=10];\n  init_6 -> _matmul;\n  out_sli_0_1 -> _matmul;\n  _matmul -> out_mat_0;\n\n  out_sli_0_2 [shape=box label=\"out_sli_0_2\" fontsize=10];\n  _slice_2 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_2)\" fontsize=10];\n  out_mat_0 -> _slice_2;\n  init_3 -> _slice_2;\n  init_8 -> _slice_2;\n  init_9 -> _slice_2;\n  _slice_2 -> out_sli_0_2;\n\n  out_tra_0_1 [shape=box label=\"out_tra_0_1\" fontsize=10];\n  _transpose_1 [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose_1)\nperm=[0 2 1]\" fontsize=10];\n  out_sli_0_2 -> _transpose_1;\n  _transpose_1 -> out_tra_0_1;\n\n  out_gat_0 [shape=box label=\"out_gat_0\" fontsize=10];\n  _gather [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather)\naxis=0\" fontsize=10];\n  out_tra_0_1 -> _gather;\n  init_b10 -> _gather;\n  _gather -> out_gat_0;\n\n  out_sli_0_3 [shape=box label=\"out_sli_0_3\" fontsize=10];\n  _slice_3 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_3)\" fontsize=10];\n  out_gat_0 -> _slice_3;\n  init_3 -> _slice_3;\n  init_b12 -> _slice_3;\n  init_3 -> _slice_3;\n  _slice_3 -> out_sli_0_3;\n\n  out_mat_0_1 [shape=box label=\"out_mat_0_1\" fontsize=10];\n  _matmul_1 [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul_1)\" fontsize=10];\n  init_b14 -> _matmul_1;\n  out_sli_0_3 -> _matmul_1;\n  _matmul_1 -> out_mat_0_1;\n\n  out_sli_0_4 [shape=box label=\"out_sli_0_4\" fontsize=10];\n  _slice_4 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_4)\" fontsize=10];\n  out_mat_0_1 -> _slice_4;\n  init_9 -> _slice_4;\n  init_b16 -> _slice_4;\n  init_3 -> _slice_4;\n  _slice_4 -> out_sli_0_4;\n\n  out_gat_0_1 [shape=box label=\"out_gat_0_1\" fontsize=10];\n  _gather_1 [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather_1)\naxis=0\" fontsize=10];\n  out_tra_0_1 -> _gather_1;\n  init_b18 -> _gather_1;\n  _gather_1 -> out_gat_0_1;\n\n  out_sli_0_5 [shape=box label=\"out_sli_0_5\" fontsize=10];\n  _slice_5 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_5)\" fontsize=10];\n  out_mat_0_1 -> _slice_5;\n  init_3 -> _slice_5;\n  init_9 -> _slice_5;\n  init_3 -> _slice_5;\n  _slice_5 -> out_sli_0_5;\n\n  out_neg_0 [shape=box label=\"out_neg_0\" fontsize=10];\n  _neg [shape=box style=\"filled,rounded\" color=orange label=\"Neg\n(_neg)\" fontsize=10];\n  out_sli_0_4 -> _neg;\n  _neg -> out_neg_0;\n\n  out_sli_0_6 [shape=box label=\"out_sli_0_6\" fontsize=10];\n  _slice_6 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_6)\" fontsize=10];\n  out_gat_0_1 -> _slice_6;\n  init_3 -> _slice_6;\n  init_b12 -> _slice_6;\n  init_3 -> _slice_6;\n  _slice_6 -> out_sli_0_6;\n\n  out_con_0 [shape=box label=\"out_con_0\" fontsize=10];\n  _concat [shape=box style=\"filled,rounded\" color=orange label=\"Concat\n(_concat)\naxis=0\" fontsize=10];\n  out_neg_0 -> _concat;\n  out_sli_0_5 -> _concat;\n  _concat -> out_con_0;\n\n  out_mat_0_2 [shape=box label=\"out_mat_0_2\" fontsize=10];\n  _matmul_2 [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul_2)\" fontsize=10];\n  init_b14 -> _matmul_2;\n  out_sli_0_6 -> _matmul_2;\n  _matmul_2 -> out_mat_0_2;\n\n  out_add_0 [shape=box label=\"out_add_0\" fontsize=10];\n  _add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(_add)\" fontsize=10];\n  out_mat_0_2 -> _add;\n  out_con_0 -> _add;\n  _add -> out_add_0;\n\n  _slice_7 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_7)\" fontsize=10];\n  out_add_0 -> _slice_7;\n  init -> _slice_7;\n  init_b27 -> _slice_7;\n  init_b28 -> _slice_7;\n  _slice_7 -> y;\n}");
document.getElementById('M79d084ff707542a2bd01788961e5de7a').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fft2d.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onnx_rfft_2d</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">()</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</pre></div>
</div>
<p>With a different <code class="docutils literal notranslate"><span class="pre">fft_length</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fft2d_onx</span> <span class="o">=</span> <span class="n">onnx_rfft_2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_cus</span><span class="p">,</span> <span class="n">fft2d_onx</span><span class="p">)</span>
</pre></div>
</div>
<p>This implementation of FFT in ONNX assumes shapes and fft lengths are
constant. Otherwise, the matrix returned by function <code class="docutils literal notranslate"><span class="pre">dft_real_cst</span></code>
must be converted as well. That’s left as an exercise.</p>
</section>
<section id="fft2d-with-shape-3-1-4">
<h2><a class="toc-backref" href="#id5">FFT2D with shape (3,1,4)</a><a class="headerlink" href="#fft2d-with-shape-3-1-4" title="Permalink to this headline">#</a></h2>
<p>Previous implementation expects the input matrix to have two dimensions.
It fails with 3.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">fft2d_numpy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
<span class="n">fft2d_numpy</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fft2d_numpy</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="mf">1.04513007</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.7261328</span> <span class="o">-</span><span class="mf">0.1488841</span><span class="n">j</span> <span class="p">,</span>
         <span class="o">-</span><span class="mf">0.76143177</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.7261328</span> <span class="o">+</span><span class="mf">0.1488841</span><span class="n">j</span> <span class="p">]],</span>
       <span class="p">[[</span> <span class="mf">0.13626025</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">0.37364573</span><span class="o">+</span><span class="mf">0.49485394</span><span class="n">j</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">0.5746009</span> <span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span> <span class="o">-</span><span class="mf">0.37364573</span><span class="o">-</span><span class="mf">0.49485394</span><span class="n">j</span><span class="p">]],</span>
       <span class="p">[[</span> <span class="mf">1.52022177</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.35786384</span><span class="o">+</span><span class="mf">1.09477997</span><span class="n">j</span><span class="p">,</span>
          <span class="mf">2.16783673</span><span class="o">+</span><span class="mf">0.</span><span class="n">j</span>        <span class="p">,</span>  <span class="mf">0.35786384</span><span class="o">-</span><span class="mf">1.09477997</span><span class="n">j</span><span class="p">]]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1"># fft2d_onx = onnx_rfft_2d(rnd, fft_length=fft_length)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="n">don</span><span class="s1">&#39;t match array</span>
</pre></div>
</div>
<section id="numpy-version">
<h3><a class="toc-backref" href="#id6">numpy version</a><a class="headerlink" href="#numpy-version" title="Permalink to this headline">#</a></h3>
<p>Let’s do it again with numpy first.
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.fft.fft2.html">fft2</a>
performs <code class="docutils literal notranslate"><span class="pre">fft2</span></code> on the last two axis as many times as the first axis.
The goal is still to have an implementation which works for any
dimension.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">fft2d</span><span class="p">(</span><span class="n">rnd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="n">conc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">conc</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_numpy</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<p>It works. And now a more efficient implementation. It is better to read
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.matmul.html">matmul</a>
description before. To summarize, a third axis is equivalent to many
matrix multiplications over the last two axes, as many as the dimension
of the first axis: <code class="docutils literal notranslate"><span class="pre">matmul(A[I,J,K],</span> <span class="pre">B[I,K,L])</span> <span class="pre">--&gt;</span> <span class="pre">C[I,J,L]</span></code>.
Broadcasting also works… <code class="docutils literal notranslate"><span class="pre">matmul(A[1,J,K],</span> <span class="pre">B[I,K,L])</span> <span class="pre">--&gt;</span> <span class="pre">C[I,J,L]</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dft_real_d3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not implemented for shape=</span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">transpose</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fft_length</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">cst</span> <span class="o">=</span> <span class="n">dft_real_cst</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fft2d_d3</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># first FFT</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dft_real_d3</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># second FFT decomposed on FFT on real part and imaginary part</span>
    <span class="n">res2_real</span> <span class="o">=</span> <span class="n">dft_real_d3</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag</span> <span class="o">=</span> <span class="n">dft_real_d3</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="o">-</span><span class="n">res2_imag</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">res2_imag</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res2_real</span> <span class="o">+</span> <span class="n">res2_imag2</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">:</span><span class="n">size</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">fft2d_any</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">):</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">mat2</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">fft2d_d3</span><span class="p">(</span><span class="n">mat2</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">f2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>


<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">fft2d_numpy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
<span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d_any</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_numpy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">fft2d_cus</span><span class="p">)</span>
</pre></div>
</div>
<p>We check with more shapes to see if the implementation works for all of
them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]:</span>
    <span class="k">for</span> <span class="n">fft_length</span> <span class="ow">in</span> <span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))]:</span>
        <span class="n">x</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">fnp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fn</span><span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">fnp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cus</span> <span class="o">=</span> <span class="n">fft2d_any</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERR x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> error=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">almost_equal</span><span class="p">(</span><span class="n">fnp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">cus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">cus</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DIS x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> error=</span><span class="si">%r</span><span class="s2">  output shape=</span><span class="si">%r</span><span class="s2"> or </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">fnp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cus</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OK  x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> output shape=</span><span class="si">%r</span><span class="s2"> or </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">fnp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cus</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="onnx-version">
<h3><a class="toc-backref" href="#id7">ONNX version</a><a class="headerlink" href="#onnx-version" title="Permalink to this headline">#</a></h3>
<p>Let’s look into the differences first.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> pyquickhelper
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%html</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span><span class="w"></span>
<span class="nt">table</span><span class="w"> </span><span class="nt">td</span><span class="o">,</span><span class="w"> </span><span class="nt">table</span><span class="w"> </span><span class="nt">th</span><span class="o">,</span><span class="w"> </span><span class="nt">table</span><span class="w"> </span><span class="nt">tr</span><span class="w"> </span><span class="p">{</span><span class="k">text-align</span><span class="p">:</span><span class="kc">left</span><span class="w"> </span><span class="cp">!important</span><span class="p">;</span><span class="w"> </span><span class="k">white-space</span><span class="p">:</span><span class="w"> </span><span class="kc">pre</span><span class="p">;}</span><span class="w"></span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</pre></div>
</div>
<style>
table td, table th, table tr {text-align:left !important; white-space: pre;}
</style><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">text1</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">dft_real</span><span class="p">)</span>
<span class="n">text2</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">dft_real_d3</span><span class="p">)</span>
<span class="o">%</span><span class="k">codediff</span> text1 text2 --verbose 1 --two 1
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 24/24 [00:00&lt;00:00, 573.03it/s]
</pre></div>
</div>
<table style="white-space: pre; 1px solid black; font-family:courier; text-align:left !important;">
<tr style="1px solid black;"><td><code>0</code></td><td><code>0</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">def dft_real(x, fft_length=None, transpose=True):</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>def dft_real<span style="color:#196F3D;">_</span><span style="color:#196F3D;">d</span><span style="color:#196F3D;">3</span>(x, fft_length=None, transpose=True):</code></td></tr>
<tr style="1px solid black;"><td><code>1</code></td><td><code>1</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    if len(x.shape) =<span style="color:#BA4A00;">=</span> <span style="color:#BA4A00;">1</span>:</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    if len(x.shape) <span style="color:#196F3D;">!</span>= <span style="color:#196F3D;">3</span>:</code></td></tr>
<tr style="1px solid black;"><td><code>2</code></td><td><code>2</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        <span style="color:#BA4A00;">x</span> = x.<span style="color:#BA4A00;">r</span><span style="color:#BA4A00;">e</span>shape<span style="color:#BA4A00;">(</span><span style="color:#BA4A00;">(</span><span style="color:#BA4A00;">1</span><span style="color:#BA4A00;">,</span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;">-</span><span style="color:#BA4A00;">1</span>)<span style="color:#BA4A00;">)</span></code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        <span style="color:#196F3D;">r</span><span style="color:#196F3D;">a</span><span style="color:#196F3D;">i</span><span style="color:#196F3D;">s</span><span style="color:#196F3D;">e</span> <span style="color:#196F3D;">R</span><span style="color:#196F3D;">u</span><span style="color:#196F3D;">n</span><span style="color:#196F3D;">t</span><span style="color:#196F3D;">i</span><span style="color:#196F3D;">m</span><span style="color:#196F3D;">e</span><span style="color:#196F3D;">E</span><span style="color:#196F3D;">r</span><span style="color:#196F3D;">r</span><span style="color:#196F3D;">o</span><span style="color:#196F3D;">r</span><span style="color:#196F3D;">(</span><span style="color:#196F3D;">"</span><span style="color:#196F3D;">N</span><span style="color:#196F3D;">o</span><span style="color:#196F3D;">t</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">i</span><span style="color:#196F3D;">m</span><span style="color:#196F3D;">p</span><span style="color:#196F3D;">l</span><span style="color:#196F3D;">e</span><span style="color:#196F3D;">m</span><span style="color:#196F3D;">e</span><span style="color:#196F3D;">n</span><span style="color:#196F3D;">t</span><span style="color:#196F3D;">e</span><span style="color:#196F3D;">d</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">f</span><span style="color:#196F3D;">o</span><span style="color:#196F3D;">r</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">s</span><span style="color:#196F3D;">h</span><span style="color:#196F3D;">a</span><span style="color:#196F3D;">p</span><span style="color:#196F3D;">e</span>=<span style="color:#196F3D;">%</span><span style="color:#196F3D;">r</span><span style="color:#196F3D;">.</span><span style="color:#196F3D;">"</span> <span style="color:#196F3D;">%</span><span style="color:#196F3D;"> </span>x.shape)</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#E59866;"><code style="background-color:#E59866;">3</code></td><td></td><td style="background-color:#E59866;"><code style="background-color:#E59866;">        N = 1</code></td><td></td></tr>
<tr style="1px solid black;"><td style="background-color:#E59866;"><code style="background-color:#E59866;">4</code></td><td></td><td style="background-color:#E59866;"><code style="background-color:#E59866;">    else:</code></td><td></td></tr>
<tr style="1px solid black;"><td><code>5</code></td><td><code>3</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    <span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span>N = x.shape[<span style="color:#BA4A00;">0</span>]<span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span></code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    N = x.shape[<span style="color:#196F3D;">1</span>]</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">6</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">4</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    C = x.shape[-1] if transpose else x.shape[-2]</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    C = x.shape[-1] if transpose else x.shape[-2]</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">7</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">5</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    if fft_length is None:</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    if fft_length is None:</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">8</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">6</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        fft_length = x.shape[-1]</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        fft_length = x.shape[-1]</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">9</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">7</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    size = fft_length // 2 + 1</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    size = fft_length // 2 + 1</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">10</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">8</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;"></code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;"></code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">11</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">9</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    cst = dft_real_cst(C, fft_length)</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    cst = dft_real_cst(C, fft_length)</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">12</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">10</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    if transpose:</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    if transpose:</code></td></tr>
<tr style="1px solid black;"><td><code>13</code></td><td><code>11</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        x = numpy.transpose(x, (<span style="color:#BA4A00;">1</span>, <span style="color:#BA4A00;">0</span>))</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        x = numpy.transpose(x, (<span style="color:#196F3D;">0</span>, <span style="color:#196F3D;">2</span><span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">1</span>))</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">14</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">12</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        a = cst[:, :, :fft_length]</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        a = cst[:, :, :fft_length]</code></td></tr>
<tr style="1px solid black;"><td><code>15</code></td><td><code>13</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        b = x[:fft_length]</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        b = x[:<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>fft_length<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>]</code></td></tr>
<tr style="1px solid black;"><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">14</code></td><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">        a = numpy.expand_dims(a, 0)</code></td></tr>
<tr style="1px solid black;"><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">15</code></td><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">        b = numpy.expand_dims(b, 1)</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">16</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">16</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        res = numpy.matmul(a, b)</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        res = numpy.matmul(a, b)</code></td></tr>
<tr style="1px solid black;"><td><code>17</code></td><td><code>17</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        res = res[:, :size, :]</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        res = res[:, :<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>size, :]</code></td></tr>
<tr style="1px solid black;"><td><code>18</code></td><td><code>18</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        return numpy.transpose(res, (0, <span style="color:#BA4A00;">2</span>, <span style="color:#BA4A00;">1</span>))</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        return numpy.transpose(res, (<span style="color:#196F3D;">1</span><span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span>0, <span style="color:#196F3D;">3</span>, <span style="color:#196F3D;">2</span>))</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">19</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">19</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    else:</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    else:</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">20</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">20</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        a = cst[:, :, :fft_length]</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">        a = cst[:, :, :fft_length]</code></td></tr>
<tr style="1px solid black;"><td><code>21</code></td><td><code>21</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        b = x[:fft_length]</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        b = x[:<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>fft_length<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>]</code></td></tr>
<tr style="1px solid black;"><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">22</code></td><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">        a = numpy.expand_dims(a, 0)</code></td></tr>
<tr style="1px solid black;"><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">23</code></td><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">        b = numpy.expand_dims(b, 1)</code></td></tr>
<tr style="1px solid black;"><td><code>22</code></td><td><code>24</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">        re<span style="color:#BA4A00;">t</span><span style="color:#BA4A00;">u</span><span style="color:#BA4A00;">r</span><span style="color:#BA4A00;">n</span> numpy.matmul(a, b)</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>        re<span style="color:#196F3D;">s</span> <span style="color:#196F3D;">=</span><span style="color:#196F3D;"> </span>numpy.matmul(a, b)</code></td></tr>
<tr style="1px solid black;"><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">25</code></td><td></td><td style="background-color:#ABEBC6;"><code style="background-color:#ABEBC6;">        return numpy.transpose(res, (1, 0, 2, 3))</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">23</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">26</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;"></code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;"></code></td></tr>
</table><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text1</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fft2d</span><span class="p">)</span>
<span class="n">text2</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fft2d_d3</span><span class="p">)</span>
<span class="o">%</span><span class="k">codediff</span> text1 text2 --verbose 1 --two 1
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 15/15 [00:00&lt;00:00, 791.61it/s]
</pre></div>
</div>
<table style="white-space: pre; 1px solid black; font-family:courier; text-align:left !important;">
<tr style="1px solid black;"><td><code>0</code></td><td><code>0</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">def fft2d(mat, fft_length):</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>def fft2d<span style="color:#196F3D;">_</span><span style="color:#196F3D;">d</span><span style="color:#196F3D;">3</span>(mat, fft_length):</code></td></tr>
<tr style="1px solid black;"><td><code>1</code></td><td><code>1</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    mat = mat[:fft_length[<span style="color:#BA4A00;">0</span>], :fft_length[1]]</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    mat = mat[:<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>fft_length[<span style="color:#196F3D;">-</span><span style="color:#196F3D;">2</span>], :fft_length[<span style="color:#196F3D;">-</span>1]]</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">2</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">2</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    res = mat.copy()</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    res = mat.copy()</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">3</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">3</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    </code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    </code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">4</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">4</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    # first FFT</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    # first FFT</code></td></tr>
<tr style="1px solid black;"><td><code>5</code></td><td><code>5</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    res = dft_real(res, fft_length=fft_length[1], transpose=True)</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    res = dft_real<span style="color:#196F3D;">_</span><span style="color:#196F3D;">d</span><span style="color:#196F3D;">3</span>(res, fft_length=fft_length[<span style="color:#196F3D;">-</span>1], transpose=True)</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">6</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">6</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    </code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    </code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">7</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">7</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    # second FFT decomposed on FFT on real part and imaginary part</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    # second FFT decomposed on FFT on real part and imaginary part</code></td></tr>
<tr style="1px solid black;"><td><code>8</code></td><td><code>8</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    res2_real = dft_real(res[0], fft_length=fft_length[<span style="color:#BA4A00;">0</span>], transpose=False)</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    res2_real = dft_real<span style="color:#196F3D;">_</span><span style="color:#196F3D;">d</span><span style="color:#196F3D;">3</span>(res[0], fft_length=fft_length[<span style="color:#196F3D;">-</span><span style="color:#196F3D;">2</span>], transpose=False)</code></td></tr>
<tr style="1px solid black;"><td><code>9</code></td><td><code>9</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    res2_imag = dft_real(res[1], fft_length=fft_length[<span style="color:#BA4A00;">0</span>], transpose=False)<span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span><span style="color:#BA4A00;"> </span></code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    res2_imag = dft_real<span style="color:#196F3D;">_</span><span style="color:#196F3D;">d</span><span style="color:#196F3D;">3</span>(res[1], fft_length=fft_length[<span style="color:#196F3D;">-</span><span style="color:#196F3D;">2</span>], transpose=False)</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">10</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">10</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    res2_imag2 = numpy.vstack([-res2_imag[1:2], res2_imag[:1]])</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    res2_imag2 = numpy.vstack([-res2_imag[1:2], res2_imag[:1]])</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">11</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">11</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    res = res2_real + res2_imag2</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">    res = res2_real + res2_imag2</code></td></tr>
<tr style="1px solid black;"><td><code>12</code></td><td><code>12</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    size = fft_length[1]//2 + 1</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    size = fft_length[<span style="color:#196F3D;">-</span>1]//2 + 1</code></td></tr>
<tr style="1px solid black;"><td><code>13</code></td><td><code>13</code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;">    return res[:, :fft_length[<span style="color:#BA4A00;">0</span>], :size]</code></code></td><td style="background-color:#E5E7E9;"><code style="background-color:#E5E7E9;"><code>    return res[:, :<span style="color:#196F3D;">,</span><span style="color:#196F3D;"> </span><span style="color:#196F3D;">:</span>fft_length[<span style="color:#196F3D;">-</span><span style="color:#196F3D;">2</span>], :size]</code></td></tr>
<tr style="1px solid black;"><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">14</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;">14</code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;"></code></td><td style="background-color:#FFFFFF;"><code style="background-color:#FFFFFF;"></code></td></tr>
</table><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">onnx_rfft_3d_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fft_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;fft_length must be specified.&quot;</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">cst</span> <span class="o">=</span> <span class="n">dft_real_cst</span><span class="p">(</span><span class="n">fft_length</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">xt</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">res2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">cst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">onnx_rfft_3d_2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># first FFT</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">onnx_rfft_3d_1d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># second FFT decomposed on FFT on real part and imaginary part</span>
    <span class="n">res2_real</span> <span class="o">=</span> <span class="n">onnx_rfft_3d_1d</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag</span> <span class="o">=</span> <span class="n">onnx_rfft_3d_1d</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res2_imag2</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="o">-</span><span class="n">res2_imag</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">res2_imag</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res2_real</span> <span class="o">+</span> <span class="n">res2_imag2</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fft_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">fft_length</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">:</span><span class="n">size</span><span class="p">]</span>


<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">((</span><span class="s2">&quot;T:all&quot;</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtypes_out</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)))</span>
<span class="k">def</span> <span class="nf">onnx_rfft_2d_any</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mat2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">onnx_rfft_3d_2d</span><span class="p">(</span><span class="n">mat2</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">npnx</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">f2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">f2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>


<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">fft_length</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">fft2d_cus</span> <span class="o">=</span> <span class="n">fft2d_any</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
<span class="n">fft2d_onx</span> <span class="o">=</span> <span class="n">onnx_rfft_2d_any</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">)</span>
<span class="n">almost_equal</span><span class="p">(</span><span class="n">fft2d_cus</span><span class="p">,</span> <span class="n">fft2d_onx</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s do the same comparison.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]:</span>
    <span class="k">for</span> <span class="n">fft_length</span> <span class="ow">in</span> <span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))]:</span>
        <span class="n">x</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fn</span><span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">fnp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cus</span> <span class="o">=</span> <span class="n">fft2d_any</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERR x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> error=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">onx</span> <span class="o">=</span> <span class="n">onnx_rfft_2d_any</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fft_length</span><span class="o">=</span><span class="n">fft_length</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERR x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> error=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">almost_equal</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">cus</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DIS x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> error=</span><span class="si">%r</span><span class="s2">  output shape=</span><span class="si">%r</span><span class="s2"> or </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">fnp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cus</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OK  x.shape=</span><span class="si">%r</span><span class="s2"> length=</span><span class="si">%r</span><span class="s2"> output shape=</span><span class="si">%r</span><span class="s2"> or </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fft_length</span><span class="p">,</span> <span class="n">fnp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cus</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">OK</span>  <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">output</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>There is one issue with <code class="docutils literal notranslate"><span class="pre">fft_length=(1,</span> <span class="pre">1)</span></code> but that case is out of
scope.</p>
</section>
<section id="onnx-graph">
<h3><a class="toc-backref" href="#id8">ONNX graph</a><a class="headerlink" href="#onnx-graph" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">onnx_rfft_2d_any</span><span class="o">.</span><span class="n">signed_compiled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">%</span><span class="k">onnxview</span> onnx_rfft_2d_any.signed_compiled[key].compiled.onnx_
</pre></div>
</div>
<div id="Mea4195a12d3949658299aedb50551e70-cont"><div id="Mea4195a12d3949658299aedb50551e70" style="width:;height:;"></div></div>
<script>

require(['http://www.xavierdupre.fr/js/vizjs/viz.js'], function() { var svgGraph = Viz("digraph{\n  orientation=portrait;\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n\n  x [shape=box color=red label=\"x\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\nint64((1,))\n[0]\" fontsize=10];\n  init_1 [shape=box label=\"init_1\nint64((1,))\n[-2]\" fontsize=10];\n  init_3 [shape=box label=\"init_3\nint64((1,))\n[-1]\" fontsize=10];\n  init_4 [shape=box label=\"init_4\nint64((2,))\n[0 0]\" fontsize=10];\n  init_5 [shape=box label=\"init_5\nint64((2,))\n[1 4]\" fontsize=10];\n  init_6 [shape=box label=\"init_6\nint64((2,))\n[1 2]\" fontsize=10];\n  init_8 [shape=box label=\"init_8\nint64((1,))\n[4]\" fontsize=10];\n  init_9 [shape=box label=\"init_9\nint64((1,))\n[1]\" fontsize=10];\n  init_b11 [shape=box label=\"init_b11\nfloat32((2, 4, 4))\n[[[ 1.0000000e+00  1.0000000e+00  1.0000000e+00  1...\" fontsize=10];\n  init_b14 [shape=box label=\"init_b14\nint64((1,))\n[3]\" fontsize=10];\n  init_b16 [shape=box label=\"init_b16\nint64(())\n1\" fontsize=10];\n  init_b21 [shape=box label=\"init_b21\nfloat32((2, 1, 1))\n[[[1.]]\n\n [[0.]]]\" fontsize=10];\n  init_b23 [shape=box label=\"init_b23\nint64(())\n0\" fontsize=10];\n  init_b28 [shape=box label=\"init_b28\nint64((1,))\n[2]\" fontsize=10];\n  init_b37 [shape=box label=\"init_b37\nint64((2,))\n[1 3]\" fontsize=10];\n  init_b38 [shape=box label=\"init_b38\nint64((2,))\n[2 3]\" fontsize=10];\n\n  out_sha_0 [shape=box label=\"out_sha_0\" fontsize=10];\n  _shape [shape=box style=\"filled,rounded\" color=orange label=\"Shape\n(_shape)\" fontsize=10];\n  x -> _shape;\n  _shape -> out_sha_0;\n\n  out_sha_0_1 [shape=box label=\"out_sha_0_1\" fontsize=10];\n  _shape_1 [shape=box style=\"filled,rounded\" color=orange label=\"Shape\n(_shape_1)\" fontsize=10];\n  out_sha_0 -> _shape_1;\n  _shape_1 -> out_sha_0_1;\n\n  out_gat_0 [shape=box label=\"out_gat_0\" fontsize=10];\n  _gather [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather)\" fontsize=10];\n  out_sha_0_1 -> _gather;\n  init -> _gather;\n  _gather -> out_gat_0;\n\n  out_sli_0 [shape=box label=\"out_sli_0\" fontsize=10];\n  _slice [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice)\" fontsize=10];\n  out_sha_0 -> _slice;\n  init_1 -> _slice;\n  out_gat_0 -> _slice;\n  init -> _slice;\n  _slice -> out_sli_0;\n\n  out_con_0 [shape=box label=\"out_con_0\" fontsize=10];\n  _concat [shape=box style=\"filled,rounded\" color=orange label=\"Concat\n(_concat)\naxis=0\" fontsize=10];\n  init_3 -> _concat;\n  out_sli_0 -> _concat;\n  _concat -> out_con_0;\n\n  out_res_0 [shape=box label=\"out_res_0\" fontsize=10];\n  _reshape [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\n(_reshape)\" fontsize=10];\n  x -> _reshape;\n  out_con_0 -> _reshape;\n  _reshape -> out_res_0;\n\n  out_sli_0_1 [shape=box label=\"out_sli_0_1\" fontsize=10];\n  _slice_1 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_1)\" fontsize=10];\n  out_res_0 -> _slice_1;\n  init_4 -> _slice_1;\n  init_5 -> _slice_1;\n  init_6 -> _slice_1;\n  _slice_1 -> out_sli_0_1;\n\n  out_tra_0 [shape=box label=\"out_tra_0\" fontsize=10];\n  _transpose [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose)\nperm=[0 2 1]\" fontsize=10];\n  out_sli_0_1 -> _transpose;\n  _transpose -> out_tra_0;\n\n  out_sli_0_2 [shape=box label=\"out_sli_0_2\" fontsize=10];\n  _slice_2 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_2)\" fontsize=10];\n  out_tra_0 -> _slice_2;\n  init -> _slice_2;\n  init_8 -> _slice_2;\n  init_9 -> _slice_2;\n  _slice_2 -> out_sli_0_2;\n\n  out_uns_0 [shape=box label=\"out_uns_0\" fontsize=10];\n  _unsqueeze [shape=box style=\"filled,rounded\" color=orange label=\"Unsqueeze\n(_unsqueeze)\" fontsize=10];\n  out_sli_0_2 -> _unsqueeze;\n  init_9 -> _unsqueeze;\n  _unsqueeze -> out_uns_0;\n\n  out_uns_0_1 [shape=box label=\"out_uns_0_1\" fontsize=10];\n  _unsqueeze_1 [shape=box style=\"filled,rounded\" color=orange label=\"Unsqueeze\n(_unsqueeze_1)\" fontsize=10];\n  init_b11 -> _unsqueeze_1;\n  init -> _unsqueeze_1;\n  _unsqueeze_1 -> out_uns_0_1;\n\n  out_mat_0 [shape=box label=\"out_mat_0\" fontsize=10];\n  _matmul [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul)\" fontsize=10];\n  out_uns_0_1 -> _matmul;\n  out_uns_0 -> _matmul;\n  _matmul -> out_mat_0;\n\n  out_sli_0_3 [shape=box label=\"out_sli_0_3\" fontsize=10];\n  _slice_3 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_3)\" fontsize=10];\n  out_mat_0 -> _slice_3;\n  init -> _slice_3;\n  init_b14 -> _slice_3;\n  init_9 -> _slice_3;\n  _slice_3 -> out_sli_0_3;\n\n  out_tra_0_1 [shape=box label=\"out_tra_0_1\" fontsize=10];\n  _transpose_1 [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose_1)\nperm=[1 0 3 2]\" fontsize=10];\n  out_sli_0_3 -> _transpose_1;\n  _transpose_1 -> out_tra_0_1;\n\n  out_gat_0_1 [shape=box label=\"out_gat_0_1\" fontsize=10];\n  _gather_1 [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather_1)\naxis=0\" fontsize=10];\n  out_tra_0_1 -> _gather_1;\n  init_b16 -> _gather_1;\n  _gather_1 -> out_gat_0_1;\n\n  out_sli_0_4 [shape=box label=\"out_sli_0_4\" fontsize=10];\n  _slice_4 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_4)\" fontsize=10];\n  out_gat_0_1 -> _slice_4;\n  init -> _slice_4;\n  init_9 -> _slice_4;\n  init_9 -> _slice_4;\n  _slice_4 -> out_sli_0_4;\n\n  out_uns_0_2 [shape=box label=\"out_uns_0_2\" fontsize=10];\n  _unsqueeze_2 [shape=box style=\"filled,rounded\" color=orange label=\"Unsqueeze\n(_unsqueeze_2)\" fontsize=10];\n  out_sli_0_4 -> _unsqueeze_2;\n  init_9 -> _unsqueeze_2;\n  _unsqueeze_2 -> out_uns_0_2;\n\n  out_uns_0_3 [shape=box label=\"out_uns_0_3\" fontsize=10];\n  _unsqueeze_3 [shape=box style=\"filled,rounded\" color=orange label=\"Unsqueeze\n(_unsqueeze_3)\" fontsize=10];\n  init_b21 -> _unsqueeze_3;\n  init -> _unsqueeze_3;\n  _unsqueeze_3 -> out_uns_0_3;\n\n  out_mat_0_1 [shape=box label=\"out_mat_0_1\" fontsize=10];\n  _matmul_1 [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul_1)\" fontsize=10];\n  out_uns_0_3 -> _matmul_1;\n  out_uns_0_2 -> _matmul_1;\n  _matmul_1 -> out_mat_0_1;\n\n  out_gat_0_2 [shape=box label=\"out_gat_0_2\" fontsize=10];\n  _gather_2 [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather_2)\naxis=0\" fontsize=10];\n  out_tra_0_1 -> _gather_2;\n  init_b23 -> _gather_2;\n  _gather_2 -> out_gat_0_2;\n\n  out_tra_0_2 [shape=box label=\"out_tra_0_2\" fontsize=10];\n  _transpose_2 [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose_2)\nperm=[1 0 2 3]\" fontsize=10];\n  out_mat_0_1 -> _transpose_2;\n  _transpose_2 -> out_tra_0_2;\n\n  out_sli_0_5 [shape=box label=\"out_sli_0_5\" fontsize=10];\n  _slice_5 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_5)\" fontsize=10];\n  out_gat_0_2 -> _slice_5;\n  init -> _slice_5;\n  init_9 -> _slice_5;\n  init_9 -> _slice_5;\n  _slice_5 -> out_sli_0_5;\n\n  out_sli_0_6 [shape=box label=\"out_sli_0_6\" fontsize=10];\n  _slice_6 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_6)\" fontsize=10];\n  out_tra_0_2 -> _slice_6;\n  init_9 -> _slice_6;\n  init_b28 -> _slice_6;\n  init -> _slice_6;\n  _slice_6 -> out_sli_0_6;\n\n  out_uns_0_4 [shape=box label=\"out_uns_0_4\" fontsize=10];\n  _unsqueeze_4 [shape=box style=\"filled,rounded\" color=orange label=\"Unsqueeze\n(_unsqueeze_4)\" fontsize=10];\n  out_sli_0_5 -> _unsqueeze_4;\n  init_9 -> _unsqueeze_4;\n  _unsqueeze_4 -> out_uns_0_4;\n\n  out_sli_0_7 [shape=box label=\"out_sli_0_7\" fontsize=10];\n  _slice_7 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_7)\" fontsize=10];\n  out_tra_0_2 -> _slice_7;\n  init -> _slice_7;\n  init_9 -> _slice_7;\n  init -> _slice_7;\n  _slice_7 -> out_sli_0_7;\n\n  out_neg_0 [shape=box label=\"out_neg_0\" fontsize=10];\n  _neg [shape=box style=\"filled,rounded\" color=orange label=\"Neg\n(_neg)\" fontsize=10];\n  out_sli_0_6 -> _neg;\n  _neg -> out_neg_0;\n\n  out_mat_0_2 [shape=box label=\"out_mat_0_2\" fontsize=10];\n  _matmul_2 [shape=box style=\"filled,rounded\" color=orange label=\"MatMul\n(_matmul_2)\" fontsize=10];\n  out_uns_0_3 -> _matmul_2;\n  out_uns_0_4 -> _matmul_2;\n  _matmul_2 -> out_mat_0_2;\n\n  out_con_0_1 [shape=box label=\"out_con_0_1\" fontsize=10];\n  _concat_1 [shape=box style=\"filled,rounded\" color=orange label=\"Concat\n(_concat_1)\naxis=0\" fontsize=10];\n  out_neg_0 -> _concat_1;\n  out_sli_0_7 -> _concat_1;\n  _concat_1 -> out_con_0_1;\n\n  out_tra_0_3 [shape=box label=\"out_tra_0_3\" fontsize=10];\n  _transpose_3 [shape=box style=\"filled,rounded\" color=orange label=\"Transpose\n(_transpose_3)\nperm=[1 0 2 3]\" fontsize=10];\n  out_mat_0_2 -> _transpose_3;\n  _transpose_3 -> out_tra_0_3;\n\n  out_add_0 [shape=box label=\"out_add_0\" fontsize=10];\n  _add [shape=box style=\"filled,rounded\" color=orange label=\"Add\n(_add)\" fontsize=10];\n  out_tra_0_3 -> _add;\n  out_con_0_1 -> _add;\n  _add -> out_add_0;\n\n  out_sli_0_8 [shape=box label=\"out_sli_0_8\" fontsize=10];\n  _slice_8 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_8)\" fontsize=10];\n  out_add_0 -> _slice_8;\n  init_4 -> _slice_8;\n  init_b37 -> _slice_8;\n  init_b38 -> _slice_8;\n  _slice_8 -> out_sli_0_8;\n\n  out_sha_0_2 [shape=box label=\"out_sha_0_2\" fontsize=10];\n  _shape_2 [shape=box style=\"filled,rounded\" color=orange label=\"Shape\n(_shape_2)\" fontsize=10];\n  out_sli_0_8 -> _shape_2;\n  _shape_2 -> out_sha_0_2;\n\n  out_sha_0_3 [shape=box label=\"out_sha_0_3\" fontsize=10];\n  _shape_3 [shape=box style=\"filled,rounded\" color=orange label=\"Shape\n(_shape_3)\" fontsize=10];\n  out_sha_0_2 -> _shape_3;\n  _shape_3 -> out_sha_0_3;\n\n  out_gat_0_3 [shape=box label=\"out_gat_0_3\" fontsize=10];\n  _gather_3 [shape=box style=\"filled,rounded\" color=orange label=\"Gather\n(_gather_3)\" fontsize=10];\n  out_sha_0_3 -> _gather_3;\n  init -> _gather_3;\n  _gather_3 -> out_gat_0_3;\n\n  out_sli_0_9 [shape=box label=\"out_sli_0_9\" fontsize=10];\n  _slice_9 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_9)\" fontsize=10];\n  out_sha_0_2 -> _slice_9;\n  init_1 -> _slice_9;\n  out_gat_0_3 -> _slice_9;\n  init -> _slice_9;\n  _slice_9 -> out_sli_0_9;\n\n  out_sli_0_b10 [shape=box label=\"out_sli_0_b10\" fontsize=10];\n  _slice_b10 [shape=box style=\"filled,rounded\" color=orange label=\"Slice\n(_slice_b10)\" fontsize=10];\n  out_sha_0 -> _slice_b10;\n  init -> _slice_b10;\n  init_1 -> _slice_b10;\n  init -> _slice_b10;\n  _slice_b10 -> out_sli_0_b10;\n\n  out_con_0_2 [shape=box label=\"out_con_0_2\" fontsize=10];\n  _concat_2 [shape=box style=\"filled,rounded\" color=orange label=\"Concat\n(_concat_2)\naxis=0\" fontsize=10];\n  init_b28 -> _concat_2;\n  out_sli_0_b10 -> _concat_2;\n  out_sli_0_9 -> _concat_2;\n  _concat_2 -> out_con_0_2;\n\n  _reshape_1 [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\n(_reshape_1)\" fontsize=10];\n  out_sli_0_8 -> _reshape_1;\n  out_con_0_2 -> _reshape_1;\n  _reshape_1 -> y;\n}");
document.getElementById('Mea4195a12d3949658299aedb50551e70').innerHTML = svgGraph; });

</script><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fft2d_any.onnx&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">onnx_rfft_2d_any</span><span class="o">.</span><span class="n">signed_compiled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">onnx_rfft_2d_any</span><span class="o">.</span><span class="n">signed_compiled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">compiled</span><span class="o">.</span><span class="n">onnx_</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</pre></div>
</div>
<p>Let’s check the intermediate results.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">onnx_rfft_2d_any</span><span class="o">.</span><span class="n">signed_compiled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">key</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FctVersion</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,),</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">onnx_rfft_2d_any</span><span class="o">.</span><span class="n">signed_compiled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">compiled</span><span class="o">.</span><span class="n">onnx_</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">},</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fLOG</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">2</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_4&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_5&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_6&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_8&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_9&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b11&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b14&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">3</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b16&#39;</span><span class="p">:</span> <span class="p">()</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b21&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b23&#39;</span><span class="p">:</span> <span class="p">()</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b28&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">2</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b37&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">+</span><span class="n">ki</span><span class="o">=</span><span class="s1">&#39;init_b38&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">2</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">--</span> <span class="n">OnnxInference</span><span class="p">:</span> <span class="n">run</span> <span class="mi">38</span> <span class="n">nodes</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sha_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_shape&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sha_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Shape</span><span class="p">(</span><span class="n">out_sha_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sha_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_shape_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sha_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">3</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Gather</span><span class="p">(</span><span class="n">out_sha_0_1</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gather&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_gat_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">3</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_sha_0</span><span class="p">,</span> <span class="n">init_1</span><span class="p">,</span> <span class="n">out_gat_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Concat</span><span class="p">(</span><span class="n">init_3</span><span class="p">,</span> <span class="n">out_sli_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_con_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_concat&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_con_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">out_con_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_res_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_reshape&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_res_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.0340726375579834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.391742706298828</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_res_0</span><span class="p">,</span> <span class="n">init_4</span><span class="p">,</span> <span class="n">init_5</span><span class="p">,</span> <span class="n">init_6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.0340726375579834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.391742706298828</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Transpose</span><span class="p">(</span><span class="n">out_sli_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_tra_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_transpose&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_tra_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.0340726375579834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.391742706298828</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_tra_0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_8</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.0340726375579834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.391742706298828</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Unsqueeze</span><span class="p">(</span><span class="n">out_sli_0_2</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_uns_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_unsqueeze&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_uns_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.0340726375579834</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.391742706298828</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Unsqueeze</span><span class="p">(</span><span class="n">init_b11</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_uns_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_unsqueeze_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_uns_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">MatMul</span><span class="p">(</span><span class="n">out_uns_0_1</span><span class="p">,</span> <span class="n">out_uns_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mat_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_matmul&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_mat_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_mat_0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_b14</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_3</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_3&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Transpose</span><span class="p">(</span><span class="n">out_sli_0_3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_tra_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_transpose_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_tra_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Gather</span><span class="p">(</span><span class="n">out_tra_0_1</span><span class="p">,</span> <span class="n">init_b16</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gather_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_gat_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_gat_0_1</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_9</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_4</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_4&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_4&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Unsqueeze</span><span class="p">(</span><span class="n">out_sli_0_4</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_uns_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_unsqueeze_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_uns_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Unsqueeze</span><span class="p">(</span><span class="n">init_b21</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_uns_0_3</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_unsqueeze_3&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_uns_0_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">MatMul</span><span class="p">(</span><span class="n">out_uns_0_3</span><span class="p">,</span> <span class="n">out_uns_0_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mat_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_matmul_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_mat_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Gather</span><span class="p">(</span><span class="n">out_tra_0_1</span><span class="p">,</span> <span class="n">init_b23</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gather_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_gat_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Transpose</span><span class="p">(</span><span class="n">out_mat_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_tra_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_transpose_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_tra_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_gat_0_2</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_9</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_5</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_5&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_5&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_tra_0_2</span><span class="p">,</span> <span class="n">init_9</span><span class="p">,</span> <span class="n">init_b28</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_6</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_6&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_6&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Unsqueeze</span><span class="p">(</span><span class="n">out_sli_0_5</span><span class="p">,</span> <span class="n">init_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_uns_0_4</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_unsqueeze_4&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_uns_0_4&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_tra_0_2</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_9</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_7</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_7&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_7&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Neg</span><span class="p">(</span><span class="n">out_sli_0_6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_neg_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_neg&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_neg_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">0.0</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">MatMul</span><span class="p">(</span><span class="n">out_uns_0_3</span><span class="p">,</span> <span class="n">out_uns_0_4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mat_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_matmul_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_mat_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Concat</span><span class="p">(</span><span class="n">out_neg_0</span><span class="p">,</span> <span class="n">out_sli_0_7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_con_0_1</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_concat_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_con_0_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.054079532623291</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.054079532623291</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Transpose</span><span class="p">(</span><span class="n">out_mat_0_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_tra_0_3</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_transpose_3&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_tra_0_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Add</span><span class="p">(</span><span class="n">out_tra_0_3</span><span class="p">,</span> <span class="n">out_con_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_add&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_add_0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">,</span> <span class="n">init_4</span><span class="p">,</span> <span class="n">init_b37</span><span class="p">,</span> <span class="n">init_b38</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_8</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_8&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_8&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Shape</span><span class="p">(</span><span class="n">out_sli_0_8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sha_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_shape_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sha_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Shape</span><span class="p">(</span><span class="n">out_sha_0_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sha_0_3</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_shape_3&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sha_0_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Gather</span><span class="p">(</span><span class="n">out_sha_0_3</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0_3</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gather_3&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_gat_0_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_sha_0_2</span><span class="p">,</span> <span class="n">init_1</span><span class="p">,</span> <span class="n">out_gat_0_3</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_9</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_9&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_9&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Slice</span><span class="p">(</span><span class="n">out_sha_0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">init_1</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sli_0_b10</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_slice_b10&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_sli_0_b10&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">3</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Concat</span><span class="p">(</span><span class="n">init_b28</span><span class="p">,</span> <span class="n">out_sli_0_b10</span><span class="p">,</span> <span class="n">out_sli_0_9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_con_0_2</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_concat_2&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;out_con_0_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">int64</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Onnx</span><span class="o">-</span><span class="n">Reshape</span><span class="p">(</span><span class="n">out_sli_0_8</span><span class="p">,</span> <span class="n">out_con_0_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">y</span>    <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_reshape_1&#39;</span><span class="p">)</span>
<span class="o">+</span><span class="n">kr</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">float32</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">2.188795566558838</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3.3646905422210693</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([[[[</span><span class="o">-</span><span class="mf">8.3439898e-01</span><span class="p">,</span>  <span class="mf">6.9026375e-01</span><span class="p">,</span>  <span class="mf">3.2907667e+00</span><span class="p">]],</span>

         <span class="p">[[</span> <span class="mf">3.3646905e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9031307e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0941215e+00</span><span class="p">]],</span>

         <span class="p">[[</span> <span class="mf">2.1246734e+00</span><span class="p">,</span>  <span class="mf">5.1293659e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1887956e+00</span><span class="p">]]],</span>


        <span class="p">[[[</span> <span class="mf">0.0000000e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0055625e+00</span><span class="p">,</span>  <span class="mf">8.1667386e-16</span><span class="p">]],</span>

         <span class="p">[[</span> <span class="mf">0.0000000e+00</span><span class="p">,</span>  <span class="mf">2.0540795e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.0671079e-16</span><span class="p">]],</span>

         <span class="p">[[</span> <span class="mf">0.0000000e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2617974e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.5504507e-16</span><span class="p">]]]],</span>
       <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)}</span>
</pre></div>
</div>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="onnx_ffts.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">ONNX FFTs</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="onnx_float32_and_64.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">ONNX graph, single or double floats</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>