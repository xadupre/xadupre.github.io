
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>2021-08-11 Decompose einsum into numpy operators &#8212; Python Runtime for ONNX</title>
    
    <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2021-08-10 onnxruntime shape [] != None" href="2021-08-10_shape.html" />
    <link rel="prev" title="2021-08-12 A few tricks for tf2onnx" href="2021-08-12_tf2onnx.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../glossary.html">
   Glossary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../all_indexes.html">
   All indexes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../all_report.html">
   Statistics on code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../filechanges.html">
   Changes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../index_module.html">
   Modules
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../i_faq.html">
   FAQ
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../i_nb.html">
   Magic commands
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../blogindex.html">
   Blog Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../license.html">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   mlprodict
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="simple visible nav section-nav flex-column">
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="decompose-einsum-into-numpy-operators">
<span id="post-2021-08-11-decomposeeinsumintonumpyoperators"></span><h1>2021-08-11 Decompose einsum into numpy operators<a class="headerlink" href="#decompose-einsum-into-numpy-operators" title="Permalink to this headline">¶</a></h1>
<p>
<script>
function share_url(share) {
    var url = share + encodeURIComponent(window.location.href);
    window.location.href = url;
}

function share_icon(divid, text) {
    var canvas = document.getElementById(divid);
    var context = canvas.getContext('2d');
    var centerX = canvas.width / 2;
    var centerY = canvas.height / 2;
    var radius = centerX;

    context.beginPath();
    context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
    context.fillStyle = '#444444';
    context.fill();
    context.font = '' + (centerX*4/3) + 'pt Calibri';
    context.textAlign = 'center';
    context.fillStyle = '#FFFFFF';
    context.fillText(text, centerX, centerY+centerY*16/30);
}
</script>
<a href="#" onclick="share_url('https://www.facebook.com/sharer/sharer.php?u=');return false;"><canvas height="20" id="canvas-f" width="20"/></a><script>share_icon('canvas-f', 'f');</script><a href="#" onclick="share_url('https://www.linkedin.com/shareArticle?mini=true&amp;title=&amp;summary=&amp;source=&amp;url=');return false;"><canvas height="20" id="canvas-in" width="20"/></a><script>share_icon('canvas-in', 'in');</script><a href="#" onclick="share_url('https://twitter.com/home?status=');return false;"><canvas height="20" id="canvas-t" width="20"/></a><script>share_icon('canvas-t', 't');</script></p>
<p>Notebook <a class="reference internal" href="../../notebooks/einsum_decomposition.html#einsumdecompositionrst"><span class="std std-ref">Einsum decomposition</span></a> what function <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.einsum.html">numpy.einsum</a>
does and how it can be decomposed into a series of basic operations,
all available in ONNX. That’s the purpose of function
Function <a class="reference internal" href="../../mlprodict/testing/einsum/einsum_impl.html#mlprodict.testing.einsum.einsum_impl.decompose_einsum_equation" title="mlprodict.testing.einsum.einsum_impl.decompose_einsum_equation"><code class="xref py py-func docutils literal notranslate"><span class="pre">decompose_einsum_equation</span></code></a>.
With function <a class="reference internal" href="../../mlprodict/onnx_tools/onnx_export.html#mlprodict.onnx_tools.onnx_export.export2numpy" title="mlprodict.onnx_tools.onnx_export.export2numpy"><code class="xref py py-func docutils literal notranslate"><span class="pre">export2numpy</span></code></a>, it is possible to
convert back this ONNX graph into a series of numpy operations.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.testing.einsum</span> <span class="kn">import</span> <span class="n">decompose_einsum_equation</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.onnx_export</span> <span class="kn">import</span> <span class="n">export2numpy</span>

<span class="n">seq_clean</span> <span class="o">=</span> <span class="n">decompose_einsum_equation</span><span class="p">(</span>
    <span class="s2">&quot;bsnh,btnh-&gt;bnts&quot;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">seq_clean</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X1&quot;</span><span class="p">,</span> <span class="s2">&quot;X2&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">code</span> <span class="o">=</span> <span class="n">export2numpy</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;einsum&quot;</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">scipy_special</span>
    <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="k">as</span> <span class="nn">scipy_distance</span>
    <span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.exports.numpy_helper</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">argmax_use_numpy_select_last_index</span><span class="p">,</span>
        <span class="n">argmin_use_numpy_select_last_index</span><span class="p">,</span>
        <span class="n">array_feature_extrator</span><span class="p">,</span>
        <span class="n">make_slice</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">numpy_einsum</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Numpy function for ``einsum``.</span>
<span class="sd">    </span>
<span class="sd">        * producer: mlprodict</span>
<span class="sd">        * version: 0</span>
<span class="sd">        * description: </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># initializers</span>
    
        <span class="n">D</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
        <span class="n">E</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
        <span class="n">F</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
        <span class="n">I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
        <span class="c1"># nodes</span>
    
        <span class="n">K</span> <span class="o">=</span> <span class="n">X1</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">X2</span>
        <span class="n">O</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">W</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">BA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">BB</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">BA</span><span class="p">))</span>
        <span class="n">BD</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">BC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">BE</span> <span class="o">=</span> <span class="n">BB</span> <span class="o">@</span> <span class="n">BD</span>
        <span class="n">BF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">BG</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">BH</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">BI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">BF</span><span class="p">,</span> <span class="n">BG</span><span class="p">,</span> <span class="n">BH</span><span class="p">,</span> <span class="n">I</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">BJ</span> <span class="o">=</span> <span class="n">BE</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">BI</span><span class="p">))</span>
        <span class="n">BK</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">BJ</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">BL</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">BK</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">BM</span> <span class="o">=</span> <span class="n">BL</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">BM</span>
    
        <span class="k">return</span> <span class="n">Y</span>
</pre></div>
</div>
<p>In some cases, it is faster to permute a matrix before doing
a matrix multiplication. There exists many equivalent equation
by permutating letters inside the initial equation.
All leads to the same results but, once decomposed, they do different
transpositions. The following code is obtained by looking for the
best permutation and converting the optimized ONNX graph into
<em>numpy</em>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.onnx_export</span> <span class="kn">import</span> <span class="n">export2numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.testing.einsum</span> <span class="kn">import</span> <span class="n">optimize_decompose_einsum_equation</span>

<span class="n">seq_opt</span> <span class="o">=</span> <span class="n">optimize_decompose_einsum_equation</span><span class="p">(</span>
    <span class="s2">&quot;bsnh,btnh-&gt;bnts&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;ml&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;best equation:&quot;</span><span class="p">,</span> <span class="n">seq_opt</span><span class="o">.</span><span class="n">equation_</span><span class="p">)</span>
<span class="n">code</span> <span class="o">=</span> <span class="n">export2numpy</span><span class="p">(</span><span class="n">seq_opt</span><span class="o">.</span><span class="n">onnx_</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;einsum_opt&quot;</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    best equation: bhts,bnts-&gt;btnh
    import numpy
    import scipy.special as scipy_special
    import scipy.spatial.distance as scipy_distance
    from mlprodict.onnx_tools.exports.numpy_helper import (
        argmax_use_numpy_select_last_index,
        argmin_use_numpy_select_last_index,
        array_feature_extrator,
        make_slice)
    
    
    def numpy_einsum_opt(X0, X1):
        &#39;&#39;&#39;
        Numpy function for ``einsum_opt``.
    
        * producer: mlprodict
        * version: 0
        * description: 
        &#39;&#39;&#39;
        # initializers
    
        D = numpy.array([0, 1], dtype=numpy.int64)
    
        E = numpy.array([4], dtype=numpy.int64)
    
        F = numpy.array([-1], dtype=numpy.int64)
    
        I = numpy.array([1], dtype=numpy.int64)
    
        # nodes
    
        K = X0
        L = numpy.expand_dims(K, axis=2)
        M = numpy.transpose(L, axes=(0, 3, 1, 2, 4))
        N = X1
        O = numpy.expand_dims(N, axis=1)
        P = numpy.transpose(O, axes=(0, 3, 1, 2, 4))
        Q = numpy.array(M.shape, dtype=numpy.int64)
        R = numpy.array(P.shape, dtype=numpy.int64)
        S = numpy.take(Q, D, axis=0)
        T = numpy.take(R, D, axis=0)
        U = S.prod(axis=0, keepdims=1)
        V = T.prod(axis=0, keepdims=1)
        W = numpy.take(Q, E, axis=0)
        X = numpy.take(R, E, axis=0)
        Z = numpy.concatenate([U, F, W], 0)
        BA = numpy.concatenate([V, F, X], 0)
        BB = M.reshape(tuple(Z))
        BC = P.reshape(tuple(BA))
        BD = numpy.transpose(BC, axes=(0, 2, 1))
        BE = BB @ BD
        BF = numpy.maximum(S, T)
        BG = numpy.take(Q, [2], axis=0)
        BH = numpy.take(R, [3], axis=0)
        BI = numpy.concatenate([BF, BG, BH, I], 0)
        BJ = BE.reshape(tuple(BI))
        BK = numpy.transpose(BJ, axes=(0, 1, 3, 4, 2))
        BL = numpy.squeeze(BK, axis=3)
        BM = BL
        Y = BM
    
        return Y
    [runpythonerror]
    0%|          | 0/121 [00:00&lt;?, ?it/s]
4.5 mlbest=&#39;bsnh,btnh-&gt;bnts&#39;:   0%|          | 0/121 [00:00&lt;?, ?it/s]
4.5 mlbest=&#39;bsnh,btnh-&gt;bnts&#39;:   1%|          | 1/121 [00:00&lt;01:08,  1.76it/s]
4.5 mlbest=&#39;bsnh,btnh-&gt;bnts&#39;:   3%|▎         | 4/121 [00:00&lt;00:15,  7.38it/s]
4.5 mlbest=&#39;bnth,bsth-&gt;btsn&#39;:   3%|▎         | 4/121 [00:00&lt;00:15,  7.38it/s]
4.5 mlbest=&#39;bnth,bsth-&gt;btsn&#39;:   6%|▌         | 7/121 [00:00&lt;00:09, 11.98it/s]
4.5 mlbest=&#39;bnth,bsth-&gt;btsn&#39;:   8%|▊         | 10/121 [00:00&lt;00:06, 16.12it/s]
4.5 mlbest=&#39;bnht,bsht-&gt;bhsn&#39;:   8%|▊         | 10/121 [00:00&lt;00:06, 16.12it/s]
4.5 mlbest=&#39;bnht,bsht-&gt;bhsn&#39;:  11%|█         | 13/121 [00:00&lt;00:05, 19.57it/s]
4.5 mlbest=&#39;bhtn,bstn-&gt;btsh&#39;:  11%|█         | 13/121 [00:01&lt;00:05, 19.57it/s]
4.5 mlbest=&#39;bhtn,bstn-&gt;btsh&#39;:  13%|█▎        | 16/121 [00:01&lt;00:04, 21.81it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  13%|█▎        | 16/121 [00:01&lt;00:04, 21.81it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  16%|█▌        | 19/121 [00:01&lt;00:04, 23.90it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  18%|█▊        | 22/121 [00:01&lt;00:03, 25.43it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  21%|██        | 25/121 [00:01&lt;00:03, 26.62it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  23%|██▎       | 28/121 [00:01&lt;00:03, 26.89it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  26%|██▌       | 31/121 [00:01&lt;00:03, 27.59it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  28%|██▊       | 34/121 [00:01&lt;00:03, 28.12it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  31%|███       | 37/121 [00:01&lt;00:02, 28.47it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  33%|███▎      | 40/121 [00:01&lt;00:02, 28.79it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  36%|███▌      | 43/121 [00:02&lt;00:02, 28.35it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  38%|███▊      | 46/121 [00:02&lt;00:02, 28.66it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  40%|████      | 49/121 [00:02&lt;00:02, 28.87it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  43%|████▎     | 52/121 [00:02&lt;00:02, 29.04it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  46%|████▋     | 56/121 [00:02&lt;00:02, 28.77it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  49%|████▉     | 59/121 [00:02&lt;00:02, 28.91it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  51%|█████     | 62/121 [00:02&lt;00:02, 29.05it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  54%|█████▎    | 65/121 [00:02&lt;00:01, 29.11it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  56%|█████▌    | 68/121 [00:02&lt;00:01, 29.24it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  59%|█████▊    | 71/121 [00:02&lt;00:01, 28.62it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  61%|██████    | 74/121 [00:03&lt;00:01, 28.81it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  64%|██████▎   | 77/121 [00:03&lt;00:01, 28.96it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  66%|██████▌   | 80/121 [00:03&lt;00:01, 29.12it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  69%|██████▊   | 83/121 [00:03&lt;00:01, 29.22it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  71%|███████   | 86/121 [00:03&lt;00:01, 28.53it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  74%|███████▎  | 89/121 [00:03&lt;00:01, 28.75it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  76%|███████▌  | 92/121 [00:03&lt;00:01, 28.91it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  79%|███████▊  | 95/121 [00:03&lt;00:00, 29.07it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  81%|████████  | 98/121 [00:03&lt;00:00, 28.51it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  83%|████████▎ | 101/121 [00:04&lt;00:00, 23.54it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  86%|████████▌ | 104/121 [00:04&lt;00:00, 25.06it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  88%|████████▊ | 107/121 [00:04&lt;00:00, 26.22it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  91%|█████████ | 110/121 [00:04&lt;00:00, 27.13it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  93%|█████████▎| 113/121 [00:04&lt;00:00, 27.21it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  96%|█████████▌| 116/121 [00:04&lt;00:00, 27.84it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;:  98%|█████████▊| 119/121 [00:04&lt;00:00, 28.26it/s]
4.5 mlbest=&#39;bhts,bnts-&gt;btnh&#39;: 100%|██████████| 121/121 [00:04&lt;00:00, 25.21it/s]
</pre></div>
</div>
<p>The optimization was done for <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime</a>, that does not guarantee
the result will be faster than with <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.einsum.html">numpy.einsum</a>.
Let’s check…</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_tools.exports.numpy_helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">argmin_use_numpy_select_last_index</span><span class="p">,</span>
    <span class="n">make_slice</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">cpyquickhelper.numbers.speed_measure</span> <span class="kn">import</span> <span class="n">measure_time</span>


<span class="k">def</span> <span class="nf">numpy_einsum</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Numpy function for ``einsum``.</span>

<span class="sd">    * producer: mlprodict</span>
<span class="sd">    * version: 0</span>
<span class="sd">    * description:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># initializers</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="c1"># nodes</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">X1</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">X2</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">W</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
    <span class="n">BC</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">BA</span><span class="p">))</span>
    <span class="n">BD</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">BC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">BE</span> <span class="o">=</span> <span class="n">BB</span> <span class="o">@</span> <span class="n">BD</span>
    <span class="n">BF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">BG</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">BH</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">BI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">BF</span><span class="p">,</span> <span class="n">BG</span><span class="p">,</span> <span class="n">BH</span><span class="p">,</span> <span class="n">I</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BJ</span> <span class="o">=</span> <span class="n">BE</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">BI</span><span class="p">))</span>
    <span class="n">BK</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">BJ</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">BL</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">BK</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="n">BM</span> <span class="o">=</span> <span class="n">BL</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">BM</span>

    <span class="k">return</span> <span class="n">Y</span>


<span class="k">def</span> <span class="nf">numpy_einsum_opt</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">X1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Numpy function for ``einsum``.</span>

<span class="sd">    * producer: mlprodict</span>
<span class="sd">    * version: 0</span>
<span class="sd">    * description:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># initializers</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="c1"># nodes</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">X0</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">X1</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">W</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
    <span class="n">BC</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">BA</span><span class="p">))</span>
    <span class="n">BD</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">BC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">BE</span> <span class="o">=</span> <span class="n">BB</span> <span class="o">@</span> <span class="n">BD</span>
    <span class="n">BF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">BG</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">BH</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">BI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">BF</span><span class="p">,</span> <span class="n">BG</span><span class="p">,</span> <span class="n">BH</span><span class="p">,</span> <span class="n">I</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BJ</span> <span class="o">=</span> <span class="n">BE</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">BI</span><span class="p">))</span>
    <span class="n">BK</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">BJ</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">BL</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">BK</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="n">BM</span> <span class="o">=</span> <span class="n">BL</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">BM</span>

    <span class="k">return</span> <span class="n">Y</span>


<span class="n">N</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Discrepencies?&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bsnh,btnh-&gt;bnts&quot;</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy_einsum</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy_einsum_opt</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numpy.einsum&#39;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bsnh,btnh-&gt;bnts&quot;</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;m1&#39;</span><span class="p">:</span> <span class="n">m1</span><span class="p">,</span> <span class="s1">&#39;m2&#39;</span><span class="p">:</span> <span class="n">m2</span><span class="p">})</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numpy.einsum decomposed&#39;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">numpy_einsum</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;m1&#39;</span><span class="p">:</span> <span class="n">m1</span><span class="p">,</span> <span class="s1">&#39;m2&#39;</span><span class="p">:</span> <span class="n">m2</span><span class="p">,</span>
             <span class="s1">&#39;numpy_einsum&#39;</span><span class="p">:</span> <span class="n">numpy_einsum</span><span class="p">})</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numpy.einsum decomposed and optimized&#39;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">numpy_einsum_opt</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span>
    <span class="n">repeat</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;m1&#39;</span><span class="p">:</span> <span class="n">m1</span><span class="p">,</span> <span class="s1">&#39;m2&#39;</span><span class="p">:</span> <span class="n">m2</span><span class="p">,</span>
             <span class="s1">&#39;numpy_einsum_opt&#39;</span><span class="p">:</span> <span class="n">numpy_einsum_opt</span><span class="p">})</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    Discrepencies?
    [[[[-0.927  0.112]
       [-2.719 -0.349]]
    
      [[ 3.823  3.434]
       [ 0.182  0.198]]]
    
    
     [[[-0.359 -0.723]
       [-0.504  1.648]]
    
      [[ 0.032  1.097]
       [ 1.234 -0.278]]]]
    [[[[-0.927  0.112]
       [-2.719 -0.349]]
    
      [[ 3.823  3.434]
       [ 0.182  0.198]]]
    
    
     [[[-0.359 -0.723]
       [-0.504  1.648]]
    
      [[ 0.032  1.097]
       [ 1.234 -0.278]]]]
    [[[[-0.927  0.112]
       [-2.719 -0.349]]
    
      [[ 3.823  3.434]
       [ 0.182  0.198]]]
    
    
     [[[-0.359 -0.723]
       [-0.504  1.648]]
    
      [[ 0.032  1.097]
       [ 1.234 -0.278]]]]
    numpy.einsum
    {&#39;average&#39;: 0.01407688360195607,
     &#39;context_size&#39;: 232,
     &#39;deviation&#39;: 5.6139706775842834e-05,
     &#39;max_exec&#39;: 0.014215758256614208,
     &#39;min_exec&#39;: 0.014023897238075733,
     &#39;number&#39;: 20,
     &#39;repeat&#39;: 10,
     &#39;ttime&#39;: 0.1407688360195607}
    numpy.einsum decomposed
    {&#39;average&#39;: 0.01168124821037054,
     &#39;context_size&#39;: 232,
     &#39;deviation&#39;: 1.5464487951107088e-05,
     &#39;max_exec&#39;: 0.011691194865852595,
     &#39;min_exec&#39;: 0.011635342985391617,
     &#39;number&#39;: 20,
     &#39;repeat&#39;: 10,
     &#39;ttime&#39;: 0.1168124821037054}
    numpy.einsum decomposed and optimized
    {&#39;average&#39;: 0.011680002780631183,
     &#39;context_size&#39;: 232,
     &#39;deviation&#39;: 4.7286927512505945e-06,
     &#39;max_exec&#39;: 0.011691913893446326,
     &#39;min_exec&#39;: 0.011674199113622307,
     &#39;number&#39;: 20,
     &#39;repeat&#39;: 10,
     &#39;ttime&#39;: 0.11680002780631184}
</pre></div>
</div>
<p>The optimization is not faster than the first decomposition
but the decomposition is faster than the numpy implementation.</p>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="2021-08-12_tf2onnx.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">2021-08-12 A few tricks for tf2onnx</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="2021-08-10_shape.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">2021-08-10 onnxruntime shape [] != None</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>