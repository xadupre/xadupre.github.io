
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Xop API &#8212; Python Runtime for ONNX</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Export ONNX into Python" href="ex_python.html" />
    <link rel="prev" title="Numpy to ONNX: Create ONNX graphs with an API similar to numpy" href="numpy_api_onnx.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_runtime.html">
   Execute ONNX graphs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="optim.html">
   Converters with options
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="benchmark.html">
   Benchmarks
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="skl.html">
   From scikit-learn to ONNX
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_numpy.html">
   Create custom ONNX graphs with AST
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_api_onnx.html">
   Numpy to ONNX: Create ONNX graphs with an API similar to numpy
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Xop API
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="ex_python.html">
   Export ONNX into Python
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#short-example">
   Short Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initializers">
   Initializers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#attributes">
   Attributes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implicit-use-of-onnx-operators">
   Implicit use of ONNX operators
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#operators-with-multiple-outputs">
   Operators with multiple outputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sub-estimators">
   Sub Estimators
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inputs-outputs">
   Inputs, outputs
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-output-type">
     Optional output type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiple-inputs-and-multiple-types">
     Multiple inputs and multiple types
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#opsets">
   Opsets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subgraphs">
   Subgraphs
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="xop-api">
<span id="l-xop-api"></span><h1>Xop API<a class="headerlink" href="#xop-api" title="Permalink to this headline">¶</a></h1>
<p>Most of the converting libraries uses <a class="reference external" href="https://github.com/onnx/onnx">onnx</a> to create ONNX graphs.
The API is quite verbose and that is why most of them implement a second
API wrapping the first one. They are not necessarily meant to be used
by users to create ONNX graphs as they are specialized for the training
framework they are developped for.</p>
<p>The API described below is similar to the one implemented in
<a class="reference external" href="https://github.com/onnx/sklearn-onnx">sklearn-onnx</a> but does not depend on it. It be easily moved
to a separate package. <cite>Xop</cite> is the contraction of <em>ONNX Operators</em>.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#short-example" id="id5">Short Example</a></p></li>
<li><p><a class="reference internal" href="#initializers" id="id6">Initializers</a></p></li>
<li><p><a class="reference internal" href="#attributes" id="id7">Attributes</a></p></li>
<li><p><a class="reference internal" href="#implicit-use-of-onnx-operators" id="id8">Implicit use of ONNX operators</a></p></li>
<li><p><a class="reference internal" href="#operators-with-multiple-outputs" id="id9">Operators with multiple outputs</a></p></li>
<li><p><a class="reference internal" href="#sub-estimators" id="id10">Sub Estimators</a></p></li>
<li><p><a class="reference internal" href="#inputs-outputs" id="id11">Inputs, outputs</a></p>
<ul>
<li><p><a class="reference internal" href="#optional-output-type" id="id12">Optional output type</a></p></li>
<li><p><a class="reference internal" href="#multiple-inputs-and-multiple-types" id="id13">Multiple inputs and multiple types</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#opsets" id="id14">Opsets</a></p></li>
<li><p><a class="reference internal" href="#subgraphs" id="id15">Subgraphs</a></p></li>
</ul>
</div>
<section id="short-example">
<h2><a class="toc-backref" href="#id5">Short Example</a><a class="headerlink" href="#short-example" title="Permalink to this headline">¶</a></h2>
<p>Let’s say we need to create a graph computed the square loss between
two float tensor <cite>X</cite> and <cite>Y</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="c1"># This line creates one class for the operator Sub and Mul.</span>
<span class="c1"># It fails if the operators are misspelled.</span>
<span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul&#39;</span><span class="p">)</span>

<span class="c1"># Inputs are defined by their name as strings.</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>

<span class="c1"># Then we create the ONNX graph defining &#39;X&#39; and &#39;Y&#39; as float.</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># We check it does what it should.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.3</span><span class="p">,</span> <span class="mf">5.7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})</span>
<span class="n">assert_almost_equal</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="c1"># Finally, we show the content of the graph.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Visually, the model looks like the following.</p>

    <div id="gdot-140513856667120-cont"><div id="gdot-140513856667120" style="width:100%;height:100%;"></div>
    <script>

    require(['../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\\nfloat(('?',))\" fontsize=10];\n  Y [shape=box color=red label=\"Y\\nfloat(('?',))\" fontsize=10];\n\n  out_mul_0 [shape=box color=green label=\"out_mul_0\\nfloat(('?',))\" fontsize=10];\n\n\n  out_sub_0 [shape=box label=\"out_sub_0\" fontsize=10];\n  _sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\\n(_sub)\" fontsize=10];\n  X -> _sub;\n  Y -> _sub;\n  _sub -> out_sub_0;\n\n  _mul [shape=box style=\"filled,rounded\" color=orange label=\"Mul\\n(_mul)\" fontsize=10];\n  out_sub_0 -> _mul;\n  out_sub_0 -> _mul;\n  _mul -> out_mul_0;\n}\n");
    document.getElementById('gdot-140513856667120').innerHTML = svgGraph; });
    
</script>
</div><p>In the following example, a string such as <cite>‘X’</cite> refers to an input
of the graph. Every class <cite>Onnx*</cite> such as <cite>OnnxSub</cite> or <cite>OnnxMul</cite>
following the signature implied in ONNX specifications
(<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX Operators</a>).
The API supports operators listed here <a class="reference internal" href="../api/xop_supported.html#l-xop-api-supported-ops"><span class="std std-ref">Supported ONNX operators</span></a>.</p>
</section>
<section id="initializers">
<h2><a class="toc-backref" href="#id6">Initializers</a><a class="headerlink" href="#initializers" title="Permalink to this headline">¶</a></h2>
<p>Every numpy array defined as an input of an operator
is automatically converted into an initializer.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxSub</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">)</span>

<span class="c1"># &#39;X&#39; is an input, the second argument is a constant</span>
<span class="c1"># stored as an initializer in the graph.</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="c1"># Then we create the ONNX graph defining &#39;X&#39; and &#39;Y&#39; as float.</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># We check it does what it should.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="c1"># Finally, we show the content of the graph.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_sub_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>There are as many initializers as numpy arrays defined in the graph.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxSub</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">diff2</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">diff2</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Sub</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">init_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0_1</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_sub_0_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>However, the conversion into onnx then applies function
<a class="reference internal" href="../mlprodict/onnx_tools/optim/_main_onnx_optim.html#mlprodict.onnx_tools.optim._main_onnx_optim.onnx_optimisations" title="mlprodict.onnx_tools.optim._main_onnx_optim.onnx_optimisations"><code class="xref py py-func docutils literal notranslate"><span class="pre">onnx_optimisations</span></code></a>
to remove duplicated initializers. It also removes unnecessary
node such as Identity nodes or unused nodes.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxSub</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">diff2</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">diff2</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Sub</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0_1</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_sub_0_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="attributes">
<h2><a class="toc-backref" href="#id7">Attributes</a><a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h2>
<p>Some operators needs attributes such as operator
<a class="reference internal" href="../api/xop_supported.html#l-xop-onnx-onnxtranspose"><span class="std std-ref">Transpose</span></a>. They are
defined as named arguments.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxMatMul</span><span class="p">,</span> <span class="n">OnnxTranspose</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;MatMul&#39;</span><span class="p">,</span> <span class="s1">&#39;Transpose&#39;</span><span class="p">)</span>

<span class="c1"># Named attribute perm defines the permutation.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">OnnxMatMul</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">OnnxTranspose</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>

<span class="c1"># discrepancies?</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">13</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Transpose</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">out_tra_0</span>
      <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">out_tra_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mat_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mat_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Operator <a class="reference internal" href="../api/xop_supported.html#l-xop-onnx-onnxcast"><span class="std std-ref">Cast</span></a> is used to convert
every element of an array into another type. ONNX types
and numpy types are different but the API is able to replace
one by the correspondance type.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxCast</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Cast&#39;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">OnnxCast</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>

<span class="c1"># discrepancies?</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">13</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Cast</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cas_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_cas_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="implicit-use-of-onnx-operators">
<h2><a class="toc-backref" href="#id8">Implicit use of ONNX operators</a><a class="headerlink" href="#implicit-use-of-onnx-operators" title="Permalink to this headline">¶</a></h2>
<p>ONNX defines standard matrix operator associated to operators
+, -, <a href="#id1"><span class="problematic" id="id2">*</span></a>, /, &#64;. The API implicitely replaces them by the corresponding
ONNX operator. In the following example, operator <cite>OnnxMatMul</cite>
was replaced by operator <cite>&#64;</cite>. The final ONNX graph looks the same.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxIdentity</span><span class="p">,</span> <span class="n">OnnxTranspose</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Identity&#39;</span><span class="p">,</span> <span class="s1">&#39;Transpose&#39;</span><span class="p">)</span>

<span class="c1"># @ is implicity replaced by OnnxMatMul</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">OnnxIdentity</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="o">@</span> <span class="n">OnnxTranspose</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>

<span class="c1"># discrepancies?</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>
<span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Transpose</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">out_tra_0</span>
      <span class="n">MatMul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">out_tra_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mat_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mat_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Operator <cite>&#64;</cite> only applies on class <a class="reference internal" href="../mlprodict/npy/xop.html#mlprodict.npy.xop.OnnxOperator" title="mlprodict.npy.xop.OnnxOperator"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxOperator</span></code></a> not on strings.
This is the base class for every class
<a class="reference internal" href="../api/xop_supported.html#l-xop-onnx-onnxidentity"><span class="std std-ref">Identity</span></a>,
<a class="reference internal" href="../api/xop_supported.html#l-xop-onnx-onnxtranspose"><span class="std std-ref">Transpose</span></a>, …
Operator <a class="reference internal" href="../api/xop_supported.html#l-xop-onnx-onnxidentity"><span class="std std-ref">Identity</span></a>
is inserted to wrap input <cite>‘X’</cite> and enables the possibility
to use standard operations +, -, <a href="#id3"><span class="problematic" id="id4">*</span></a>, /, &#64;, &gt;, &gt;=, ==, !=, &lt;, &lt;=, and, or.</p>
</section>
<section id="operators-with-multiple-outputs">
<h2><a class="toc-backref" href="#id9">Operators with multiple outputs</a><a class="headerlink" href="#operators-with-multiple-outputs" title="Permalink to this headline">¶</a></h2>
<p>Operator <a class="reference internal" href="../api/xop_supported.html#l-xop-onnx-onnxtopk"><span class="std std-ref">TopK</span></a> returns two results.
Accessing one of them requires the use of <cite>[]</cite>. The following example
extracts the two greatest elements per rows, uses the positions of
them to select the corresponding weight in another matrix,
multiply them and returns the average per row.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>

<span class="n">OnnxReduceMean</span><span class="p">,</span> <span class="n">OnnxTopK</span><span class="p">,</span> <span class="n">OnnxGatherElements</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span>
    <span class="s1">&#39;ReduceMean&#39;</span><span class="p">,</span> <span class="s1">&#39;TopK&#39;</span><span class="p">,</span> <span class="s1">&#39;GatherElements&#39;</span><span class="p">)</span>

<span class="c1"># @ is implicity replaced by OnnxMatMul</span>
<span class="n">topk</span> <span class="o">=</span> <span class="n">OnnxTopK</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">OnnxGatherElements</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">topk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">OnnxReduceMean</span><span class="p">(</span><span class="n">dist</span> <span class="o">*</span> <span class="n">topk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>

<span class="c1"># discrepancies?</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">W</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Results:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">13</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;W&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">TopK</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_top_0</span><span class="p">,</span> <span class="n">out_top_1</span>
      <span class="n">GatherElements</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">out_top_1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_gat_0</span><span class="p">,</span> <span class="n">out_top_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
        <span class="n">ReduceMean</span><span class="p">(</span><span class="n">out_mul_0</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">out_red_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_red_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    
    <span class="n">Results</span><span class="p">:</span>
    <span class="p">[[</span><span class="mf">3.05</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">1.9</span> <span class="p">]]</span>
</pre></div>
</div>
</section>
<section id="sub-estimators">
<h2><a class="toc-backref" href="#id10">Sub Estimators</a><a class="headerlink" href="#sub-estimators" title="Permalink to this headline">¶</a></h2>
<p>It is a common need to insert an ONNX graph into another one.
It is not a simple merge, there are operations before and after
and the ONNX graph may have been produced by another library.
That is the purpose of class <a class="reference internal" href="../mlprodict/npy/xop_convert.html#mlprodict.npy.xop_convert.OnnxSubOnnx" title="mlprodict.npy.xop_convert.OnnxSubOnnx"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxSubOnnx</span></code></a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop_convert</span> <span class="kn">import</span> <span class="n">OnnxSubOnnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>

<span class="n">OnnxIdentity</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Identity&#39;</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Let&#39;s create a first ONNX graph which implements</span>
<span class="c1"># a Relu function.</span>
<span class="n">vx</span> <span class="o">=</span> <span class="n">OnnxIdentity</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
<span class="n">sign</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sign_float</span> <span class="o">=</span> <span class="n">sign</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">relu</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="n">sign_float</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- Relu graph&#39;</span><span class="p">)</span>
<span class="n">onx_relu</span> <span class="o">=</span> <span class="n">relu</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-- Relu results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx_relu</span><span class="p">))</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx_relu</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-- Results:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

<span class="c1"># Then the second graph including the first one.</span>
<span class="n">x_1</span> <span class="o">=</span> <span class="n">OnnxIdentity</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Class OnnxSubOnnx takes a graph as input and applies it on the</span>
<span class="c1"># given inputs.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">OnnxSubOnnx</span><span class="p">(</span><span class="n">onx_relu</span><span class="p">,</span> <span class="n">x_1</span><span class="p">)</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-- Whole graph&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>

<span class="c1"># Expected results?</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-- Whole results:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">--</span> <span class="n">Relu</span> <span class="n">graph</span>
    
    <span class="o">--</span> <span class="n">Relu</span> <span class="n">results</span>
    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Greater</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gre_0</span>
      <span class="n">Cast</span><span class="p">(</span><span class="n">out_gre_0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cas_0</span>
        <span class="n">Mul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">out_cas_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    
    <span class="o">--</span> <span class="n">Results</span><span class="p">:</span>
    <span class="p">[[</span><span class="o">-</span><span class="mf">0.</span>  <span class="o">-</span><span class="mf">0.</span>   <span class="mf">0.5</span>  <span class="mf">1.5</span><span class="p">]]</span>
    
    <span class="o">--</span> <span class="n">Whole</span> <span class="n">graph</span>
    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0</span>
      <span class="n">Greater</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">,</span> <span class="n">init_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gre_0</span>
        <span class="n">Cast</span><span class="p">(</span><span class="n">out_gre_0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_cas_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">,</span> <span class="n">out_cas_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_sub_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    
    <span class="o">--</span> <span class="n">Whole</span> <span class="n">results</span><span class="p">:</span>
    <span class="p">[[</span><span class="o">-</span><span class="mf">0.</span>   <span class="mf">0.5</span>  <span class="mf">1.5</span>  <span class="mf">2.5</span><span class="p">]]</span>
</pre></div>
</div>
<p>This mechanism is used to plug any model from <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>
converted into ONNX in a bigger graph. Next example averages
the probabilities of two classifiers for a binary classification.
That is the purpose of class <a class="reference internal" href="../mlprodict/npy/xop_convert.html#mlprodict.npy.xop_convert.OnnxSubEstimator" title="mlprodict.npy.xop_convert.OnnxSubEstimator"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxSubEstimator</span></code></a>. The class automatically
calls the appropriate converter, <a class="reference external" href="https://github.com/onnx/sklearn-onnx">sklearn-onnx</a> for
<a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> models.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop_convert</span> <span class="kn">import</span> <span class="n">OnnxSubEstimator</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="c1"># machine learning part</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># we train two models not on the same machine</span>
<span class="n">lr1</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr2</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># score?</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">lr1</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;score1&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">lr2</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;score2&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">p2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>

<span class="c1"># OnnxGraph</span>

<span class="n">OnnxIdentity</span><span class="p">,</span> <span class="n">OnnxGather</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Identity&#39;</span><span class="p">,</span> <span class="s1">&#39;Gather&#39;</span><span class="p">)</span>

<span class="n">x1</span> <span class="o">=</span> <span class="n">OnnxGather</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">OnnxGather</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Class OnnxSubEstimator inserts the model into the ONNX graph.</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">OnnxSubEstimator</span><span class="p">(</span><span class="n">lr1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">X_train</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">OnnxSubEstimator</span><span class="p">(</span><span class="n">lr2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">OnnxIdentity</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">OnnxIdentity</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span>
          <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="c1"># Then the second graph including the first one.</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-- Whole graph&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>

<span class="c1"># Expected results?</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">output_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})[</span><span class="n">name</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">score3&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">score1</span> <span class="mf">0.47901805796542646</span>
    <span class="n">score2</span> <span class="mf">0.9698605488079173</span>
    
    <span class="o">--</span> <span class="n">Whole</span> <span class="n">graph</span>
    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_1&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init_2&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Gather</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0</span>
      <span class="n">LinearClassifier</span><span class="p">(</span><span class="n">out_gat_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">label</span><span class="p">,</span> <span class="n">probability_tensor</span>
        <span class="n">Normalizer</span><span class="p">(</span><span class="n">probability_tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">probabilities</span>
    <span class="n">Gather</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">init_1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_gat_0_1</span>
      <span class="n">LinearClassifier</span><span class="p">(</span><span class="n">out_gat_0_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">label_1</span><span class="p">,</span> <span class="n">probability_tensor_1</span>
        <span class="n">Normalizer</span><span class="p">(</span><span class="n">probability_tensor_1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">probabilities_1</span>
          <span class="n">Add</span><span class="p">(</span><span class="n">probabilities_1</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0</span>
            <span class="n">Div</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">,</span> <span class="n">init_2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_div_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_div_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    
    <span class="n">score3</span> <span class="mf">0.9685752843647581</span>
</pre></div>
</div>

    <div id="gdot-140513737333248-cont"><div id="gdot-140513737333248" style="width:100%;height:100%;"></div>
    <script>

    require(['../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n\n  X [shape=box color=red label=\"X\\nfloat(('?',))\" fontsize=10];\n\n  out_div_0 [shape=box color=green label=\"out_div_0\\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\\nint64((3,))\\n[2 3 4]\" fontsize=10];\n  init_1 [shape=box label=\"init_1\\nint64((2,))\\n[0 1]\" fontsize=10];\n  init_2 [shape=box label=\"init_2\\nfloat32((1,))\\n[2.]\" fontsize=10];\n\n  out_gat_0 [shape=box label=\"out_gat_0\" fontsize=10];\n  _gather [shape=box style=\"filled,rounded\" color=orange label=\"Gather\\n(_gather)\\naxis=1\" fontsize=10];\n  X -> _gather;\n  init -> _gather;\n  _gather -> out_gat_0;\n\n  out_gat_0_1 [shape=box label=\"out_gat_0_1\" fontsize=10];\n  _gather_1 [shape=box style=\"filled,rounded\" color=orange label=\"Gather\\n(_gather_1)\\naxis=1\" fontsize=10];\n  X -> _gather_1;\n  init_1 -> _gather_1;\n  _gather_1 -> out_gat_0_1;\n\n  label [shape=box label=\"label\" fontsize=10];\n  probability_tensor [shape=box label=\"probability_tensor\" fontsize=10];\n  _sub_LinearClassifier [shape=box style=\"filled,rounded\" color=orange label=\"LinearClassifier\\n(_sub_LinearClassifier)\\nclasslabels_ints=[0 1]\\ncoefficients=[-0.09   0.053 -0....\\nintercepts=[-0.023  0.023]\\nmulti_class=1\\npost_transform=b'LOGISTIC'\" fontsize=10];\n  out_gat_0 -> _sub_LinearClassifier;\n  _sub_LinearClassifier -> label;\n  _sub_LinearClassifier -> probability_tensor;\n\n  probabilities [shape=box label=\"probabilities\" fontsize=10];\n  _sub_Normalizer [shape=box style=\"filled,rounded\" color=orange label=\"Normalizer\\n(_sub_Normalizer)\\nnorm=b'L1'\" fontsize=10];\n  probability_tensor -> _sub_Normalizer;\n  _sub_Normalizer -> probabilities;\n\n  label_1 [shape=box label=\"label_1\" fontsize=10];\n  probability_tensor_1 [shape=box label=\"probability_tensor_1\" fontsize=10];\n  _sub_LinearClassifier_1 [shape=box style=\"filled,rounded\" color=orange label=\"LinearClassifier\\n(_sub_LinearClassifier_1)\\nclasslabels_ints=[0 1]\\ncoefficients=[-0.032 -3.76   0....\\nintercepts=[ 0.494 -0.494]\\nmulti_class=1\\npost_transform=b'LOGISTIC'\" fontsize=10];\n  out_gat_0_1 -> _sub_LinearClassifier_1;\n  _sub_LinearClassifier_1 -> label_1;\n  _sub_LinearClassifier_1 -> probability_tensor_1;\n\n  probabilities_1 [shape=box label=\"probabilities_1\" fontsize=10];\n  _sub_Normalizer_1 [shape=box style=\"filled,rounded\" color=orange label=\"Normalizer\\n(_sub_Normalizer_1)\\nnorm=b'L1'\" fontsize=10];\n  probability_tensor_1 -> _sub_Normalizer_1;\n  _sub_Normalizer_1 -> probabilities_1;\n\n  out_add_0 [shape=box label=\"out_add_0\" fontsize=10];\n  _add [shape=box style=\"filled,rounded\" color=orange label=\"Add\\n(_add)\" fontsize=10];\n  probabilities_1 -> _add;\n  probabilities -> _add;\n  _add -> out_add_0;\n\n  _div [shape=box style=\"filled,rounded\" color=orange label=\"Div\\n(_div)\" fontsize=10];\n  out_add_0 -> _div;\n  init_2 -> _div;\n  _div -> out_div_0;\n}\n");
    document.getElementById('gdot-140513737333248').innerHTML = svgGraph; });
    
</script>
</div></section>
<section id="inputs-outputs">
<h2><a class="toc-backref" href="#id11">Inputs, outputs</a><a class="headerlink" href="#inputs-outputs" title="Permalink to this headline">¶</a></h2>
<p>The following code does not specify on which type it applies,
float32, float64, it could be a tensor of any of numerical type.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    OnnxMul(2 in) -&gt; ?
</pre></div>
</div>
<p>That is why this information must be specified when it is being
converted into ONNX. That explains why method <a class="reference internal" href="../mlprodict/npy/xop.html#mlprodict.npy.xop.OnnxOperator.to_onnx" title="mlprodict.npy.xop.OnnxOperator.to_onnx"><code class="xref py py-meth docutils literal notranslate"><span class="pre">to_onnx</span></code></a> needs more information
to convert the object into ONNX: <cite>to_onnx(&lt;input type&gt;, &lt;output type&gt;)</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>

<span class="c1"># First numpy.float32 is for the input.</span>
<span class="c1"># Second numpy.float32 is for the output.</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Wrong types are possible however the runtime executing the graph
may raise an exception telling the graph cannot be executed.</p>
<section id="optional-output-type">
<h3><a class="toc-backref" href="#id12">Optional output type</a><a class="headerlink" href="#optional-output-type" title="Permalink to this headline">¶</a></h3>
<p>Most of the time the output type can be guessed based on the signature
of every operator involved in the graph. Second argument, <cite>output_type</cite>,
is optional.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="multiple-inputs-and-multiple-types">
<h3><a class="toc-backref" href="#id13">Multiple inputs and multiple types</a><a class="headerlink" href="#multiple-inputs-and-multiple-types" title="Permalink to this headline">¶</a></h3>
<p>Previous syntax assumes all inputs or outputs share the same type.
That is usually the case but not always. The order of inputs
is not very clear and that explains why the different types
are specifed using a dictionary using name as keys.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop_variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxMul</span><span class="p">,</span> <span class="n">OnnxReshape</span><span class="p">,</span> <span class="n">OnnxReduceSum</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span>
    <span class="s1">&#39;Mul&#39;</span><span class="p">,</span> <span class="s1">&#39;Reshape&#39;</span><span class="p">,</span> <span class="s1">&#39;ReduceSum&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxReshape</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">diff2</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="n">sumd</span> <span class="o">=</span> <span class="n">OnnxReduceSum</span><span class="p">(</span><span class="n">diff2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">sumd</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">},</span>
                   <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">14</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_res_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_res_0</span><span class="p">,</span> <span class="n">out_res_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
        <span class="n">ReduceSum</span><span class="p">(</span><span class="n">out_mul_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_red_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_red_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Specifying output types is more tricky. Types must still be specified
by names but output names are unknown. They are decided when the conversion
happens unless the user wants them to be named as his wished. That is where
argument <em>output_names</em> takes place in the story. It forces method <em>to_onnx</em>
to keep the chosen names when the model is converting into ONNX and
then we can be sure to give the proper type to the proper output.
The two ouputs are coming from two different objects, the conversion
is started by calling <cite>to_onnx</cite> from one and the other one is added
in argument <cite>other_outputs</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxMul</span><span class="p">,</span> <span class="n">OnnxReshape</span><span class="p">,</span> <span class="n">OnnxReduceSum</span><span class="p">,</span> <span class="n">OnnxShape</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span>
    <span class="s1">&#39;Mul&#39;</span><span class="p">,</span> <span class="s1">&#39;Reshape&#39;</span><span class="p">,</span> <span class="s1">&#39;ReduceSum&#39;</span><span class="p">,</span> <span class="s1">&#39;Shape&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxReshape</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">diff2</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="n">sumd</span> <span class="o">=</span> <span class="n">OnnxReduceSum</span><span class="p">(</span><span class="n">diff2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                     <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">OnnxShape</span><span class="p">(</span><span class="n">sumd</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">sumd</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">},</span>
                   <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">},</span>
                   <span class="n">other_outputs</span><span class="o">=</span><span class="p">[</span><span class="n">shape</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_res_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_res_0</span><span class="p">,</span> <span class="n">out_res_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
        <span class="n">ReduceSum</span><span class="p">(</span><span class="n">out_mul_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Z</span>
          <span class="n">Shape</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">S</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;S&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Runtime for ONNX are usually better when inputs and output shapes
are known or at least some part of it. That can be done the following way.
It needs to be done through a list of <a class="reference internal" href="../mlprodict/npy/xop_variable.html#mlprodict.npy.xop_variable.Variable" title="mlprodict.npy.xop_variable.Variable"><code class="xref py py-class docutils literal notranslate"><span class="pre">Variable</span></code></a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop_variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">OnnxMul</span><span class="p">,</span> <span class="n">OnnxReshape</span><span class="p">,</span> <span class="n">OnnxReduceSum</span><span class="p">,</span> <span class="n">OnnxShape</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span>
    <span class="s1">&#39;Mul&#39;</span><span class="p">,</span> <span class="s1">&#39;Reshape&#39;</span><span class="p">,</span> <span class="s1">&#39;ReduceSum&#39;</span><span class="p">,</span> <span class="s1">&#39;Shape&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxReshape</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">diff2</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="n">sumd</span> <span class="o">=</span> <span class="n">OnnxReduceSum</span><span class="p">(</span><span class="n">diff2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                     <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">OnnxShape</span><span class="p">(</span><span class="n">sumd</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">sumd</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span>
    <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
     <span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">])],</span>
    <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
     <span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">])],</span>
    <span class="n">other_outputs</span><span class="o">=</span><span class="p">[</span><span class="n">shape</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">15</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">--</span> <span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_res_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_res_0</span><span class="p">,</span> <span class="n">out_res_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
        <span class="n">ReduceSum</span><span class="p">(</span><span class="n">out_mul_0</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Z</span>
          <span class="n">Shape</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">S</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;S&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
</pre></div>
</div>
</section>
</section>
<section id="opsets">
<h2><a class="toc-backref" href="#id14">Opsets</a><a class="headerlink" href="#opsets" title="Permalink to this headline">¶</a></h2>
<p>ONNX is versioned. The assumption is every old ONNX graph must remain
valid even if new verions of the language were released. By default,
the latest supported version is used. You first have the latest version
installed:</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx.defs</span> <span class="kn">import</span> <span class="n">onnx_opset_version</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnx_opset_version() -&gt;&quot;</span><span class="p">,</span> <span class="n">onnx_opset_version</span><span class="p">())</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">onnx_opset_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="mi">16</span>
</pre></div>
</div>
<p>But the library does not always support the latest version right away.
That is the default opset if none is given.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">mlprodict</span> <span class="kn">import</span> <span class="n">__max_supported_opset__</span><span class="p">,</span> <span class="n">__max_supported_opsets__</span>
<span class="nb">print</span><span class="p">(</span><span class="n">__max_supported_opset__</span><span class="p">)</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">__max_supported_opsets__</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="mi">15</span>
    <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</pre></div>
</div>
<p>Following example shows how to force the opset to 12 instead of the
default version. It must be specified in two places, in every operator,
and when calling <cite>to_onnx</cite> with argument <cite>target_opset</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">opset</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxMul</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul&#39;</span><span class="p">)</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                    <span class="n">target_opset</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">12</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>It can be also done by using the specific class corresponding to
the most recent version below the considered opset.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">opset</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">OnnxSub_7</span><span class="p">,</span> <span class="n">OnnxMul_7</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub_7&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul_7&#39;</span><span class="p">)</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub_7</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul_7</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                    <span class="n">target_opset</span><span class="o">=</span><span class="n">opset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">7</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>There is one unique opset per domain. The opsets associated to
the other domains can be specified as a dictionary.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="n">opset</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">OnnxSub_7</span><span class="p">,</span> <span class="n">OnnxMul_7</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub_7&#39;</span><span class="p">,</span> <span class="s1">&#39;Mul_7&#39;</span><span class="p">)</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub_7</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">OnnxMul_7</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                    <span class="n">target_opset</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">opset</span><span class="p">,</span> <span class="s1">&#39;ai.onnx.ml&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">onx</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">7</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">Mul</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">out_sub_0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_mul_0</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_mul_0&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
</pre></div>
</div>
<p>Usually, the code written with one opset is likely to run the same way
with the next one. However, the signature of an operator may change,
an attribute may become an input. The code has to be different according
to the opset, see for example function <a class="reference internal" href="../mlprodict/npy/xop_opset.html#mlprodict.npy.xop_opset.OnnxSqueezeApi11" title="mlprodict.npy.xop_opset.OnnxSqueezeApi11"><code class="xref py py-func docutils literal notranslate"><span class="pre">OnnxSqueezeApi11</span></code></a>.</p>
</section>
<section id="subgraphs">
<h2><a class="toc-backref" href="#id15">Subgraphs</a><a class="headerlink" href="#subgraphs" title="Permalink to this headline">¶</a></h2>
<p>Three operators hold graph attributes or subgraph:
<code class="xref py py-class docutils literal notranslate"><span class="pre">If</span></code>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">Loop</span></code>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">Scan</span></code>.
The first one executes one graph or another based on one condition.
The two others ones run loops. Those operators are not so easy
to deal with. Unittests may provide more examples
<a class="reference external" href="https://github.com/sdpython/mlprodict/blob/master/_unittests/ut_npy/test_xop.py">test_xop.py</a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.text_plot</span> <span class="kn">import</span> <span class="n">onnx_simple_text_plot</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop_variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.xop</span> <span class="kn">import</span> <span class="n">loadop</span>

<span class="p">(</span><span class="n">OnnxSub</span><span class="p">,</span> <span class="n">OnnxIdentity</span><span class="p">,</span> <span class="n">OnnxReduceSumSquare</span><span class="p">,</span> <span class="n">OnnxScan</span><span class="p">,</span>
 <span class="n">OnnxAdd</span><span class="p">)</span> <span class="o">=</span> <span class="n">loadop</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Identity&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ReduceSumSquare&#39;</span><span class="p">,</span> <span class="s1">&#39;Scan&#39;</span><span class="p">,</span> <span class="s1">&#39;Add&#39;</span><span class="p">)</span>

<span class="c1"># Building of the subgraph.</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><span class="s1">&#39;next_in&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">)</span>
<span class="n">id_next</span> <span class="o">=</span> <span class="n">OnnxIdentity</span><span class="p">(</span><span class="s1">&#39;next_in&#39;</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;next_out&#39;</span><span class="p">])</span>
<span class="n">flat</span> <span class="o">=</span> <span class="n">OnnxReduceSumSquare</span><span class="p">(</span>
    <span class="n">diff</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scan_out&#39;</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scan_body</span> <span class="o">=</span> <span class="n">id_next</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span>
    <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;next_in&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
     <span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">))],</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;next_out&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
             <span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;scan_out&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">))],</span>
    <span class="n">other_outputs</span><span class="o">=</span><span class="p">[</span><span class="n">flat</span><span class="p">])</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">scan_body</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>

<span class="n">cop</span> <span class="o">=</span> <span class="n">OnnxAdd</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>

<span class="c1"># Subgraph as a graph attribute.</span>
<span class="n">node</span> <span class="o">=</span> <span class="n">OnnxScan</span><span class="p">(</span><span class="n">cop</span><span class="p">,</span> <span class="n">cop</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">],</span>
                <span class="n">num_scan_inputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="p">(</span><span class="n">scan_body</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="p">[</span><span class="n">id_next</span><span class="p">,</span> <span class="n">flat</span><span class="p">]))</span>

<span class="n">cop2</span> <span class="o">=</span> <span class="n">OnnxIdentity</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cdist&#39;</span><span class="p">])</span>

<span class="n">model_def</span> <span class="o">=</span> <span class="n">cop2</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-- Graph:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_simple_text_plot</span><span class="p">(</span><span class="n">model_def</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">{</span><span class="s1">&#39;cdist&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([[</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">72.</span><span class="p">,</span> <span class="mf">80.</span><span class="p">],</span>
           <span class="p">[</span><span class="mf">72.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">],</span>
           <span class="p">[</span><span class="mf">80.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)}</span>
    
    <span class="o">--</span> <span class="n">Graph</span><span class="p">:</span>
    <span class="n">opset</span><span class="p">:</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">version</span><span class="o">=</span><span class="mi">16</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="n">Add</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_add_0</span>
      <span class="n">Scan</span><span class="p">(</span><span class="n">out_add_0</span><span class="p">,</span> <span class="n">out_add_0</span><span class="p">,</span> <span class="n">num_scan_inputs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">S1</span><span class="p">,</span> <span class="n">cdist</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cdist&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">()</span>
    <span class="o">-----</span> <span class="n">subgraph</span> <span class="o">----</span> <span class="n">Scan</span> <span class="o">-</span> <span class="n">_scan</span> <span class="o">-</span> <span class="n">att</span><span class="o">.</span><span class="n">body</span><span class="o">=</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;next_in&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;next&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="n">Identity</span><span class="p">(</span><span class="n">next_in</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">next_out</span>
    <span class="n">Sub</span><span class="p">(</span><span class="n">next_in</span><span class="p">,</span> <span class="nb">next</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out_sub_0</span>
      <span class="n">ReduceSumSquare</span><span class="p">(</span><span class="n">out_sub_0</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scan_out</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;next_out&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;scan_out&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
</pre></div>
</div>
<p>And visually:</p>

    <div id="gdot-140513856580336-cont"><div id="gdot-140513856580336" style="width:100%;height:100%;"></div>
    <script>

    require(['../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  nodesep=0.05;\n  ranksep=0.25;\n  size=7;\n  orientation=portrait;\n\n  input [shape=box color=red label=\"input\\nfloat(('?',))\" fontsize=10];\n\n  cdist [shape=box color=green label=\"cdist\\nfloat(('?',))\" fontsize=10];\n\n\n  out_add_0 [shape=box label=\"out_add_0\" fontsize=10];\n  _add [shape=box style=\"filled,rounded\" color=orange label=\"Add\\n(_add)\" fontsize=10];\n  input -> _add;\n  input -> _add;\n  _add -> out_add_0;\n\n  S1 [shape=box label=\"S1\" fontsize=10];\n  subgraph cluster_Scan140518476161088_140521948596912 {\n    label=\"Scan\\n(_scan)\\nbody=node {\\n  input: 'next_in'...\\nnum_scan_inputs=1\";\n    fontsize=10;\n    color=black;\n    B_next_in [shape=box color=red label=\"next_in\\nfloat((0, 0))\" fontsize=10];\n    B_next [shape=box color=red label=\"next\\nfloat((0,))\" fontsize=10];\n  \n    B_next_out [shape=box color=green label=\"next_out\\nfloat((0, 0))\" fontsize=10];\n    B_scan_out [shape=box color=green label=\"scan_out\\nfloat((0,))\" fontsize=10];\n  \n  \n    B_out_sub_0 [shape=box label=\"out_sub_0\" fontsize=10];\n    B__sub [shape=box style=\"filled,rounded\" color=orange label=\"Sub\\n(_sub)\" fontsize=10];\n    B_next_in -> B__sub;\n    B_next -> B__sub;\n    B__sub -> B_out_sub_0;\n  \n    B__reducesumsquare [shape=box style=\"filled,rounded\" color=orange label=\"ReduceSumSquare\\n(_reducesumsquare)\\naxes=[1]\\nkeepdims=0\" fontsize=10];\n    B_out_sub_0 -> B__reducesumsquare;\n    B__reducesumsquare -> B_scan_out;\n  \n    B__identity [shape=box style=\"filled,rounded\" color=orange label=\"Identity\\n(_identity)\" fontsize=10];\n    B_next_in -> B__identity;\n    B__identity -> B_next_out;\n  }\n  out_add_0 -> B_next_in;\n  out_add_0 -> B_next;\n  B_next_out -> S1;\n  B_scan_out -> cdist;\n  _scan -> B__sub [lhead=cluster_Scan140518476161088_140521948596912];\n  out_add_0 -> _scan;\n  out_add_0 -> _scan;\n  _scan -> S1;\n  _scan -> cdist;\n}\n");
    document.getElementById('gdot-140513856580336').innerHTML = svgGraph; });
    
</script>
</div></section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="numpy_api_onnx.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Numpy to ONNX: Create ONNX graphs with an API similar to numpy</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="ex_python.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Export ONNX into Python</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>