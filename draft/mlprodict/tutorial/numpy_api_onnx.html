
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Numpy to ONNX: Create ONNX graphs with an API similar to numpy &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Xop API" href="xop_api.html" />
    <link rel="prev" title="Create custom ONNX graphs with AST" href="onnx_numpy.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, â€¦
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gyexamples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_runtime.html">
   Execute ONNX graphs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="optim.html">
   Converters with options
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="benchmark.html">
   Benchmarks
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="skl.html">
   From scikit-learn to ONNX
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="onnx_numpy.html">
   Create custom ONNX graphs with AST
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Numpy to ONNX: Create ONNX graphs with an API similar to numpy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="xop_api.html">
   Xop API
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="ex_python.html">
   Export ONNX into Python
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#principle">
   Principle
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#available-functions">
   Available functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#functiontransformer">
   FunctionTransformer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#custom-predictor-or-transformer">
   Custom Predictor or Transformer
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-classifier">
     Custom Classifier
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-transformer">
     Custom Transformer
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-options">
   More options
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-onnxruntime-as-onnx-runtime">
     Use onnxruntime as ONNX runtime
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-a-specific-onnx-opset">
     Use a specific ONNX opset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#same-implementation-for-float32-and-float64">
     Same implementation for float32 and float64
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-convert-inplace-modifications">
   How to convert inplace modifications
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-errors">
   Common errors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#missing-wrapper">
     Missing wrapper
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#missing-annotation">
     Missing annotation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#type-mismatch">
     Type mismatch
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shape-mismatch">
     Shape mismatch
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#missing-converter">
     Missing converter
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#issue-when-an-estimator-is-called-by-another-one">
     Issue when an estimator is called by another one
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#typeerror-unsupported-operand-type-s-for-or-pow-float-and-onnxvar">
     TypeError: unsupported operand type(s) for ** or pow(): â€˜floatâ€™ and â€˜OnnxVarâ€™
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="numpy-to-onnx-create-onnx-graphs-with-an-api-similar-to-numpy">
<span id="l-numpy-api-for-onnx"></span><h1>Numpy to ONNX: Create ONNX graphs with an API similar to numpy<a class="headerlink" href="#numpy-to-onnx-create-onnx-graphs-with-an-api-similar-to-numpy" title="Permalink to this headline">#</a></h1>
<p>Many people came accross the task of converting a pipeline
including a custom preprocessing embedded into a
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/preprocessing.FunctionTransformer.html">sklearn.preprocessing.FunctionTransformer</a>.
<a class="reference external" href="https://github.com/onnx/sklearn-onnx">sklearn-onnx</a> implements many converters. Their task
is to create an ONNX graph for every <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>
model included in a pipeline. Every converter is a new implementation
of methods <cite>predict</cite>, <cite>predict_proba</cite> or <cite>transform</cite> with
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX Operators</a>. But that does not include custom function.
Writing a converter can be quite verbose and requires to know
the <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX Operators</a>, similar to <a class="reference external" href="https://www.numpy.org/">numpy</a> but not
the same.</p>
<p>The goal here is to make it easier for users and have their custom
function converted in ONNX.
Everybody playing with <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> knows <a class="reference external" href="https://www.numpy.org/">numpy</a>
then it should be possible to write a function using <a class="reference external" href="https://www.numpy.org/">numpy</a>
and automatically have it converted into <a class="reference external" href="https://onnx.ai/">ONNX</a>.
This tutorial focuses more on the implementation of custom
transformer for <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>. Notebook
<a class="reference internal" href="../notebooks/loss_functions.html#lossfunctionsrst"><span class="std std-ref">Loss function in ONNX</span></a> focuses on the implementation of
loss functions to train machine learned models.</p>
<p>This API was first added to <em>mlprodict</em> in version 0.6.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#principle" id="id1">Principle</a></p></li>
<li><p><a class="reference internal" href="#available-functions" id="id2">Available functions</a></p></li>
<li><p><a class="reference internal" href="#functiontransformer" id="id3">FunctionTransformer</a></p></li>
<li><p><a class="reference internal" href="#custom-predictor-or-transformer" id="id4">Custom Predictor or Transformer</a></p>
<ul>
<li><p><a class="reference internal" href="#custom-classifier" id="id5">Custom Classifier</a></p></li>
<li><p><a class="reference internal" href="#custom-transformer" id="id6">Custom Transformer</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#more-options" id="id7">More options</a></p>
<ul>
<li><p><a class="reference internal" href="#use-onnxruntime-as-onnx-runtime" id="id8">Use onnxruntime as ONNX runtime</a></p></li>
<li><p><a class="reference internal" href="#use-a-specific-onnx-opset" id="id9">Use a specific ONNX opset</a></p></li>
<li><p><a class="reference internal" href="#same-implementation-for-float32-and-float64" id="id10">Same implementation for float32 and float64</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-convert-inplace-modifications" id="id11">How to convert inplace modifications</a></p></li>
<li><p><a class="reference internal" href="#common-errors" id="id12">Common errors</a></p>
<ul>
<li><p><a class="reference internal" href="#missing-wrapper" id="id13">Missing wrapper</a></p></li>
<li><p><a class="reference internal" href="#missing-annotation" id="id14">Missing annotation</a></p></li>
<li><p><a class="reference internal" href="#type-mismatch" id="id15">Type mismatch</a></p></li>
<li><p><a class="reference internal" href="#shape-mismatch" id="id16">Shape mismatch</a></p></li>
<li><p><a class="reference internal" href="#missing-converter" id="id17">Missing converter</a></p></li>
<li><p><a class="reference internal" href="#issue-when-an-estimator-is-called-by-another-one" id="id18">Issue when an estimator is called by another one</a></p></li>
<li><p><a class="reference internal" href="#typeerror-unsupported-operand-type-s-for-or-pow-float-and-onnxvar" id="id19">TypeError: unsupported operand type(s) for ** or pow(): â€˜floatâ€™ and â€˜OnnxVarâ€™</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Available notebooks:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../notebooks/numpy_api_onnx_ftr.html#numpyapionnxftrrst"><span class="std std-ref">Introduction to a numpy API for ONNX: FunctionTransformer</span></a></p></li>
<li><p><a class="reference internal" href="../notebooks/numpy_api_onnx_ccl.html#numpyapionnxcclrst"><span class="std std-ref">Introduction to a numpy API for ONNX: CustomClassifier</span></a></p></li>
</ul>
<section id="principle">
<h2><a class="toc-backref" href="#id1">Principle</a><a class="headerlink" href="#principle" title="Permalink to this headline">#</a></h2>
<p>The user writes a function using <a class="reference external" href="https://www.numpy.org/">numpy</a> function but
behind the scene, it uses an <a class="reference external" href="https://onnx.ai/">ONNX</a> runtime to execute
the function. To do that, this package reimplements many
<a class="reference external" href="https://www.numpy.org/">numpy</a> functions using <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX Operators</a>. It looks
like <a class="reference external" href="https://www.numpy.org/">numpy</a> but it uses <a class="reference external" href="https://onnx.ai/">ONNX</a>.
Following example shows how to replace <em>numpy</em> by <em>ONNX</em>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>

<span class="c1"># The numpy function</span>


<span class="k">def</span> <span class="nf">log_1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># The ONNX function</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;onnx&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">numpy</span>
    <span class="p">[[</span><span class="mf">0.661</span> <span class="mf">0.268</span> <span class="mf">0.412</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.495</span> <span class="mf">0.171</span> <span class="mf">0.598</span><span class="p">]]</span>
    <span class="n">onnx</span>
    <span class="p">[[</span><span class="mf">0.661</span> <span class="mf">0.268</span> <span class="mf">0.412</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.495</span> <span class="mf">0.171</span> <span class="mf">0.598</span><span class="p">]]</span>
</pre></div>
</div>
<p>ONNX runtimes are usually more strict about types than <a class="reference external" href="https://www.numpy.org/">numpy</a>
(see <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime</a>).
A function must be implemented for the same input type
and there is not implicit cast. There are three important elements
in this example:</p>
<ul class="simple">
<li><p>Decorator <a class="reference internal" href="../mlprodict/npy/onnx_numpy_wrapper.html#mlprodict.npy.onnx_numpy_wrapper.onnxnumpy_default" title="mlprodict.npy.onnx_numpy_wrapper.onnxnumpy_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">onnxnumpy_default</span></code></a>:
it parses the annotations, creates the ONNX graph and initialize a runtime with it.</p></li>
<li><p>Annotation: every input and output types must be specified. They are <a class="reference internal" href="../mlprodict/npy/onnx_numpy_annotation.html#mlprodict.npy.onnx_numpy_annotation.NDArray" title="mlprodict.npy.onnx_numpy_annotation.NDArray"><code class="xref py py-class docutils literal notranslate"><span class="pre">NDArray</span></code></a>, shape can be left undefined by element
type must be precised.</p></li>
<li><p>Types: <cite>1</cite> is different than <cite>np.float32(1)</cite>, the right type must be used.</p></li>
</ul>
<p><cite>onnx_log_1</cite> is not a function but an instance of class
<a class="reference internal" href="../mlprodict/npy/onnx_numpy_wrapper.html#mlprodict.npy.onnx_numpy_wrapper.wrapper_onnxnumpy" title="mlprodict.npy.onnx_numpy_wrapper.wrapper_onnxnumpy"><code class="xref py py-class docutils literal notranslate"><span class="pre">wrapper_onnxnumpy</span></code></a>.
This class implements method <cite>__call__</cite> to behave like a function
and holds an attribute of type
<a class="reference internal" href="../mlprodict/npy/onnx_numpy_compiler.html#mlprodict.npy.onnx_numpy_compiler.OnnxNumpyCompiler" title="mlprodict.npy.onnx_numpy_compiler.OnnxNumpyCompiler"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxNumpyCompiler</span></code></a>.
This class contains an ONNX graph and a instance of a runtime.
The following lines lists some usefull attributes.</p>
<ul class="simple">
<li><p><cite>onnx_log_1</cite>: <a class="reference internal" href="../mlprodict/npy/onnx_numpy_wrapper.html#mlprodict.npy.onnx_numpy_wrapper.wrapper_onnxnumpy" title="mlprodict.npy.onnx_numpy_wrapper.wrapper_onnxnumpy"><code class="xref py py-class docutils literal notranslate"><span class="pre">wrapper_onnxnumpy</span></code></a></p></li>
<li><p><cite>onnx_log_1.compiled</cite>: <a class="reference internal" href="../mlprodict/npy/onnx_numpy_compiler.html#mlprodict.npy.onnx_numpy_compiler.OnnxNumpyCompiler" title="mlprodict.npy.onnx_numpy_compiler.OnnxNumpyCompiler"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxNumpyCompiler</span></code></a></p></li>
<li><p><cite>onnx_log_1.compiled.onnx_</cite>: ONNX graph</p></li>
<li><p><cite>onnx_log_1.compiled.rt_fct_.rt</cite>: runtime, by default
<a class="reference internal" href="../mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxInference</span></code></a></p></li>
</ul>
<p>The ONNX graph <cite>onnx_log_1.compiled.onnx_</cite> looks like this:</p>

    <div id="gdot-139922718490784-cont"><div id="gdot-139922718490784" style="width:100%;height:100%;"></div>
    <script>

    require(['../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  size=7;\n  ranksep=0.25;\n  nodesep=0.05;\n  orientation=portrait;\n\n  x [shape=box color=red label=\"x\\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\\nfloat32((1,))\\n[1.]\" fontsize=10];\n\n  out_add_0 [shape=box label=\"out_add_0\" fontsize=10];\n  _add [shape=box style=\"filled,rounded\" color=orange label=\"Add\\n(_add)\" fontsize=10];\n  x -> _add;\n  init -> _add;\n  _add -> out_add_0;\n\n  _log [shape=box style=\"filled,rounded\" color=orange label=\"Log\\n(_log)\" fontsize=10];\n  out_add_0 -> _log;\n  _log -> y;\n}\n");
    document.getElementById('gdot-139922718490784').innerHTML = svgGraph; });
    
</script>
</div><p>There is a fundamental different between <a class="reference external" href="https://www.numpy.org/">numpy</a> and
<a class="reference external" href="https://onnx.ai/">ONNX</a>. <a class="reference external" href="https://www.numpy.org/">numpy</a> allows inplace modifications.
The simple instruction <code class="docutils literal notranslate"><span class="pre">m[:,</span> <span class="pre">0]</span> <span class="pre">=</span> <span class="pre">1</span></code> modifies an entire column
of an existing array. <a class="reference external" href="https://onnx.ai/">ONNX</a> does not allow that, even if the
same operator can be achieved, the result is a new array.
See section <a class="reference internal" href="#l-inplace-modification-onnx"><span class="std std-ref">How to convert inplace modifications</span></a> for more
details. This API intends to be easy to use than the current
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/PythonAPIOverview.md">ONNX API</a>
or the other introduced in <a class="reference external" href="https://onnx.ai/sklearn-onnx/auto_tutorial/plot_icustom_converter.html">skl2onnx</a>
which looks like this:</p>

    <div id="gdot-139922729424928-cont"><div id="gdot-139922729424928" style="width:100%;height:100%;"></div>
    <script>

    require(['../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  orientation=portrait;\n  ranksep=0.25;\n  nodesep=0.05;\n  size=7;\n\n  X [shape=box color=red label=\"X\\nfloat((0, 3))\" fontsize=10];\n\n  Y [shape=box color=green label=\"Y\\nfloat(('?',))\" fontsize=10];\n\n  Sl_Slicecst [shape=box label=\"Sl_Slicecst\\nint64((1,))\\n[0]\" fontsize=10];\n  Sl_Slicecst1 [shape=box label=\"Sl_Slicecst1\\nint64((1,))\\n[1]\" fontsize=10];\n\n  Sl_output0 [shape=box label=\"Sl_output0\" fontsize=10];\n  Sl_Slice [shape=box style=\"filled,rounded\" color=orange label=\"Slice\\n(Sl_Slice)\" fontsize=10];\n  X -> Sl_Slice;\n  Sl_Slicecst -> Sl_Slice;\n  Sl_Slicecst1 -> Sl_Slice;\n  Sl_Slice -> Sl_output0;\n\n  Sq_Squeezecst [shape=box label=\"Sq_Squeezecst\" fontsize=10];\n  Sq_Squeezecst_op [shape=box style=\"filled,rounded\" color=orange label=\"Identity\\n(Sq_Squeezecst_op)\" fontsize=10];\n  Sl_Slicecst -> Sq_Squeezecst_op;\n  Sq_Squeezecst_op -> Sq_Squeezecst;\n\n  Sq_Squeeze [shape=box style=\"filled,rounded\" color=orange label=\"Squeeze\\n(Sq_Squeeze)\" fontsize=10];\n  Sl_output0 -> Sq_Squeeze;\n  Sq_Squeezecst -> Sq_Squeeze;\n  Sq_Squeeze -> Y;\n}\n");
    document.getElementById('gdot-139922729424928').innerHTML = svgGraph; });
    
</script>
</div><p>This API requires to know ONNX operators and an extra step to convert
code written with <a class="reference external" href="https://www.numpy.org/">numpy</a> into code written with ONNX operators.
Even though the operators are similar, signatures may be different.</p>
</section>
<section id="available-functions">
<h2><a class="toc-backref" href="#id2">Available functions</a><a class="headerlink" href="#available-functions" title="Permalink to this headline">#</a></h2>
<p>This tool does not implement every function of <a class="reference external" href="https://www.numpy.org/">numpy</a>.
This a work in progress. The list of supported functions is
available at <a class="reference internal" href="../mlprodict/npy/numpy_onnx_impl.html#f-numpyonnximpl"><span class="std std-ref">module npy.numpy_onnx_impl</span></a>.</p>
<p>Common operators <cite>+</cite>, <cite>-</cite>, <cite>/</cite>, <cite>*</cite>,  <cite>**</cite>, <cite>%</cite>, <cite>[]</cite> are
supported as well. They are implemented by class
<a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.OnnxVar" title="mlprodict.npy.onnx_variable.OnnxVar"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxVar</span></code></a>.
This class also implements methods such as <cite>astype</cite> or
properties such as <cite>shape</cite>, <cite>size</cite>, <cite>T</cite>.</p>
</section>
<section id="functiontransformer">
<h2><a class="toc-backref" href="#id3">FunctionTransformer</a><a class="headerlink" href="#functiontransformer" title="Permalink to this headline">#</a></h2>
<p>Now onnx was used to implement a custom function,
it needs to used by a <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/preprocessing.FunctionTransformer.html">sklearn.preprocessing.FunctionTransformer</a>.
One instance is added in a pipeline trained on the Iris dataset.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">),</span>
    <span class="n">StandardScaler</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">LogisticRegression</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zipmap&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]})[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[[</span><span class="mf">9.569e-01</span> <span class="mf">4.308e-02</span> <span class="mf">1.977e-07</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">6.215e-04</span> <span class="mf">3.500e-01</span> <span class="mf">6.494e-01</span><span class="p">]]</span>
    <span class="p">[[</span><span class="mf">9.569e-01</span> <span class="mf">4.308e-02</span> <span class="mf">1.977e-07</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">6.215e-04</span> <span class="mf">3.500e-01</span> <span class="mf">6.494e-01</span><span class="p">]]</span>
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">xgboost</span><span class="o">/</span><span class="n">compat</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Int64Index</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">pandas</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span><span class="o">.</span> <span class="n">Use</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">the</span> <span class="n">appropriate</span> <span class="n">dtype</span> <span class="n">instead</span><span class="o">.</span>
      <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">MultiIndex</span><span class="p">,</span> <span class="n">Int64Index</span>
</pre></div>
</div>
<p><em>ONNX</em> is still more strict than <em>numpy</em>. Some elements
must be added every time this is used:</p>
<ul class="simple">
<li><p>The custom function signature is using <em>float32</em>,
training and testing data are cast in <em>float32</em>.</p></li>
<li><p>The shape of <cite>onnx_log_1</cite> return was changed into
<cite>NDArray[(None, None), np.float32]</cite>. Otherwise the converter
for <em>StandardScaler</em> raised an exception (see
<a class="reference internal" href="#l-npy-shape-mismatch"><span class="std std-ref">Shape mismatch</span></a>).</p></li>
<li><p>Method <a class="reference internal" href="../mlprodict/onnx_conv/convert.html#mlprodict.onnx_conv.convert.to_onnx" title="mlprodict.onnx_conv.convert.to_onnx"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_onnx</span></code></a>
is called with parameter <cite>rewrite_ops=True</cite>. This parameter
tells the function to overwrite the converter for
<em>FunctionTransformer</em> by a new one which supports custom
functions implemented with this API (see
<a class="reference internal" href="#l-npy-missing-converter"><span class="std std-ref">Missing converter</span></a>).</p></li>
</ul>
</section>
<section id="custom-predictor-or-transformer">
<h2><a class="toc-backref" href="#id4">Custom Predictor or Transformer</a><a class="headerlink" href="#custom-predictor-or-transformer" title="Permalink to this headline">#</a></h2>
<p>Creating a custom predictor or transformer is not a common task
but still not too difficult with <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> API.
It becomes more difficult task when it comes to convert a
pipeline involving this new model into ONNX. It means writing
a custom converter or more simply to implement the inference
function with ONNX operators. It is difficult because ONNX
operators are close to <a class="reference external" href="https://www.numpy.org/">numpy</a> function but not exactly
the same plus testing an ONNX conversion requires to use
a runtime. That means more lines of code to just test.</p>
<section id="custom-classifier">
<h3><a class="toc-backref" href="#id5">Custom Classifier</a><a class="headerlink" href="#custom-classifier" title="Permalink to this headline">#</a></h3>
<p>The conversion of a classifier is more complex than a regressor
or a transformer because a classifier implements two methods,
<em>predict</em> for the labels, <em>predict_proba</em> for the probabilities.
Next example implements a weird classifier based on two logistic
regressions. It does not do anything with ONNX yet. This is taken
from notebook <a class="reference internal" href="../notebooks/numpy_api_onnx_ccl.html#numpyapionnxcclrst"><span class="std std-ref">Introduction to a numpy API for ONNX: CustomClassifier</span></a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_clusters_per_class</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hypercube</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TwoLogisticRegression</span><span class="p">(</span><span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ClassifierMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BaseEstimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;weighted sample not implemented in this example.&quot;</span><span class="p">)</span>

        <span class="c1"># Barycenters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()])</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centers_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># A vector orthogonal</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
        <span class="n">v</span> <span class="o">/=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">x</span> <span class="o">/=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperplan_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># sign</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperplan_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Trains models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr0_</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr1_</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_side</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">prob0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr0_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">prob1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr1_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">prob1</span> <span class="o">*</span> <span class="n">sign</span> <span class="o">-</span> <span class="n">prob0</span> <span class="o">*</span> <span class="p">(</span><span class="n">sign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_side</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperplan_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">TwoLogisticRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]),</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[[</span><span class="mf">0.955</span> <span class="mf">0.045</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.186</span> <span class="mf">0.814</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.127</span> <span class="mf">0.873</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.504</span> <span class="mf">0.496</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.242</span> <span class="mf">0.758</span><span class="p">]]</span>
</pre></div>
</div>
<p>Next step is to converter this classifier into ONNX. Instead of writing
a converter, the strategy is to implement methods <em>predict</em>
and <em>predict_proba</em> with ONNX instead of numpy. Thatâ€™s where
the numpy API for ONNX becomes handy, with some decorators
to simplifies manythings. Among them, the types. Python does
not really care about signed arguments but ONNX does.
As a result, if the predict method is used with <cite>float32</cite> and
<cite>float64</cite>, two ONNX graphs are created and executed with a runtime.
When method <em>predict</em> is called, the input type is detected and an ONNX
graph is generated. If the second call uses the same type, the same graph
is used. Letâ€™s see how to do it.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxsklearn_class</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.onnx_variable</span> <span class="kn">import</span> <span class="n">MultiOnnxVar</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">nxnp</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl_skl</span> <span class="k">as</span> <span class="nn">nxnpskl</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_clusters_per_class</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hypercube</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="nd">@onnxsklearn_class</span><span class="p">(</span><span class="s1">&#39;onnx_graph&#39;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># opset=13, 14, ...</span>
<span class="k">class</span> <span class="nc">TwoLogisticRegressionOnnx</span><span class="p">(</span><span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ClassifierMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BaseEstimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;weighted sample not implemented in this example.&quot;</span><span class="p">)</span>

        <span class="c1"># Barycenters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()])</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centers_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># A vector orthogonal</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
        <span class="n">v</span> <span class="o">/=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">x</span> <span class="o">/=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperplan_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># sign</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperplan_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Trains models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr0_</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr1_</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">onnx_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperplan_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">@</span> <span class="n">h</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">cast</span> <span class="o">=</span> <span class="n">sign</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Function logistic_regression is not a numpy function.</span>
        <span class="c1"># It calls the converter for a LogisticRegression</span>
        <span class="c1"># implemented in sklearn-onnx.</span>
        <span class="n">prob0</span> <span class="o">=</span> <span class="n">nxnpskl</span><span class="o">.</span><span class="n">logistic_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr0_</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prob1</span> <span class="o">=</span> <span class="n">nxnpskl</span><span class="o">.</span><span class="n">logistic_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr1_</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">prob1</span> <span class="o">*</span> <span class="n">cast</span> <span class="o">-</span> <span class="n">prob0</span> <span class="o">*</span> <span class="p">(</span><span class="n">cast</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">nxnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MultiOnnxVar</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">TwoLogisticRegressionOnnx</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]),</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]))</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># opset=13, 14, ...</span>
<span class="c1"># print(onx)  # too long to be displayed</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[[</span><span class="mf">0.044</span> <span class="mf">0.956</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.999</span> <span class="mf">0.001</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.929</span> <span class="mf">0.071</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.978</span> <span class="mf">0.022</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.104</span> <span class="mf">0.896</span><span class="p">]]</span>
</pre></div>
</div>
<p>The decorator <code class="docutils literal notranslate"><span class="pre">&#64;onnxsklearn_class('onnx_graph')</span></code>
(see <a class="reference internal" href="../mlprodict/npy/onnx_sklearn_wrapper.html#mlprodict.npy.onnx_sklearn_wrapper.onnxsklearn_class" title="mlprodict.npy.onnx_sklearn_wrapper.onnxsklearn_class"><code class="xref py py-func docutils literal notranslate"><span class="pre">onnxsklearn_class</span></code></a>)
declares method <em>onnx_graph</em> as the method which creates
the ONNX graph. In a classifier case,
it returns two outputs, label and probabilites assembled within an instance of
<a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.MultiOnnxVar" title="mlprodict.npy.onnx_variable.MultiOnnxVar"><code class="xref py py-class docutils literal notranslate"><span class="pre">MultiOnnxVar</span></code></a>. The decorator
detects the class is a classifier (<cite>ClassifierMixin</cite>) and linked the
two outputs to the two methods <em>predict</em> and <em>predict_proba</em>, in that order.
When one of them is called, it follows the steps:</p>
<ul class="simple">
<li><p>Detects input type,</p></li>
<li><p>Detects if an ONNX graph was generated for this type</p></li>
<li><p>Generates the ONNX graph if it does not exist</p></li>
<li><p>Create an instance with a runtime if it does not exist</p></li>
<li><p>Returns the output of the runtime</p></li>
</ul>
<p>The instruction <code class="docutils literal notranslate"><span class="pre">to_onnx(model,</span> <span class="pre">X_test[:5],</span> <span class="pre">target_opset=?)</span></code> creates
an ONNX graph by calling method <em>onnx_graph</em> registered as a converter
in <em>skl2onnx</em>. It is equivalent to something like
<code class="docutils literal notranslate"><span class="pre">model.onnx_graph(X_test[:5]).to_algebra()[0].to_onnx({'X':</span> <span class="pre">X})</span></code>.</p>
<p>The implementation of method <em>onnx_graph</em> relies on numpy function
implemented with ONNX operator from submodule <a class="reference internal" href="../mlprodict/npy/numpy_onnx_impl.html#f-numpyonnximpl"><span class="std std-ref">module npy.numpy_onnx_impl</span></a>
and converters for scikit-learn models wrapped into functions
from submodule <a class="reference internal" href="../mlprodict/npy/numpy_onnx_impl_skl.html#f-numpyonnximplskl"><span class="std std-ref">module npy.numpy_onnx_impl_skl</span></a>.</p>
</section>
<section id="custom-transformer">
<h3><a class="toc-backref" href="#id6">Custom Transformer</a><a class="headerlink" href="#custom-transformer" title="Permalink to this headline">#</a></h3>
<p>The syntax is the same. The decorator
<code class="docutils literal notranslate"><span class="pre">&#64;onnxsklearn_class(&quot;onnx_transform&quot;,</span> <span class="pre">op_version=?)</span></code> detects
the class is a transformer and automatically adds method
<em>transform</em>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">TransformerMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxsklearn_class</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">nxnp</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl_skl</span> <span class="k">as</span> <span class="nn">nxnpskl</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_clusters_per_class</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hypercube</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="nd">@onnxsklearn_class</span><span class="p">(</span><span class="s2">&quot;onnx_transform&quot;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># opset=13, 14, ...</span>
<span class="k">class</span> <span class="nc">DecorrelateTransformerOnnx</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="n">BaseEstimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">TransformerMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># pylint: disable=W0201</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">onnx_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;X.dtype cannot be None.&quot;</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_</span><span class="o">.</span><span class="n">mean_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">cmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">@</span> <span class="n">cmp</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">DecorrelateTransformerOnnx</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]))</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># opset=13, 14, ...</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[[</span> <span class="mf">0.262</span> <span class="o">-</span><span class="mf">0.44</span> <span class="p">]</span>
     <span class="p">[</span> <span class="mf">0.418</span>  <span class="mf">1.311</span><span class="p">]</span>
     <span class="p">[</span> <span class="mf">0.512</span>  <span class="mf">1.3</span>  <span class="p">]</span>
     <span class="p">[</span><span class="o">-</span><span class="mf">0.599</span> <span class="o">-</span><span class="mf">1.291</span><span class="p">]</span>
     <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span>  <span class="o">-</span><span class="mf">0.296</span><span class="p">]]</span>
    <span class="n">ir_version</span><span class="p">:</span> <span class="mi">7</span>
    <span class="n">producer_name</span><span class="p">:</span> <span class="s2">&quot;skl2onnx&quot;</span>
    <span class="n">producer_version</span><span class="p">:</span> <span class="s2">&quot;1.11.1&quot;</span>
    <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;ai.onnx&quot;</span>
    <span class="n">model_version</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">doc_string</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="n">graph</span> <span class="p">{</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;init&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;out_sub_0&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;_sub__sub&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Sub&quot;</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;out_sub_0&quot;</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;init_1&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;variable1&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;_sub__matmul&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;MatMul&quot;</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="p">}</span>
      <span class="n">node</span> <span class="p">{</span>
        <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;variable1&quot;</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;variable&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;_sub_variable&quot;</span>
        <span class="n">op_type</span><span class="p">:</span> <span class="s2">&quot;Identity&quot;</span>
        <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="p">}</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;mlprodict_ONNX(DecorrelateTransformerOnnx)&quot;</span>
      <span class="n">initializer</span> <span class="p">{</span>
        <span class="n">dims</span><span class="p">:</span> <span class="mi">2</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="mi">11</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;init&quot;</span>
        <span class="n">raw_data</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\000</span><span class="s2">.</span><span class="se">\206</span><span class="s2">9</span><span class="se">\250\025\250\277\324\220\247</span><span class="s2">s3</span><span class="se">\037\271</span><span class="s2">?&quot;</span>
      <span class="p">}</span>
      <span class="n">initializer</span> <span class="p">{</span>
        <span class="n">dims</span><span class="p">:</span> <span class="mi">2</span>
        <span class="n">dims</span><span class="p">:</span> <span class="mi">2</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="mi">11</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;init_1&quot;</span>
        <span class="n">raw_data</span><span class="p">:</span> <span class="s2">&quot;D</span><span class="se">\231\227\273</span><span class="s2">%</span><span class="se">\321\214</span><span class="s2">?y</span><span class="se">\225\226</span><span class="s2">b0</span><span class="se">\377\357\277</span><span class="s2">y</span><span class="se">\225\226</span><span class="s2">b0</span><span class="se">\377\357</span><span class="s2">?D</span><span class="se">\231\227\273</span><span class="s2">%</span><span class="se">\321\214</span><span class="s2">?&quot;</span>
      <span class="p">}</span>
      <span class="nb">input</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">11</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
                <span class="n">dim_value</span><span class="p">:</span> <span class="mi">2</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">output</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;variable&quot;</span>
        <span class="nb">type</span> <span class="p">{</span>
          <span class="n">tensor_type</span> <span class="p">{</span>
            <span class="n">elem_type</span><span class="p">:</span> <span class="mi">11</span>
            <span class="n">shape</span> <span class="p">{</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">dim</span> <span class="p">{</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">opset_import</span> <span class="p">{</span>
      <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
      <span class="n">version</span><span class="p">:</span> <span class="mi">14</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="more-options">
<h2><a class="toc-backref" href="#id7">More options</a><a class="headerlink" href="#more-options" title="Permalink to this headline">#</a></h2>
<section id="use-onnxruntime-as-onnx-runtime">
<h3><a class="toc-backref" href="#id8">Use onnxruntime as ONNX runtime</a><a class="headerlink" href="#use-onnxruntime-as-onnx-runtime" title="Permalink to this headline">#</a></h3>
<p>By default, the ONNX graph is executed by the Python runtime
implemented in this module (see <a class="reference internal" href="onnx_runtime.html#l-onnx-python-runtime"><span class="std std-ref">Python Runtime for ONNX</span></a>).
It is a mix of <a class="reference external" href="https://www.numpy.org/">numpy</a> and C++ implementations and it does
not require any new dependency. However, it is possible to use
a different one like <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime</a> which has an implementation
for more <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX Operators</a>. The only change is a wrapper
with arguments <a class="reference internal" href="../mlprodict/npy/onnx_numpy_wrapper.html#mlprodict.npy.onnx_numpy_wrapper.onnxnumpy_np" title="mlprodict.npy.onnx_numpy_wrapper.onnxnumpy_np"><code class="xref py py-class docutils literal notranslate"><span class="pre">onnxnumpy_np</span></code></a>:
<cite>&#64;onnxnumpy_np(runtime=â€™onnxruntimeâ€™)</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_np</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>


<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">),</span>
    <span class="n">StandardScaler</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">LogisticRegression</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zipmap&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>

<span class="n">oinf</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]})[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[[</span><span class="mf">9.722e-01</span> <span class="mf">2.775e-02</span> <span class="mf">2.494e-07</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">9.850e-01</span> <span class="mf">1.501e-02</span> <span class="mf">9.336e-08</span><span class="p">]]</span>
    <span class="p">[[</span><span class="mf">9.722e-01</span> <span class="mf">2.775e-02</span> <span class="mf">2.494e-07</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">9.850e-01</span> <span class="mf">1.501e-02</span> <span class="mf">9.336e-08</span><span class="p">]]</span>
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">xgboost</span><span class="o">/</span><span class="n">compat</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Int64Index</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">pandas</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span><span class="o">.</span> <span class="n">Use</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">the</span> <span class="n">appropriate</span> <span class="n">dtype</span> <span class="n">instead</span><span class="o">.</span>
      <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">MultiIndex</span><span class="p">,</span> <span class="n">Int64Index</span>
</pre></div>
</div>
</section>
<section id="use-a-specific-onnx-opset">
<h3><a class="toc-backref" href="#id9">Use a specific ONNX opset</a><a class="headerlink" href="#use-a-specific-onnx-opset" title="Permalink to this headline">#</a></h3>
<p>By default, the ONNX graph generated by the wrapper is using
the latest version of ONNX but it is possible to use an older one
if the involved runtime does not implement the latest version.
The desired opset must be specified in two places,
the first time as an argument of <cite>onnxnumpy_np</cite>, the second time
as an argument of <cite>to_onnx</cite>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_np</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>

<span class="n">target_opset</span> <span class="o">=</span> <span class="mi">11</span>


<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">op_version</span><span class="o">=</span><span class="n">target_opset</span><span class="p">)</span>  <span class="c1"># first place</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">),</span>
    <span class="n">StandardScaler</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">LogisticRegression</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zipmap&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>
              <span class="n">target_opset</span><span class="o">=</span><span class="n">target_opset</span><span class="p">)</span>  <span class="c1"># second place</span>

<span class="n">oinf</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]})[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[[</span><span class="mf">9.752e-01</span> <span class="mf">2.475e-02</span> <span class="mf">1.282e-07</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">9.790e-01</span> <span class="mf">2.096e-02</span> <span class="mf">6.769e-07</span><span class="p">]]</span>
    <span class="p">[[</span><span class="mf">9.752e-01</span> <span class="mf">2.475e-02</span> <span class="mf">1.282e-07</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">9.790e-01</span> <span class="mf">2.096e-02</span> <span class="mf">6.769e-07</span><span class="p">]]</span>
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">xgboost</span><span class="o">/</span><span class="n">compat</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Int64Index</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">pandas</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span><span class="o">.</span> <span class="n">Use</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">the</span> <span class="n">appropriate</span> <span class="n">dtype</span> <span class="n">instead</span><span class="o">.</span>
      <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">MultiIndex</span><span class="p">,</span> <span class="n">Int64Index</span>
</pre></div>
</div>
</section>
<section id="same-implementation-for-float32-and-float64">
<h3><a class="toc-backref" href="#id10">Same implementation for float32 and float64</a><a class="headerlink" href="#same-implementation-for-float32-and-float64" title="Permalink to this headline">#</a></h3>
<p>Only one input type is allowed by default but there is a way
to define a function supporting more than one type with
<a class="reference internal" href="../mlprodict/npy/onnx_numpy_annotation.html#mlprodict.npy.onnx_numpy_annotation.NDArrayType" title="mlprodict.npy.onnx_numpy_annotation.NDArrayType"><code class="xref py py-class docutils literal notranslate"><span class="pre">NDArrayType</span></code></a>.
When calling function <cite>onnx_log_1</cite>, inputs are detected,
an ONNX graph is generated and executed. Next time the same function
is called, if the input types are the same as before, it reuses the same
ONNX graph and same runtime. Otherwise, it generates a new
ONNX graph taking this new type as input. The expression
<cite>x.dtype</cite> returns the type of this input in order to cast
the constant <cite>1</cite> into the right type before being used by
another operator.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_np</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy.onnx_numpy_annotation</span> <span class="kn">import</span> <span class="n">NDArrayType</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>


<span class="nd">@onnxnumpy_np</span><span class="p">(</span><span class="n">signature</span><span class="o">=</span><span class="n">NDArrayType</span><span class="p">(</span><span class="s1">&#39;floats&#39;</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">float32</span> <span class="p">[[</span><span class="mf">0.688</span> <span class="mf">0.285</span> <span class="mf">0.588</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.271</span> <span class="mf">0.446</span> <span class="mf">0.039</span><span class="p">]]</span>
    <span class="n">float64</span> <span class="p">[[</span><span class="mf">0.688</span> <span class="mf">0.285</span> <span class="mf">0.588</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.271</span> <span class="mf">0.446</span> <span class="mf">0.039</span><span class="p">]]</span>
</pre></div>
</div>
<p>There are more options to it. Many of them are used in
<a class="reference internal" href="../mlprodict/npy/numpy_onnx_pyrt.html#f-numpyonnxpyrt"><span class="std std-ref">module npy.numpy_onnx_pyrt</span></a>. It is possible to add arguments
with default values or undefined number of inputs. One
important detail though, a different value for an argument
(not an input) means the ONNX graph has to be different because
this value is stored in the graph instead of being an input.
Everytime an input type or an argument is different, a new ONNX
graph is generated and executed.</p>
</section>
</section>
<section id="how-to-convert-inplace-modifications">
<span id="l-inplace-modification-onnx"></span><h2><a class="toc-backref" href="#id11">How to convert inplace modifications</a><a class="headerlink" href="#how-to-convert-inplace-modifications" title="Permalink to this headline">#</a></h2>
<p>As mentioned earlier, there is no way to modify a tensor inplace.
Every modification implies a copy. A modification can be done
by creating a new tensor concatenated from other tensors or by using
operators <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#ScatterElements">Op.ScatterElements</a> or <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#ScatterND">Op.ScatterND</a>.
Instruction <code class="docutils literal notranslate"><span class="pre">v[5]</span> <span class="pre">=</span> <span class="pre">3.5</span></code> is correct with numpy. Class <a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.OnnxVar" title="mlprodict.npy.onnx_variable.OnnxVar"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxVar</span></code></a> replaces that instruction
with operator <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#ScatterElements">Op.ScatterElements</a>.</p>
<p>Operator <cite>[] (__setitem__)</cite> must return the instance itself (<cite>self</cite>).
Thatâ€™s why the design is different from the other methods. Instead of
returning a new instance of <a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.OnnxVar" title="mlprodict.npy.onnx_variable.OnnxVar"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxVar</span></code></a>, it replaces the only input.
However, that require the operator <cite>[]</cite> to follow a copy.
<code class="docutils literal notranslate"><span class="pre">v[5]</span> <span class="pre">=</span> <span class="pre">3.5</span></code> may not be valid but <code class="docutils literal notranslate"><span class="pre">v</span> <span class="pre">=</span> <span class="pre">v.copy();</span> <span class="pre">v[5]</span> <span class="pre">=</span> <span class="pre">3.5</span></code> always is.
Current implementation only supports one dimensional tensor.
Operators <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#ScatterElements">Op.ScatterElements</a> or <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#ScatterND">Op.ScatterND</a> are not
really meant to change only one element but to change many of them.</p>

    <div id="gdot-139922714607728-cont"><div id="gdot-139922714607728" style="width:100%;height:100%;"></div>
    <script>

    require(['../_static/viz.js'], function() { var svgGraph = Viz(" digraph{\n  nodesep=0.05;\n  size=7;\n  ranksep=0.25;\n  orientation=portrait;\n\n  x [shape=box color=red label=\"x\\nfloat(('?',))\" fontsize=10];\n\n  y [shape=box color=green label=\"y\\nfloat(('?',))\" fontsize=10];\n\n  init [shape=box label=\"init\\nint64((1,))\\n[-1]\" fontsize=10];\n  init_1 [shape=box label=\"init_1\\nint64((1,))\\n[4]\" fontsize=10];\n  init_2 [shape=box label=\"init_2\\nfloat32((1,))\\n[5.]\" fontsize=10];\n\n  out_res_0 [shape=box label=\"out_res_0\" fontsize=10];\n  _reshape [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\\n(_reshape)\" fontsize=10];\n  x -> _reshape;\n  init -> _reshape;\n  _reshape -> out_res_0;\n\n  out_sca_0 [shape=box label=\"out_sca_0\" fontsize=10];\n  _scatterelements [shape=box style=\"filled,rounded\" color=orange label=\"ScatterElements\\n(_scatterelements)\\naxis=0\" fontsize=10];\n  out_res_0 -> _scatterelements;\n  init_1 -> _scatterelements;\n  init_2 -> _scatterelements;\n  _scatterelements -> out_sca_0;\n\n  out_sha_0 [shape=box label=\"out_sha_0\" fontsize=10];\n  _shape [shape=box style=\"filled,rounded\" color=orange label=\"Shape\\n(_shape)\" fontsize=10];\n  x -> _shape;\n  _shape -> out_sha_0;\n\n  _reshape_1 [shape=box style=\"filled,rounded\" color=orange label=\"Reshape\\n(_reshape_1)\" fontsize=10];\n  out_sca_0 -> _reshape_1;\n  out_sha_0 -> _reshape_1;\n  _reshape_1 -> y;\n}\n");
    document.getElementById('gdot-139922714607728').innerHTML = svgGraph; });
    
</script>
</div><p>Instructions using slice is also supported: <code class="docutils literal notranslate"><span class="pre">v[:5]</span> <span class="pre">=</span> <span class="pre">3.5</span></code>, <code class="docutils literal notranslate"><span class="pre">v[5:]</span> <span class="pre">=</span> <span class="pre">3.5</span></code>, â€¦</p>
</section>
<section id="common-errors">
<h2><a class="toc-backref" href="#id12">Common errors</a><a class="headerlink" href="#common-errors" title="Permalink to this headline">#</a></h2>
<section id="missing-wrapper">
<h3><a class="toc-backref" href="#id13">Missing wrapper</a><a class="headerlink" href="#missing-wrapper" title="Permalink to this headline">#</a></h3>
<p>The wrapper intercepts the output of the function and
returns a new function with a runtime. The inner function
returns an instance of type
<a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.OnnxVar" title="mlprodict.npy.onnx_variable.OnnxVar"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxVar</span></code></a>.
It is an layer on the top of ONNX and holds a method doing
the conversion to ONNX <a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.OnnxVar.to_algebra" title="mlprodict.npy.onnx_variable.OnnxVar.to_algebra"><code class="xref py py-meth docutils literal notranslate"><span class="pre">to_algebra</span></code></a>.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>


<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">OnnxVar</span><span class="p">(</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.131</span><span class="p">,</span> <span class="mf">1.134</span><span class="p">,</span> <span class="mf">1.485</span><span class="p">],</span>
           <span class="p">[</span><span class="mf">1.202</span><span class="p">,</span> <span class="mf">1.786</span><span class="p">,</span> <span class="mf">1.071</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">),</span> <span class="n">op</span><span class="o">=</span><span class="n">OnnxLog</span><span class="p">)</span>
</pre></div>
</div>
<p>The execution does not fail but returns an instance of class
<a class="reference internal" href="../mlprodict/npy/onnx_variable.html#mlprodict.npy.onnx_variable.OnnxVar" title="mlprodict.npy.onnx_variable.OnnxVar"><code class="xref py py-class docutils literal notranslate"><span class="pre">OnnxVar</span></code></a>. This
instance holds all the necessary information to create the ONNX
graph.</p>
</section>
<section id="missing-annotation">
<h3><a class="toc-backref" href="#id14">Missing annotation</a><a class="headerlink" href="#missing-annotation" title="Permalink to this headline">#</a></h3>
<p>The annotation is needed to determine the input and output types.
The runtime would fail executing the ONNX graph without that.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">15</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">159</span><span class="p">,</span> <span class="ow">in</span> <span class="n">onnxnumpy_default</span>
        <span class="k">return</span> <span class="n">onnxnumpy</span><span class="p">()(</span><span class="n">fct</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">134</span><span class="p">,</span> <span class="ow">in</span> <span class="n">decorator_fct</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="n">OnnxNumpyCompiler</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">163</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onnx_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_onnx</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">379</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_to_onnx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_annotation</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">295</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_parse_annotation</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
    <span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">annotation</span> <span class="k">for</span> <span class="n">argument</span> <span class="s1">&#39;x&#39;</span><span class="o">.</span> <span class="n">You</span> <span class="n">should</span> <span class="n">annotate</span> <span class="n">the</span> <span class="n">arguments</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">results</span> <span class="ow">or</span> <span class="n">specify</span> <span class="n">a</span> <span class="n">signature</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="type-mismatch">
<h3><a class="toc-backref" href="#id15">Type mismatch</a><a class="headerlink" href="#type-mismatch" title="Permalink to this headline">#</a></h3>
<p>As mentioned below, ONNX is strict about types.
If ONNX does an addition, it expects to do it with the same
types. If types are different, one must be cast into the other one.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># -&gt; replace 1 by numpy.float32(1)</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
    [runpythonerror]
    Traceback (most recent call last):
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;, line 71, in __call__
        return self.compiled(*args, **kwargs)
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;, line 520, in __call__
        res = self.rt_fct_(*args, **kwargs)
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;, line 85, in __call__
        out = self.rt.run(inp, **kwargs)
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/onnxrt/onnx_inference.py&quot;, line 875, in run
        return self._run(inputs, clean_right_away=False,
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/onnxrt/onnx_inference.py&quot;, line 1021, in _run_sequence_runtime
        node.run(values)
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/onnxrt/onnx_inference_node.py&quot;, line 365, in run
        res = self.ops_.run(*args)
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/onnxrt/ops_cpu/_op.py&quot;, line 815, in run
        res = OpRunBinary.run(self, x, y)
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/onnxrt/ops_cpu/_op.py&quot;, line 706, in run
        raise RuntimeTypeError(
    mlprodict.onnxrt.ops_cpu._op.RuntimeTypeError: Input type mismatch: float32 != int64 (operator &#39;Add&#39;, shapes (2, 3), (1,))
    
    The above exception was the direct cause of the following exception:
    
    Traceback (most recent call last):
      File &quot;&lt;stdin&gt;&quot;, line 19, in &lt;module&gt;
      File &quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;, line 76, in __call__
        raise RuntimeError(
    RuntimeError: Unable to call the compiled version, args is [&lt;class &#39;numpy.ndarray&#39;&gt;]. kwargs={}.
</pre></div>
</div>
</section>
<section id="shape-mismatch">
<span id="l-npy-shape-mismatch"></span><h3><a class="toc-backref" href="#id16">Shape mismatch</a><a class="headerlink" href="#shape-mismatch" title="Permalink to this headline">#</a></h3>
<p>The signature of the custom function does not specify any output shape
but the converter of the next transformer in the pipeline might
except one.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">),</span>
    <span class="n">StandardScaler</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rewrite_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">LogisticRegression</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zipmap&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[[</span><span class="mf">5.336e-04</span> <span class="mf">1.752e-01</span> <span class="mf">8.243e-01</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">2.022e-02</span> <span class="mf">8.533e-01</span> <span class="mf">1.265e-01</span><span class="p">]]</span>
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">xgboost</span><span class="o">/</span><span class="n">compat</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Int64Index</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">pandas</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span><span class="o">.</span> <span class="n">Use</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">the</span> <span class="n">appropriate</span> <span class="n">dtype</span> <span class="n">instead</span><span class="o">.</span>
      <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">MultiIndex</span><span class="p">,</span> <span class="n">Int64Index</span>
</pre></div>
</div>
<p><cite>NDArray[Any, np.float32]</cite> needs to be replaced by
<cite>NDArray[(None, None), np.float32]</cite> to tell next converter the
output is a two dimension array.</p>
</section>
<section id="missing-converter">
<span id="l-npy-missing-converter"></span><h3><a class="toc-backref" href="#id17">Missing converter</a><a class="headerlink" href="#missing-converter" title="Permalink to this headline">#</a></h3>
<p>The default converter for <em>FunctionTransformer</em> implemented in
<a class="reference external" href="https://github.com/onnx/sklearn-onnx">sklearn-onnx</a> does not support custom functions,
only identity, which defeats the purpose of using such preprocessing.
The conversion fails unless the default converter is replaced by
a new one supporting custom functions implemented this API.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_log_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">onnx_log_1</span><span class="p">),</span>
    <span class="n">StandardScaler</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
              <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">LogisticRegression</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zipmap&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">34</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/onnx_conv/convert.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">483</span><span class="p">,</span> <span class="ow">in</span> <span class="n">to_onnx</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_types</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/skl2onnx/convert.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">184</span><span class="p">,</span> <span class="ow">in</span> <span class="n">convert_sklearn</span>
        <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">convert_topology</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/skl2onnx/common/_topology.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1421</span><span class="p">,</span> <span class="ow">in</span> <span class="n">convert_topology</span>
        <span class="n">topology</span><span class="o">.</span><span class="n">convert_operators</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/skl2onnx/common/_topology.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1255</span><span class="p">,</span> <span class="ow">in</span> <span class="n">convert_operators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_shape_calculator</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/skl2onnx/common/_topology.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1091</span><span class="p">,</span> <span class="ow">in</span> <span class="n">call_shape_calculator</span>
        <span class="n">operator</span><span class="o">.</span><span class="n">infer_types</span><span class="p">()</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/skl2onnx/common/_topology.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">606</span><span class="p">,</span> <span class="ow">in</span> <span class="n">infer_types</span>
        <span class="n">shape_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/skl2onnx/shape_calculators/function_transformer.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">in</span> <span class="n">calculate_sklearn_function_transformer_output_shapes</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;FunctionTransformer is not supported unless the &quot;</span>
    <span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">FunctionTransformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">supported</span> <span class="n">unless</span> <span class="n">the</span> <span class="n">transform</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">(</span><span class="o">=</span> <span class="n">identity</span><span class="p">)</span><span class="o">.</span> <span class="n">You</span> <span class="n">may</span> <span class="k">raise</span> <span class="n">an</span> <span class="n">issue</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">onnx</span><span class="o">/</span><span class="n">sklearn</span><span class="o">-</span><span class="n">onnx</span><span class="o">/</span><span class="n">issues</span><span class="o">.</span>
</pre></div>
</div>
<p>There are a couple of ways to fix this example. One way is to call
<a class="reference internal" href="../mlprodict/onnx_conv/convert.html#mlprodict.onnx_conv.convert.to_onnx" title="mlprodict.onnx_conv.convert.to_onnx"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_onnx</span></code></a> function with
argument <cite>rewrite_ops=True</cite>. The function restores the default
converter after the call. Another way is to call function
<a class="reference internal" href="../mlprodict/onnx_conv/register_rewritten_converters.html#mlprodict.onnx_conv.register_rewritten_converters.register_rewritten_operators" title="mlprodict.onnx_conv.register_rewritten_converters.register_rewritten_operators"><code class="xref py py-func docutils literal notranslate"><span class="pre">register_rewritten_operators</span></code></a>
but changes are permanent.</p>
</section>
<section id="issue-when-an-estimator-is-called-by-another-one">
<h3><a class="toc-backref" href="#id18">Issue when an estimator is called by another one</a><a class="headerlink" href="#issue-when-an-estimator-is-called-by-another-one" title="Permalink to this headline">#</a></h3>
<p>A new class is created and the method <em>transform</em> is implemented
with the numpy API for ONNX. This function must produce an ONNX
graph including the embedded the embedded model. It must call
the converter for this estimator to get that graph.
That what instruction <code class="docutils literal notranslate"><span class="pre">nxnpskl.transformer(X,</span> <span class="pre">model=self.estimator_)</span></code>
does. However it produces the following error.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">TransformerMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxsklearn_class</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl_skl</span> <span class="k">as</span> <span class="nn">nxnpskl</span>


<span class="nd">@onnxsklearn_class</span><span class="p">(</span><span class="s2">&quot;onnx_graph&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CustomTransformerOnnx</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_estimator</span><span class="p">):</span>
        <span class="n">TransformerMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BaseEstimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_estimator</span> <span class="o">=</span> <span class="n">base_estimator</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;weighted sample not implemented in this example.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>  <span class="c1"># pylint: disable=W0201</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">onnx_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nxnpskl</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span><span class="p">)</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span>
     <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">dec</span> <span class="o">=</span> <span class="n">CustomTransformerOnnx</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">())</span>
<span class="n">dec</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># pylint: disable=E1101</span>
<span class="n">got</span> <span class="o">=</span> <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">got</span><span class="p">)</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">{</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.764</span><span class="p">,</span>  <span class="mf">0.762</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">1.585</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.715</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">0.314</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.751</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">0.367</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.494</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">1.297</span><span class="p">,</span>  <span class="mf">0.747</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">2.002</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.84</span> <span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">0.754</span><span class="p">,</span>  <span class="mf">0.375</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">0.91</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.197</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">1.317</span><span class="p">,</span>  <span class="mf">0.781</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">0.133</span><span class="p">,</span>  <span class="mf">0.703</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">1.252</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.523</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">0.396</span><span class="p">,</span>  <span class="mf">1.359</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">0.197</span><span class="p">,</span>  <span class="mf">1.69</span> <span class="p">],</span>
           <span class="p">[</span> <span class="mf">0.33</span> <span class="p">,</span>  <span class="mf">0.605</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">0.645</span><span class="p">,</span>  <span class="mf">0.544</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">1.039</span><span class="p">,</span>  <span class="mf">0.315</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">0.842</span><span class="p">,</span>  <span class="mf">0.003</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">1.41</span> <span class="p">,</span>  <span class="mf">0.216</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">1.317</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.434</span><span class="p">],</span>
           <span class="p">[</span> <span class="mf">0.182</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.147</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)}</span>
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">xgboost</span><span class="o">/</span><span class="n">compat</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span> <span class="ne">FutureWarning</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Int64Index</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">pandas</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span><span class="o">.</span> <span class="n">Use</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">the</span> <span class="n">appropriate</span> <span class="n">dtype</span> <span class="n">instead</span><span class="o">.</span>
      <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">MultiIndex</span><span class="p">,</span> <span class="n">Int64Index</span>
</pre></div>
</div>
<p>To fix it, instruction <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">nxnpskl.transformer(X,</span> <span class="pre">model=self.estimator_)</span></code>
should be replaced by
<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">nxnpskl.transformer(X,</span> <span class="pre">model=self.estimator_).copy()</span></code>.</p>
</section>
<section id="typeerror-unsupported-operand-type-s-for-or-pow-float-and-onnxvar">
<h3><a class="toc-backref" href="#id19">TypeError: unsupported operand type(s) for ** or pow(): â€˜floatâ€™ and â€˜OnnxVarâ€™</a><a class="headerlink" href="#typeerror-unsupported-operand-type-s-for-or-pow-float-and-onnxvar" title="Permalink to this headline">#</a></h3>
<p>The following example works because operator <code class="docutils literal notranslate"><span class="pre">__radd__</span></code> was overwritten
in class &#64;see cl OnnxVar.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>


<span class="k">def</span> <span class="nf">np_fct</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_fct</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np_fct</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">onnx_fct</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="p">[[</span><span class="mf">0.254</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.621</span><span class="p">]]</span> <span class="p">[[</span><span class="mf">0.254</span><span class="p">]</span>
     <span class="p">[</span><span class="mf">0.621</span><span class="p">]]</span>
</pre></div>
</div>
<p>But it is not the case for all operators.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>


<span class="k">def</span> <span class="nf">np_fct</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">x</span><span class="p">)</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_fct</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">**</span> <span class="n">x</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np_fct</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">onnx_fct</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">18</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">159</span><span class="p">,</span> <span class="ow">in</span> <span class="n">onnxnumpy_default</span>
        <span class="k">return</span> <span class="n">onnxnumpy</span><span class="p">()(</span><span class="n">fct</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">134</span><span class="p">,</span> <span class="ow">in</span> <span class="n">decorator_fct</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="n">OnnxNumpyCompiler</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">163</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onnx_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_onnx</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">402</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_to_onnx</span>
        <span class="n">onx_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fct_</span><span class="p">(</span><span class="o">*</span><span class="n">names_var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">19</span><span class="p">,</span> <span class="ow">in</span> <span class="n">onnx_fct</span>
    <span class="ne">TypeError</span><span class="p">:</span> <span class="n">unsupported</span> <span class="n">operand</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="o">**</span> <span class="ow">or</span> <span class="nb">pow</span><span class="p">():</span> <span class="s1">&#39;float&#39;</span> <span class="ow">and</span> <span class="s1">&#39;OnnxVar&#39;</span>
</pre></div>
</div>
<p>Python calls the operator <code class="docutils literal notranslate"><span class="pre">float.__pow__</span></code> and not <code class="docutils literal notranslate"><span class="pre">OnnxVar.__pow__</span></code>.
That explains the error. Function &#64;see fct cst can be used to
convert a constant into an &#64;see cl OnnxVar. The right operator
is called.</p>
<p>&lt;&lt;&lt;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlprodict.npy.numpy_onnx_impl</span> <span class="k">as</span> <span class="nn">npnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.npy</span> <span class="kn">import</span> <span class="n">onnxnumpy_default</span><span class="p">,</span> <span class="n">NDArray</span>


<span class="k">def</span> <span class="nf">np_fct</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">x</span><span class="p">)</span>


<span class="nd">@onnxnumpy_default</span>
<span class="k">def</span> <span class="nf">onnx_fct</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">npnx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">**</span> <span class="n">x</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np_fct</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">onnx_fct</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>&gt;&gt;&gt;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    
    <span class="p">[</span><span class="n">runpythonerror</span><span class="p">]</span>
    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">18</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">159</span><span class="p">,</span> <span class="ow">in</span> <span class="n">onnxnumpy_default</span>
        <span class="k">return</span> <span class="n">onnxnumpy</span><span class="p">()(</span><span class="n">fct</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_wrapper.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">134</span><span class="p">,</span> <span class="ow">in</span> <span class="n">decorator_fct</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="n">OnnxNumpyCompiler</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">163</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onnx_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_onnx</span><span class="p">(</span>
      <span class="n">File</span> <span class="s2">&quot;/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/sphinxdoc/source/mlprodict/npy/onnx_numpy_compiler.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">402</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_to_onnx</span>
        <span class="n">onx_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fct_</span><span class="p">(</span><span class="o">*</span><span class="n">names_var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">19</span><span class="p">,</span> <span class="ow">in</span> <span class="n">onnx_fct</span>
    <span class="ne">TypeError</span><span class="p">:</span> <span class="n">unsupported</span> <span class="n">operand</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="o">**</span> <span class="ow">or</span> <span class="nb">pow</span><span class="p">():</span> <span class="s1">&#39;float&#39;</span> <span class="ow">and</span> <span class="s1">&#39;OnnxVar&#39;</span>
</pre></div>
</div>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="onnx_numpy.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Create custom ONNX graphs with AST</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="xop_api.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Xop API</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier DuprÃ©.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>