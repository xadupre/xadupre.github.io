
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Compares implementations of Add &#8212; Python Runtime for ONNX</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compares implementations of ReduceMax" href="plot_op_reducemax.html" />
    <link rel="prev" title="Compares numba, numpy, onnxruntime for simple functions" href="plot_numba.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_logistic_regression.html">
   Conversion of a logistic regression into C
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_benchmark.html">
   Measure ONNX runtime performances
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_profile.html">
   Profile the execution of a runtime
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_grid_search.html">
   Grid search ONNX models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_merge_benchmark.html">
   Merges benchmarks
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_speedup_pca.html">
   Speed up scikit-learn inference with ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_time_tree_ensemble.html">
   Benchmark Random Forests, Tree Ensemble
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_numba.html">
   Compares numba, numpy, onnxruntime for simple functions
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Compares implementations of Add
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemax.html">
   Compares implementations of ReduceMax
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesumsquare.html">
   Compares implementations of ReduceSumSquare
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemean.html">
   Compares implementations of ReduceMean
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_transpose.html">
   Compares implementations of Tranpose
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_parallelism.html">
   When to parallelize?
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesum.html">
   Compares implementations of ReduceSum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_where.html">
   Compares implementations of Where
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_einsum.html">
   Compares implementations of Einsum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_onnx_topk.html">
   TopK benchmark
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_linear_regression.html">
   Benchmark Linear Regression
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_reg.html">
   Benchmark Random Forests, Tree Ensemble, (AoS and SoA)
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_cls_multi.html">
   Benchmark Random Forests, Tree Ensemble, Multi-Classification
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_tree_ensemble_parallel.html">
   TreeEnsembleRegressor and parallelisation
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-implementations">
   Add implementations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#n-n-5-n-n">
   (5, N, N) + (5, N, N)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#n-n-5-n-1">
   (5, N, N) + (5, N, 1)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#n-n-5-1-n">
   (5, N, N) + (5, 1, N)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#n-5-n-1-n-1-1">
   (5, N, 5, N) + (1, N, 1, 1)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-op-add-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="compares-implementations-of-add">
<span id="l-b-add"></span><span id="sphx-glr-gyexamples-plot-op-add-py"></span><h1>Compares implementations of Add<a class="headerlink" href="#compares-implementations-of-add" title="Permalink to this headline">¶</a></h1>
<p>This example compares the addition of <em>numpy</em>
to <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime</a> implementation.
Function <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.add.html">numpy.add</a> is repeated 3 times. This minimizes the cost
of copying the data from python to an external library.
If available, <a class="reference external" href="https://www.tensorflow.org/">tensorflow</a> and <a class="reference external" href="https://pytorch.org/">pytorch</a> are included as well.
The numpy implementation is not the best,
it allocates more buffers than necessary because parameter <em>out</em>
is not used to reuse buffers.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#add-implementations" id="id1">Add implementations</a></p></li>
<li><p><a class="reference internal" href="#n-n-5-n-n" id="id2">(5, N, N) + (5, N, N)</a></p></li>
<li><p><a class="reference internal" href="#n-n-5-n-1" id="id3">(5, N, N) + (5, N, 1)</a></p></li>
<li><p><a class="reference internal" href="#n-n-5-1-n" id="id4">(5, N, N) + (5, 1, N)</a></p></li>
<li><p><a class="reference internal" href="#n-5-n-1-n-1-1" id="id5">(5, N, 5, N) + (1, N, 1, 1)</a></p></li>
<li><p><a class="reference internal" href="#conclusion" id="id6">Conclusion</a></p></li>
</ul>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">from</span> <span class="nn">skl2onnx.common.data_types</span> <span class="kn">import</span> <span class="n">FloatTensorType</span>
<span class="kn">from</span> <span class="nn">skl2onnx.algebra.onnx_ops</span> <span class="kn">import</span> <span class="n">OnnxAdd</span>
<span class="kn">from</span> <span class="nn">cpyquickhelper.numbers</span> <span class="kn">import</span> <span class="n">measure_time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">mlprodict.testing.experimental_c_impl.experimental_c</span> <span class="kn">import</span> <span class="n">code_optimisation</span>
<span class="nb">print</span><span class="p">(</span><span class="n">code_optimisation</span><span class="p">())</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>AVX-omp=8
</pre></div>
</div>
<section id="add-implementations">
<h2><a class="toc-backref" href="#id1">Add implementations</a><a class="headerlink" href="#add-implementations" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tensorflow.math</span> <span class="kn">import</span> <span class="n">add</span> <span class="k">as</span> <span class="n">tf_add</span>
    <span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">convert_to_tensor</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">tf_add</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">add</span> <span class="k">as</span> <span class="n">torch_add</span><span class="p">,</span> <span class="n">from_numpy</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">torch_add</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">build_ort_add</span><span class="p">(</span><span class="n">op_version</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">node1</span> <span class="o">=</span> <span class="n">OnnxAdd</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">op_version</span><span class="p">)</span>
    <span class="n">node2</span> <span class="o">=</span> <span class="n">OnnxAdd</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">op_version</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">OnnxAdd</span><span class="p">(</span><span class="n">node2</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">op_version</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
    <span class="n">onx</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">to_onnx</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">()),</span>
                               <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">())],</span>
                       <span class="n">target_opset</span><span class="o">=</span><span class="n">op_version</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">loop_fct</span><span class="p">(</span><span class="n">fct</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
        <span class="n">fct</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">benchmark_op</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">shape_fcts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">shape_fcts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">shape_fct</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="n">shape_fcts</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape_fct</span><span class="p">,</span> <span class="n">shape_fct</span><span class="p">)</span>
    <span class="n">ort_fct</span> <span class="o">=</span> <span class="n">build_ort_add</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span>
                     <span class="mi">256</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1536</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">2560</span><span class="p">]):</span>
        <span class="n">shape1</span> <span class="o">=</span> <span class="n">shape_fcts</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">shape2</span> <span class="o">=</span> <span class="n">shape_fcts</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">n_arrays</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="mi">512</span> <span class="k">else</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="mi">2048</span> <span class="k">else</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">n_arrays</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_arrays</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_arrays</span><span class="p">)]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_arrays</span><span class="p">)]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape1</span><span class="o">=</span><span class="n">shape1</span><span class="p">,</span> <span class="n">shape2</span><span class="o">=</span><span class="n">shape2</span><span class="p">)</span>

        <span class="c1"># numpy</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">xs</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">ys</span><span class="p">,</span>
            <span class="n">fct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span>
            <span class="n">loop_fct</span><span class="o">=</span><span class="n">loop_fct</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
            <span class="s2">&quot;loop_fct(fct, xs, ys)&quot;</span><span class="p">,</span>
            <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="c1"># onnxruntime</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ort_fct</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
            <span class="s2">&quot;loop_fct(fct, xs, ys)&quot;</span><span class="p">,</span>
            <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ort&#39;</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tf_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># tensorflow</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">tf_add</span><span class="p">(</span><span class="n">tf_add</span><span class="p">(</span><span class="n">tf_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">]</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
                <span class="s2">&quot;loop_fct(fct, xs, ys)&quot;</span><span class="p">,</span>
                <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tf&#39;</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">torch_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># torch</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch_add</span><span class="p">(</span>
                <span class="n">torch_add</span><span class="p">(</span><span class="n">torch_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">]</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
                <span class="s2">&quot;loop_fct(fct, xs, ys)&quot;</span><span class="p">,</span>
                <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;torch&#39;</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="c1"># Dataframes</span>
    <span class="n">shape1_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">shape1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
    <span class="n">shape2_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">shape2</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;fct&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">)</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ort&#39;</span><span class="p">,</span> <span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="s1">&#39;tf&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">rs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">rs</span><span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="c1"># Graphs.</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> benchmark</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">&quot;</span>
                   <span class="s2">&quot; lower better&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape1_name</span><span class="p">,</span> <span class="n">shape2_name</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Speedup, baseline=numpy</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">&quot;</span>
                  <span class="s2">&quot; higher better&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape1_name</span><span class="p">,</span> <span class="n">shape2_name</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">index</span><span class="p">)],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;g--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">index</span><span class="p">)],</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span> <span class="s1">&#39;g--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">ax</span>


<span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</section>
<section id="n-n-5-n-n">
<h2><a class="toc-backref" href="#id2">(5, N, N) + (5, N, N)</a><a class="headerlink" href="#n-n-5-n-n" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">benchmark_op</span><span class="p">()</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;fct&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_op_add_001.png" srcset="../_images/sphx_glr_plot_op_add_001.png" alt="Add benchmark (5, N, N) + (5, N, N) lower better, Add Speedup, baseline=numpy (5, N, N) + (5, N, N) higher better" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/14 [00:00&lt;?, ?it/s]
  7%|7         | 1/14 [00:00&lt;00:05,  2.46it/s]
 21%|##1       | 3/14 [00:00&lt;00:01,  6.17it/s]
 29%|##8       | 4/14 [00:00&lt;00:01,  6.19it/s]
 36%|###5      | 5/14 [00:01&lt;00:01,  4.94it/s]
 43%|####2     | 6/14 [00:01&lt;00:02,  3.33it/s]
 50%|#####     | 7/14 [00:02&lt;00:03,  2.07it/s]
 57%|#####7    | 8/14 [00:03&lt;00:04,  1.29it/s]
 64%|######4   | 9/14 [00:07&lt;00:07,  1.54s/it]
 71%|#######1  | 10/14 [00:08&lt;00:05,  1.46s/it]
 79%|#######8  | 11/14 [00:13&lt;00:07,  2.52s/it]
 86%|########5 | 12/14 [00:27&lt;00:12,  6.01s/it]
 93%|#########2| 13/14 [01:16&lt;00:18, 18.92s/it]
100%|##########| 14/14 [02:16&lt;00:00, 31.36s/it]
100%|##########| 14/14 [02:16&lt;00:00,  9.75s/it]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>8</th>
      <th>16</th>
      <th>32</th>
      <th>64</th>
      <th>100</th>
      <th>128</th>
      <th>200</th>
      <th>256</th>
      <th>400</th>
      <th>512</th>
      <th>1024</th>
      <th>1536</th>
      <th>2048</th>
      <th>2560</th>
    </tr>
    <tr>
      <th>fct</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>numpy</th>
      <td>0.000314</td>
      <td>0.000416</td>
      <td>0.000715</td>
      <td>0.001835</td>
      <td>0.003155</td>
      <td>0.007190</td>
      <td>0.021194</td>
      <td>0.034518</td>
      <td>0.081044</td>
      <td>0.033116</td>
      <td>0.130231</td>
      <td>0.287295</td>
      <td>0.565019</td>
      <td>1.573621</td>
    </tr>
    <tr>
      <th>ort</th>
      <td>0.001282</td>
      <td>0.001409</td>
      <td>0.001688</td>
      <td>0.002757</td>
      <td>0.006229</td>
      <td>0.011522</td>
      <td>0.015433</td>
      <td>0.025312</td>
      <td>0.058594</td>
      <td>0.022914</td>
      <td>0.088781</td>
      <td>0.199842</td>
      <td>0.374033</td>
      <td>0.709534</td>
    </tr>
    <tr>
      <th>tf</th>
      <td>0.008739</td>
      <td>0.002773</td>
      <td>0.002990</td>
      <td>0.003850</td>
      <td>0.006986</td>
      <td>0.015822</td>
      <td>0.020658</td>
      <td>0.031541</td>
      <td>0.057738</td>
      <td>0.020350</td>
      <td>0.071768</td>
      <td>0.220724</td>
      <td>0.428405</td>
      <td>0.619630</td>
    </tr>
    <tr>
      <th>torch</th>
      <td>0.013614</td>
      <td>0.001165</td>
      <td>0.001858</td>
      <td>0.004582</td>
      <td>0.005977</td>
      <td>0.006273</td>
      <td>0.008531</td>
      <td>0.014601</td>
      <td>0.044052</td>
      <td>0.017106</td>
      <td>0.064175</td>
      <td>0.143493</td>
      <td>0.281820</td>
      <td>0.481524</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="n-n-5-n-1">
<h2><a class="toc-backref" href="#id3">(5, N, N) + (5, N, 1)</a><a class="headerlink" href="#n-n-5-n-1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shape_fcts</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span>
              <span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">df</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">benchmark_op</span><span class="p">(</span><span class="n">shape_fcts</span><span class="o">=</span><span class="n">shape_fcts</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;fct&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_op_add_002.png" srcset="../_images/sphx_glr_plot_op_add_002.png" alt="Add benchmark (5, N, N) + (5, N, 1) lower better, Add Speedup, baseline=numpy (5, N, N) + (5, N, 1) higher better" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/14 [00:00&lt;?, ?it/s]
  7%|7         | 1/14 [00:00&lt;00:02,  5.67it/s]
 21%|##1       | 3/14 [00:00&lt;00:01,  8.69it/s]
 29%|##8       | 4/14 [00:00&lt;00:01,  7.11it/s]
 36%|###5      | 5/14 [00:00&lt;00:01,  4.99it/s]
 43%|####2     | 6/14 [00:01&lt;00:02,  3.50it/s]
 50%|#####     | 7/14 [00:02&lt;00:03,  2.27it/s]
 57%|#####7    | 8/14 [00:03&lt;00:03,  1.55it/s]
 64%|######4   | 9/14 [00:05&lt;00:06,  1.23s/it]
 71%|#######1  | 10/14 [00:06&lt;00:04,  1.16s/it]
 79%|#######8  | 11/14 [00:10&lt;00:05,  1.98s/it]
 86%|########5 | 12/14 [00:19&lt;00:07,  3.96s/it]
 93%|#########2| 13/14 [00:37&lt;00:08,  8.24s/it]
100%|##########| 14/14 [01:18&lt;00:00, 18.23s/it]
100%|##########| 14/14 [01:18&lt;00:00,  5.62s/it]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>8</th>
      <th>16</th>
      <th>32</th>
      <th>64</th>
      <th>100</th>
      <th>128</th>
      <th>200</th>
      <th>256</th>
      <th>400</th>
      <th>512</th>
      <th>1024</th>
      <th>1536</th>
      <th>2048</th>
      <th>2560</th>
    </tr>
    <tr>
      <th>fct</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>numpy</th>
      <td>0.000856</td>
      <td>0.001009</td>
      <td>0.001453</td>
      <td>0.002779</td>
      <td>0.005096</td>
      <td>0.008437</td>
      <td>0.022131</td>
      <td>0.034717</td>
      <td>0.078231</td>
      <td>0.031491</td>
      <td>0.139114</td>
      <td>0.279091</td>
      <td>0.559810</td>
      <td>1.278485</td>
    </tr>
    <tr>
      <th>ort</th>
      <td>0.001494</td>
      <td>0.001701</td>
      <td>0.002150</td>
      <td>0.003674</td>
      <td>0.007313</td>
      <td>0.011122</td>
      <td>0.013241</td>
      <td>0.019968</td>
      <td>0.048523</td>
      <td>0.019240</td>
      <td>0.073530</td>
      <td>0.167862</td>
      <td>0.299486</td>
      <td>0.659207</td>
    </tr>
    <tr>
      <th>tf</th>
      <td>0.013325</td>
      <td>0.003228</td>
      <td>0.003713</td>
      <td>0.005626</td>
      <td>0.009772</td>
      <td>0.015396</td>
      <td>0.022690</td>
      <td>0.026900</td>
      <td>0.049526</td>
      <td>0.017804</td>
      <td>0.055136</td>
      <td>0.137246</td>
      <td>0.268110</td>
      <td>0.573639</td>
    </tr>
    <tr>
      <th>torch</th>
      <td>0.001213</td>
      <td>0.001370</td>
      <td>0.002138</td>
      <td>0.004828</td>
      <td>0.006362</td>
      <td>0.006247</td>
      <td>0.007718</td>
      <td>0.009471</td>
      <td>0.034009</td>
      <td>0.013447</td>
      <td>0.050324</td>
      <td>0.113583</td>
      <td>0.275257</td>
      <td>0.593575</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="n-n-5-1-n">
<h2><a class="toc-backref" href="#id4">(5, N, N) + (5, 1, N)</a><a class="headerlink" href="#n-n-5-1-n" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shape_fcts</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span>
              <span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>

<span class="n">df</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">benchmark_op</span><span class="p">(</span><span class="n">shape_fcts</span><span class="o">=</span><span class="n">shape_fcts</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;fct&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_op_add_003.png" srcset="../_images/sphx_glr_plot_op_add_003.png" alt="Add benchmark (5, N, N) + (5, 1, N) lower better, Add Speedup, baseline=numpy (5, N, N) + (5, 1, N) higher better" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/14 [00:00&lt;?, ?it/s]
  7%|7         | 1/14 [00:00&lt;00:01,  7.37it/s]
 21%|##1       | 3/14 [00:00&lt;00:01,  9.55it/s]
 29%|##8       | 4/14 [00:00&lt;00:01,  7.44it/s]
 36%|###5      | 5/14 [00:00&lt;00:01,  4.99it/s]
 43%|####2     | 6/14 [00:01&lt;00:02,  3.50it/s]
 50%|#####     | 7/14 [00:02&lt;00:03,  2.29it/s]
 57%|#####7    | 8/14 [00:03&lt;00:03,  1.54it/s]
 64%|######4   | 9/14 [00:05&lt;00:06,  1.22s/it]
 71%|#######1  | 10/14 [00:06&lt;00:04,  1.16s/it]
 79%|#######8  | 11/14 [00:10&lt;00:05,  1.94s/it]
 86%|########5 | 12/14 [00:18&lt;00:07,  3.90s/it]
 93%|#########2| 13/14 [00:38&lt;00:08,  8.75s/it]
100%|##########| 14/14 [01:13&lt;00:00, 16.59s/it]
100%|##########| 14/14 [01:13&lt;00:00,  5.26s/it]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>8</th>
      <th>16</th>
      <th>32</th>
      <th>64</th>
      <th>100</th>
      <th>128</th>
      <th>200</th>
      <th>256</th>
      <th>400</th>
      <th>512</th>
      <th>1024</th>
      <th>1536</th>
      <th>2048</th>
      <th>2560</th>
    </tr>
    <tr>
      <th>fct</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>numpy</th>
      <td>0.000844</td>
      <td>0.000998</td>
      <td>0.001299</td>
      <td>0.002496</td>
      <td>0.004806</td>
      <td>0.007907</td>
      <td>0.021391</td>
      <td>0.034351</td>
      <td>0.076592</td>
      <td>0.031535</td>
      <td>0.122271</td>
      <td>0.264473</td>
      <td>0.552337</td>
      <td>1.244747</td>
    </tr>
    <tr>
      <th>ort</th>
      <td>0.001502</td>
      <td>0.001699</td>
      <td>0.002155</td>
      <td>0.003780</td>
      <td>0.007574</td>
      <td>0.011310</td>
      <td>0.013246</td>
      <td>0.020848</td>
      <td>0.048536</td>
      <td>0.020048</td>
      <td>0.074279</td>
      <td>0.167172</td>
      <td>0.301683</td>
      <td>0.469339</td>
    </tr>
    <tr>
      <th>tf</th>
      <td>0.009225</td>
      <td>0.003276</td>
      <td>0.003735</td>
      <td>0.005590</td>
      <td>0.009671</td>
      <td>0.015538</td>
      <td>0.022716</td>
      <td>0.028296</td>
      <td>0.051068</td>
      <td>0.017967</td>
      <td>0.056266</td>
      <td>0.134486</td>
      <td>0.391137</td>
      <td>0.593351</td>
    </tr>
    <tr>
      <th>torch</th>
      <td>0.001244</td>
      <td>0.001424</td>
      <td>0.002221</td>
      <td>0.005223</td>
      <td>0.007731</td>
      <td>0.006532</td>
      <td>0.007228</td>
      <td>0.010357</td>
      <td>0.032165</td>
      <td>0.014324</td>
      <td>0.050672</td>
      <td>0.113287</td>
      <td>0.389354</td>
      <td>0.307991</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="n-5-n-1-n-1-1">
<h2><a class="toc-backref" href="#id5">(5, N, 5, N) + (1, N, 1, 1)</a><a class="headerlink" href="#n-5-n-1-n-1-1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shape_fcts</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span>
              <span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">df</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">benchmark_op</span><span class="p">(</span><span class="n">shape_fcts</span><span class="o">=</span><span class="n">shape_fcts</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;fct&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_op_add_004.png" srcset="../_images/sphx_glr_plot_op_add_004.png" alt="Add benchmark (5, N, 5, N) + (1, N, 1, 1) lower better, Add Speedup, baseline=numpy (5, N, 5, N) + (1, N, 1, 1) higher better" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/14 [00:00&lt;?, ?it/s]
 21%|##1       | 3/14 [00:00&lt;00:00, 28.17it/s]
 43%|####2     | 6/14 [00:00&lt;00:01,  6.31it/s]
 57%|#####7    | 8/14 [00:02&lt;00:02,  2.15it/s]
 64%|######4   | 9/14 [00:05&lt;00:04,  1.05it/s]
 71%|#######1  | 10/14 [00:06&lt;00:04,  1.00s/it]
 79%|#######8  | 11/14 [00:11&lt;00:05,  1.97s/it]
 86%|########5 | 12/14 [00:38&lt;00:16,  8.30s/it]
 93%|#########2| 13/14 [01:56&lt;00:27, 27.16s/it]
100%|##########| 14/14 [04:00&lt;00:00, 54.12s/it]
100%|##########| 14/14 [04:00&lt;00:00, 17.19s/it]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>N</th>
      <th>8</th>
      <th>16</th>
      <th>32</th>
      <th>64</th>
      <th>100</th>
      <th>128</th>
      <th>200</th>
      <th>256</th>
      <th>400</th>
      <th>512</th>
      <th>1024</th>
      <th>1536</th>
      <th>2048</th>
      <th>2560</th>
    </tr>
    <tr>
      <th>fct</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>numpy</th>
      <td>0.000259</td>
      <td>0.000356</td>
      <td>0.000760</td>
      <td>0.002601</td>
      <td>0.006725</td>
      <td>0.011637</td>
      <td>0.023858</td>
      <td>0.038951</td>
      <td>0.094634</td>
      <td>0.037877</td>
      <td>0.150494</td>
      <td>0.890345</td>
      <td>4.437272</td>
      <td>7.067374</td>
    </tr>
    <tr>
      <th>ort</th>
      <td>0.000410</td>
      <td>0.000502</td>
      <td>0.000873</td>
      <td>0.002132</td>
      <td>0.003883</td>
      <td>0.006446</td>
      <td>0.014863</td>
      <td>0.023863</td>
      <td>0.056299</td>
      <td>0.024370</td>
      <td>0.096515</td>
      <td>0.867989</td>
      <td>1.683101</td>
      <td>2.733781</td>
    </tr>
    <tr>
      <th>tf</th>
      <td>0.000831</td>
      <td>0.000945</td>
      <td>0.001398</td>
      <td>0.004572</td>
      <td>0.006970</td>
      <td>0.008493</td>
      <td>0.014739</td>
      <td>0.020967</td>
      <td>0.043874</td>
      <td>0.017263</td>
      <td>0.082833</td>
      <td>0.261950</td>
      <td>0.454442</td>
      <td>0.684437</td>
    </tr>
    <tr>
      <th>torch</th>
      <td>0.000374</td>
      <td>0.000571</td>
      <td>0.001395</td>
      <td>0.002823</td>
      <td>0.001855</td>
      <td>0.003240</td>
      <td>0.010237</td>
      <td>0.018430</td>
      <td>0.039048</td>
      <td>0.015718</td>
      <td>0.078010</td>
      <td>0.280639</td>
      <td>0.483365</td>
      <td>0.729247</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="conclusion">
<h2><a class="toc-backref" href="#id6">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>It is difficult to have a final conclusion as the addition
of two vectors is of the same order of magnitude of a copy
between python and the C++ code of onnxruntime, pytorch or
tensorflow. numpy is much better of small vectors.
onnxruntime, pytorch and tensorflow are not optimized
on this case because it is not very common in deep learning.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">merged</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span>
<span class="n">merged</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;plot_</span><span class="si">%s</span><span class="s2">.csv&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">merged</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;plot_</span><span class="si">%s</span><span class="s2">.xlsx&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plot_</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_op_add_005.png" srcset="../_images/sphx_glr_plot_op_add_005.png" alt="plot op add" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 9 minutes  24.489 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-op-add-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/73388f734093c44057ba4a36d368c9fa/plot_op_add.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_op_add.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/da1dbae79b20d9080c9654461a96bf86/plot_op_add.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_op_add.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_numba.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compares numba, numpy, onnxruntime for simple functions</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_op_reducemax.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Compares implementations of ReduceMax</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>