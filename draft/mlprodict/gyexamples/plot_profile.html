
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Profile the execution of a runtime &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Grid search ONNX models" href="plot_grid_search.html" />
    <link rel="prev" title="Measure ONNX runtime performances" href="plot_onnx_benchmark.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_logistic_regression.html">
   Conversion of a logistic regression into C
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_benchmark.html">
   Measure ONNX runtime performances
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Profile the execution of a runtime
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_grid_search.html">
   Grid search ONNX models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_merge_benchmark.html">
   Merges benchmarks
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_speedup_pca.html">
   Speed up scikit-learn inference with ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_time_tree_ensemble.html">
   Benchmark Random Forests, Tree Ensemble
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_numba.html">
   Compares numba, numpy, onnxruntime for simple functions
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_add.html">
   Compares implementations of Add
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemax.html">
   Compares implementations of ReduceMax
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesumsquare.html">
   Compares implementations of ReduceSumSquare
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemean.html">
   Compares implementations of ReduceMean
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_transpose.html">
   Compares implementations of Tranpose
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_parallelism.html">
   When to parallelize?
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesum.html">
   Compares implementations of ReduceSum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_where.html">
   Compares implementations of Where
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_einsum.html">
   Compares implementations of Einsum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_onnx_topk.html">
   TopK benchmark
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_linear_regression.html">
   Benchmark Linear Regression
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_reg.html">
   Benchmark Random Forests, Tree Ensemble, (AoS and SoA)
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_cls_multi.html">
   Benchmark Random Forests, Tree Ensemble, Multi-Classification
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_tree_ensemble_parallel.html">
   TreeEnsembleRegressor and parallelisation
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training-and-converting-a-model">
   Training and converting a model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling-and-comparison-with-scikit-learn">
   Profiling and comparison with scikit-learn
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling-for-adaboostregressor">
   Profiling for AdaBoostRegressor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#with-a-different-runtime">
   With a different runtime
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#py-spy">
   py-spy
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-profile-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="profile-the-execution-of-a-runtime">
<span id="l-example-profile"></span><span id="sphx-glr-gyexamples-plot-profile-py"></span><h1>Profile the execution of a runtime<a class="headerlink" href="#profile-the-execution-of-a-runtime" title="Permalink to this headline">#</a></h1>
<p>The following example shows how to profile the execution
of a model with different runtime.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#training-and-converting-a-model" id="id1">Training and converting a model</a></p></li>
<li><p><a class="reference internal" href="#profiling-and-comparison-with-scikit-learn" id="id2">Profiling and comparison with scikit-learn</a></p></li>
<li><p><a class="reference internal" href="#profiling-for-adaboostregressor" id="id3">Profiling for AdaBoostRegressor</a></p></li>
<li><p><a class="reference internal" href="#with-a-different-runtime" id="id4">With a different runtime</a></p></li>
<li><p><a class="reference internal" href="#py-spy" id="id5">py-spy</a></p></li>
</ul>
</div>
<section id="training-and-converting-a-model">
<h2><a class="toc-backref" href="#id1">Training and converting a model</a><a class="headerlink" href="#training-and-converting-a-model" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_boston</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">AdaBoostRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict</span> <span class="kn">import</span> <span class="n">get_ir_version</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_boston</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">target</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">dt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">X</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python_compiled&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:87: FutureWarning: Function load_boston is deprecated; `load_boston` is deprecated in 1.0 and will be removed in 1.2.

    The Boston housing prices dataset has an ethical problem. You can refer to
    the documentation of this function for further details.

    The scikit-learn maintainers therefore strongly discourage the use of this
    dataset unless the purpose of the code is to study and educate about
    ethical issues in data science and machine learning.

    In this special case, you can fetch the dataset from the original
    source::

        import pandas as pd
        import numpy as np


        data_url = &quot;http://lib.stat.cmu.edu/datasets/boston&quot;
        raw_df = pd.read_csv(data_url, sep=&quot;\s+&quot;, skiprows=22, header=None)
        data = np.hstack([raw_df.values[::2, :], raw_df.values[1::2, :2]])
        target = raw_df.values[1::2, 2]

    Alternative datasets include the California housing dataset (i.e.
    :func:`~sklearn.datasets.fetch_california_housing`) and the Ames housing
    dataset. You can load the datasets as follows::

        from sklearn.datasets import fetch_california_housing
        housing = fetch_california_housing()

    for the California housing dataset and::

        from sklearn.datasets import fetch_openml
        housing = fetch_openml(name=&quot;house_prices&quot;, as_frame=True)

    for the Ames housing dataset.

  warnings.warn(msg, category=FutureWarning)
OnnxInference(...)
    def compiled_run(dict_inputs, yield_ops=None):
        if yield_ops is not None:
            raise NotImplementedError(&#39;yields_ops should be None.&#39;)
        # inputs
        X = dict_inputs[&#39;X&#39;]
        (variable, ) = n0_treeensembleregressor_1(X)
        return {
            &#39;variable&#39;: variable,
        }
</pre></div>
</div>
</section>
<section id="profiling-and-comparison-with-scikit-learn">
<h2><a class="toc-backref" href="#id2">Profiling and comparison with scikit-learn</a><a class="headerlink" href="#profiling-and-comparison-with-scikit-learn" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runlocaldt</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">):</span>
        <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">10</span><span class="p">]})</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;profiling...&quot;</span><span class="p">)</span>
<span class="n">txt</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">runlocaldt</span><span class="p">,</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>profiling...

  _     ._   __/__   _ _  _  _ _/_   Recorded: 03:13:00 AM Samples:  2772
 /_//_/// /_\ / //_// / //_&#39;/ //     Duration: 2.790     CPU time: 2.786
/   _/                      v4.1.1

Program: /var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/examples/plot_profile.py

2.789 profile  ../pycode/profiling.py:457
`- 2.789 runlocaldt  plot_profile.py:44
      [170 frames hidden]  plot_profile, sklearn, &lt;__array_funct...
</pre></div>
</div>
</section>
<section id="profiling-for-adaboostregressor">
<h2><a class="toc-backref" href="#id3">Profiling for AdaBoostRegressor</a><a class="headerlink" href="#profiling-for-adaboostregressor" title="Permalink to this headline">#</a></h2>
<p>The next example shows how long the python runtime
spends in each operator.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ada</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">()</span>
<span class="n">ada</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">ada</span><span class="p">,</span> <span class="n">X</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python_compiled&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>OnnxInference(...)
    def compiled_run(dict_inputs, yield_ops=None):
        if yield_ops is not None:
            raise NotImplementedError(&#39;yields_ops should be None.&#39;)
        # init: axis_name (axis_name)
        # init: estimators_weights (estimators_weights)
        # init: half_scalar (half_scalar)
        # init: k_value (k_value)
        # init: last_index (last_index)
        # init: negate (negate)
        # init: shape_tensor (shape_tensor)
        # inputs
        X = dict_inputs[&#39;X&#39;]
        (est_label_0, ) = n0_treeensembleregressor_1(X)
        (est_label_3, ) = n1_treeensembleregressor_1(X)
        (est_label_4, ) = n2_treeensembleregressor_1(X)
        (est_label_2, ) = n3_treeensembleregressor_1(X)
        (est_label_1, ) = n4_treeensembleregressor_1(X)
        (est_label_7, ) = n5_treeensembleregressor_1(X)
        (est_label_8, ) = n6_treeensembleregressor_1(X)
        (est_label_5, ) = n7_treeensembleregressor_1(X)
        (est_label_49, ) = n8_treeensembleregressor_1(X)
        (est_label_6, ) = n9_treeensembleregressor_1(X)
        (est_label_9, ) = n10_treeensembleregressor_1(X)
        (est_label_10, ) = n11_treeensembleregressor_1(X)
        (est_label_11, ) = n12_treeensembleregressor_1(X)
        (est_label_13, ) = n13_treeensembleregressor_1(X)
        (est_label_17, ) = n14_treeensembleregressor_1(X)
        (est_label_12, ) = n15_treeensembleregressor_1(X)
        (est_label_16, ) = n16_treeensembleregressor_1(X)
        (est_label_14, ) = n17_treeensembleregressor_1(X)
        (est_label_15, ) = n18_treeensembleregressor_1(X)
        (est_label_21, ) = n19_treeensembleregressor_1(X)
        (est_label_22, ) = n20_treeensembleregressor_1(X)
        (est_label_18, ) = n21_treeensembleregressor_1(X)
        (est_label_19, ) = n22_treeensembleregressor_1(X)
        (est_label_20, ) = n23_treeensembleregressor_1(X)
        (est_label_23, ) = n24_treeensembleregressor_1(X)
        (est_label_29, ) = n25_treeensembleregressor_1(X)
        (est_label_25, ) = n26_treeensembleregressor_1(X)
        (est_label_24, ) = n27_treeensembleregressor_1(X)
        (est_label_26, ) = n28_treeensembleregressor_1(X)
        (est_label_27, ) = n29_treeensembleregressor_1(X)
        (est_label_28, ) = n30_treeensembleregressor_1(X)
        (est_label_34, ) = n31_treeensembleregressor_1(X)
        (est_label_30, ) = n32_treeensembleregressor_1(X)
        (est_label_38, ) = n33_treeensembleregressor_1(X)
        (est_label_31, ) = n34_treeensembleregressor_1(X)
        (est_label_32, ) = n35_treeensembleregressor_1(X)
        (est_label_33, ) = n36_treeensembleregressor_1(X)
        (est_label_37, ) = n37_treeensembleregressor_1(X)
        (est_label_35, ) = n38_treeensembleregressor_1(X)
        (est_label_36, ) = n39_treeensembleregressor_1(X)
        (est_label_40, ) = n40_treeensembleregressor_1(X)
        (est_label_41, ) = n41_treeensembleregressor_1(X)
        (est_label_39, ) = n42_treeensembleregressor_1(X)
        (est_label_48, ) = n43_treeensembleregressor_1(X)
        (est_label_42, ) = n44_treeensembleregressor_1(X)
        (est_label_43, ) = n45_treeensembleregressor_1(X)
        (est_label_44, ) = n46_treeensembleregressor_1(X)
        (est_label_45, ) = n47_treeensembleregressor_1(X)
        (est_label_46, ) = n48_treeensembleregressor_1(X)
        (est_label_47, ) = n49_treeensembleregressor_1(X)
        (concatenated_labels, ) = n50_concat(est_label_0, est_label_1, est_label_2, est_label_3, est_label_4, est_label_5, est_label_6, est_label_7, est_label_8, est_label_9, est_label_10, est_label_11, est_label_12, est_label_13, est_label_14, est_label_15, est_label_16, est_label_17, est_label_18, est_label_19, est_label_20, est_label_21, est_label_22, est_label_23, est_label_24, est_label_25, est_label_26, est_label_27, est_label_28, est_label_29, est_label_30, est_label_31, est_label_32, est_label_33, est_label_34, est_label_35, est_label_36, est_label_37, est_label_38, est_label_39, est_label_40, est_label_41, est_label_42, est_label_43, est_label_44, est_label_45, est_label_46, est_label_47, est_label_48, est_label_49)
        (negated_labels, ) = n51_mul(concatenated_labels, negate)
        (sorted_values, sorted_indices, ) = n52_topk_11(negated_labels, k_value)
        (array_feat_extractor_output, ) = n53_arrayfeatureextractor(estimators_weights, sorted_indices)
        (reshaped_weights, ) = n54_reshape_5(array_feat_extractor_output, shape_tensor)
        (weights_cdf, ) = n55_cumsum(reshaped_weights, axis_name)
        (median_value, ) = n56_arrayfeatureextractor(weights_cdf, last_index)
        (comp_value, ) = n57_mul(median_value, half_scalar)
        (median_or_above, ) = n58_less(weights_cdf, comp_value)
        (cast_result, ) = n59_cast(median_or_above)
        (median_idx, ) = n60_argmin_12(cast_result)
        (median_estimators, ) = n61_gatherelements(sorted_indices, median_idx)
        (variable, ) = n62_gatherelements(concatenated_labels, median_estimators)
        return {
            &#39;variable&#39;: variable,
        }
</pre></div>
</div>
<p>The profiling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">runlocal</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">):</span>
        <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;profiling...&quot;</span><span class="p">)</span>
<span class="n">txt</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">runlocal</span><span class="p">,</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>profiling...

  _     ._   __/__   _ _  _  _ _/_   Recorded: 03:13:07 AM Samples:  17841
 /_//_/// /_\ / //_// / //_&#39;/ //     Duration: 104.887   CPU time: 717.357
/   _/                      v4.1.1

Program: /var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/examples/plot_profile.py

104.886 profile  ../pycode/profiling.py:457
`- 104.886 runlocal  plot_profile.py:72
      [173 frames hidden]  plot_profile, mlprodict, &lt;string&gt;, &lt;b...
         98.604 _run  mlprodict/onnxrt/ops_cpu/op_tree_ensemble_regressor.py:95
         `- 98.600 [self]
</pre></div>
</div>
</section>
<section id="with-a-different-runtime">
<h2><a class="toc-backref" href="#id4">With a different runtime</a><a class="headerlink" href="#with-a-different-runtime" title="Permalink to this headline">#</a></h2>
<p>Let’s compare to <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onx</span><span class="o">.</span><span class="n">ir_version</span> <span class="o">=</span> <span class="n">get_ir_version</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime1&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runlocalort</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">):</span>
        <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">})</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;profiling with onnxruntime...&quot;</span><span class="p">)</span>
<span class="n">txt</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">runlocalort</span><span class="p">,</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>profiling with onnxruntime...

  _     ._   __/__   _ _  _  _ _/_   Recorded: 03:14:55 AM Samples:  500
 /_//_/// /_\ / //_// / //_&#39;/ //     Duration: 1.973     CPU time: 7.877
/   _/                      v4.1.1

Program: /var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/examples/plot_profile.py

1.972 profile  ../pycode/profiling.py:457
`- 1.972 runlocalort  plot_profile.py:91
      [5 frames hidden]  plot_profile, mlprodict
         1.972 run  mlprodict/onnxrt/ops_whole/session.py:98
</pre></div>
</div>
</section>
<section id="py-spy">
<h2><a class="toc-backref" href="#id5">py-spy</a><a class="headerlink" href="#py-spy" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="https://github.com/benfred/py-spy">py-spy</a> may be used to dig into native
functions. An example can be found at:
<a class="reference external" href="http://www.xavierdupre.fr/app/_benchmarks/helpsphinx/onnx/onnx_profiling_reg_adaboost.html#profiling-adaboostregressor">Profiling AdaBoostRegressor</a>.
The last piece of code uses the standard
python profiler.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pr</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">runlocal</span><span class="p">,</span> <span class="n">as_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;namefct&#39;</span><span class="p">,</span> <span class="s1">&#39;cum_tall&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
    <span class="s1">&#39;namefct&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rot</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Simple profiling&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
    <span class="n">la</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_profile_001.png" srcset="../_images/sphx_glr_plot_profile_001.png" alt="Simple profiling" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 2 minutes  0.414 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-profile-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/a1b56031bad1e22b487617e56ed69a9b/plot_profile.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_profile.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/2d6bd2160fdc119ee45745829856fa17/plot_profile.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_profile.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_onnx_benchmark.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Measure ONNX runtime performances</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_grid_search.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Grid search ONNX models</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>