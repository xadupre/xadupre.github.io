
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>TreeEnsembleRegressor and parallelisation &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Notebook Gallery" href="../all_notebooks.html" />
    <link rel="prev" title="Benchmark Random Forests, Tree Ensemble, Multi-Classification" href="plot_opml_random_forest_cls_multi.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, â€¦
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_logistic_regression.html">
   Conversion of a logistic regression into C
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_benchmark.html">
   Measure ONNX runtime performances
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_profile.html">
   Profile the execution of a runtime
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_grid_search.html">
   Grid search ONNX models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_merge_benchmark.html">
   Merges benchmarks
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_speedup_pca.html">
   Speed up scikit-learn inference with ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_time_tree_ensemble.html">
   Benchmark Random Forests, Tree Ensemble
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_numba.html">
   Compares numba, numpy, onnxruntime for simple functions
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_add.html">
   Compares implementations of Add
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemax.html">
   Compares implementations of ReduceMax
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesumsquare.html">
   Compares implementations of ReduceSumSquare
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemean.html">
   Compares implementations of ReduceMean
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_transpose.html">
   Compares implementations of Tranpose
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_parallelism.html">
   When to parallelize?
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesum.html">
   Compares implementations of ReduceSum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_where.html">
   Compares implementations of Where
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_einsum.html">
   Compares implementations of Einsum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_onnx_topk.html">
   TopK benchmark
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_linear_regression.html">
   Benchmark Linear Regression
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_reg.html">
   Benchmark Random Forests, Tree Ensemble, (AoS and SoA)
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_cls_multi.html">
   Benchmark Random Forests, Tree Ensemble, Multi-Classification
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   TreeEnsembleRegressor and parallelisation
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#graph">
   Graph
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scikit-learn-t-trees-vs-1-tree">
   scikit-learn: T trees vs 1 tree
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scikit-learn-against-onnxuntime">
   scikit-learn against onnxuntime
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#zipmap-operator">
   ZipMap operator
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelisation-per-trees">
   Parallelisation per trees
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-class-decisiontreeclassifier">
   Multi-Class DecisionTreeClassifier
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-class-logisticregression">
   Multi-class LogisticRegression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision-tree-and-number-of-features">
   Decision Tree and number of features
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-onnx-tree-ensemble-parallel-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="treeensembleregressor-and-parallelisation">
<span id="onnxtreeensembleparallelrst"></span><span id="sphx-glr-gyexamples-plot-onnx-tree-ensemble-parallel-py"></span><h1><a class="toc-backref" href="#id1">TreeEnsembleRegressor and parallelisation</a><a class="headerlink" href="#treeensembleregressor-and-parallelisation" title="Permalink to this headline">#</a></h1>
<p>The operator <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators-ml.md#ai.onnx.ml.TreeEnsembleClassifier">TreeEnsembleClassifier</a> describe any tree model
(decision tree, random forest, gradient boosting). The runtime
is usually implements in C/C++ and uses parallelisation.
The notebook studies the impact of the parallelisation.</p>
<div class="contents topic" id="local">
<p class="topic-title">:local</p>
<ul class="simple">
<li><p><a class="reference internal" href="#treeensembleregressor-and-parallelisation" id="id1">TreeEnsembleRegressor and parallelisation</a></p>
<ul>
<li><p><a class="reference internal" href="#graph" id="id2">Graph</a></p></li>
<li><p><a class="reference internal" href="#scikit-learn-t-trees-vs-1-tree" id="id3">scikit-learn: T trees vs 1 tree</a></p></li>
<li><p><a class="reference internal" href="#scikit-learn-against-onnxuntime" id="id4">scikit-learn against onnxuntime</a></p></li>
<li><p><a class="reference internal" href="#zipmap-operator" id="id5">ZipMap operator</a></p></li>
<li><p><a class="reference internal" href="#parallelisation-per-trees" id="id6">Parallelisation per trees</a></p></li>
<li><p><a class="reference internal" href="#multi-class-decisiontreeclassifier" id="id7">Multi-Class DecisionTreeClassifier</a></p></li>
<li><p><a class="reference internal" href="#multi-class-logisticregression" id="id8">Multi-class LogisticRegression</a></p></li>
<li><p><a class="reference internal" href="#decision-tree-and-number-of-features" id="id9">Decision Tree and number of features</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="graph">
<h2><a class="toc-backref" href="#id2">Graph</a><a class="headerlink" href="#graph" title="Permalink to this headline">#</a></h2>
<p>The following dummy graph shows the time ratio between two runtimes
depending on the number of observations in a batch (N) and
the number of trees in the forest.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt.validate.validate_benchmark</span> <span class="kn">import</span> <span class="n">benchmark_fct</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mlprodict.plotting.plotting</span> <span class="kn">import</span> <span class="n">plot_benchmark_metrics</span>


<span class="k">def</span> <span class="nf">plot_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;trees&quot;</span><span class="p">,</span> <span class="n">middle</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">,</span> <span class="n">cbar</span> <span class="o">=</span> <span class="n">plot_benchmark_metrics</span><span class="p">(</span>
        <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">middle</span><span class="o">=</span><span class="n">middle</span><span class="p">,</span>
        <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span><span class="p">,</span> <span class="n">cbar_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">shrink</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">0.1</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="mi">1000</span><span class="p">}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plot_metric</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_001.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_001.png" alt="plot onnx tree ensemble parallel" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;trees&#39;, ylabel=&#39;N&#39;&gt;
</pre></div>
</div>
</section>
<section id="scikit-learn-t-trees-vs-1-tree">
<h2><a class="toc-backref" href="#id3">scikit-learn: T trees vs 1 tree</a><a class="headerlink" href="#scikit-learn-t-trees-vs-1-tree" title="Permalink to this headline">#</a></h2>
<p>Letâ€™s do first compare a <em>GradientBoostingClassifier</em> from
<em>scikit-learn</em> with 1 tree against multiple trees.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In[4]:</span>


<span class="n">ntest</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">ntest</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span>
                                     <span class="n">ntest</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ModelToTest</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span>

<span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">ModelToTest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:00&lt;00:00,  4.04it/s]
 40%|####      | 2/5 [00:00&lt;00:00,  3.01it/s]
 60%|######    | 3/5 [00:02&lt;00:02,  1.08s/it]
 80%|########  | 4/5 [00:06&lt;00:02,  2.19s/it]
100%|##########| 5/5 [00:16&lt;00:00,  4.93s/it]
100%|##########| 5/5 [00:16&lt;00:00,  3.26s/it]
</pre></div>
</div>
<p>Benchmark.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">fct1</span><span class="p">,</span> <span class="n">fct2</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">ti</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">r</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="k">with</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">config_context</span><span class="p">(</span><span class="n">assume_finite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># to warm up the engine</span>
        <span class="n">time_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">N</span><span class="p">}</span>
        <span class="n">benchmark_fct</span><span class="p">(</span><span class="n">fct1</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">time_kwargs</span><span class="o">=</span><span class="n">time_kwargs</span><span class="p">,</span> <span class="n">skip_long_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">benchmark_fct</span><span class="p">(</span><span class="n">fct2</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">time_kwargs</span><span class="o">=</span><span class="n">time_kwargs</span><span class="p">,</span> <span class="n">skip_long_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># real measure</span>
        <span class="n">time_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="n">ti</span><span class="p">(</span><span class="n">repeat</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">N</span><span class="p">}</span>
        <span class="n">res1</span> <span class="o">=</span> <span class="n">benchmark_fct</span><span class="p">(</span>
            <span class="n">fct1</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">time_kwargs</span><span class="o">=</span><span class="n">time_kwargs</span><span class="p">,</span> <span class="n">skip_long_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">res2</span> <span class="o">=</span> <span class="n">benchmark_fct</span><span class="p">(</span>
            <span class="n">fct2</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">time_kwargs</span><span class="o">=</span><span class="n">time_kwargs</span><span class="p">,</span> <span class="n">skip_long_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res1</span><span class="p">):</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="s1">&#39;ttime&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r1</span><span class="p">[</span><span class="s1">&#39;ttime&#39;</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">tree_benchmark</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">fct1</span><span class="p">,</span> <span class="n">fct2</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">bench</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fct1</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">fct2</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">bench</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">bench</span>


<span class="n">bench</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                       <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>
                       <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="nb">list</span><span class="p">(</span><span class="n">bench</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:19&lt;01:19, 20.00s/it]
 40%|####      | 2/5 [00:40&lt;01:00, 20.11s/it]
 60%|######    | 3/5 [01:02&lt;00:41, 20.91s/it]
 80%|########  | 4/5 [01:25&lt;00:22, 22.09s/it]
100%|##########| 5/5 [01:55&lt;00:00, 24.93s/it]
100%|##########| 5/5 [01:55&lt;00:00, 23.18s/it]

[((1, 1), 0.9986346594803491), ((10, 1), 1.000348395535168), ((100, 1), 0.9953942470338755)]
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn 1 tree vs scikit-learn T trees</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt; 1 means onnxruntime is faster&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_002.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_002.png" alt="scikit-learn 1 tree vs scikit-learn T trees < 1 means onnxruntime is faster" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn 1 tree vs scikit-learn T trees\n&lt; 1 means onnxruntime is faster&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>As expected, all ratio on first line are close to 1 since
both models are the same. fourth line, second column
(T=20, N=10) means an ensemble with 20 trees is slower to
compute the predictions of 10 observations in a batch compare
to an ensemble with 1 tree.</p>
</section>
<section id="scikit-learn-against-onnxuntime">
<h2><a class="toc-backref" href="#id4">scikit-learn against onnxuntime</a><a class="headerlink" href="#scikit-learn-against-onnxuntime" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">models_onnx</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="n">sess_models</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
               <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">models_onnx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
</pre></div>
</div>
<p>Benchmark.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bench_ort</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">se</span><span class="o">=</span><span class="n">sess_models</span><span class="p">:</span> <span class="n">se</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">bench_ort</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:14&lt;00:58, 14.63s/it]
 40%|####      | 2/5 [00:29&lt;00:44, 14.72s/it]
 60%|######    | 3/5 [00:47&lt;00:32, 16.48s/it]
 80%|########  | 4/5 [01:09&lt;00:18, 18.36s/it]
100%|##########| 5/5 [01:38&lt;00:00, 22.16s/it]
100%|##########| 5/5 [01:38&lt;00:00, 19.62s/it]

{(1, 1): 0.10745178393859103, (10, 1): 0.1256487018625591, (100, 1): 0.29413061224778636, (1000, 1): 1.6953830253872568, (10000, 1): 4.032696513588496, (1, 2): 0.10744041580390046, (10, 2): 0.12590478688372522, (100, 2): 0.29170841342254894, (1000, 2): 1.484850040782813, (10000, 2): 3.4800833828932674, (1, 10): 0.10758366939113244, (10, 10): 0.13529648705810318, (100, 10): 0.36767012043859787, (1000, 10): 1.422193360543461, (10000, 10): 2.3391630275591915, (1, 20): 0.10428142041137484, (10, 20): 0.14255817207527216, (100, 20): 0.33343341282251443, (1000, 20): 1.0493064866002648, (10000, 20): 1.5011176183922992, (1, 50): 0.11016883954942784, (10, 50): 0.18400158144509643, (100, 50): 0.2815831611285774, (1000, 50): 0.6971730823072282, (10000, 50): 0.8666282364382145}
</pre></div>
</div>
<p>Graphs</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_ort</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs onnxruntime</span><span class="se">\n</span><span class="s2"> &lt; 1 &quot;</span>
            <span class="s2">&quot;means onnxruntime is faster&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_003.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_003.png" alt="scikit-learn vs onnxruntime  < 1 means onnxruntime is faster" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn vs onnxruntime\n &lt; 1 means onnxruntime is faster&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>We see onnxruntime is fast for small batches,
still faster but not that much for big batches.</p>
</section>
<section id="zipmap-operator">
<h2><a class="toc-backref" href="#id5">ZipMap operator</a><a class="headerlink" href="#zipmap-operator" title="Permalink to this headline">#</a></h2>
<p>ZipMap just creates a new container for the same results.
The copy may impact the ratio. Letâ€™s remove it from the equation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">models_onnx</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">ModelToTest</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zipmap&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
               <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">sess_models</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
               <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">models_onnx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: Attribute `n_features_` was deprecated in version 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: Attribute `n_features_` was deprecated in version 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: Attribute `n_features_` was deprecated in version 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: Attribute `n_features_` was deprecated in version 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: Attribute `n_features_` was deprecated in version 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
</pre></div>
</div>
<p>Benchmarks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bench_ort</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">se</span><span class="o">=</span><span class="n">sess_models</span><span class="p">:</span> <span class="n">se</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">bench_ort</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:10&lt;00:42, 10.60s/it]
 40%|####      | 2/5 [00:21&lt;00:32, 10.72s/it]
 60%|######    | 3/5 [00:36&lt;00:25, 12.94s/it]
 80%|########  | 4/5 [00:55&lt;00:15, 15.20s/it]
100%|##########| 5/5 [01:23&lt;00:00, 19.72s/it]
100%|##########| 5/5 [01:23&lt;00:00, 16.68s/it]

{(1, 1): 0.09448585496807024, (10, 1): 0.09680629838045533, (100, 1): 0.1086254445101944, (1000, 1): 0.13076143912242422, (10000, 1): 0.18556890807081175, (1, 2): 0.09546326780205351, (10, 2): 0.09934692834764017, (100, 2): 0.10988399373426447, (1000, 2): 0.1401014902356618, (10000, 2): 0.20053310240312405, (1, 10): 0.09573671018544877, (10, 10): 0.10765394426949626, (100, 10): 0.22601054707765633, (1000, 10): 0.7083486281715143, (10000, 10): 1.3244542258030654, (1, 20): 0.09824032456639578, (10, 20): 0.1261986422444393, (100, 20): 0.2208451197123215, (1000, 20): 0.5895464854602973, (10000, 20): 0.9699684044278726, (1, 50): 0.09893464607695, (10, 50): 0.16489086298393657, (100, 50): 0.20215065869758628, (1000, 50): 0.47934368522142734, (10000, 50): 0.7979746960526732}
</pre></div>
</div>
<p>Graphs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_ort</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs onnxruntime (no zipmap)</span><span class="se">\n</span><span class="s2"> &lt; 1 &quot;</span>
            <span class="s2">&quot;means onnxruntime is faster&quot;</span><span class="p">)</span>


<span class="c1"># ZipMap removal significantly improves.</span>
<span class="c1">#</span>
<span class="c1"># Implementation details for mlprodict runtime</span>
<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++</span>
<span class="c1">#</span>
<span class="c1"># The runtime implemented in :epkg:`mlprodict` mostly relies on</span>
<span class="c1"># two files:</span>
<span class="c1"># * `op_tree_ensemble_common_p_agg_.hpp &lt;https://github.com/sdpython/</span>
<span class="c1">#   mlprodict/blob/master/mlprodict/onnxrt/ops_cpu/</span>
<span class="c1">#   op_tree_ensemble_common_p_agg_.hpp&gt;`_</span>
<span class="c1"># * `op_tree_ensemble_common_p_.hpp &lt;https://github.com/sdpython/</span>
<span class="c1">#   mlprodict/blob/master/mlprodict/onnxrt/ops_cpu/</span>
<span class="c1">#   op_tree_ensemble_common_p_.hpp&gt;`_</span>
<span class="c1">#</span>
<span class="c1"># The runtime builds a tree structure, computes the output of every</span>
<span class="c1"># tree and then agregates them. The implementation distringuishes</span>
<span class="c1"># when the batch size contains only 1 observations or many.</span>
<span class="c1"># It parallelizes on the following conditions:</span>
<span class="c1"># * if the batch size $N \geqslant N_0$, it then parallelizes per</span>
<span class="c1">#   observation, asuming every one is independant,</span>
<span class="c1"># * if the batch size $N = 1$ and the number of trees</span>
<span class="c1">#   $T \geqslant T_0$, it then parallelizes per tree.</span>
<span class="c1">#</span>
<span class="c1"># scikit-learn against mlprodict, no parallelisation</span>
<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++</span>


<span class="n">oinf_models</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python_compiled&quot;</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">models_onnx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_004.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_004.png" alt="scikit-learn vs onnxruntime (no zipmap)  < 1 means onnxruntime is faster" class = "sphx-glr-single-img"/><p>Letâ€™s modify the thresholds which trigger the parallelization.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">oinf</span> <span class="ow">in</span> <span class="n">oinf_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_tree_</span> <span class="o">=</span> <span class="mi">10000000</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">10000000</span>
</pre></div>
</div>
<p>Benchmarks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bench_mlp</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">bench_mlp</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:11&lt;00:44, 11.14s/it]
 40%|####      | 2/5 [00:22&lt;00:34, 11.44s/it]
 60%|######    | 3/5 [00:39&lt;00:27, 13.87s/it]
 80%|########  | 4/5 [01:04&lt;00:18, 18.33s/it]
100%|##########| 5/5 [01:52&lt;00:00, 28.80s/it]
100%|##########| 5/5 [01:52&lt;00:00, 22.42s/it]

{(1, 1): 0.05329692893325514, (10, 1): 0.05675549243774483, (100, 1): 0.08190704401532897, (1000, 1): 0.2509185221791713, (10000, 1): 0.5758854139504826, (1, 2): 0.05380513713478591, (10, 2): 0.05874436307533113, (100, 2): 0.09688898182849806, (1000, 2): 0.33408298746375353, (10000, 2): 0.7422296249181807, (1, 10): 0.05523086375486625, (10, 10): 0.07453834356955792, (100, 10): 0.23259609953138785, (1000, 10): 0.9208734744788102, (10000, 10): 1.584152428328549, (1, 20): 0.057772998091162646, (10, 20): 0.10046896484506097, (100, 20): 0.4341042503452291, (1000, 20): 1.5778107871275282, (10000, 20): 2.3569039980967648, (1, 50): 0.06196149473842815, (10, 50): 0.1509092455449356, (100, 50): 0.753463587766876, (1000, 50): 2.1547253679182083, (10000, 50): 2.7640603996695576}
</pre></div>
</div>
<p>Graphs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_mlp</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs mlprodict</span><span class="se">\n</span><span class="s2"> &lt; 1 &quot;</span>
            <span class="s2">&quot;means mlprodict is faster&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_005.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_005.png" alt="scikit-learn vs mlprodict  < 1 means mlprodict is faster" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn vs mlprodict\n &lt; 1 means mlprodict is faster&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>Letâ€™s compare <em>onnxruntime</em> against <em>mlprodict</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bench_mlp_ort</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">se</span><span class="o">=</span><span class="n">sess_models</span><span class="p">:</span> <span class="n">se</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">bench_mlp_ort</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:02&lt;00:08,  2.17s/it]
 40%|####      | 2/5 [00:04&lt;00:07,  2.39s/it]
 60%|######    | 3/5 [00:13&lt;00:10,  5.22s/it]
 80%|########  | 4/5 [00:29&lt;00:09,  9.36s/it]
100%|##########| 5/5 [01:03&lt;00:00, 18.28s/it]
100%|##########| 5/5 [01:03&lt;00:00, 12.62s/it]

{(1, 1): 0.5893220349658057, (10, 1): 0.6091144541739735, (100, 1): 0.799607569656932, (1000, 1): 1.9743801671925296, (10000, 1): 3.338903562471071, (1, 2): 0.5896201485969849, (10, 2): 0.6185937183262247, (100, 2): 0.9270005048626073, (1000, 2): 2.4478991448646537, (10000, 2): 3.9250607016427903, (1, 10): 0.6050932584241883, (10, 10): 0.7300578978767085, (100, 10): 1.002636769457864, (1000, 10): 1.2660143076945343, (10000, 10): 1.5465692143183956, (1, 20): 0.612390100030294, (10, 20): 0.8200480084381241, (100, 20): 1.9615852137989758, (1000, 20): 2.6249647447595255, (10000, 20): 3.1442932008400404, (1, 50): 0.6586467254103388, (10, 50): 0.949798122254939, (100, 50): 3.776302713547626, (1000, 50): 4.486289172842603, (10000, 50): 4.755620292876148}
</pre></div>
</div>
<p>Graphs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_mlp_ort</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;onnxruntime vs mlprodict</span><span class="se">\n</span><span class="s2"> &lt; 1 means &quot;</span>
            <span class="s2">&quot;mlprodict is faster</span><span class="se">\n</span><span class="s2">no parallelisation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_006.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_006.png" alt="onnxruntime vs mlprodict  < 1 means mlprodict is faster no parallelisation" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;onnxruntime vs mlprodict\n &lt; 1 means mlprodict is faster\nno parallelisation&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>This implementation is faster except for high number of trees
or high number of observations. Letâ€™s add parallelisation for
trees and observations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">oinf</span> <span class="ow">in</span> <span class="n">oinf_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_tree_</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">2</span>


<span class="n">bench_mlp_para</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">bench_mlp_para</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:26&lt;01:46, 26.62s/it]
 40%|####      | 2/5 [00:39&lt;00:55, 18.64s/it]
 60%|######    | 3/5 [00:56&lt;00:35, 17.99s/it]
 80%|########  | 4/5 [01:33&lt;00:25, 25.32s/it]
100%|##########| 5/5 [02:02&lt;00:00, 26.82s/it]
100%|##########| 5/5 [02:02&lt;00:00, 24.59s/it]

{(1, 1): 0.05286871725977243, (10, 1): 6.8836192627013215, (100, 1): 2.7051826256812928, (1000, 1): 6.304531775674716, (10000, 1): 2.0916781266975106, (1, 2): 0.052174800194003466, (10, 2): 0.4245193600347045, (100, 2): 0.10330737665213013, (1000, 2): 0.3586718578098879, (10000, 2): 0.8727501553849253, (1, 10): 0.3595197561363624, (10, 10): 0.16090001446710764, (100, 10): 0.09803245947425539, (1000, 10): 0.2987561432191349, (10000, 10): 0.4609569282263275, (1, 20): 2.6150459890946913, (10, 20): 0.19568565239752297, (100, 20): 0.12870933213942387, (1000, 20): 3.315357407201718, (10000, 20): 1.1539759293315635, (1, 50): 0.16129516649014652, (10, 50): 0.2131711372693617, (100, 50): 0.09535758502926563, (1000, 50): 0.1687201599858167, (10000, 50): 0.40372385889738516}
</pre></div>
</div>
<p>Graphs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_mlp_para</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs mlprodict</span><span class="se">\n</span><span class="s2"> &lt; 1 means &quot;</span>
            <span class="s2">&quot;mlprodict is faster</span><span class="se">\n</span><span class="s2">parallelisation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_007.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_007.png" alt="scikit-learn vs mlprodict  < 1 means mlprodict is faster parallelisation" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn vs mlprodict\n &lt; 1 means mlprodict is faster\nparallelisation&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>Parallelisation does improve the computation time when N is big.
Letâ€™s compare with and without parallelisation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bench_para</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bench_mlp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">bench_para</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bench_mlp_para</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">v</span>


<span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_para</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;mlprodict vs mlprodict parallelized</span><span class="se">\n</span><span class="s2"> &lt; 1 &quot;</span>
            <span class="s2">&quot;means parallelisation is faster&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_008.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_008.png" alt="mlprodict vs mlprodict parallelized  < 1 means parallelisation is faster" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;mlprodict vs mlprodict parallelized\n &lt; 1 means parallelisation is faster&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>Parallelisation per trees does not seem to be efficient.
Letâ€™s confirm with a proper benchmark as the previous merges
results from two benchmarks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">oinf</span> <span class="ow">in</span> <span class="n">oinf_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_tree_</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">1000000</span>

<span class="n">oinf_models_para</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python_compiled&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">models_onnx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">oinf</span> <span class="ow">in</span> <span class="n">oinf_models_para</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_tree_</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">bench_mlp_para</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models_para</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">bench_mlp_para</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:04&lt;00:17,  4.41s/it]
 40%|####      | 2/5 [00:08&lt;00:13,  4.49s/it]
 60%|######    | 3/5 [00:55&lt;00:47, 23.58s/it]
 80%|########  | 4/5 [01:57&lt;00:38, 38.85s/it]
100%|##########| 5/5 [03:32&lt;00:00, 59.26s/it]
100%|##########| 5/5 [03:32&lt;00:00, 42.59s/it]

{(1, 1): 0.9814702851892596, (10, 1): 1.1349809875819972, (100, 1): 0.9928452023622985, (1000, 1): 1.5350526512192995, (10000, 1): 2.0063667621480037, (1, 2): 0.9892314395486872, (10, 2): 1.3110492684869148, (100, 2): 1.0643268572542968, (1000, 2): 0.775216557780646, (10000, 2): 0.766604287210717, (1, 10): 35.394059324241304, (10, 10): 16.57050981321819, (100, 10): 11.983899401663496, (1000, 10): 3.458439234031079, (10000, 10): 0.8939209045641269, (1, 20): 33.10061949008491, (10, 20): 5.438875785025879, (100, 20): 8.046452732596087, (1000, 20): 2.928817399089297, (10000, 20): 0.41489277928307733, (1, 50): 7.43391352441265, (10, 50): 28.26673777663611, (100, 50): 6.7056847453653265, (1000, 50): 1.2518029586030024, (10000, 50): 0.25191224661408457}
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_mlp_para</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;mlprodict vs mlprodict parallelized</span><span class="se">\n</span><span class="s2"> &lt; 1 &quot;</span>
            <span class="s2">&quot;means parallelisation is faster</span><span class="se">\n</span><span class="s2">same baseline&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_009.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_009.png" alt="mlprodict vs mlprodict parallelized  < 1 means parallelisation is faster same baseline" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;mlprodict vs mlprodict parallelized\n &lt; 1 means parallelisation is faster\nsame baseline&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;trees&#39;&gt;
</pre></div>
</div>
<p>It should be run on different machines. On the current one,
parallelisation per trees (when N=1) does not seem to help.
Parallelisation for a small number of observations does not
seem to help either. So we need to find some threshold.</p>
</section>
<section id="parallelisation-per-trees">
<h2><a class="toc-backref" href="#id6">Parallelisation per trees</a><a class="headerlink" href="#parallelisation-per-trees" title="Permalink to this headline">#</a></h2>
<p>Letâ€™s study the parallelisation per tree. We need to train new models.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In[33]:</span>


<span class="n">N2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">T2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>

<span class="n">models2</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">T2</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">ModelToTest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models2</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/10 [00:00&lt;?, ?it/s]
 10%|#         | 1/10 [00:00&lt;00:01,  5.08it/s]
 20%|##        | 2/10 [00:00&lt;00:02,  3.20it/s]
 30%|###       | 3/10 [00:02&lt;00:07,  1.07s/it]
 40%|####      | 4/10 [00:12&lt;00:26,  4.49s/it]
 50%|#####     | 5/10 [00:31&lt;00:49,  9.89s/it]
 60%|######    | 6/10 [01:00&lt;01:05, 16.43s/it]
 70%|#######   | 7/10 [01:39&lt;01:11, 23.75s/it]
 80%|########  | 8/10 [02:37&lt;01:09, 34.67s/it]
 90%|######### | 9/10 [03:55&lt;00:47, 47.99s/it]
100%|##########| 10/10 [05:31&lt;00:00, 62.96s/it]
100%|##########| 10/10 [05:31&lt;00:00, 33.15s/it]
</pre></div>
</div>
<p>Conversion to ONNX.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">models2_onnx</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models2</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">oinf_models2</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python_compiled&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">models2_onnx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">oinf</span> <span class="ow">in</span> <span class="n">oinf_models2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_tree_</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">1000000</span>

<span class="n">oinf_models2_para</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">OnnxInference</span><span class="p">(</span>
    <span class="n">mo</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python_compiled&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">models2_onnx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">oinf</span> <span class="ow">in</span> <span class="n">oinf_models2_para</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_tree_</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
/var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_venv/lib/python3.9/site-packages/sklearn/utils/deprecation.py:103: FutureWarning: The attribute `n_features_` is deprecated in 1.0 and will be removed in 1.2. Use `n_features_in_` instead.
  warnings.warn(msg, category=FutureWarning)
</pre></div>
</div>
<p>And benchmark.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In[36]:</span>


<span class="n">bench_mlp_tree</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models2</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t_</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">oi</span><span class="o">=</span><span class="n">oinf_models2_para</span><span class="p">:</span> <span class="n">oi</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
    <span class="n">T2</span><span class="p">,</span> <span class="n">N2</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">bench_mlp_tree</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/10 [00:00&lt;?, ?it/s]
 10%|#         | 1/10 [00:02&lt;00:22,  2.51s/it]
 20%|##        | 2/10 [00:05&lt;00:20,  2.53s/it]
 30%|###       | 3/10 [00:08&lt;00:19,  2.85s/it]
 40%|####      | 4/10 [00:12&lt;00:19,  3.27s/it]
 50%|#####     | 5/10 [00:16&lt;00:18,  3.77s/it]
 60%|######    | 6/10 [00:22&lt;00:17,  4.40s/it]
 70%|#######   | 7/10 [00:29&lt;00:16,  5.34s/it]
 80%|########  | 8/10 [00:42&lt;00:15,  7.66s/it]
 90%|######### | 9/10 [01:02&lt;00:11, 11.68s/it]
100%|##########| 10/10 [01:30&lt;00:00, 16.59s/it]
100%|##########| 10/10 [01:30&lt;00:00,  9.05s/it]

{(1, 1): 0.9927936818905806, (10, 1): 0.9968264695530976, (1, 2): 0.9923687561932233, (10, 2): 1.0011225234290904, (1, 10): 1.4462865381872163, (10, 10): 1.2054182092411687, (1, 50): 1.3939569791705835, (10, 50): 0.5026028687581705, (1, 100): 1.2273188849034524, (10, 100): 0.5754709138694123, (1, 150): 1.1056823249565848, (10, 150): 0.33073248697201924, (1, 200): 0.9600105168154409, (10, 200): 0.21742443723986216, (1, 300): 0.5424269336138723, (10, 300): 0.1262200263139531, (1, 400): 0.33475411810238914, (10, 400): 0.0982592992181812, (1, 500): 0.24573234555118537, (10, 500): 0.08573930289168043}
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span>
    <span class="n">bench_mlp_tree</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;mlprodict vs mlprodict parallelized</span><span class="se">\n</span><span class="s2"> &lt; 1 means parallelisation &quot;</span>
    <span class="s2">&quot;is faster&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_010.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_010.png" alt="mlprodict vs mlprodict parallelized  < 1 means parallelisation is faster" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;mlprodict vs mlprodict parallelized\n &lt; 1 means parallelisation is faster&#39;}, xlabel=&#39;trees&#39;, ylabel=&#39;N&#39;&gt;
</pre></div>
</div>
<p>The parallelisation starts to be below 1 after 400 trees.
For 10 observations, there is no parallelisation neither by
trees nor by observations. Ratios are close to 1.
The gain obviously depends on the tree depth. You can
try with a different max depth and the number of trees
parallelisation becomes interesting depending on the tree depth.</p>
</section>
<section id="multi-class-decisiontreeclassifier">
<h2><a class="toc-backref" href="#id7">Multi-Class DecisionTreeClassifier</a><a class="headerlink" href="#multi-class-decisiontreeclassifier" title="Permalink to this headline">#</a></h2>
<p>Same experiment when the number of tree is 1 but then we
change the number of classes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ModelToTest</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span>

<span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="n">trees</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>

    <span class="n">ntest</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">ntest</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="n">cl</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:])</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">ModelToTest</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">monnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">monnx</span><span class="p">)</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">trees</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> <span class="n">X32</span><span class="o">=</span><span class="n">X32</span><span class="p">,</span> <span class="n">monnx</span><span class="o">=</span><span class="n">monnx</span><span class="p">,</span> <span class="n">oinf</span><span class="o">=</span><span class="n">oinf</span><span class="p">)</span>


<span class="n">bench_dt</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cl</span><span class="p">:</span> <span class="n">trees</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="s1">&#39;X32&#39;</span><span class="p">],</span>
                          <span class="k">lambda</span> <span class="n">cl</span><span class="p">:</span> <span class="n">trees</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
                          <span class="k">lambda</span> <span class="n">cl</span><span class="p">:</span> <span class="p">(</span>
                              <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cl</span><span class="p">:</span> <span class="n">trees</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;oinf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
                          <span class="n">C</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">bench_dt</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/8 [00:00&lt;?, ?it/s]
 12%|#2        | 1/8 [00:00&lt;00:02,  2.58it/s]
 25%|##5       | 2/8 [00:00&lt;00:02,  2.51it/s]
 38%|###7      | 3/8 [00:01&lt;00:02,  2.35it/s]
 50%|#####     | 4/8 [00:01&lt;00:01,  2.20it/s]
 62%|######2   | 5/8 [00:02&lt;00:01,  2.05it/s]
 75%|#######5  | 6/8 [00:02&lt;00:01,  1.84it/s]
 88%|########7 | 7/8 [00:03&lt;00:00,  1.64it/s]
100%|##########| 8/8 [00:04&lt;00:00,  1.48it/s]
100%|##########| 8/8 [00:04&lt;00:00,  1.77it/s]

  0%|          | 0/8 [00:00&lt;?, ?it/s]
 12%|#2        | 1/8 [00:05&lt;00:38,  5.48s/it]
 25%|##5       | 2/8 [00:11&lt;00:34,  5.72s/it]
 38%|###7      | 3/8 [00:17&lt;00:29,  5.98s/it]
 50%|#####     | 4/8 [00:24&lt;00:25,  6.28s/it]
 62%|######2   | 5/8 [00:31&lt;00:19,  6.59s/it]
 75%|#######5  | 6/8 [00:39&lt;00:14,  7.04s/it]
 88%|########7 | 7/8 [00:48&lt;00:07,  7.55s/it]
100%|##########| 8/8 [00:57&lt;00:00,  8.14s/it]
100%|##########| 8/8 [00:57&lt;00:00,  7.18s/it]

{(1, 2): 0.4797342973574218, (10, 2): 0.47049579850966655, (100, 2): 0.49612963846051455, (1000, 2): 0.6612060813826067, (10000, 2): 0.8796205261312893, (1, 5): 0.47181775759092415, (10, 5): 0.4732894046438794, (100, 5): 0.5149854509394224, (1000, 5): 0.6969026986133698, (10000, 5): 0.8513474370911395, (1, 10): 0.47033357116727087, (10, 10): 0.4721873368613484, (100, 10): 0.511473745800736, (1000, 10): 0.6712626862068822, (10000, 10): 0.8176465855016496, (1, 15): 0.4698205472865529, (10, 15): 0.4639644814668912, (100, 15): 0.5137198248183148, (1000, 15): 0.6700404267711422, (10000, 15): 0.8032539834158782, (1, 20): 0.4763801009988098, (10, 20): 0.47083447577219606, (100, 20): 0.5222021660472781, (1000, 20): 0.655810132576266, (10000, 20): 0.7756895099956939, (1, 30): 0.4727421602667013, (10, 30): 0.48001813793521286, (100, 30): 0.522948605017639, (1000, 30): 0.630522533929567, (10000, 30): 0.7400039747423744, (1, 40): 0.4750104498191635, (10, 40): 0.48023209895808194, (100, 40): 0.5386999036873503, (1000, 40): 0.6360562553863544, (10000, 40): 0.7526225445842833, (1, 50): 0.49382857269923747, (10, 50): 0.480849479800001, (100, 50): 0.537547199304846, (1000, 50): 0.6213147038977004, (10000, 50): 0.7514933133057422}
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_dt</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;classes&quot;</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs mlprodict (DecisionTreeClassifier) </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt; 1 means mlprodict is faster</span><span class="se">\n</span><span class="s2"> no parallelisation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_011.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_011.png" alt="scikit-learn vs mlprodict (DecisionTreeClassifier)  < 1 means mlprodict is faster  no parallelisation" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn vs mlprodict (DecisionTreeClassifier) \n&lt; 1 means mlprodict is faster\n no parallelisation&#39;}, xlabel=&#39;classes&#39;, ylabel=&#39;N&#39;&gt;
</pre></div>
</div>
</section>
<section id="multi-class-logisticregression">
<h2><a class="toc-backref" href="#id8">Multi-class LogisticRegression</a><a class="headerlink" href="#multi-class-logisticregression" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ModelToTest</span> <span class="o">=</span> <span class="n">LogisticRegression</span>

<span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>

    <span class="n">ntest</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">ntest</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="n">cl</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:])</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ModelToTest</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">monnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">monnx</span><span class="p">)</span>
    <span class="n">models</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
                      <span class="n">X32</span><span class="o">=</span><span class="n">X32</span><span class="p">,</span> <span class="n">monnx</span><span class="o">=</span><span class="n">monnx</span><span class="p">,</span> <span class="n">oinf</span><span class="o">=</span><span class="n">oinf</span><span class="p">)</span>


<span class="n">bench_lr</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cl</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="s1">&#39;X32&#39;</span><span class="p">],</span>
                          <span class="k">lambda</span> <span class="n">cl</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
                          <span class="k">lambda</span> <span class="n">cl</span><span class="p">:</span> <span class="p">(</span>
                              <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cl</span><span class="p">:</span> <span class="n">trees</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;oinf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span>
                          <span class="n">C</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">bench_lr</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:00&lt;00:01,  2.86it/s]
 40%|####      | 2/5 [00:01&lt;00:01,  1.57it/s]
 60%|######    | 3/5 [00:02&lt;00:01,  1.35it/s]
 80%|########  | 4/5 [00:03&lt;00:01,  1.02s/it]
100%|##########| 5/5 [00:05&lt;00:00,  1.26s/it]
100%|##########| 5/5 [00:05&lt;00:00,  1.04s/it]

  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:05&lt;00:23,  5.95s/it]
 40%|####      | 2/5 [00:14&lt;00:22,  7.46s/it]
 60%|######    | 3/5 [00:24&lt;00:17,  8.69s/it]
 80%|########  | 4/5 [00:36&lt;00:09,  9.83s/it]
100%|##########| 5/5 [00:49&lt;00:00, 11.11s/it]
100%|##########| 5/5 [00:49&lt;00:00,  9.92s/it]

{(1, 2): 0.3849319770884322, (10, 2): 0.40000987494648116, (100, 2): 0.43899778090911046, (1000, 2): 0.6474817832338519, (10000, 2): 1.0765846661654122, (1, 5): 0.3312081925564331, (10, 5): 0.3198861175396883, (100, 5): 0.3173678802718868, (1000, 5): 0.30756030549891666, (10000, 5): 0.30548624900466753, (1, 10): 0.3275660638395715, (10, 10): 0.3162654061095607, (100, 10): 0.29416226629923015, (1000, 10): 0.24986670203387762, (10000, 10): 0.23724662930264473, (1, 15): 0.3260647910819572, (10, 15): 0.3078937501594963, (100, 15): 0.28067428532487915, (1000, 15): 0.22220749365205916, (10000, 15): 0.21927784613582538, (1, 20): 0.3304397188627888, (10, 20): 0.3045965221312652, (100, 20): 0.2589541420752453, (1000, 20): 0.19489912740528315, (10000, 20): 0.18057346738584967}
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span><span class="n">bench_lr</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;classes&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs mlprodict (LogisticRegression) </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt; 1 means mlprodict is faster</span><span class="se">\n</span><span class="s2"> no parallelisation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_012.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_012.png" alt="scikit-learn vs mlprodict (LogisticRegression)  < 1 means mlprodict is faster  no parallelisation" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn vs mlprodict (LogisticRegression) \n&lt; 1 means mlprodict is faster\n no parallelisation&#39;}, xlabel=&#39;N&#39;, ylabel=&#39;classes&#39;&gt;
</pre></div>
</div>
</section>
<section id="decision-tree-and-number-of-features">
<h2><a class="toc-backref" href="#id9">Decision Tree and number of features</a><a class="headerlink" href="#decision-tree-and-number-of-features" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ModelToTest</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span>

<span class="n">NF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">50000</span><span class="p">]</span>
<span class="n">trees_nf</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">nf</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
    <span class="n">ntest</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">ntest</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="n">nf</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="n">nf</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_repeated</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="n">ntest</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">ntest</span><span class="p">:])</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">ModelToTest</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">monnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">monnx</span><span class="p">)</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">trees_nf</span><span class="p">[</span><span class="n">nf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
                        <span class="n">X32</span><span class="o">=</span><span class="n">X32</span><span class="p">,</span> <span class="n">monnx</span><span class="o">=</span><span class="n">monnx</span><span class="p">,</span> <span class="n">oinf</span><span class="o">=</span><span class="n">oinf</span><span class="p">)</span>


<span class="n">bench_dt_nf</span> <span class="o">=</span> <span class="n">tree_benchmark</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">nf</span><span class="p">:</span> <span class="n">trees_nf</span><span class="p">[</span><span class="n">nf</span><span class="p">][</span><span class="s1">&#39;X32&#39;</span><span class="p">],</span>
    <span class="k">lambda</span> <span class="n">nf</span><span class="p">:</span> <span class="n">trees_nf</span><span class="p">[</span><span class="n">nf</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">nf</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">nf</span><span class="p">:</span> <span class="n">trees_nf</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;oinf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})),</span> <span class="n">NF</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">bench_dt_nf</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/10 [00:00&lt;?, ?it/s]
 10%|#         | 1/10 [00:00&lt;00:01,  7.73it/s]
 20%|##        | 2/10 [00:00&lt;00:01,  4.07it/s]
 30%|###       | 3/10 [00:01&lt;00:02,  2.52it/s]
 40%|####      | 4/10 [00:02&lt;00:04,  1.50it/s]
 50%|#####     | 5/10 [00:03&lt;00:04,  1.10it/s]
 60%|######    | 6/10 [00:05&lt;00:04,  1.22s/it]
 70%|#######   | 7/10 [00:07&lt;00:05,  1.68s/it]
 80%|########  | 8/10 [00:13&lt;00:05,  2.80s/it]
 90%|######### | 9/10 [00:26&lt;00:06,  6.09s/it]
100%|##########| 10/10 [00:54&lt;00:00, 12.89s/it]
100%|##########| 10/10 [00:54&lt;00:00,  5.45s/it]

  0%|          | 0/10 [00:00&lt;?, ?it/s]
 10%|#         | 1/10 [00:09&lt;01:25,  9.47s/it]
 20%|##        | 2/10 [00:18&lt;01:15,  9.50s/it]
 30%|###       | 3/10 [00:28&lt;01:07,  9.64s/it]
 40%|####      | 4/10 [00:38&lt;00:58,  9.77s/it]
 50%|#####     | 5/10 [00:48&lt;00:49,  9.90s/it]
 60%|######    | 6/10 [00:59&lt;00:40, 10.02s/it]
 70%|#######   | 7/10 [01:09&lt;00:30, 10.26s/it]
 80%|########  | 8/10 [01:22&lt;00:22, 11.10s/it]
 90%|######### | 9/10 [01:40&lt;00:13, 13.20s/it]
100%|##########| 10/10 [02:05&lt;00:00, 16.75s/it]
100%|##########| 10/10 [02:05&lt;00:00, 12.53s/it]

{(1, 2): 0.4776332354278456, (10, 2): 0.4692195482661804, (100, 2): 0.49362311452626034, (1000, 2): 0.6729299555356348, (10000, 2): 0.9008069903707812, (50000, 2): 0.9640361596292094, (1, 10): 0.4731625499035755, (10, 10): 0.4701336040440532, (100, 10): 0.49326926942596233, (1000, 10): 0.6642829779256914, (10000, 10): 0.8805757475377772, (50000, 10): 0.9555824669691629, (1, 20): 0.470749869976751, (10, 20): 0.4694689450911203, (100, 20): 0.49654244410721976, (1000, 20): 0.6693912442043274, (10000, 20): 0.8960895847292957, (50000, 20): 0.9683079072843285, (1, 40): 0.4727913763163058, (10, 40): 0.4714507865555438, (100, 40): 0.49513587047524377, (1000, 40): 0.6488184994810332, (10000, 40): 0.8997938154239181, (50000, 40): 0.9627073651244736, (1, 50): 0.4745428864139398, (10, 50): 0.47241674682669704, (100, 50): 0.4943855596826769, (1000, 50): 0.6531426512411326, (10000, 50): 0.9146066210668232, (50000, 50): 0.9774591868678737, (1, 70): 0.46770308500954727, (10, 70): 0.46504726148050135, (100, 70): 0.49208565441665586, (1000, 70): 0.6093315570263641, (10000, 70): 0.9123305069459965, (50000, 70): 0.9772175620711291, (1, 100): 0.47050733635602043, (10, 100): 0.47104984137624273, (100, 100): 0.49744894928230776, (1000, 100): 0.5851790598235195, (10000, 100): 0.9241194391666269, (50000, 100): 0.9811391312700085, (1, 200): 0.47400925296614826, (10, 200): 0.4730930699964868, (100, 200): 0.5044502419971014, (1000, 200): 0.6336783573561434, (10000, 200): 0.9452813676052982, (50000, 200): 0.9908880754435826, (1, 500): 0.46998171724778653, (10, 500): 0.46685124096078334, (100, 500): 0.4935649625882642, (1000, 500): 0.7666350918734185, (10000, 500): 1.0583588012354055, (50000, 500): 1.1012157646066973, (1, 1000): 0.4685314547758537, (10, 1000): 0.46659779513157285, (100, 1000): 0.47082223754292635, (1000, 1000): 0.8156968221318556, (10000, 1000): 1.1081539869632016, (50000, 1000): 1.1551583974971333}
</pre></div>
</div>
<p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_metric</span><span class="p">(</span>
    <span class="n">bench_dt_nf</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;number of features&quot;</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;scikit-learn vs mlprodict (DecisionTreeClassifier) </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;&lt; 1 means mlprodict is faster</span><span class="se">\n</span><span class="s2"> no parallelisation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_013.png" srcset="../_images/sphx_glr_plot_onnx_tree_ensemble_parallel_013.png" alt="scikit-learn vs mlprodict (DecisionTreeClassifier)  < 1 means mlprodict is faster  no parallelisation" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;scikit-learn vs mlprodict (DecisionTreeClassifier) \n&lt; 1 means mlprodict is faster\n no parallelisation&#39;}, xlabel=&#39;number of features&#39;, ylabel=&#39;N&#39;&gt;
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 26 minutes  50.880 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-onnx-tree-ensemble-parallel-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/88b09cdf660a2333279e24722c2f48e1/plot_onnx_tree_ensemble_parallel.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_onnx_tree_ensemble_parallel.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/0774d96771cb2c94ea57e2eb405b9165/plot_onnx_tree_ensemble_parallel.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_onnx_tree_ensemble_parallel.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_opml_random_forest_cls_multi.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Benchmark Random Forests, Tree Ensemble, Multi-Classification</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../all_notebooks.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Notebook Gallery</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier DuprÃ©.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>