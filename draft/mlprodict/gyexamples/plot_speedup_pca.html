
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Speed up scikit-learn inference with ONNX &#8212; Python Runtime for ONNX</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Benchmark Random Forests, Tree Ensemble" href="plot_time_tree_ensemble.html" />
    <link rel="prev" title="Merges benchmarks" href="plot_op_merge_benchmark.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_logistic_regression.html">
   Conversion of a logistic regression into C
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_benchmark.html">
   Measure ONNX runtime performances
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_profile.html">
   Profile the execution of a runtime
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_grid_search.html">
   Grid search ONNX models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_merge_benchmark.html">
   Merges benchmarks
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Speed up scikit-learn inference with ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_time_tree_ensemble.html">
   Benchmark Random Forests, Tree Ensemble
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_numba.html">
   Compares numba, numpy, onnxruntime for simple functions
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_add.html">
   Compares implementations of Add
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemax.html">
   Compares implementations of ReduceMax
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesumsquare.html">
   Compares implementations of ReduceSumSquare
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemean.html">
   Compares implementations of ReduceMean
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_transpose.html">
   Compares implementations of Tranpose
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_parallelism.html">
   When to parallelize?
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesum.html">
   Compares implementations of ReduceSum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_where.html">
   Compares implementations of Where
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_einsum.html">
   Compares implementations of Einsum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_onnx_topk.html">
   TopK benchmark
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_linear_regression.html">
   Benchmark Linear Regression
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_reg.html">
   Benchmark Random Forests, Tree Ensemble, (AoS and SoA)
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_cls_multi.html">
   Benchmark Random Forests, Tree Ensemble, Multi-Classification
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_tree_ensemble_parallel.html">
   TreeEnsembleRegressor and parallelisation
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pca">
   PCA
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-speedup-pca-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="speed-up-scikit-learn-inference-with-onnx">
<span id="l-speedup-pca"></span><span id="sphx-glr-gyexamples-plot-speedup-pca-py"></span><h1>Speed up scikit-learn inference with ONNX<a class="headerlink" href="#speed-up-scikit-learn-inference-with-onnx" title="Permalink to this headline">#</a></h1>
<p>Is it possible to make <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> faster with ONNX?
That’s question this example tries to answer. The scenario is
is the following:</p>
<ul class="simple">
<li><p>a model is trained</p></li>
<li><p>it is converted into ONNX for inference</p></li>
<li><p>it selects a runtime to compute the prediction</p></li>
</ul>
<p>The following runtime are tested:</p>
<ul class="simple">
<li><p><cite>python</cite>: python runtime for ONNX</p></li>
<li><p><cite>onnxruntime1</cite>: <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime</a></p></li>
<li><p><cite>numpy</cite>: the ONNX graph is converted into numpy code</p></li>
<li><p><cite>numba</cite>: the numpy code is accelerated with <a class="reference external" href="https://numba.org/">numba</a>.</p></li>
</ul>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#pca" id="id1">PCA</a></p></li>
</ul>
</div>
<section id="pca">
<h2><a class="toc-backref" href="#id1">PCA</a><a class="headerlink" href="#pca" title="Permalink to this headline">#</a></h2>
<p>Let’s look at a very simple model, a PCA.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile</span>
<span class="kn">from</span> <span class="nn">mlprodict.sklapi</span> <span class="kn">import</span> <span class="n">OnnxSpeedupTransformer</span>
<span class="kn">from</span> <span class="nn">cpyquickhelper.numbers.speed_measure</span> <span class="kn">import</span> <span class="n">measure_time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
<p>Data and models to test.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">OnnxSpeedupTransformer</span><span class="p">(</span>
        <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;onnxruntime1&#39;</span><span class="p">,</span> <span class="n">OnnxSpeedupTransformer</span><span class="p">(</span>
        <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;onnxruntime1&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">OnnxSpeedupTransformer</span><span class="p">(</span>
        <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;numba&#39;</span><span class="p">,</span> <span class="n">OnnxSpeedupTransformer</span><span class="p">(</span>
        <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;numba&#39;</span><span class="p">))]</span>
</pre></div>
</div>
<p>Training.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:00&lt;00:00,  7.80it/s]
 60%|######    | 3/5 [00:00&lt;00:00, 10.66it/s]
100%|##########| 5/5 [00:07&lt;00:00,  1.83s/it]
100%|##########| 5/5 [00:07&lt;00:00,  1.45s/it]
</pre></div>
</div>
<p>Profiling of runtime <cite>onnxruntime1</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fct</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">models</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">fct</span><span class="p">,</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  _     ._   __/__   _ _  _  _ _/_   Recorded: 03:15:13 AM Samples:  505
 /_//_/// /_\ / //_// / //_&#39;/ //     Duration: 0.639     CPU time: 2.550
/   _/                      v4.1.1

Program: /var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/examples/plot_speedup_pca.py

0.639 profile  ../pycode/profiling.py:457
`- 0.639 fct  plot_speedup_pca.py:67
      [13 frames hidden]  plot_speedup_pca, mlprodict
         0.631 run  mlprodict/onnxrt/ops_whole/session.py:98
</pre></div>
</div>
<p>Profiling of runtime <cite>numpy</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fct</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">models</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">fct</span><span class="p">,</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  _     ._   __/__   _ _  _  _ _/_   Recorded: 03:15:14 AM Samples:  320
 /_//_/// /_\ / //_// / //_&#39;/ //     Duration: 0.332     CPU time: 0.332
/   _/                      v4.1.1

Program: /var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/examples/plot_speedup_pca.py

0.331 profile  ../pycode/profiling.py:457
`- 0.331 fct  plot_speedup_pca.py:79
      [16 frames hidden]  plot_speedup_pca, mlprodict, sklearn,...
         0.280 numpy_mlprodict_ONNX_PCA  &lt;string&gt;:11
         |- 0.141 [self]
         |- 0.131 array  &lt;built-in&gt;:0
</pre></div>
</div>
<p>The class <em>OnnxSpeedupTransformer</em> converts the PCA
into ONNX and then converts it into a python code using
<em>numpy</em>. The code is the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy_code_</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>import numpy
import scipy.special as scipy_special
import scipy.spatial.distance as scipy_distance
from mlprodict.onnx_tools.exports.numpy_helper import (
    argmax_use_numpy_select_last_index,
    argmin_use_numpy_select_last_index,
    array_feature_extrator,
    make_slice)


def numpy_mlprodict_ONNX_PCA(X):
    &#39;&#39;&#39;
    Numpy function for ``mlprodict_ONNX_PCA``.

    * producer: skl2onnx
    * version: 0
    * description:
    &#39;&#39;&#39;
    # initializers

    list_value = [0.03522588685154915, -0.04391317069530487, -0.3019331097602844, -0.08857168257236481, -0.04125336557626724, -0.1372506469488144, -0.15545883774757385, -0.29013821482658386, -0.2170533686876297, -0.009242745116353035, 0.028533577919006348, 0.0418868213891983, 0.09391921758651733, -0.673380434513092, 0.4197906255722046, -0.36630380153656006, -0.21160711348056793, 0.028479784727096558, -0.07911509275436401, 0.05429431051015854, -0.016461068764328957, -0.08221270889043808, 0.3420103192329407, -0.18598555028438568, 0.15762969851493835, 0.46943679451942444, 0.3404766917228699, -0.3100897967815399, -0.18107417225837708, 0.08803647756576538, 0.39513328671455383, 0.03356841951608658, -0.05867309123277664, 0.4098595976829529, 0.26771920919418335, 0.025141030550003052, -0.0803273618221283, -0.28375062346458435, 0.056819431483745575, -0.21815301477909088, -0.31348809599876404, -0.24914886057376862, -0.08464746177196503, 0.04204845428466797, -0.25113722681999207, 0.09550014138221741, -0.4219156503677368, -0.13716453313827515, -0.20961827039718628, 0.06006816029548645, 0.02216215245425701, -0.3065590560436249, 0.23661229014396667, 0.20935629308223724, -0.1726744920015335, -0.36021891236305237, 0.024149619042873383, 0.06666494160890579, 0.1875750720500946, 0.5891869068145752, 0.052102379500865936, 0.1691839098930359, -0.010547593235969543, -0.05830360949039459, -0.2233782708644867, -0.04592195153236389, -0.07198181748390198, -0.3452170491218567, -0.17131690680980682, 0.1980271339416504, -0.1746671050786972, -0.09624757617712021, 0.15323825180530548, 0.44910112023353577, 0.5162782669067383, -0.21690776944160461, -0.05309027433395386, 0.08803343772888184, -0.20859375596046448, -0.06328219920396805, -0.3302276134490967, 0.1708548367023468, -0.06401528418064117, 0.04334565997123718, -0.09085354208946228, -0.3452633023262024, 0.11034107208251953, -0.32488223910331726, -0.18863177299499512, -0.38356223702430725, 0.4194985628128052, 0.07467803359031677, -0.2680917978286743, 0.05319248139858246, -0.011900395154953003, 0.16783447563648224, 0.13117912411689758, 0.010787688195705414, -0.15326648950576782, 0.15091925859451294,
                  0.05567193403840065, -0.5821548104286194, -0.005654362961649895, -0.13977614045143127, 0.08097386360168457, 0.20613563060760498, -0.2828896641731262, 0.12731046974658966, 0.06732460111379623, -0.20602290332317352, 0.0016411282122135162, 0.20149409770965576, 0.44979655742645264, 0.11433097720146179, -0.2531198263168335, 0.055678918957710266, -0.27453410625457764, 0.30891719460487366, -0.057148516178131104, -0.352786123752594, 0.2109539806842804, -0.17314523458480835, 0.5185893177986145, -0.07017163932323456, -0.2076755166053772, -0.25260186195373535, 0.20356816053390503, -0.36128267645835876, 0.10138076543807983, -0.16016840934753418, 0.3096393048763275, -0.32698506116867065, 0.02671171724796295, -0.014824658632278442, 0.02823743224143982, -0.10258353501558304, -0.11335937678813934, -0.12684054672718048, 0.0032808110117912292, -0.22259417176246643, 0.030816804617643356, 0.19896170496940613, 0.12073422968387604, -0.0027247369289398193, 0.2638765573501587, -0.11494152247905731, 0.15325583517551422, 0.20857945084571838, -0.06654155254364014, 0.0842096135020256, 0.17692816257476807, -0.0732412189245224, -0.11389152705669403, 0.028294242918491364, 0.1814122498035431, -0.07548843324184418, -0.13339780271053314, -0.17244917154312134, 0.13185881078243256, 0.047141265124082565, -0.4110371172428131, -0.008370316587388515, 0.07260086387395859, 0.15411722660064697, 0.26084113121032715, 0.15544359385967255, -0.1315050572156906, -0.3465263843536377, 0.22994205355644226, 0.21516229212284088, -0.2586739957332611, -0.41148707270622253, -0.19924192130565643, -0.03929010406136513, 0.018542705103754997, -0.02322215959429741, 0.5503065586090088, 0.1206894963979721, -0.04807346314191818, -0.21227966248989105, 0.07046424597501755, -0.09622500091791153, 0.21259407699108124, 0.06374454498291016, 0.049957338720560074, 0.1281668096780777, -0.062413424253463745, 0.05819839984178543, -0.7248937487602234, 0.1750917285680771, -0.08923415094614029, 0.1404252052307129, 0.16485461592674255, -0.11322721838951111, 0.14091645181179047, 0.33257782459259033, -0.13305926322937012, -0.11384911835193634, 0.28106456995010376, -0.06577727943658829]
    B = numpy.array(list_value, dtype=numpy.float32).reshape((20, 10))

    list_value = [-0.011537947691977024, -0.053047001361846924, 0.00043868148350156844, 0.021356476470828056, 0.04350115731358528, -0.020801274105906487, -0.003591367742046714, 0.08736559003591537, -0.003987821284681559, 0.027182267978787422, -
                  0.008783889003098011, -0.05426081269979477, -0.02160467393696308, -0.02549884095788002, 0.03422679752111435, 0.007602499797940254, -0.029017562046647072, -0.06731828302145004, -0.015037109144032001, 0.030689967796206474]
    C = numpy.array(list_value, dtype=numpy.float32)

    # nodes

    D = X - C
    variable = D @ B

    return variable
</pre></div>
</div>
<p>Benchmark.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bench</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">200000</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># We run it a first time (numba compiles</span>
        <span class="c1"># the function during the first execution).</span>
        <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">})</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">bench</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">bench</span><span class="p">)</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">)</span>
<span class="n">piv</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5 [00:00&lt;?, ?it/s]
 20%|##        | 1/5 [00:39&lt;02:37, 39.33s/it]
 40%|####      | 2/5 [01:07&lt;01:38, 32.96s/it]
 60%|######    | 3/5 [01:21&lt;00:48, 24.17s/it]
 80%|########  | 4/5 [01:47&lt;00:25, 25.07s/it]
100%|##########| 5/5 [02:19&lt;00:00, 27.40s/it]
100%|##########| 5/5 [02:19&lt;00:00, 27.90s/it]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>numba</th>
      <th>numpy</th>
      <th>onnxruntime1</th>
      <th>python</th>
      <th>sklearn</th>
    </tr>
    <tr>
      <th>size</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.000026</td>
      <td>0.000103</td>
      <td>0.000297</td>
      <td>0.000195</td>
      <td>0.000280</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.000031</td>
      <td>0.000109</td>
      <td>0.000295</td>
      <td>0.000180</td>
      <td>0.000289</td>
    </tr>
    <tr>
      <th>100</th>
      <td>0.000048</td>
      <td>0.000129</td>
      <td>0.000335</td>
      <td>0.000191</td>
      <td>0.000326</td>
    </tr>
    <tr>
      <th>1000</th>
      <td>0.000193</td>
      <td>0.000285</td>
      <td>0.000539</td>
      <td>0.000356</td>
      <td>0.000586</td>
    </tr>
    <tr>
      <th>10000</th>
      <td>0.001769</td>
      <td>0.001876</td>
      <td>0.001425</td>
      <td>0.002232</td>
      <td>0.002843</td>
    </tr>
    <tr>
      <th>100000</th>
      <td>0.013270</td>
      <td>0.016511</td>
      <td>0.007728</td>
      <td>0.017223</td>
      <td>0.023993</td>
    </tr>
    <tr>
      <th>200000</th>
      <td>0.028003</td>
      <td>0.031735</td>
      <td>0.014700</td>
      <td>0.034493</td>
      <td>0.048167</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Speedup PCA with ONNX (lower better)&quot;</span><span class="p">,</span>
         <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">piv2</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">piv2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">piv2</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">piv</span><span class="p">[</span><span class="s1">&#39;sklearn&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">piv2</span><span class="p">)</span>
<span class="n">piv2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;baseline=scikit-learn (lower better)&quot;</span><span class="p">,</span>
          <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_speedup_pca_001.png" srcset="../_images/sphx_glr_plot_speedup_pca_001.png" alt="Speedup PCA with ONNX (lower better), baseline=scikit-learn (lower better)" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>name       numba     numpy  onnxruntime1    python  sklearn
size
1       0.094160  0.367328      1.062296  0.696770      1.0
10      0.107015  0.376076      1.021664  0.622485      1.0
100     0.147017  0.397408      1.028905  0.587404      1.0
1000    0.329933  0.486672      0.919924  0.607708      1.0
10000   0.622233  0.659963      0.501087  0.784828      1.0
100000  0.553091  0.688183      0.322086  0.717848      1.0
200000  0.581378  0.658858      0.305190  0.716115      1.0
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 2 minutes  31.004 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-speedup-pca-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/e435d5cf66639c6b3318d5ad54090fe0/plot_speedup_pca.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_speedup_pca.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/2bc5788d211825828f37ccaaa7bde748/plot_speedup_pca.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_speedup_pca.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_op_merge_benchmark.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Merges benchmarks</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_time_tree_ensemble.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Benchmark Random Forests, Tree Ensemble</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>