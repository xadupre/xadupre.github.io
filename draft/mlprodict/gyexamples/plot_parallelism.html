
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>When to parallelize? &#8212; Python Runtime for ONNX</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style_notebook_snippet.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxtrib-images/LightBox2/lightbox2/css/lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/require.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script src="../_static/sphinxtrib-images/LightBox2/lightbox2_customize/jquery-noconflict.js"></script>
    <link rel="shortcut icon" href="../_static/project_ico.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compares implementations of ReduceSum" href="plot_op_reducesum.html" />
    <link rel="prev" title="Compares implementations of Tranpose" href="plot_op_transpose.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/project_ico.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorial/index.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx.html">
  ONNX, Runtime, Backends
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../onnx_bench.html">
  scikit-learn Converters and Benchmarks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_cmd.html">
  Command lines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_ex.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../i_index.html">
  FAQ, code, …
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../all_notebooks.html">
  Notebook Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../HISTORY.html">
  History
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_logistic_regression.html">
   Conversion of a logistic regression into C
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_benchmark.html">
   Measure ONNX runtime performances
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_profile.html">
   Profile the execution of a runtime
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_grid_search.html">
   Grid search ONNX models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_merge_benchmark.html">
   Merges benchmarks
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_speedup_pca.html">
   Speed up scikit-learn inference with ONNX
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_time_tree_ensemble.html">
   Benchmark Random Forests, Tree Ensemble
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_numba.html">
   Compares numba, numpy, onnxruntime for simple functions
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_add.html">
   Compares implementations of Add
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemax.html">
   Compares implementations of ReduceMax
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesumsquare.html">
   Compares implementations of ReduceSumSquare
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducemean.html">
   Compares implementations of ReduceMean
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_transpose.html">
   Compares implementations of Tranpose
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   When to parallelize?
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_reducesum.html">
   Compares implementations of ReduceSum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_where.html">
   Compares implementations of Where
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_einsum.html">
   Compares implementations of Einsum
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_op_onnx_topk.html">
   TopK benchmark
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_linear_regression.html">
   Benchmark Linear Regression
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_reg.html">
   Benchmark Random Forests, Tree Ensemble, (AoS and SoA)
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_opml_random_forest_cls_multi.html">
   Benchmark Random Forests, Tree Ensemble, Multi-Classification
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_onnx_tree_ensemble_parallel.html">
   TreeEnsembleRegressor and parallelisation
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training-and-converting-a-model">
   Training and converting a model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling">
   Profiling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gain-from-parallelization">
   Gain from parallelization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#measures-based-on-the-number-of-trees">
   Measures based on the number of trees
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#moving-the-theshold">
   Moving the theshold
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gyexamples-plot-parallelism-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="when-to-parallelize">
<span id="l-example-parallelism"></span><span id="sphx-glr-gyexamples-plot-parallelism-py"></span><h1>When to parallelize?<a class="headerlink" href="#when-to-parallelize" title="Permalink to this headline">¶</a></h1>
<p>That is the question. Parallize computation
takes some time to set up, it is not the right
solution in every case. The following example studies
the parallelism introduced into the runtime of
<em>TreeEnsembleRegressor</em> to see when it is best
to do it.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#training-and-converting-a-model" id="id1">Training and converting a model</a></p></li>
<li><p><a class="reference internal" href="#profiling" id="id2">Profiling</a></p></li>
<li><p><a class="reference internal" href="#gain-from-parallelization" id="id3">Gain from parallelization</a></p></li>
<li><p><a class="reference internal" href="#measures-based-on-the-number-of-trees" id="id4">Measures based on the number of trees</a></p></li>
<li><p><a class="reference internal" href="#moving-the-theshold" id="id5">Moving the theshold</a></p></li>
</ul>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">config_context</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">HistGradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">cpyquickhelper.numbers</span> <span class="kn">import</span> <span class="n">measure_time</span>
<span class="kn">from</span> <span class="nn">pyquickhelper.pycode.profiling</span> <span class="kn">import</span> <span class="n">profile</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnx_conv</span> <span class="kn">import</span> <span class="n">to_onnx</span><span class="p">,</span> <span class="n">register_rewritten_operators</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">mlprodict.tools.model_info</span> <span class="kn">import</span> <span class="n">analyze_model</span>
</pre></div>
</div>
<p>Available optimisations on this machine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.testing.experimental_c_impl.experimental_c</span> <span class="kn">import</span> <span class="n">code_optimisation</span>
<span class="nb">print</span><span class="p">(</span><span class="n">code_optimisation</span><span class="p">())</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>AVX-omp=8
</pre></div>
</div>
<section id="training-and-converting-a-model">
<h2><a class="toc-backref" href="#id1">Training and converting a model</a><a class="headerlink" href="#training-and-converting-a-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">hgb</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">hgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hgb</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>HistGradientBoostingRegressor(max_depth=6)
</pre></div>
</div>
<p>Let’s get more statistics about the model itself.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">analyze_model</span><span class="p">(</span><span class="n">hgb</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>{&#39;_predictors.max|tree_.max_depth&#39;: 6,
 &#39;_predictors.size&#39;: 100,
 &#39;_predictors.sum|tree_.leave_count&#39;: 3100,
 &#39;_predictors.sum|tree_.node_count&#39;: 6100,
 &#39;train_score_.shape&#39;: 101,
 &#39;validation_score_.shape&#39;: 101}
</pre></div>
</div>
<p>And let’s convert it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register_rewritten_operators</span><span class="p">()</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python_compiled&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>OnnxInference(...)
    def compiled_run(dict_inputs, yield_ops=None):
        if yield_ops is not None:
            raise NotImplementedError(&#39;yields_ops should be None.&#39;)
        # inputs
        X = dict_inputs[&#39;X&#39;]
        (variable, ) = n0_treeensembleregressor(X)
        return {
            &#39;variable&#39;: variable,
        }
</pre></div>
</div>
<p>The runtime of the forest is in the following object.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>TreeEnsembleRegressor(
    op_type=TreeEnsembleRegressor
    aggregate_function=b&#39;SUM&#39;,
    base_values=[0.7807642],
    domain=ai.onnx.ml,
    inplaces={},
    ir_version=8,
    n_targets=1,
    nodes_falsenodeids=[30 17 10 ...  0  0  0],
    nodes_featureids=[ 2 14 16 ...  0  0  0],
    nodes_hitrates=[1. 1. 1. ... 1. 1. 1.],
    nodes_missing_value_tracks_true=[0 1 0 ... 0 0 0],
    nodes_modes=[b&#39;BRANCH_LEQ&#39; b&#39;BRANCH_LEQ&#39; b&#39;BRANCH_LEQ&#39; ... b&#39;LEAF&#39; b&#39;LEAF&#39; b&#39;LEAF&#39;],
    nodes_nodeids=[ 0  1  2 ... 58 59 60],
    nodes_treeids=[ 0  0  0 ... 99 99 99],
    nodes_truenodeids=[1 2 3 ... 0 0 0],
    nodes_values=[-0.00458882  0.08421846 -0.07731909 ...  0.          0.
  0.        ],
    post_transform=b&#39;NONE&#39;,
    target_ids=[0 0 0 ... 0 0 0],
    target_nodeids=[ 5  6  8 ... 58 59 60],
    target_opset=1,
    target_treeids=[ 0  0  0 ... 99 99 99],
    target_weights=[-30.826473   -20.658823   -21.4012     ...   0.87109977   2.5309787
   1.9359126 ],
)
&lt;mlprodict.onnxrt.ops_cpu.op_tree_ensemble_regressor_p_.RuntimeTreeEnsembleRegressorPFloat object at 0x7fccb82472f0&gt;
</pre></div>
</div>
<p>And the threshold used to start parallelizing
based on the number of observations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>20
</pre></div>
</div>
</section>
<section id="profiling">
<h2><a class="toc-backref" href="#id2">Profiling</a><a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h2>
<p>This step involves <a class="reference external" href="https://github.com/joerick/pyinstrument">pyinstrument</a> to measure
where the time is spent. Both <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>
and <a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/index.html">mlprodict</a> runtime are called so that
the prediction times can be compared.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X32</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runlocal</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span><span class="n">assume_finite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
            <span class="n">oinf</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]})</span>
            <span class="n">hgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;profiling...&quot;</span><span class="p">)</span>
<span class="n">txt</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">runlocal</span><span class="p">,</span> <span class="n">pyinst_format</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>profiling...

  _     ._   __/__   _ _  _  _ _/_   Recorded: 09:14:06 AM Samples:  1506
 /_//_/// /_\ / //_// / //_&#39;/ //     Duration: 2.312     CPU time: 18.319
/   _/                      v4.1.1

Program: /var/lib/jenkins/workspace/mlprodict/mlprodict_UT_39_std/_doc/examples/plot_parallelism.py

2.312 profile  ../pycode/profiling.py:457
`- 2.312 runlocal  plot_parallelism.py:91
      [33 frames hidden]  plot_parallelism, sklearn, &lt;built-in&gt;...
         0.829 _predict_from_raw_data  &lt;built-in&gt;:0
         0.650 _run  mlprodict/onnxrt/ops_cpu/op_tree_ensemble_regressor.py:80
</pre></div>
</div>
<p>Now let’s measure the performance the average
computation time per observations for 2 to 100
observations. The runtime implemented in
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/index.html">mlprodict</a> parallizes the computation
after a given number of observations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">))):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="s2">&quot;oinf.run({&#39;X&#39;: x})&quot;</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;oinf&#39;</span><span class="p">:</span> <span class="n">oinf</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="n">N</span><span class="p">]},</span>
                     <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;RT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ONNX&#39;</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span><span class="n">assume_finite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="s2">&quot;hgb.predict(x)&quot;</span><span class="p">,</span>
                         <span class="p">{</span><span class="s1">&#39;hgb&#39;</span><span class="p">:</span> <span class="n">hgb</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="n">N</span><span class="p">]},</span>
                         <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">number</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;RT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SKL&#39;</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min_exec&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="s1">&#39;max_exec&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/19 [00:00&lt;?, ?it/s]
  5%|5         | 1/19 [00:01&lt;00:23,  1.28s/it]
 11%|#         | 2/19 [00:02&lt;00:21,  1.28s/it]
 16%|#5        | 3/19 [00:03&lt;00:20,  1.29s/it]
 21%|##1       | 4/19 [00:05&lt;00:19,  1.29s/it]
 26%|##6       | 5/19 [00:06&lt;00:18,  1.29s/it]
 32%|###1      | 6/19 [00:07&lt;00:16,  1.29s/it]
 37%|###6      | 7/19 [00:09&lt;00:15,  1.29s/it]
 42%|####2     | 8/19 [00:10&lt;00:14,  1.29s/it]
 47%|####7     | 9/19 [00:11&lt;00:13,  1.30s/it]
 53%|#####2    | 10/19 [00:12&lt;00:11,  1.32s/it]
 58%|#####7    | 11/19 [00:14&lt;00:10,  1.33s/it]
 63%|######3   | 12/19 [00:15&lt;00:09,  1.33s/it]
 68%|######8   | 13/19 [00:16&lt;00:07,  1.33s/it]
 74%|#######3  | 14/19 [00:18&lt;00:06,  1.32s/it]
 79%|#######8  | 15/19 [00:19&lt;00:05,  1.32s/it]
 84%|########4 | 16/19 [00:20&lt;00:03,  1.32s/it]
 89%|########9 | 17/19 [00:22&lt;00:02,  1.32s/it]
 95%|#########4| 18/19 [00:23&lt;00:01,  1.32s/it]
100%|##########| 19/19 [00:24&lt;00:00,  1.33s/it]
100%|##########| 19/19 [00:24&lt;00:00,  1.31s/it]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>average</th>
      <th>deviation</th>
      <th>min_exec</th>
      <th>max_exec</th>
      <th>repeat</th>
      <th>number</th>
      <th>ttime</th>
      <th>context_size</th>
      <th>N</th>
      <th>RT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000028</td>
      <td>0.000002</td>
      <td>0.000027</td>
      <td>0.000030</td>
      <td>10</td>
      <td>20</td>
      <td>0.000557</td>
      <td>232</td>
      <td>2</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.004233</td>
      <td>0.000054</td>
      <td>0.004210</td>
      <td>0.004288</td>
      <td>10</td>
      <td>15</td>
      <td>0.084666</td>
      <td>232</td>
      <td>2</td>
      <td>SKL</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.000023</td>
      <td>0.000002</td>
      <td>0.000022</td>
      <td>0.000024</td>
      <td>10</td>
      <td>20</td>
      <td>0.000678</td>
      <td>232</td>
      <td>3</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.002818</td>
      <td>0.000015</td>
      <td>0.002812</td>
      <td>0.002826</td>
      <td>10</td>
      <td>15</td>
      <td>0.084528</td>
      <td>232</td>
      <td>3</td>
      <td>SKL</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000020</td>
      <td>0.000002</td>
      <td>0.000020</td>
      <td>0.000021</td>
      <td>10</td>
      <td>20</td>
      <td>0.000798</td>
      <td>232</td>
      <td>4</td>
      <td>ONNX</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">RT</span> <span class="o">==</span> <span class="s1">&#39;ONNX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average ONNX prediction time per observation in a batch.&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">RT</span> <span class="o">==</span> <span class="s1">&#39;SKL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
    <span class="s2">&quot;Average scikit-learn prediction time</span><span class="se">\n</span><span class="s2">per observation in a batch.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_parallelism_001.png" srcset="../_images/sphx_glr_plot_parallelism_001.png" alt="Average ONNX prediction time per observation in a batch., Average scikit-learn prediction time per observation in a batch." class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Average scikit-learn prediction time\nper observation in a batch.&#39;)
</pre></div>
</div>
</section>
<section id="gain-from-parallelization">
<h2><a class="toc-backref" href="#id3">Gain from parallelization</a><a class="headerlink" href="#gain-from-parallelization" title="Permalink to this headline">¶</a></h2>
<p>There is a clear gap between after and before 10 observations
when it is parallelized. Does this threshold depends on the number
of trees in the model?
For that we compute for each model the average prediction time
up to 10 and from 10 to 20.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parallized_gain</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">RT</span> <span class="o">==</span> <span class="s1">&#39;ONNX&#39;</span><span class="p">]</span>
    <span class="n">df10</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">t10</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df10</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df10</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df10p</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">t10p</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df10p</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df10p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t10</span> <span class="o">/</span> <span class="n">t10p</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="n">parallized_gain</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>gain 1.303851504830905
</pre></div>
</div>
</section>
<section id="measures-based-on-the-number-of-trees">
<h2><a class="toc-backref" href="#id4">Measures based on the number of trees</a><a class="headerlink" href="#measures-based-on-the-number-of-trees" title="Permalink to this headline">¶</a></h2>
<p>We trained many models with different number
of trees to see how the parallelization gain
is moving. One models is trained for every
distinct number of trees and then the prediction
time is measured for different number of observations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tries_set</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">tries</span> <span class="o">=</span> <span class="p">[(</span><span class="n">nb</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">tries_set</span><span class="p">]</span>
</pre></div>
</div>
<p>training</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">oinf</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tries</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">nb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="n">hgb</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">hgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python_compiled&#39;</span><span class="p">)</span>
        <span class="n">models</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">oinf</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/17 [00:00&lt;?, ?it/s]
  6%|5         | 1/17 [00:00&lt;00:05,  3.09it/s]
 12%|#1        | 2/17 [00:01&lt;00:13,  1.09it/s]
 24%|##3       | 4/17 [00:02&lt;00:06,  2.11it/s]
 29%|##9       | 5/17 [00:04&lt;00:12,  1.06s/it]
 35%|###5      | 6/17 [00:04&lt;00:09,  1.12it/s]
 41%|####1     | 7/17 [00:06&lt;00:10,  1.07s/it]
 47%|####7     | 8/17 [00:07&lt;00:08,  1.09it/s]
 53%|#####2    | 9/17 [00:08&lt;00:09,  1.14s/it]
 59%|#####8    | 10/17 [00:09&lt;00:07,  1.01s/it]
 65%|######4   | 11/17 [00:12&lt;00:09,  1.51s/it]
 71%|#######   | 12/17 [00:13&lt;00:07,  1.59s/it]
 76%|#######6  | 13/17 [00:14&lt;00:05,  1.38s/it]
 82%|########2 | 14/17 [00:15&lt;00:03,  1.27s/it]
 88%|########8 | 15/17 [00:18&lt;00:03,  1.77s/it]
 94%|#########4| 16/17 [00:20&lt;00:01,  1.86s/it]
100%|##########| 17/17 [00:21&lt;00:00,  1.65s/it]
100%|##########| 17/17 [00:21&lt;00:00,  1.29s/it]
</pre></div>
</div>
<p>prediction time</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">nb</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">tries</span><span class="p">):</span>
    <span class="n">hgb</span><span class="p">,</span> <span class="n">oinf</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="s2">&quot;oinf.run({&#39;X&#39;: x})&quot;</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;oinf&#39;</span><span class="p">:</span> <span class="n">oinf</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="n">N</span><span class="p">]},</span>
                     <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">number</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;RT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ONNX&#39;</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min_exec&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="s1">&#39;max_exec&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/170 [00:00&lt;?, ?it/s]
  4%|3         | 6/170 [00:00&lt;00:02, 57.17it/s]
  7%|7         | 12/170 [00:00&lt;00:03, 50.25it/s]
 11%|#         | 18/170 [00:00&lt;00:03, 44.50it/s]
 14%|#4        | 24/170 [00:00&lt;00:03, 46.88it/s]
 17%|#7        | 29/170 [00:00&lt;00:03, 43.42it/s]
 20%|##        | 34/170 [00:00&lt;00:03, 36.46it/s]
 24%|##3       | 40/170 [00:00&lt;00:03, 40.46it/s]
 26%|##6       | 45/170 [00:01&lt;00:03, 38.37it/s]
 29%|##8       | 49/170 [00:01&lt;00:03, 33.45it/s]
 31%|###1      | 53/170 [00:01&lt;00:03, 32.00it/s]
 34%|###4      | 58/170 [00:01&lt;00:03, 34.87it/s]
 36%|###6      | 62/170 [00:01&lt;00:03, 32.99it/s]
 39%|###8      | 66/170 [00:01&lt;00:03, 28.15it/s]
 41%|####      | 69/170 [00:01&lt;00:03, 25.97it/s]
 44%|####3     | 74/170 [00:02&lt;00:03, 30.42it/s]
 46%|####5     | 78/170 [00:02&lt;00:03, 29.57it/s]
 48%|####8     | 82/170 [00:02&lt;00:03, 25.60it/s]
 50%|#####     | 85/170 [00:02&lt;00:04, 21.18it/s]
 53%|#####2    | 90/170 [00:02&lt;00:03, 26.44it/s]
 55%|#####5    | 94/170 [00:02&lt;00:02, 26.88it/s]
 57%|#####7    | 97/170 [00:03&lt;00:02, 24.87it/s]
 59%|#####8    | 100/170 [00:03&lt;00:03, 21.03it/s]
 61%|######    | 103/170 [00:03&lt;00:03, 19.18it/s]
 64%|######3   | 108/170 [00:03&lt;00:02, 24.08it/s]
 65%|######5   | 111/170 [00:03&lt;00:02, 24.15it/s]
 67%|######7   | 114/170 [00:03&lt;00:02, 22.21it/s]
 69%|######8   | 117/170 [00:04&lt;00:02, 18.56it/s]
 71%|#######   | 120/170 [00:04&lt;00:02, 16.90it/s]
 74%|#######3  | 125/170 [00:04&lt;00:02, 21.81it/s]
 75%|#######5  | 128/170 [00:04&lt;00:01, 22.00it/s]
 77%|#######7  | 131/170 [00:04&lt;00:01, 20.19it/s]
 79%|#######8  | 134/170 [00:05&lt;00:02, 16.79it/s]
 80%|########  | 136/170 [00:05&lt;00:02, 14.17it/s]
 83%|########2 | 141/170 [00:05&lt;00:01, 19.83it/s]
 85%|########4 | 144/170 [00:05&lt;00:01, 20.79it/s]
 86%|########6 | 147/170 [00:05&lt;00:01, 19.46it/s]
 88%|########8 | 150/170 [00:05&lt;00:01, 16.58it/s]
 89%|########9 | 152/170 [00:06&lt;00:01, 13.92it/s]
 91%|######### | 154/170 [00:06&lt;00:01, 13.89it/s]
 93%|#########2| 158/170 [00:06&lt;00:00, 18.68it/s]
 95%|#########4| 161/170 [00:06&lt;00:00, 19.68it/s]
 96%|#########6| 164/170 [00:06&lt;00:00, 18.18it/s]
 98%|#########8| 167/170 [00:07&lt;00:00, 15.24it/s]
 99%|#########9| 169/170 [00:07&lt;00:00, 12.68it/s]
100%|##########| 170/170 [00:07&lt;00:00, 22.96it/s]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>average</th>
      <th>deviation</th>
      <th>min_exec</th>
      <th>max_exec</th>
      <th>repeat</th>
      <th>number</th>
      <th>ttime</th>
      <th>context_size</th>
      <th>N</th>
      <th>nb</th>
      <th>RT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000015</td>
      <td>4.640621e-07</td>
      <td>0.000015</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000309</td>
      <td>232</td>
      <td>2</td>
      <td>2</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000016</td>
      <td>2.732580e-07</td>
      <td>0.000016</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000316</td>
      <td>232</td>
      <td>2</td>
      <td>5</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.000016</td>
      <td>2.690261e-07</td>
      <td>0.000016</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000318</td>
      <td>232</td>
      <td>2</td>
      <td>8</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.000016</td>
      <td>4.722324e-07</td>
      <td>0.000016</td>
      <td>0.000017</td>
      <td>10</td>
      <td>50</td>
      <td>0.000329</td>
      <td>232</td>
      <td>2</td>
      <td>10</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000017</td>
      <td>3.640444e-07</td>
      <td>0.000017</td>
      <td>0.000018</td>
      <td>10</td>
      <td>50</td>
      <td>0.000345</td>
      <td>232</td>
      <td>2</td>
      <td>15</td>
      <td>ONNX</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Let’s compute the gains.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gains</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nb&#39;</span><span class="p">]):</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">parallized_gain</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nb</span> <span class="o">==</span> <span class="n">nb</span><span class="p">])</span>
    <span class="n">gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">))</span>

<span class="n">dfg</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
<span class="n">dfg</span> <span class="o">=</span> <span class="n">dfg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;nb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dfg</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nb</th>
      <th>gain</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>3.342564</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5</td>
      <td>3.070982</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8</td>
      <td>2.849541</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>2.719479</td>
    </tr>
    <tr>
      <th>4</th>
      <td>15</td>
      <td>2.462390</td>
    </tr>
    <tr>
      <th>5</th>
      <td>20</td>
      <td>2.250934</td>
    </tr>
    <tr>
      <th>6</th>
      <td>25</td>
      <td>2.078773</td>
    </tr>
    <tr>
      <th>7</th>
      <td>30</td>
      <td>1.968299</td>
    </tr>
    <tr>
      <th>8</th>
      <td>35</td>
      <td>1.849501</td>
    </tr>
    <tr>
      <th>9</th>
      <td>40</td>
      <td>1.770980</td>
    </tr>
    <tr>
      <th>10</th>
      <td>45</td>
      <td>1.700082</td>
    </tr>
    <tr>
      <th>11</th>
      <td>50</td>
      <td>1.654464</td>
    </tr>
    <tr>
      <th>12</th>
      <td>60</td>
      <td>1.577692</td>
    </tr>
    <tr>
      <th>13</th>
      <td>70</td>
      <td>1.513925</td>
    </tr>
    <tr>
      <th>14</th>
      <td>80</td>
      <td>1.443747</td>
    </tr>
    <tr>
      <th>15</th>
      <td>90</td>
      <td>1.378006</td>
    </tr>
    <tr>
      <th>16</th>
      <td>100</td>
      <td>1.353666</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">dfg</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;nb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
    <span class="s2">&quot;Parallelization gain depending</span><span class="se">\n</span><span class="s2">on the number of trees</span><span class="se">\n</span><span class="s2">(max_depth=6).&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_parallelism_002.png" srcset="../_images/sphx_glr_plot_parallelism_002.png" alt="Parallelization gain depending on the number of trees (max_depth=6)." class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Parallelization gain depending\non the number of trees\n(max_depth=6).&#39;)
</pre></div>
</div>
<p>That does not answer the question we are looking for
as we would like to know the best threshold <em>th</em>
which defines the number of observations for which
we should parallelized. This number depends on the number
of trees. A gain &gt; 1 means the parallization should happen
Here, even two observations is ok.
Let’s check with lighter trees (<code class="docutils literal notranslate"><span class="pre">max_depth=2</span></code>),
maybe in that case, the conclusion is different.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">oinf</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tries</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">nb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="n">hgb</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">hgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python_compiled&#39;</span><span class="p">)</span>
        <span class="n">models</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">oinf</span><span class="p">)</span>

<span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">nb</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">tries</span><span class="p">):</span>
    <span class="n">hgb</span><span class="p">,</span> <span class="n">oinf</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="s2">&quot;oinf.run({&#39;X&#39;: x})&quot;</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;oinf&#39;</span><span class="p">:</span> <span class="n">oinf</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="n">N</span><span class="p">]},</span>
                     <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">number</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;RT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ONNX&#39;</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min_exec&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="s1">&#39;max_exec&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/17 [00:00&lt;?, ?it/s]
  6%|5         | 1/17 [00:00&lt;00:04,  3.70it/s]
 12%|#1        | 2/17 [00:00&lt;00:06,  2.45it/s]
 24%|##3       | 4/17 [00:01&lt;00:03,  4.10it/s]
 29%|##9       | 5/17 [00:01&lt;00:04,  2.49it/s]
 35%|###5      | 6/17 [00:02&lt;00:04,  2.67it/s]
 41%|####1     | 7/17 [00:02&lt;00:04,  2.35it/s]
 47%|####7     | 8/17 [00:03&lt;00:03,  2.53it/s]
 53%|#####2    | 9/17 [00:03&lt;00:03,  2.22it/s]
 59%|#####8    | 10/17 [00:03&lt;00:02,  2.36it/s]
 65%|######4   | 11/17 [00:04&lt;00:03,  1.84it/s]
 71%|#######   | 12/17 [00:05&lt;00:02,  1.77it/s]
 76%|#######6  | 13/17 [00:05&lt;00:02,  1.94it/s]
 82%|########2 | 14/17 [00:06&lt;00:01,  2.04it/s]
 88%|########8 | 15/17 [00:07&lt;00:01,  1.62it/s]
 94%|#########4| 16/17 [00:07&lt;00:00,  1.57it/s]
100%|##########| 17/17 [00:08&lt;00:00,  1.71it/s]
100%|##########| 17/17 [00:08&lt;00:00,  2.06it/s]

  0%|          | 0/170 [00:00&lt;?, ?it/s]
  4%|4         | 7/170 [00:00&lt;00:02, 59.72it/s]
  8%|7         | 13/170 [00:00&lt;00:02, 56.18it/s]
 11%|#1        | 19/170 [00:00&lt;00:02, 52.57it/s]
 15%|#4        | 25/170 [00:00&lt;00:02, 53.73it/s]
 18%|#8        | 31/170 [00:00&lt;00:02, 51.14it/s]
 22%|##1       | 37/170 [00:00&lt;00:02, 47.75it/s]
 25%|##5       | 43/170 [00:00&lt;00:02, 48.88it/s]
 28%|##8       | 48/170 [00:00&lt;00:02, 46.62it/s]
 31%|###1      | 53/170 [00:01&lt;00:02, 42.31it/s]
 35%|###4      | 59/170 [00:01&lt;00:02, 44.89it/s]
 38%|###7      | 64/170 [00:01&lt;00:02, 43.49it/s]
 41%|####      | 69/170 [00:01&lt;00:02, 37.51it/s]
 44%|####4     | 75/170 [00:01&lt;00:02, 41.22it/s]
 47%|####7     | 80/170 [00:01&lt;00:02, 40.70it/s]
 50%|#####     | 85/170 [00:01&lt;00:02, 33.31it/s]
 54%|#####3    | 91/170 [00:02&lt;00:02, 37.95it/s]
 56%|#####6    | 96/170 [00:02&lt;00:01, 38.21it/s]
 59%|#####9    | 101/170 [00:02&lt;00:02, 34.16it/s]
 62%|######1   | 105/170 [00:02&lt;00:02, 32.38it/s]
 65%|######4   | 110/170 [00:02&lt;00:01, 35.34it/s]
 67%|######7   | 114/170 [00:02&lt;00:01, 34.91it/s]
 69%|######9   | 118/170 [00:02&lt;00:01, 30.92it/s]
 72%|#######1  | 122/170 [00:03&lt;00:01, 29.27it/s]
 75%|#######4  | 127/170 [00:03&lt;00:01, 32.78it/s]
 77%|#######7  | 131/170 [00:03&lt;00:01, 32.53it/s]
 79%|#######9  | 135/170 [00:03&lt;00:01, 28.57it/s]
 82%|########1 | 139/170 [00:03&lt;00:01, 27.01it/s]
 85%|########4 | 144/170 [00:03&lt;00:00, 30.67it/s]
 87%|########7 | 148/170 [00:03&lt;00:00, 30.52it/s]
 89%|########9 | 152/170 [00:04&lt;00:00, 26.64it/s]
 91%|#########1| 155/170 [00:04&lt;00:00, 24.16it/s]
 94%|#########4| 160/170 [00:04&lt;00:00, 28.76it/s]
 96%|#########6| 164/170 [00:04&lt;00:00, 29.29it/s]
 99%|#########8| 168/170 [00:04&lt;00:00, 26.31it/s]
100%|##########| 170/170 [00:04&lt;00:00, 34.27it/s]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>average</th>
      <th>deviation</th>
      <th>min_exec</th>
      <th>max_exec</th>
      <th>repeat</th>
      <th>number</th>
      <th>ttime</th>
      <th>context_size</th>
      <th>N</th>
      <th>nb</th>
      <th>RT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000015</td>
      <td>1.688440e-06</td>
      <td>0.000015</td>
      <td>0.000018</td>
      <td>10</td>
      <td>50</td>
      <td>0.000309</td>
      <td>232</td>
      <td>2</td>
      <td>2</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000015</td>
      <td>2.889513e-07</td>
      <td>0.000015</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000306</td>
      <td>232</td>
      <td>2</td>
      <td>5</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.000015</td>
      <td>2.158380e-07</td>
      <td>0.000015</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000308</td>
      <td>232</td>
      <td>2</td>
      <td>8</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.000016</td>
      <td>4.048876e-07</td>
      <td>0.000015</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000312</td>
      <td>232</td>
      <td>2</td>
      <td>10</td>
      <td>ONNX</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000016</td>
      <td>3.301538e-07</td>
      <td>0.000016</td>
      <td>0.000016</td>
      <td>10</td>
      <td>50</td>
      <td>0.000318</td>
      <td>232</td>
      <td>2</td>
      <td>15</td>
      <td>ONNX</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Measures.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gains</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nb&#39;</span><span class="p">]):</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">parallized_gain</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nb</span> <span class="o">==</span> <span class="n">nb</span><span class="p">])</span>
    <span class="n">gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">))</span>

<span class="n">dfg</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
<span class="n">dfg</span> <span class="o">=</span> <span class="n">dfg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;nb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dfg</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nb</th>
      <th>gain</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>3.455291</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5</td>
      <td>3.282338</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8</td>
      <td>3.160855</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>3.085528</td>
    </tr>
    <tr>
      <th>4</th>
      <td>15</td>
      <td>2.940223</td>
    </tr>
    <tr>
      <th>5</th>
      <td>20</td>
      <td>2.781014</td>
    </tr>
    <tr>
      <th>6</th>
      <td>25</td>
      <td>2.662970</td>
    </tr>
    <tr>
      <th>7</th>
      <td>30</td>
      <td>2.573553</td>
    </tr>
    <tr>
      <th>8</th>
      <td>35</td>
      <td>2.474134</td>
    </tr>
    <tr>
      <th>9</th>
      <td>40</td>
      <td>2.393840</td>
    </tr>
    <tr>
      <th>10</th>
      <td>45</td>
      <td>2.288964</td>
    </tr>
    <tr>
      <th>11</th>
      <td>50</td>
      <td>2.224130</td>
    </tr>
    <tr>
      <th>12</th>
      <td>60</td>
      <td>2.072905</td>
    </tr>
    <tr>
      <th>13</th>
      <td>70</td>
      <td>1.950264</td>
    </tr>
    <tr>
      <th>14</th>
      <td>80</td>
      <td>1.852916</td>
    </tr>
    <tr>
      <th>15</th>
      <td>90</td>
      <td>1.776336</td>
    </tr>
    <tr>
      <th>16</th>
      <td>100</td>
      <td>1.354441</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">dfg</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;nb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
    <span class="s2">&quot;Parallelization gain depending</span><span class="se">\n</span><span class="s2">on the number of trees</span><span class="se">\n</span><span class="s2">(max_depth=3).&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_parallelism_003.png" srcset="../_images/sphx_glr_plot_parallelism_003.png" alt="Parallelization gain depending on the number of trees (max_depth=3)." class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Parallelization gain depending\non the number of trees\n(max_depth=3).&#39;)
</pre></div>
</div>
<p>The conclusion is somewhat the same but
it shows that the bigger the number of trees is
the bigger the gain is and under the number of
cores of the processor.</p>
</section>
<section id="moving-the-theshold">
<h2><a class="toc-backref" href="#id5">Moving the theshold</a><a class="headerlink" href="#moving-the-theshold" title="Permalink to this headline">¶</a></h2>
<p>The last experiment consists in comparing the prediction
time with or without parallelization for different
number of observation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hgb</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">hgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">hgb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">onx</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;python_compiled&#39;</span><span class="p">)</span>


<span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">51</span><span class="p">))):</span>
    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="s2">&quot;oinf.run({&#39;X&#39;: x})&quot;</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;oinf&#39;</span><span class="p">:</span> <span class="n">oinf</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="n">N</span><span class="p">]},</span>
                     <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">number</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;RT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ONNX&#39;</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;PARALLEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">oinf</span><span class="o">.</span><span class="n">sequence_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ops_</span><span class="o">.</span><span class="n">rt_</span><span class="o">.</span><span class="n">omp_N_</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">measure_time</span><span class="p">(</span><span class="s2">&quot;oinf.run({&#39;X&#39;: x})&quot;</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;oinf&#39;</span><span class="p">:</span> <span class="n">oinf</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">X32</span><span class="p">[:</span><span class="n">N</span><span class="p">]},</span>
                     <span class="n">div_by_number</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">number</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;RT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ONNX&#39;</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;PARALLEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min_exec&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="s1">&#39;max_exec&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/49 [00:00&lt;?, ?it/s]
  6%|6         | 3/49 [00:00&lt;00:01, 25.83it/s]
 12%|#2        | 6/49 [00:00&lt;00:01, 25.14it/s]
 18%|#8        | 9/49 [00:00&lt;00:01, 23.21it/s]
 24%|##4       | 12/49 [00:00&lt;00:01, 21.29it/s]
 31%|###       | 15/49 [00:00&lt;00:01, 19.57it/s]
 35%|###4      | 17/49 [00:00&lt;00:01, 18.06it/s]
 39%|###8      | 19/49 [00:00&lt;00:01, 16.99it/s]
 43%|####2     | 21/49 [00:01&lt;00:01, 15.99it/s]
 47%|####6     | 23/49 [00:01&lt;00:01, 15.08it/s]
 51%|#####1    | 25/49 [00:01&lt;00:01, 14.15it/s]
 55%|#####5    | 27/49 [00:01&lt;00:01, 13.36it/s]
 59%|#####9    | 29/49 [00:01&lt;00:01, 12.68it/s]
 63%|######3   | 31/49 [00:01&lt;00:01, 12.06it/s]
 67%|######7   | 33/49 [00:02&lt;00:01, 11.44it/s]
 71%|#######1  | 35/49 [00:02&lt;00:01, 10.91it/s]
 76%|#######5  | 37/49 [00:02&lt;00:01, 10.45it/s]
 80%|#######9  | 39/49 [00:02&lt;00:00, 10.02it/s]
 84%|########3 | 41/49 [00:03&lt;00:00,  9.34it/s]
 86%|########5 | 42/49 [00:03&lt;00:00,  9.18it/s]
 88%|########7 | 43/49 [00:03&lt;00:00,  8.76it/s]
 90%|########9 | 44/49 [00:03&lt;00:00,  8.63it/s]
 92%|#########1| 45/49 [00:03&lt;00:00,  8.45it/s]
 94%|#########3| 46/49 [00:03&lt;00:00,  8.33it/s]
 96%|#########5| 47/49 [00:03&lt;00:00,  8.20it/s]
 98%|#########7| 48/49 [00:03&lt;00:00,  8.05it/s]
100%|##########| 49/49 [00:04&lt;00:00,  7.91it/s]
100%|##########| 49/49 [00:04&lt;00:00, 12.04it/s]
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>average</th>
      <th>deviation</th>
      <th>min_exec</th>
      <th>max_exec</th>
      <th>repeat</th>
      <th>number</th>
      <th>ttime</th>
      <th>context_size</th>
      <th>N</th>
      <th>RT</th>
      <th>PARALLEL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000021</td>
      <td>0.000001</td>
      <td>0.000021</td>
      <td>0.000023</td>
      <td>10</td>
      <td>20</td>
      <td>0.000418</td>
      <td>232</td>
      <td>2</td>
      <td>ONNX</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000035</td>
      <td>0.000066</td>
      <td>0.000022</td>
      <td>0.000133</td>
      <td>10</td>
      <td>50</td>
      <td>0.000695</td>
      <td>232</td>
      <td>2</td>
      <td>ONNX</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.000016</td>
      <td>0.000001</td>
      <td>0.000015</td>
      <td>0.000016</td>
      <td>10</td>
      <td>20</td>
      <td>0.000465</td>
      <td>232</td>
      <td>3</td>
      <td>ONNX</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.000016</td>
      <td>0.000001</td>
      <td>0.000015</td>
      <td>0.000017</td>
      <td>10</td>
      <td>50</td>
      <td>0.000466</td>
      <td>232</td>
      <td>3</td>
      <td>ONNX</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000013</td>
      <td>0.000001</td>
      <td>0.000013</td>
      <td>0.000014</td>
      <td>10</td>
      <td>20</td>
      <td>0.000512</td>
      <td>232</td>
      <td>4</td>
      <td>ONNX</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;PARALLEL&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;PARALLEL&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Prediction time with and without parallelization.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_parallelism_004.png" srcset="../_images/sphx_glr_plot_parallelism_004.png" alt="Prediction time with and without parallelization." class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Prediction time with and without parallelization.&#39;)
</pre></div>
</div>
<p>Parallelization is working.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 1 minutes  22.746 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-gyexamples-plot-parallelism-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/888148fc180c4b80a06c7ff1d93bf161/plot_parallelism.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_parallelism.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/fc65736e2ccaddf5c07e6e518b11b4bb/plot_parallelism.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_parallelism.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_op_transpose.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compares implementations of Tranpose</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_op_reducesum.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Compares implementations of ReduceSum</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Xavier Dupré.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>