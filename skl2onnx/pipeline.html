<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>Convert a pipeline</title>

  <link rel="stylesheet" href="_static/sphinx-modern-theme-modified.css" type="text/css"/>
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
</head>
<body>
<div class="container">
  <div class="row" style="margin-top: 1rem;">
    <div id="sidebar" class="col-xs-12 col-sm-3">
      <a href="index.html">
        <img style="margin-bottom: 0.5rem;" class="img-fluid" src="_static/logo_main.png"/>
      </a>
      <div id="searchbox" style="display: none" role="search">
        <form class="form-inline" action="search.html" method="get">
          <div class="form-group">
            <label class="sr-only" for="searchInput">Search</label>
            <input type="text" class="form-control" name="q" id="searchInput" placeholder="Search">
          </div>
          <button type="submit" class="btn btn-secondary" style="display:none">Go</button>
          <input type="hidden" name="check_keywords" value="yes"/>
          <input type="hidden" name="area" value="default"/>
        </form>
      </div>

      <hr>

        <div id="toc">
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#step-1-train-a-model-using-your-favorite-framework">Step 1: Train a model using your favorite framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#step-2-convert-or-export-the-model-into-onnx-format">Step 2: Convert or export the model into ONNX format</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#step-3-load-and-run-the-model-using-onnx-runtime">Step 3: Load and run the model using ONNX Runtime</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_summary.html">API Summary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api_summary.html#converters">Converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_summary.html#manipulate-onnx-graphs">Manipulate ONNX graphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_summary.html#registered-functions">Registered functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_summary.html#parsers">Parsers</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_summary.html#utils-for-contributors">Utils for contributors</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_summary.html#concepts">Concepts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="auto_examples/index.html">Gallery of examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_backend.html">ONNX Runtime Backend for ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_pipeline.html">Draw a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_metadata.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_convert_model.html">Train, convert and predict a model</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_errors_onnxruntime.html">Errors with onnxruntime</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_pipeline_lightgbm.html">Convert a pipeline with a LightGbm model</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_complex_pipeline.html">Convert a pipeline with ColumnTransformer</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_tfidfvectorizer.html">TfIdfVectorizer with ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_errors_pipeline.html">Errors while converting a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_intermediate_outputs.html">Walk through intermediate outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_transfer_learning.html">Transfer learning with ONNX</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_examples/plot_custom_model.html">Write your own converter for your own model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="supported.html">Supported Models</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Convert a pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#convert-complex-pipelines">Convert complex pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parser-shape-calculator-converter">Parser, shape calculator, converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#new-converters-in-a-pipeline">New converters in a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#titanic-example">Titanic example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parameterize-the-conversion">Parameterize the conversion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="parameterized.html">Converters with options</a></li>
</ul>

        </div>
    </div>
    <div class="col-xs-12 col-sm-9">
      <div class="section" id="convert-a-pipeline">
<h1>Convert a pipeline<a class="headerlink" href="#convert-a-pipeline" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#convert-complex-pipelines" id="id1">Convert complex pipelines</a></li>
<li><a class="reference internal" href="#parser-shape-calculator-converter" id="id2">Parser, shape calculator, converter</a></li>
<li><a class="reference internal" href="#new-converters-in-a-pipeline" id="id3">New converters in a pipeline</a></li>
<li><a class="reference internal" href="#titanic-example" id="id4">Titanic example</a></li>
<li><a class="reference internal" href="#parameterize-the-conversion" id="id5">Parameterize the conversion</a></li>
</ul>
</div>
<p><em>skl2onnx</em> converts any machine learning pipeline into
<em>ONNX</em> pipelines. Every transformer or predictors is converted
into one or multiple nodes into the <em>ONNX</em> graph.
Any <a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/ImplementingAnOnnxBackend.md">ONNX backend</a>
can then use this graph to compute equivalent outputs for the same inputs.</p>
<div class="section" id="convert-complex-pipelines">
<span id="l-complex-pipeline"></span><h2><a class="toc-backref" href="#id1">Convert complex pipelines</a><a class="headerlink" href="#convert-complex-pipelines" title="Permalink to this headline">¶</a></h2>
<p><em>scikit-learn</em> introduced
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.compose.ColumnTransformer.html">ColumnTransformer</a>
useful to build complex pipelines such as the following one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1"># [&quot;vA&quot;, &quot;vB&quot;, &quot;vC&quot;]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="c1"># [&quot;vcat&quot;, &quot;vcat2&quot;]</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])),</span>
                                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;onehot&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;tsvd&#39;</span><span class="p">,</span> <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;arpack&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;precprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">classifier</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>Which we can represents as:</p>
<div><img height="440" src="_images/blockdiag-0e2bbe287bfc020181cb7981832f234c906f12a6.png" width="448" /></div><p>Once fitted, the model is converted into <em>ONNX</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initial_type</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;numfeat&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])),</span>
                <span class="p">(</span><span class="s1">&#39;strfeat&#39;</span><span class="p">,</span> <span class="n">StringTensorType</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))]</span>
<span class="n">model_onnx</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_type</span><span class="p">)</span>
</pre></div>
</div>
<p>It can be represented as a
<a class="reference external" href="https://en.wikipedia.org/wiki/DOT_(graph_description_language)">DOT</a> graph:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnx.tools.net_drawer</span> <span class="k">import</span> <span class="n">GetPydotGraph</span><span class="p">,</span> <span class="n">GetOpNodeProducer</span>
<span class="n">pydot_graph</span> <span class="o">=</span> <span class="n">GetPydotGraph</span><span class="p">(</span><span class="n">model_onnx</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">model_onnx</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;TP&quot;</span><span class="p">,</span>
                            <span class="n">node_producer</span><span class="o">=</span><span class="n">GetOpNodeProducer</span><span class="p">(</span><span class="s2">&quot;docstring&quot;</span><span class="p">))</span>
<span class="n">pydot_graph</span><span class="o">.</span><span class="n">write_dot</span><span class="p">(</span><span class="s2">&quot;graph.dot&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;dot -O -Tpng graph.dot&#39;</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/pipeline.png"><img alt="_images/pipeline.png" src="_images/pipeline.png" style="width: 1000px;" /></a>
</div>
<div class="section" id="parser-shape-calculator-converter">
<h2><a class="toc-backref" href="#id2">Parser, shape calculator, converter</a><a class="headerlink" href="#parser-shape-calculator-converter" title="Permalink to this headline">¶</a></h2>
<p id="index-0">Three kinds of functions are involved into the conversion
of a <em>scikit-pipeline</em>. Each of them is called in the following
order:</p>
<ul class="simple">
<li><strong>parser(scope, model, inputs, custom_parser)</strong>:
the parser builds the expected outputs of a model,
as the resulting graph must contain unique names,
<em>scope</em> contains all names already given,
<em>model</em> is the model to convert,
<em>inputs</em> are the <em>inputs</em> the model receives
in the <em>ONNX</em> graph. It is a list of
<a class="reference internal" href="api_summary.html#skl2onnx.common._topology.Variable" title="skl2onnx.common._topology.Variable"><code class="xref py py-class docutils literal notranslate"><span class="pre">Variable</span></code></a>.
<em>custom_parsers</em> contains a map <code class="docutils literal notranslate"><span class="pre">{model</span> <span class="pre">type:</span> <span class="pre">parser}</span></code>
which extends the default list of parsers.
The parser defines default outputs for standard
machine learned problems. The shape calculator
changes the shapes and types for each of them
depending on the model and is called after all
outputs were defined (topology). This steps defines
the number of outputs for every node and sets them to
a default type and default shape <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">'None']</span></code>
which the output node has one row and no known
columns yet.</li>
<li><strong>shape_calculator(model):</strong>
The shape calculator changes the shape and types
of the outputs created by the parser. Once this function
returned its results, the graph structure is fully defined
and cannot be changed.</li>
<li><strong>converter(scope, operator, container):</strong>
The converter converts the transformers or predictors into
<em>ONNX</em> nodes. Each node can an <em>ONNX</em>
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">operator</a> or
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ML operator</a> or
custom <em>ONNX</em> operators.</li>
</ul>
<p>As <em>sklearn-onnx</em> may convert pipelines with model coming from other libraries,
the library must handle parsers, shape calculators or converters coming
from other packages. This can be done is two ways. The first one
consists in calling function <a class="reference internal" href="api_summary.html#skl2onnx.convert_sklearn" title="skl2onnx.convert_sklearn"><code class="xref py py-func docutils literal notranslate"><span class="pre">convert_sklearn</span></code></a>
by mapping the model type to a specific parser, a specific shape calculator
or a specific converter. It is possible to avoid these specifications
by registering the new parser or shape calculator or converter
with one of the two functions
<a class="reference internal" href="api_summary.html#skl2onnx.update_registered_converter" title="skl2onnx.update_registered_converter"><code class="xref py py-func docutils literal notranslate"><span class="pre">update_registered_converter</span></code></a>,
<a class="reference internal" href="api_summary.html#skl2onnx.update_registered_parser" title="skl2onnx.update_registered_parser"><code class="xref py py-func docutils literal notranslate"><span class="pre">update_registered_parser</span></code></a>.
One example follows.</p>
</div>
<div class="section" id="new-converters-in-a-pipeline">
<span id="l-register-converter"></span><h2><a class="toc-backref" href="#id3">New converters in a pipeline</a><a class="headerlink" href="#new-converters-in-a-pipeline" title="Permalink to this headline">¶</a></h2>
<p>Many libraries implement <em>scikit-learn</em> API and their models can
be included in <em>scikit-learn</em> pipelines. However, <em>sklearn-onnx</em> cannot
a pipeline which include a model such as <em>XGBoost</em> or <em>LightGbm</em>
if it does not know the corresponding converters: it needs to be registered.
That’s the purpose of function <a class="reference internal" href="api_summary.html#skl2onnx.update_registered_converter" title="skl2onnx.update_registered_converter"><code class="xref py py-func docutils literal notranslate"><span class="pre">skl2onnx.update_registered_converter()</span></code></a>.
The following example shows how to register a new converter or
or update an existing one. Four elements are registered:</p>
<ul class="simple">
<li>the model class</li>
<li>an alias, usually the class name prefixed by the library name</li>
<li>a shape calculator which computes the type and shape of the expected outputs</li>
<li>a model converter</li>
</ul>
<p>The following lines shows what these four elements are for a random forest:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onnxmltools.convert.common.shape_calculator</span> <span class="k">import</span> <span class="n">calculate_linear_classifier_output_shapes</span>
<span class="kn">from</span> <span class="nn">skl2onnx.operator_converters.RandomForest</span> <span class="k">import</span> <span class="n">convert_sklearn_random_forest_classifier</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="k">import</span> <span class="n">update_registered_converter</span>
<span class="n">update_registered_converter</span><span class="p">(</span><span class="n">SGDClassifier</span><span class="p">,</span> <span class="s1">&#39;SklearnLinearClassifier&#39;</span><span class="p">,</span>
                            <span class="n">calculate_linear_classifier_output_shapes</span><span class="p">,</span>
                            <span class="n">convert_sklearn_random_forest_classifier</span><span class="p">)</span>
</pre></div>
</div>
<p>See example <a class="reference internal" href="auto_examples/plot_pipeline_lightgbm.html#example-lightgbm"><span class="std std-ref">Convert a pipeline with a LightGbm model</span></a> to see a complete example
with a <em>LightGbm</em> model.</p>
</div>
<div class="section" id="titanic-example">
<h2><a class="toc-backref" href="#id4">Titanic example</a><a class="headerlink" href="#titanic-example" title="Permalink to this headline">¶</a></h2>
<p>The first example was a simplified pipeline coming from <em>scikit-learn</em>’s documentation:
<a class="reference external" href="https://scikit-learn.org/stable/auto_examples/compose/plot_column_transformer_mixed_types.html#sphx-glr-auto-examples-compose-plot-column-transformer-mixed-types-py">Column Transformer with Mixed Types</a>.
The full story is available in a runable exemple: <a class="reference internal" href="auto_examples/plot_complex_pipeline.html#example-complex-pipeline"><span class="std std-ref">Convert a pipeline with ColumnTransformer</span></a>
which also shows up some mistakes that a user could come accross
when trying to convert his pipeline.</p>
</div>
<div class="section" id="parameterize-the-conversion">
<h2><a class="toc-backref" href="#id5">Parameterize the conversion</a><a class="headerlink" href="#parameterize-the-conversion" title="Permalink to this headline">¶</a></h2>
<p>Most of the converter do not require specific options
to convert a <em>scikit-learn</em> model. It always produces the same
results. However, in some cases, the conversion cannot produce
a model which returns the exact same results. The user may want
to optimize the conversion by giving the converter additional
information, even if the model to convert is included in a
pipeline. That why the option mechanism was implemented:
<span class="xref std std-ref">l-conv-options</span>.</p>
</div>
</div>

    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"
        integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js"
        integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/js/bootstrap.min.js"
        integrity="sha384-ux8v3A6CPtOTqOzMKiuo3d/DomGaaClxFYdCu2HPMBEkf6x2xiDyJ7gkXU0MWwaD"
        crossorigin="anonymous"></script>
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="_static/searchtools.js"></script>
<script>$('#searchbox').show(0)</script>
</body>
</html>