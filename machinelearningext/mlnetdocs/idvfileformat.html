
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>IDV File Format &#8212; Custom Extensions to ML.net 0.8.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/font-awesome@4.5.0/css/font-awesome.min.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.14.0/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Key Values" href="keyvalues.html" />
    <link rel="prev" title="IDataView Type System" href="idataviewtypesystem.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="idv-file-format">
<span id="idv-file-format"></span><h1>IDV File Format<a class="headerlink" href="#idv-file-format" title="Permalink to this headline">¶</a></h1>
<p>This document describes ML.NET’s Binary dataview file format, version 1.1.1.5
written by the <code class="docutils literal notranslate"><span class="pre">BinarySaver</span></code> and <code class="docutils literal notranslate"><span class="pre">BinaryLoader</span></code> classes, commonly known as the
<code class="docutils literal notranslate"><span class="pre">.idv</span></code> format.</p>
<div class="section" id="goal-of-the-format">
<span id="goal-of-the-format"></span><h2>Goal of the Format<a class="headerlink" href="#goal-of-the-format" title="Permalink to this headline">¶</a></h2>
<p>A dataview is a collection of columns, over some number of rows. (Do not
confuse column with features. Columns can be and often are vector valued, and
it is expected though not required that commonly all features will be together
in one vector valued column.)</p>
<p>The actual values are stored in blocks. A block holds values for a single
column across multiple rows. Block format is dictated by a codec. There is a
table-of-contents and lookup table to facilitate quasi-random access to
particular blocks. (Quasi in the sense that you can only seek to a block, not
to a particular within a block.)</p>
</div>
<div class="section" id="general-data-format">
<span id="general-data-format"></span><h2>General Data Format<a class="headerlink" href="#general-data-format" title="Permalink to this headline">¶</a></h2>
<p>Before we discuss the format itself we will establish some conventions on how
individual scalar values, strings, and other data is serialized. All basic
pieces of data (for example, a single number, or a single string) are encoded in ways
reflecting the semantics of the .NET <code class="docutils literal notranslate"><span class="pre">BinaryWriter</span></code> class, those semantics
being:</p>
<ul class="simple">
<li>All numbers are stored as little-endian, using their natural fix-length
binary encoding.</li>
<li>Strings are stored using an unsigned
<a class="reference external" href="https://en.wikipedia.org/wiki/LEB128">LEB128</a> number describing the number
of bytes, followed by that many bytes containing the UTF-8 encoded string.</li>
</ul>
<p>A note about this: LEB128 is a simple encoding to encode arbitrarily large
integers. Each byte of 8-bits follows this convention. The most significant
bit is 0 if and only if this is the end of the LEB128 encoding. The remaining
7 bits are a part of the number being encoded. The bytes are stored
little-endian, that is, the first byte holds the 7 least significant bits, the
second byte (if applicable) holds the next 7 least significant bits, etc., and
the last byte holds the 7 most significant bits. LEB128 is used one or two
places in this format. (I might tend to prefer use of LEB128 in places where
we are writing values that, on balance, we expect to be relatively small, and
only in cases where there is no potential for benefit for random access to the
associated stream, since LEB128 is incompatible with random access. However,
this is not formulated into anything approaching a definite policy.)</p>
</div>
<div class="section" id="header">
<span id="header"></span><h2>Header<a class="headerlink" href="#header" title="Permalink to this headline">¶</a></h2>
<p>Every binary instances stream has a header composed of 256 bytes, at the start
of the stream. Not all bytes are used. Those bytes that are not explicitly
used have undefined content, and can have anything in them. We strongly
encourage writers of this format to insert obscene messages in this dead
space. The content is defined as follows (the offsets being the start of that
column).</p>
<p>Offsets | Type  | Name and Description
——–|——-|———————
0       | ulong | <strong>Signature</strong>: The magic number of this file.
8       | ulong | <strong>Version</strong>: Indicates the version of the data file.
16      | ulong | <strong>CompatibleVersion</strong>: Indicates the minimum reader version that can interpret this file, possibly with some data loss.
24      | long  | <strong>TableOfContentsOffset</strong>: The offset to the column table of contents structure.
32      | long  | <strong>TailOffset</strong>: The eight-byte tail signature starts at this offset. So, the entire dataset stream should be considered to have byte length of eight plus this value.
40      | long  | <strong>RowCount</strong>: The number of rows in this data file.
48      | int   | <strong>ColumnCount</strong>: The number of columns in this data file.</p>
<p>Notes on these:</p>
<ul class="simple">
<li>The signature of this file is <code class="docutils literal notranslate"><span class="pre">0x00425644004C4D43</span></code>, which is, when written
little-endian to a file, <code class="docutils literal notranslate"><span class="pre">CML</span> <span class="pre">DVB</span></code> with null characters in the place of
spaces. These letters are intended  to suggest “CloudML DataView Binary.”</li>
<li>The tail signature is the byte-reversed version of this, that is,
<code class="docutils literal notranslate"><span class="pre">0x434D4C0044564200</span></code>.</li>
<li>Versions are encoded as four 16-bit unsigned numbers passed into a single
ulong, with higher order bits being a more major version. The first
supported version of the is 1.1.1.4, that is, <code class="docutils literal notranslate"><span class="pre">0x0001000100010004</span></code>.
(Versions prior to 1.1.1.4 did exist, but were not released, so we do not
support them, though we do describe them in this document for the sake of
completeness.)</li>
</ul>
</div>
<div class="section" id="table-of-contents-format">
<span id="table-of-contents-format"></span><h2>Table of Contents Format<a class="headerlink" href="#table-of-contents-format" title="Permalink to this headline">¶</a></h2>
<p>The table of contents are packed entries, with there being as many entries as
there are columns. The version field here indicates the versions where that
entry is written. ≥ indicates the field occurred in versions after and
including that version, = indicates the field occurs only in that version.</p>
<p>Description | Entry Type | Version
————|————|——–
Column name | string     | ≥1.1.1.1
Codec loadname | string  | ≥1.1.1.1
Codec parameterization length | LEB128 integer | ≥1.1.1.1
Codec parameterization, which must have precisely the length indicated above | arbitrary, but with specified length | ≥1.1.1.1
Compression kind | CompressionKind (byte) | ≥1.1.1.1
Rows per block in this column | LEB128 integer | ≥1.1.1.1
Lookup table offset | long | ≥1.1.1.1
Slot names offset, or 0 if this column has no slot names, if 1.1.1.2 behave as if there are no slot names, with this having value 0) | long | =1.1.1.3
Slot names byte size (present only if slot names offset is greater than 0) | long | =1.1.1.3
Slot names count (present only if slot names offset is greater than 0) | int | =1.1.1.3
Metadata table of contents offset, or 0 if there is no metadata (1.1.1.4) | long | ≥1.1.1.4</p>
<p>For those working in the ML.NET codebase: The three <code class="docutils literal notranslate"><span class="pre">Codec</span></code> fields are handled
by the <code class="docutils literal notranslate"><span class="pre">CodecFactory.WriteCodec/TryReadCodec</span></code> methods, with the definition
stream being at the start of the codec loadname, and being at the end of the
codec parameterization, both in the case of success or failure.</p>
<p>CompressionCodec enums are described below, and describe the compression
algorithm used to compress blocks.</p>
<div class="section" id="compression-kind">
<span id="compression-kind"></span><h3>Compression Kind<a class="headerlink" href="#compression-kind" title="Permalink to this headline">¶</a></h3>
<p>The enum for compression kind is one byte, and follows this scheme:</p>
<p>Compression Kind                                               | Code
—————————————————————|—–
None                                                           | 0
DEFLATE (i.e., <a class="reference external" href="https://www.ietf.org/rfc/rfc1951.txt">RFC1951</a>) | 1
zlib (i.e., <a class="reference external" href="https://www.ietf.org/rfc/rfc1950.txt">RFC1950</a>)    | 2</p>
<p>None means no compression. DEFLATE is the default scheme. There is a tendency
to conflate zlib and DEFLATE, so to be clear: zlib can be (somewhat inexactly)
considered a wrapped version of DEFLATE, but it is still a distinct (but
closely related) format. However, both are implemented by the zlib library,
which is probably the source of the confusion.</p>
</div>
</div>
<div class="section" id="metadata-table-of-contents-format">
<span id="metadata-table-of-contents-format"></span><h2>Metadata Table of Contents Format<a class="headerlink" href="#metadata-table-of-contents-format" title="Permalink to this headline">¶</a></h2>
<p>The metadata table of contents begins with a LEB128 integer describing the
number of entries. (Should be a positive value, since if a column has no
metadata the expectation is that the offset for the metadata TOC will be
stored as 0.) What follows that are that many packed entries. Each entry is
somewhat akin to the column table of contents entry, with some simplifications
considering that there will be exactly one “block” with one item.</p>
<p>Description                                            | Entry Type
——————————————————-|————
Metadata kind                                          | string
Codec loadname                                         | string
Codec parameterization length                          | LEB128 integer
Codec parameterization, which must have precisely the length indicated above | arbitrary, but with specified length
Compression kind                                       | CompressionKind(byte)
Offset of the block where the metadata item is written | long
Byte length of the block                               | LEB128 integer</p>
<p>The “block” written is written in exactly same format as the main content
blocks. This will be very slightly inefficient as that scheme is sometimes
written to accommodate many entries, but I don’t expect that to be much of a
burden.</p>
</div>
<div class="section" id="lookup-table-format">
<span id="lookup-table-format"></span><h2>Lookup Table Format<a class="headerlink" href="#lookup-table-format" title="Permalink to this headline">¶</a></h2>
<p>Each table of contents entry is associated with a lookup table starting at the
indicated lookup table offset. It is written as packed binary, with each
lookup entry consisting of 16 bytes. So in all, the lookup table takes 16
bytes, times the total number of blocks for this column.</p>
<p>Description                                               | Entry Type
———————————————————-|———–
Block offset, position in the file where the block starts | long
Block length, its size in bytes in the file               | int
Uncompressed block length, its size in bytes if the block bytes were decompressed according to the column’s compression codec | int</p>
</div>
<div class="section" id="slot-names">
<span id="slot-names"></span><h2>Slot Names<a class="headerlink" href="#slot-names" title="Permalink to this headline">¶</a></h2>
<p>If slot names are stored, they are stored as pairs of integer index/string
pairs. As many pairs are stored as count of slot names were present in the
table of contents entry. Note that this only appeared in version 1.1.1.3. With
1.1.1.4 and later, slot names were just considered yet another piece of
metadata.</p>
<p>Description       | Entry Type
——————|———–
Index of the slot | int
The slot name     | string</p>
</div>
<div class="section" id="block-format">
<span id="block-format"></span><h2>Block Format<a class="headerlink" href="#block-format" title="Permalink to this headline">¶</a></h2>
<p>Columns are ordered into blocks, with each block holding the binary encoded
values for one particular columns across a range of rows. So for example, if
the column’s table of contents describes it as having 1000 rows per block, the
first block will contain the values for the column for rows 0 through 999,
second block 1000 through 1999, etc., with all blocks containing the same
number of blocks, except the last block which will contain fewer items (unless
the number of rows just so happens to be a multiple of the block size).</p>
<p>Each column is a possibly compressed sequence of bytes, compressed according
to the compression type field in the table of contents.  It begins and ends at
the offsets indicated in the metadata entry stored in the directory. The
uncompressed bytes will be stored in the format as described by the codec.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/project_ico.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Custom Extensions to ML.net</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataframe.html">DataFrames in C#</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commandline.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">ML.net Components</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../machinelearning_docs.html">ML.net details</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">ML.net details</a></li>
<li class="toctree-l2"><a class="reference internal" href="changes.html">ML.net releases details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts.html">Scikit.ML details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apicsharpdoc.html">CSharp API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aonnx.html">ML.net and ONNX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incompatibilities.html">ML.net customization</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../machinelearning_docs.html">ML.net details</a><ul>
  <li><a href="index.html">ML.net details</a><ul>
      <li>Previous: <a href="idataviewtypesystem.html" title="previous chapter"><code class="docutils literal notranslate"><span class="pre">IDataView</span></code> Type System</a></li>
      <li>Next: <a href="keyvalues.html" title="next chapter">Key Values</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/mlnetdocs/idvfileformat.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>