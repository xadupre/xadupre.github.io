
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ML.NET Cookbook &#8212; Custom Extensions to ML.net 0.8.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/font-awesome@4.5.0/css/font-awesome.min.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.14.0/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ML.NET high-level concepts" href="mlnethighlevelconcepts.html" />
    <link rel="prev" title="Key Values" href="keyvalues.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="ml-net-cookbook">
<span id="ml-net-cookbook"></span><h1>ML.NET Cookbook<a class="headerlink" href="#ml-net-cookbook" title="Permalink to this headline">¶</a></h1>
<p>This document is intended to provide essential samples for common usage patterns of ML.NET.
It is advisable to be at least minimally familiar with <a class="reference external" href="MlNetHighLevelConcepts.md">high-level concepts of ML.NET</a>, otherwise the terminology in this document may be foreign to you.</p>
<div class="section" id="how-to-use-this-cookbook">
<span id="how-to-use-this-cookbook"></span><h2>How to use this cookbook<a class="headerlink" href="#how-to-use-this-cookbook" title="Permalink to this headline">¶</a></h2>
<p>Developers often work by copying and pasting source code from somewhere and then adapting it to their needs. We do it all the time.</p>
<p>So, we decided to embrace the pattern and provide an authoritative set of example usages of ML.NET, for many common scenarios that you may encounter.
These examples are multi-purpose:</p>
<ul class="simple">
<li>They can kickstart your development, so that you don’t start from nothing,</li>
<li>They are annotated and verbose, so you have easier time adapting them to your needs.</li>
</ul>
<p>Each sample also contains a snippet of the data file used in the sample. We mostly use snippets from our test datasets for that.</p>
<p>Please feel free to search this page and use any code that suits your needs.</p>
<div class="section" id="list-of-recipes">
<span id="list-of-recipes"></span><h3>List of recipes<a class="headerlink" href="#list-of-recipes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="#how-do-i-load-data-from-a-text-file">How do I load data from a text file?</a></li>
<li><a class="reference external" href="#how-do-i-load-data-with-many-columns-from-a-csv">How do I load data with many columns from a CSV?</a></li>
<li><a class="reference external" href="#how-do-i-debug-my-experiment-or-preview-my-pipeline">How do I debug my experiment or preview my pipeline?</a></li>
<li><a class="reference external" href="#how-do-i-look-at-the-intermediate-data">How do I look at the intermediate data?</a></li>
<li><a class="reference external" href="#how-do-i-train-a-regression-model">How do I train a regression model?</a></li>
<li><a class="reference external" href="#how-do-i-verify-the-model-quality">How do I verify the model quality?</a></li>
<li><a class="reference external" href="#how-do-i-save-and-load-the-model">How do I save and load the model?</a></li>
<li><a class="reference external" href="#how-do-i-use-the-model-to-make-one-prediction">How do I use the model to make one prediction?</a></li>
<li><a class="reference external" href="#what-if-my-training-data-is-not-in-a-text-file">What if my training data is not in a text file?</a></li>
<li><a class="reference external" href="#i-want-to-look-at-my-models-coefficients">I want to look at my model’s coefficients</a></li>
<li><a class="reference external" href="#what-is-normalization-and-why-do-i-need-to-care">What is normalization and why do I need to care?</a></li>
<li><a class="reference external" href="#how-do-i-train-my-model-on-categorical-data">How do I train my model on categorical data?</a></li>
<li><a class="reference external" href="#how-do-i-train-my-model-on-textual-data">How do I train my model on textual data?</a></li>
<li><a class="reference external" href="#how-do-i-train-using-cross-validation">How do I train using cross-validation?</a></li>
<li><a class="reference external" href="#can-i-mix-and-match-static-and-dynamic-pipelines">Can I mix and match static and dynamic pipelines?</a></li>
<li><a class="reference external" href="#how-can-i-define-my-own-transformation-of-data">How can I define my own transformation of data?</a></li>
</ul>
</div>
<div class="section" id="general-questions-about-the-samples">
<span id="general-questions-about-the-samples"></span><h3>General questions about the samples<a class="headerlink" href="#general-questions-about-the-samples" title="Permalink to this headline">¶</a></h3>
<p>As this document is reviewed, we found that certain general clarifications are in order about all the samples together. We try to address them in this section.</p>
<ul class="simple">
<li><em>My compiler fails to find some of the methods that are present in the samples!</em>
This is because we rely on extension methods a lot, and they only become available after you say <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">TheRightNamespace</span></code>.
We are still re-organizing the namespaces, and trying to improve the story. In the meantime, the following namespaces prove useful for extension methods:</li>
</ul>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">Microsoft.ML.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.StaticPipe</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Trainers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Transforms</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><em>Why is there two ways of doing things? Which one is better, static or dynamic?</em>
We don’t know yet, that’s why we have two ways!</li>
</ul>
<p>If you are loading an existing model from a stream, there’s no need to use static types (and it’s also pretty hard to do). Also, if the data view’s schema is only known at runtime, there is no way to use static types. In other scenarios we tend to prefer the static types, since this way gives you compiler support: it’s more likely that, if your code compiles, it will also work as intended.</p>
<ul class="simple">
<li><em>Why do we call <code class="docutils literal notranslate"><span class="pre">reader.MakeNewEstimator</span></code> to create a pipeline?</em>
In the static pipeline, we need to know the two ‘schema’ types: the input and the output to the pipeline.
One of them is already known: typically, the output schema of <code class="docutils literal notranslate"><span class="pre">reader</span></code> (which is the same as the schema of <code class="docutils literal notranslate"><span class="pre">reader.Read()</span></code>) is also the input schema of the learning pipeline.</li>
</ul>
<p>The call to <code class="docutils literal notranslate"><span class="pre">x.MakeNewEstimator</span></code> is only using the <code class="docutils literal notranslate"><span class="pre">x</span></code>’s <em>schema</em> to create an empty pipeline, it doesn’t use anything else from <code class="docutils literal notranslate"><span class="pre">x</span></code>. So, the following three lines would create the exactly same (empty) pipeline:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">p1</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">p2</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataLocation</span><span class="p">).</span><span class="n">MakeNewEstimator</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">p3</span> <span class="p">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">();</span>
</pre></div>
</div>
<ul class="simple">
<li><em>Can we use <code class="docutils literal notranslate"><span class="pre">reader</span></code> to read more than one file?</em>
Absolutely! This is why we separated <code class="docutils literal notranslate"><span class="pre">reader</span></code> from the data. This is completely legitimate (and recommended):</li>
</ul>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">trainDataLocation</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">testData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">testDataLocation</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-do-i-load-data-from-a-text-file">
<span id="how-do-i-load-data-from-a-text-file"></span><h2>How do I load data from a text file?<a class="headerlink" href="#how-do-i-load-data-from-a-text-file" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">TextLoader</span></code> is used to load data from text files. You will need to specify what are the data columns, what are their types, and where to find them in the text file.</p>
<p>Note that it’s perfectly acceptable to read only some columns of a file, or read the same column multiple times.</p>
<p><a class="reference external" href="../../test/data/adult.tiny.with-schema.txt">Example file</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Label</span>   <span class="n">Workclass</span>   <span class="n">education</span>   <span class="n">marital</span><span class="o">-</span><span class="n">status</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="mi">11</span><span class="n">th</span>    <span class="n">Never</span><span class="o">-</span><span class="n">married</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="n">HS</span><span class="o">-</span><span class="n">grad</span> <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
<span class="mi">1</span>   <span class="n">Local</span><span class="o">-</span><span class="n">gov</span>   <span class="n">Assoc</span><span class="o">-</span><span class="n">acdm</span>  <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
<span class="mi">1</span>   <span class="n">Private</span> <span class="n">Some</span><span class="o">-</span><span class="n">college</span>    <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
</pre></div>
</div>
<p>This is how you can read this data:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// A boolean column depicting the &#39;target label&#39;.</span>
        <span class="n">IsOver50K</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadBool</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="c1">// Three text columns.</span>
        <span class="n">Workclass</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">Education</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
        <span class="n">MaritalStatus</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">3</span><span class="p">)),</span>
    <span class="n">hasHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">// Now read the file (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>
</pre></div>
</div>
<p>If the schema of the data is not known at compile time, or too cumbersome, you can revert to the dynamically-typed API:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// A boolean column depicting the &#39;label&#39;.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;IsOver50K&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">BL</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="c1">// Three text columns.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Workclass&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Education&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;MaritalStatus&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="c1">// First line of the file is a header, not a data row.</span>
    <span class="n">HasHeader</span> <span class="p">=</span> <span class="k">true</span>
<span class="p">});</span>

<span class="c1">// Now read the file (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-load-data-from-multiple-files">
<span id="how-do-i-load-data-from-multiple-files"></span><h2>How do I load data from multiple files?<a class="headerlink" href="#how-do-i-load-data-from-multiple-files" title="Permalink to this headline">¶</a></h2>
<p>You can again use the <code class="docutils literal notranslate"><span class="pre">TextLoader</span></code>, and specify an array of files to its Read method.
The files need to have the same schema (same number and type of columns)</p>
<p><a class="reference external" href="../../test/data/adult.train">Example file1</a>:
<a class="reference external" href="../../test/data/adult.test">Example file2</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Label</span>   <span class="n">Workclass</span>   <span class="n">education</span>   <span class="n">marital</span><span class="o">-</span><span class="n">status</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="mi">11</span><span class="n">th</span>    <span class="n">Never</span><span class="o">-</span><span class="n">married</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="n">HS</span><span class="o">-</span><span class="n">grad</span> <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
<span class="mi">1</span>   <span class="n">Local</span><span class="o">-</span><span class="n">gov</span>   <span class="n">Assoc</span><span class="o">-</span><span class="n">acdm</span>  <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
<span class="mi">1</span>   <span class="n">Private</span> <span class="n">Some</span><span class="o">-</span><span class="n">college</span>    <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
</pre></div>
</div>
<p>This is how you can read this data:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// A boolean column depicting the &#39;target label&#39;.</span>
        <span class="n">IsOver50K</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadBool</span><span class="p">(</span><span class="m">14</span><span class="p">),</span>
        <span class="c1">// Three text columns.</span>
        <span class="n">Workclass</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">Education</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
        <span class="n">MaritalStatus</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">5</span><span class="p">)),</span>
    <span class="n">hasHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">// Now read the files (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">exampleFile1</span><span class="p">,</span> <span class="n">exampleFile2</span><span class="p">);</span>
</pre></div>
</div>
<p>The code is very similar using the dynamic API:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// A boolean column depicting the &#39;label&#39;.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;IsOver50k&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">BL</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="c1">// Three text columns.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Workclass&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Education&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;MaritalStatus&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="c1">// First line of the file is a header, not a data row.</span>
    <span class="n">HasHeader</span> <span class="p">=</span> <span class="k">true</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">exampleFile1</span><span class="p">,</span> <span class="n">exampleFile2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-load-data-with-many-columns-from-a-csv">
<span id="how-do-i-load-data-with-many-columns-from-a-csv"></span><h2>How do I load data with many columns from a CSV?<a class="headerlink" href="#how-do-i-load-data-with-many-columns-from-a-csv" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">TextLoader</span></code> is used to load data from text files. You will need to specify what are the data columns, what are their types, and where to find them in the text file.</p>
<p>When the input file contains many columns of the same type, always intended to be used together, we recommend reading them as a <em>vector column</em> from the very start: this way the schema of the data is cleaner, and we don’t incur unnecessary performance costs.</p>
<p><a class="reference external" href="../../test/data/generated_regression_dataset.csv">Example file</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">0.77</span><span class="p">,</span><span class="o">-</span><span class="mf">0.61</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">1.39</span><span class="p">,</span><span class="mf">0.38</span><span class="p">,</span><span class="o">-</span><span class="mf">0.53</span><span class="p">,</span><span class="o">-</span><span class="mf">0.50</span><span class="p">,</span><span class="o">-</span><span class="mf">2.13</span><span class="p">,</span><span class="o">-</span><span class="mf">0.39</span><span class="p">,</span><span class="mf">0.46</span><span class="p">,</span><span class="mf">140.66</span>
<span class="o">-</span><span class="mf">0.61</span><span class="p">,</span><span class="o">-</span><span class="mf">0.37</span><span class="p">,</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span><span class="mf">0.55</span><span class="p">,</span><span class="o">-</span><span class="mf">1.00</span><span class="p">,</span><span class="mf">0.84</span><span class="p">,</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">1.30</span><span class="p">,</span><span class="o">-</span><span class="mf">0.24</span><span class="p">,</span><span class="o">-</span><span class="mf">0.50</span><span class="p">,</span><span class="o">-</span><span class="mf">2.12</span><span class="p">,</span><span class="mf">148.12</span>
<span class="o">-</span><span class="mf">0.85</span><span class="p">,</span><span class="o">-</span><span class="mf">0.91</span><span class="p">,</span><span class="mf">1.81</span><span class="p">,</span><span class="mf">0.02</span><span class="p">,</span><span class="o">-</span><span class="mf">0.78</span><span class="p">,</span><span class="o">-</span><span class="mf">1.41</span><span class="p">,</span><span class="o">-</span><span class="mf">1.09</span><span class="p">,</span><span class="o">-</span><span class="mf">0.65</span><span class="p">,</span><span class="mf">0.90</span><span class="p">,</span><span class="o">-</span><span class="mf">0.37</span><span class="p">,</span><span class="o">-</span><span class="mf">0.22</span><span class="p">,</span><span class="mf">402.20</span>
<span class="mf">0.28</span><span class="p">,</span><span class="mf">1.05</span><span class="p">,</span><span class="o">-</span><span class="mf">0.24</span><span class="p">,</span><span class="mf">0.30</span><span class="p">,</span><span class="o">-</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.19</span><span class="p">,</span><span class="mf">0.32</span><span class="p">,</span><span class="o">-</span><span class="mf">0.95</span><span class="p">,</span><span class="o">-</span><span class="mf">1.19</span><span class="p">,</span><span class="o">-</span><span class="mf">0.63</span><span class="p">,</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">443.51</span>
</pre></div>
</div>
<p>Reading this file using <code class="docutils literal notranslate"><span class="pre">TextLoader</span></code>:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// We read the first 11 values as a single float vector.</span>
        <span class="n">FeatureVector</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span>
        <span class="c1">// Separately, read the target variable.</span>
        <span class="n">Target</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">11</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Default separator is tab, but we need a comma.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>


<span class="c1">// Now read the file (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>
</pre></div>
</div>
<p>If the schema of the data is not known at compile time, or too cumbersome, you can revert to the dynamically-typed API:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// We read the first 10 values as a single float vector.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;FeatureVector&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">9</span><span class="p">)}),</span>
        <span class="c1">// Separately, read the target variable.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Target&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="c1">// Default separator is tab, but we need a comma.</span>
    <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Separator</span> <span class="p">=</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>

<span class="c1">// Now read the file (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-debug-my-experiment-or-preview-my-pipeline">
<span id="how-do-i-debug-my-experiment-or-preview-my-pipeline"></span><h2>How do I debug my experiment or preview my pipeline?<a class="headerlink" href="#how-do-i-debug-my-experiment-or-preview-my-pipeline" title="Permalink to this headline">¶</a></h2>
<p>Most ML.NET operations are ‘lazy’: they are not actually processing data, they just validate that the operation is possible, and then defer execution until the output data is actually requested. This provides good efficiency, but makes it hard to step through and debug the experiment.</p>
<p>In order to improve debug-ability, we have added a <code class="docutils literal notranslate"><span class="pre">Preview()</span></code> extension method to all data views, transformers, estimators and readers:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Preview</span></code> of a data view contains first 100 rows (configurable) of the data view, encoded as objects, in a single in-memory structure.</li>
<li><code class="docutils literal notranslate"><span class="pre">Preview</span></code> of a transformer takes data as input, and outputs the preview of the transformed data.</li>
<li><code class="docutils literal notranslate"><span class="pre">Preview</span></code> of an estimator also takes data as input, fits an ‘approximated model’ on the first 100 rows (configurable) of data, and then outputs the preview of the resulting transformer.</li>
</ul>
<p>We tried to make <code class="docutils literal notranslate"><span class="pre">Preview</span></code> debugger-friendly: our expectation is that, if you enter, say <code class="docutils literal notranslate"><span class="pre">data.Preview()</span></code> in your Watch window, you will be able to easily inspect the data there.</p>
<p>Here is the code sample:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">estimator</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Categorical</span><span class="p">.</span><span class="n">MapValueToKey</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">StochasticDualCoordinateAscent</span><span class="p">())</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Conversion</span><span class="p">.</span><span class="n">MapKeyToValue</span><span class="p">(</span><span class="s">&quot;PredictedLabel&quot;</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">ReadFromTextFile</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">[]</span> <span class="p">{</span>
    <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">Text</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
    <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span> <span class="p">},</span> <span class="n">filePath</span><span class="p">);</span>

<span class="c1">// Preview the data. </span>
<span class="kt">var</span> <span class="n">dataPreview</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Preview</span><span class="p">();</span>

<span class="c1">// Preview the result of training and transformation.</span>
<span class="kt">var</span> <span class="n">transformationPreview</span> <span class="p">=</span> <span class="n">estimator</span><span class="p">.</span><span class="n">Preview</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-look-at-the-intermediate-data">
<span id="how-do-i-look-at-the-intermediate-data"></span><h2>How do I look at the intermediate data?<a class="headerlink" href="#how-do-i-look-at-the-intermediate-data" title="Permalink to this headline">¶</a></h2>
<p>Oftentimes, when we construct the experiment, we want to make sure that the data processing ‘up to a certain moment’ produces the results that we want. With ML.NET it is not very easy to do: since all ML.NET operations are lazy, the objects we construct are just ‘promises’ of data.</p>
<p>We will need to create the cursor and scan the data to obtain the actual values. One way to do this is to use <a class="reference external" href="SchemaComprehension.md">schema comprehension</a> and map the data to an <code class="docutils literal notranslate"><span class="pre">IEnumerable</span></code> of user-defined objects.</p>
<p>Another mechanism that lets you inspect the intermediate data is the <code class="docutils literal notranslate"><span class="pre">GetColumn&lt;T&gt;</span></code> extension method. It lets you look at the contents of one column of your data in a form of an <code class="docutils literal notranslate"><span class="pre">IEnumerable</span></code>.</p>
<p>Here is all of this in action:</p>
<p><a class="reference external" href="../../test/data/adult.tiny.with-schema.txt">Example file</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Label</span>   <span class="n">Workclass</span>   <span class="n">education</span>   <span class="n">marital</span><span class="o">-</span><span class="n">status</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="mi">11</span><span class="n">th</span>    <span class="n">Never</span><span class="o">-</span><span class="n">married</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="n">HS</span><span class="o">-</span><span class="n">grad</span> <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
<span class="mi">1</span>   <span class="n">Local</span><span class="o">-</span><span class="n">gov</span>   <span class="n">Assoc</span><span class="o">-</span><span class="n">acdm</span>  <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
<span class="mi">1</span>   <span class="n">Private</span> <span class="n">Some</span><span class="o">-</span><span class="n">college</span>    <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>
</pre></div>
</div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// A boolean column depicting the &#39;target label&#39;.</span>
        <span class="n">IsOver50K</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadBool</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="c1">// Three text columns.</span>
        <span class="n">Workclass</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">Education</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
        <span class="n">MaritalStatus</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">3</span><span class="p">)),</span>
    <span class="n">hasHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">// Start creating our processing pipeline. For now, let&#39;s just concatenate all the text columns</span>
<span class="c1">// together into one.</span>
<span class="kt">var</span> <span class="n">dataPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">row</span> <span class="p">=&gt;</span> <span class="p">(</span>
            <span class="n">row</span><span class="p">.</span><span class="n">IsOver50K</span><span class="p">,</span>
            <span class="n">AllFeatures</span><span class="p">:</span> <span class="n">row</span><span class="p">.</span><span class="n">Workclass</span><span class="p">.</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">Education</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">MaritalStatus</span><span class="p">)</span>
        <span class="p">));</span>

<span class="c1">// Let&#39;s verify that the data has been read correctly. </span>
<span class="c1">// First, we read the data file.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Fit our data pipeline and transform data with it.</span>
<span class="kt">var</span> <span class="n">transformedData</span> <span class="p">=</span> <span class="n">dataPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// &#39;transformedData&#39; is a &#39;promise&#39; of data. Let&#39;s actually read it.</span>
<span class="kt">var</span> <span class="n">someRows</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">AsDynamic</span>
    <span class="c1">// Convert to an enumerable of user-defined type. </span>
    <span class="p">.</span><span class="n">AsEnumerable</span><span class="p">&lt;</span><span class="n">InspectedRow</span><span class="p">&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="n">reuseRowObject</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
    <span class="c1">// Take a couple values as an array.</span>
    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">4</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Extract the &#39;AllFeatures&#39; column.</span>
<span class="c1">// This will give the entire dataset: make sure to only take several row</span>
<span class="c1">// in case the dataset is huge.</span>
<span class="kt">var</span> <span class="n">featureColumns</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">AllFeatures</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">20</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// The same extension method also applies to the dynamic-typed data, except you have to</span>
<span class="c1">// specify the column name and type:</span>
<span class="kt">var</span> <span class="n">dynamicData</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">AsDynamic</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">sameFeatureColumns</span> <span class="p">=</span> <span class="n">dynamicData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;AllFeatures&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">20</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>
</div>
<p>The above code assumes that we defined our <code class="docutils literal notranslate"><span class="pre">InspectedRow</span></code> class as follows:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">class</span> <span class="nc">InspectedRow</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsOver50K</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Workclass</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Education</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">MaritalStatus</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">AllFeatures</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also use the dynamic API to create the equivalent of the previous pipeline.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create the reader: define the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// A boolean column depicting the &#39;label&#39;.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;IsOver50k&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">BL</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="c1">// Three text columns.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Workclass&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Education&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;MaritalStatus&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="c1">// First line of the file is a header, not a data row.</span>
    <span class="n">HasHeader</span> <span class="p">=</span> <span class="k">true</span>
<span class="p">});</span>

<span class="c1">// Start creating our processing pipeline. For now, let&#39;s just concatenate all the text columns</span>
<span class="c1">// together into one.</span>
<span class="kt">var</span> <span class="n">dynamicPipeline</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="s">&quot;AllFeatures&quot;</span><span class="p">,</span> <span class="s">&quot;Education&quot;</span><span class="p">,</span> <span class="s">&quot;MaritalStatus&quot;</span><span class="p">);</span>

<span class="c1">// Let&#39;s verify that the data has been read correctly. </span>
<span class="c1">// First, we read the data file.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Fit our data pipeline and transform data with it.</span>
<span class="kt">var</span> <span class="n">transformedData</span> <span class="p">=</span> <span class="n">dynamicPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// &#39;transformedData&#39; is a &#39;promise&#39; of data. Let&#39;s actually read it.</span>
<span class="kt">var</span> <span class="n">someRows</span> <span class="p">=</span> <span class="n">transformedData</span>
    <span class="c1">// Convert to an enumerable of user-defined type. </span>
    <span class="p">.</span><span class="n">AsEnumerable</span><span class="p">&lt;</span><span class="n">InspectedRow</span><span class="p">&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="n">reuseRowObject</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
    <span class="c1">// Take a couple values as an array.</span>
    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">4</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Extract the &#39;AllFeatures&#39; column.</span>
<span class="c1">// This will give the entire dataset: make sure to only take several row</span>
<span class="c1">// in case the dataset is huge. The is similar to the static API, except</span>
<span class="c1">// you have to specify the column name and type.</span>
<span class="kt">var</span> <span class="n">featureColumns</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;AllFeatures&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">20</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-train-a-regression-model">
<span id="how-do-i-train-a-regression-model"></span><h2>How do I train a regression model?<a class="headerlink" href="#how-do-i-train-a-regression-model" title="Permalink to this headline">¶</a></h2>
<p>Generally, in order to train any model in ML.NET, you will go through three steps:</p>
<ol class="simple">
<li>Figure out how the training data gets into ML.NET in a form of an <code class="docutils literal notranslate"><span class="pre">IDataView</span></code></li>
<li>Build the ‘learning pipeline’ as a sequence of elementary ‘operators’ (estimators).</li>
<li>Call <code class="docutils literal notranslate"><span class="pre">Fit</span></code> on the pipeline to obtain the trained model.</li>
</ol>
<p><a class="reference external" href="../../test/data/generated_regression_dataset.csv">Example file</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feature_0</span><span class="p">;</span><span class="n">feature_1</span><span class="p">;</span><span class="n">feature_2</span><span class="p">;</span><span class="n">feature_3</span><span class="p">;</span><span class="n">feature_4</span><span class="p">;</span><span class="n">feature_5</span><span class="p">;</span><span class="n">feature_6</span><span class="p">;</span><span class="n">feature_7</span><span class="p">;</span><span class="n">feature_8</span><span class="p">;</span><span class="n">feature_9</span><span class="p">;</span><span class="n">feature_10</span><span class="p">;</span><span class="n">target</span>
<span class="o">-</span><span class="mf">2.75</span><span class="p">;</span><span class="mf">0.77</span><span class="p">;</span><span class="o">-</span><span class="mf">0.61</span><span class="p">;</span><span class="mf">0.14</span><span class="p">;</span><span class="mf">1.39</span><span class="p">;</span><span class="mf">0.38</span><span class="p">;</span><span class="o">-</span><span class="mf">0.53</span><span class="p">;</span><span class="o">-</span><span class="mf">0.50</span><span class="p">;</span><span class="o">-</span><span class="mf">2.13</span><span class="p">;</span><span class="o">-</span><span class="mf">0.39</span><span class="p">;</span><span class="mf">0.46</span><span class="p">;</span><span class="mf">140.66</span>
<span class="o">-</span><span class="mf">0.61</span><span class="p">;</span><span class="o">-</span><span class="mf">0.37</span><span class="p">;</span><span class="o">-</span><span class="mf">0.12</span><span class="p">;</span><span class="mf">0.55</span><span class="p">;</span><span class="o">-</span><span class="mf">1.00</span><span class="p">;</span><span class="mf">0.84</span><span class="p">;</span><span class="o">-</span><span class="mf">0.02</span><span class="p">;</span><span class="mf">1.30</span><span class="p">;</span><span class="o">-</span><span class="mf">0.24</span><span class="p">;</span><span class="o">-</span><span class="mf">0.50</span><span class="p">;</span><span class="o">-</span><span class="mf">2.12</span><span class="p">;</span><span class="mf">148.12</span>
<span class="o">-</span><span class="mf">0.85</span><span class="p">;</span><span class="o">-</span><span class="mf">0.91</span><span class="p">;</span><span class="mf">1.81</span><span class="p">;</span><span class="mf">0.02</span><span class="p">;</span><span class="o">-</span><span class="mf">0.78</span><span class="p">;</span><span class="o">-</span><span class="mf">1.41</span><span class="p">;</span><span class="o">-</span><span class="mf">1.09</span><span class="p">;</span><span class="o">-</span><span class="mf">0.65</span><span class="p">;</span><span class="mf">0.90</span><span class="p">;</span><span class="o">-</span><span class="mf">0.37</span><span class="p">;</span><span class="o">-</span><span class="mf">0.22</span><span class="p">;</span><span class="mf">402.20</span>
</pre></div>
</div>
<p>In the file above, the last column (12th) is label that we predict, and all the preceding ones are features.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// We read the first 11 values as a single float vector.</span>
        <span class="n">FeatureVector</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span>
        <span class="c1">// Separately, read the target variable.</span>
        <span class="n">Target</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">11</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// The data file has header.</span>
    <span class="n">hasHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span>
    <span class="c1">// Default separator is tab, but we need a semicolon.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;;&#39;</span><span class="p">);</span>


<span class="c1">// Now read the file (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">trainDataPath</span><span class="p">);</span>

<span class="c1">// Step two: define the learning pipeline. </span>

<span class="c1">// We &#39;start&#39; the pipeline with the output of the reader.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="c1">// Now we can add any &#39;training steps&#39; to it. In our case we want to &#39;normalize&#39; the data (rescale to be</span>
    <span class="c1">// between -1 and 1 for all examples)</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// Retain the &#39;Target&#39; column for evaluation purposes.</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Target</span><span class="p">,</span>
        <span class="c1">// We choose the SDCA regression trainer. Note that we normalize the &#39;FeatureVector&#39; right here in</span>
        <span class="c1">// the the same call.</span>
        <span class="n">Prediction</span><span class="p">:</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Regression</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">Sdca</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Target</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">FeatureVector</span><span class="p">.</span><span class="n">Normalize</span><span class="p">())));</span>

<span class="c1">// Step three. Fit the pipeline to the training data.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
</pre></div>
</div>
<p>You can also use the dynamic API to create the equivalent of the previous pipeline.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// We read the first 11 values as a single float vector.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;FeatureVector&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span>

        <span class="c1">// Separately, read the target variable.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Target&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">11</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="c1">// First line of the file is a header, not a data row.</span>
    <span class="n">HasHeader</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
    <span class="c1">// Default separator is tab, but we need a semicolon.</span>
    <span class="n">Separator</span> <span class="p">=</span> <span class="s">&quot;;&quot;</span>
<span class="p">});</span>

<span class="c1">// Now read the file (remember though, readers are lazy, so the actual reading will happen when the data is accessed).</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">trainDataPath</span><span class="p">);</span>

<span class="c1">// Step two: define the learning pipeline. </span>

<span class="c1">// We &#39;start&#39; the pipeline with the output of the reader.</span>
<span class="kt">var</span> <span class="n">dynamicPipeline</span> <span class="p">=</span>
    <span class="c1">// First &#39;normalize&#39; the data (rescale to be</span>
    <span class="c1">// between -1 and 1 for all examples)</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="s">&quot;FeatureVector&quot;</span><span class="p">)</span>
    <span class="c1">// Add the SDCA regression trainer.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Regression</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">StochasticDualCoordinateAscent</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="s">&quot;Target&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="s">&quot;FeatureVector&quot;</span><span class="p">));</span>

<span class="c1">// Step three. Fit the pipeline to the training data.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dynamicPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-verify-the-model-quality">
<span id="how-do-i-verify-the-model-quality"></span><h2>How do I verify the model quality?<a class="headerlink" href="#how-do-i-verify-the-model-quality" title="Permalink to this headline">¶</a></h2>
<p>This is the first question that arises after you train the model: how good it actually is?
For each of the machine learning tasks, there is a set of ‘metrics’ that can describe how good the model is: it could be log-loss or F1 score for classification, RMS or L1 loss for regression etc.</p>
<p>You can use the corresponding ‘context’ of the task to evaluate the model.</p>
<p>Assuming the example above was used to train the model, here’s how you calculate the metrics.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Read the test dataset.</span>
<span class="kt">var</span> <span class="n">testData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">testDataPath</span><span class="p">);</span>
<span class="c1">// Calculate metrics of the model on the test data.</span>
<span class="kt">var</span> <span class="n">metrics</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Regression</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">testData</span><span class="p">),</span> <span class="n">label</span><span class="p">:</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Target</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Prediction</span><span class="p">);</span>
</pre></div>
</div>
<p>Calculating the metrics with the dynamic API is as follows.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Read the test dataset.</span>
<span class="kt">var</span> <span class="n">testData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">testDataPath</span><span class="p">);</span>
<span class="c1">// Calculate metrics of the model on the test data.</span>
<span class="kt">var</span> <span class="n">metrics</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Regression</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">testData</span><span class="p">),</span> <span class="n">label</span><span class="p">:</span> <span class="s">&quot;Target&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-save-and-load-the-model">
<span id="how-do-i-save-and-load-the-model"></span><h2>How do I save and load the model?<a class="headerlink" href="#how-do-i-save-and-load-the-model" title="Permalink to this headline">¶</a></h2>
<p>Assuming that the model metrics look good to you, it’s time to ‘operationalize’ the model. This is where ML.NET really shines: the <code class="docutils literal notranslate"><span class="pre">model</span></code> object you just built is ready for immediate consumption, it will apply all the same steps that it has ‘learned’ during training, and it can be persisted and reused in different environments.</p>
<p>Here’s what you do to save the model to a file, and reload it (potentially in a different context).</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">modelPath</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Saving and loading happens to &#39;dynamic&#39; models, so the static typing is lost in the process.</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">AsDynamic</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Potentially, the lines below can be in a different process altogether.</span>

<span class="c1">// When you load the model, it&#39;s a &#39;dynamic&#39; transformer. </span>
<span class="n">ITransformer</span> <span class="n">loadedModel</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">OpenRead</span><span class="p">(</span><span class="n">modelPath</span><span class="p">))</span>
    <span class="n">loadedModel</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</pre></div>
</div>
<p>You can use the dynamic API to achieve the same.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">modelPath</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Saving and loading happens to &#39;dynamic&#39; models.</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Potentially, the lines below can be in a different process altogether.</span>

<span class="c1">// When you load the model, it&#39;s a &#39;dynamic&#39; transformer. </span>
<span class="n">ITransformer</span> <span class="n">loadedModel</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">OpenRead</span><span class="p">(</span><span class="n">modelPath</span><span class="p">))</span>
    <span class="n">loadedModel</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-use-the-model-to-make-one-prediction">
<span id="how-do-i-use-the-model-to-make-one-prediction"></span><h2>How do I use the model to make one prediction?<a class="headerlink" href="#how-do-i-use-the-model-to-make-one-prediction" title="Permalink to this headline">¶</a></h2>
<p>Since any ML.NET model is a transformer, you can of course use <code class="docutils literal notranslate"><span class="pre">model.Transform</span></code> to apply the model to the ‘data view’ and obtain predictions this way.</p>
<p>A more typical case, though, is when there is no ‘dataset’ that we want to predict on, but instead we receive one example at a time. For instance, we run the model as part of the ASP.NET website, and we need to make a prediction for an incoming HTTP request.</p>
<p>For this case, ML.NET offers a convenient <code class="docutils literal notranslate"><span class="pre">PredictionFunction</span></code> component, that essentially runs one example at a time through the prediction pipeline.</p>
<p>Here is the full example. Let’s imagine that we have built a model for the famous Iris prediction dataset:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// The four features of the Iris dataset.</span>
        <span class="n">SepalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="n">SepalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">PetalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
        <span class="n">PetalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

<span class="c1">// Retrieve the training data.</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">irisDataPath</span><span class="p">);</span>

<span class="c1">// Build the training pipeline.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Concatenate all the features together into one column &#39;Features&#39;.</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">SepalLength</span><span class="p">.</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">SepalWidth</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalLength</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalWidth</span><span class="p">)))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Train the multi-class SDCA model to predict the label using features.</span>
        <span class="c1">// Note that the label is a text, so it needs to be converted to key using &#39;ToKey&#39; estimator.</span>
        <span class="n">Predictions</span><span class="p">:</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">Sdca</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">.</span><span class="n">ToKey</span><span class="p">(),</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">)))</span>
    <span class="c1">// Apply the inverse conversion from &#39;predictedLabel&#39; key back to string value.</span>
    <span class="c1">// Note that the final output column is only one, and we didn&#39;t assign a name to it.</span>
    <span class="c1">// In this case, ML.NET auto-assigns the name &#39;Data&#39; to the produced column.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Predictions</span><span class="p">.</span><span class="n">predictedLabel</span><span class="p">.</span><span class="n">ToValue</span><span class="p">());</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">).</span><span class="n">AsDynamic</span><span class="p">;</span>
</pre></div>
</div>
<p>You can also use the dynamic API to create the equivalent of the previous pipeline.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;SepalLength&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;SepalWidth&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;PetalLength&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;PetalWidth&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">4</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">Separator</span> <span class="p">=</span> <span class="s">&quot;,&quot;</span>
<span class="p">});</span>

<span class="c1">// Retrieve the training data.</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">irisDataPath</span><span class="p">);</span>

<span class="c1">// Build the training pipeline.</span>
<span class="kt">var</span> <span class="n">dynamicPipeline</span> <span class="p">=</span>
    <span class="c1">// Concatenate all the features together into one column &#39;Features&#39;.</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;SepalLength&quot;</span><span class="p">,</span> <span class="s">&quot;SepalWidth&quot;</span><span class="p">,</span> <span class="s">&quot;PetalLength&quot;</span><span class="p">,</span> <span class="s">&quot;PetalWidth&quot;</span><span class="p">)</span>
    <span class="c1">// Note that the label is text, so it needs to be converted to key.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Categorical</span><span class="p">.</span><span class="n">MapValueToKey</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">),</span> <span class="n">TransformerScope</span><span class="p">.</span><span class="n">TrainTest</span><span class="p">)</span>
    <span class="c1">// Use the multi-class SDCA model to predict the label using features.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">StochasticDualCoordinateAscent</span><span class="p">())</span>
    <span class="c1">// Apply the inverse conversion from &#39;PredictedLabel&#39; column back to string value.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Conversion</span><span class="p">.</span><span class="n">MapKeyToValue</span><span class="p">((</span><span class="s">&quot;PredictedLabel&quot;</span><span class="p">,</span> <span class="s">&quot;Data&quot;</span><span class="p">)));</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dynamicPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, in order to use <a class="reference external" href="SchemaComprehension.md">schema comprehension</a> for prediction, we define a pair of classes like following:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">class</span> <span class="nc">IrisInput</span>
<span class="p">{</span>
    <span class="c1">// Unfortunately, we still need the dummy &#39;Label&#39; column to be present.</span>
<span class="na">    [ColumnName(&quot;Label&quot;)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">IgnoredLabel</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">SepalLength</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">SepalWidth</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">PetalLength</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">PetalWidth</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">class</span> <span class="nc">IrisPrediction</span>
<span class="p">{</span>
<span class="na">    [ColumnName(&quot;Data&quot;)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">PredictedClass</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The prediction code now looks as follows:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Use the model for one-time prediction.</span>
<span class="c1">// Make the prediction function object. Note that, on average, this call takes around 200x longer</span>
<span class="c1">// than one prediction, so you might want to cache and reuse the prediction function, instead of</span>
<span class="c1">// creating one per prediction.</span>
<span class="kt">var</span> <span class="n">predictionFunc</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">MakePredictionFunction</span><span class="p">&lt;</span><span class="n">IrisInput</span><span class="p">,</span> <span class="n">IrisPrediction</span><span class="p">&gt;(</span><span class="n">mlContext</span><span class="p">);</span>

<span class="c1">// Obtain the prediction. Remember that &#39;Predict&#39; is not reentrant. If you want to use multiple threads</span>
<span class="c1">// for simultaneous prediction, make sure each thread is using its own PredictionFunction.</span>
<span class="kt">var</span> <span class="n">prediction</span> <span class="p">=</span> <span class="n">predictionFunc</span><span class="p">.</span><span class="n">Predict</span><span class="p">(</span><span class="k">new</span> <span class="n">IrisInput</span>
<span class="p">{</span>
    <span class="n">SepalLength</span> <span class="p">=</span> <span class="m">4.1f</span><span class="p">,</span>
    <span class="n">SepalWidth</span> <span class="p">=</span> <span class="m">0.1f</span><span class="p">,</span>
    <span class="n">PetalLength</span> <span class="p">=</span> <span class="m">3.2f</span><span class="p">,</span>
    <span class="n">PetalWidth</span> <span class="p">=</span> <span class="m">1.4f</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="what-if-my-training-data-is-not-in-a-text-file">
<span id="what-if-my-training-data-is-not-in-a-text-file"></span><h2>What if my training data is not in a text file?<a class="headerlink" href="#what-if-my-training-data-is-not-in-a-text-file" title="Permalink to this headline">¶</a></h2>
<p>The commonly demonstrated use case for ML.NET is when the training data resides somewhere on disk, and we use the <code class="docutils literal notranslate"><span class="pre">TextLoader</span></code> to read it.
However, in real-time training scenarios the training data can be elsewhere: in a bunch of SQL tables, extracted from log files, or even generated on the fly.</p>
<p>Here is how we can use <a class="reference external" href="SchemaComprehension.md">schema comprehension</a> to bring an existing C# <code class="docutils literal notranslate"><span class="pre">IEnumerable</span></code> into ML.NET as a data view.</p>
<p>For the purpose of this example, we will assume that we build the customer churn prediction model, and we can extract the following features from our production system:</p>
<ul class="simple">
<li>Customer ID (ignored by the model)</li>
<li>Whether the customer has churned (the target ‘label’)</li>
<li>The ‘demographic category’ (one string, like ‘young adult’ etc.)</li>
<li>The number of visits from the last 5 days.</li>
</ul>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">class</span> <span class="nc">CustomerChurnInfo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">HasChurned</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">DemographicCategory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="c1">// Visits during last 5 days, latest to newest.</span>
<span class="na">    [VectorType(5)]</span>
    <span class="k">public</span> <span class="kt">float</span><span class="p">[]</span> <span class="n">LastVisits</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Given this information, here’s how we turn this data into the ML.NET data view and train on it:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// Let&#39;s assume that &#39;GetChurnData()&#39; fetches and returns the training data from somewhere.</span>
<span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CustomerChurnInfo</span><span class="p">&gt;</span> <span class="n">churnData</span> <span class="p">=</span> <span class="n">GetChurnInfo</span><span class="p">();</span>

<span class="c1">// Turn the data into the ML.NET data view.</span>
<span class="c1">// We can use CreateDataView or CreateStreamingDataView, depending on whether &#39;churnData&#39; is an IList, </span>
<span class="c1">// or merely an IEnumerable.</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">CreateStreamingDataView</span><span class="p">(</span><span class="n">churnData</span><span class="p">);</span>

<span class="c1">// Now note that &#39;trainData&#39; is just an IDataView, so we face a choice here: either declare the static type</span>
<span class="c1">// and proceed in the statically typed fashion, or keep dynamic types and build a dynamic pipeline.</span>
<span class="c1">// We demonstrate both below.</span>

<span class="c1">// Build the learning pipeline. </span>
<span class="c1">// In our case, we will one-hot encode the demographic category, and concatenate that with the number of visits.</span>
<span class="c1">// We apply our FastTree binary classifier to predict the &#39;HasChurned&#39; label.</span>

<span class="kt">var</span> <span class="n">dynamicLearningPipeline</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Categorical</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">(</span><span class="s">&quot;DemographicCategory&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;DemographicCategory&quot;</span><span class="p">,</span> <span class="s">&quot;LastVisits&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">FastTree</span><span class="p">(</span><span class="s">&quot;HasChurned&quot;</span><span class="p">,</span> <span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="n">numTrees</span><span class="p">:</span> <span class="m">20</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dynamicModel</span> <span class="p">=</span> <span class="n">dynamicLearningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>

<span class="c1">// Build the same learning pipeline, but statically typed.</span>
<span class="c1">// First, transition to the statically-typed data view.</span>
<span class="kt">var</span> <span class="n">staticData</span> <span class="p">=</span> <span class="n">trainData</span><span class="p">.</span><span class="n">AssertStatic</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span> <span class="n">c</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">HasChurned</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">Bool</span><span class="p">.</span><span class="n">Scalar</span><span class="p">,</span>
        <span class="n">DemographicCategory</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Scalar</span><span class="p">,</span>
        <span class="n">LastVisits</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">R4</span><span class="p">.</span><span class="n">Vector</span><span class="p">));</span>

<span class="c1">// Build the pipeline, same as the one above.</span>
<span class="kt">var</span> <span class="n">staticLearningPipeline</span> <span class="p">=</span> <span class="n">staticData</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">HasChurned</span><span class="p">,</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">DemographicCategory</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">().</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">LastVisits</span><span class="p">)))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">FastTree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">HasChurned</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">,</span> <span class="n">numTrees</span><span class="p">:</span> <span class="m">20</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">staticModel</span> <span class="p">=</span> <span class="n">staticLearningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">staticData</span><span class="p">);</span>

<span class="c1">// Note that dynamicModel should be the same as staticModel.AsDynamic (give or take random variance from</span>
<span class="c1">// the training procedure).</span>
</pre></div>
</div>
</div>
<div class="section" id="i-want-to-look-at-my-model-s-coefficients">
<span id="i-want-to-look-at-my-model-s-coefficients"></span><h2>I want to look at my model’s coefficients<a class="headerlink" href="#i-want-to-look-at-my-model-s-coefficients" title="Permalink to this headline">¶</a></h2>
<p>Oftentimes, once a model is trained, we are also interested on ‘what it has learned’.</p>
<p>For example, if the linear model assigned zero weight to a feature that we consider important, it could indicate some problem with modeling. The weights of the linear model can also be used as a poor man’s estimation of ‘feature importance’.</p>
<p>In the static pipeline API, we provide a set of <code class="docutils literal notranslate"><span class="pre">onFit</span></code> delegates that allow introspection of the individual transformers as they are trained.</p>
<p>This is how we can extract the learned parameters out of the model that we trained:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// The four features of the Iris dataset.</span>
        <span class="n">SepalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="n">SepalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">PetalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
        <span class="n">PetalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

<span class="c1">// Retrieve the training data.</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// This is the predictor (&#39;weights collection&#39;) that we will train.</span>
<span class="n">MulticlassLogisticRegressionPredictor</span> <span class="n">predictor</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="c1">// And these are the normalizer scales that we will learn.</span>
<span class="n">ImmutableArray</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;</span> <span class="n">normScales</span><span class="p">;</span>
<span class="c1">// Build the training pipeline.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Concatenate all the features together into one column &#39;Features&#39;.</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">SepalLength</span><span class="p">.</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">SepalWidth</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalLength</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalWidth</span><span class="p">)))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Normalize (rescale) the features to be between -1 and 1. </span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span>
            <span class="c1">// When the normalizer is trained, the below delegate is going to be called.</span>
            <span class="c1">// We use it to memorize the scales.</span>
            <span class="n">onFit</span><span class="p">:</span> <span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">normScales</span> <span class="p">=</span> <span class="n">scales</span><span class="p">)))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Train the multi-class SDCA model to predict the label using features.</span>
        <span class="c1">// Note that the label is a text, so it needs to be converted to key using &#39;ToKey&#39; estimator.</span>
        <span class="n">Predictions</span><span class="p">:</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">Sdca</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">.</span><span class="n">ToKey</span><span class="p">(),</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">,</span>
            <span class="c1">// When the model is trained, the below delegate is going to be called.</span>
            <span class="c1">// We use that to memorize the predictor object.</span>
            <span class="n">onFit</span><span class="p">:</span> <span class="n">p</span> <span class="p">=&gt;</span> <span class="n">predictor</span> <span class="p">=</span> <span class="n">p</span><span class="p">)));</span>

<span class="c1">// Train the model. During this call our &#39;onFit&#39; delegate will be invoked,</span>
<span class="c1">// and our &#39;predictor&#39; will be set.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>

<span class="c1">// Now we can use &#39;predictor&#39; to look at the weights.</span>
<span class="c1">// &#39;weights&#39; will be an array of weight vectors, one vector per class.</span>
<span class="c1">// Our problem has 3 classes, so numClasses will be 3, and weights will contain</span>
<span class="c1">// 3 vectors (of 4 values each).</span>
<span class="n">VBuffer</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;[]</span> <span class="n">weights</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="n">predictor</span><span class="p">.</span><span class="n">GetWeights</span><span class="p">(</span><span class="k">ref</span> <span class="n">weights</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">numClasses</span><span class="p">);</span>

<span class="c1">// Similarly we can also inspect the biases for the 3 classes.</span>
<span class="kt">var</span> <span class="n">biases</span> <span class="p">=</span> <span class="n">predictor</span><span class="p">.</span><span class="n">GetBiases</span><span class="p">();</span>

<span class="c1">// Inspect the normalizer scales.</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">normScales</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="what-is-normalization-and-why-do-i-need-to-care">
<span id="what-is-normalization-and-why-do-i-need-to-care"></span><h2>What is normalization and why do I need to care?<a class="headerlink" href="#what-is-normalization-and-why-do-i-need-to-care" title="Permalink to this headline">¶</a></h2>
<p>In ML.NET we expose a number of <a class="reference external" href="https://machinelearningmastery.com/parametric-and-nonparametric-machine-learning-algorithms/">parametric and non-parametric algorithms</a>.</p>
<p>Typically, parametric learners hold certain assumptions about the training data, and if they are not met, the training is greatly hampered (or sometimes becomes completely impossible).</p>
<p>Most commonly, the assumptions are that</p>
<ul class="simple">
<li>All the features have values roughly on the same scale;</li>
<li>Feature values are not too large, and not too small.</li>
</ul>
<p>Violating the first assumption above can cause the learner to train a sub-optimal model (or even a completely useless one). Violating the second assumption can cause arithmetic error accumulation, which typically breaks the training process altogether.</p>
<p>As a general rule, <em>if you use a parametric learner, you need to make sure your training data is correctly scaled</em>.</p>
<p>ML.NET offers several built-in scaling algorithms, or ‘normalizers’:</p>
<ul class="simple">
<li>MinMax normalizer: for each feature, we learn the minimum and maximum value of it, and then linearly rescale it so that the values fit between -1 and 1.</li>
<li>MeanVar normalizer: for each feature, compute the mean and variance, and then linearly rescale it to zero-mean, unit-variance.</li>
<li>CDF normalizer: for each feature, compute the mean and variance, and then replace each value <code class="docutils literal notranslate"><span class="pre">x</span></code> with <code class="docutils literal notranslate"><span class="pre">Cdf(x)</span></code>, where <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> is the cumulative density function of normal distribution with these mean and variance.</li>
<li>Binning normalizer: discretize the feature value into <code class="docutils literal notranslate"><span class="pre">N</span></code> ‘buckets’, and then replace each value with the index of the bucket, divided by <code class="docutils literal notranslate"><span class="pre">N-1</span></code>.</li>
</ul>
<p>These normalizers all have different properties and tradeoffs, but it’s not <em>that</em> big of a deal if you use one over another. Just make sure you use a normalizer when training linear models or other parametric models.</p>
<p>An important parameter of ML.NET normalizers is called <code class="docutils literal notranslate"><span class="pre">fixZero</span></code>. If <code class="docutils literal notranslate"><span class="pre">fixZero</span></code> is true, zero input is always mapped to zero output. This is very important when you handle sparse data: if we don’t preserve zeroes, we will turn all sparse data into dense, which is usually a bad idea.</p>
<p>It is a good practice to include the normalizer directly in the ML.NET learning pipeline: this way you are sure that the normalization</p>
<ul class="simple">
<li>is only trained on the training data, and not on your test data,</li>
<li>is correctly applied to all the new incoming data, without the need for extra pre-processing at prediction time.</li>
</ul>
<p>Here’s a snippet of code that demonstrates normalization in learning pipelines. It assumes the Iris dataset:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// The four features of the Iris dataset will be grouped together as one Features column.</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

<span class="c1">// Read the training data.</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Apply all kinds of standard ML.NET normalization to the raw features.</span>
<span class="kt">var</span> <span class="n">pipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">MinMaxNormalized</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">fixZero</span><span class="p">:</span> <span class="k">true</span><span class="p">),</span>
        <span class="n">MeanVarNormalized</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">NormalizeByMeanVar</span><span class="p">(</span><span class="n">fixZero</span><span class="p">:</span> <span class="k">false</span><span class="p">),</span>
        <span class="n">CdfNormalized</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">NormalizeByCumulativeDistribution</span><span class="p">(),</span>
        <span class="n">BinNormalized</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">NormalizeByBinning</span><span class="p">(</span><span class="n">maxBins</span><span class="p">:</span> <span class="m">256</span><span class="p">)</span>
    <span class="p">));</span>

<span class="c1">// Let&#39;s train our pipeline of normalizers, and then apply it to the same data.</span>
<span class="kt">var</span> <span class="n">normalizedData</span> <span class="p">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>

<span class="c1">// Inspect one column of the resulting dataset.</span>
<span class="kt">var</span> <span class="n">meanVarValues</span> <span class="p">=</span> <span class="n">normalizedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">MeanVarNormalized</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>
</div>
<p>You can achieve the same results using the dynamic API.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// The four features of the Iris dataset will be grouped together as one Features column.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">4</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">Separator</span> <span class="p">=</span> <span class="s">&quot;,&quot;</span>
<span class="p">});</span>

<span class="c1">// Read the training data.</span>
<span class="kt">var</span> <span class="n">trainData</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Apply all kinds of standard ML.NET normalization to the raw features.</span>
<span class="kt">var</span> <span class="n">pipeline</span> <span class="p">=</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">NormalizingEstimator</span><span class="p">.</span><span class="n">MinMaxColumn</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;MinMaxNormalized&quot;</span><span class="p">,</span> <span class="n">fixZero</span><span class="p">:</span> <span class="k">true</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">NormalizingEstimator</span><span class="p">.</span><span class="n">MeanVarColumn</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;MeanVarNormalized&quot;</span><span class="p">,</span> <span class="n">fixZero</span><span class="p">:</span> <span class="k">true</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">NormalizingEstimator</span><span class="p">.</span><span class="n">BinningColumn</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;BinNormalized&quot;</span><span class="p">,</span> <span class="n">numBins</span><span class="p">:</span> <span class="m">256</span><span class="p">));</span>

<span class="c1">// Let&#39;s train our pipeline of normalizers, and then apply it to the same data.</span>
<span class="kt">var</span> <span class="n">normalizedData</span> <span class="p">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>

<span class="c1">// Inspect one column of the resulting dataset.</span>
<span class="kt">var</span> <span class="n">meanVarValues</span> <span class="p">=</span> <span class="n">normalizedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;MeanVarNormalized&quot;</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-train-my-model-on-categorical-data">
<span id="how-do-i-train-my-model-on-categorical-data"></span><h2>How do I train my model on categorical data?<a class="headerlink" href="#how-do-i-train-my-model-on-categorical-data" title="Permalink to this headline">¶</a></h2>
<p>Generally speaking, <em>all ML.NET learners expect the features as a float vector</em>. So, if some of your data is not natively a float, you will need to convert to floats.</p>
<p>If our data contains ‘categorical’ features (think ‘enum’), we need to ‘featurize’ them somehow. ML.NET offers several ways of converting categorical data to features:</p>
<ul class="simple">
<li>One-hot encoding</li>
<li>Hash-based one-hot encoding</li>
<li>Binary encoding (convert category index into a bit sequence and use bits as features)</li>
</ul>
<p>If some of the categories are very high-cardinality (there’s lots of different values, but only several are commonly occurring), a one-hot encoding can be wasteful. We can use count-based feature selection to trim down the number of slots that we encode.</p>
<p>Same with normalization, it’s a good practice to include categorical featurization directly in the ML.NET learning pipeline: this way you are sure that the categorical transformation</p>
<ul class="simple">
<li>is only ‘trained’ on the training data, and not on your test data,</li>
<li>is correctly applied to all the new incoming data, without the need for extra pre-processing at prediction time.</li>
</ul>
<p>Below is an example of categorical handling for the <a class="reference external" href="../../test/data/adult.tiny.with-schema.txt">adult census dataset</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Label</span>   <span class="n">Workclass</span>   <span class="n">education</span>   <span class="n">marital</span><span class="o">-</span><span class="n">status</span>  <span class="n">occupation</span>  <span class="n">relationship</span>    <span class="n">ethnicity</span>   <span class="n">sex</span> <span class="n">native</span><span class="o">-</span><span class="n">country</span><span class="o">-</span><span class="n">region</span>   <span class="n">age</span> <span class="n">fnlwgt</span>  <span class="n">education</span><span class="o">-</span><span class="n">num</span>   <span class="n">capital</span><span class="o">-</span><span class="n">gain</span>    <span class="n">capital</span><span class="o">-</span><span class="n">loss</span>    <span class="n">hours</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">week</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="mi">11</span><span class="n">th</span>    <span class="n">Never</span><span class="o">-</span><span class="n">married</span>   <span class="n">Machine</span><span class="o">-</span><span class="n">op</span><span class="o">-</span><span class="n">inspct</span>   <span class="n">Own</span><span class="o">-</span><span class="n">child</span>   <span class="n">Black</span>   <span class="n">Male</span>    <span class="n">United</span><span class="o">-</span><span class="n">States</span>   <span class="mi">25</span>  <span class="mi">226802</span>  <span class="mi">7</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">40</span>
<span class="mi">0</span>   <span class="n">Private</span> <span class="n">HS</span><span class="o">-</span><span class="n">grad</span> <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>  <span class="n">Farming</span><span class="o">-</span><span class="n">fishing</span> <span class="n">Husband</span> <span class="n">White</span>   <span class="n">Male</span>    <span class="n">United</span><span class="o">-</span><span class="n">States</span>   <span class="mi">38</span>  <span class="mi">89814</span>   <span class="mi">9</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">50</span>
<span class="mi">1</span>   <span class="n">Local</span><span class="o">-</span><span class="n">gov</span>   <span class="n">Assoc</span><span class="o">-</span><span class="n">acdm</span>  <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>  <span class="n">Protective</span><span class="o">-</span><span class="n">serv</span> <span class="n">Husband</span> <span class="n">White</span>   <span class="n">Male</span>    <span class="n">United</span><span class="o">-</span><span class="n">States</span>   <span class="mi">28</span>  <span class="mi">336951</span>  <span class="mi">12</span>  <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">40</span>
<span class="mi">1</span>   <span class="n">Private</span> <span class="n">Some</span><span class="o">-</span><span class="n">college</span>    <span class="n">Married</span><span class="o">-</span><span class="n">civ</span><span class="o">-</span><span class="n">spouse</span>  <span class="n">Machine</span><span class="o">-</span><span class="n">op</span><span class="o">-</span><span class="n">inspct</span>   <span class="n">Husband</span> <span class="n">Black</span>   <span class="n">Male</span>    <span class="n">United</span><span class="o">-</span><span class="n">States</span>   <span class="mi">44</span>  <span class="mi">160323</span>  <span class="mi">10</span>  <span class="mi">7688</span>    <span class="mi">0</span>   <span class="mi">40</span>
</pre></div>
</div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadBool</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="c1">// We will load all the categorical features into one vector column of size 8.</span>
        <span class="n">CategoricalFeatures</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">8</span><span class="p">),</span>
        <span class="c1">// Similarly, load all numerical features into one vector of size 6.</span>
        <span class="n">NumericalFeatures</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">9</span><span class="p">,</span> <span class="m">14</span><span class="p">),</span>
        <span class="c1">// Let&#39;s also separately load the &#39;Workclass&#39; column.</span>
        <span class="n">Workclass</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">),</span> <span class="n">hasHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Inspect the categorical columns to check that they are correctly read.</span>
<span class="kt">var</span> <span class="n">catColumns</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">CategoricalFeatures</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Build several alternative featurization pipelines.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="n">r</span><span class="p">.</span><span class="n">NumericalFeatures</span><span class="p">,</span>
        <span class="c1">// Convert each categorical feature into one-hot encoding independently.</span>
        <span class="n">CategoricalOneHot</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">CategoricalFeatures</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">(</span><span class="n">outputKind</span><span class="p">:</span> <span class="n">CategoricalStaticExtensions</span><span class="p">.</span><span class="n">OneHotVectorOutputKind</span><span class="p">.</span><span class="n">Ind</span><span class="p">),</span>
        <span class="c1">// Convert all categorical features into indices, and build a &#39;word bag&#39; of these.</span>
        <span class="n">CategoricalBag</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">CategoricalFeatures</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">(</span><span class="n">outputKind</span><span class="p">:</span> <span class="n">CategoricalStaticExtensions</span><span class="p">.</span><span class="n">OneHotVectorOutputKind</span><span class="p">.</span><span class="n">Bag</span><span class="p">),</span>
        <span class="c1">// One-hot encode the workclass column, then drop all the categories that have fewer than 10 instances in the train set.</span>
        <span class="n">WorkclassOneHotTrimmed</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Workclass</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">().</span><span class="n">SelectFeaturesBasedOnCount</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="m">10</span><span class="p">)</span>
    <span class="p">));</span>

<span class="c1">// Let&#39;s train our pipeline, and then apply it to the same data.</span>
<span class="kt">var</span> <span class="n">transformedData</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// Inspect some columns of the resulting dataset.</span>
<span class="kt">var</span> <span class="n">categoricalBags</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CategoricalBag</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">workclasses</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">WorkclassOneHotTrimmed</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Of course, if we want to train the model, we will need to compose a single float vector of all the features.</span>
<span class="c1">// Here&#39;s how we could do this:</span>

<span class="kt">var</span> <span class="n">fullLearningPipeline</span> <span class="p">=</span> <span class="n">learningPipeline</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Concatenate two of the 3 categorical pipelines, and the numeric features.</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">NumericalFeatures</span><span class="p">.</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">CategoricalBag</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">WorkclassOneHotTrimmed</span><span class="p">)))</span>
    <span class="c1">// Now we&#39;re ready to train. We chose our FastTree trainer for this classification task.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">FastTree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">,</span> <span class="n">numTrees</span><span class="p">:</span> <span class="m">50</span><span class="p">));</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">fullLearningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<p>You can achieve the same results using the dynamic API.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">BL</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="c1">// We will load all the categorical features into one vector column of size 8.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;CategoricalFeatures&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">8</span><span class="p">),</span>
        <span class="c1">// Similarly, load all numerical features into one vector of size 6.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;NumericalFeatures&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">14</span><span class="p">),</span>
        <span class="c1">// Let&#39;s also separately load the &#39;Workclass&#39; column.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Workclass&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">HasHeader</span> <span class="p">=</span> <span class="k">true</span>
<span class="p">});</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Inspect the first 10 records of the categorical columns to check that they are correctly read.</span>
<span class="kt">var</span> <span class="n">catColumns</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;CategoricalFeatures&quot;</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Build several alternative featurization pipelines.</span>
<span class="kt">var</span> <span class="n">dynamicPipeline</span> <span class="p">=</span>
    <span class="c1">// Convert each categorical feature into one-hot encoding independently.</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Categorical</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">(</span><span class="s">&quot;CategoricalFeatures&quot;</span><span class="p">,</span> <span class="s">&quot;CategoricalOneHot&quot;</span><span class="p">)</span>
    <span class="c1">// Convert all categorical features into indices, and build a &#39;word bag&#39; of these.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Categorical</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">(</span><span class="s">&quot;CategoricalFeatures&quot;</span><span class="p">,</span> <span class="s">&quot;CategoricalBag&quot;</span><span class="p">,</span> <span class="n">CategoricalTransform</span><span class="p">.</span><span class="n">OutputKind</span><span class="p">.</span><span class="n">Bag</span><span class="p">))</span>
    <span class="c1">// One-hot encode the workclass column, then drop all the categories that have fewer than 10 instances in the train set.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Categorical</span><span class="p">.</span><span class="n">OneHotEncoding</span><span class="p">(</span><span class="s">&quot;Workclass&quot;</span><span class="p">,</span> <span class="s">&quot;WorkclassOneHot&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">FeatureSelection</span><span class="p">.</span><span class="n">CountFeatureSelectingEstimator</span><span class="p">(</span><span class="s">&quot;WorkclassOneHot&quot;</span><span class="p">,</span> <span class="s">&quot;WorkclassOneHotTrimmed&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="m">10</span><span class="p">));</span>

<span class="c1">// Let&#39;s train our pipeline, and then apply it to the same data.</span>
<span class="kt">var</span> <span class="n">transformedData</span> <span class="p">=</span> <span class="n">dynamicPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// Inspect some columns of the resulting dataset.</span>
<span class="kt">var</span> <span class="n">categoricalBags</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;CategoricalBag&quot;</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">workclasses</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;WorkclassOneHotTrimmed&quot;</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Of course, if we want to train the model, we will need to compose a single float vector of all the features.</span>
<span class="c1">// Here&#39;s how we could do this:</span>

<span class="kt">var</span> <span class="n">fullLearningPipeline</span> <span class="p">=</span> <span class="n">dynamicPipeline</span>
    <span class="c1">// Concatenate two of the 3 categorical pipelines, and the numeric features.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;NumericalFeatures&quot;</span><span class="p">,</span> <span class="s">&quot;CategoricalBag&quot;</span><span class="p">,</span> <span class="s">&quot;WorkclassOneHotTrimmed&quot;</span><span class="p">))</span>
    <span class="c1">// Now we&#39;re ready to train. We chose our FastTree trainer for this classification task.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">FastTree</span><span class="p">(</span><span class="n">numTrees</span><span class="p">:</span> <span class="m">50</span><span class="p">));</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">fullLearningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-train-my-model-on-textual-data">
<span id="how-do-i-train-my-model-on-textual-data"></span><h2>How do I train my model on textual data?<a class="headerlink" href="#how-do-i-train-my-model-on-textual-data" title="Permalink to this headline">¶</a></h2>
<p>Generally speaking, <em>all ML.NET learners expect the features as a float vector</em>. So, if some of your data is not natively a float, you will need to convert to floats.</p>
<p>If we want to learn on textual data, we need to ‘extract features’ out of the texts. There is an entire research area of NLP (Natural Language Processing) that handles this. In ML.NET we offer some basic mechanisms of text feature extraction:</p>
<ul class="simple">
<li>Text normalization (removing punctuation, diacritics, switching to lowercase etc.)</li>
<li>Separator-based tokenization.</li>
<li>Stopword removal.</li>
<li>Ngram and skip-gram extraction.</li>
<li>TF-IDF rescaling.</li>
<li>Bag of words conversion.</li>
</ul>
<p>ML.NET offers a “one-stop shop” operation called <code class="docutils literal notranslate"><span class="pre">TextFeaturizer</span></code>, that runs a combination of above steps as one big ‘text featurization’. We have tested it extensively on text datasets, and we’re confident that it performs reasonably well without the need to deep-dive into the operations.</p>
<p>However, we also offer a selection of elementary operations that let you customize your NLP processing. Here’s the example below where we use them.</p>
<p>Wikipedia detox dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Sentiment   SentimentText
1   Stop trolling, zapatancas, calling me a liar merely demonstartes that you arer Zapatancas. You may choose to chase every legitimate editor from this site and ignore me but I am an editor with a record that isnt 99% trolling and therefore my wishes are not to be completely ignored by a sockpuppet like yourself. The consensus is overwhelmingly against you and your trollin g lover Zapatancas,  
1   ::::: Why are you threatening me? I&#39;m not being disruptive, its you who is being disruptive.   
0   &quot; *::Your POV and propaganda pushing is dully noted. However listing interesting facts in a netral and unacusitory tone is not POV. You seem to be confusing Censorship with POV monitoring. I see nothing POV expressed in the listing of intersting facts. If you want to contribute more facts or edit wording of the cited fact to make them sound more netral then go ahead. No need to CENSOR interesting factual information. &quot;
0   ::::::::This is a gross exaggeration. Nobody is setting a kangaroo court. There was a simple addition concerning the airline. It is the only one disputed here.   
</pre></div>
</div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">IsToxic</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadBool</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="n">Message</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">),</span> <span class="n">hasHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Inspect the message texts that are read from the file.</span>
<span class="kt">var</span> <span class="n">messageTexts</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Message</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">20</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Apply various kinds of text operations supported by ML.NET.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// One-stop shop to run the full text featurization.</span>
        <span class="n">TextFeatures</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">FeaturizeText</span><span class="p">(),</span>

        <span class="c1">// NLP pipeline 1: bag of words.</span>
        <span class="n">BagOfWords</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">NormalizeText</span><span class="p">().</span><span class="n">ToBagofWords</span><span class="p">(),</span>

        <span class="c1">// NLP pipeline 2: bag of bigrams, using hashes instead of dictionary indices.</span>
        <span class="n">BagOfBigrams</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">NormalizeText</span><span class="p">().</span><span class="n">ToBagofHashedWords</span><span class="p">(</span><span class="n">ngramLength</span><span class="p">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">allLengths</span><span class="p">:</span> <span class="k">false</span><span class="p">),</span>

        <span class="c1">// NLP pipeline 3: bag of tri-character sequences with TF-IDF weighting.</span>
        <span class="n">BagOfTrichar</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">TokenizeIntoCharacters</span><span class="p">().</span><span class="n">ToNgrams</span><span class="p">(</span><span class="n">ngramLength</span><span class="p">:</span> <span class="m">3</span><span class="p">,</span> <span class="n">weighting</span><span class="p">:</span> <span class="n">NgramExtractingEstimator</span><span class="p">.</span><span class="n">WeightingCriteria</span><span class="p">.</span><span class="n">TfIdf</span><span class="p">),</span>

        <span class="c1">// NLP pipeline 4: word embeddings.</span>
        <span class="n">Embeddings</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">NormalizeText</span><span class="p">().</span><span class="n">TokenizeText</span><span class="p">().</span><span class="n">WordEmbeddings</span><span class="p">(</span><span class="n">WordEmbeddingsExtractorTransformer</span><span class="p">.</span><span class="n">PretrainedModelKind</span><span class="p">.</span><span class="n">GloVeTwitter25D</span><span class="p">)</span>
    <span class="p">));</span>

<span class="c1">// Let&#39;s train our pipeline, and then apply it to the same data.</span>
<span class="c1">// Note that even on a small dataset of 70KB the pipeline above can take up to a minute to completely train.</span>
<span class="kt">var</span> <span class="n">transformedData</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// Inspect some columns of the resulting dataset.</span>
<span class="kt">var</span> <span class="n">embeddings</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Embeddings</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">unigrams</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">BagOfWords</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>
</div>
<p>You can achieve the same results using the dynamic API.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;IsToxic&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">BL</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">HasHeader</span> <span class="p">=</span> <span class="k">true</span>
<span class="p">});</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Inspect the message texts that are read from the file.</span>
<span class="kt">var</span> <span class="n">messageTexts</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;Message&quot;</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">20</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>

<span class="c1">// Apply various kinds of text operations supported by ML.NET.</span>
<span class="kt">var</span> <span class="n">dynamicPipeline</span> <span class="p">=</span>
    <span class="c1">// One-stop shop to run the full text featurization.</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">FeaturizeText</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">,</span> <span class="s">&quot;TextFeatures&quot;</span><span class="p">)</span>

    <span class="c1">// Normalize the message for later transforms</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">NormalizeText</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">,</span> <span class="s">&quot;NormalizedMessage&quot;</span><span class="p">))</span>

    <span class="c1">// NLP pipeline 1: bag of words.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="n">WordBagEstimator</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;NormalizedMessage&quot;</span><span class="p">,</span> <span class="s">&quot;BagOfWords&quot;</span><span class="p">))</span>

    <span class="c1">// NLP pipeline 2: bag of bigrams, using hashes instead of dictionary indices.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="n">WordHashBagEstimator</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;NormalizedMessage&quot;</span><span class="p">,</span> <span class="s">&quot;BagOfBigrams&quot;</span><span class="p">,</span>
                <span class="n">ngramLength</span><span class="p">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">allLengths</span><span class="p">:</span> <span class="k">false</span><span class="p">))</span>

    <span class="c1">// NLP pipeline 3: bag of tri-character sequences with TF-IDF weighting.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">TokenizeCharacters</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">,</span> <span class="s">&quot;MessageChars&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="n">NgramExtractingEstimator</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;MessageChars&quot;</span><span class="p">,</span> <span class="s">&quot;BagOfTrichar&quot;</span><span class="p">,</span>
                <span class="n">ngramLength</span><span class="p">:</span> <span class="m">3</span><span class="p">,</span> <span class="n">weighting</span><span class="p">:</span> <span class="n">NgramExtractingEstimator</span><span class="p">.</span><span class="n">WeightingCriteria</span><span class="p">.</span><span class="n">TfIdf</span><span class="p">))</span>

    <span class="c1">// NLP pipeline 4: word embeddings.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">TokenizeWords</span><span class="p">(</span><span class="s">&quot;NormalizedMessage&quot;</span><span class="p">,</span> <span class="s">&quot;TokenizedMessage&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">ExtractWordEmbeedings</span><span class="p">(</span><span class="s">&quot;TokenizedMessage&quot;</span><span class="p">,</span> <span class="s">&quot;Embeddings&quot;</span><span class="p">,</span>
                <span class="n">WordEmbeddingsExtractorTransformer</span><span class="p">.</span><span class="n">PretrainedModelKind</span><span class="p">.</span><span class="n">GloVeTwitter25D</span><span class="p">));</span>

<span class="c1">// Let&#39;s train our pipeline, and then apply it to the same data.</span>
<span class="c1">// Note that even on a small dataset of 70KB the pipeline above can take up to a minute to completely train.</span>
<span class="kt">var</span> <span class="n">transformedData</span> <span class="p">=</span> <span class="n">dynamicPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// Inspect some columns of the resulting dataset.</span>
<span class="kt">var</span> <span class="n">embeddings</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;Embeddings&quot;</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">unigrams</span> <span class="p">=</span> <span class="n">transformedData</span><span class="p">.</span><span class="n">GetColumn</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">[]&gt;(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;BagOfWords&quot;</span><span class="p">).</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-train-using-cross-validation">
<span id="how-do-i-train-using-cross-validation"></span><h2>How do I train using cross-validation?<a class="headerlink" href="#how-do-i-train-using-cross-validation" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">Cross-validation</a> is a useful technique for ML applications. It helps estimate the variance of the model quality from one run to another and also eliminates the need to extract a separate test set for evaluation.</p>
<p>There are a couple pitfalls that await us when we implement our own cross-validation. Essentially, if we are not careful, we may introduce label leakage in the process, so our metrics could become over-inflated.</p>
<ul class="simple">
<li>It is tempting to apply the same pre-processing to the entire data, and then just cross-validate the final training of the model. If we do this for data-dependent, ‘trainable’ pre-processing (like text featurization, categorical handling and normalization/rescaling), we cause these processing steps to ‘train’ on the union of train subset and test subset, thus causing label leakage. The correct way is to apply pre-processing independently for each ‘fold’ of the cross-validation.</li>
<li>In many cases there is a natural ‘grouping’ of the data that needs to be respected. For example, if we are solving a click prediction problem, it’s a good idea to group all examples pertaining to one URL to appear in one-fold of the data. If they end up separated, we can introduce label leakage.</li>
</ul>
<p>ML.NET guards us against both these pitfalls: it will automatically apply the featurization correctly (as long as all of the preprocessing resides in one learning pipeline), and we can use the ‘stratification column’ concept to make sure that related examples don’t get separated.</p>
<p>Here’s an example of training on Iris dataset using randomized 90/10 train-test split, as well as a 5-fold cross-validation:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// The four features of the Iris dataset.</span>
        <span class="n">SepalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="n">SepalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">PetalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
        <span class="n">PetalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Build the training pipeline.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// Convert string label to a key.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">.</span><span class="n">ToKey</span><span class="p">(),</span>
        <span class="c1">// Concatenate all the features together into one column &#39;Features&#39;.</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">SepalLength</span><span class="p">.</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">SepalWidth</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalLength</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalWidth</span><span class="p">)))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span>
        <span class="c1">// Train the multi-class SDCA model to predict the label using features.</span>
        <span class="n">Predictions</span><span class="p">:</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">Sdca</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">Features</span><span class="p">)));</span>

<span class="c1">// Split the data 90:10 into train and test sets, train and evaluate.</span>
<span class="kt">var</span> <span class="p">(</span><span class="n">trainData</span><span class="p">,</span> <span class="n">testData</span><span class="p">)</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">TrainTestSplit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">testFraction</span><span class="p">:</span> <span class="m">0.1</span><span class="p">);</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
<span class="c1">// Compute quality metrics on the test set.</span>
<span class="kt">var</span> <span class="n">metrics</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">testData</span><span class="p">),</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Predictions</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">AccuracyMicro</span><span class="p">);</span>

<span class="c1">// Now run the 5-fold cross-validation experiment, using the same pipeline.</span>
<span class="kt">var</span> <span class="n">cvResults</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">CrossValidate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">learningPipeline</span><span class="p">,</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">,</span> <span class="n">numFolds</span><span class="p">:</span> <span class="m">5</span><span class="p">);</span>

<span class="c1">// The results object is an array of 5 elements. For each of the 5 folds, we have metrics, model and scored test data.</span>
<span class="c1">// Let&#39;s compute the average micro-accuracy.</span>
<span class="kt">var</span> <span class="n">microAccuracies</span> <span class="p">=</span> <span class="n">cvResults</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">AccuracyMicro</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">microAccuracies</span><span class="p">.</span><span class="n">Average</span><span class="p">());</span>
</pre></div>
</div>
<p>You can achieve the same results using the dynamic API.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Step one: read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Arguments</span>
<span class="p">{</span>
    <span class="n">Column</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span>
        <span class="c1">// We read the first 11 values as a single float vector.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;SepalLength&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;SepalWidth&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;PetalLength&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;PetalWidth&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">R4</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="k">new</span> <span class="n">TextLoader</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span> <span class="n">DataKind</span><span class="p">.</span><span class="n">TX</span><span class="p">,</span> <span class="m">4</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">Separator</span> <span class="p">=</span> <span class="s">&quot;,&quot;</span>
<span class="p">});</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Build the training pipeline.</span>
<span class="kt">var</span> <span class="n">dynamicPipeline</span> <span class="p">=</span>
    <span class="c1">// Concatenate all the features together into one column &#39;Features&#39;.</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="s">&quot;Features&quot;</span><span class="p">,</span> <span class="s">&quot;SepalLength&quot;</span><span class="p">,</span> <span class="s">&quot;SepalWidth&quot;</span><span class="p">,</span> <span class="s">&quot;PetalLength&quot;</span><span class="p">,</span> <span class="s">&quot;PetalWidth&quot;</span><span class="p">)</span>
    <span class="c1">// Note that the label is text, so it needs to be converted to key.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">Conversions</span><span class="p">.</span><span class="n">MapValueToKey</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">),</span> <span class="n">TransformerScope</span><span class="p">.</span><span class="n">TrainTest</span><span class="p">)</span>
    <span class="c1">// Use the multi-class SDCA model to predict the label using features.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">StochasticDualCoordinateAscent</span><span class="p">());</span>

<span class="c1">// Split the data 90:10 into train and test sets, train and evaluate.</span>
<span class="kt">var</span> <span class="p">(</span><span class="n">trainData</span><span class="p">,</span> <span class="n">testData</span><span class="p">)</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">TrainTestSplit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">testFraction</span><span class="p">:</span> <span class="m">0.1</span><span class="p">);</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dynamicPipeline</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
<span class="c1">// Compute quality metrics on the test set.</span>
<span class="kt">var</span> <span class="n">metrics</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">testData</span><span class="p">));</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">AccuracyMicro</span><span class="p">);</span>

<span class="c1">// Now run the 5-fold cross-validation experiment, using the same pipeline.</span>
<span class="kt">var</span> <span class="n">cvResults</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">MulticlassClassification</span><span class="p">.</span><span class="n">CrossValidate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dynamicPipeline</span><span class="p">,</span> <span class="n">numFolds</span><span class="p">:</span> <span class="m">5</span><span class="p">);</span>

<span class="c1">// The results object is an array of 5 elements. For each of the 5 folds, we have metrics, model and scored test data.</span>
<span class="c1">// Let&#39;s compute the average micro-accuracy.</span>
<span class="kt">var</span> <span class="n">microAccuracies</span> <span class="p">=</span> <span class="n">cvResults</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">AccuracyMicro</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">microAccuracies</span><span class="p">.</span><span class="n">Average</span><span class="p">());</span>
</pre></div>
</div>
</div>
<div class="section" id="can-i-mix-and-match-static-and-dynamic-pipelines">
<span id="can-i-mix-and-match-static-and-dynamic-pipelines"></span><h2>Can I mix and match static and dynamic pipelines?<a class="headerlink" href="#can-i-mix-and-match-static-and-dynamic-pipelines" title="Permalink to this headline">¶</a></h2>
<p>Yes, we can have both of them in our codebase. The static pipelines are just a statically-typed way to build dynamic pipelines.</p>
<p>Namely, any statically typed component (<code class="docutils literal notranslate"><span class="pre">DataView&lt;T&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">Transformer&lt;T&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">Estimator&lt;T&gt;</span></code>) has its dynamic counterpart as an <code class="docutils literal notranslate"><span class="pre">AsDynamic</span></code> property.</p>
<p>Transitioning from dynamic to static types is more costly: we have to formally declare what is the ‘schema shape’. Or, in case of estimators and transformers, what is the input and output schema shape.</p>
<p>We can do this via <code class="docutils literal notranslate"><span class="pre">AssertStatic&lt;T&gt;</span></code> extensions, as demonstrated in the following example, where we mix and match static and dynamic pipelines.</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a new context for ML.NET operations. It can be used for exception tracking and logging, </span>
<span class="c1">// as a catalog of available operations and as the source of randomness.</span>
<span class="kt">var</span> <span class="n">mlContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Read the data as an IDataView.</span>
<span class="c1">// First, we define the reader: specify the data columns and where to find them in the text file.</span>
<span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">TextReader</span><span class="p">(</span><span class="n">ctx</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// The four features of the Iris dataset.</span>
        <span class="n">SepalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="n">SepalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
        <span class="n">PetalLength</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
        <span class="n">PetalWidth</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadFloat</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
        <span class="c1">// Label: kind of iris.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">ctx</span><span class="p">.</span><span class="n">LoadText</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Default separator is tab, but the dataset has comma.</span>
    <span class="n">separator</span><span class="p">:</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

<span class="c1">// Read the data.</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">dataPath</span><span class="p">);</span>

<span class="c1">// Build the pre-processing pipeline.</span>
<span class="kt">var</span> <span class="n">learningPipeline</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeNewEstimator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="c1">// Convert string label to a key.</span>
        <span class="n">Label</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">Label</span><span class="p">.</span><span class="n">ToKey</span><span class="p">(),</span>
        <span class="c1">// Concatenate all the features together into one column &#39;Features&#39;.</span>
        <span class="n">Features</span><span class="p">:</span> <span class="n">r</span><span class="p">.</span><span class="n">SepalLength</span><span class="p">.</span><span class="n">ConcatWith</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">SepalWidth</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalLength</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">PetalWidth</span><span class="p">)));</span>

<span class="c1">// Now, at the time of writing, there is no static pipeline for OVA (one-versus-all). So, let&#39;s</span>
<span class="c1">// append the OVA learner to the dynamic pipeline.</span>
<span class="n">IEstimator</span><span class="p">&lt;</span><span class="n">ITransformer</span><span class="p">&gt;</span> <span class="n">dynamicPipe</span> <span class="p">=</span> <span class="n">learningPipeline</span><span class="p">.</span><span class="n">AsDynamic</span><span class="p">;</span>

<span class="c1">// Create a binary classification trainer.</span>
<span class="kt">var</span> <span class="n">binaryTrainer</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">AveragedPerceptron</span><span class="p">(</span><span class="s">&quot;Label&quot;</span><span class="p">,</span> <span class="s">&quot;Features&quot;</span><span class="p">);</span>

<span class="c1">// Append the OVA learner to the pipeline.</span>
<span class="n">dynamicPipe</span> <span class="p">=</span> <span class="n">dynamicPipe</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="n">Ova</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span> <span class="n">binaryTrainer</span><span class="p">));</span>

<span class="c1">// At this point, we have a choice. We could continue working with the dynamically-typed pipeline, and</span>
<span class="c1">// ultimately call dynamicPipe.Fit(data.AsDynamic) to get the model, or we could go back into the static world.</span>
<span class="c1">// Here&#39;s how we go back to the static pipeline:</span>
<span class="kt">var</span> <span class="n">staticFinalPipe</span> <span class="p">=</span> <span class="n">dynamicPipe</span><span class="p">.</span><span class="n">AssertStatic</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span>
        <span class="c1">// Declare the shape of the input. As you can see, it&#39;s identical to the shape of the reader:</span>
        <span class="c1">// four float features and a string label.</span>
        <span class="n">c</span> <span class="p">=&gt;</span> <span class="p">(</span>
            <span class="n">SepalLength</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">R4</span><span class="p">.</span><span class="n">Scalar</span><span class="p">,</span>
            <span class="n">SepalWidth</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">R4</span><span class="p">.</span><span class="n">Scalar</span><span class="p">,</span>
            <span class="n">PetalLength</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">R4</span><span class="p">.</span><span class="n">Scalar</span><span class="p">,</span>
            <span class="n">PetalWidth</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">R4</span><span class="p">.</span><span class="n">Scalar</span><span class="p">,</span>
            <span class="n">Label</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Scalar</span><span class="p">),</span>
        <span class="c1">// Declare the shape of the output (or a relevant subset of it).</span>
        <span class="c1">// In our case, we care only about the predicted label column (a key type), and scores (vector of floats).</span>
        <span class="n">c</span> <span class="p">=&gt;</span> <span class="p">(</span>
            <span class="n">Score</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">R4</span><span class="p">.</span><span class="n">Vector</span><span class="p">,</span>
            <span class="c1">// Predicted label is a key backed by uint, with text values (since original labels are text).</span>
            <span class="n">PredictedLabel</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">KeyU4</span><span class="p">.</span><span class="n">TextValues</span><span class="p">.</span><span class="n">Scalar</span><span class="p">))</span>
    <span class="c1">// Convert the predicted label from key back to the original string value.</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">PredictedLabel</span><span class="p">.</span><span class="n">ToValue</span><span class="p">());</span>

<span class="c1">// Train the model in a statically typed way.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">staticFinalPipe</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// And here is how we could&#39;ve stayed in the dynamic pipeline and train that way.</span>
<span class="n">dynamicPipe</span> <span class="p">=</span> <span class="n">dynamicPipe</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyToValueEstimator</span><span class="p">(</span><span class="n">mlContext</span><span class="p">,</span> <span class="s">&quot;PredictedLabel&quot;</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">dynamicModel</span> <span class="p">=</span> <span class="n">dynamicPipe</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">AsDynamic</span><span class="p">);</span>

<span class="c1">// Now &#39;dynamicModel&#39;, and &#39;model.AsDynamic&#39; are equivalent.</span>
</pre></div>
</div>
</div>
<div class="section" id="how-can-i-define-my-own-transformation-of-data">
<span id="how-can-i-define-my-own-transformation-of-data"></span><h2>How can I define my own transformation of data?<a class="headerlink" href="#how-can-i-define-my-own-transformation-of-data" title="Permalink to this headline">¶</a></h2>
<p>ML.NET has quite a lot of built-in transformers, but we can not possibly cover everything. Inevitably, you will need to perform custom user-defined operations.
We added <code class="docutils literal notranslate"><span class="pre">MLContext.Transforms.CustomMapping</span></code> for this very purpose: it is a user-defined arbitrary <em>mapping</em> of the data.</p>
<p>Suppose that we have the dataset with float ‘Income’ column, and we want to compute ‘Label’, that is equal to <code class="docutils literal notranslate"><span class="pre">true</span></code> if the income is more than 50000, and <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<p>Here’s how we can do this via a custom transformer:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define a class for all the input columns that we intend to consume.</span>
<span class="k">class</span> <span class="nc">InputRow</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">Income</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Define a class for all output columns that we intend to produce.</span>
<span class="k">class</span> <span class="nc">OutputRow</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Label</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">IDataView</span> <span class="nf">PrepareData</span><span class="p">(</span><span class="n">MLContext</span> <span class="n">mlContext</span><span class="p">,</span> <span class="n">IDataView</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Define the operation code.</span>
    <span class="n">Action</span><span class="p">&lt;</span><span class="n">InputRow</span><span class="p">,</span> <span class="n">OutputRow</span><span class="p">&gt;</span> <span class="n">mapping</span> <span class="p">=</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">output</span><span class="p">.</span><span class="n">Label</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">Income</span> <span class="p">&gt;</span> <span class="m">50000</span><span class="p">;</span>
    <span class="c1">// Make a custom transformer and transform the data.</span>
    <span class="kt">var</span> <span class="n">transformer</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">CustomMappingTransformer</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">transformer</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also insert a custom mapping inside an estimator pipeline:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="n">ITransformer</span> <span class="nf">TrainModel</span><span class="p">(</span><span class="n">MLContext</span> <span class="n">mlContext</span><span class="p">,</span> <span class="n">IDataView</span> <span class="n">trainData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Define the custom operation.</span>
    <span class="n">Action</span><span class="p">&lt;</span><span class="n">InputRow</span><span class="p">,</span> <span class="n">OutputRow</span><span class="p">&gt;</span> <span class="n">mapping</span> <span class="p">=</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">output</span><span class="p">.</span><span class="n">Label</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">Income</span> <span class="p">&gt;</span> <span class="m">50000</span><span class="p">;</span>
    <span class="c1">// Construct the learning pipeline.</span>
    <span class="kt">var</span> <span class="n">estimator</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">CustomMapping</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">FastTree</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="s">&quot;Label&quot;</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">estimator</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Please note that you need to make your <code class="docutils literal notranslate"><span class="pre">mapping</span></code> operation into a ‘pure function’:</p>
<ul class="simple">
<li>It should be reentrant (we will call it simultaneously from multiple threads)</li>
<li>It should not have side effects (we may call it arbitrarily at any time, or omit the call)</li>
</ul>
<p>One important caveat is: if you want your custom transformation to be part of your saved model, you will need to provide a <code class="docutils literal notranslate"><span class="pre">contractName</span></code> for it.
At loading time, you will need to reconstruct the custom transformer and inject it into MLContext.</p>
<p>Here is a complete example that saves and loads a model with a custom mapping.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// One class that contains all custom mappings that we need for our model.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomMappings</span>
<span class="p">{</span>
    <span class="c1">// This is the custom mapping. We now separate it into a method, so that we can use it both in training and in loading.</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">IncomeMapping</span><span class="p">(</span><span class="n">InputRow</span> <span class="n">input</span><span class="p">,</span> <span class="n">OutputRow</span> <span class="n">output</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">output</span><span class="p">.</span><span class="n">Label</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">Income</span> <span class="p">&gt;</span> <span class="m">50000</span><span class="p">;</span>

    <span class="c1">// MLContext is needed to create a new transformer. We are using &#39;Import&#39; to have ML.NET populate</span>
    <span class="c1">// this property.</span>
<span class="na">    [Import]</span>
    <span class="k">public</span> <span class="n">MLContext</span> <span class="n">MLContext</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// We are exporting the custom transformer by the name &#39;IncomeMapping&#39;.</span>
<span class="na">    [Export(nameof(IncomeMapping))]</span>
    <span class="k">public</span> <span class="n">ITransformer</span> <span class="n">MyCustomTransformer</span> 
        <span class="p">=&gt;</span> <span class="n">MLContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">CustomMappingTransformer</span><span class="p">&lt;</span><span class="n">InputRow</span><span class="p">,</span> <span class="n">OutputRow</span><span class="p">&gt;(</span><span class="n">IncomeMapping</span><span class="p">,</span> <span class="n">nameof</span><span class="p">(</span><span class="n">IncomeMapping</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Construct the learning pipeline. Note that we are now providing a contract name for the custom mapping:</span>
<span class="c1">// otherwise we will not be able to save the model.</span>
<span class="kt">var</span> <span class="n">estimator</span> <span class="p">=</span> <span class="n">mlContext</span><span class="p">.</span><span class="n">Transforms</span><span class="p">.</span><span class="n">CustomMapping</span><span class="p">&lt;</span><span class="n">InputRow</span><span class="p">,</span> <span class="n">OutputRow</span><span class="p">&gt;(</span><span class="n">CustomMappings</span><span class="p">.</span><span class="n">IncomeMapping</span><span class="p">,</span> <span class="n">nameof</span><span class="p">(</span><span class="n">CustomMappings</span><span class="p">.</span><span class="n">IncomeMapping</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">mlContext</span><span class="p">.</span><span class="n">BinaryClassification</span><span class="p">.</span><span class="n">Trainers</span><span class="p">.</span><span class="n">FastTree</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="s">&quot;Label&quot;</span><span class="p">));</span>

<span class="c1">// Train the model.</span>
<span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="n">estimator</span><span class="p">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>

<span class="c1">// Save the model.</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">modelPath</span><span class="p">))</span>
    <span class="n">mlContext</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>

<span class="c1">// Now pretend we are in a different process.</span>
<span class="kt">var</span> <span class="n">newContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MLContext</span><span class="p">();</span>

<span class="c1">// Create a custom composition container for all our custom mapping actions.</span>
<span class="n">newContext</span><span class="p">.</span><span class="n">CompositionContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CompositionContainer</span><span class="p">(</span><span class="k">new</span> <span class="n">TypeCatalog</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CustomMappings</span><span class="p">)));</span>

<span class="c1">// Now we can load the model.</span>
<span class="n">ITransformer</span> <span class="n">loadedModel</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">OpenRead</span><span class="p">(</span><span class="n">modelPath</span><span class="p">))</span>
    <span class="n">loadedModel</span> <span class="p">=</span> <span class="n">newContext</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/project_ico.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Custom Extensions to ML.net</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataframe.html">DataFrames in C#</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commandline.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">ML.net Components</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../machinelearning_docs.html">ML.net details</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">ML.net details</a></li>
<li class="toctree-l2"><a class="reference internal" href="changes.html">ML.net releases details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts.html">Scikit.ML details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apicsharpdoc.html">CSharp API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aonnx.html">ML.net and ONNX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incompatibilities.html">ML.net customization</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../machinelearning_docs.html">ML.net details</a><ul>
  <li><a href="index.html">ML.net details</a><ul>
      <li>Previous: <a href="keyvalues.html" title="previous chapter">Key Values</a></li>
      <li>Next: <a href="mlnethighlevelconcepts.html" title="next chapter">ML.NET high-level concepts</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/mlnetdocs/mlnetcookbook.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>